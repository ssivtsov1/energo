//---------------------------------------------------------------------------
#include <vcl.h>
#pragma hdrstop

#include "fReps.h"
#include "Main.h"
//#include "fQRreps.h"
#include "fCalendar.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "xlcClasses"
#pragma link "xlReport"
#pragma link "ZPgSqlQuery"
#pragma link "ZQuery"
#pragma resource "*.dfm"
TfReports *fReports;

TDateTime WorkDate;
TDateTime WorkDate_2;

TWTDBGrid* WAbonGrid;
TWTWinDBGrid *WFiderGrid;
TWTWinDBGrid *WPSGrid;
TWTDBGrid    *WTarGrid;
TWTDBGrid    *WPosGrid;
TDateTime cur_mmgg;
//---------------------------------------------------------------------------

void _fastcall TMainForm::ShowRepsForm(TObject *Sender) {
     Application->CreateForm(__classid(TfReports), &fReports);
     fReports->ShowAs("Reps_ded");
}
//---------------------------------------------------------------------------
void __fastcall TfReports::btGoClick(TObject *Sender)
{
  btGo->Enabled=false;
  btPrint->Enabled=false;
//  Crpe1->ReportName=(PTRepData(CurReport->Data))->file_name;
    //
    if ((PTRepData(CurReport->Data))->ident == "oborot") ObSaldo(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "oborot_nds") ObSaldoNDS(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "oborot_akt") ObSaldoAkt(((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "oborot_year") ObSaldoDemandYear(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "oborot_transit") ObSaldoTransit(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);

    //    if ((PTRepData(CurReport->Data))->ident == "oborot_r") ObSaldo(((TComponent*)(Sender))->Tag==1,2);
    if ((PTRepData(CurReport->Data))->ident == "oborot_1") ObSaldoAbon(dtBegin->Date,cbKindEnergy->ItemIndex,AbonId,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "bill_saldo") BillSaldo(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex,AbonId,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "sales") Sales(((TComponent*)(Sender))->Tag==1,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "sales_abon") SalesAbon(((TComponent*)(Sender))->Tag==1,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "ind_debtor") ShowIndicDebtor(dtBegin->Date,dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "bill_debtor") ShowBillDebtor(dtRDate->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "tar_3zon") R3Zone_tar(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "f32") F32(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "ind_now") IndicToDate();
    if ((PTRepData(CurReport->Data))->ident == "abon_saldo") MainForm->CliSaldRRep(AbonId, dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "met_3zon") R3Zone_meters(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "tax_book") PrintTaxBook(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "tax_list") PrintTaxList(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "tax_listgrp") PrintTaxListGrp(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "bill_list") PrintBillist(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "pay_list") PrintPaylist(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "debet_list") PrintDebetList(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,cbKindEnergy->ItemIndex,StrToFloat(edValue->Text),1);
    if ((PTRepData(CurReport->Data))->ident == "kt_list") PrintDebetList(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,cbKindEnergy->ItemIndex,StrToFloat(edValue->Text),2);
    if ((PTRepData(CurReport->Data))->ident == "oborot_short") PrintOborotShort(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "f24") PrintF24(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_tar") PrintAbonTarif(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_volt") PrintAbonVolt(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_dep") PrintAbonDep(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "NDS") PrintNDS(dtBegin->Date,cbKindEnergy->ItemIndex,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "NDS2011") PrintNDS2011(dtBegin->Date,cbKindEnergy->ItemIndex,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "NDS2011_inf") NDS2011_info(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_grp") PrintAbonGrp(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "akt1") PrintAkt1(dtRDate->Date,cbKindEnergy->ItemIndex,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt2") PrintAkt2(dtRDate->Date,cbKindEnergy->ItemIndex,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt3") PrintAkt3(dtBegin->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt4") PrintAkt4(dtRDate->Date,cbKindEnergy->ItemIndex,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt4list") PrintAkt4List(dtRDate->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "akt5") PrintAkt5(dtBegin->Date,dtEnd->Date, cbKindEnergy->ItemIndex,AbonId, ((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "akt_2z") PrintAkt_2zon(dtBegin->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt_tr") PrintAkt_Trans(dtBegin->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt_him") PrintAkt_Him(dtBegin->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "akt_osv") PrintAkt_Osv(dtBegin->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "abonfider") PrintAbonFiders(((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abonfider_mem") PrintAbonFiders_mem(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "prognoz_fider") PrintPrognozFiders(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "fact_fider") PrintPrognozFiders_WithFact(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "abonfider_inf") PrintAbonFidersInfo(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "psfider_mem") PrintPsFiders_mem(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abonps") PrintPSAbons(((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abonnofider") PrintAbonNoFiders(((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abonconnect") PrintAbonConnect(((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "rep_con_abon") PrintConnAbon(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "doc_revis") PrintDocRevis(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "check2kr") Check2KRBills(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "check2kr_area") Check2KRBillsArea(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "check2krNoLimit") Check2KRBillsNoLimit(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "subabons") AbonWithSubAbon();
    if ((PTRepData(CurReport->Data))->ident == "fidersdemand") PrintAbonFidersDemand(dtBegin->Date,dtEnd->Date,AbonId,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "fizabonfiderdem") PrintFizAbonFidersDem(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "tax_reestr") PrintTaxBookNew(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "tax_reestr_2010") PrintTaxBookNew(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "tax_reestr_2011") PrintTaxBookNew2011(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "tax_reestr_fast") PrintTaxBookNew2011_Fast(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "tax_nds_err") PrintTaxNDSErrList(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "nodemand") PrintAbonNoDemand(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "pointnometer") PrintNoMeter ();
    if ((PTRepData(CurReport->Data))->ident == "for4nkre") PrintFor4Nkre(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "4nkre") Print4NKRE(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "tar_2zon") Print2Zone(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "lost_nolost") PrintLost_NoLost(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "r_f32") PrintReact_F32(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "r_f49") PrintF49(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "r_compens") PrintRCompens(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "compens_cnt") PrintCompens5(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abonfider_compens") PrintCompens5_2month_fider(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "oborot_5kr") ObSaldo_5kr(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_volt_lst") PrintAbonLost(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "lighting") MetersLighting(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "abon_count") RepAbonCount(dtEnd->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "point_count") RepPointCount(dtEnd->Date,((TComponent*)(Sender))->Tag==1);    
//    if ((PTRepData(CurReport->Data))->ident == "abon_count_det") RepAbonCountDet(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "pay_abon") PrintPayAbonGrp(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "pointlist") PointsAbon(dtRDate->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "ind_dates") ShowIndicDates(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "switch") ShowSwitching();
    if ((PTRepData(CurReport->Data))->ident == "metnodemand") PrintMeterNoIndication(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "metnodemand2") PrintMeterNoDemand(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "metnodemand3") PrintMeterNoDemandManyMonth(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "meterlist") PrintMetersList();
    if ((PTRepData(CurReport->Data))->ident == "dub_meterlist") DublMetersList();
    if ((PTRepData(CurReport->Data))->ident == "metercheck") MetersControlNow(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "meterchecklate") MetersControlLate(dtRDate->Date);

    if ((PTRepData(CurReport->Data))->ident == "gor1") PrintLetterForGor(AbonId);
    if ((PTRepData(CurReport->Data))->ident == "rentdates") ShowRentDates(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "rentdates_all") ShowRentDatesAll();    
    if ((PTRepData(CurReport->Data))->ident == "cnt05") CountRep2();
    if ((PTRepData(CurReport->Data))->ident == "cnt05_1") CountRep2_1();
    if ((PTRepData(CurReport->Data))->ident == "oborot_err") ObSaldoErr(((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "prognoz") Prognoz(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "all_tar") AllPointTarif(dtBegin->Date,dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "prognozpay") PrognozPay(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "progpayadd") PrognozPayAdd(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "rep_forEN") RepForEN(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "rep_forENR") RepForENReact(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "progpayad5") PrognozPayAdd5(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "progpaydem") PrognozPayDem5(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "point_err") PrintPointHistErr(dtBegin->Date,cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "9nkre_d1") Print9NKRE_d1(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "9nkre_d2") Print9NKRE_d2(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "9nkre_d3") Print9NKRE_d3(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "8nkre") Print8NKRE(dtBegin->Date);    

    if ((PTRepData(CurReport->Data))->ident == "limit_list") PrintLimitList(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "limit_year") PrintLimitYear(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "limit_area_year") PrintLimitGroundYear(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "empty_ind") PrintEmptyIndication(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "avg_area_dem") PrintAreaDemand6(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "avg_area_dem12") PrintAreaDemand12(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "meter_area_dem") PrintAreaDemand_meters(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "border") PrintBorderRes();
    if ((PTRepData(CurReport->Data))->ident == "border2") PrintBorderA();

    if ((PTRepData(CurReport->Data))->ident == "gor_kur") PointsForCuriers(dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "kur_meter") KurMeter(dtRDate->Date);

    if ((PTRepData(CurReport->Data))->ident == "worm_meters") PrintWormMeters(dtBegin->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "freetaxnum") PrintFreeTaxNums(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "taxcheck") PrintTaxCheck(dtBegin->Date,cbKindEnergy->ItemIndex,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "print_tt") PrintTT(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "abontar_2month") PrintAbon2Month(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "tables") ShowTableFields();
    if ((PTRepData(CurReport->Data))->ident == "clientlist") PrintAbonList();
//    if ((PTRepData(CurReport->Data))->ident == "points_ta2") PrintPoints10k(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "points_ta2_all") PrintPointsAll(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "abon_point_un") PrintAbonPointUn(dtBegin->Date,true);
    if ((PTRepData(CurReport->Data))->ident == "clientlist_fps") PrintAbonsExt();

    if ((PTRepData(CurReport->Data))->ident == "monitor_a2") Monitor_A2(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a3") Monitor_A3(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a4") Monitor_A4(((TComponent*)(Sender))->Tag==1 ,dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a6") PrintPoints10k(dtBegin->Date,dtEnd->Date);
    // Для горсетей другой алгоритм
    if ((PTRepData(CurReport->Data))->ident == "monitor_a2m") Monitor_A2_mem(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a3m") Monitor_A3_mem(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a4m") Monitor_A4_mem(((TComponent*)(Sender))->Tag==1, dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a6m") PrintPoints10k_mem(dtBegin->Date,dtEnd->Date);

     if ((PTRepData(CurReport->Data))->ident == "monitor_10k") PrintAbon10k(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "ms_voltage") Monitor_MSVoltage(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "worklist") WorkListAll(dtBegin->Date,dtEnd->Date,AbonId,InspectorId);
    if ((PTRepData(CurReport->Data))->ident == "worklist_dt") WorkListDt(dtBegin->Date,dtEnd->Date,InspectorId);
    if ((PTRepData(CurReport->Data))->ident == "worklistnone") WorkListNone(dtBegin->Date,dtEnd->Date,AbonId);


    if ((PTRepData(CurReport->Data))->ident == "workreq") WorkRequirementCheck(dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "worktech") WorkTechCheck(dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "workcontr") WorkControlCheck(dtRDate->Date);

    if ((PTRepData(CurReport->Data))->ident == "plomblistall") PlombListAll(dtRDate->Date,AbonId,InspectorId);
    if ((PTRepData(CurReport->Data))->ident == "plombinstall") PlombInstall(dtBegin->Date,dtEnd->Date,AbonId,InspectorId);
    if ((PTRepData(CurReport->Data))->ident == "plombdelete") PlombDelete(dtBegin->Date,dtEnd->Date,AbonId,InspectorId);

    if ((PTRepData(CurReport->Data))->ident == "warning_debet") WarningDebet(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,AbonId,InspectorId,0);
    if ((PTRepData(CurReport->Data))->ident == "warning_debet_list") WarningDebet(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,0,InspectorId,1);
    if ((PTRepData(CurReport->Data))->ident == "warning_avans") WarningAvans(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,AbonId,InspectorId,0);
    if ((PTRepData(CurReport->Data))->ident == "warning_avans_list") WarningAvans(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date,0,InspectorId,1);

    if ((PTRepData(CurReport->Data))->ident == "nasp_demand") PrintNasPTarifAbons(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "eqp_change") PrintEqpChanges(dtBegin->Date,dtEnd->Date,AbonId,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "point_change") PrintPoinPowerChanges(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "inspect_control")  InspectControlReport(dtBegin->Date,dtEnd->Date,InspectorId);
    if ((PTRepData(CurReport->Data))->ident == "meter_unchecked") PrintUncheckedMeters(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "homenets_demand") HomeNetsDemand(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "noplombnowork") PointsNoPlombNoWork();
    if ((PTRepData(CurReport->Data))->ident == "meter_change") PrintMeterChanges(dtBegin->Date,dtEnd->Date,AbonId);
    if ((PTRepData(CurReport->Data))->ident == "meter_change2") PrintMeterCheckChanges(dtBegin->Date,dtEnd->Date,AbonId);

    if ((PTRepData(CurReport->Data))->ident == "grafic_work1") GraficWork_fiders(dtBegin->Date,1,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "grafic_work2") GraficWork_fiders(dtBegin->Date,2,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "grafic_work1_f") GraficWork_fiders_fact(dtBegin->Date,1,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "grafic_work2_f") GraficWork_fiders_fact(dtBegin->Date,2,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "grafic3") PrintAbonFiders_grafic_mem(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "grafic3_f") PrintAbonFiders_grafic_fact(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "grafic_summary") GraficWork_symmary(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "meter_indic_hist") Print_Indic_History(dtBegin->Date,dtEnd->Date,AbonId,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "abon_count_volt") PrintAbonCountMonitor(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "monitor2010_ps10") Monitor_PS_2010(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a4_2010") Monitor_A4_2010(((TComponent*)(Sender))->Tag==1 ,dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "monitor_a2_2010") Monitor_A2_2010(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "monitor_a3_2010") Monitor_A3_2010(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "limit2kr_calc") DemandLimit_AvansCalc(((TComponent*)(Sender))->Tag==1,dtRDate->Date, dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "bad_indic_list") BadIndicList(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "3nkre") Print3NKRE(((TComponent*)(Sender))->Tag==1,dtBegin->Date, dtEnd->Date );

    if ((PTRepData(CurReport->Data))->ident == "abonpower") PrintAbonPower(dtRDate->Date);

    if ((PTRepData(CurReport->Data))->ident == "fider_monitoring") Fider_monitoring(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "fider_monitoring_2") Fider_monitoring_2periods(dtBegin->Date,dtEnd->Date,dtBegin_2->Date,dtEnd_2->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "meter_indications") MeterIndicationList(dtRDate->Date,AbonId,FiderId,InspectorId);

    if ((PTRepData(CurReport->Data))->ident == "tax_list_abon") PrintTaxList_Abon(dtBegin->Date,dtEnd->Date,AbonId);

    if ((PTRepData(CurReport->Data))->ident == "master_demand") MastersPowerDemand(dtBegin->Date,dtEnd->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "reactiv_2010") Reactiv_2010(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "masters_demand") MastersDemandAktList(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "masters_akt") MastersDemandAkt(dtBegin->Date,AbonId,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "renthist") RentHist(dtBegin->Date,true);

    if ((PTRepData(CurReport->Data))->ident == "point_dem_year") PrintAbonPointDemandYear(dtBegin->Date,cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "unif_fiz") PrintFizAndUnif(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "point_procent") PrintAbonPointProcent(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "ps10_load") PS10_AbonLoad(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "ps10_demand") PS10_AbonDemand(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "ps35_load") PS35_AbonLoad(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "ps35_summary") PS35_AbonSummary(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "abon_area_dem") PrintAreaDemand_mem(dtBegin->Date,AbonId);

    if ((PTRepData(CurReport->Data))->ident == "common_account") PrintCommonAccInfo(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "abon_tar_year") PrintAbonTarYear(dtBegin->Date,AbonId);

    if ((PTRepData(CurReport->Data))->ident == "switch_list") PrintSwitchList(((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "area_check") CheckAreaParams();

    if ((PTRepData(CurReport->Data))->ident == "check_limit_power") CheckLimitPowerArea(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "homenet_lines") HomenetLines();
    if ((PTRepData(CurReport->Data))->ident == "compens_tp_abon") PrintAbonCompensList();
    if ((PTRepData(CurReport->Data))->ident == "abon_area_summary") AbonAreaSummary();

    if ((PTRepData(CurReport->Data))->ident == "ps10_rezerv") PS10_Rezerv(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "ps35_rezerv") PS35_Rezerv();

    if ((PTRepData(CurReport->Data))->ident == "zone_meters") Zone_meters_all(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "saldo_dt_kt") Saldo_AllEnergy(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "meterlistavg") PrintMetersAvgDemand(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "avans_analiz") AvansAnializ(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

    if ((PTRepData(CurReport->Data))->ident == "ttchecklate") PrintTTControlList(dtRDate->Date, (cbAll->Checked?1:0));

    if ((PTRepData(CurReport->Data))->ident == "meter2_5") Meters2_5List(dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "meter_tt_check") MetersAndTTControlWarning(dtRDate->Date);
    if ((PTRepData(CurReport->Data))->ident == "point_dem_magnet") PrintAbonPointDemandYear_Magnet(dtBegin->Date);
    if ((PTRepData(CurReport->Data))->ident == "reactiv_2014") Reactiv_2014(dtBegin->Date,dtEnd->Date);
    if ((PTRepData(CurReport->Data))->ident == "oborot_2kr2014") Print2kr2014(dtBegin->Date);

    if ((PTRepData(CurReport->Data))->ident == "limit_area_change") PrintLimitAreaChange(dtBegin->Date,dtEnd->Date);

    if ((PTRepData(CurReport->Data))->ident == "own_needs") PrintAbonOwnNeeds(dtBegin->Date,dtEnd->Date,cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "debet_pay") AbonDebetPay(dtBegin->Date, ((TComponent*)(Sender))->Tag==1, cbKindEnergy->ItemIndex);
    if ((PTRepData(CurReport->Data))->ident == "abon_extra") PrintAbonExtra(dtBegin->Date, cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "oborot_1_all") ObSaldoAbonForAll(dtBegin->Date,cbKindEnergy->ItemIndex,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "old_kt") PrintOldKt(dtRDate->Date,cbKindEnergy->ItemIndex);

    if ((PTRepData(CurReport->Data))->ident == "masters_demand_det") MastersDemandAktListDetail(dtBegin->Date,((TComponent*)(Sender))->Tag==1);
    if ((PTRepData(CurReport->Data))->ident == "masters_losts_det") MastersDemandLostsDetail(dtBegin->Date,((TComponent*)(Sender))->Tag==1);

  btGo->Enabled=true;

  btPrint->Enabled=true;
}
//----------------------- ----------------------------------------------------
void __fastcall TfReports::tRepsChanging(TObject *Sender, TTreeNode *Node,
      bool &AllowChange)
{
  CurReport=Node;
  if ((PTRepData(CurReport->Data))->ident == "_gr")
   {
   btGo->Enabled=false;
   btPrint->Enabled=false;
   }
  else
   {
   btGo->Enabled=true;
   btPrint->Enabled=true;
   }

  if (((((PTRepData(CurReport->Data))->params)&16384) > 0) ) pExecutor->Visible=true;
  else pExecutor->Visible=false;

  if (((((PTRepData(CurReport->Data))->params)&8192) > 0) ) pLostNolost->Visible=true;
  else pLostNolost->Visible=false;

  if (((((PTRepData(CurReport->Data))->params)&4096) > 0) ) pAll->Visible=true;
  else pAll->Visible=false;

  if (((((PTRepData(CurReport->Data))->params)&2048) > 0) ) pPeriod_2->Visible=true;
  else pPeriod_2->Visible=false;

  if (((((PTRepData(CurReport->Data))->params)&1024) > 0) ) pInspector->Visible=true;
  else pInspector->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&512) > 0)  pTarif->Visible=true;
  else pTarif->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&256) > 0)  pPS->Visible=true;
  else pPS->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&128) > 0)  pKey->Visible=true;
  else pKey->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&64) > 0)  pUrFiz->Visible=true;
  else pUrFiz->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&32) > 0)  pFiders->Visible=true;
  else pFiders->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&16) > 0)  pValue->Visible=true;
  else pValue->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&8) > 0)  pKindEn->Visible=true;
  else pKindEn->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&4) > 0)  pDate->Visible=true;
  else pDate->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&2) > 0)  pPeriod->Visible=true;
  else pPeriod->Visible=false;

  if ((((PTRepData(CurReport->Data))->params)&1) >0 ) pAbon->Visible=true;
  else pAbon->Visible=false;

  if (((PTRepData(CurReport->Data))->ident == "f32")
  //||((PTRepData(CurReport->Data))->ident == "NDS2011")
  ||((PTRepData(CurReport->Data))->ident == "lost_nolost")||((PTRepData(CurReport->Data))->ident == "abon_volt_lst"))
     btFile->Enabled=true;
  else
     btFile->Enabled=false;

  lFullName->Caption=(PTRepData(CurReport->Data))->full_name;

}
//---------------------------------------------------------------------------

__fastcall TfReports::TfReports(TComponent* Owner)
        : TfTWTCompForm(Owner)
{

  ZQXLReps->Database=TWTTable::Database;
  ZQXLReps2->Database=TWTTable::Database;
  ZQXLReps3->Database=TWTTable::Database;
  ZQXLRepsSum->Database=TWTTable::Database;
  ZQXLRepsSum2->Database=TWTTable::Database;
  ZQXLRepsSum3->Database=TWTTable::Database;

//  Application->CreateForm(__classid(TfQReps), &fQReps);


  ZQReps = new TWTQuery(Application);
  ZQReps->MacroCheck=true;
  ZQReps->Options<< doQuickOpen;
  ZQReps->RequestLive=false;
  ZQReps->CachedUpdates=false;
//  ZQReps->Transaction->AutoCommit=true;

  AnsiString sqlstr="select getsysvar('id_person'::::varchar) as curuser;";

  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    cur_user=ZQReps->FieldByName("curuser")->AsInteger;
   }
  ZQReps->Close();

   sqlstr="select to_date(value_ident,'DD.MM.YYYY') as val from syi_sysvars_tbl where ident='mmgg';";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   try
   {
    ZQReps->Open();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
   cur_mmgg = ZQReps->FieldByName("val")->AsDateTime;
   ZQReps->Close();


  sqlstr="select res.id,res.kind_dep,res.short_name, res.name, scl.phone as res_phone, scl.addr_tax,  \
  boss.name as bospos,boss.represent_name as bossname,boss.phone as bossphone, buh.name as buhpos,buh.represent_name as buhname, \
  users.represent_name as usrname, users.phone as userphone,ip.name as usrpos \
  from clm_client_tbl as res \
  join clm_statecl_tbl as scl on (scl.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
   left join clm_position_tbl as users on (users.id = :user ) \
   left join cli_position_tbl as ip  on (ip.id = users.id_position) \
  where res.id = syi_resid_fun() ;";



  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("user")->AsInteger =cur_user ;
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    ZQReps->First();
    ResId=ZQReps->FieldByName("id")->AsInteger;
    ResName=ZQReps->FieldByName("short_name")->AsString;
    ResAddr=ZQReps->FieldByName("addr_tax")->AsString;
    ResPhone=ZQReps->FieldByName("res_phone")->AsString;
    ResFullName=ZQReps->FieldByName("name")->AsString;
    res_code=ZQReps->FieldByName("kind_dep")->AsInteger;

   // cur_user=ZQReps->FieldByName("curuser")->AsInteger;
    CurUserName=ZQReps->FieldByName("usrname")->AsString;
    CurUserPos=ZQReps->FieldByName("usrpos")->AsString;
    CurUserPhone=ZQReps->FieldByName("userphone")->AsString;
    BossName=ZQReps->FieldByName("bossname")->AsString.Trim();
    BossPhone=ZQReps->FieldByName("bossphone")->AsString;
    BossPos=ZQReps->FieldByName("bospos")->AsString.Trim();
    BuhName=ZQReps->FieldByName("buhname")->AsString;
    BuhPos=ZQReps->FieldByName("buhpos")->AsString;
    }
  ZQReps->Close();

  sqlstr="select * from rep_kinds_tbl order by id;";
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   ZQReps->First();

   NodeDataList = new TList;
   TTreeNode *Node1;

   for (int i = 0; i<=ZQReps->RecordCount-1;i++)
   {

     if (ZQReps->FieldByName("id_group")->IsNull)
     {
       Node1=tReps->Items->Add(NULL,ZQReps->FieldByName("name")->AsString);
     }
     else
     {
      for (int j=0;j<=tReps->Items->Count-1;j++)
      {
       if (PTRepData(tReps->Items->Item[j]->Data)->id==ZQReps->FieldByName("id_group")->AsInteger)
       {
         Node1=tReps->Items->AddChild(tReps->Items->Item[j],ZQReps->FieldByName("name")->AsString);
         break;
       }
      }
     }
     PTRepData NodeData= new TRepData;
     NodeData->id=ZQReps->FieldByName("id")->AsInteger;
     NodeData->full_name=ZQReps->FieldByName("full_name")->AsString;
     NodeData->file_name=ZQReps->FieldByName("file_name")->AsString;
//     NodeData->proc_name=ZQReps->FieldByName("proc_name")->AsString;
     NodeData->ident=ZQReps->FieldByName("ident")->AsString;
     NodeData->params=ZQReps->FieldByName("flag_param")->AsInteger;
     Node1->Data=NodeData;
     NodeDataList->Add(NodeData);

     ZQReps->Next();
   }
   ZQReps->Close();

  btGo->Enabled=false;
  btPrint->Enabled=false;

  sqlstr="select fun_mmgg();";
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    ZQReps->First();
    WorkDate=ZQReps->Fields->Fields[0]->AsDateTime;
    WorkDate_2=ZQReps->Fields->Fields[0]->AsDateTime;    
   }
  ZQReps->Close();

  dtBegin->Date=WorkDate;
  dtEnd->Date=IncMonth(dtBegin->Date,1)-1;
  dtBegin->Time=0;
  dtEnd->Time=0;

  dtBegin_2->Date=WorkDate_2;
  dtEnd_2->Date=IncMonth(dtBegin_2->Date,1)-1;
  dtBegin_2->Time=0;
  dtEnd_2->Time=0;

  edMonth->Text=FormatDateTime("mmmm yyyy",WorkDate);
  edMonth_2->Text=FormatDateTime("mmmm yyyy",WorkDate_2);

  tReps->FullExpand();

  dtRDate->Date=Now();
  cbKindEnergy->ItemIndex = 0;
  edValue->Text = FormatFloat("0.00",0.01);
}
//---------------------------------------------------------------------------
void TfReports::ObSaldo(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям


  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (select coalesce(obr.roz,999)as link, sum(nar) as snar, sum(nar_v) as snar_v, sum(opl_zv) as sopl_zv, \
     -sum(deb_zpmv) as sdeb, sum(kr_zpmv) as skr_zpmv, - sum(deb_pm99v) as sdeb99 ,- sum(deb_pm00v) as sdeb00,\
     -sum(deb_pm01v) as sdeb01,- sum(deb_pm02v) as  sdeb02, \
     -sum(deb_pm03v)  as sdeb03,- sum(deb_pm04v) as sdeb04, - sum(deb_pm05v) as sdeb05, \
     -sum(deb_pm06v) as sdeb06, -sum(deb_pm07v) as sdeb07,-sum(deb_pm08v) as sdeb08, -sum(deb_pm09v) as sdeb09, \
     -sum(deb_pm10v) as sdeb10, -sum(deb_pm11v) as sdeb11, -sum(deb_pm12v) as sdeb12,  -sum(deb_pm13v) as sdeb13, \
     -sum(deb_pm14v) as sdeb14, \
     -sum(deb_kmv) as sdeb_k, sum(kr_zkmv) as skr_zkmv, - sum(deb_km99v) as sdeb99_k ,- sum(deb_km00v) as sdeb00_k, \
     -sum(deb_km01v) as sdeb01_k,- sum(deb_km02v) as  sdeb02_k, \
     -sum(deb_km03v) as sdeb03_k,- sum(deb_km04v) as sdeb04_k, - sum(deb_km05v) as sdeb05_k, \
     -sum(deb_km06v) as sdeb06_k,-sum(deb_km07v) as sdeb07_k ,-sum(deb_km08v) as sdeb08_k, -sum(deb_km09v) as sdeb09_k, \
     -sum(deb_km10v) as sdeb10_k, -sum(deb_km11v) as sdeb11_k, -sum(deb_km12v) as sdeb12_k , -sum(deb_km13v) as sdeb13_k, \
     -sum(deb_km14v) as sdeb14_k  \
     from %obrtable as obr join clm_client_tbl c  on (c.id = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) group by obr.roz )as sss \
     join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;


  // по потребителям


  AnsiString  sqlstr1="  select coalesce(obr.roz,999) as link ,obr.osob_r,obr.osob_rsk as abon_name ,c.represent_name,\
     nar, nar_v,opl_zv, \
     -deb_zpmv as deb, kr_zpmv, - deb_pm99v as deb99 ,- deb_pm00v as deb00, - deb_pm01v as deb01, \
     - deb_pm02v as  deb02, \
     -deb_pm03v  as deb03,- deb_pm04v as deb04, - deb_pm05v as deb05,\
     -deb_pm06v as deb06, -deb_pm07v as deb07, -deb_pm08v as deb08, -deb_pm09v as deb09, -deb_pm10v as deb10, -deb_pm11v as deb11, \
     -deb_pm12v as deb12, -deb_pm13v as deb13, -deb_pm14v as deb14, \
     -deb_kmv as deb_k,kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, - deb_km05v as deb05_k, \
     -deb_km06v as deb06_k, -deb_km07v as deb07_k , -deb_km08v as deb08_k , -deb_km09v as deb09_k, -deb_km10v as deb10_k , \
     -deb_km11v as deb11_k, -deb_km12v as deb12_k, -deb_km13v as deb13_k, -deb_km14v as deb14_k \
     from %obrtable as obr join (select c.*,s.id_position,p.represent_name from clm_client_tbl c,clm_statecl_tbl s \
     left join clm_position_tbl p on (s.id_position=p.id ) where s.id_client=c.id ) as c on (c.id = obr.id_client)  \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);


  if (kind_energy==1)
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  else
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";

  if (kind_energy == 0)  xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за активну електроенергію";
  if (kind_energy == 1)  xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за реактивну електроенергію";
  if (kind_energy == 2)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр споживання з ПДВ ).";
  if (kind_energy == 4)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр споживання без ПДВ ).";
  if (kind_energy == 5)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Передача електроенергії.";
  if (kind_energy == 8)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Інформаційні послуги.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::Sales(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);
  AnsiString sqlstr;

  if (kind_energy>1) return;


  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select sss.*,cla.name from \
    (select coalesce(obr.roz,999) as link, sum(nar_v) as nar_v, sum(nar_e) as nar_e ,sum(nar_pdv)as nar_pdv , \
    sum(opl_zv)as opl_zv,sum(opl_zpdv)as opl_zpdv ,sum(opl_bv)as opl_bv ,sum(opl_bpdv)as opl_bpdv, \
    sum(- deb_zpmv) as d_b, sum(- deb_zpmpdv) as d_b_pdv, \
    sum(kr_zpmv)as kr_zpmv, sum(kr_zpmpdv) as kr_zpmpdv, \
    sum(- deb_kmv) as d_k, sum(- deb_kmpdv) as d_k_pdv, sum(kr_zkmv) as kr_zkmv, \
    sum(kr_zkmpdv) as kr_zkmpdv ,sum(nar) as nar \
    from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    where obr.period = :mmgg and obr.idk_work not in (0,99) and obr.id_pref = :pref group by obr.roz )as sss \
    join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  AnsiString  sqlstr2=" select sum(nar_v) as snar_v, sum(nar_e) as snar_e ,sum(nar_pdv)as snar_pdv , \
    sum(opl_zv)as sopl_zv,sum(opl_zpdv)as sopl_zpdv ,sum(opl_bv)as sopl_bv ,sum(opl_bpdv)as sopl_bpdv, \
    sum(- deb_zpmv) as sd_b, sum(- deb_zpmpdv) as sd_b_pdv, \
    sum(kr_zpmv)as skr_zpmv, sum(kr_zpmpdv) as skr_zpmpdv, \
    sum(- deb_kmv) as sd_k, sum(- deb_kmpdv) as sd_k_pdv, sum(kr_zkmv) as skr_zkmv, \
    sum(kr_zkmpdv) as skr_zkmpdv ,sum(nar) as snar \
    from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps2->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps2->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps2->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps2->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps2->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps2->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps2->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps2->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps2->ParamByName("pref")->AsInteger=120;


  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // если все нормально, запустим отчет
  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->DataSet = ZQXLReps2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  //Param=xlReport->Params->Add();
  //Param->Name="lyear";


  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  //xlReport->ParamByName["lyear"]->Value = IntToStr(year1);
  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Довідка про фактичну реалізацію за активну електроенергію";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Довідка про фактичну реалізацію за реактивну електроенергію";


  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
}
//---------------------------------------------------------------------------

void TfReports::SalesAbon(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);
  AnsiString sqlstr;

  if (kind_energy>1) return;


  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select sss.*,cla.name from \
    (select coalesce(obr.roz,999) as link, sum(nar_v) as nar_v, sum(nar_e) as nar_e ,sum(nar_pdv)as nar_pdv , \
    sum(opl_zv)as opl_zv,sum(opl_zpdv)as opl_zpdv ,sum(opl_bv)as opl_bv ,sum(opl_bpdv)as opl_bpdv, \
    sum(- deb_zpmv) as d_b, sum(- deb_zpmpdv) as d_b_pdv, \
    sum(kr_zpmv)as kr_zpmv, sum(kr_zpmpdv) as kr_zpmpdv, \
    sum(- deb_kmv) as d_k, sum(- deb_kmpdv) as d_k_pdv, sum(kr_zkmv) as kr_zkmv, \
    sum(kr_zkmpdv) as kr_zkmpdv ,sum(nar) as nar \
    from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client = c.id ) \
    where obr.period = :mmgg and obr.idk_work not in (0,99) and obr.id_pref = :pref \
    and ((stcl.id_position = :insp) or ( :insp is null) ) \
    group by obr.roz )as sss \
    join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;


  AnsiString  sqlstr2=" select sum(nar_v) as snar_v, sum(nar_e) as snar_e ,sum(nar_pdv)as snar_pdv , \
    sum(opl_zv)as sopl_zv,sum(opl_zpdv)as sopl_zpdv ,sum(opl_bv)as sopl_bv ,sum(opl_bpdv)as sopl_bpdv, \
    sum(- deb_zpmv) as sd_b, sum(- deb_zpmpdv) as sd_b_pdv, \
    sum(kr_zpmv)as skr_zpmv, sum(kr_zpmpdv) as skr_zpmpdv, \
    sum(- deb_kmv) as sd_k, sum(- deb_kmpdv) as sd_k_pdv, sum(kr_zkmv) as skr_zkmv, \
    sum(kr_zkmpdv) as skr_zkmpdv ,sum(nar) as snar \
    from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client = c.id ) \
    where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
    and ((stcl.id_position = :insp) or ( :insp is null) ) ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (InspectorId!=0)
     ZQXLReps2->ParamByName("insp")->AsInteger=InspectorId;


  if (kind_energy==0)    ZQXLReps2->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps2->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps2->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps2->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps2->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps2->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps2->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps2->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps2->ParamByName("pref")->AsInteger=120;



  AnsiString  sqlstr3="  select obr.osob_r,obr.osob_rsk as abon_name ,p.represent_name , \
    coalesce(obr.roz,999) as link, nar_v,  nar_e , nar_pdv , \
    opl_zv, opl_zpdv , opl_bv , opl_bpdv, \
    - deb_zpmv as d_b, - deb_zpmpdv as d_b_pdv,  kr_zpmv, kr_zpmpdv, \
    - deb_kmv as d_k, - deb_kmpdv as d_k_pdv, kr_zkmv,  kr_zkmpdv , nar \
    from seb_obr_all_tmp as obr \
    join clm_client_tbl as c on (c.id = obr.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client = c.id ) \
    left join clm_position_tbl p on (stcl.id_position=p.id ) \
    where obr.period = :mmgg and obr.idk_work not in (0,99) and obr.id_pref = :pref  \
    and ((stcl.id_position = :insp) or ( :insp is null) ) \
    order by link,obr.osob_r;  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr3);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps2->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // если все нормально, запустим отчет
  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->Alias =  "ZQXLRepsAll";
  Dsr->DataSet = ZQXLReps2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Довідка про фактичну реалізацію за активну електроенергію";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Довідка про фактичну реалізацію за реактивну електроенергію";

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
  ZQXLRepsSum->Close();

  ZQXLReps->MasterSource=NULL;
  ZQXLReps->LinkFields="";

}

//---------------------------------------------------------------------------
void __fastcall TfReports::FormClose(TObject *Sender, TCloseAction &Action)
{
 TfTWTCompForm::FormClose(Sender,Action);

 for (int i=0;i<NodeDataList->Count;i++)
 {
 delete (NodeDataList->Items[i]);
 }
 delete NodeDataList;
// delete fQReps;

 Action = caFree;
}

//---------------------------------------------------------------------------

void __fastcall TfReports::sbDecClick(TObject *Sender)
{
  WorkDate=IncMonth(WorkDate,-1);
  dtBegin->Date=WorkDate;
  dtEnd->Date=IncMonth(dtBegin->Date,1)-1;
  dtBegin->Time=0;
  dtEnd->Time=0;
  edMonth->Text=FormatDateTime("mmmm yyyy",WorkDate);
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbIncClick(TObject *Sender)
{
  WorkDate=IncMonth(WorkDate,1);
  dtBegin->Date=WorkDate;
  dtEnd->Date=IncMonth(dtBegin->Date,1)-1;
  dtBegin->Time=0;
  dtEnd->Time=0;
  edMonth->Text=FormatDateTime("mmmm yyyy",WorkDate);
}
//---------------------------------------------------------------------------
void TfReports::IndicToDate(void)

{
/*
  AnsiString  sqlstr1=" SELECT clm.id, clm.name, clm.code FROM clm_client_tbl as clm join clm_statecl_tbl as clp \
  on ((clm.id = clp.id_client)and (clp.period_indicat is not null)and (clp.period_indicat <>0) and (clm.book is null) ) \
  where (date_part('day', :dt_rep::::timestamp)=clp.dt_indicat) and \
      (date_part('month', :dt_rep::::timestamp) =(clp.period_indicat*(trunc((date_part('month', :dt_rep::::timestamp)-1)/clp.period_indicat))+clp.month_indicat)) order by clm.code;";

*/
  AnsiString  sqlstr1=" SELECT clm.id, clm.name, clm.code, sc.phone,cp.represent_name FROM clm_client_tbl as clm \
  join clm_statecl_tbl as sc on (clm.id = sc.id_client) \
  left join clm_position_tbl as cp on (sc.id_position=cp.id) \
  where clm.book<0 and clm.idk_work not in (0,99) and coalesce(clm.id_state,0) not in (50,99,3) \
  and sc.dt_end_rent is null \
  and date_trunc('day',:dt_rep::::date)::::date=to_date(substr( sel_dt(clm.id,date_trunc('month',:dt_rep::::date)::::date),12),'yyyy.mm.dd') \
  and ( :insp is null or sc.id_position = :insp) \
  order by clm.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_rep")->AsDateTime=dtRDate->Date;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldate";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldate"]->Value = FormatDateTime("dd mm yyyy",dtRDate->Date);

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

/*
  Crpe1->Connect->ServerName = "energo";
  Crpe1->Connect->UserID = "osa";
  Crpe1->Connect->Password = "";
  */
  //Crpe1.Connect.DatabaseName := 'Company1';


/*
  AnsiString Parstr1="res;"+ResName+";TRUE";
  AnsiString Parstr2="dt_rep;Date("+FormatDateTime("yyyy,m,d",dtRDate->Date)+");TRUE";

  CrystalReport->ParameterFields[0]=WideString(Parstr1).c_bstr();
  CrystalReport->ParameterFields[1]=WideString(Parstr2).c_bstr();

  CrystalReport->PrintReport();
*/
 /*
  Crpe1->ParamByName("res","")->CurrentValue = ResName;
  Crpe1->ParamByName("dt_rep","")->CurrentValue = CrDateToStr(dtRDate->Date);
   */
 /*
  CrystalReport->ParameterFields[0]=WideString("month;12;TRUE").c_bstr();
  CrystalReport->ParameterFields[1]=WideString("year;2003;TRUE").c_bstr();
  CrystalReport->ParameterFields[2]=WideString("res;Черниговский РЕС;TRUE").c_bstr();
 */


//if (Crpe1->Connect->Test()) Crpe1->Show();

}
/*
void __fastcall TfReports::CrpeDS1GetFieldCount(TObject *Sender,
      TDataSet *DataSet, short &FieldCount)
{
 ShowMessage("FieldCount :"+IntToStr(FieldCount));
}
//---------------------------------------------------------------------------

void __fastcall TfReports::CrpeDS1GetFieldName(TObject *Sender,
      TDataSet *DataSet, short FieldIndex, WideString &FieldName)
{
 ShowMessage("FieldIndex:"+IntToStr(FieldIndex));
 ShowMessage("FieldName:"+FieldName);
}
//---------------------------------------------------------------------------

void __fastcall TfReports::CrpeDS1GetFieldType(TObject *Sender,
      TDataSet *DataSet, short FieldIndex, short &FieldType)
{
 ShowMessage("FieldIndex:"+IntToStr(FieldIndex));
 ShowMessage("FieldType:"+IntToStr(FieldType));
}
//---------------------------------------------------------------------------

void __fastcall TfReports::CrpeDS1GetRecordCount(TObject *Sender,
      TDataSet *DataSet, int &RecordCount)
{
 ShowMessage("RecordCount :"+IntToStr(RecordCount));
}
*/
//---------------------------------------------------------------------------

void __fastcall TfReports::Button1Click(TObject *Sender)
{
/*
//  Crpe1->ReportName="Report1.rpt";
  Crpe1->ReportName="oborot_q.rpt";
  Crpe1->DiscardSavedData();

  AnsiString  sqlstr1="select potr,debet,kt,bdt,bkt,kdt,kkt,id_client,bs,bs1,bs2,bs3,bsold,es,es1,es2,\
 es3,esold,abon_name,abon_code,industry1,industry2 from rep_ob_sal_tbl;";

  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr1);
   try
  {
    ZQReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  CrpeDS1->DataSet=ZQReps;
  Crpe1->Tables->Items[0]->DataPointer=CrpeDS1->DataPointer();

if (Crpe1->Connect->Test())
Crpe1->Show();
*/
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbAbonClick(TObject *Sender)
{
  TWTDBGrid* Grid;
  Grid=MainForm->CliClientMSel();
  if(Grid==NULL) return;
  else WAbonGrid=Grid;

  //WAbonGrid->FieldSource = WAbonGrid->Table->GetTField("id");
  WAbonGrid->FieldSource = WAbonGrid->Query->GetTField("id");
  WAbonGrid->StringDest = "1";
  WAbonGrid->OnAccept=AbonAccept;

}
//---------------------------------------------------------------------------
void __fastcall TfReports::AbonAccept (TObject* Sender)
{
  AbonId=WAbonGrid->Query->FieldByName("id")->AsInteger;
  edAbonName->Text=WAbonGrid->Query->FieldByName("short_name")->AsString;
  edAbonCode->Text=WAbonGrid->Query->FieldByName("code")->AsString;
  AbonFullName=WAbonGrid->Query->FieldByName("name")->AsString;
}
//---------------------------------------------------------------------------
void TfReports::F32 (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_f32_fun( :mmgg);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1="select ident, caption, demand_tcl1, sum_tcl1, demand_tcl2,sum_tcl2,gr_lvl \
   from rep_f32_tbl where mmgg = :pmmgg::::date and part_code not in (10,11,12,13,16,17) order by part_code,num,ident";
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------
void TfReports::Zone_meters_all (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select seb_diftarif( :mmgg,0);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select clm.code,clm.short_name,  \
  z.eqp_type,z.eqp_num , adr.adr, \
 coalesce(kvt1,0)::::numeric as demand_z1, \
 coalesce(kvt2,0)::::numeric as demand_z2, \
 coalesce(kvt3,0)::::numeric as demand_z3, \
 coalesce(kvt1,0)::::numeric + \
 coalesce(kvt2,0)::::numeric + \
 coalesce(kvt3,0)::::numeric as demand_z_all \
 from seb_diftarif_tmp as z \
 join clm_client_tbl as clm on (clm.code=z.code ) \
 join eqm_equipment_h as eq on (eq.id = z.id_point) \
 left join adv_address_tbl as adr on (adr.id = coalesce(eq.id_addres,clm.id_addres)) \
 where z.mmgg = :pmmgg  \
 and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 \
   where eq2.id = z.id_point and eq2.dt_b <= :pmmgg::::date +'1 month'::::interval ) \
 order by clm.code, z.eqp_num ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}

//---------------------------------------------------------------------------
void TfReports::R3Zone_meters (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_3zone_fun( :mmgg);";
//  AnsiString sqlstr="select seb_diftarif( :mmgg,0);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
/*
  AnsiString  sqlstr1=" select clm.code,clm.short_name, z.class as cltar, \
 z.id_group as grtar_cod, z.eqp_type||' №'||z.eqp_num as type , \
 sum(coalesce(kvt1::::numeric,0)/1000)::::numeric as demand_z1, \
 sum(coalesce(kvt2::::numeric,0)/1000)::::numeric as demand_z2, \
 sum(coalesce(kvt3::::numeric,0)/1000)::::numeric as demand_z3, \
 sum(coalesce(demand3_old::::numeric,0)/1000)::::numeric as demand_z3_old, \
 sum(coalesce(demand3_new::::numeric,0)/1000)::::numeric as demand_z3_new, \
 sum(coalesce(sum1::::numeric,0))::::numeric as sum_z1, \
 sum(coalesce(sum2::::numeric,0))::::numeric as sum_z2, \
 sum(coalesce(sum3::::numeric,0))::::numeric as sum_z3, \
 sum(coalesce(sum3_old::::numeric,0))::::numeric as sum_z3_old, \
 sum(coalesce(sum3_new::::numeric,0))::::numeric as sum_z3_new \
 from seb_diftarif_tmp as z \
 join clm_client_tbl as clm on (clm.code=z.code ) \
  left join ( select bs.id_point, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.demand_val ELSE 0 END) as demand3_old, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.demand_val ELSE 0 END) as demand3_new, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.sum_val ELSE 0 END) as sum3_old, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.sum_val ELSE 0 END) as sum3_new \
	from acd_billsum_tbl as bs \
	join acm_bill_tbl as bm using (id_doc) \
	join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
	where bs.id_zone in (1,2,3) and bs.kind_energy=1 \
        and  bs.mmgg = :pmmgg \
        group by bs.id_point ) as bill on (bill.id_point  = z.id_point) \
 where z.mmgg = :pmmgg and z.kind =3 and clm.book =-1 \
 group by clm.code, clm.short_name, z.class , z.id_group , z.eqp_type||' №'||z.eqp_num order by clm.code;";
 */


  AnsiString  sqlstr1="select ss.*,demand3_old,demand3_new,sum3_old,sum3_new \
  from \
  (select clm.code,clm.short_name, substr(tcl.ident,4,1)::::varchar as cltar,tgr.ident as grtar, \
  CASE WHEN tgr.ident = 'tgr1' then 1 WHEN tgr.ident = 'tgr2' then 2 \
 WHEN tgr.ident = 'tgr3' then 5 WHEN tgr.ident = 'tgr4' then 6 \
 WHEN tgr.ident = 'tgr5' then 7 WHEN tgr.ident = 'tgr6' then 4 \
 WHEN tgr.ident like 'tgr7%' then 8 WHEN tgr.ident like 'tgr8%' then 9  end as grtar_cod, \
 m.type||' №'||z.num_eqp as type , \
 sum( coalesce(demand_z1::::numeric,0)/1000)::::numeric as demand_z1, \
 sum(coalesce(demand_z2::::numeric,0)/1000)::::numeric as demand_z2, \
 sum(coalesce(demand_z3::::numeric,0)/1000)::::numeric as demand_z3, \
 sum(coalesce(sum_z1::::numeric,0))::::numeric as sum_z1, \
 sum(coalesce(sum_z2::::numeric,0))::::numeric as sum_z2, \
 sum(coalesce(sum_z3::::numeric,0))::::numeric as sum_z3, \
 z.id_point \
 from rep_3zone_tbl as z left \
 join clm_client_tbl as clm on (clm.id=z.id_client) \
 left join aci_tarif_tbl as tar on (tar.id=z.id_tariff) \
 join eqi_grouptarif_tbl as tgr on (tgr.id=tar.id_grouptarif) \
 join eqi_classtarif_tbl as tcl on (tcl.id=tar.id_classtarif) \
 join eqi_meter_tbl as m on (z.id_type_meter=m.id) \
 where (tgr.ident not like 'tgr9%') \
 and z.mmgg = :pmmgg \
  group by clm.code, clm.short_name, substr(tcl.ident,4,1) ,tgr.ident, m.type||' №'||z.num_eqp, z.id_point \
) as ss \
  left join ( select bs.id_point, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.demand_val ELSE 0 END::::numeric/1000) as demand3_old, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.demand_val ELSE 0 END::::numeric/1000) as demand3_new, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.sum_val ELSE 0 END) as sum3_old, \
	sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.sum_val ELSE 0 END) as sum3_new \
	from acd_billsum_tbl as bs \
	join acm_bill_tbl as bm using (id_doc) \
	join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
	where bs.id_zone in (1,2,3) and bs.kind_energy=1 \
        and  bs.mmgg = :pmmgg \
        group by bs.id_point ) as bill on (bill.id_point  = ss.id_point) \
  order by ss.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  if ((year1 = 2014)&&(month1==12))
     xlReport->XLSTemplate = "XL\\met_3zon_12_2014.xls";
  else
     xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;



  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------
void TfReports::R3Zone_tar (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  //AnsiString sqlstr="select rep_3zone_fun( :mmgg);";
  AnsiString sqlstr="select seb_diftarif( :mmgg,0);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }


  AnsiString  sqlstr1=" select t.id_grouptarif as link,t.id_classtarif,t.tgrname, t.tclname, \
 coalesce(demand_z1,0)::::numeric as demand_z1, \
 coalesce(demand_z2,0)::::numeric as demand_z2, \
 coalesce(demand_z3,0)::::numeric as demand_z3, \
 coalesce(sum_z1,0)::::numeric as sum_z1, \
 coalesce(sum_z2,0)::::numeric as sum_z2, \
 coalesce(sum_z3,0)::::numeric as sum_z3,  \
 from (select tgr.id as id_grouptarif, tcl.id as id_classtarif ,tgr.name as tgrname, tcl.name as tclname \
 from eqi_grouptarif_tbl as tgr ,eqi_classtarif_tbl as tcl \
 where (tgr.ident not like 'tgr7%') and (tgr.ident not like 'tgr8%') and (tgr.ident not like 'tgr9%')\
 order by tgr.ident,tcl.ident) as t  left join \
(select tar.id_grouptarif,tar.id_classtarif, \
 coalesce(sum(kvt1)::::numeric,0)::::numeric as demand_z1, \
 coalesce(sum(kvt2)::::numeric,0)::::numeric as demand_z2, \
 coalesce(sum(kvt3)::::numeric,0)::::numeric as demand_z3, \
 coalesce(sum(sum1)::::numeric,0)::::numeric as sum_z1, \
 coalesce(sum(sum2)::::numeric,0)::::numeric as sum_z2, \
 coalesce(sum(sum3)::::numeric,0)::::numeric as sum_z3 \
 from aci_tarif_tbl as tar \
 left join seb_diftarif_tmp as z  on (tar.id=z.id_tarif and z.kind =3 and z.mmgg = :pmmgg ) \
 group by tar.id_grouptarif,tar.id_classtarif ) as smonth \
 on (((t.id_grouptarif=smonth.id_grouptarif)or(t.id_grouptarif=0)) and (t.id_classtarif=smonth.id_classtarif));";


/*
  AnsiString  sqlstr1=" select t.id_grouptarif as link,t.id_classtarif,t.tgrname, t.tclname, \
 coalesce(demand_z1,0)::::numeric as demand_z1,coalesce(demand_z2,0)::::numeric as demand_z2, \
 coalesce(demand_z3,0)::::numeric as demand_z3, \
 coalesce(sum_z1,0)::::numeric as sum_z1,coalesce(sum_z2,0)::::numeric as sum_z2, \
 coalesce(sum_z3,0)::::numeric as sum_z3 \
 from (select tgr.id as id_grouptarif, tcl.id as id_classtarif ,tgr.name as tgrname, tcl.name as tclname \
 from eqi_grouptarif_tbl as tgr ,eqi_classtarif_tbl as tcl \
 where (tgr.ident not like 'tgr7%') and (tgr.ident not like 'tgr8%') and (tgr.ident not like 'tgr9%')\
 order by tgr.ident,tcl.ident) as t  left join \
(select tar.id_grouptarif,tar.id_classtarif, \
 coalesce(sum(demand_z1)::::numeric,0)::::numeric as demand_z1, \
 coalesce(sum(demand_z2)::::numeric,0)::::numeric as demand_z2, \
 coalesce(sum(demand_z3)::::numeric,0)::::numeric as demand_z3, \
 coalesce(sum(sum_z1)::::numeric,0)::::numeric as sum_z1, \
 coalesce(sum(sum_z2)::::numeric,0)::::numeric as sum_z2, \
 coalesce(sum(sum_z3)::::numeric,0)::::numeric as sum_z3 \
 from aci_tarif_tbl as tar left join rep_3zone_tbl as z  on (tar.id=z.id_tariff) \
 where z.mmgg = :pmmgg group by tar.id_grouptarif,tar.id_classtarif ) as smonth \
 on (((t.id_grouptarif=smonth.id_grouptarif)or(t.id_grouptarif=0)) and (t.id_classtarif=smonth.id_classtarif));";

 */
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  sqlstr1="select tgr.id as link, tgr.name as tgrname from eqi_grouptarif_tbl as tgr \
  where (tgr.ident not like 'tgr7%') and (tgr.ident not like 'tgr8%') and (tgr.ident not like 'tgr9%') order by tgr.ident";
  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

  sqlstr1=" select tcl.id as id_classtarif, tcl.name as tclname, \
 coalesce(demand_z1,0)::::numeric as demand_z1,coalesce(demand_z2,0)::::numeric as demand_z2, \
 coalesce(demand_z3,0)::::numeric as demand_z3, \
 coalesce(sum_z1,0)::::numeric as sum_z1,coalesce(sum_z2,0)::::numeric as sum_z2, \
 coalesce(sum_z3,0)::::numeric as sum_z3 \
 from  eqi_classtarif_tbl as tcl left join \
 (select tar.id_classtarif, \
 coalesce(sum(kvt1)::::numeric,0)::::numeric as demand_z1, \
 coalesce(sum(kvt2)::::numeric,0)::::numeric as demand_z2, \
 coalesce(sum(kvt3)::::numeric,0)::::numeric as demand_z3, \
 coalesce(sum(sum1)::::numeric,0)::::numeric as sum_z1, \
 coalesce(sum(sum2)::::numeric,0)::::numeric as sum_z2, \
 coalesce(sum(sum3)::::numeric,0)::::numeric as sum_z3 \
 from aci_tarif_tbl as tar \
 join seb_diftarif_tmp as z  on (tar.id=z.id_tarif and z.kind =3 ) \
 join eqi_grouptarif_tbl as tgr on (tgr.id=tar.id_grouptarif) \
 where z.mmgg = :pmmgg and (tgr.ident not like 'tgr7%') and (tgr.ident not like 'tgr8%')and (tgr.ident not like 'tgr9%') \
 group by tar.id_classtarif  ) as s on  (tcl.id=s.id_classtarif) order by tcl.ident;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr1);
  ZQXLReps2->ParamByName("pmmgg")->AsDateTime=mmgg;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLReps->Open();
    ZQXLRepsSum->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL ");
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "ClassRange";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "ClassRangeS";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lallmonth";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lallmonth"]->Value = "За  "+FormatDateTime("m",dtBegin->Date)+" міс.";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}

//---------------------------------------------------------------------------
void TfReports::PrintTaxBook (TDateTime dt_b, TDateTime dt_e)
{
/*
  AnsiString sqlstr=" select res.name as resname,raddr.full_adr as resaddr, \
  respar.tax_num as taxnum_res,respar.licens_num as SvidNum_res \
  from clm_client_tbl as res left join clm_statecl_tbl as respar on (respar.id_client = res.id) \
  left join adv_address_tbl as raddr on (raddr.id = res.id_addres) \
  where (res.id in (select value_ident from syi_sysvars_tbl where ident='id_res') ); ";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="ResName_Addr";
  Param=xlReport->Params->Add();
  Param->Name="NumRes";
  Param=xlReport->Params->Add();
  Param->Name="SvidNumRes";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  if (ZQReps->RecordCount>0)
   {
    ZQReps->First();

    xlReport->ParamByName["ResName_Addr"]->Value =  ZQReps->FieldByName("resname")->AsString +"  "+
        ZQReps->FieldByName("resaddr")->AsString;
    xlReport->ParamByName["NumRes"]->Value = ZQReps->FieldByName("taxnum_res")->AsString;
    xlReport->ParamByName["SvidNumRes"]->Value = ZQReps->FieldByName("SvidNum_res")->AsString;
   }
  ZQReps->Close();


  AnsiString  sqlstr1=" select * from ( \
  select cl.short_name, t.reg_num,t.reg_date, t.value, t.value_tax,scl.flag_taxpay,scl.tax_num, \
  CASE WHEN scl.flag_taxpay=1 THEN t.value ELSE 0 END as val_pay, \
  CASE WHEN scl.flag_taxpay=0 THEN t.value ELSE 0 END as val_nopay, \
  CASE WHEN scl.flag_taxpay=1 THEN t.value_tax ELSE 0 END as tax_pay, \
  CASE WHEN scl.flag_taxpay=0 THEN t.value_tax ELSE 0 END as tax_nopay, \
  0 as cor_val, 0 as cor_tax \
  from acm_tax_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_tbl as scl  on (cl.id = scl.id_client) \
  where t.reg_date >= :dtb and t.reg_date <= :dte \
  union \
  select cl.short_name, t.reg_num,t.reg_date, t.value, t.value_tax,scl.flag_taxpay,scl.tax_num, \
  0 as val_pay,0 as val_nopay,0 as tax_pay,0 as tax_nopay, \
  t.value as cor_val, t.value_tax as cor_tax \
  from acm_taxcorrection_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_tbl as scl  on (cl.id = scl.id_client) \
  where t.reg_date >= :dtb and t.reg_date <= :dte \
  ) as s order by reg_date  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dt_b;
  ZQXLReps->ParamByName("dte")->AsDateTime=dt_e;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Report();

 ZQXLReps->Close();
 */
}
////////////---------------------------------------------

void TfReports::PrintBillist(TDateTime dtb,TDateTime dte,int kind_energy)
{

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  Word year3;
  Word month3;
  Word day3;


  DecodeDate(dtb,year1,month1,day1);
  DecodeDate(dte,year2,month2,day2);
  DecodeDate(dte+1,year3,month3,day3);

  AnsiString where_period = "";
  if ((day1 ==1) && (day3==1) )
  {
    where_period = " and (b.mmgg >= :dtb::::date and b.mmgg <= :dte::::date) ";
  }
  else
  {
    where_period = "and (coalesce(b.dat_e,b.reg_date) >= :dtb::::date and coalesce(b.dat_e,b.reg_date) <= :dte::::date ) ";
  }



  AnsiString  sqlstr1="  select b.dat_e as bill_date, b.reg_num, b.reg_date, b.value, b.value_tax, b.dt, \
  dci.name as dciname, c.short_name , c.code ,b.demand_val as demand,b.mmgg , cp.represent_name, bp.represent_name as usr_name, \
  cp2.represent_name as executor,  c.code_okpo, \
  CASE WHEN coalesce(b.flag_transmis,0) <> 0 THEN 'Так' ELSE '' END as transmis, b.date_transmis  \
  from acm_bill_tbl as b  left join dci_document_tbl as dci on (dci.id=b.idk_doc) \
  left join clm_client_tbl as c on (c.id= b.id_client) \
  left join clm_statecl_h as sc on (c.id = sc.id_client) \
  left join clm_position_tbl as cp on (sc.id_position=cp.id) \
  left join clm_position_tbl as bp on (b.id_person=bp.id) \
  left join clm_position_tbl as cp2 on (sc.id_kur=cp2.id) \
  where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :dte::::date ) ) \
  and ( :insp is null or sc.id_position = :insp) \
  and ( :exec is null or sc.id_kur = :exec) \
  and b.id_pref = :pref and c.book = -1" + where_period +" order by b.dat_e, b.reg_date ;";

//  and date_trunc('month'::::varchar, b.mmgg_bill::::date) = date_trunc('month'::::varchar, :dtb::::date)
// coalesce(b.dat_e,b.reg_date) >= :dtb and coalesce(b.dat_e,b.reg_date) <= :dte \

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  if (ExecutorId!=0)
     ZQXLReps->ParamByName("exec")->AsInteger=ExecutorId;

  if (kind_energy == 0)  ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy == 1)  ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";

  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача електроенергії.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформаційні послуги.";


  if (kind_energy == 1)  xlReport->ParamByName["demcaption"]->Value = "кВАрг";
  else xlReport->ParamByName["demcaption"]->Value = "кВтг";

  Param=xlReport->Params->Add();
  Param->Name="linsp";

  AnsiString linsp = "";

  if (InspectorId!=0)
    linsp = "Iнспектор "+edInspector->Text;

  if (ExecutorId!=0)
    linsp = linsp+" технік по розрахункам "+edExecutor->Text;

  xlReport->ParamByName["linsp"]->Value = linsp;

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintPaylist(TDateTime dtb,TDateTime dte,int kind_energy)
{

  AnsiString  sqlstr1=" select c.code, c.short_name,p.reg_num, p.reg_date, \
  p.mmgg_pay, p.value_pay, p.value, p.value_tax, cp.represent_name, pp.represent_name as usr_name, p.comment \
  from acm_pay_tbl as p \
  left join dci_document_tbl as dci on (dci.id=p.idk_doc) \
  left join clm_client_tbl as c on (c.id= p.id_client) \
  left join clm_statecl_h as sc on (c.id = sc.id_client) \
  left join clm_position_tbl as cp on (sc.id_position=cp.id) \
  left join clm_position_tbl as pp on (p.id_person=pp.id) \
  where p.reg_date >= :dtb and p.reg_date <= :dte \
  and ( :insp is null or sc.id_position = :insp) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :dte::::date ) ) \
  and p.id_pref = :pref and c.book = -1 and sign_pay = 1 order by p.reg_date ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  if (kind_energy == 0)  ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy == 1)  ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача електроенергії.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформаційні послуги.";


  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintDebetList(boolean Build, TDateTime dt,TDateTime mmgg,int kind_energy,float val, int d_k)
{
  AnsiString sqlstr;
  int obr_exists=0;
  AnsiString message;

   // сальдо за прошлый месяц
   // если будет постоянное развернутое сальдо - возьмем оттуда

   if (Build)
   {
     sqlstr="select count(*) as cnt from seb_obr_all_tbl where period = date_trunc('month', :mmgg::::date)- '1 month'::::interval;";
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
     obr_exists = ZQReps->FieldByName("cnt")->AsInteger;
     ZQReps->Close();

     if ((mmgg > cur_mmgg)||(obr_exists==0))
     {
      if (mmgg > cur_mmgg) message ="Предыдущий месяц не закрыт! Переформировать оборотку ?";
      else message ="Нет данных за предыдущий месяц! Переформировать оборотку ?";

      int r = MessageDlg(message, mtConfirmation, TMsgDlgButtons() << mbYes << mbNo<<mbCancel, 0);

      if ( r==mrCancel ) return;
      if ( r==mrYes )
      {
        sqlstr=" select seb_all( 3, (date_trunc('month', :mmgg::::date)- '1 month'::::interval)::::date );";

        ZQReps->Close();
        ZQReps->Sql->Clear();
        ZQReps->Sql->Add(sqlstr);
        ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

        try
        {
         ZQReps->ExecSql();
        }
        catch(...)
        {
         ShowMessage("Ошибка SQL :"+sqlstr);
         return;
        }

      }
     }
   }

  // по категориям
  AnsiString  sqlstr2;

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);


  if(year1 == 2010 )
  {
  sqlstr2=" select detal.id_section as link, cla.kod, cla.name,cla.sort, sum(db) as db, sum(kb) as kb, sum(kbold) as kbold,sum(db99) as db99,sum(db00) as db00, \
     sum(db01) as db01,sum(db02) as db02,sum(db03)as db03,sum(db04) as db04,sum(db05) as db05, sum(db06) as db06,sum(db07) as db07,sum(db08) as db08, sum(db09) as db09, sum(db10) as db10,\
     sum(sumbill) as sumbill ,sum(pay_all) as pay_all, \
     sum(dk) as dk, sum(kk) as kk, sum(kkold) as kkold, sum(kk_now) as kk_now,sum(dk99) as dk99,sum(dk00) as dk00, \
     sum(dk01) as dk01,sum(dk02) as dk02,sum(dk03)as dk03,sum(dk04) as dk04,sum(dk05) as dk05,sum(dk06) as dk06 ,sum(dk07) as dk07,sum(dk08) as dk08, sum(dk09) as dk09, sum(dk10) as dk10 \
     from \
    (select ss.id_client, ss.db, ss.kb, ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09, ss.db10, \
     ss.sumbill,ss.bill_date,ss.pay_all,ss.pay_date, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) ELSE 0 END as dk, \
     CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as id_section \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, \
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     (coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) - coalesce(s.kr_old_pos,0) ) as dk09, \
     (coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) - coalesce(s.kr_zkmv_now,0) ) as dk10, \
      numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay10,0) - coalesce(bill.sumbill10,0) - coalesce(s.deb10_k,0),0 ) as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay09,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay09,0) \
     ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay09,0) - coalesce(bill.sumbill09,0) - coalesce(s.deb09_k,0),0 ) END as kkold \
     from \
     (select obr.id_client, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr left join clm_client_tbl as c on (c.id= obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.id_client)as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
      sum(b.value+b.value_tax) as sumbill,  max(b.reg_date) as reg_date \
      from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10 \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and  p.sign_pay = 1 and c.idk_work not in (0,99) group by p.id_client order by p.id_client ) as pay using (id_client) )as ss \
     join clm_statecl_h as stcl on (ss.id_client = stcl.id_client) \
     where ( :insp is null or stcl.id_position = :insp) and \
     stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";


  if (d_k==1)
    sqlstr2=sqlstr2+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) >= :v ) as detal ";
  else
    sqlstr2=sqlstr2+" and ss.kk_now >= :v ) as detal ";

    sqlstr2=sqlstr2+"  join cla_param_tbl as cla on (detal.id_section = cla.id) \
     group by detal.id_section, cla.kod, cla.name,cla.sort   order by cla.sort;";
  }
  //---
  if(year1 == 2011 )
  {
  sqlstr2=" select detal.id_section as link, cla.kod, cla.name,cla.sort, sum(db) as db, sum(kb) as kb, sum(kbold) as kbold,sum(db99) as db99,sum(db00) as db00, \
     sum(db01) as db01,sum(db02) as db02,sum(db03)as db03,sum(db04) as db04,sum(db05) as db05, sum(db06) as db06,sum(db07) as db07,sum(db08) as db08, sum(db09) as db09, sum(db10) as db10, sum(db11) as db11, \
     sum(sumbill) as sumbill ,sum(pay_all) as pay_all, \
     sum(dk) as dk, sum(kk) as kk, sum(kkold) as kkold, sum(kk_now) as kk_now,sum(dk99) as dk99,sum(dk00) as dk00, \
     sum(dk01) as dk01,sum(dk02) as dk02,sum(dk03)as dk03,sum(dk04) as dk04,sum(dk05) as dk05,sum(dk06) as dk06 ,sum(dk07) as dk07,sum(dk08) as dk08, sum(dk09) as dk09, sum(dk10) as dk10, sum(dk11) as dk11 \
     from \
    (select ss.id_client, ss.db, ss.kb, ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09, ss.db10, ss.db11, \
     ss.sumbill,ss.bill_date,ss.pay_all,ss.pay_date, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) ELSE 0 END as dk, \
     CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as id_section \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, \
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     (coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) - coalesce(s.kr_old_pos,0) ) as dk10, \
     (coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) - coalesce(s.kr_zkmv_now,0) ) as dk11, \
      numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(s.deb11_k,0),0 ) as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay10,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay10,0) \
     ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay10,0) - coalesce(bill.sumbill10,0) - coalesce(s.deb10_k,0),0 ) END as kkold \
     from \
     (select obr.id_client, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr left join clm_client_tbl as c on (c.id= obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.id_client)as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
      sum(b.value+b.value_tax) as sumbill,  max(b.reg_date) as reg_date \
      from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11 \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and  p.sign_pay = 1 and c.idk_work not in (0,99) group by p.id_client order by p.id_client ) as pay using (id_client) )as ss \
     join clm_statecl_h as stcl on (ss.id_client = stcl.id_client) \
     where ( :insp is null or stcl.id_position = :insp) and \
     stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";


  if (d_k==1)
    sqlstr2=sqlstr2+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) >= :v ) as detal ";
  else
    sqlstr2=sqlstr2+" and ss.kk_now >= :v ) as detal ";

    sqlstr2=sqlstr2+"  join cla_param_tbl as cla on (detal.id_section = cla.id) \
     group by detal.id_section, cla.kod, cla.name,cla.sort   order by cla.sort;";
  }

  //---
  if(year1 == 2012 )
  {
  sqlstr2=" select detal.id_section as link, cla.kod, cla.name,cla.sort, sum(db) as db, sum(kb) as kb, sum(kbold) as kbold,sum(db99) as db99,sum(db00) as db00, \
     sum(db01) as db01,sum(db02) as db02,sum(db03)as db03,sum(db04) as db04,sum(db05) as db05, sum(db06) as db06,sum(db07) as db07,sum(db08) as db08, sum(db09) as db09, sum(db10) as db10, sum(db11) as db11, sum(db12) as db12, \
     sum(sumbill) as sumbill ,sum(pay_all) as pay_all, \
     sum(dk) as dk, sum(kk) as kk, sum(kkold) as kkold, sum(kk_now) as kk_now,sum(dk99) as dk99,sum(dk00) as dk00, \
     sum(dk01) as dk01,sum(dk02) as dk02,sum(dk03)as dk03,sum(dk04) as dk04,sum(dk05) as dk05,sum(dk06) as dk06 ,sum(dk07) as dk07,sum(dk08) as dk08, sum(dk09) as dk09, sum(dk10) as dk10, sum(dk11) as dk11, sum(dk12) as dk12 \
     from \
    (select ss.id_client, ss.db, ss.kb, ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09, ss.db10, ss.db11, ss.db12, \
     ss.sumbill,ss.bill_date,ss.pay_all,ss.pay_date, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) ELSE 0 END as dk, \
     CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as id_section \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, \
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
     (coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) - coalesce(s.kr_old_pos,0) ) as dk11, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_zkmv_now,0) ) END as dk12,  \
    CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay12,0) - numeric_larger(coalesce(bill.sumbill12,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb12_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb12_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay11,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb11_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(s.deb11_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, - deb_km12v as deb12_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id= obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.id_client)as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
      sum(b.value+b.value_tax) as sumbill,  max(b.reg_date) as reg_date \
      from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and  p.sign_pay = 1 and c.idk_work not in (0,99) group by p.id_client order by p.id_client ) as pay using (id_client) )as ss \
     join clm_statecl_h as stcl on (ss.id_client = stcl.id_client) \
     where ( :insp is null or stcl.id_position = :insp) and \
     stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";


  if (d_k==1)
    sqlstr2=sqlstr2+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) >= :v ) as detal ";
  else
    sqlstr2=sqlstr2+" and (ss.kk_now + ss.kkold) >= :v ) as detal ";

    sqlstr2=sqlstr2+"  join cla_param_tbl as cla on (detal.id_section = cla.id) \
     group by detal.id_section, cla.kod, cla.name,cla.sort   order by cla.sort;";
  }


  //---
  if(year1 == 2013 )
  {
  sqlstr2=" select detal.id_section as link, cla.kod, cla.name,cla.sort, sum(db) as db, sum(kb) as kb, sum(kbold) as kbold,sum(db99) as db99,sum(db00) as db00, \
     sum(db01) as db01,sum(db02) as db02,sum(db03)as db03,sum(db04) as db04,sum(db05) as db05, sum(db06) as db06,sum(db07) as db07,sum(db08) as db08, sum(db09) as db09, sum(db10) as db10, sum(db11) as db11, sum(db12) as db12, sum(db13) as db13,\
     sum(sumbill) as sumbill ,sum(pay_all) as pay_all, \
     sum(dk) as dk, sum(kk) as kk, sum(kkold) as kkold, sum(kk_now) as kk_now,sum(dk99) as dk99,sum(dk00) as dk00, \
     sum(dk01) as dk01,sum(dk02) as dk02,sum(dk03)as dk03,sum(dk04) as dk04,sum(dk05) as dk05,sum(dk06) as dk06 ,sum(dk07) as dk07,sum(dk08) as dk08, sum(dk09) as dk09, sum(dk10) as dk10, sum(dk11) as dk11, sum(dk12) as dk12, sum(dk13) as dk13 \
     from \
    (select ss.id_client, ss.db, ss.kb, ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09, ss.db10, ss.db11, ss.db12, ss.db13, \
     ss.sumbill,ss.bill_date,ss.pay_all,ss.pay_date, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     CASE WHEN ss.dk13 >0  THEN ss.dk13 ELSE 0 END as dk13, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) ELSE 0 END as dk, \
     CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as id_section \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12, coalesce(s.deb13_k,0) as db13,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, \
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
     coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) as dk11, \
     (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_old_pos,0) ) as dk12, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_zkmv_now,0) ) END as dk13,  \
    CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay13,0) - numeric_larger(coalesce(bill.sumbill13,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb13_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb13_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay12,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb12_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb12_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, - deb_km12v as deb12_k, - deb_km13v as deb13_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id= obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.id_client)as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value+b.value_tax ELSE 0 END) as sumbill13, \
      sum(b.value+b.value_tax) as sumbill,  max(b.reg_date) as reg_date \
      from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and  p.sign_pay = 1 and c.idk_work not in (0,99) group by p.id_client order by p.id_client ) as pay using (id_client) )as ss \
     join clm_statecl_h as stcl on (ss.id_client = stcl.id_client) \
     where ( :insp is null or stcl.id_position = :insp) and \
     stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";


  if (d_k==1)
    sqlstr2=sqlstr2+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) >= :v ) as detal ";
  else
    sqlstr2=sqlstr2+" and (ss.kk_now + ss.kkold) >= :v ) as detal ";

    sqlstr2=sqlstr2+"  join cla_param_tbl as cla on (detal.id_section = cla.id) \
     group by detal.id_section, cla.kod, cla.name,cla.sort   order by cla.sort;";
  }

  //---
  if(year1 == 2014 )
  {
  sqlstr2=" select detal.id_section as link, cla.kod, cla.name,cla.sort, sum(db) as db, sum(kb) as kb, sum(kbold) as kbold,sum(db99) as db99,sum(db00) as db00, \
     sum(db01) as db01,sum(db02) as db02,sum(db03)as db03,sum(db04) as db04,sum(db05) as db05, sum(db06) as db06,sum(db07) as db07,sum(db08) as db08, sum(db09) as db09, \
     sum(db10) as db10, sum(db11) as db11, sum(db12) as db12, sum(db13) as db13,sum(db14) as db14,\
     sum(sumbill) as sumbill ,sum(pay_all) as pay_all, \
     sum(dk) as dk, sum(kk) as kk, sum(kkold) as kkold, sum(kk_now) as kk_now,sum(dk99) as dk99,sum(dk00) as dk00, \
     sum(dk01) as dk01,sum(dk02) as dk02,sum(dk03)as dk03,sum(dk04) as dk04,sum(dk05) as dk05,sum(dk06) as dk06 ,sum(dk07) as dk07, \
     sum(dk08) as dk08, sum(dk09) as dk09, sum(dk10) as dk10, sum(dk11) as dk11, sum(dk12) as dk12, sum(dk13) as dk13, sum(dk14) as dk14 \
     from \
    (select ss.id_client, ss.db, ss.kb, ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09, ss.db10, ss.db11, ss.db12, ss.db13, ss.db14, \
     ss.sumbill,ss.bill_date,ss.pay_all,ss.pay_date, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     CASE WHEN ss.dk13 >0  THEN ss.dk13 ELSE 0 END as dk13, \
     CASE WHEN ss.dk14 >0  THEN ss.dk14 ELSE 0 END as dk14, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk14) >0 \
       THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk14) ELSE 0 END as dk, \
     CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as id_section \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12, coalesce(s.deb13_k,0) as db13,\
     coalesce(s.deb14_k,0) as db14,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, \
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
     coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) as dk11, \
     coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) as dk12, \
     (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_old_pos,0) ) as dk13, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb14_k,0) - coalesce(pay.pay14,0) + coalesce(bill.sumbill14,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb14_k,0) - coalesce(pay.pay14,0) + coalesce(bill.sumbill14,0) - coalesce(s.kr_zkmv_now,0) ) END as dk14,  \
    CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay14,0) - numeric_larger(coalesce(bill.sumbill14,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb14_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay14,0) - coalesce(bill.sumbill14,0) - coalesce(s.deb14_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay13,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(bill.sumbill14,0) - coalesce(s.deb13_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb13_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, - deb_km12v as deb12_k, - deb_km13v as deb13_k, - deb_km14v as deb14_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id= obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.id_client)as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value+b.value_tax ELSE 0 END) as sumbill13, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value+b.value_tax ELSE 0 END) as sumbill14, \
      sum(b.value+b.value_tax) as sumbill,  max(b.reg_date) as reg_date \
      from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_pay ELSE 0 END) as pay14  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and  p.sign_pay = 1 and c.idk_work not in (0,99) group by p.id_client order by p.id_client ) as pay using (id_client) )as ss \
     join clm_statecl_h as stcl on (ss.id_client = stcl.id_client) \
     where ( :insp is null or stcl.id_position = :insp) and \
     stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";


  if (d_k==1)
    sqlstr2=sqlstr2+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk14) >= :v ) as detal ";
  else
    sqlstr2=sqlstr2+" and (ss.kk_now + ss.kkold) >= :v ) as detal ";

    sqlstr2=sqlstr2+"  join cla_param_tbl as cla on (detal.id_section = cla.id) \
     group by detal.id_section, cla.kod, cla.name,cla.sort   order by cla.sort;";
  }

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;
  ZQXLRepsSum->ParamByName("v")->AsFloat=StrToFloat(edValue->Text);


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;


  // по потребителям
  AnsiString  sqlstr1;

  if(year1 == 2010)
  {
   sqlstr1=" select distinct ss.id_client, ss.db, ss.kb,ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09,ss.db10,\
     ss.sumbill,ss.bill_date,ss.transmis_date,ss.pay_all,ss.pay_date, stcl.phone, \
     calend_dt_inc(coalesce(ss.transmis_date,ss.bill_date)::::date,stcl.day_pay_bill) as last_date, stcl.phone||coalesce(pos_phones,'') as phones, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) ELSE 0 END as dk, \
     cl.code, cl.short_name, CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as link, ssw.status,ssw.comment,cp.represent_name \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
    (coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) - coalesce(s.kr_old_pos,0) ) as dk09, \
    (coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) - coalesce(s.kr_zkmv_now,0) ) as dk10, \
     numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay10,0) - coalesce(bill.sumbill10,0) - coalesce(s.deb10_k,0),0 ) as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay09,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay09,0) \
     ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay09,0) - coalesce(bill.sumbill09,0) - coalesce(s.deb09_k,0),0 ) END as kkold \
     from \
     (select obr.id_client, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref  )as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06,\
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10 \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and p.sign_pay = 1 group by p.id_client ) as pay using (id_client) )as ss \
     join clm_client_tbl as cl on (cl.id = ss.id_client) \
     join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position=cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action, csw.comment,  \
       case when csw.action =1 then 'Відключений '||to_char(csw.dt_action, 'DD.MM.YYYY') \
       when csw.action =2 then 'Попереджений '||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       when csw.action =5 then 'Попереджений (аванс)'||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       end as status \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where action <> 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4,5) and cswc.id_client is null \
      ) as ssw on (cl.id = ssw.id_client) \
     where cl.idk_work not in (0,99)  and ( :insp is null or stcl.id_position = :insp) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";

  if (d_k==1)
    sqlstr1=sqlstr1+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10) >= :v order by cl.code ;";
  else
    sqlstr1=sqlstr1+" and ss.kk_now >= :v order by cl.code ;";

  }
//-----------------
  if(year1 == 2011)
  {
   sqlstr1=" select distinct ss.id_client, ss.db, ss.kb,ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09,ss.db10,ss.db11, \
     ss.sumbill,ss.bill_date,ss.transmis_date,ss.pay_all,ss.pay_date, stcl.phone, \
     calend_dt_inc(coalesce(ss.transmis_date,ss.bill_date)::::date,stcl.day_pay_bill) as last_date, stcl.phone||coalesce(pos_phones,'') as phones, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) ELSE 0 END as dk, \
     cl.code, cl.short_name, CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as link, ssw.status,ssw.comment,cp.represent_name \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
    (coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) - coalesce(s.kr_old_pos,0) ) as dk10, \
    (coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) - coalesce(s.kr_zkmv_now,0) ) as dk11, \
     numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(s.deb11_k,0),0 ) as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay10,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay10,0) \
     ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay10,0) - coalesce(bill.sumbill10,0) - coalesce(s.deb10_k,0),0 ) END as kkold \
     from \
     (select obr.id_client, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref  )as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06,\
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11 \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and p.sign_pay = 1 group by p.id_client ) as pay using (id_client) )as ss \
     join clm_client_tbl as cl on (cl.id = ss.id_client) \
     join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position=cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action, csw.comment,  \
       case when csw.action =1 then 'Відключений '||to_char(csw.dt_action, 'DD.MM.YYYY') \
       when csw.action =2 then 'Попереджений '||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       when csw.action =5 then 'Попереджений (аванс)'||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       end as status \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where action <> 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4,5) and cswc.id_client is null \
      ) as ssw on (cl.id = ssw.id_client) \
     where cl.idk_work not in (0,99)  and ( :insp is null or stcl.id_position = :insp) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";

  if (d_k==1)
    sqlstr1=sqlstr1+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11) >= :v order by cl.code ;";
  else
    sqlstr1=sqlstr1+" and ss.kk_now >= :v order by cl.code ;";

  }

//-----------------
  if(year1 == 2012)
  {
   sqlstr1=" select distinct ss.id_client, ss.db, ss.kb,ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09,ss.db10,ss.db11,ss.db12, \
     ss.sumbill,ss.bill_date,ss.transmis_date,ss.pay_all,ss.pay_date, stcl.phone, \
     calend_dt_inc(coalesce(ss.transmis_date,ss.bill_date)::::date,stcl.day_pay_bill) as last_date, stcl.phone||coalesce(pos_phones,'') as phones, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) ELSE 0 END as dk, \
     cl.code, cl.short_name, CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as link, ssw.status,coalesce(ssw.comment,stcl.for_undef) as comment,cp.represent_name \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
    (coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) - coalesce(s.kr_old_pos,0) ) as dk11, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_zkmv_now,0) ) END as dk12,  \
    CASE WHEN s.order_pay =0 THEN  numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay12,0) - numeric_larger(coalesce(bill.sumbill12,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb12_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb12_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay11,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb11_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay11,0) - coalesce(bill.sumbill11,0) - coalesce(s.deb11_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, - deb_km12v as deb12_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref  )as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
       sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and p.sign_pay = 1 group by p.id_client ) as pay using (id_client) )as ss \
     join clm_client_tbl as cl on (cl.id = ss.id_client) \
     join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position=cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action, csw.comment,  \
       case when csw.action =1 then 'Відключений '||to_char(csw.dt_action, 'DD.MM.YYYY') \
       when csw.action =2 then 'Попереджений '||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       when csw.action =5 then 'Попереджений (аванс)'||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       end as status \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where action <> 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4,5) and cswc.id_client is null \
      ) as ssw on (cl.id = ssw.id_client) \
     where cl.idk_work not in (0,99)  and ( :insp is null or stcl.id_position = :insp) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";

  if (d_k==1)
    sqlstr1=sqlstr1+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12) >= :v order by cl.code ;";
  else
    sqlstr1=sqlstr1+" and (ss.kk_now + ss.kkold) >= :v order by cl.code ;";

  }

//-----------------
  if(year1 == 2013)
  {
   sqlstr1=" select distinct ss.id_client, ss.db, ss.kb,ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09,ss.db10,ss.db11,ss.db12, ss.db13, \
     ss.sumbill,ss.bill_date,ss.transmis_date,ss.pay_all,ss.pay_date, stcl.phone, \
     (CASE WHEN stcl.pre_pay_day1 is not null and stcl.pre_pay_day1 <> 0 THEN text(stcl.pre_pay_day1) ELSE '' END || \
      CASE WHEN stcl.pre_pay_day2 is not null and stcl.pre_pay_day2 <> 0 THEN ','||text(stcl.pre_pay_day2) ELSE '' END || \
      CASE WHEN stcl.pre_pay_day3 is not null and stcl.pre_pay_day3 <> 0 THEN ','||text(stcl.pre_pay_day3) ELSE '' END)::::varchar as pre_pay_days, \
     (CASE WHEN stcl.pre_pay_perc1 is not null and stcl.pre_pay_perc1 <> 0 THEN text(stcl.pre_pay_perc1)||'%' ELSE '' END || \
      CASE WHEN stcl.pre_pay_perc2 is not null and stcl.pre_pay_perc2 <> 0 THEN ','||text(stcl.pre_pay_perc2)||'%' ELSE '' END || \
      CASE WHEN stcl.pre_pay_perc3 is not null and stcl.pre_pay_perc3 <> 0 THEN ','||text(stcl.pre_pay_perc3)||'%' ELSE '' END)::::varchar as pre_pay_perc, \
     calend_dt_inc(coalesce(ss.transmis_date,ss.bill_date)::::date,stcl.day_pay_bill) as last_date, stcl.phone||coalesce(pos_phones,'') as phones, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     CASE WHEN ss.dk13 >0  THEN ss.dk13 ELSE 0 END as dk13, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) >0 THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) ELSE 0 END as dk, \
     cl.code, cl.short_name, CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as link, ssw.status,coalesce(ssw.comment,stcl.for_undef) as comment,ssw.dt_transmiss, cp.represent_name \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12, coalesce(s.deb13_k,0) as db13,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
     coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) as dk11, \
    (coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) - coalesce(s.kr_old_pos,0) ) as dk12, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_zkmv_now,0) ) END as dk13,  \
    CASE WHEN s.order_pay =0 THEN  numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay13,0) - numeric_larger(coalesce(bill.sumbill13,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb13_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb13_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay12,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb12_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay12,0) - coalesce(bill.sumbill12,0) - coalesce(s.deb12_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, - deb_km11v as deb11_k, - deb_km12v as deb12_k, - deb_km13v as deb13_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref  )as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value+b.value_tax ELSE 0 END) as sumbill13, \
       sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and p.sign_pay = 1 group by p.id_client ) as pay using (id_client) )as ss \
     join clm_client_tbl as cl on (cl.id = ss.id_client) \
     join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position=cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action, csw.comment, csw.dt_transmiss, \
       case when csw.action =1 then 'Відключений '||to_char(csw.dt_action, 'DD.MM.YYYY') \
       when csw.action =2 then 'Попереджений '||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       when csw.action =5 then 'Попереджений (аванс)'||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       end as status \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where action <> 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4,5) and cswc.id_client is null \
      ) as ssw on (cl.id = ssw.id_client) \
     where cl.idk_work not in (0,99)  and ( :insp is null or stcl.id_position = :insp) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";

  if (d_k==1)
    sqlstr1=sqlstr1+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13) >= :v order by cl.code ;";
  else
    sqlstr1=sqlstr1+" and (ss.kk_now + ss.kkold) >= :v order by cl.code ;";

  }

//-----------------
  if(year1 == 2014)
  {
   sqlstr1=" select distinct ss.id_client, ss.db, ss.kb,ss.kb_now, ss.kbold,ss.db99,ss.db00,ss.db01,ss.db02,ss.db03,ss.db04,ss.db05,ss.db06,ss.db07, ss.db08, ss.db09,ss.db10,ss.db11,ss.db12, ss.db13, ss.db14, \
     ss.sumbill,ss.bill_date,ss.transmis_date,ss.pay_all,ss.pay_date, stcl.phone, bp.represent_name as usr_name, \
     (CASE WHEN stcl.pre_pay_day1 is not null and stcl.pre_pay_day1 <> 0 THEN text(stcl.pre_pay_day1) ELSE '' END || \
      CASE WHEN stcl.pre_pay_day2 is not null and stcl.pre_pay_day2 <> 0 THEN ','||text(stcl.pre_pay_day2) ELSE '' END || \
      CASE WHEN stcl.pre_pay_day3 is not null and stcl.pre_pay_day3 <> 0 THEN ','||text(stcl.pre_pay_day3) ELSE '' END)::::varchar as pre_pay_days, \
     (CASE WHEN stcl.pre_pay_perc1 is not null and stcl.pre_pay_perc1 <> 0 THEN text(stcl.pre_pay_perc1)||'%' ELSE '' END || \
      CASE WHEN stcl.pre_pay_perc2 is not null and stcl.pre_pay_perc2 <> 0 THEN ','||text(stcl.pre_pay_perc2)||'%' ELSE '' END || \
      CASE WHEN stcl.pre_pay_perc3 is not null and stcl.pre_pay_perc3 <> 0 THEN ','||text(stcl.pre_pay_perc3)||'%' ELSE '' END)::::varchar as pre_pay_perc, \
     calend_dt_inc(coalesce(ss.transmis_date,ss.bill_date)::::date,stcl.day_pay_bill) as last_date, stcl.phone||coalesce(pos_phones,'') as phones, \
     ss.dk99,ss.dk00,ss.dk01,ss.dk02,ss.dk03,ss.dk04,ss.dk05, \
     CASE WHEN ss.dk06 >0  THEN ss.dk06 ELSE 0 END as dk06, \
     CASE WHEN ss.dk07 >0  THEN ss.dk07 ELSE 0 END as dk07, \
     CASE WHEN ss.dk08 >0  THEN ss.dk08 ELSE 0 END as dk08, \
     CASE WHEN ss.dk09 >0  THEN ss.dk09 ELSE 0 END as dk09, \
     CASE WHEN ss.dk10 >0  THEN ss.dk10 ELSE 0 END as dk10, \
     CASE WHEN ss.dk11 >0  THEN ss.dk11 ELSE 0 END as dk11, \
     CASE WHEN ss.dk12 >0  THEN ss.dk12 ELSE 0 END as dk12, \
     CASE WHEN ss.dk13 >0  THEN ss.dk13 ELSE 0 END as dk13, \
     CASE WHEN ss.dk14 >0  THEN ss.dk14 ELSE 0 END as dk14, \
     ss.kk_now, ss.kkold, ss.kk_now + ss.kkold as kk , \
     CASE WHEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk13+ss.dk14) >0 \
        THEN (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk14) ELSE 0 END as dk, \
     cl.code, cl.short_name, CASE WHEN coalesce(stcl.id_section,0) =0 THEN 216 ELSE stcl.id_section END as link, ssw.status,coalesce(ssw.comment,stcl.for_undef) as comment,ssw.dt_transmiss, cp.represent_name \
     from \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, kr_zkmv_now as kb_now, kr_zkmv_old as kbold, \
     coalesce(s.deb99_k,0) as db99,coalesce(s.deb00_k,0) as db00, coalesce(s.deb01_k,0) as db01, \
     coalesce(s.deb02_k,0) as db02, coalesce(s.deb03_k,0) as db03, coalesce(s.deb04_k,0) as db04,\
     coalesce(s.deb05_k,0) as db05, coalesce(s.deb06_k,0) as db06, coalesce(s.deb07_k,0) as db07,\
     coalesce(s.deb08_k,0) as db08, coalesce(s.deb09_k,0) as db09, coalesce(s.deb10_k,0) as db10,\
     coalesce(s.deb11_k,0) as db11, coalesce(s.deb12_k,0) as db12, coalesce(s.deb13_k,0) as db13,\
     coalesce(s.deb14_k,0) as db14,\
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,bill.id_person as id_person_bill,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     coalesce(s.deb99_k,0) - coalesce(pay.pay99,0) + coalesce(bill.sumbill99,0) as dk99, \
     coalesce(s.deb00_k,0) - coalesce(pay.pay00,0) + coalesce(bill.sumbill00,0) as dk00, \
     coalesce(s.deb01_k,0) - coalesce(pay.pay01,0) + coalesce(bill.sumbill01,0) as dk01, \
     coalesce(s.deb02_k,0) - coalesce(pay.pay02,0) + coalesce(bill.sumbill02,0) as dk02, \
     coalesce(s.deb03_k,0) - coalesce(pay.pay03,0) + coalesce(bill.sumbill03,0) as dk03, \
     coalesce(s.deb04_k,0) - coalesce(pay.pay04,0) + coalesce(bill.sumbill04,0) as dk04, \
     coalesce(s.deb05_k,0) - coalesce(pay.pay05,0) + coalesce(bill.sumbill05,0) as dk05, \
     coalesce(s.deb06_k,0) - coalesce(pay.pay06,0) + coalesce(bill.sumbill06,0) as dk06, \
     coalesce(s.deb07_k,0) - coalesce(pay.pay07,0) + coalesce(bill.sumbill07,0) as dk07, \
     coalesce(s.deb08_k,0) - coalesce(pay.pay08,0) + coalesce(bill.sumbill08,0) as dk08, \
     coalesce(s.deb09_k,0) - coalesce(pay.pay09,0) + coalesce(bill.sumbill09,0) as dk09, \
     coalesce(s.deb10_k,0) - coalesce(pay.pay10,0) + coalesce(bill.sumbill10,0) as dk10, \
     coalesce(s.deb11_k,0) - coalesce(pay.pay11,0) + coalesce(bill.sumbill11,0) as dk11, \
     coalesce(s.deb12_k,0) - coalesce(pay.pay12,0) + coalesce(bill.sumbill12,0) as dk12, \
    (coalesce(s.deb13_k,0) - coalesce(pay.pay13,0) + coalesce(bill.sumbill13,0) - coalesce(s.kr_old_pos,0) ) as dk13, \
    CASE WHEN s.order_pay =0 THEN (coalesce(s.deb14_k,0) - coalesce(pay.pay14,0) + coalesce(bill.sumbill14,0) - coalesce(s.kr_zkmv,0) ) \
         ELSE (coalesce(s.deb14_k,0) - coalesce(pay.pay14,0) + coalesce(bill.sumbill14,0) - coalesce(s.kr_zkmv_now,0) ) END as dk14,  \
    CASE WHEN s.order_pay =0 THEN  numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay14,0) - numeric_larger(coalesce(bill.sumbill14,0)- coalesce(s.kr_old_pos,0) ,0)- coalesce(s.deb14_k,0),0 ) \
    ELSE numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay14,0) - coalesce(bill.sumbill14,0) - coalesce(s.deb14_k,0),0 ) END as kk_now, \
     CASE WHEN (kr_zkmv_old <0 ) and (coalesce(pay.pay13,0) < -coalesce(kr_zkmv_old,0)) THEN coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) \
     ELSE  CASE WHEN s.order_pay =0 THEN numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(bill.sumbill14,0) - coalesce(s.deb13_k,0),0 ) \
        ELSE numeric_larger(coalesce(s.kr_zkmv_old,0) + coalesce(pay.pay13,0) - coalesce(bill.sumbill13,0) - coalesce(s.deb13_k,0),0 ) END  END as kkold \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, \
     - deb_km11v as deb11_k, - deb_km12v as deb12_k, - deb_km13v as deb13_k, - deb_km14v as deb14_k, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = :pref  )as s \
     full outer join \
     ( select b.id_client, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value+b.value_tax ELSE 0 END) as sumbill99, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value+b.value_tax ELSE 0 END) as sumbill00, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value+b.value_tax ELSE 0 END) as sumbill01, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value+b.value_tax ELSE 0 END) as sumbill02, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value+b.value_tax ELSE 0 END) as sumbill03, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value+b.value_tax ELSE 0 END) as sumbill04, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value+b.value_tax ELSE 0 END) as sumbill05, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value+b.value_tax ELSE 0 END) as sumbill06, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value+b.value_tax ELSE 0 END) as sumbill07, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value+b.value_tax ELSE 0 END) as sumbill08, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value+b.value_tax ELSE 0 END) as sumbill09, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value+b.value_tax ELSE 0 END) as sumbill11, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value+b.value_tax ELSE 0 END) as sumbill13, \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value+b.value_tax ELSE 0 END) as sumbill14, \
       sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date, max(b.id_person) as id_person  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = :pref and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13, \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_pay ELSE 0 END) as pay14  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = :pref and c.book = -1 and p.sign_pay = 1 group by p.id_client ) as pay using (id_client) )as ss \
     join clm_client_tbl as cl on (cl.id = ss.id_client) \
     join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position=cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action, csw.comment, csw.dt_transmiss, \
       case when csw.action =1 then 'Відключений '||to_char(csw.dt_action, 'DD.MM.YYYY') \
       when csw.action =2 then 'Попереджений '||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       when csw.action =5 then 'Попереджений (аванс)'||to_char(csw.dt_action, 'DD.MM.YYYY')||coalesce(' на '||to_char(csw.dt_warning, 'DD.MM.YYYY'),'') \
       end as status \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4) and cswc.id_client is null \
      ) as ssw on (cl.id = ssw.id_client) \
     left join clm_position_tbl as bp on (id_person_bill=bp.id) \
     where cl.idk_work not in (0,99)  and ( :insp is null or stcl.id_position = :insp) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     ";

  if (d_k==1)
    sqlstr1=sqlstr1+" and (ss.dk99+ss.dk00+ss.dk01+ss.dk02+ss.dk03+ss.dk04+ss.dk05+ss.dk06+ss.dk07+ss.dk08+ss.dk09+ss.dk10+ss.dk11+ss.dk12+ss.dk13+ss.dk14) >= :v order by cl.code ;";
  else
    sqlstr1=sqlstr1+" and (ss.kk_now + ss.kkold) >= :v order by cl.code ;";

  }

//           where b.mmgg_bill = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  ZQXLReps->ParamByName("v")->AsFloat=StrToFloat(edValue->Text);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

 /* if (kind_energy==0)
   {
//    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr";
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
//    ZQXLReps->MacroByName("obrtable")->AsString="seb_obrr";
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }   */

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lval";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = FormatDateTime("dd.mm.yyyy",dt);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["lval"]->Value = edValue->Text;

  if (d_k==1)
  {
   if (kind_energy==0)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (активна електроенергія)";
  if (kind_energy==1)    xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (реактивна електроенергія)";
  if (kind_energy==2)    xlReport->ParamByName["caption"]->Value =  "Відомість дебіторів (2-х кратка потужність)";
  if (kind_energy==3)    xlReport->ParamByName["caption"]->Value =  "Відомість дебіторів (2-х кратка споживання з ПДВ)";
  if (kind_energy==4)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (2-х кратка споживання без ПДВ )";
  if (kind_energy==5)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (пеня)";
  if (kind_energy==6)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (інфляція)";
  if (kind_energy==7)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (передача)";
  if (kind_energy==8)     xlReport->ParamByName["caption"]->Value = "Відомість дебіторів (інформ.послуги)";

  }
  else
  {
  if (kind_energy==0)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (активна електроенергія)";
  if (kind_energy==1)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (реактивна електроенергія)";
  if (kind_energy==2)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (2-х кратка потужність)";
  if (kind_energy==3)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (2-х кратка споживання з ПДВ)";
  if (kind_energy==4)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (2-х кратка споживання без ПДВ)";
  if (kind_energy==5)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (пеня)";
  if (kind_energy==6)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (інфляція)";
  if (kind_energy==7)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (передача)";
  if (kind_energy==8)     xlReport->ParamByName["caption"]->Value = "Відомість кредиторів (інформ.послуги)";

  }

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";


  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}

//---------------------------------------------------------------------------
void TfReports::PrintOborotShort(TDateTime mmgg,int kind_energy)
{
  AnsiString sqlstr;


//   if (kind_energy==0)  sqlstr=" select seb_obr( date_trunc('month', :mmgg::::date)::::date )";
//   else sqlstr=" select seb_obrr( date_trunc('month', :mmgg::::date)::::date)";

   sqlstr=" select seb_all( 0, date_trunc('month', :mmgg::::date)::::date )";
   
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

   AnsiString  sqlstr1=" select n.id, n.name,n.sort, \
    sum(nar) as snar, sum(nar_v) as snar_v, sum(opl_zv) as sopl_zv, \
    sum(deb) as sdeb, sum(kr_zpmv) as skr_zpmv, sum(deb99) as sdeb99 ,sum(deb00) as sdeb00,\
    sum(deb01) as sdeb01, sum(deb02) as  sdeb02, sum(deb03) as sdeb03, sum(deb04) as sdeb04, \
    sum(deb05) as sdeb05, sum(deb06) as sdeb06, sum(deb07) as sdeb07, sum(deb08) as sdeb08,  sum(deb09) as sdeb09, sum(deb10) as sdeb10,\
    sum(deb_k) as sdeb_k, sum(kr_zkmv) as skr_zkmv, sum(deb99_k) as sdeb99_k , \
    sum(deb00_k) as sdeb00_k, sum(deb01_k) as sdeb01_k, sum(deb02_k) as sdeb02_k, \
    sum(deb03_k) as sdeb03_k, sum(deb04_k) as sdeb04_k, sum(deb05_k) as sdeb05_k,sum(deb06_k) as sdeb06_k, \
    sum(deb07_k) as sdeb07_k,  sum(deb08_k) as sdeb08_k, sum(deb09_k) as sdeb09_k, sum(deb10_k) as sdeb10_k \
    from \
     (select coalesce(obr.roz,999)as roz, sum(nar) as nar, sum(nar_v) as nar_v, sum(opl_zv) as opl_zv, \
     -sum(deb_zpmv) as deb, sum(kr_zpmv) as kr_zpmv, - sum(deb_pm99v) as deb99 ,- sum(deb_pm00v) as deb00,\
     -sum(deb_pm01v) as deb01,- sum(deb_pm02v) as  deb02, \
     -sum(deb_pm03v)  as deb03,-sum(deb_pm04v) as deb04, \
     -sum(deb_pm05v) as deb05, -sum(deb_pm06v) as deb06, - sum(deb_pm07v) as deb07,- sum(deb_pm08v) as deb08,\
     -sum(deb_pm09v) as deb09, -sum(deb_pm10v) as deb10, \
     -sum(deb_kmv) as deb_k, sum(kr_zkmv) as kr_zkmv, - sum(deb_km99v) as deb99_k ,- sum(deb_km00v) as deb00_k, \
     -sum(deb_km01v) as deb01_k,- sum(deb_km02v) as  deb02_k, \
     -sum(deb_km03v) as deb03_k,- sum(deb_km04v) as deb04_k, \
     -sum(deb_km05v) as deb05_k,- sum(deb_km06v) as deb06_k, - sum(deb_km07v) as deb07_k, - sum(deb_km08v) as deb08_k ,\
     -sum(deb_km09v) as deb09_k,- sum(deb_km10v) as deb10_k \
     from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) group by obr.roz )as sss \
     join \
     (select p1.kod,p1.id as id1,p2.id as id2,p3.id as id3,p4.id as id4 \
     from cla_param_tbl as p1 \
     left join cla_param_tbl as p2 on (p2.id = p1.id_parent ) \
     left join cla_param_tbl as p3 on (p3.id = p2.id_parent ) \
     left join cla_param_tbl as p4 on (p4.id = p3.id_parent ) \
     where p1.id_group= 200 and p1.id <>200 ) as gr on (gr.kod = sss.roz) \
     right join    ( select p.id, p.lev, p.sort ,\
      CASE WHEN p.lev = 2 THEN p.name \
           WHEN p.lev = 3 THEN ' - '||p.name \
           WHEN p.lev = 4 THEN ' - - '||p.name \
           WHEN p.lev = 1 THEN 'ВСЬОГО' END AS name \
      from cla_param_tbl as p where p.id_group= 200 or p.id = 200  ) as  n  \
     on (n.id in (gr.id1,gr.id2,gr.id3,gr.id4) ) \
     group by  n.id, n.name , n.sort order by n.sort ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);


  if (kind_energy==0)
  {
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";
  }
  if (kind_energy==1)
  {
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  }

  if (kind_energy==0)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за активну електроенергію";
  if (kind_energy==1)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за реактивну електроенергію";
  if (kind_energy==2)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (2-х кратка потужність)";
  if (kind_energy==3)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (2-х кратка споживання з ПДВ)";
  if (kind_energy==4)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (2-х кратка споживання без ПДВ)";
  if (kind_energy==5)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (пеня)";
  if (kind_energy==6)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (Інфляція)";
  if (kind_energy==7)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (передача)";
  if (kind_energy==8)     xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків (інформ.послуги)";


  xlReport->Report();


 ZQXLReps->Close();


}
//---------------------------------------------------------------------------

void TfReports::PrintF24(TDateTime mmgg,int kind_energy)
{
  AnsiString sqlstr;

  AnsiString  sqlstr1="  select n.id,n.kod, int4(n.kod)/100 as num, n.name, sum(demand)as demand, sum(demandyear)as demandyear \
   from  (select coalesce(ph.id_depart,0) as id_depart , sum(bs.demand_val)as demandyear, sum(bs.sum_val) as sumvyear \
   from  acm_bill_tbl as b \
   join acd_billsum_tbl as bs on  (bs.id_doc = b.id_doc) \
   join ( select distinct id_client \
      from seb_obr_all_tbl  \
      where  mmgg= :mmgg::::date and id_pref = :pref and idk_work not in (0,99) order by id_client \
    ) as c on (c.id_client = b.id_client) \
   join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
   where date_part('year', b.mmgg) = date_part('year', :mmgg::::date) \
   and date_part('month', b.mmgg) <= date_part('month', :mmgg::::date) \
   and b.id_pref = :pref  \
   and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
   group by coalesce(ph.id_depart,0) ) as billsumyear \
   left join \
  (select coalesce(ph.id_depart,0) as id_depart, sum(bs.demand_val)as demand, sum(bs.sum_val) as sumv \
   from  acm_bill_tbl as b \
    join acd_billsum_tbl as bs on  (bs.id_doc = b.id_doc) \
   join ( select distinct id_client \
      from seb_obr_all_tbl \
      where mmgg= :mmgg::::date and id_pref = :pref and idk_work not in (0,99) order by id_client \
    ) as c on (c.id_client = b.id_client) \
   join  eqm_point_h  as ph on (ph.code_eqp = bs.id_point) \
   where b.mmgg = date_trunc('month', :mmgg::::date) \
   and b.id_pref = :pref  \
   and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
   group by coalesce(ph.id_depart,0) ) as billsum on (billsum.id_depart = billsumyear.id_depart) \
  left join \
  (select p1.id as id1,p2.id as id2,p3.id as id3,p4.id as id4,p5.id as id5, p1.name \
  from cla_param_tbl as p1 \
  left join cla_param_tbl as p2 on (p2.id = p1.id_parent ) \
  left join cla_param_tbl as p3 on (p3.id = p2.id_parent ) \
  left join cla_param_tbl as p4 on (p4.id = p3.id_parent ) \
  left join cla_param_tbl as p5 on (p5.id = p4.id_parent ) \
  where p1.id_group= 800 and p1.id <>800 ) as gr on (billsumyear.id_depart = gr.id1) \
   left join    ( select p.id, p.lev, p.kod , \
   CASE WHEN p.lev = 1 THEN 'ВСЬОГО' ELSE '. '||p.name END AS name \
   from cla_param_tbl as p where p.id_group= 800 or p.id = 800  ) as  n \
  on (n.id in (gr.id1,gr.id2,gr.id3,gr.id4,gr.id5) ) \
  group by  n.id, n.name,n.kod order by int4(n.kod);  ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
 /*
  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }
*/
 if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про споживання активної електроенергії по міністерствах.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про споживання реактивної електроенергії по міністерствах.";
  if (kind_energy==2)
    xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про нарахування 2-х кратки потужність по міністерствах.";
  if (kind_energy==3)
     xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про нарахування 2-х кратки споживання з ПДВ по міністерствах.";
  if (kind_energy==4)
     xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про нарахування 2-х кратки споживання без ПДВ по міністерствах.";
  if (kind_energy==5)
     xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про споживання пені по міністерствах.";
  if (kind_energy==6)
    xlReport->ParamByName["caption"]->Value = "Форма Е-24 енерго. Звіт про нарахування інфляції по міністерствах.";

  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonTarif(TDateTime mmgg1,TDateTime mmgg2,int kind_energy)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , bs.id_point, bs.id_tariff as link, \
  bs.kvt, bs.dem, eq2.name_eqp, bs.num_eqp , tar.name as tarname, tcl.name as tarclass, cla.name as abongrp \
  from \
  ( select b.id_client,bs.id_point,bs.id_tariff, kz.num_eqp, sum(bs.demand_val) as kvt, sum(bs.sum_val) as dem \
   from acm_bill_tbl as b \
   join acd_billsum_tbl as bs on ( b.id_doc = bs.id_doc) \
   left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg >= :mmgg1 and mmgg <= :mmgg2 and kind_energy = :energy group by id_point,id_doc order by id_point,id_doc ) as kz  \
   on (kz.id_point = bs.id_point and kz.id_doc = b.id_doc ) \
   where b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 and b.id_pref = :pref \
   and ((bs.demand_val <> 0) or (bs.sum_val <> 0 )) \
   group by b.id_client,bs.id_point,bs.id_tariff, kz.num_eqp \
  ) as bs \
  join clm_client_tbl as cl on (cl.id = bs.id_client) \
  join aci_tarif_tbl as tar on (bs.id_tariff = tar.id) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join clm_statecl_tbl as stcl on (stcl.id_client = cl.id) \
  left join cla_param_tbl as cla on (cla.id = stcl.id_section) \
  left join \
  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) order by eq3.id \
  ) as eq2  on (bs.id_point=eq2.id) \
  where cl.book = -1 and cl.idk_work <> 0 \
   order by cl.code, eq2.name_eqp, bs.num_eqp ; ";

   //   order by cl.code, eq2.name_eqp, bs.num_eqp ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
    ZQXLReps->ParamByName("energy")->AsInteger=1;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
    ZQXLReps->ParamByName("energy")->AsInteger=2;
   }

  // по категориям
  AnsiString  sqlstr2=" select id_tariff as link, dem, kvt, tar.name as tarname, tgr.name as tgrname \
  from (select id_tariff, sum(bs.demand_val) as kvt,sum(bs.sum_val) as dem \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  where b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 and b.id_pref = :pref and cl.book = -1 \
  group by id_tariff )as ts \
  join aci_tarif_tbl as tar on (ts.id_tariff = tar.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif = tgr.id ) \
  order by tgr.ident,tar.id_classtarif, id_tariff;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLRepsSum->ParamByName("mmgg2")->AsDateTime=mmgg2;

  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(mmgg1,year1,month1,day1);
  DecodeDate(mmgg2,year2,month2,day2);

  if ((year1==year2)&&(month1==month2))
  {
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);
  }
  else
  {
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1)+" - "+FormatDateTime("mmmm yyyy",mmgg2);
  }


  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по тарифах.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по тарифах.";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonVolt(TDateTime mmgg,int kind_energy)
{
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , bs.id_point, \
  bs.dem, bs.kvt, eq2.name_eqp, kz.num_eqp ,coalesce(ph.id_voltage,0)as link \
  from clm_client_tbl as cl join acm_bill_tbl as b on (cl.id = b.id_client) \
  join (select id_point, id_doc, sum(demand_val) as kvt,sum(sum_val) as dem, max(dt_end) as dt_end \
  from acd_billsum_tbl group by id_point, id_doc )as bs using ( id_doc) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg = :mmgg and kind_energy = :energy \
    group by id_point,id_doc) as kz  \
  using (id_point,id_doc) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and (bs.dem <>0 or bs.kvt <>0 ) order by ph.id_voltage desc , cl.code ; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
    ZQXLReps->ParamByName("energy")->AsInteger=1;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
    ZQXLReps->ParamByName("energy")->AsInteger=2;
   }

  // по категориям
  AnsiString  sqlstr2=" select coalesce(ts.id_voltage,0) as link,\
  coalesce(voltage_min::::varchar, 'Не відомий') as voltage, dem, kvt  \
  from  (select ph.id_voltage, sum(bs.demand_val) as kvt,sum(bs.sum_val) as dem \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  group by ph.id_voltage )as ts  \
  left join eqk_voltage_tbl as v on (v.id = ts.id_voltage) \
  order by v.voltage_min desc;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
//  ZQXLReps->LinkFields="id_voltage = id_voltage";
//  ZQXLReps->MasterSource=DSRep;
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по рівнях напруги.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по рівнях напруги.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------
void TfReports::PrintTaxList(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1="  select  cl.code,cl.short_name,s.type_tax, s.reg_num,s.reg_date, s.value, s.value_tax, \
  CASE WHEN kind_calc =1 THEN 'рахунок'  WHEN kind_calc =2 THEN 'аванс' \
       WHEN kind_calc =3 THEN 'оплата'   WHEN kind_calc =4 THEN 'коригування' END as kind, \
  CASE WHEN flag_transmis =1 THEN 'Выдана' ELSE '' END as transmis \
  from ( \
   select t.id_client, 0::::int as type_tax,t.reg_num,t.int_num,t.reg_date, t.value, t.value_tax, kind_calc,flag_transmis \
   from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union \
   select t.id_client,1::::int as type_tax, t.reg_num,0,t.reg_date, t.value, t.value_tax, 4 as kind_calc,flag_transmis \
   from acm_taxcorrection_tbl as t  where \
   date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
   and t.id_pref = :pref \
  ) as s  join clm_client_tbl as cl  on (cl.id = s.id_client)\
  order by reg_date, int_num, reg_num ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (активна енергія)";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (реактивна енергія)";
  if (kind_energy==3)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (Перевищення ліміту 2кр)";


  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintTaxListGrp(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1="  select sc.id_section as link, cl.code,cl.short_name, s.reg_num,s.reg_date, s.value, s.value_tax, \
  CASE WHEN kind_calc =1 THEN 'рахунок'  WHEN kind_calc =2 THEN 'аванс' \
       WHEN kind_calc =3 THEN 'оплата'   WHEN kind_calc =4 THEN 'коригування' END as kind \
  from ( \
   select t.id_client, t.reg_num,t.int_num,t.reg_date, t.value, t.value_tax, kind_calc \
   from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union \
   select t.id_client, t.reg_num,0,t.reg_date, t.value, t.value_tax, 4 as kind_calc \
   from acm_taxcorrection_tbl as t  where \
   date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
   and t.id_pref = :pref \
  ) as s  join clm_client_tbl as cl  on (cl.id = s.id_client)\
   join clm_statecl_h as sc on (cl.id=sc.id_client) \
   where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
  order by cl.code ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;

  // по категориям
  AnsiString  sqlstr2=" select ss.*, cla.name from \
  (  select sc.id_section as link, sum(s.value) as value, sum(s.value_tax) as value_tax \
     from ( \
      select t.id_client, t.reg_num,t.int_num,t.reg_date, t.value, t.value_tax, kind_calc \
      from acm_tax_tbl as t  where \
      date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
      and t.id_pref = :pref \
      union \
      select t.id_client, t.reg_num,0,t.reg_date, t.value, t.value_tax, 4 as kind_calc \
      from acm_taxcorrection_tbl as t  where \
      date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
      and t.id_pref = :pref \
     ) as s  join clm_client_tbl as cl  on (cl.id = s.id_client) \
     join clm_statecl_h sc on (cl.id=sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     group by sc.id_section \
   ) as ss \
  join cla_param_tbl as cla on (ss.link = cla.id and cla.id_group = 200) \
  order by cla.sort; ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";


  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (активна енергія)";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (реактивна енергія)";
  if (kind_energy==3)
    xlReport->ParamByName["caption"]->Value = "Реєстр податкових накладних (Перевищення ліміту 2кр)";


  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}

//---------------------------------------------------------------------------
void TfReports::PrintAbonDep(TDateTime mmgg,int kind_energy)
{
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , bs.id_point, \
  eq2.name_eqp, kz.num_eqp ,coalesce(ph.id_depart,0) as link , sum(bs.demand_val) as kvt,sum(bs.sum_val) as dem \
  from acm_bill_tbl as b \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc ) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 \
      on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg = :mmgg and kind_energy = :energy \
    group by id_point,id_doc) as kz  \
  using (id_point,id_doc) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and (bs.demand_val <>0 or bs.sum_val <>0 ) \
  group by cl.id, cl.code, cl.short_name , bs.id_point, eq2.name_eqp, kz.num_eqp , ph.id_depart \
   order by ph.id_depart desc , cl.code ; ";

//  join (select id_point, id_doc, sum(demand_val) as kvt,sum(sum_val) as dem, max(dt_end) as dt_end \
//  from acd_billsum_tbl group by id_point, id_doc )as bs using ( id_doc) \


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
    ZQXLReps->ParamByName("energy")->AsInteger=1;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
    ZQXLReps->ParamByName("energy")->AsInteger=2;    
   }

  // по категориям
  // копия ф24
  AnsiString  sqlstr2="  select coalesce(n.id,0) as link,n.kod, coalesce(n.name,'- Не указано -') as name, sum(demand)as demand, sum(sumv)as sumv \
   from (select ph.id_depart, sum(bs.demand_val)as demand, sum(bs.sum_val) as sumv \
   from  acm_bill_tbl as b \
   join clm_client_tbl as c on (c.id = b.id_client) \
   join acd_billsum_tbl as bs using  (id_doc) \
   join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
   where b.mmgg = date_trunc('month', :mmgg::::date) \
   and b.id_pref = :pref and c.book = -1 \
   and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
   group by ph.id_depart ) as billsum \
  left join \
  (select p1.id as id1,p2.id as id2,p3.id as id3,p4.id as id4,p5.id as id5, p1.name \
  from cla_param_tbl as p1 \
  left join cla_param_tbl as p2 on (p2.id = p1.id_parent ) \
  left join cla_param_tbl as p3 on (p3.id = p2.id_parent ) \
  left join cla_param_tbl as p4 on (p4.id = p3.id_parent ) \
  left join cla_param_tbl as p5 on (p5.id = p4.id_parent ) \
  where p1.id_group= 800 and p1.id <>800 ) as gr on (billsum.id_depart = gr.id1) \
   left join    ( select p.id, p.lev, p.kod , \
   CASE WHEN p.lev = 1 THEN 'ВСЬОГО' ELSE '. '||p.name END AS name \
   from cla_param_tbl as p where p.id_group= 800 or p.id = 800  ) as  n \
  on (n.id in (gr.id1,gr.id2,gr.id3,gr.id4,gr.id5) ) \
  group by  n.id, n.name,n.kod order by int4(n.kod); ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по міністрствах.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по міністерствах.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//---------------------------------------------------------------------------

void TfReports::PrintNDS(TDateTime mmgg,int kind_energy,boolean Build)
{
  AnsiString sqlstr;


  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_nds_fun( :mmgg, :pref, :build );");

  if (kind_energy==0)
    ZQReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==3)
    ZQReps->ParamByName("pref")->AsInteger=520;


  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQReps->ParamByName("build")->AsBoolean=Build;

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  AnsiString  sqlstr1=" select * from  rep_nds_tbl ;";

  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = " Звіт про реалізації активної електроенергії .";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = " Звіт про реалізації реактивної електроенергії.";

  if (kind_energy==3)
    xlReport->ParamByName["caption"]->Value = " Звіт про реалізації електроенергії (2кр споживання до 2014 року).";


  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::PrintNDS2011(TDateTime mmgg,int kind_energy,boolean Build)
{
  AnsiString sqlstr;

  if (Build)
  {

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add("select flock from rep_nds2011_tbl where mmgg = :mmgg and id_pref = :pref;");

   if (kind_energy==0)
     ZQReps->ParamByName("pref")->AsInteger=10;
   if (kind_energy==1)
     ZQReps->ParamByName("pref")->AsInteger=20;
   if (kind_energy==2)
     ZQReps->ParamByName("pref")->AsInteger=510;
   if (kind_energy==3)
     ZQReps->ParamByName("pref")->AsInteger=520;
   if (kind_energy==4)
     ZQReps->ParamByName("pref")->AsInteger=524;

   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->Open();
   }
   catch(EDatabaseError &e)
   {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
   }

   if (ZQReps->FieldByName("flock")->AsInteger != 1 )
   {

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_nds2011_fun( :mmgg, :pref, :build );");

    if (kind_energy==0)
      ZQReps->ParamByName("pref")->AsInteger=10;
    if (kind_energy==1)
      ZQReps->ParamByName("pref")->AsInteger=20;
    if (kind_energy==2)
      ZQReps->ParamByName("pref")->AsInteger=510;
    if (kind_energy==3)
      ZQReps->ParamByName("pref")->AsInteger=520;
    if (kind_energy==4)
      ZQReps->ParamByName("pref")->AsInteger=524;

    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
    ZQReps->ParamByName("build")->AsBoolean=Build;

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
   }
   else
   {
    ShowMessage("Нельзя переформировать закрытый месяц!");
   }
  }


   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add("select sum(value_tax) as sum_tax from ( \
       select id_doc,value_tax from acm_tax_tbl where mmgg = :mmgg and id_pref = :pref and int_num <> 0\
       union all \
       select id_doc,value_tax from acm_taxcorrection_tbl where mmgg = :mmgg and id_pref = :pref and int_num <> 0 \
       ) as ss;    ");

   if (kind_energy==0)
     ZQReps->ParamByName("pref")->AsInteger=10;
   if (kind_energy==1)
     ZQReps->ParamByName("pref")->AsInteger=20;
   if (kind_energy==2)
     ZQReps->ParamByName("pref")->AsInteger=510;
   if (kind_energy==3)
     ZQReps->ParamByName("pref")->AsInteger=520;
   if (kind_energy==4)
     ZQReps->ParamByName("pref")->AsInteger=524;


   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->Open();
   }
   catch(EDatabaseError &e)
   {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
   }

   double taxsum = ZQReps->FieldByName("sum_tax")->AsFloat;

  ZQReps->Close();

  AnsiString  sqlstr1=" select * from  rep_nds2011_tbl where mmgg = :mmgg and id_pref = :pref;";

  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)
    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)
    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)
    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)
    ZQXLReps->ParamByName("pref")->AsInteger=524;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="ltaxnds";

  xlReport->ParamByName["ltaxnds"]->Value = FormatFloat("0.00",taxsum);

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = " Звіт по реалізації активної електроенергії .";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = " Звіт по реалізації реактивної електроенергії.";

  if (kind_energy==2)
    xlReport->ParamByName["caption"]->Value = " Звіт по реалізації електроенергії (2кр потужність).";

  if (kind_energy==3)
    xlReport->ParamByName["caption"]->Value = " Звіт по реалізації електроенергії (2кр споживання до 2014 року).";

  if (kind_energy==4)
    xlReport->ParamByName["caption"]->Value = " Звіт по реалізації електроенергії (2кр споживання починаючи з 2014 року).";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonGrp(TDateTime dtb,TDateTime dte,int kind_energy)
{
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , boss.represent_name as bossname, boss.position, addr.adr,   \
  (b.value+b.value_tax) as dem, b.kvt, coalesce(scl.id_section,999) as link \
  from clm_client_tbl as cl \
  join (select id_client, sum(demand_val) as kvt, sum(value) as value, sum(value_tax) as value_tax \
  from acm_bill_tbl \
  where ( \
   (  (mmgg >= date_trunc('month', :dtb::::date) and mmgg <= date_trunc('month', :dte::::date)) \
     and (date_trunc('month', :dtb::::date) = :dtb::::date) and (date_trunc('month', :dte::::date)+'1 month'::::interval-'1 day'::::interval = :dte::::date )) \
  or (coalesce(dat_e,reg_date) >= :dtb and coalesce(dat_e,reg_date) <= :dte  and ((date_trunc('month', :dtb::::date) <> :dtb) or (date_trunc('month', :dte::::date)+'1 month'::::interval-'1 day'::::interval <> :dte::::date ) )  ) )\
  and id_pref = :pref \
  group by id_client )as b  on (cl.id = b.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  left join adv_address_tbl as addr on (addr.id = cl.id_addres) \
  left join ( select pos.id_client, pos.represent_name, p.name as position \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
            where (p_1.minid is not null ) or (pc.cnt = 1) \
            order by id_client     ) as boss on ( boss.id_client = cl.id) \
  where  cl.book = -1  and cl.idk_work not in (0,99) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  order by cl.code ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }

  // по категориям
  AnsiString  sqlstr2= " select n.id as link, n.name,n.sort, sum(sss.kvt) as kvt, sum(sss.dem) as dem \
     from ( select sum(b.value+b.value_tax) as dem , sum(b.demand_val) as kvt, coalesce(scl.id_section,999) as section \
     from clm_client_tbl as cl join acm_bill_tbl as b on (cl.id = b.id_client) \
     join clm_statecl_h as scl  on (cl.id = scl.id_client) \
     where \
     (( (b.mmgg >= date_trunc('month', :dtb::::date) and b.mmgg <= date_trunc('month', :dte::::date)) \
     and (date_trunc('month', :dtb::::date) = :dtb::::date) and (date_trunc('month', :dte::::date)+'1 month'::::interval-'1 day'::::interval = :dte::::date )) \
     or (coalesce(b.dat_e,b.reg_date) >= :dtb and coalesce(b.dat_e,b.reg_date) <= :dte  and ((date_trunc('month', :dtb::::date) <> :dtb) or (date_trunc('month', :dte::::date)+'1 month'::::interval-'1 day'::::interval <> :dte::::date ) )  ) )\
     and b.id_pref = :pref and cl.book = -1 and cl.idk_work not in (0,99) \
     and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
     group by section )as sss \
     left join \
     (select p1.id as id1,p2.id as id2,p3.id as id3,p4.id as id4 \
     from cla_param_tbl as p1 \
     left join cla_param_tbl as p2 on (p2.id = p1.id_parent ) \
     left join cla_param_tbl as p3 on (p3.id = p2.id_parent ) \
     left join cla_param_tbl as p4 on (p4.id = p3.id_parent ) \
     where p1.id_group= 200 and p1.id <>200 ) as gr on (gr.id1 = sss.section) \
     right join    ( select p.id, p.lev, p.sort ,\
      CASE WHEN p.lev = 2 THEN p.name \
           WHEN p.lev = 3 THEN ' - '||p.name \
           WHEN p.lev = 4 THEN ' - - '||p.name \
           WHEN p.lev = 1 THEN 'ВСЬОГО' END AS name \
      from cla_param_tbl as p where p.id_group= 200 or p.id = 200  ) as  n  \
     on (n.id in (gr.id1,gr.id2,gr.id3,gr.id4) ) \
     group by  n.id, n.name , n.sort order by n.sort ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLRepsSum->ParamByName("dte")->AsDateTime=dte;

  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  Word year3;
  Word month3;
  Word day3;

  DecodeDate(dtb,year1,month1,day1);
  DecodeDate(dte,year2,month2,day2);
  DecodeDate(dte+1,year3,month3,day3);

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  if((month1 == month2)&&(day1 ==1 )&&(day3 ==1))
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtb);
  }
  else
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yyyy",dtb)+" - "+
     FormatDateTime("dd.mm.yyyy",dte);
  }

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії .";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------

void TfReports::PrintAkt1(TDateTime dt,int kind_energy,int client)
{
  if(client==0) return;

   AnsiString  sqlstr;

//   if (kind_energy==0)  sqlstr=" select seb_obr( date_trunc('month', :mmgg::::date)::::date )";
//   else sqlstr=" select seb_obrr( date_trunc('month', :mmgg::::date)::::date)";

   //sqlstr=" select seb_all( 0, date_trunc('month', :mmgg::::date)::::date )";

   sqlstr=" select seb_one( date_trunc('month', :mmgg::::date)::::date, 0, :client )";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=dt;
   ZQReps->ParamByName("client")->AsInteger=client;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }


  AnsiString  sqlstr1="select abon.name as abonname, \
  abon.short_name as abonsname, abon.code, res.name as resname,res.short_name as ressname, \
  addr.full_adr as abonaddr, cla.name as industrname, cla.kod as indcod, \
  coalesce(-deb_kme,0) as saldod, coalesce(-deb_kmpdv,0) as saldotaxd, coalesce(kr_zkme,0) as saldok, \
  coalesce(kr_zkmpdv,0) as saldotaxk, \
  CASE WHEN coalesce(deb_kmv,0) <0 THEN res.short_name ELSE abon.short_name END as viner, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname,  ab.abn_boss \
  from \
  clm_client_tbl as abon \
  join adv_address_tbl as addr on (addr.id = abon.id_addres) \
  join clm_statecl_h as abonpar on (abonpar.id_client = abon.id) \
  left join cla_param_tbl as cla on (cla.id = abonpar.id_grp_industr) \
  left join seb_obr_all_tmp as obr on (obr.id_client = abon.id and obr.id_pref = :pref and obr.period = date_trunc('month',  :dt::::date) ) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and abonpar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as abonpar2 where abonpar2.id_client = abonpar.id_client and abonpar2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
  and (res.id = syi_resid_fun() )";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);


  ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  ZQXLReps->ParamByName("client")->AsInteger=client;
  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
 /*
  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }
   */
  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="energy";
  Param=xlReport->Params->Add();
  Param->Name="workdt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
//  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->ParamByName["workdt"]->Value = dt;


  if (kind_energy==0)
    xlReport->ParamByName["energy"]->Value = "активну електроенергію";
  if (kind_energy==1)
    xlReport->ParamByName["energy"]->Value = "реактивну електроенергію";

  if (kind_energy==3)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";
  if (kind_energy==4)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";

  if (kind_energy==2)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту потужності ";
  xlReport->Report();

  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::PrintAbonFiders(boolean Build)
{

  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select sss.*, ee.name_eqp as grpname from ( ";

  if (cbUr->Checked)
  {
   sqlstr1 = sqlstr1 + " select 0 as book,c.code,c.short_name, eq.name_eqp, ba.num_meter, id_grp as link, v.voltage_min as voltage , ";
   sqlstr1 = sqlstr1 +" CASE WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl ";
   sqlstr1 = sqlstr1 +" from bal_abons_tbl as ba ";
   sqlstr1 = sqlstr1 +" join clm_client_tbl as c on (c.id = ba.id_client) ";
   sqlstr1 = sqlstr1 +" join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) ";
   sqlstr1 = sqlstr1 +" join eqm_equipment_tbl as eq on (eq.id = ba.id_point) ";
   sqlstr1 = sqlstr1 +" join eqm_point_tbl as p on (p.code_eqp = ba.id_point) ";
   sqlstr1 = sqlstr1 +" join eqk_voltage_tbl as v on (p.id_voltage = v.id) ";
   sqlstr1 = sqlstr1 +" where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) ";
  }

  if ((cbUr->Checked)&&(cbFiz->Checked))
   sqlstr1 = sqlstr1 +" union ";

  if (cbFiz->Checked)
  {
   sqlstr1 = sqlstr1 +" select c.book,c.code,c.name as short_name, '' as name_eqp, ba.num_meter, id_grp as link, 0.4 as voltage ," ;
   sqlstr1 = sqlstr1 +" CASE WHEN coalesce(c.id_state,0)=50 THEN 'Архив'::::varchar WHEN ba.id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl " ;
   sqlstr1 = sqlstr1 +" from bal_abons_tbl as ba " ;
   sqlstr1 = sqlstr1 +" join clm_pclient_tbl as c on (c.id = ba.id_client) " ;
  }

   sqlstr1 = sqlstr1 +" )as sss left join eqm_equipment_tbl as ee on (ee.id = link) order by book, code " ;

  ZQXLReps->Sql->Add( sqlstr1 );

  // фидера

  AnsiString  sqlstr2=" select sss2.*, sss4.cnt  from \
  (  select coalesce(ffs.id_st,ffs.id_fider) as link, ffs.f, ffs.id_fider, \
  CASE WHEN ffs.f = 1 THEN eq.name_eqp else ' - '||eq.name_eqp END as name \
  from (select 1 as f,code_eqp as id_fider , NULL as id_st from eqm_fider_tbl \
        union \
        select 2, * from bal_fider_st_tbl) as ffs \
  join eqm_equipment_tbl as eq on (eq.id = coalesce(ffs.id_st,ffs.id_fider)) \
  where (ffs.id_fider = :fider) or ( :fider = 0 ) ) as sss2 \
  left join \
  ( select link, count(*) as cnt from (" +sqlstr1+ ") as sss3  group by link ) as sss4 on (sss2.link = sss4.link) \
  order by id_fider, f, name  ; ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";

  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
  if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//---------------------------------------------------------------------------

void TfReports::PrintAbonFiders_mem(TDateTime mmgg, boolean Build)
{

  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Close();
  ZQXLReps2->Close();

  ZQXLReps->Sql->Clear();
  ZQXLReps2->Sql->Clear();

  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, \
case when id_voltage in (1,2) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when id_voltage in (1,2) and type_eqp = 8 then grpname \
     when id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

  if (cbUr->Checked)
  {
   sqlstr1 = sqlstr1 + " select 0 as book,c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, id_grp as link, v.voltage_min as voltage , ";
   sqlstr1 = sqlstr1 +" CASE WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl, '' as border_eqp, p.power ";
   sqlstr1 = sqlstr1 +" from bal_abons_tbl as ba ";
   sqlstr1 = sqlstr1 +" join clm_client_tbl as c on (c.id = ba.id_client) ";
   sqlstr1 = sqlstr1 +" join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) ";
   sqlstr1 = sqlstr1 +" join eqm_equipment_tbl as eq on (eq.id = ba.id_point) ";
   sqlstr1 = sqlstr1 +" join eqm_point_tbl as p on (p.code_eqp = ba.id_point) ";
   sqlstr1 = sqlstr1 +" join eqk_voltage_tbl as v on (p.id_voltage = v.id) ";
   sqlstr1 = sqlstr1 +" where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) and coalesce(p.reserv,0)=0 ";
  }

  if ((cbUr->Checked)&&(cbFiz->Checked))
   sqlstr1 = sqlstr1 +" union ";

  if (cbFiz->Checked)
  {

   if (res_code==310)
    sqlstr1 = sqlstr1 +" select c.book,c.code,c.name as short_name, ba.id_point,coalesce((stt.shot_name||' '||st.name||' '||coalesce(c.build,'')||' кв.'||coalesce(c.office,''))::::varchar,c.address) as name_eqp,    ba.num_meter, id_grp as link, 0.4 as voltage,  " ;
   else
    sqlstr1 = sqlstr1 +" select c.book,c.code,c.name as short_name, ba.id_point,coalesce((t.name||' '||stt.shot_name||' '||st.name||' '||coalesce(c.build,'')||' кв.'||coalesce(c.office,''))::::varchar,c.address) as name_eqp,    ba.num_meter, id_grp as link, 0.4 as voltage,  " ;

   sqlstr1 = sqlstr1 +" CASE WHEN coalesce(c.id_state,0)=50 THEN 'Архив'::::varchar WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl, eq.name_eqp as border_eqp, c.set_power as power " ;
   sqlstr1 = sqlstr1 +" from bal_abons_tbl as ba " ;
   sqlstr1 = sqlstr1 +" join clm_pclient_tbl as c on (c.id = ba.id_client) " ;
   sqlstr1 = sqlstr1 +" join eqm_equipment_tbl as eq on (eq.id = c.id_eqpborder) " ;
   sqlstr1 = sqlstr1 +" left join adi_street_tbl as st on (st.id=c.id_street) " ;
   sqlstr1 = sqlstr1 +" left join adi_town_tbl as t on (st.id_town=t.id) " ;
   sqlstr1 = sqlstr1 +" left join adk_street_tbl as stt on (st.idk_street=stt.id) " ;


  }

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss   where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) order by name_ps35, name_f10, name_ps10, book, code " ;

  ZQXLReps->Sql->Add( sqlstr1+ " LIMIT 64000 ;" );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps2->Sql->Add( sqlstr1+ " OFFSET 64000 ;" );
  ZQXLReps2->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  ZQXLReps2->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
/*
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";
*/
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";

  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
  if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLReps2->Close(); 
// ZQXLRepsSum->Close();

// ZQXLReps->MasterSource=NULL;
// ZQXLReps->LinkFields="";
}
//------------------------------------------------------------------------------
void TfReports::PrintAbonFidersInfo(TDateTime mmgg, boolean Build)
{

//  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector,  \
     ww.worktype,ww.dt_work,ww.comment, \
     CASE WHEN cst.abon_ps is null THEN '' WHEN cst.abon_ps = 1 THEN 'Абон.' ELSE 'РЕМ' END as ps_owner ,\
coalesce(ff.id_station,case when ssss.id_voltage in (1,2) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END) as code_ps35, \
coalesce(eqps.name_eqp,case when ssss.id_voltage in (1,2) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END) as name_ps35, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, cla.name as group, \
  adv.adr, im.type, ph.name as phase, km.name as kind, cp.represent_name,stt.tt_type, bb.inf, id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_eqp_tree_tbl as tt on (ba.id_point = tt.code_eqp) \
  join eqm_tree_tbl as t on (t.id = tt.id_tree) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqm_borders_tbl as bb on (bb.code_eqp = t.code_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  left join cla_param_tbl as cla on (stcl.id_section = cla.id) \
  left join \
  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
  ic.conversion , ic.type as tt_type,ic.accuracy from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) and coalesce(p.reserv,0)=0  ";

  //left join clm_statecl_tbl as sc on (c.id = sc.id_client)

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join eqm_compens_station_tbl as cst on (cst.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join eqm_equipment_tbl as eqps on (eqps.id = ff.id_station) \
  left join \
  ( select wi.name as worktype, w.id_point,w.dt_work,w.comment \
    from clm_works_tbl as w \
    join cli_works_tbl as wi on (wi.id = w.id_type) \
    join (select min(w1.id) as id , w1.dt_work, w1.id_point \
     from clm_works_tbl as w1 \
     join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = 1 or id_type = 2 group by id_client, id_point) as w2 \
     on (w1.id_client = w2.id_client and w1.id_point = w2.id_point and w1.dt_work  = w2.dt_work ) \
     group by w1.id_point, w1.dt_work\
    ) as ww on (w.id = ww.id) \
  ) as ww on (ww.id_point = ssss.id_point) \
    where (( case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
  order by code " ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  AnsiString sqlstr2 =" select name_f10, fider_inspector ,\
  sum(CASE WHEN phase = 1 and kind =1 THEN 1 ELSE 0 END ) as cnt_1_1, \
  sum(CASE WHEN phase = 1 and kind =2 THEN 1 ELSE 0 END ) as cnt_1_2, \
  sum(CASE WHEN phase = 2 and kind =1 and tt_type is null THEN 1 ELSE 0 END ) as cnt_2_1_no, \
  sum(CASE WHEN phase = 2 and kind =1 and tt_type is not null THEN 1 ELSE 0 END ) as cnt_2_1_yes, \
  sum(CASE WHEN phase = 2 and kind =2 and tt_type is null THEN 1 ELSE 0 END ) as cnt_2_2_no, \
  sum(CASE WHEN phase = 2 and kind =2 and tt_type is not null THEN 1 ELSE 0 END ) as cnt_2_2_yes, \
  sum(CASE WHEN (phase is null ) or ( kind is null)  or (phase not in (1,2)) or (kind not in (1,2)) THEN 1 ELSE 0 END ) as cnt_unknown \
   from \
  ( select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( \
  select c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type, ph.id as phase, km.id as kind, cp.represent_name,stt.tt_type, id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  left join \
  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
  ic.conversion , ic.type as tt_type,ic.accuracy from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) and coalesce(p.reserv,0)=0  \
    )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
    ) as bigsel \
    group by name_f10, fider_inspector  order by name_f10 " ;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add( sqlstr2 );
  ZQXLReps2->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";

  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
 // if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();

}
//------------------------------------------------------------------------------

void TfReports::PrintPsFiders_mem(TDateTime mmgg, boolean Build)
{

 // if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select cnt_prom, cnt_fiz, \
case when id_voltage in (1,2) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when id_voltage in (1,2) and type_eqp = 8 then grpname \
     when id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when type_eqp = 3 then code_eqp \
     when type_eqp2 = 3 then code_eqp2 \
     when type_eqp3 = 3 then code_eqp3 \
     when type_eqp4 = 3 then code_eqp4 END as code_vvod, \
case when type_eqp = 3 then grpname \
     when type_eqp2 = 3 then grpname2 \
     when type_eqp3 = 3 then grpname3 \
     when type_eqp4 = 3 then grpname4 END as name_vvod, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage  in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( select ee.name_eqp as grpname , \
 gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
 gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
 gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
 gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
 ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
from \
bal_grp_tree_tbl as gr1 \
left join eqm_equipment_tbl as ee on (ee.id =  gr1.code_eqp) \
left join bal_grp_tree_tbl as gr2 on (gr2.id_p_eqp = gr1.code_eqp and gr2.mmgg= :mmgg::::date and (gr2.type_eqp=8 or gr2.type_eqp=15 or gr2.type_eqp=3)) \
left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
left join bal_grp_tree_tbl as gr3 on (gr3.id_p_eqp = gr2.code_eqp and gr3.mmgg= :mmgg::::date and (gr3.type_eqp=8 or gr3.type_eqp=15 or gr3.type_eqp=3)) \
left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
left join bal_grp_tree_tbl as gr4 on (gr4.id_p_eqp = gr3.code_eqp and gr4.mmgg= :mmgg::::date and (gr4.type_eqp=8 or gr4.type_eqp=15 or gr4.type_eqp=3)) \
left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
where  gr1.mmgg= :mmgg::::date and gr1.id_p_eqp is null and (gr1.type_eqp=8 or gr1.type_eqp=15 or gr1.type_eqp=3) \
order by code_eqp4, code_eqp3, code_eqp2 ,code_eqp \
) as ssss \
left join (select id_grp as link, count(distinct id_point) as cnt_prom \
           from bal_abons_tbl as ba \
           join clm_client_tbl as c on (c.id = ba.id_client) \
           join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
           where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99)  group by id_grp order by id_grp  )  as sss \
  on (sss.link =  coalesce(ssss.code_eqp4, ssss.code_eqp3, ssss.code_eqp2 ,ssss.code_eqp )) \
left join ( select id_grp as link, count(distinct id_client) as cnt_fiz \
           from bal_abons_tbl as ba \
           join clm_pclient_tbl as c on (c.id = ba.id_client) where coalesce(c.id_state,0)<>50 group by id_grp order by id_grp) as ssf \
 on (ssf.link =  coalesce(ssss.code_eqp4, ssss.code_eqp3, ssss.code_eqp2 ,ssss.code_eqp )) \
 where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
 order by name_ps35,name_vvod, name_f10, name_ps10  ";

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Підключення абонентів до мереж РЕМ (підсумкова таблиця). ";

//  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
//  if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();
}

//---------------------------------------------------------------------------
void TfReports::PrintTaxBookNew (TDateTime dt_b)
{
   AnsiString sqlstr=" update clm_statecl_tbl set tax_num='  '|| tax_num  WHERE length(tax_num)=10 ";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   };

  sqlstr=" select res.short_name as resname, \
  respar.tax_num as taxnum_res,respar.licens_num as SvidNum_res \
  from clm_client_tbl as res \
  left join clm_statecl_h as respar on (respar.id_client = res.id) \
  where res.id = syi_resid_fun() \
  and respar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as respar2 where respar2.id_client = respar.id_client and respar2.mmgg_b <= :mmgg::::date ) ; ";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  ZQReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="ResName_Addr";
  Param=xlReport->Params->Add();
  Param->Name="NumRes";
  Param=xlReport->Params->Add();
  Param->Name="SvidNumRes";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  if (ZQReps->RecordCount>0)
   {
    ZQReps->First();

    xlReport->ParamByName["ResName_Addr"]->Value =  ZQReps->FieldByName("resname")->AsString;
    xlReport->ParamByName["NumRes"]->Value = ZQReps->FieldByName("taxnum_res")->AsString;
    xlReport->ParamByName["SvidNumRes"]->Value = ZQReps->FieldByName("SvidNum_res")->AsString;
   }
  ZQReps->Close();

  if(dt_b< TDateTime(2010,1,1))
  {
   xlReport->ParamByName["caption"]->Value = " Реестр виданих податкових накладних за електроенергію за "+
      FormatDateTime("mmmm yyyy",dt_b);
  }
  else
  {
   xlReport->ParamByName["caption"]->Value = " Реестр отриманих та виданих податкових накладних за "+
      FormatDateTime("mmmm yyyy",dt_b);
  }


  AnsiString  sqlstr1=" select * from ( \
  select t.int_num,0::::int as tax_type, '1990-01-01'::::date as date_tax,t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN cl.name ELSE cl.name ||' (поставка неплатнику податку)' END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE 'XXXXXXXXXXXX' END as tax_num, \
  CASE WHEN coalesce(t.pay_p,0)<>1999 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN coalesce(t.pay_p,0) =1999 THEN t.value ELSE 0 END as val_0 \
  from acm_tax_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  union \
  select  t.id_doc,1::::int as tax_type, tt.reg_date as date_tax,t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN cl.name ELSE cl.name ||' (поставка неплатнику податку)' END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE 'XXXXXXXXXXXX' END as tax_num, \
  CASE WHEN t.value_tax<>0 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN t.value_tax=0 THEN t.value ELSE 0 END as val_0 \
  from acm_taxcorrection_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  left join acm_tax_tbl tt on(tt.id_doc=t.id_tax)  \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  ) as s order by reg_date,int_num,reg_num ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dt_b;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void __fastcall TfReports::sbFiderClick(TObject *Sender)
{
  TWTQuery *QueryAdr;
  QueryAdr = new  TWTQuery(this);
  TZDatasetOptions Options;
  Options=QueryAdr->Options;
  Options << doQuickOpen;
  QueryAdr->Options=Options;

  QueryAdr->Sql->Clear();

  QueryAdr->Sql->Add("select eq.id, eq.name_eqp from eqm_equipment_tbl as eq where eq.type_eqp = 15  order by eq.name_eqp; ");


  WFiderGrid = new TWTWinDBGrid(this, QueryAdr,false);
  WFiderGrid->SetCaption("Фидера");

  TWTQuery* Query = WFiderGrid->DBGrid->Query;

  Query->Open();

  TStringList *WList=new TStringList();
  WList->Add("id");

  TStringList *NList=new TStringList();
  NList->Add("id");

  QueryAdr->SetSQLModify("eqm_equipment_tbl",WList,NList,false,false,false);
  TWTField *Field;

//  Field = WFiderGrid->AddColumn("kindname", "Тип", "Тип");
  Field = WFiderGrid->AddColumn("name_eqp", "Наименование", "Наименование");

  WFiderGrid->DBGrid->FieldSource = WFiderGrid->DBGrid->Query->GetTField("id");

  WFiderGrid->DBGrid->StringDest = "-1";
  WFiderGrid->DBGrid->OnAccept=PlaceAccept;
  WFiderGrid->DBGrid->Visible = true;
  WFiderGrid->DBGrid->ReadOnly=true;
  WFiderGrid->ShowAs("Выбор фидера");


}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbFiderClClick(TObject *Sender)
{
FiderId = 0;
edFiderName->Text ="";
}
//---------------------------------------------------------------------------

void __fastcall TfReports::PlaceAccept (TObject* Sender)
{
   FiderId =WFiderGrid->DBGrid->Query->FieldByName("id")->AsInteger;
   edFiderName->Text =WFiderGrid->DBGrid->Query->FieldByName("name_eqp")->AsString;
}
//---------------------------------------------------------------------------

void TfReports::PrintAbonNoFiders(boolean Build)
{

  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {
  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(" select * from ( ");
  if (cbUr->Checked)
  {
   ZQXLReps->Sql->Add(" select 0 as book,c.code,c.short_name, eq.name_eqp, ba.num_meter, ");
   ZQXLReps->Sql->Add(" CASE WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl, eq.id,p.power  ");
   ZQXLReps->Sql->Add(" from bal_abons_tbl as ba ");
   ZQXLReps->Sql->Add(" join clm_client_tbl as c on (c.id = ba.id_client) ");
   ZQXLReps->Sql->Add(" join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) ");
   ZQXLReps->Sql->Add(" join eqm_equipment_tbl as eq on (eq.id = ba.id_point) ");
   ZQXLReps->Sql->Add(" join eqm_point_tbl as p on (eq.id = p.code_eqp) ");
   ZQXLReps->Sql->Add(" where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) and id_grp is null ");
  }
  if ((cbUr->Checked)&&(cbFiz->Checked))
   ZQXLReps->Sql->Add(" union ");

  if (cbFiz->Checked)
  {
   if (res_code==310)
     ZQXLReps->Sql->Add(" select c.book,c.code,c.name as short_name, coalesce((stt.shot_name||' '||st.name||' '||coalesce(c.build,'')||' кв.'||coalesce(c.office,''))::::varchar,c.address) as name_eqp, ba.num_meter, " );
   else
     ZQXLReps->Sql->Add(" select c.book,c.code,c.name as short_name, coalesce((t.name||' '||stt.shot_name||' '||st.name||' '||coalesce(c.build,'')||' кв.'||coalesce(c.office,''))::::varchar,c.address) as name_eqp, ba.num_meter, " );

   ZQXLReps->Sql->Add(" CASE WHEN coalesce(c.id_state,0)=50 THEN 'Архив'::::varchar WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl, null as id, c.set_power as power " );
   ZQXLReps->Sql->Add(" from bal_abons_tbl as ba " );
   ZQXLReps->Sql->Add(" join clm_pclient_tbl as c on (c.id = ba.id_client) " );
   ZQXLReps->Sql->Add(" left join adi_street_tbl as st on (st.id=c.id_street) " );
   ZQXLReps->Sql->Add(" left join adi_town_tbl as t on (st.id_town=t.id) ");
   ZQXLReps->Sql->Add(" left join adk_street_tbl as stt on (st.idk_street=stt.id) ");
   ZQXLReps->Sql->Add(" where id_grp is null  " );
  }

  ZQXLReps->Sql->Add(" )as sss order by book, code;  " );

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Перелік непідключених абонентів. ";

  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
  if (cbFiz->Checked) caption =caption +" Населення; ";

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------------
void TfReports::PrintAbonConnect(boolean Build)
{

 ZQXLReps->Close();
 ZQXLReps->Sql->Clear();

   ZQXLReps->Sql->Add(" select * from ( select cl.id ,cl.book, cl.code,cl.name, cl.set_power, \
    (t.name||' вул. '||st.name||' '||coalesce(cl.build,'')||' '||coalesce(cl.office,''))::::varchar as adr, \
    cl.id_eqpborder,he.name_eqp, cl.address, \
     CASE WHEN coalesce(cl.id_state,0)=50 THEN 'Архив'::::varchar ELSE ''::::varchar END as state \
     from clm_pclient_tbl as cl \
left join adi_street_tbl as st on (st.id=cl.id_street) \
left join adi_town_tbl as t on (st.id_town=t.id)       \
left join eqm_equipment_h as he on cl.id_eqpborder=he.id  \
 order by cl.book, cl.code ) as s   ");


  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Перелік  абонентів. ";

  

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------
// акт для бюджетников
void TfReports::PrintAkt2(TDateTime dt,int kind_energy,int client)
{
  if(client==0) return;

   AnsiString sqlstr;

   sqlstr=" select seb_all( 0, date_trunc('month', :mmgg::::date)::::date )";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=dt;

   try
   {
    ZQReps->ExecSql();
   }
   catch(EDatabaseError &e)
   {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
   }

  //больше 0 - кредитор
  // меньше 0 - дебитор

  AnsiString  sqlstr1="select abon.name as abonname, \
  abon.short_name as abonsname, abon.code, res.name as resname,res.short_name as ressname, \
  addr.full_adr as abonaddr, cla.name as industrname, cla.kod as indcod, \
  coalesce(deb_kme,0)+coalesce(kr_zkme,0) as saldo, coalesce(deb_kmpdv,0) +coalesce(kr_zkmpdv,0) as saldotax,  \
  coalesce((deb_kme -deb_km99v -deb_km00e -deb_km01e- deb_km02e -deb_km03e - deb_km04e- deb_km05e- deb_km06e- deb_km07e- deb_km08e),0)+coalesce(kr_zkme,0) as saldonew, \
  coalesce(deb_kmpdv -deb_km00pdv -deb_km01pdv- deb_km02pdv -deb_km03pdv - deb_km04pdv- deb_km05pdv- deb_km06pdv - deb_km07pdv - deb_km08pdv ,0) +coalesce(kr_zkmpdv,0) as saldotaxnew,  \
  CASE WHEN coalesce(deb_kmv,0) =0 THEN res.short_name ELSE abon.short_name END as viner, \
  CASE WHEN coalesce(deb_kmv,0) =0 THEN abon.short_name ELSE res.short_name END as looser, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as addr on (addr.id = abon.id_addres) \
  left join clm_statecl_h as abonpar on (abonpar.id_client = abon.id) \
  left join cla_param_tbl as cla on (cla.id = abonpar.id_grp_industr) \
  left join seb_obr_all_tmp as obr on (obr.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client and obr.id_pref = :pref \
  and obr.period = date_trunc('month',  :dt::::date) \
  and abonpar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as abonpar2 where abonpar2.id_client = abonpar.id_client and abonpar2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
  and (res.id = syi_resid_fun() )";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);


  ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  ZQXLReps->ParamByName("client")->AsInteger=client;


  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="energy";
  Param=xlReport->Params->Add();
  Param->Name="workdt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->ParamByName["workdt"]->Value = dt;

  if (kind_energy==0)
    xlReport->ParamByName["energy"]->Value = "(активну електроенергію)";
  if (kind_energy==1)
    xlReport->ParamByName["energy"]->Value = "(реактивну електроенергію)";

  if (kind_energy==3)
    xlReport->ParamByName["energy"]->Value = "(перевищення ліміту споживання електроенергії)";
  if (kind_energy==4)
    xlReport->ParamByName["energy"]->Value = "(перевищення ліміту споживання електроенергії)";

  if (kind_energy==2)
    xlReport->ParamByName["energy"]->Value = "(перевищення ліміту потужності)";

  xlReport->Report();

  ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::ObSaldoNDS(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям
  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (select coalesce(obr.roz,999)as link, sum(nar) as snar, \
     sum(nar_v) as snar_v, sum(opl_zv) as sopl_zv, \
     sum(nar_pdv) as snar_n, sum(opl_zpdv) as sopl_n, \
     -sum(deb_zpmv) as sdeb, sum(kr_zpmv) as skr_zpmv, - sum(deb_pm99v) as sdeb99 ,- sum(deb_pm00v) as sdeb00,\
     - sum(deb_pm01v) as sdeb01,- sum(deb_pm02v) as  sdeb02, \
     -sum(deb_pm03v)  as sdeb03,- sum(deb_pm04v) as sdeb04, \
     -sum(deb_pm05v) as sdeb05,- sum(deb_pm06v) as sdeb06,- sum(deb_pm07v) as sdeb07, - sum(deb_pm08v) as sdeb08,\
     -sum(deb_pm09v) as sdeb09, -sum(deb_pm10v) as sdeb10, -sum(deb_pm11v) as sdeb11, -sum(deb_pm12v) as sdeb12, \
     -sum(deb_pm13v) as sdeb13, -sum(deb_pm14v) as sdeb14, \
     -sum(deb_kmv) as sdeb_k, sum(kr_zkmv) as skr_zkmv, - sum(deb_km99v) as sdeb99_k ,- sum(deb_km00v) as sdeb00_k, \
     -sum(deb_km01v) as sdeb01_k,- sum(deb_km02v) as  sdeb02_k, \
     -sum(deb_km03v) as sdeb03_k,- sum(deb_km04v) as sdeb04_k, \
     -sum(deb_km05v) as sdeb05_k, - sum(deb_km06v) as sdeb06_k, - sum(deb_km07v) as sdeb07_k,- sum(deb_km08v) as sdeb08_k,\
     -sum(deb_km09v) as sdeb09_k, -sum(deb_km10v) as sdeb10_k, -sum(deb_km11v) as sdeb11_k, -sum(deb_km12v) as sdeb12_k, \
     -sum(deb_km13v) as sdeb13_k, -sum(deb_km14v) as sdeb14_k, \
     -sum(deb_zpmpdv) as sdebn, sum(kr_zpmpdv) as skr_zpmn, - sum(deb_pm00pdv) as sdeb00n,\
     -sum(deb_pm01pdv) as sdeb01n,- sum(deb_pm02pdv) as  sdeb02n, \
     -sum(deb_pm03pdv)  as sdeb03n,- sum(deb_pm04pdv) as sdeb04n, \
     -sum(deb_pm05pdv) as sdeb05n, - sum(deb_pm06pdv) as sdeb06n, - sum(deb_pm07pdv) as sdeb07n,- sum(deb_pm08pdv) as sdeb08n,\
     -sum(deb_pm09pdv) as sdeb09n, -sum(deb_pm10pdv) as sdeb10n, -sum(deb_pm11pdv) as sdeb11n, -sum(deb_pm12pdv) as sdeb12n, \
     -sum(deb_pm13pdv) as sdeb13n, -sum(deb_pm14pdv) as sdeb14n, \
     -sum(deb_kmpdv) as sdeb_kn, sum(kr_zkmpdv) as skr_zkmn, - sum(deb_km00pdv) as sdeb00_kn, \
     -sum(deb_km01pdv) as sdeb01_kn,- sum(deb_km02pdv) as  sdeb02_kn, \
     -sum(deb_km03pdv) as sdeb03_kn,- sum(deb_km04pdv) as sdeb04_kn, \
     -sum(deb_km05pdv) as sdeb05_kn, - sum(deb_km06pdv) as sdeb06_kn, - sum(deb_km07pdv) as sdeb07_kn,- sum(deb_km08pdv) as sdeb08_kn, \
     -sum(deb_km09pdv) as sdeb09_kn, -sum(deb_km10pdv) as sdeb10_kn , -sum(deb_km11pdv) as sdeb11_kn, -sum(deb_km12pdv) as sdeb12_kn, \
     -sum(deb_km13pdv) as sdeb13_kn, -sum(deb_km14pdv) as sdeb14_kn \
     from %obrtable as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     join clm_statecl_h as stcl on (stcl.id_client=c.id) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
     and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) ";

     if (cbNoKey->Checked)
       sqlstr2=sqlstr2+ " and stcl.flag_key = 0 ";

     sqlstr2=sqlstr2+ "  group by obr.roz ) as sss \
     join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort; ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;

  // по потребителям
  AnsiString  sqlstr1="  select coalesce(obr.roz,999) as link ,obr.osob_r,obr.osob_rsk as abon_name, \
     CASE WHEN stcl.dt_end_rent is not null THEN 1 END as closed, \
     nar, nar_v,opl_zv, nar_pdv as nar_n, opl_zpdv as opl_n, \
     -deb_zpmv as deb, kr_zpmv, - deb_pm99v as deb99 ,- deb_pm00v as deb00, - deb_pm01v as deb01,- deb_pm02v as  deb02, \
     -deb_pm03v  as deb03,- deb_pm04v as deb04, \
     -deb_pm05v as deb05, - deb_pm06v as deb06, - deb_pm07v as deb07, - deb_pm08v as deb08,\
     -deb_pm09v as deb09, -deb_pm10v as deb10, -deb_pm11v as deb11, -deb_pm12v as deb12, \
     -deb_pm13v as deb13, -deb_pm14v as deb14, \
     -deb_kmv as deb_k,kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, -deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k,\
     -deb_km09v as deb09_k, -deb_km10v as deb10_k, -deb_km11v as deb11_k, -deb_km12v as deb12_k, \
     -deb_km13v as deb13_k, -deb_km14v as deb14_k, \
     -deb_zpmpdv as debn, kr_zpmpdv as kr_zpmn, - deb_pm00pdv as deb00n, - deb_pm01pdv as deb01n,- deb_pm02pdv as  deb02n, \
     -deb_pm03pdv  as deb03n,- deb_pm04pdv as deb04n, \
     -deb_pm05pdv as deb05n, -deb_pm06pdv as deb06n, - deb_pm07pdv as deb07n,- deb_pm08pdv as deb08n,\
     -deb_pm09pdv as deb09n, -deb_pm10pdv as deb10n, -deb_pm11pdv as deb11n, -deb_pm12pdv as deb12n, \
     -deb_pm13pdv as deb13n, -deb_pm14pdv as deb14n, \
     -deb_kmpdv as deb_kn,kr_zkmpdv as kr_zkmn, - deb_km00pdv as deb00_kn, - deb_km01pdv as deb01_kn,- deb_km02pdv as deb02_kn, \
     -deb_km03pdv  as deb03_kn,- deb_km04pdv as deb04_kn, \
     -deb_km05pdv as deb05_kn, - deb_km06pdv as deb06_kn, - deb_km07pdv as deb07_kn,- deb_km08pdv as deb08_kn,  \
     -deb_km09pdv as deb09_kn, -deb_km10pdv as deb10_kn, -deb_km11pdv as deb11_kn, -deb_km12pdv as deb12_kn, \
     -deb_km13pdv as deb13_kn, -deb_km14pdv as deb14_kn \
     from %obrtable as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     join clm_statecl_h as stcl on (stcl.id_client=c.id) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) ";

     if (cbNoKey->Checked)
       sqlstr1=sqlstr1+ " and stcl.flag_key =0 ";

     sqlstr1=sqlstr1+ " and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
      order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);

  AnsiString caption;

  if (kind_energy==0)
  {
    caption = "Оборотна відомість розрахунків за активну електроенергію";
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";
  }
  if (kind_energy==1)
  {
    caption = "Оборотна відомість розрахунків за реактивну електроенергію";
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  }

  if (cbNoKey->Checked) caption+=" без ключових";

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonNoDemand( TDateTime mmgg)
{
  ZQXLReps->Sql->Clear();

  AnsiString sqlstr = "select c.id,c.code, c.name , clp.period_indicat,clp.month_indicat, clp.dt_indicat, b.value, cp.represent_name \
  from clm_client_tbl as c join clm_statecl_h as clp on (c.id = clp.id_client) \
  left join clm_position_tbl as cp on (clp.id_position=cp.id) \
  left join ( select id_client, sum(value) as value \
  from acm_bill_tbl where mmgg = :mmgg and id_pref = 10 group by id_client) as b on (b.id_client = c.id ) \
  where (b.value is null or b.value = 0) and c.book =-1 \
  and clp.mmgg_b = (select max(mmgg_b) from clm_statecl_h as clp2 where clp2.id_client = clp.id_client and clp2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ( :insp is null or clp.id_position = :insp) \
  and clp.id_section not in (205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99,3) \
  order by code;";

  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  AnsiString caption = "Абоненти, що мають нульове споживання.";
  xlReport->ParamByName["caption"]->Value = caption;

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintFor4Nkre(TDateTime mmgg)
{
  AnsiString  sqlstr1=" select vlt.name as voltage, id_tgr as link , \
  coalesce(demand_tcl1,0)::::numeric as demand_tcl1,coalesce(sum_tcl1,0) as sum_tcl1, \
  coalesce(demand_tcl2,0)::::numeric as demand_tcl2,coalesce(sum_tcl2,0) as sum_tcl2 \
  from ( (  select tgr.id as id_tgr, vv.voltage_min as voltage, sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where tcl.ident='tcl1' and b.id_pref=10 and cl.book = -1 \
  and bs.mmgg =date_trunc('month', :mmgg::::date ) \
  and cl.idk_work <> 0 \
  and tar.id not in (900001,999999) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  group by tgr.id, vv.voltage_min \
 ) as tcl1 full outer join \
 ( select tgr.id as id_tgr, vv.voltage_min as voltage, sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where tcl.ident='tcl2' and b.id_pref=10 and cl.book = -1  \
  and bs.mmgg=date_trunc('month', :mmgg::::date ) \
  and tar.id not in (900001,999999) \
  and cl.idk_work <> 0 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  group by tgr.id, vv.voltage_min \
 ) as tcl2 using (id_tgr,voltage)) as tcl \
 left join ( \
  select 'по 10, 6 и 3 кВ '::::varchar as name, 10::::int as voltage_max,3::::int as voltage_min \
  union  select 'по 0,4 кВ ',0.4,0.4 \
  union  select 'по 35 кВ ',35 ,27 \
  union  select 'по 110 кВ ',160 ,110  ) as vlt \
 on (tcl.voltage<=vlt.voltage_max and tcl.voltage>=vlt.voltage_min) \
 order by vlt.voltage_min desc;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

    // по категориям
  AnsiString  sqlstr2= " select tgr.ident,tgr.name as tarifname, tgr.id as link, \
  coalesce(demand_tcl1,0)::::numeric as demand_tcl1,coalesce(sum_tcl1,0) as sum_tcl1, \
  coalesce(demand_tcl2,0)::::numeric as demand_tcl2,coalesce(sum_tcl2,0) as sum_tcl2 \
  from ( (  select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl1' and b.id_pref=10 and cl.book = -1 \
  and bs.mmgg=date_trunc('month', :mmgg::::date ) \
  and tar.id not in (900001,999999) \
  and cl.idk_work <> 0 \
  group by tgr.id  ) as tcl1 \
  full outer join \
  ( select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl2' and b.id_pref=10 and cl.book = -1 \
  and bs.mmgg=date_trunc('month', :mmgg::::date ) \
  and tar.id not in (900001,999999) \
  and cl.idk_work <> 0 \
  group by tgr.id \
 ) as tcl2 using (id_tgr) ) as tcl\
 join eqi_grouptarif_tbl as tgr on (tgr.id = tcl.id_tgr) \
 order by tgr.ident;";

// where ident not like 'tgr8%' and ident not like 'tgr7%' \

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  //------------------------------------------------------------------------

    AnsiString  sqlstr3=" select vlt.name as voltage, section as link , \
  coalesce(demand_tcl1,0)::::numeric as demand_tcl1,coalesce(sum_tcl1,0) as sum_tcl1, \
  coalesce(demand_tcl2,0)::::numeric as demand_tcl2,coalesce(sum_tcl2,0) as sum_tcl2 \
  from ( (  select CASE WHEN p.lev=4 THEN p.id_parent  ELSE p.id END AS section , \
  vv.voltage_min as voltage, sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join cla_param_tbl as p on (stcl.id_section=p.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where tcl.ident='tcl1' and b.id_pref=10 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and bs.mmgg= date_trunc('month', :mmgg::::date )  \
  and  p.id in (211,213,214,215,203)\
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  group by section, vv.voltage_min \
 ) as tcl1 full outer join \
 ( select CASE WHEN p.lev=4 THEN p.id_parent  ELSE p.id END AS section , \
  vv.voltage_min as voltage, sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join cla_param_tbl as p on (stcl.id_section=p.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where tcl.ident='tcl2' and b.id_pref=10 and cl.book = -1  \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and bs.mmgg =date_trunc('month', :mmgg::::date ) \
  and p.id in (211,213,214,215,203) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  group by section, vv.voltage_min \
 ) as tcl2 using (section,voltage)) as tcl \
 join ( \
  select 'по 10, 6 и 3 кВ '::::varchar as name, 10::::int as voltage_max,3::::int as voltage_min \
  union  select 'по 0,4 кВ ',0.4,0.4 \
  union  select 'по 35 кВ ',35 ,27 \
  union  select 'по 110 кВ ',110 ,160  ) as vlt \
 on (tcl.voltage<=vlt.voltage_max and tcl.voltage>=vlt.voltage_min) \
 order by vlt.voltage_min desc;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr3);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

    // по категориям
  AnsiString  sqlstr4= " select p2.name as sectionname, section as link, \
  coalesce(demand_tcl1,0)::::numeric as demand_tcl1,coalesce(sum_tcl1,0) as sum_tcl1, \
  coalesce(demand_tcl2,0)::::numeric as demand_tcl2,coalesce(sum_tcl2,0) as sum_tcl2 \
  from ( (  select CASE WHEN p.lev=4 THEN p.id_parent  ELSE p.id END AS section,\
  sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join cla_param_tbl as p on (stcl.id_section=p.id) \
  where tcl.ident='tcl1' and b.id_pref=10 and cl.book = -1 \
  and bs.mmgg =date_trunc('month', :mmgg::::date ) \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and p.id in (211,213,214,215,203) \
  group by section  ) as tcl1 \
  full outer join \
  ( select  CASE WHEN p.lev=4 THEN p.id_parent  ELSE p.id END AS section, \
  sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join cla_param_tbl as p on (stcl.id_section=p.id) \
  where tcl.ident='tcl2' and b.id_pref=10 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and bs.mmgg= date_trunc('month', :mmgg::::date ) \
  and p.id in (211,213,214,215,203) \
  group by section \
 ) as tcl2 using (section) ) as tcl\
 join cla_param_tbl as p2 on (p2.id = tcl.section) \
 order by section;";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr4);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps2->MasterSource=DSRep2;
  ZQXLReps2->LinkFields="link = link";



  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();
  ZQXLReps2->Open();
  ZQXLRepsSum2->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsSum2";
  Dsr->Range = "GroupRange2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
//  Param=xlReport->Params->Add();
//  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum2->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
 ZQXLReps2->MasterSource=NULL;
 ZQXLReps2->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::Print2Zone( TDateTime mmgg)
{
  {
  AnsiString sqlstr="select rep_2zone_fun( :mmgg);";
//  AnsiString sqlstr="select seb_diftarif( :mmgg,0);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
/*
  AnsiString sqlstr = "select tgr.short_name as tgr_name, tcl.name as class, c.code, c.short_name , \
  sum(z.kvt1)/1000::::numeric  as demand_n, \
  sum(z.kvt2)/1000::::numeric  as demand_d, \
  sum(bill.demand2_old)/1000::::numeric  as demand_d_old, \
  sum(bill.demand2_new)/1000::::numeric  as demand_d_new, \
  sum(z.sum0) as sum0,  sum(z.sum123) as sum_dif, \
  max(z.tar0)::::numeric*1000 as tarif \
  from seb_diftarif_tmp as z \
  join aci_tarif_tbl as tar on (tar.id=z.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join clm_client_tbl as c on (c.code = z.code) \
  left join ( select bs.id_point, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.5 THEN bs.demand_val ELSE 0 END) as demand2_old, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.85 THEN bs.demand_val ELSE 0 END) as demand2_new, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.5 THEN bs.sum_val ELSE 0 END) as sum2_old, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.85 THEN bs.sum_val ELSE 0 END) as sum2_new \
	from acd_billsum_tbl as bs \
	join acm_bill_tbl as bm using (id_doc) \
	join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
	where bs.id_zone in (4,5) and bs.kind_energy=1 \
        and  bs.mmgg = :mmgg \
        group by bs.id_point ) as bill on (bill.id_point  = z.id_point) \
  where z.mmgg = :mmgg  and  kind = 2 and c.book =-1\
  group by tgr.short_name,tcl.name ,c.code, c.short_name order by tgr.short_name, c.code; ";
*/

/*
  AnsiString sqlstr = "select tgr.short_name as tgr_name, tcl.name as class, c.code, c.short_name , \
  sum(CASE WHEN bs.id_zone = 4 then bs.demand_val::::numeric/1000 ELSE 0 END)::::numeric  as demand_n, \
  sum(CASE WHEN bs.id_zone = 5 then bs.demand_val::::numeric/1000 ELSE 0 END)::::numeric  as demand_d, \
  sum(bs.sum_val) as sum, max(tsum.value)::::numeric*1000 as tarif \
  from acd_billsum_tbl as bs join acm_bill_tbl as b using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join (select t1.* from acd_tarif_tbl as t1 join (select id_tarif, max(dt_begin) as maxdt from acd_tarif_tbl where dt_begin <=  :mmgg group by id_tarif ) as t2 \
      on (t1.id_tarif = t2.id_tarif and t1.dt_begin = t2.maxdt) )as tsum on (tar.id = tsum.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  where bs.id_zone in (4,5) and b.mmgg = :mmgg  \
  group by tgr.short_name,tcl.name ,c.code, c.short_name order by tgr.short_name, c.code; ";
*/


  AnsiString  sqlstr="select ss.code,ss.short_name, ss.tgr_name, ss.class, ss.tarif , \
  sum(demand_n) as demand_n, \
  sum(demand_d) as demand_d, \
  sum(sum0) as sum0, \
  sum(sum_dif) as sum_dif, \
  sum(demand2_old) as demand_d_old ,sum(demand2_new) as demand_d_new \
  from \
  (select clm.code,clm.short_name, tgr.short_name as tgr_name, tcl.name as class, \
 max(z.tar0)::::numeric*1000 as tarif , \
 sum( coalesce(demand_z1::::numeric,0)/1000)::::numeric as demand_n, \
 sum(coalesce(demand_z2::::numeric,0)/1000)::::numeric as demand_d, \
 sum(coalesce(sum_z1::::numeric,0))::::numeric as sum_n, \
 sum(coalesce(sum_z2::::numeric,0))::::numeric as sum_d, \
 sum((coalesce(demand_z1,0)+coalesce(demand_z2,0))*tar0) as sum0, \
 sum(coalesce(sum_z1,0)+ coalesce(sum_z2,0)) as sum_dif, \
 z.id_point \
 from rep_2zone_tbl as z  \
 join clm_client_tbl as clm on (clm.id=z.id_client) \
 join aci_tarif_tbl as tar on (tar.id=z.id_tariff) \
 join eqi_grouptarif_tbl as tgr on (tgr.id=tar.id_grouptarif) \
 join eqi_classtarif_tbl as tcl on (tcl.id=tar.id_classtarif) \
 join eqi_meter_tbl as m on (z.id_type_meter=m.id) \
 where (tgr.ident not like 'tgr9%') \
 and z.mmgg = :pmmgg \
  group by clm.code, clm.short_name, tgr.short_name, tcl.name, z.id_point \
) as ss \
  left join ( select bs.id_point, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.5 THEN bs.demand_val ELSE 0 END::::numeric/1000) as demand2_old, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.85 THEN bs.demand_val ELSE 0 END::::numeric/1000) as demand2_new, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.5 THEN bs.sum_val ELSE 0 END) as sum2_old, \
	sum(CASE WHEN bs.id_zone=5 and z.koef = 1.85 THEN bs.sum_val ELSE 0 END) as sum2_new \
	from acd_billsum_tbl as bs \
	join acm_bill_tbl as bm using (id_doc) \
	join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
	where bs.id_zone in (4,5) and bs.kind_energy=1 \
        and  bs.mmgg = :pmmgg \
        group by bs.id_point ) as bill on (bill.id_point  = ss.id_point) \
  group by ss.code, ss.short_name, ss.tgr_name, ss.class, ss.tarif  \
  order by ss.code;";


  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
//  ZQXLRepsSum->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  if ((year1 = 2014)&&(month1==12))
     xlReport->XLSTemplate = "XL\\tar_2zon_12_2014.xls";
  else
     xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;


  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

//  Dsr = xlReport->DataSources->Add();
//  Dsr->DataSet = ZQXLRepsSum;
//  Dsr->Alias =  "ZQXLRepsSum";
//  Dsr->Range = "range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "range";
//  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

//  AnsiString caption = "Абоненти, що мають нульове споживання.";
//  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();
// ZQXLRepsSum->Close();

// ZQXLReps->MasterSource=NULL;
// ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------

void TfReports::PrintLost_NoLost(TDateTime mmgg)
{
  ZQXLReps->Sql->Clear();

/*  ОСА - Церкви не попадали в структуру а должны
  sum(CASE WHEN  v.voltage_max<=160 and v.voltage_min>=110 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%') and (ts.ident not like 'tgr8_6%') then kvt ELSE 0 END)  as fl110, \
  sum(CASE WHEN  v.voltage_max<=35 and v.voltage_min>=27 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%') and (ts.ident not like 'tgr8_6%')then kvt ELSE 0 END)  as fl35, \
  sum(CASE WHEN  v.voltage_max<=10 and v.voltage_min>=3 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%') and (ts.ident not like 'tgr8_6%') then kvt ELSE 0 END)  as fl10, \
  sum(CASE WHEN  v.voltage_min<1 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%') and (ts.ident not like 'tgr8_6%') then kvt ELSE 0 END)  as fl04, \

 */
  AnsiString sqlstr = " select \
  sum(CASE WHEN lost = 1 and v.voltage_max<=160 and v.voltage_min>=110  then kvt ELSE 0 END)  as l110, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=160 and v.voltage_min>=110  then kvt ELSE 0 END)  as nl110, \
  sum(CASE WHEN lost = 1 and v.voltage_max<=35 and v.voltage_min>=27  then kvt ELSE 0 END)  as l35, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=35 and v.voltage_min>=27  then kvt ELSE 0 END)  as nl35, \
  sum(CASE WHEN lost = 1 and v.voltage_max<=10 and v.voltage_min>=3  then kvt ELSE 0 END)  as l10, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=10 and v.voltage_min>=3  then kvt ELSE 0 END)  as nl10, \
  sum(CASE WHEN lost = 1 and v.voltage_min<1 then kvt ELSE 0 END)  as l04, \
  sum(CASE WHEN lost = 0 and v.voltage_min<1 then kvt ELSE 0 END)  as nl04, \
  sum(CASE WHEN  v.voltage_max<=160 and v.voltage_min>=110 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%')  then kvt ELSE 0 END)  as fl110, \
  sum(CASE WHEN  v.voltage_max<=35 and v.voltage_min>=27 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%') then kvt ELSE 0 END)  as fl35, \
  sum(CASE WHEN  v.voltage_max<=10 and v.voltage_min>=3 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%')  then kvt ELSE 0 END)  as fl10, \
  sum(CASE WHEN  v.voltage_min<1 and (ts.ident like 'tgr7%' or ts.ident like 'tgr8%')  then kvt ELSE 0 END)  as fl04, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=160 and v.voltage_min>=110 and ts.id_section = 217 then kvt ELSE 0 END)  as nltve110, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=35 and v.voltage_min>=27 and ts.id_section = 217 then kvt ELSE 0 END)  as nltve35, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=10 and v.voltage_min>=3 and ts.id_section = 217 then kvt ELSE 0 END)  as nltve10, \
  sum(CASE WHEN lost = 0 and v.voltage_min<1 and ts.id_section = 217 then kvt ELSE 0 END)  as nltve04, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=160 and v.voltage_min>=110 and ts.id_section = 209 then kvt ELSE 0 END)  as nltr110, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=35 and v.voltage_min>=27 and ts.id_section = 209 then kvt ELSE 0 END)  as nltr35, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=10 and v.voltage_min>=3 and ts.id_section = 209 then kvt ELSE 0 END)  as nltr10, \
  sum(CASE WHEN lost = 0 and v.voltage_min<1 and ts.id_section = 209 then kvt ELSE 0 END)  as nltr04, \
  sum(CASE WHEN lost = 1 and v.voltage_max<=160 and v.voltage_min>=110 and ts.id_section = 209 then kvt ELSE 0 END)  as ltr110, \
  sum(CASE WHEN lost = 1 and v.voltage_max<=35 and v.voltage_min>=27 and ts.id_section = 209 then kvt ELSE 0 END)  as ltr35, \
  sum(CASE WHEN lost = 1 and v.voltage_max<=10 and v.voltage_min>=3 and ts.id_section = 209 then kvt ELSE 0 END)  as ltr10, \
  sum(CASE WHEN lost = 1 and v.voltage_min<1 and ts.id_section = 209 then kvt ELSE 0 END)  as ltr04, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=160 and v.voltage_min>=110 and id_client = 2154 and id_point = 265559 then kvt ELSE 0 END)  as ees110, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=35 and v.voltage_min>=27 and id_client = 2154 and id_point = 265559 then kvt ELSE 0 END)  as ees35, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=10 and v.voltage_min>=3 and id_client = 2154 and id_point = 265559 then kvt ELSE 0 END)  as ees10, \
  sum(CASE WHEN lost = 0 and v.voltage_min<1 and id_client = 2154 and id_point = 265559 then kvt ELSE 0 END) as ees04, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=160 and v.voltage_min>=110 and ts.id_extra = 1014 then kvt ELSE 0 END)  as tec110, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=35 and v.voltage_min>=27 and ts.id_extra = 1014 then kvt ELSE 0 END)  as tec35, \
  sum(CASE WHEN lost = 0 and v.voltage_max<=10 and v.voltage_min>=3 and ts.id_extra = 1014 then kvt ELSE 0 END)  as tec10, \
  sum(CASE WHEN lost = 0 and v.voltage_min<1 and ts.id_extra = 1014 then kvt ELSE 0 END)  as tec04 \
  from  ( select b.id_client,bs.id_point,ph.id_extra,tgr.ident, ph.id_voltage, stcl.id_section, coalesce(ph.lost_nolost,0) as lost, sum(bs.demand_val) as kvt \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  where b.mmgg = :mmgg \
  and cl.idk_work <> 0 \
  and ( ( (b.id_pref = 10) and (b.idk_doc<>280)  ) or (b.id_pref=101) ) and cl.book = -1 \
  and bs.id_tariff not in ( 900002, 900001, 999999) \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  group by b.id_client,bs.id_point,ph.id_extra,ph.id_voltage, lost, tgr.ident, stcl.id_section )as ts  \
  left join eqk_voltage_tbl as v on (v.id = ts.id_voltage);";


  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

  ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintReact_F32(TDateTime mmgg)
{
  ZQXLReps->Sql->Clear();

  //временные таблици для выбора тарифов то точкам учета

  AnsiString  sqlstr=" delete from  rep_point_tarif_tmp ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
  {
    ZQReps->ExecSql();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }

  sqlstr=" insert into rep_point_tarif_tmp \
   select distinct p2.code_eqp, p2.id_tarif from eqm_point_h as p2 \
   join (select code_eqp, max(dt_b) as maxdt from eqm_point_h  where dt_b <= ( :mmgg::::date+'1 month'::::interval)::::date \
   group by code_eqp order by code_eqp ) as p3 \
   on  (p3.maxdt = p2.dt_b and p3.code_eqp = p2.code_eqp); ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQReps->ExecSql();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }

  sqlstr=" delete from  rep_point_tarif_year_tmp ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
  {
    ZQReps->ExecSql();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }

  sqlstr=" insert into rep_point_tarif_year_tmp \
  select distinct b.id_doc, bs.id, ph.code_eqp, ph.id_tarif \
  from ( select * from acm_bill_tbl where id_pref=20 \
  and date_part('year', :mmgg::::date) = date_part('year', mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', mmgg) \
  order by id_doc ) as b \
 join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
 join eqm_point_h as ph on (bs.id_point = ph.code_eqp) \
  where  ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.reg_date,p2.dt_b) ) ; ";

//  where  ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQReps->ExecSql();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }

  //только потребление РЕ

  AnsiString  sqlstr1=" select tgr.name as tarifname , tgr.ident,\
  coalesce(round(demand_tcl1::::numeric/1000,2),0)::::numeric as demand_tcl1,coalesce(round(sum_tcl1/1000,2),0) as sum_tcl1, \
  coalesce(round(demand_tcl2::::numeric/1000,2),0)::::numeric as demand_tcl2,coalesce(round(sum_tcl2/1000,2),0) as sum_tcl2, \
  coalesce(round(yeardemand_tcl1::::numeric/1000,2),0)::::numeric as yeardemand_tcl1,coalesce(round(yearsum_tcl1/1000,2),0) as yearsum_tcl1, \
  coalesce(round(yeardemand_tcl2::::numeric/1000,2),0)::::numeric as yeardemand_tcl2,coalesce(round(yearsum_tcl2/1000,2),0) as yearsum_tcl2 \
  from ( \
  ( select tgr.id as id_tgr, \
   sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end ) as demand_tcl1, \
   sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end ) as demand_tcl2, \
   sum(case when tcl.ident='tcl1' then bs.sum_val else 0 end ) as sum_tcl1, \
   sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end ) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_tmp as ph  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where bs.kind_energy=2  \
  and b.id_pref=20 and cl.book = -1 \
  and coalesce(stcl.id_section,0) <> 209 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  group by tgr.id  ) as mtcl \
   full outer join \
  ( select tgr.id as id_tgr,  \
  sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end ) as yeardemand_tcl1, \
  sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end ) as yeardemand_tcl2, \
  sum(case when tcl.ident='tcl1' then bs.sum_val else 0 end ) as yearsum_tcl1, \
  sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end ) as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_year_tmp as ph  on (bs.id_point = ph.code_eqp and ph.id_doc = b.id_doc and bs.id = ph.id_billsum) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where bs.kind_energy=2  \
  and b.id_pref=20 and cl.book = -1 \
  and coalesce(stcl.id_section,0) <> 209 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
   and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= b.mmgg ) \
  group by tgr.id  ) as ytcl using (id_tgr) \
  ) as tcl \
  join eqi_grouptarif_tbl as tgr on (tgr.id = tcl.id_tgr) \
  union \
select 'Транзит','tgrt',st1.*,st2.* from \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_tmp as ph  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where bs.kind_energy=2 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.id_section = 209 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
) as st1  \
right join \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_year_tmp as ph  on (bs.id_point = ph.code_eqp and ph.id_doc = b.id_doc and bs.id = ph.id_billsum) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where bs.kind_energy=2 \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= b.mmgg ) \
  and stcl.id_section = 209 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
) as st2 on (1=1)  order by ident;";


/*
  AnsiString  sqlstr=" select tgr.name as tarifname , tgr.ident,\
  coalesce(round(demand_tcl1::::numeric/1000,2),0)::::numeric as demand_tcl1,coalesce(round(sum_tcl1/1000,2),0) as sum_tcl1, \
  coalesce(round(demand_tcl2::::numeric/1000,2),0)::::numeric as demand_tcl2,coalesce(round(sum_tcl2/1000,2),0) as sum_tcl2, \
  coalesce(round(yeardemand_tcl1::::numeric/1000,2),0)::::numeric as yeardemand_tcl1,coalesce(round(yearsum_tcl1/1000,2),0) as yearsum_tcl1, \
  coalesce(round(yeardemand_tcl2::::numeric/1000,2),0)::::numeric as yeardemand_tcl2,coalesce(round(yearsum_tcl2/1000,2),0) as yearsum_tcl2 \
  from ( \
  ( select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl1' and bs.kind_energy=2  \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
  group by tgr.id  ) as tcl1 \
  full outer join \
 ( select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp ) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl2' and bs.kind_energy=2  \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
  group by tgr.id) as tcl2 using (id_tgr) \
   full outer join \
  ( select tgr.id as id_tgr, sum(bs.demand_val) as yeardemand_tcl1, round(sum(bs.sum_val),2) as yearsum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join eqm_point_h as ph on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl1' and bs.kind_energy=2  \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and b.id_pref=20 and cl.book = -1 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
  group by tgr.id  ) as ytcl1 using (id_tgr) \
   full outer join \
 ( select tgr.id as id_tgr, sum(bs.demand_val) as yeardemand_tcl2,round(sum(bs.sum_val),2) as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join eqm_point_h as ph on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl2' and bs.kind_energy=2  \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
  group by tgr.id) as ytcl2 using (id_tgr) \
  ) as tcl \
  right join eqi_grouptarif_tbl as tgr on (tgr.id = tcl.id_tgr) \
  where ident not like 'tgr9%' and ident not like 'tgr8%' and ident not like 'tgr7%' and ident not like 'tgr_pwr' \
  union \
select 'Транзит','tgrt',st1.*,st2.* from \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp ) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where bs.kind_energy=2 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.id_section = 209 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
) as st1  \
right join \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp ) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where bs.kind_energy=2 \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and stcl.id_section = 209 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
) as st2 on (1=1)  order by ident;";
*/
//     where tcl.ident='tcl1' and bs.kind_energy=2 and bs.sum_val <>0 \


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  // потребление РЕ + генерация РЕ
  AnsiString  sqlstr2=" select tgr.name as tarifname , tgr.ident,\
  coalesce(round(demand_tcl1::::numeric/1000,2),0)::::numeric as demand_tcl1,coalesce(round(sum_tcl1/1000,2),0) as sum_tcl1, \
  coalesce(round(demand_tcl2::::numeric/1000,2),0)::::numeric as demand_tcl2,coalesce(round(sum_tcl2/1000,2),0) as sum_tcl2, \
  coalesce(round(yeardemand_tcl1::::numeric/1000,2),0)::::numeric as yeardemand_tcl1,coalesce(round(yearsum_tcl1/1000,2),0) as yearsum_tcl1, \
  coalesce(round(yeardemand_tcl2::::numeric/1000,2),0)::::numeric as yeardemand_tcl2,coalesce(round(yearsum_tcl2/1000,2),0) as yearsum_tcl2 \
  from ( \
  ( select tgr.id as id_tgr, \
   sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end ) as demand_tcl1, \
   sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end ) as demand_tcl2, \
   sum(case when tcl.ident='tcl1' then bs.sum_val else 0 end ) as sum_tcl1, \
   sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end ) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_tmp as ph  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where b.id_pref=20 and cl.book = -1 \
  and coalesce(stcl.id_section,0) <> 209 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
  group by tgr.id  ) as mtcl \
   full outer join \
  ( select tgr.id as id_tgr,  \
  sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end ) as yeardemand_tcl1, \
  sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end ) as yeardemand_tcl2, \
  sum(case when tcl.ident='tcl1' then bs.sum_val else 0 end ) as yearsum_tcl1, \
  sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end ) as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_year_tmp as ph  on (bs.id_point = ph.code_eqp and ph.id_doc = b.id_doc and bs.id = ph.id_billsum) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where b.id_pref=20 and cl.book = -1 \
  and coalesce(stcl.id_section,0) <> 209 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= b.mmgg ) \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
  group by tgr.id  ) as ytcl using (id_tgr) \
  ) as tcl \
  join eqi_grouptarif_tbl as tgr on (tgr.id = tcl.id_tgr) \
  union \
select 'Транзит','tgrt',st1.*,st2.* from \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_tmp as ph  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and b.id_pref=20 and cl.book = -1 \
  and stcl.id_section = 209 \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
) as st1  \
right join \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join rep_point_tarif_year_tmp as ph  on (bs.id_point = ph.code_eqp and ph.id_doc = b.id_doc and bs.id = ph.id_billsum) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where b.id_pref=20 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= b.mmgg ) \
  and stcl.id_section = 209 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
) as st2 on (1=1)  order by ident;";


//  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
//  where ident not like 'tgr9%' and ident not like 'tgr7%' and ident not like 'tgr_pwr' \




/*
  AnsiString  sqlstr2=" select tgr.name as tarifname , tgr.ident, \
  coalesce(round(demand_tcl1::::numeric/1000,2),0)::::numeric as demand_tcl1,coalesce(round(sum_tcl1/1000,2),0) as sum_tcl1, \
  coalesce(round(demand_tcl2::::numeric/1000,2),0)::::numeric as demand_tcl2,coalesce(round(sum_tcl2/1000,2),0) as sum_tcl2, \
  coalesce(round(yeardemand_tcl1::::numeric/1000,2),0)::::numeric as yeardemand_tcl1,coalesce(round(yearsum_tcl1/1000,2),0) as yearsum_tcl1, \
  coalesce(round(yeardemand_tcl2::::numeric/1000,2),0)::::numeric as yeardemand_tcl2,coalesce(round(yearsum_tcl2/1000,2),0) as yearsum_tcl2 \
  from ( \
  (  select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl1, round(sum(bs.sum_val),2) as sum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp ) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl1'  \
  and b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b.mmgg) \
  group by tgr.id  ) as tcl1 \
  full outer join \
 ( select tgr.id as id_tgr, sum(bs.demand_val) as demand_tcl2,round(sum(bs.sum_val),2) as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl2'  \
  and b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b.mmgg) \
  group by tgr.id) as tcl2 using (id_tgr) \
   full outer join \
  ( select tgr.id as id_tgr, sum(bs.demand_val) as yeardemand_tcl1, round(sum(bs.sum_val),2) as yearsum_tcl1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join eqm_point_h as ph on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl1'   \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and b.id_pref=20 and cl.book = -1 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
  group by tgr.id  ) as ytcl1 using (id_tgr) \
  full outer join \
 ( select tgr.id as id_tgr, sum(bs.demand_val) as yeardemand_tcl2,round(sum(bs.sum_val),2) as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join eqm_point_h as ph on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tcl.ident='tcl2'   \
  and b.id_pref=20 and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
  group by tgr.id) as ytcl2 using (id_tgr) \
  ) as tcl \
  right join eqi_grouptarif_tbl as tgr on (tgr.id = tcl.id_tgr) \
  where ident not like 'tgr9%' and ident not like 'tgr8%' and ident not like 'tgr7%' \
  union \
select 'Транзит','tgrt',st1.*,st2.* from \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric /1000,2)::::numeric as sum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as demand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as sum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp ) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where b.id_pref=20 and cl.book = -1 \
  and stcl.id_section = 209 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and date_trunc('month', :mmgg::::date) =  b.mmgg \
) as st1  \
right join \
(select round(sum(case when tcl.ident='tcl1' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl1, \
 round(sum (case when tcl.ident='tcl1' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl1, \
 round(sum(case when tcl.ident='tcl2' then bs.demand_val else 0 end )::::numeric/1000,2)::::numeric as yeardemand_tcl2, \
 round(sum(case when tcl.ident='tcl2' then bs.sum_val else 0 end )::::numeric/1000,2)::::numeric as yearsum_tcl2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join clm_statecl_h as stcl on (stcl.id_client=b.id_client) \
  join (select p2.code_eqp, p2.id_tarif from eqm_point_h as p2 where p2.dt_b = (select max(p3.dt_b) from eqm_point_h as p3 where p3.code_eqp = p2.code_eqp) order by code_eqp) as ph \
  on (bs.id_point = ph.code_eqp) \
  join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where b.id_pref=20 and cl.book = -1 \
  and stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and stcl.id_section = 209 \
  and date_part('year', :mmgg::::date) = date_part('year', b.mmgg) and  date_part('month', :mmgg::::date) >= date_part('month', b.mmgg) \
) as st2 on (1=1)  order by ident;";
*/

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
}
//---------------------------------------------------------------------------

void TfReports::PrintF49(TDateTime mmgg)
{
  ZQXLReps->Sql->Clear();

  AnsiString sqlstr = " select * from  ( select \
  round(sum (CASE WHEN bs.kind_energy=2 THEN bs.demand_val ELSE 0 END)::::numeric/1000,2) as demand_re, \
  round(sum (CASE WHEN bs.kind_energy=4 THEN bs.demand_val ELSE 0 END)::::numeric/1000,2) as demand_ge, \
  round(sum (CASE WHEN bs.kind_energy=2 THEN bs.sum_val ELSE 0 END)/1000,2) as sum_re, \
  round(sum (CASE WHEN bs.kind_energy=4 THEN bs.sum_val ELSE 0 END)/1000,2) as sum_ge, \
  round(sum (p1*k_corr/1000),2) as p1, round((sum(bs.sum_val) - sum(round(p1*k_corr,2)))/1000,2) as p2, \
  count(distinct b.id_client) as r_count \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  where b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b.mmgg) \
  and ( bs.demand_val <> 0 or bs.sum_val<>0) \
  ) as s1 left join \
  (select round(sum(p.value)/1000,2) as pay from acm_pay_tbl as p  where p.id_pref=20 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', p.mmgg) and sign_pay = 1 \
  ) as pp on (1=1) \
  left join \
  ( select round(sum(fact_losts)::::numeric/1000,2) as losts from acm_bill_tbl as b2 join acd_pwr_demand_tbl as pd on (pd.id_doc = b2.id_doc) \
    where b2.id_pref=20 and fact_losts >0 and date_trunc('month', :mmgg::::date) = date_trunc('month', b2.mmgg) \
  ) as ll on (1=1) ";


  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  ZQXLReps2->Sql->Clear();

  AnsiString sqlstr2 = " select * from  ( select \
  round(sum (CASE WHEN bs.kind_energy=2 THEN bs.demand_val ELSE 0 END)::::numeric/1000,2) as demand_re, \
  round(sum (CASE WHEN bs.kind_energy=4 THEN bs.demand_val ELSE 0 END)::::numeric/1000,2) as demand_ge, \
  round(sum (CASE WHEN bs.kind_energy=2 THEN bs.sum_val ELSE 0 END)/1000,2) as sum_re, \
  round(sum (CASE WHEN bs.kind_energy=4 THEN bs.sum_val ELSE 0 END)/1000,2) as sum_ge, \
  round(sum (p1*k_corr/1000),2) as p1, round((sum(bs.sum_val) - sum(round(p1*k_corr,2)))/1000,2) as p2, \
  count(distinct b.id_client) as r_count \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  where b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b.mmgg) \
  and ( bs.demand_val <> 0 or bs.sum_val<>0) \
  and b.id_client not in (select distinct id_client from acm_bill_tbl where id_pref=20 and date_trunc('year', :mmgg::::date) > date_trunc('year', mmgg)) \
  ) as s1 left join \
  (select round(sum(p.value)/1000,2) as pay from acm_pay_tbl as p  where p.id_pref=20 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', p.mmgg) and sign_pay = 1 \
  and p.id_client not in (select distinct id_client from acm_bill_tbl where id_pref=20 and date_trunc('year', :mmgg::::date) > date_trunc('year', mmgg)) \
  ) as pp on (1=1) \
  left join \
  ( select round(sum(fact_losts)::::numeric/1000,2) as losts from acm_bill_tbl as b2 join acd_pwr_demand_tbl as pd on (pd.id_doc = b2.id_doc) \
    where b2.id_pref=20 and fact_losts >0 and date_trunc('month', :mmgg::::date) = date_trunc('month', b2.mmgg) \
    and b2.id_client not in (select distinct id_client from acm_bill_tbl where id_pref=20 and date_trunc('year', :mmgg::::date) > date_trunc('year', mmgg)) \
  ) as ll on (1=1) ";


  ZQXLReps2->Sql->Add(sqlstr2);

  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yyyy",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();  
}
//---------------------------------------------------------------------------
void TfReports::PrintRCompens(TDateTime mmgg)
{

  AnsiString sqlstr;

  sqlstr=" select seb_all( 0, date_trunc('month', :mmgg::::date)::::date)";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQReps->ExecSql();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  ZQXLReps->Sql->Clear();

  sqlstr = " select sss.*, s1.*, (b1.sum_tax - s1.sum_ge_tax) as sum_re_tax from \
  (select sum(opl_ze) as pay, sum(opl_zpdv) as pay_tax, \
  -sum(deb_zpme) as debb, -sum(deb_zpmpdv) as debb_tax, sum(kr_zpme) as ktb,sum(kr_zpmpdv) as ktb_tax, \
   sum(kr_zkme) as kte,sum(kr_zkmpdv) as kte_tax \
  from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
  where obr.period = :mmgg and obr.id_pref = 20 and obr.idk_work not in (0,99) )as sss \
  left join  ( select \
  sum (CASE WHEN bs.kind_energy=2 THEN bs.demand_val ELSE 0 END) as demand_re, \
  sum (CASE WHEN bs.kind_energy=4 THEN bs.demand_val ELSE 0 END) as demand_ge, \
  sum (CASE WHEN bs.kind_energy=2 THEN bs.sum_val ELSE 0 END) as sum_re, \
  sum (CASE WHEN bs.kind_energy=4 THEN bs.sum_val ELSE 0 END) as sum_ge, \
  round(sum (CASE WHEN bs.kind_energy=4 THEN bs.sum_val ELSE 0 END)*0.2,2) as sum_ge_tax \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  where b.id_pref=20 and cl.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b.mmgg) \
  ) as s1 on (1=1) \
  left join \
  (select sum(b2.value_tax) as sum_tax \
  from acm_bill_tbl as b2 \
  join clm_client_tbl as cl2 on (cl2.id = b2.id_client) \
  where b2.id_pref=20 and cl2.book = -1 \
  and date_trunc('month', :mmgg::::date) = date_trunc('month', b2.mmgg) ) as b1 on (1=1); ";

  /*--  and cl.idk_work not in (0,99) \*/
  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yyyy",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

  ZQXLReps->Close();

}
//------------------------------------------------------------------------------------
void __fastcall TfReports::btFileClick(TObject *Sender)
{

  AnsiString sqlstr;

  ZQReps->Close();
  ZQReps->Sql->Clear();

  if ((PTRepData(CurReport->Data))->ident == "NDS2011")
  {
    sqlstr=" select rep_file_nds_fun(date_trunc('month', :mmgg::::date)::::date, :pref)";
    ZQReps->Sql->Add(sqlstr);
    if (cbKindEnergy->ItemIndex==0)
    {
      ZQReps->ParamByName("pref")->AsInteger=10;
    }
    else
    {
      ZQReps->ParamByName("pref")->AsInteger=20;
    }
  }

  if ((PTRepData(CurReport->Data))->ident == "f32")
  {
    sqlstr=" select  rep_file_f32_fun( date_trunc('month', :mmgg::::date)::::date)";
    ZQReps->Sql->Add(sqlstr);
  }

  if ((PTRepData(CurReport->Data))->ident == "4nkre")
  {
    if (dtBegin->Date < TDateTime(2012,10,1))
    {
      sqlstr=" select  rep_4nkre_fun( date_trunc('month', :mmgg::::date)::::date, 1)";
    }
    else
    {
      sqlstr=" select  rep_4nkre2012_fun( date_trunc('month', :mmgg::::date)::::date, 1)";
    }

    ZQReps->Sql->Add(sqlstr);
  }

  if ((PTRepData(CurReport->Data))->ident == "lost_nolost")
  {
    sqlstr=" select  rep_lost_fun( date_trunc('month', :mmgg::::date)::::date, 1)";
    ZQReps->Sql->Add(sqlstr);
  }

  if ((PTRepData(CurReport->Data))->ident == "abon_volt_lst")
  {
    sqlstr=" select  abon_lost_fun( date_trunc('month', :mmgg::::date)::::date)";
    ZQReps->Sql->Add(sqlstr);
  }


  ZQReps->ParamByName("mmgg")->AsDateTime=dtBegin->Date;


  try
  {
    ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }
  ShowMessage("Информация выгружена в файл успешно (в папку /home/local/seb/ на сервере).");
}
//---------------------------------------------------------------------------
void TfReports::ObSaldo_5kr(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

//  Word year2;
//  Word month2;
//  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
//  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }


  // по потребителям
  AnsiString  sqlstr1=" select obr.osob_r as code,obr.osob_rsk as abon_name, \
     nar, nar_v,opl_zv, -deb_zpmv as deb_b, kr_zpmv as kt_b, \
     -deb_kmv as deb_e,kr_zkmv as kt_e \
     from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client)  \
     where obr.period = :mmgg and obr.idk_work not in (0,99) and obr.id_pref = :pref order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  if (kind_energy==2)
    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)
    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)
    ZQXLReps->ParamByName("pref")->AsInteger=524;


//  ZQXLReps->MasterSource=DSRep;
//  ZQXLReps->LinkFields="link = link";

  try
  {
//    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
//  Dsr->DataSet = ZQXLRepsSum;
//  Dsr->Alias =  "ZQXLRepsSum";
//  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
//  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
//  Param->Name="lyear";
//  Param=xlReport->Params->Add();
  Param->Name="lcaption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
//  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);

  if (kind_energy==2)
    xlReport->ParamByName["lcaption"]->Value = "(2КР потужності)";
  if (kind_energy==3)
    xlReport->ParamByName["lcaption"]->Value = "(2КР споживання)";
  if (kind_energy==4)
    xlReport->ParamByName["lcaption"]->Value = "(2КР споживання 2014)";

  xlReport->Report();


  ZQXLReps->Close();
// ZQXLRepsSum->Close();

// ZQXLReps->MasterSource=NULL;
// ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonLost(TDateTime mmgg1,TDateTime mmgg2,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(mmgg1,year1,month1,day1);
  DecodeDate(mmgg2,year2,month2,day2);

  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , bs.id_point, name_eqp, num_eqp,\
  sum(dem) as dem , sum(kvt) as kvt  , coalesce(id_voltage,0)+coalesce(lost_nolost,0)*1000 as link, \
  tgr.short_name as tar_name, cla.name as grp_name, bb.inf \
  from clm_client_tbl as cl \
  join clm_statecl_tbl as stcl on (stcl.id_client = cl.id ) \
  join cla_param_tbl as cla on (stcl.id_section = cla.id) \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join (select id_point, id_doc, id_tariff, demand_val as kvt,sum_val as dem, dt_end \
   from acd_billsum_tbl where id_tariff not in ( 900002, 900001, 999999) order by id_point, id_doc )as bs on ( bs.id_doc = b.id_doc ) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg >= date_trunc('month', :mmgg1::::date) and mmgg <= date_trunc('month', :mmgg2::::date) and kind_energy = :energy \
    group by id_point,id_doc) as kz \
  on (kz.id_point = bs.id_point and kz.id_doc = bs.id_doc ) \
  left join eqm_eqp_tree_tbl as tt on (tt.code_eqp = bs.id_point ) \
  left join eqm_tree_tbl as t on (t.id = tt.id_tree ) \
  left join eqm_borders_tbl as bb on (bb.code_eqp = t.code_eqp ) \
  where b.mmgg >= date_trunc('month', :mmgg1::::date) and\
  b.mmgg <= date_trunc('month', :mmgg2::::date) \
  and ( ( (b.id_pref = :pref) and (b.idk_doc<>:no_idk_doc)  ) or (b.id_pref=:add_pref) )  \
  and cl.book = -1 \
  and cl.idk_work <> 0  \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and (bs.dem <>0 or bs.kvt <>0 ) \
  group by bs.id_point, name_eqp, num_eqp,id_voltage,lost_nolost,cl.id, cl.code, cl.short_name,tgr.short_name , cla.name, bb.inf  \
  order by id_voltage desc , cl.code ; ";


  AnsiString  sqlstr11=" select cl.id, cl.code, cl.short_name , bs.id_point, name_eqp, num_eqp,\
  sum(dem) as dem , sum(kvt) as kvt  , coalesce(id_voltage,0)+coalesce(lost_nolost,0)*1000 as link, \
  tgr.short_name as tar_name, cla.name as grp_name, bb.inf \
  from clm_client_tbl as cl \
  join clm_statecl_tbl as stcl on (stcl.id_client = cl.id ) \
  join cla_param_tbl as cla on (stcl.id_section = cla.id) \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join (select id_point, id_doc, id_tariff, demand_val as kvt,sum_val as dem, dt_end \
   from acd_billsum_tbl where id_tariff not in ( 900002, 900001, 999999) order by id_point, id_doc )as bs on ( bs.id_doc = b.id_doc ) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg >= date_trunc('month', :mmgg1::::date) and mmgg <= date_trunc('month', :mmgg2::::date) and kind_energy = :energy \
    group by id_point,id_doc) as kz \
 on (kz.id_point = bs.id_point and kz.id_doc = bs.id_doc ) \
  left join eqm_eqp_tree_tbl as tt on (tt.code_eqp = bs.id_point ) \
  left join eqm_tree_tbl as t on (t.id = tt.id_tree ) \
  left join eqm_borders_tbl as bb on (bb.code_eqp = t.code_eqp ) \
  where b.mmgg >= date_trunc('month', :mmgg1::::date) and (tgr.ident like 'tgr7%' or tgr.ident like 'tgr8%') \
  and b.mmgg <= date_trunc('month', :mmgg2::::date) \
  and ( ( (b.id_pref = :pref) and (b.idk_doc<>:no_idk_doc)  ) or (b.id_pref=:add_pref) )  \
  and cl.book = -1  \
  and cl.idk_work <> 0 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and (bs.dem <>0 or bs.kvt <>0 ) \
  group by bs.id_point, name_eqp, num_eqp,id_voltage,lost_nolost,cl.id, cl.code, cl.short_name,tgr.short_name , cla.name, bb.inf  \
  order by id_voltage desc , cl.code ; ";


/*
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , id_point, name_eqp, num_eqp,\
  sum(dem) as dem , sum(kvt) as kvt  , coalesce(id_voltage,0)+coalesce(lost_nolost,0)*1000 as link \
  from clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join (select id_point, id_doc, sum(demand_val) as kvt,sum(sum_val) as dem, max(dt_end) as dt_end \
   from acd_billsum_tbl where id_tariff not in ( 900002, 900001, 999999) group by id_point, id_doc )as bs using ( id_doc) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg >= date_trunc('month', :mmgg1::::date) and mmgg <= date_trunc('month', :mmgg2::::date) and kind_energy = :energy \
    group by id_point,id_doc) as kz \
  using (id_point,id_doc) \
  where b.mmgg >= date_trunc('month', :mmgg1::::date) and b.mmgg <= date_trunc('month', :mmgg2::::date) and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and (bs.dem <>0 or bs.kvt <>0 ) \
  group by id_point, name_eqp, num_eqp,id_voltage,lost_nolost,cl.id, cl.code, cl.short_name \
  order by id_voltage desc , cl.code ; ";
*/

  ZQXLReps->Sql->Clear();
  if(cbLNLAll->Checked)
    ZQXLReps->Sql->Add(sqlstr1);
  else
    ZQXLReps->Sql->Add(sqlstr11);

  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
    ZQXLReps->ParamByName("add_pref")->AsInteger=101;
    ZQXLReps->ParamByName("no_idk_doc")->AsInteger=280;
    ZQXLReps->ParamByName("energy")->AsInteger=1;

   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
    ZQXLReps->ParamByName("add_pref")->AsInteger=201;
    ZQXLReps->ParamByName("no_idk_doc")->AsInteger=280;
    ZQXLReps->ParamByName("energy")->AsInteger=2;

   }

  // по категориям
  AnsiString  sqlstr2=" select coalesce(ts.id_voltage,0)+coalesce(ts.lost,0)*1000 as link,\
  coalesce(voltage_min::::varchar, 'Не відомий') as voltage, \
  CASE WHEN ts.lost  = 1 THEN 'Втратний' ELSE 'Безвтратний' END as lost_text, dem, kvt  \
  from  (select ph.id_voltage,coalesce(ph.lost_nolost,0)as lost, sum(bs.demand_val) as kvt,sum(bs.sum_val) as dem \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  where b.mmgg >= date_trunc('month', :mmgg1::::date) and b.mmgg <= date_trunc('month', :mmgg2::::date) \
    and ( ( (b.id_pref = :pref) and (b.idk_doc<>:no_idk_doc)  ) or (b.id_pref=:add_pref) )   \
  and cl.book = -1  and cl.idk_work <> 0 \
  and  bs.id_tariff not in ( 900002, 900001, 999999) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  group by ph.id_voltage,lost )as ts  \
  left join eqk_voltage_tbl as v on (v.id = ts.id_voltage) \
  order by ts.lost, v.voltage_min desc;";

  AnsiString  sqlstr22=" select coalesce(ts.id_voltage,0)+coalesce(ts.lost,0)*1000 as link,\
  coalesce(voltage_min::::varchar, 'Не відомий') as voltage, \
  CASE WHEN ts.lost  = 1 THEN 'Втратний' ELSE 'Безвтратний' END as lost_text, dem, kvt  \
  from  (select ph.id_voltage,coalesce(ph.lost_nolost,0)as lost, sum(bs.demand_val) as kvt,sum(bs.sum_val) as dem \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where b.mmgg >= date_trunc('month', :mmgg1::::date) and b.mmgg <= date_trunc('month', :mmgg2::::date) \
    and ( ( (b.id_pref = :pref) and (b.idk_doc<>:no_idk_doc)  ) or (b.id_pref=:add_pref) )   \
  and cl.book = -1   and cl.idk_work <> 0 \
  and (tgr.ident like 'tgr7%' or tgr.ident like 'tgr8%') \
  and bs.id_tariff not in ( 900002, 900001, 999999) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  group by ph.id_voltage,lost )as ts  \
  left join eqk_voltage_tbl as v on (v.id = ts.id_voltage) \
  order by ts.lost, v.voltage_min desc;";

  ZQXLRepsSum->Sql->Clear();

  if(cbLNLAll->Checked)
    ZQXLRepsSum->Sql->Add(sqlstr2);
  else
    ZQXLRepsSum->Sql->Add(sqlstr22);

  ZQXLRepsSum->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLRepsSum->ParamByName("mmgg2")->AsDateTime=mmgg2;

  if (kind_energy==0) {
     ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
     ZQXLRepsSum->ParamByName("add_pref")->AsInteger=101;
     ZQXLRepsSum->ParamByName("no_idk_doc")->AsInteger=280;
   };
  if (kind_energy==1)
   {
     ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
     ZQXLRepsSum->ParamByName("add_pref")->AsInteger=201;
     ZQXLRepsSum->ParamByName("no_idk_doc")->AsInteger=280;
   };

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
   ZQXLRepsSum->Open();
   ZQXLReps->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="caption2";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  if ((year1 ==year2)&&(month1==month2))
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);
  else
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date)+" - "+
          FormatDateTime("mmmm yyyy",dtEnd->Date);


  if (kind_energy==0){
    if(cbLNLAll->Checked)
      xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по структурi корисного вiдпуску.";
    else
      xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по структурi корисного вiдпуску (Населення і населені пункти).";
    }
  if (kind_energy==1){
    if(cbLNLAll->Checked)
      xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по структурi корисного вiдпуску.";
    else
      xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по структурi корисного вiдпуску (Населення і населені пункти).";
    }

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::MetersLighting (TDateTime mmgg)
{
/*
  AnsiString  sqlstr1="  select clm.code,clm.name, substr(tcl.ident,4,1)::::varchar as cltar,tgr.ident as grtar, \
 CASE WHEN tgr.ident = 'tgr1' then 1 WHEN tgr.ident = 'tgr2' then 2 \
 WHEN tgr.ident = 'tgr3' then 5 WHEN tgr.ident = 'tgr4' then 6 \
 WHEN tgr.ident = 'tgr5' then 7 WHEN tgr.ident = 'tgr6' then 4 end as grtar_cod, \
 m.type, sss.num_eqp , \
 sss.sum_n,sss.demand_n::::numeric/1000 as demand_n,sss2.demand_d::::numeric/1000 as demand_d,sss2.sum_d,sss.sum_n+coalesce(sss2.sum_d,0) as sum,sss.billdt \
 from \
 (select b.id_client, mkz.id_type_meter,mkz.num_eqp::::varchar,tar.id_grouptarif,tar.id_classtarif, \
 sum(bs.demand_val) as demand_n, sum(bs.sum_val) as sum_n, min(b.dat_e) as billdt \
 from acm_bill_tbl as b \
 join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
 join clm_client_tbl as clm on (clm.id=b.id_client) \
 join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
 left join (select id_point,id_doc,  \
           max(id_meter) as id_meter,max(id_type_eqp) as id_type_meter,trim(regexp_replace(trim(max(num_eqp)),'(н|д)$',''))::::varchar as num_eqp  \
           from acd_met_kndzn_tbl where id_zone = 0 and kind_energy=1 and mmgg = :pmmgg group by id_point,id_doc order by id_point,id_doc) as mkz \
           on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc ) \
 where bs.id_tariff = 51 and bs.id_zone = 0 and b.id_pref = 10 \
 and b.mmgg = :pmmgg and clm.book = -1 \
 group by b.id_client, mkz.id_type_meter,mkz.num_eqp,tar.id_grouptarif,tar.id_classtarif order by b.id_client, mkz.num_eqp) as sss \
 left join \
 (select b.id_client, mkz.num_eqp::::varchar, sum(bs.demand_val) as demand_d, sum(bs.sum_val) as sum_d \
 from acm_bill_tbl as b join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
 join clm_client_tbl as clm on (clm.id=b.id_client) \
 join (select id_point,id_doc, trim(regexp_replace(trim(max(num_eqp)),'(н|д)$',''))::::varchar as num_eqp   \
           from acd_met_kndzn_tbl where id_zone = 0 and kind_energy=1 and mmgg = :pmmgg group by id_point,id_doc order by id_point,id_doc) as mkz \
           on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc ) \
 where bs.id_tariff <> 51 and bs.id_zone = 0 and b.id_pref = 10 \
 and b.mmgg = :pmmgg and clm.book = -1 \
 group by b.id_client, mkz.num_eqp order by b.id_client, mkz.num_eqp) as sss2 on (sss.id_client = sss2.id_client and sss.num_eqp = sss2.num_eqp) \
 left join eqi_grouptarif_tbl as tgr on (tgr.id=sss.id_grouptarif) \
 left join eqi_classtarif_tbl as tcl on (tcl.id=sss.id_classtarif) \
 left join clm_client_tbl as clm on (clm.id=sss.id_client) \
 left join eqi_meter_tbl as m on (sss.id_type_meter=m.id) order by clm.code,sss.num_eqp; ";
   */

  AnsiString  sqlstr1="  select clm.code,clm.name, substr(tcl.ident,4,1)::::varchar as cltar,tgr.ident as grtar, \
 CASE WHEN tgr.ident = 'tgr1' then 1 WHEN tgr.ident = 'tgr2' then 2 \
 WHEN tgr.ident = 'tgr3' then 5 WHEN tgr.ident = 'tgr4' then 6 \
 WHEN tgr.ident = 'tgr5' then 7 WHEN tgr.ident = 'tgr6' then 4 end as grtar_cod, \
 m.type, sss.num_eqp , \
 sss.sum_n,sss.demand_n::::numeric/1000 as demand_n,sss2.demand_d::::numeric/1000 as demand_d,sss2.sum_d,sss.sum_n+coalesce(sss2.sum_d,0) as sum,sss.billdt \
 from \
 (select b.id_client, mp.id_meter, mm.id_type_eqp as id_type_meter,trim(regexp_replace(trim(eq.num_eqp),'(н|д)$',''))::::varchar as num_eqp, \
 tar.id_grouptarif,tar.id_classtarif, \
 sum(bs.demand_val) as demand_n, sum(bs.sum_val) as sum_n, min(b.dat_e) as billdt \
 from acm_bill_tbl as b \
 join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
 join clm_client_tbl as clm on (clm.id=b.id_client) \
 join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
 left join eqm_meter_point_h as mp on (mp.id_point = bs.id_point and mp.dt_b <= bs.dt_begin and coalesce(mp.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
 left join eqm_equipment_h as eq on (eq.id = mp.id_meter and eq.dt_b <= bs.dt_begin and coalesce(eq.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
 left join eqm_meter_h as mm on (mm.code_eqp = mp.id_meter and mm.dt_b <= bs.dt_begin and coalesce(mm.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
 where bs.id_tariff = 51 and bs.id_zone = 0 and b.id_pref = 10 \
 and b.mmgg = :pmmgg and clm.book = -1 \
 group by b.id_client, mp.id_meter, id_type_meter,num_eqp,tar.id_grouptarif,tar.id_classtarif order by b.id_client, num_eqp) as sss \
 left join \
 (select b.id_client, trim(regexp_replace(trim(eq.num_eqp),'(н|д)$',''))::::varchar as num_eqp, \
  sum(bs.demand_val) as demand_d, sum(bs.sum_val) as sum_d \
 from acm_bill_tbl as b join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
 join clm_client_tbl as clm on (clm.id=b.id_client) \
 left join eqm_meter_point_h as mp on (mp.id_point = bs.id_point and mp.dt_b <= bs.dt_begin and coalesce(mp.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
 left join eqm_equipment_h as eq on (eq.id = mp.id_meter and eq.dt_b <= bs.dt_begin and coalesce(eq.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
 where bs.id_tariff <> 51 and bs.id_zone = 0 and b.id_pref = 10 \
 and b.mmgg = :pmmgg and clm.book = -1 \
 group by b.id_client, num_eqp order by b.id_client, num_eqp) as sss2 on (sss.id_client = sss2.id_client and sss.num_eqp = sss2.num_eqp) \
 left join eqi_grouptarif_tbl as tgr on (tgr.id=sss.id_grouptarif) \
 left join eqi_classtarif_tbl as tcl on (tcl.id=sss.id_classtarif) \
 left join clm_client_tbl as clm on (clm.id=sss.id_client) \
 left join eqi_meter_tbl as m on (sss.id_type_meter=m.id) order by clm.code,sss.num_eqp; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::RepAbonCount(TDateTime dt, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dt;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1="select * from rep_count_tbl where mmgg = :dt;";
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  AnsiString  sqlstr11=" select c.code, c.short_name, av.adr, \
  case when scl.id_section in (211,213,214,215) and coalesce(kt.flag_type , (select getsysvar('kod_res') = 310 ) ) =true and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_budjet_t, \
  case when scl.id_section in (211,213,214,215) and coalesce(kt.flag_type ,(select getsysvar('kod_res') = 310 )) =false and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_budjet_v, \
  case when scl.id_section in (203) and coalesce(kt.flag_type ,(select getsysvar('kod_res') = 310 )) =true and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_jkh_t, \
  case when scl.id_section in (203) and coalesce(kt.flag_type ,(select getsysvar('kod_res') = 310 )) =false and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_jkh_v, \
  case when scl.id_section in (204) and coalesce(kt.flag_type ,(select getsysvar('kod_res') = 310 )) =true and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_other_t, \
  case when scl.id_section in (204) and coalesce(kt.flag_type ,(select getsysvar('kod_res') = 310 )) =false and exists (select id_point from rep_areas_points_tbl where id_client  = c.id )and not exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_other_v, \
  case when scl.id_section not in (202) and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) and exists (select id_point from rep_areas_points_tbl where id_client  = c.id and coalesce(voltage,4) <> 4 ) then 1 else 0 end as abons_noprom10k, \
  case when scl.id_section =202 then 1 else 0 end as abons_sh \
  from clm_client_tbl as c \
  left join clm_statecl_h as scl on (c.id = scl.id_client) \
  left join adm_address_tbl as a on (a.id = c.id_addres) \
  left join adv_address_tbl as av on (av.id = a.id) \
  left join adi_street_tbl as s on (s.id = a.id_street) \
  left join adi_town_tbl as t on (t.id = s.id_town) \
  left join adk_town_tbl as kt on (kt.id = t.idk_town) \
  where scl.id_section not in (205,206,207,208,201) and c.idk_work not in (0,99) and c.book=-1 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and exists (select id_point from rep_areas_points_tbl where id_client  = c.id ) \
  and coalesce(c.id_state,0) not in (50,99) \
  order by c.code; ";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr11);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=dt;


  AnsiString  sqlstr12=" select c2.id, c2.code, c2.short_name, power_calc, power_all, pp.power from \
  ( select tr.id_client, sum(coalesce(eqi.power_nom,0)) as power_all, \
   sum(CASE WHEN csi.code_eqp_inst is not null THEN coalesce(eqi.power_nom,0) END ) as power_calc \
    from eqm_tree_h as tr \
    join (select id, max(dt_b) as dt from eqm_tree_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by id order by id ) as tr2 on (tr.id = tr2.id and tr2.dt = tr.dt_b) \
    join eqm_eqp_tree_h as ttr on (tr.id = ttr.id_tree) \
    join (select code_eqp, max(dt_b) as dt from eqm_eqp_tree_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp order by code_eqp) as ttr2 on (ttr.code_eqp = ttr2.code_eqp and ttr2.dt = ttr.dt_b) \
    join eqm_compensator_h as p on (ttr.code_eqp = p.code_eqp) \
    join (select code_eqp, max(dt_b) as dt from eqm_compensator_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp order by code_eqp ) as p2 on (p.code_eqp = p2.code_eqp and p2.dt = p.dt_b) \
    join eqi_compensator_tbl as eqi on (eqi.id = p.id_type_eqp) \
    left join \
    (select inst.code_eqp, inst.code_eqp_inst from eqm_compens_station_inst_h as inst \
     join (select code_eqp, code_eqp_inst, max(dt_b) as dt from eqm_compens_station_inst_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt \
          group by code_eqp, code_eqp_inst order by  code_eqp, code_eqp_inst) as inst2 \
          on (inst.code_eqp = inst2.code_eqp and inst.code_eqp_inst = inst2.code_eqp_inst and inst2.dt = inst.dt_b) \
     join eqm_equipment_tbl as eq_inst on (inst.code_eqp_inst = eq_inst.id and eq_inst.type_eqp = 11) \
    ) as csi on (csi.code_eqp = p.code_eqp) \
   group by tr.id_client ) as ss \
    right join \
    (select cl.id,cl.short_name,cl.code from clm_client_tbl as cl \
     left join clm_statecl_h as scl on (cl.id = scl.id_client) \
     where scl.id_section =201 and cl.idk_work not in (0,99) and cl.book=-1 \
     and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
     and exists (select id_point from rep_areas_points_tbl where id_client  = cl.id ) \
     and coalesce(cl.id_state,0) not in (50,99) ) as c2 \
    on (c2.id = ss.id_client) \
    join rep_count_prom_power_tbl as pp on (pp.id_client = c2.id) \
    order by c2.code ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr12);
  ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;

  AnsiString  sqlstr13="  select c.code, c.short_name, a.name_eqp as areaname, av.adr, \
   p.name_eqp as pointname, ph.name as phase, vv.voltage_min, coalesce(pp.name, '??? Не вказано ???') as section, \
   case when ap.is_town = true then 'Город' else 'Село' end as town \
   from rep_areas_points_tbl as ap \
   join clm_client_tbl as c on (c.id = ap.id_client ) \
   join clm_statecl_h as scl on (c.id = scl.id_client) \
   join eqm_equipment_h as p on (p.id = ap.id_point) \
   join (select id, max(dt_b) as dt from eqm_equipment_h  where dt_b <= :dt and coalesce(dt_e, :dt) >= :dt group by id) as p2 on (p.id = p2.id and p2.dt = p.dt_b) \
   left join\
    (select area.id, area.name_eqp, area.id_addres from eqm_equipment_h as area \
    join (select id, max(dt_b) as dt from eqm_equipment_h  where dt_b <= :dt and coalesce(dt_e, :dt) >= :dt and type_eqp  = 11 group by id) as area2 on (area.id = area2.id and area2.dt = area.dt_b) \
    ) as a on (a.id = ap.id_area) \
   left join eqk_voltage_tbl as vv on (vv.id = ap.voltage) \
   left join adv_address_tbl as av on (av.id = a.id_addres) \
   left join eqk_phase_tbl as ph on (ph.id = ap.phase) \
   left join cla_param_tbl as pp on (pp.id = scl.id_section) \
   where scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
   and ap.del_abon = 0 \
   order by id_section, c.code, areaname; ";

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr13);
  ZQXLRepsSum2->ParamByName("dt")->AsDateTime=dt;


  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias = "ZQXLReps3";
  Dsr->Range = "Range2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias = "ZQXLReps4";
  Dsr->Range = "Range3";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum->Close();
 ZQXLRepsSum2->Close();

}
////////////---------------------------------------------
void TfReports::PrintPayAbonGrp(TDateTime dtb,TDateTime dte,int kind_energy)
{
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name ,bank.name as bank_name , cp.represent_name, \
  pay.value_pay,pay.value,pay.value_tax, coalesce(scl.id_section,999) as link \
  from clm_client_tbl as cl \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  join ( select id_client,mfo_client, sum(p.value_pay) as value_pay, sum(p.value) as value, sum(p.value_tax) as value_tax \
  from acm_pay_tbl as p  where p.reg_date >= :dtb and p.reg_date <= :dte \
  and p.id_pref = :pref and  p.sign_pay = 1 and p.value_pay<> 0 \
  group by id_client,mfo_client ) as pay on (pay.id_client = cl.id) \
  left join cmi_bank_tbl as bank on (bank.id = pay.mfo_client) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  where cl.book = -1  and ( :insp is null or scl.id_position = :insp) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date ) ) \
  order by cl.code , bank_name; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  // по категориям
  AnsiString  sqlstr2= " select n.id as link, n.name,n.sort, \
     sum(value_pay) as value_pay, sum(value) as value, sum(value_tax) as value_tax \
     from ( select sum(p.value_pay) as value_pay, sum(p.value) as value, sum(p.value_tax) as value_tax, coalesce(scl.id_section,999) as section \
     from clm_client_tbl as cl \
     join clm_statecl_h as scl  on (cl.id = scl.id_client) \
     join acm_pay_tbl as p on (cl.id = p.id_client) \
     where p.reg_date >= :dtb and p.reg_date <= :dte   \
     and ( :insp is null or scl.id_position = :insp) \
     and p.id_pref = :pref and cl.book = -1 and p.sign_pay = 1 \
     and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date ) ) \
     group by section )as sss \
     left join \
     (select p1.id as id1,p2.id as id2,p3.id as id3,p4.id as id4 \
     from cla_param_tbl as p1 \
     left join cla_param_tbl as p2 on (p2.id = p1.id_parent ) \
     left join cla_param_tbl as p3 on (p3.id = p2.id_parent ) \
     left join cla_param_tbl as p4 on (p4.id = p3.id_parent ) \
     where p1.id_group= 200 and p1.id <>200 ) as gr on (gr.id1 = sss.section) \
     right join    ( select p.id, p.lev, p.sort ,\
      CASE WHEN p.lev = 2 THEN p.name \
           WHEN p.lev = 3 THEN ' - '||p.name \
           WHEN p.lev = 4 THEN ' - - '||p.name \
           WHEN p.lev = 1 THEN 'ВСЬОГО' END AS name \
      from cla_param_tbl as p where p.id_group= 200 or p.id = 200  ) as  n  \
     on (n.id in (gr.id1,gr.id2,gr.id3,gr.id4) ) \
     group by  n.id, n.name , n.sort order by n.sort ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);

  ZQXLRepsSum->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLRepsSum->ParamByName("dte")->AsDateTime=dte;

  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформ.послуги.";


  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";


  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------
void TfReports::ObSaldoAbon(TDateTime mmgg,int kind_energy,int client, boolean Build)
{
  if(client==0) return;

   AnsiString  sqlstr;
   if (Build)
   {
    sqlstr=" select seb_one( date_trunc('month', :mmgg::::date)::::date, 0, :client )";

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
    ZQReps->ParamByName("client")->AsInteger=client;

    try
    {
     ZQReps->ExecSql();

      sqlstr= " update seb_obrs_tmp \
                    set b_dtval=0,    b_ktval=b_ktval-b_dtval \
                 where b_dtval<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
      sqlstr= " update seb_obrs_tmp \
                    set  b_dtval_tax=0, b_ktval_tax=b_ktval_tax-b_dtval_tax   \
               where b_dtval_tax<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_dtval=0,e_ktval=e_ktval-e_dtval \
               where e_dtval<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_dtval_tax=0,e_ktval_tax=e_ktval_tax-e_dtval_tax  \
               where e_dtval_tax<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
     /////////////////////////////////////////////////////
      sqlstr= " update seb_obrs_tmp \
                    set b_ktval=0,    b_dtval=b_dtval-b_ktval \
                 where b_ktval<0 and (select sum(b_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0  \
                                     and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date) \
                 ;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();
      sqlstr= " update seb_obrs_tmp \
                    set     b_ktval_tax=0, b_dtval_tax=b_dtval_tax-b_ktval_tax   \
               where b_ktval_tax<0 and (select sum(b_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date);";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_ktval=0,e_dtval=coalesce(e_dtval,0)-e_ktval \
               where e_ktval<0 and (select sum(e_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0\
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";
                         //
      ZQReps->Close();
      
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_ktval_tax=0,e_dtval_tax=e_dtval_tax-e_ktval_tax  \
               where e_ktval_tax<0 and (select sum(e_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
       ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();


    }
    catch(...)
    {
     ShowMessage("Ошибка SQL :"+sqlstr);
     return;
    }
   }


  AnsiString  sqlstr1="select abon.name , abon.code,  \
  abonpar.doc_num ||' від '|| abonpar.doc_dat as doc, \
  sss1.*, sss2.*,sss3.*, CASE WHEN coalesce(abonpar.flag_budjet,0) <> 0 THEN 'Так' ELSE 'Ні' END::::varchar as budjet, \
  CASE WHEN coalesce(abonpar.flag_taxpay,0) <> 0 THEN 'Так' ELSE 'Ні' END::::varchar as taxpay \
  from  clm_client_tbl as abon \
  join clm_statecl_h as abonpar on (abonpar.id_client = abon.id) \
  left join \
  ( select obr.id_client , \
  sum(kt1999.b_kt+kt1999.b_kttax) as kr_zpmv99, \
  sum(kt2000.b_kt+kt2000.b_kttax) as kr_zpmv00, \
  sum(kt2001.b_kt+kt2001.b_kttax) as kr_zpmv01, \
  sum(kt2002.b_kt+kt2002.b_kttax) as kr_zpmv02, \
  sum(kt2003.b_kt+kt2003.b_kttax) as kr_zpmv03, \
  sum(kt2004.b_kt+kt2004.b_kttax) as kr_zpmv04, \
  sum(kt2005.b_kt+kt2005.b_kttax) as kr_zpmv05, \
  sum(kt2006.b_kt+kt2006.b_kttax) as kr_zpmv06, \
  sum(kt2007.b_kt+kt2007.b_kttax) as kr_zpmv07, \
  sum(kt2008.b_kt+kt2008.b_kttax) as kr_zpmv08, \
  sum(kt2009.b_kt+kt2009.b_kttax) as kr_zpmv09, \
  sum(kt2010.b_kt+kt2010.b_kttax) as kr_zpmv10, \
  sum(kt2011.b_kt+kt2011.b_kttax) as kr_zpmv11, \
  sum(kt2012.b_kt+kt2012.b_kttax) as kr_zpmv12, \
  sum(kt2013.b_kt+kt2013.b_kttax) as kr_zpmv13, \
  sum(kt2014.b_kt+kt2014.b_kttax) as kr_zpmv14, \
  -sum(deb_pm99v) as deb99 ,- sum(deb_pm00v) as deb00,\
  -sum(deb_pm01v) as deb01,- sum(deb_pm02v) as deb02, \
  -sum(deb_pm03v) as deb03,- sum(deb_pm04v) as deb04, \
  -sum(deb_pm05v) as deb05, -sum(deb_pm06v) as deb06, \
  -sum(deb_pm07v) as deb07,-sum(deb_pm08v) as deb08,\
  -sum(deb_pm09v) as deb09, -sum(deb_pm10v) as deb10,\
  -sum(deb_pm11v) as deb11, -sum(deb_pm12v) as deb12, \
  -sum(deb_pm13v) as deb13, -sum(deb_pm14v) as deb14, \
  sum(kt1999.e_kt+kt1999.e_kttax) as kr_zkmv99, \
  sum(kt2000.e_kt+kt2000.e_kttax) as kr_zkmv00, \
  sum(kt2001.e_kt+kt2001.e_kttax) as kr_zkmv01, \
  sum(kt2002.e_kt+kt2002.e_kttax) as kr_zkmv02, \
  sum(kt2003.e_kt+kt2003.e_kttax) as kr_zkmv03, \
  sum(kt2004.e_kt+kt2004.e_kttax) as kr_zkmv04, \
  sum(kt2005.e_kt+kt2005.e_kttax) as kr_zkmv05, \
  sum(kt2006.e_kt+kt2006.e_kttax) as kr_zkmv06, \
  sum(kt2007.e_kt+kt2007.e_kttax) as kr_zkmv07, \
  sum(kt2008.e_kt+kt2008.e_kttax) as kr_zkmv08, \
  sum(kt2009.e_kt+kt2009.e_kttax) as kr_zkmv09, \
  sum(kt2010.e_kt+kt2010.e_kttax) as kr_zkmv10, \
  sum(kt2011.e_kt+kt2011.e_kttax) as kr_zkmv11, \
  sum(kt2012.e_kt+kt2012.e_kttax) as kr_zkmv12, \
  sum(kt2013.e_kt+kt2013.e_kttax) as kr_zkmv13, \
  sum(kt2014.e_kt+kt2014.e_kttax) as kr_zkmv14, \
  -sum(deb_km99v) as deb99_k,- sum(deb_km00v) as deb00_k, \
  -sum(deb_km01v) as deb01_k,- sum(deb_km02v) as deb02_k, \
  -sum(deb_km03v) as deb03_k,- sum(deb_km04v) as deb04_k, \
  -sum(deb_km05v) as deb05_k, -sum(deb_km06v) as deb06_k, \
  -sum(deb_km07v) as deb07_k, -sum(deb_km08v) as deb08_k,\
  -sum(deb_km09v) as deb09_k, -sum(deb_km10v) as deb10_k , \
  -sum(deb_km11v) as deb11_k , -sum(deb_km12v) as deb12_k ,\
  -sum(deb_km13v) as deb13_k , -sum(deb_km14v) as deb14_k ,\
  sum(kt1999.b_kttax) as kr_zpmn99, \
  sum(kt2000.b_kttax) as kr_zpmn00, \
  sum(kt2001.b_kttax) as kr_zpmn01, \
  sum(kt2002.b_kttax) as kr_zpmn02, \
  sum(kt2003.b_kttax) as kr_zpmn03, \
  sum(kt2004.b_kttax) as kr_zpmn04, \
  sum(kt2005.b_kttax) as kr_zpmn05, \
  sum(kt2006.b_kttax) as kr_zpmn06, \
  sum(kt2007.b_kttax) as kr_zpmn07, \
  sum(kt2008.b_kttax) as kr_zpmn08, \
  sum(kt2009.b_kttax) as kr_zpmn09, \
  sum(kt2010.b_kttax) as kr_zpmn10, \
  sum(kt2011.b_kttax) as kr_zpmn11, \
  sum(kt2012.b_kttax) as kr_zpmn12, \
  sum(kt2013.b_kttax) as kr_zpmn13, \
  sum(kt2014.b_kttax) as kr_zpmn14, \
  -sum(deb_pm00pdv) as deb00n,\
  -sum(deb_pm01pdv) as deb01n,- sum(deb_pm02pdv) as deb02n, \
  -sum(deb_pm03pdv) as deb03n,- sum(deb_pm04pdv) as deb04n, \
  -sum(deb_pm05pdv) as deb05n, -sum(deb_pm06pdv) as deb06n, \
  -sum(deb_pm07pdv) as deb07n,-sum(deb_pm08pdv) as deb08n,\
  -sum(deb_pm09pdv) as deb09n,-sum(deb_pm10pdv) as deb10n, \
  -sum(deb_pm11pdv) as deb11n, -sum(deb_pm12pdv) as deb12n, \
  -sum(deb_pm13pdv) as deb13n, -sum(deb_pm14pdv) as deb14n, \
  sum(kt1999.e_kttax) as kr_zkmn99, \
  sum(kt2000.e_kttax) as kr_zkmn00, \
  sum(kt2001.e_kttax) as kr_zkmn01, \
  sum(kt2002.e_kttax) as kr_zkmn02, \
  sum(kt2003.e_kttax) as kr_zkmn03, \
  sum(kt2004.e_kttax) as kr_zkmn04, \
  sum(kt2005.e_kttax) as kr_zkmn05, \
  sum(kt2006.e_kttax) as kr_zkmn06, \
  sum(kt2007.e_kttax) as kr_zkmn07, \
  sum(kt2008.e_kttax) as kr_zkmn08, \
  sum(kt2009.e_kttax) as kr_zkmn09, \
  sum(kt2010.e_kttax) as kr_zkmn10, \
  sum(kt2011.e_kttax) as kr_zkmn11, \
  sum(kt2012.e_kttax) as kr_zkmn12, \
  sum(kt2013.e_kttax) as kr_zkmn13, \
  sum(kt2014.e_kttax) as kr_zkmn14, \
  -sum(deb_km00pdv) as deb00_kn, \
  -sum(deb_km01pdv) as deb01_kn,- sum(deb_km02pdv) as deb02_kn, \
  -sum(deb_km03pdv) as deb03_kn,- sum(deb_km04pdv) as deb04_kn, \
  -sum(deb_km05pdv) as deb05_kn, -sum(deb_km06pdv) as deb06_kn, \
  -sum(deb_km07pdv) as deb07_kn,-sum(deb_km08pdv) as deb08_kn, \
  -sum(deb_km09pdv) as deb09_kn,  -sum(deb_km10pdv) as deb10_kn, \
  -sum(deb_km11pdv) as deb11_kn , -sum(deb_km12pdv) as deb12_kn, \
  -sum(deb_km13pdv) as deb13_kn , -sum(deb_km14pdv) as deb14_kn \
  from  seb_obr_all_tmp as obr \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=1999 group by id_client ) as kt1999 on ( kt1999.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2000 group by id_client ) as kt2000 on ( kt2000.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2001 group by id_client ) as kt2001 on ( kt2001.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2002 group by id_client ) as kt2002 on ( kt2002.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2003 group by id_client ) as kt2003 on ( kt2003.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2004 group by id_client ) as kt2004 on ( kt2004.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2005 group by id_client ) as kt2005 on ( kt2005.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2006 group by id_client ) as kt2006 on ( kt2006.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2007 group by id_client ) as kt2007 on ( kt2007.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2008 group by id_client ) as kt2008 on ( kt2008.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2009 group by id_client ) as kt2009 on ( kt2009.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2010 group by id_client ) as kt2010 on ( kt2010.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2011 group by id_client ) as kt2011 on ( kt2011.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2012 group by id_client ) as kt2012 on ( kt2012.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2013 group by id_client ) as kt2013 on ( kt2013.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2014 group by id_client ) as kt2014 on ( kt2014.id_client = obr.id_client) \
  where obr.id_client = :client and obr.id_pref = :pref \
  and obr.period = date_trunc('month',  :dt::::date) \
  group by obr.id_client ) as sss1 on (sss1.id_client = abon.id) \
 left join \
 (select p.id_client, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_pay ELSE 0 END) as pay14, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_tax ELSE 0 END) as paytax00, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_tax ELSE 0 END) as paytax01, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_tax ELSE 0 END) as paytax02, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_tax ELSE 0 END) as paytax03, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_tax ELSE 0 END) as paytax04, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_tax ELSE 0 END) as paytax05, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_tax ELSE 0 END) as paytax06, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_tax ELSE 0 END) as paytax07, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_tax ELSE 0 END) as paytax08, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_tax ELSE 0 END) as paytax09, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_tax ELSE 0 END) as paytax10, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_tax ELSE 0 END) as paytax11, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_tax ELSE 0 END) as paytax12, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_tax ELSE 0 END) as paytax13, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_tax ELSE 0 END) as paytax14  \
  from acm_pay_tbl as p  \
  where p.id_client = :client and p.mmgg = date_trunc('month',  :dt::::date)  \
  and p.id_pref = :pref and p.sign_pay = 1 group by p.id_client \
  )as sss2 on (sss2.id_client = abon.id) \
 left join \
 (select b.id_client, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value ELSE 0 END) as bill99, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value ELSE 0 END) as bill00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value ELSE 0 END) as bill01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value ELSE 0 END) as bill02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value ELSE 0 END) as bill03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value ELSE 0 END) as bill04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value ELSE 0 END) as bill05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value ELSE 0 END) as bill06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value ELSE 0 END) as bill07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value ELSE 0 END) as bill08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value ELSE 0 END) as bill09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value ELSE 0 END) as bill10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value ELSE 0 END) as bill11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value ELSE 0 END) as bill12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value ELSE 0 END) as bill13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value ELSE 0 END) as bill14, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value_tax ELSE 0 END) as billtax00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value_tax ELSE 0 END) as billtax01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value_tax ELSE 0 END) as billtax02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value_tax ELSE 0 END) as billtax03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value_tax ELSE 0 END) as billtax04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value_tax ELSE 0 END) as billtax05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value_tax ELSE 0 END) as billtax06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value_tax ELSE 0 END) as billtax07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value_tax ELSE 0 END) as billtax08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value_tax ELSE 0 END) as billtax09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value_tax ELSE 0 END) as billtax10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value_tax ELSE 0 END) as billtax11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value_tax ELSE 0 END) as billtax12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value_tax ELSE 0 END) as billtax13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value_tax ELSE 0 END) as billtax14, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.demand_val ELSE 0 END) as dem99, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.demand_val ELSE 0 END) as dem00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.demand_val ELSE 0 END) as dem01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.demand_val ELSE 0 END) as dem02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.demand_val ELSE 0 END) as dem03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.demand_val ELSE 0 END) as dem04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.demand_val ELSE 0 END) as dem05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.demand_val ELSE 0 END) as dem06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.demand_val ELSE 0 END) as dem07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.demand_val ELSE 0 END) as dem08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.demand_val ELSE 0 END) as dem09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.demand_val ELSE 0 END) as dem10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.demand_val ELSE 0 END) as dem11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.demand_val ELSE 0 END) as dem12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.demand_val ELSE 0 END) as dem13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.demand_val ELSE 0 END) as dem14  \
  from acm_bill_tbl as b  \
  where b.id_client = :client and b.mmgg = date_trunc('month',  :dt::::date)  \
  and b.id_pref = :pref and b.idk_doc<>201 group by b.id_client \
  )as sss3 on (sss3.id_client = abon.id) \
  where abon.id = :client \
  and abonpar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as abonpar2 where abonpar2.id_client = abonpar.id_client and abonpar2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
  ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("dt")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформ.послуги";

  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
// акт по 3-зонным
void TfReports::PrintAkt3(TDateTime mmgg,int client)
{

  AnsiString  sqlstr1="select abonname, resname, bill.demand1,bill.demand2,bill.demand3, \
  bill.demand3_old, bill.demand3_new,bill.sum1,bill.sum2,bill.sum3,bill.sum3_old, bill.sum3_new, \
  b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, \
  sa.pay, sa.deb_e, sa.adr, bospos, bossname,  buhpos, buhname, abn_boss \
  from \
  (select abon.id,abon.name as abonname, res.name as resname, aa.adr, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname, \
  ss.kt_val+ss.kt_valtax as pay, ss.e_val+ss.e_valtax as deb_e, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join acm_saldo_tbl as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.mmgg = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) ) as sa \
  left join \
  ( select bm.id_client, \
  sum(CASE WHEN bs.id_zone=1 THEN bs.demand_val ELSE 0 END) as demand1, \
  sum(CASE WHEN bs.id_zone=2 THEN bs.demand_val ELSE 0 END) as demand2, \
  sum(CASE WHEN bs.id_zone=3 THEN bs.demand_val ELSE 0 END) as demand3, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.demand_val ELSE 0 END) as demand3_old, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.demand_val ELSE 0 END) as demand3_new, \
  sum(CASE WHEN bs.id_zone=1 THEN bs.sum_val ELSE 0 END) as sum1, \
  sum(CASE WHEN bs.id_zone=2 THEN bs.sum_val ELSE 0 END) as sum2, \
  sum(CASE WHEN bs.id_zone=3 THEN bs.sum_val ELSE 0 END) as sum3, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.sum_val ELSE 0 END) as sum3_old, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.sum_val ELSE 0 END) as sum3_new \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as bm using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
  where bs.id_zone in (1,2,3) and bs.kind_energy=1 \
  and (tgr.ident not like '%tgr7%' and tgr.ident not like '%tgr8%' or tgr.ident = 'tgr8_61')\
  and bm.id_client = :client \
  and date_trunc('month',bs.mmgg)=date_trunc('month', :mmgg::::date) \
  group by bm.id_client ) as bill on (bill.id_client=sa.id)\
  left join \
  (select id_client, sum(value) as value, sum(value_tax) as value_tax, sum(demand_val) as demand_val, \
   max(CASE WHEN idk_doc = 200 THEN reg_date ELSE null END) as reg_date , \
   max(CASE WHEN idk_doc = 200 THEN reg_num ELSE null END) as reg_num \
  from acm_bill_tbl where id_client = :client and mmgg=date_trunc('month', :mmgg::::date) and id_pref = 10 \
  group by id_client \
  ) as b on (b.id_client=sa.id);";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;


  AnsiString  sqlstr2="select abonname, resname, bill.demand1,bill.demand2,bill.demand3, \
  bill.demand3_old, bill.demand3_new,bill.sum3_old, bill.sum3_new, \
  bill.sum1,bill.sum2,bill.sum3,b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, \
  sa.pay, sa.deb_e, sa.adr, bospos, bossname,  buhpos, buhname \
  from \
  (select abon.id, abon.name as abonname, res.name as resname, aa.adr, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname, \
  ss.kt_val+ss.kt_valtax as pay, ss.e_val+ss.e_valtax as deb_e \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join acm_saldo_tbl as ss on (ss.id_client = abon.id), \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.mmgg = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) ) as sa \
  left join \
  ( select bm.id_client, \
  sum(CASE WHEN bs.id_zone=1 THEN bs.demand_val ELSE 0 END) as demand1, \
  sum(CASE WHEN bs.id_zone=2 THEN bs.demand_val ELSE 0 END) as demand2, \
  sum(CASE WHEN bs.id_zone=3 THEN bs.demand_val ELSE 0 END) as demand3, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.demand_val ELSE 0 END) as demand3_old, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.demand_val ELSE 0 END) as demand3_new, \
  sum(CASE WHEN bs.id_zone=1 THEN bs.sum_val ELSE 0 END) as sum1, \
  sum(CASE WHEN bs.id_zone=2 THEN bs.sum_val ELSE 0 END) as sum2, \
  sum(CASE WHEN bs.id_zone=3 THEN bs.sum_val ELSE 0 END) as sum3, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 1.68 THEN bs.sum_val ELSE 0 END) as sum3_old, \
  sum(CASE WHEN bs.id_zone=3 and z.koef = 2 THEN bs.sum_val ELSE 0 END) as sum3_new \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as bm using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
  where bs.id_zone in (1,2,3) and bs.kind_energy=1 \
  and (tgr.ident like '%tgr7%' or tgr.ident like '%tgr8%') \
  and bm.id_client = :client \
  and date_trunc('month',bs.mmgg)=date_trunc('month', :mmgg::::date) \
  group by bm.id_client ) as bill on (bill.id_client=sa.id) \
  left join \
  (select id_client, sum(value) as value, sum(value_tax) as value_tax, sum(demand_val) as demand_val, \
   max(CASE WHEN idk_doc = 200 THEN reg_date ELSE null END) as reg_date , \
   max(CASE WHEN idk_doc = 200 THEN reg_num ELSE null END) as reg_num \
  from acm_bill_tbl where id_client = :client and mmgg=date_trunc('month', :mmgg::::date) and id_pref = 10 \
  group by id_client \
  ) as b on (b.id_client=sa.id);";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps2->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  if ((year1 = 2014)&&(month1==12))
     xlReport->XLSTemplate = "XL\\akt3_12_2014.xls";
  else
     xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;

  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";

  Dsr = xlReport->DataSources->Add();  
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";

  //  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

//  Param=xlReport->Params->Add();
//  Param->Name="lnow";
//  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

//  xlReport->ParamByName["workdt"]->Value = dt;

 xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();

}
//---------------------------------------------------------------------------
void TfReports::PointsAbon(TDateTime dt,int client)
{
  if(client==0) return;

   AnsiString  sqlstr;

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select del_eqtmp_t(0,1);");
    ZQReps->Sql->Add("select mabn_tree( :client ,( :dt::::date - '1 day'::::interval)::::date, :dt::::date ,0, date_trunc('month', :mmgg::::date)::::date);");

    ZQReps->ParamByName("client")->AsInteger=client;
    ZQReps->ParamByName("dt")->AsDateTime=dt;

    
    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }

 AnsiString  sqlstr1="  select cp.code,cp.name_client,ep.id_point,e.id_client as id_client,\
  e.id_addres, adr.adr,e.name_eqp,ep.num_eqp,ep.type_met,ep.carry_met,ep.type_tt,ep.type_tu, \
  koef_tt*koef_tu as koef, ep.energy,ep.zone,\
 pp.id_grouptarif,pp.id_tarif,pp.id_voltage,pp.tarif,pp.class,pp.power, pp.name_voltage, pp.extra_name, pp.count_itr,pp.itr_comment, \
  CASE WHEN pb.id_p_point is null THEN 'Осн.' ELSE 'Дубль' END as isdubl, \
  Case when ll.id_point is not null then '+' else ' ' end as lep, \
    Case when lt.id_point is not null then '+' else ' ' end as tp \
 from act_point_branch_tbl as pb                                                        \
 left join   act_losts_eqm_tbl ll  on (pb.id_point=ll.id_point and ll.type_eqm in (6,7)) \
 left join   act_losts_eqm_tbl lt  on (pb.id_point=lt.id_point and lt.type_eqm=2), \
 (                                                                                                                                                    \
  select * from                                                                                                                                        \
    ((select e.*,et.id_client from                                                                                                                      \
       (select * from eqm_equipment_tbl where type_eqp in (12)) as e,                                                                                   \
         ( select e.*,et.id_client from eqm_eqp_tree_tbl e,                                                                                             \
                (select t.* from eqm_tree_tbl t,clm_statecl_tbl s                                                                                       \
                  where s.id_client=t.id_client                                                                                                         \
                )   et                                                                                                                                  \
           where et.id=e.id_tree                                                                                                                        \
          ) et where e.id=et.code_eqp                                                                                                                   \
        )                                                                                                                                               \
        union                                                                                                                                           \
       (select e.*,et.id_client from                                                                                                                    \
          (select * from eqm_equipment_tbl where type_eqp in (12) ) as e,                                                                                \
            (select e.* from eqm_eqp_use_tbl e     ,clm_statecl_tbl s                                                                                    \
              where s.id_client=e.id_client                                                                                                              \
            )   et                                                                                                                                       \
            where e.id=et.code_eqp                                                                                                                       \
           )                                                                                                                                             \
       ) as e                                                                                                                                            \
     ) as e left join adv_address_tbl adr on adr.id=e.id_addres, \
 (select pp.*,v.voltage_min as name_voltage,tg.value_r, cla.name as extra_name from  \
       (select p.*,t.id_grouptarif,t.name as tarif,clt.name as class \
        from eqm_point_tbl as p,aci_tarif_tbl as t,eqi_classtarif_tbl as clt  \
           where p.id_tarif=t.id and t.id_classtarif=clt.id                                                                                              \
        ) pp left join eqk_tg_tbl tg on pp.id_tg=tg.id \
         left join eqk_voltage_tbl v on pp.id_voltage=v.id         \
         left join cla_param_tbl as cla on (pp.id_extra=cla.id )    \
  ) as pp,                                                                                                                                               \
( select p.*,z.energy,z.name_zone as zone from eqv_pnt_met   p   full join \
   (select e.*,k.name as energy,z.name as name_zone  from eqd_meter_zone_tbl e ,  \
eqk_energy_tbl k,eqk_zone_tbl z where e.kind_energy=k.id and   e.zone=z.id and  dt_begin<=now()   \
   order by e.code_eqp) as z on z.code_eqp=p.id_meter \                                                                                                                             \
) ep,                                                                                                                                                    \
(select cc.id,cc.code,cc.short_name as name_client from clm_client_tbl cc   ) as cp                                                                       \
where ep.id_point=e.id and e.id_client=cp.id   and pp.code_eqp=ep.id_point                                                      \
  and pb.id_point=ep.id_point  and cp.id=:client                                                                                                                           \
order by cp.code ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  //ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["labon"]->Value = edAbonName->Text;


  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::ShowIndicDates(TDateTime mmgg)
{
  AnsiString  sqlstr1=" SELECT clm.id, clm.short_name as name, clm.code, cp.represent_name, cp2.represent_name as executor, scl.phone, \
  to_char(to_date(substr( sel_dt(clm.id,date_trunc('month',:mmgg::::date)::::date),12),'yyyy.mm.dd'),'DD.MM.YYYY') as dayx \
  FROM clm_client_tbl as clm \
  left join clm_statecl_h as scl on (clm.id = scl.id_client) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  left join clm_position_tbl as cp2 on (scl.id_kur=cp2.id) \
  where clm.book=-1 and clm.idk_work not in (0,99) and coalesce(clm.id_state,0) not in (50,99,3) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and scl.id_section not in (205,206,207,208) and scl.dt_end_rent is null \
  and to_char(:mmgg::::date,'YYYY-MM')=substr( sel_dt(clm.id,date_trunc('month',:mmgg::::date)::::date),12,7) \
  and ( :insp is null or scl.id_position = :insp) \
  and ( :exec is null or scl.id_kur = :exec) \
  order by dayx, clm.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  if (ExecutorId!=0)
     ZQXLReps->ParamByName("exec")->AsInteger=ExecutorId;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";

  AnsiString linsp = "" ;

  if (InspectorId!=0)
    linsp = "Iнспектор "+edInspector->Text;

  if (ExecutorId!=0)
    linsp = linsp+" технік по розрахункам "+edExecutor->Text;

  xlReport->ParamByName["linsp"]->Value = linsp;

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::PrintLetterForGor(int client)
{
  AnsiString  sqlstr1=" select c.name, c.short_name, c.code, scl.doc_num,scl.doc_dat,scl.day_pay_bill, dir.posname, \
  dir.represent_name,dir.last_name||' '||dir.first_name||' '||dir.father_name as dir_name,scl.doc_ground \
  from clm_client_tbl as c \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  left join \
  (select p.id_client, p.id_position,p.represent_name,p.last_name,p.first_name,p.father_name,ip.name as posname \
   from  clm_position_tbl as p join cli_position_tbl as ip \
   on (ip.id = p.id_position) ) as dir on (dir.id_client = c.id) \
  where scl.id_section not in (205,206,207,208) and c.idk_work not in (0,99) \
  and coalesce(c.id_state,0) not in (50,99) and c.book=-1 and (c.id = :client or :client = 0);";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
 /*
  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
*/

  xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------
void __fastcall TfReports::SpeedButton1Click(TObject *Sender)
{
 AbonId=0;
 edAbonName->Text="";
 edAbonCode->Text="";
}
//---------------------------------------------------------------------------
void TfReports::CountRep2(void)
{
    // отчет о количестве абонентов, запрошен в 12.2005 сбытом
   AnsiString  sqlstr;

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_c2_fun( :dtb, :dte);");
    ZQReps->ParamByName("dtb")->AsDateTime=dtBegin->Date;
    ZQReps->ParamByName("dte")->AsDateTime=dtEnd->Date;

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }


  AnsiString  sqlstr1="  select * from \
  (select sum(case when avg_demand >=10000000 then 1 else 0 end) as v10m, \
   sum(case when avg_demand >=1000000 then 1 else 0 end) as v1m, \
   sum(case when avg_demand >=50000 then 1 else 0 end) as v50k, \
   sum(case when avg_demand >=0 then 1 else 0 end ) as other \
   from rep_avr_demand_tbl) as s_dem, \
  (select \
   sum(case when sum_power >=750 then 1 else 0 end) as c750, \
   sum(case when sum_power >=550 and sum_power< 750 then 1 else 0 end) as c550, \
   sum(case when sum_power >=150 and sum_power< 550 then 1 else 0 end) as c150 \
   from \
   (select distinct a.code_eqp, sum(p.power::::numeric) as sum_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqm_point_tbl as p on (p.code_eqp = ins.code_eqp) \
    where a.id_client <> syi_resid_fun() \
    and eq.type_eqp=11 \
    and not exists( \
     select distinct c2.code_eqp \
     from eqm_compens_station_inst_tbl as ins2 \
     join eqm_compensator_tbl as c2 on (c2.code_eqp = ins2.code_eqp) \
     where ins2.code_eqp_inst = a.code_eqp ) \
    group by a.code_eqp \
    having sum(p.power::::numeric) >=150 \
    union \
    select a.code_eqp, sum(eqi.power_nom::::numeric) as sum_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    where a.id_client <> syi_resid_fun() \
    and eq.type_eqp=11 \
    group by a.code_eqp \
  ) as c_power \
 ) as s_power ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
//  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
 // Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="dtb";
  Param=xlReport->Params->Add();
  Param->Name="dte";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["dtb"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["dte"]->Value = FormatDateTime("mmmm yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------
void TfReports::ObSaldoErr(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по потребителям
  AnsiString  sqlstr1="  select obr.osob_r,obr.osob_rsk as abon_name, \
     nar, nar_v,opl_zv, nar_pdv as nar_n, opl_zpdv as opl_n, \
     -deb_zpmv as deb, kr_zpmv, - deb_pm99v as deb99 ,- deb_pm00v as deb00, - deb_pm01v as deb01,- deb_pm02v as  deb02, \
     -deb_pm03v  as deb03,-deb_pm04v as deb04, \
     -deb_pm05v as deb05, -deb_pm06v as deb06, -deb_pm07v as deb07,-deb_pm08v as deb08, -deb_pm09v as deb09, -deb_pm10v as deb10, -deb_pm11v as deb11, -deb_pm12v as deb12, \
     -deb_pm13v as deb13, -deb_pm14v as deb14, \
     -deb_kmv as deb_k,kr_zkmv, - deb_km99v as deb99_k ,- deb_km00v as deb00_k, - deb_km01v as deb01_k,- deb_km02v as  deb02_k, \
     -deb_km03v  as deb03_k,- deb_km04v as deb04_k, \
     -deb_km05v as deb05_k, - deb_km06v as deb06_k, - deb_km07v as deb07_k,- deb_km08v as deb08_k, - deb_km09v as deb09_k, - deb_km10v as deb10_k, -deb_km11v as deb11_k, -deb_km12v as deb12_k, \
     -deb_km13v as deb13_k, -deb_km14v as deb14_k, \
     -deb_zpmpdv as debn, kr_zpmpdv as kr_zpmn, - deb_pm00pdv as deb00n, - deb_pm01pdv as deb01n,- deb_pm02pdv as  deb02n, \
     -deb_pm03pdv  as deb03n,- deb_pm04pdv as deb04n, \
     -deb_pm05pdv as deb05n, - deb_pm06pdv as deb06n, - deb_pm07pdv as deb07n,- deb_pm08pdv as deb08n, - deb_pm09pdv as deb09n, - deb_pm10pdv as deb10n, -deb_pm11pdv as deb11n, -deb_pm12pdv as deb12n, \
     -deb_pm13pdv as deb13n, -deb_pm14pdv as deb14n, \
     -deb_kmpdv as deb_kn,kr_zkmpdv as kr_zkmn, - deb_km00pdv as deb00_kn, - deb_km01pdv as deb01_kn,- deb_km02pdv as deb02_kn, \
     -deb_km03pdv  as deb03_kn,- deb_km04pdv as deb04_kn, \
     -deb_km05pdv as deb05_kn, - deb_km06pdv as deb06_kn, - deb_km07pdv as deb07_kn,- deb_km08pdv as deb08_kn, - deb_km09pdv as deb09_kn, - deb_km10pdv as deb10_kn, -deb_km11pdv as deb11_kn,-deb_km12pdv as deb12_kn, \
     -deb_km13pdv as deb13_kn, -deb_km14pdv as deb14_kn, \
     CASE WHEN (-deb_kmv = kr_zkmv) and (((kr_zkmpdv = 0) and (deb_kmv<>0)) or ((kr_zkmpdv<> 0) and (deb_kmv=0)) \
      or ((kr_zkmv = 0) and (deb_kmpdv<>0)) or ((kr_zkmv<> 0) and (deb_kmpdv=0)) or (kr_zkmv<>-deb_kmv)or (kr_zkmpdv<>-deb_kmpdv)) \
        THEN 'Несоответствие НДС начисления и оплаты' END as error \
     from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
     and ((-deb_kmv = kr_zkmv) and (((kr_zkmpdv = 0) and (deb_kmv<>0)) or ((kr_zkmpdv<> 0) and (deb_kmv=0)) \
      or ((kr_zkmv = 0) and (deb_kmpdv<>0)) or ((kr_zkmv<> 0) and (deb_kmpdv=0))or ((kr_zkmv<> 0) and (deb_kmv=0))or (kr_zkmv<>-deb_kmv)or (kr_zkmpdv<>-deb_kmpdv))) \
     order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
// Dsr = xlReport->DataSources->Add();
//  Dsr->DataSet = ZQXLRepsSum;
//  Dsr->Alias =  "ZQXLRepsSum";
//  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
//  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());



  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);


  if (kind_energy==0)
  {
    xlReport->ParamByName["caption"]->Value = "Помилки оборотної відомістї (активна електроенергія)";
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";
  }
  if (kind_energy==1)
  {
    xlReport->ParamByName["caption"]->Value = "Помилки оборотної відомістї (реактивна електроенергія)";
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  }

  if (kind_energy==2)
  {
    xlReport->ParamByName["caption"]->Value = "Помилки оборотної відомістї (2-кр потужності)";
    xlReport->ParamByName["demcaption"]->Value = "кВт";
  }
  if (kind_energy==3)
  {
    xlReport->ParamByName["caption"]->Value = "Помилки оборотної відомістї (2-кр споживання)";
    xlReport->ParamByName["demcaption"]->Value = "кВтг";
  }
  if (kind_energy==4)
  {
    xlReport->ParamByName["caption"]->Value = "Помилки оборотної відомістї (2-кр споживання 2014)";
    xlReport->ParamByName["demcaption"]->Value = "кВтг";
  }


  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::ShowRentDates(TDateTime mmgg)
{
  AnsiString  sqlstr1=" SELECT clm.id, clm.short_name as name, clm.code, rh.name_object, rh.dt_rent_end \
  FROM clm_client_tbl as clm \
  left join clm_statecl_h as scl on (clm.id = scl.id_client) \
  left join clm_renthist_tbl as rh on (clm.id = rh.id_client) \
  where clm.book=-1 and clm.idk_work not in (0,99) and coalesce(clm.id_state,0) not in ( 50,99) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and scl.id_section not in (205,206,207,208) \
  and date_trunc('month',:mmgg::::date) = date_trunc('month',rh.dt_rent_end) \
  order by rh.dt_rent_end, clm.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::CountRep2_1(void)
{
    // перечень абонентов, потребление субабонентов которых более 50000 
   AnsiString  sqlstr;

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_c3_fun( :dtb, :dte);");
    ZQReps->ParamByName("dtb")->AsDateTime=dtBegin->Date;
    ZQReps->ParamByName("dte")->AsDateTime=dtEnd->Date;

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }


  AnsiString  sqlstr1="  select c.code, c.short_name, avr.avg_demand from \
  rep_avr_demand_tbl as avr join clm_client_tbl as c on (c.id = avr.id_client) \
  where avg_demand >=50000 order by avg_demand desc; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="dtb";
  Param=xlReport->Params->Add();
  Param->Name="dte";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["dtb"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["dte"]->Value = FormatDateTime("mmmm yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------

void TfReports::Print4NKRE(TDateTime mmgg,boolean Build)
{
  AnsiString sqlstr;

  ZQReps->Close();
  ZQReps->Sql->Clear();

  if (mmgg < TDateTime(2012,10,1))
  {
      ZQReps->Sql->Add("select rep_4nkre_fun( :mmgg , 0);");
  }
  else
  {
      ZQReps->Sql->Add("select rep_4nkre2012_fun( :mmgg , 0);");
  }


  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  AnsiString  sqlstr1;

  if (mmgg < TDateTime(2012,10,1))
  {
    sqlstr1=" select * from  rep_4nkre_tbl ;";
    ZQXLReps->Sql->Add(sqlstr1);
  }
  else
  {
    sqlstr1=" select * from  rep_4nkre2012_tbl where mmgg = :mmgg ;";
    ZQXLReps->Sql->Add(sqlstr1);
    ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  }



  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  if (mmgg >= TDateTime(2012,10,1))
  {
   xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  }
  else
  {
   xlReport->XLSTemplate = "XL\\4nkre_old.xls";
  }

  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg2";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["lmmgg2"]->Value = "Звітні (фактичні) дані за звітний місяць \n "+ FormatDateTime("mmmm yyyy",mmgg)+" року";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::ShowSwitching(void)
{
  AnsiString  sqlstr1="select c.id,c.code,c.short_name as name,s.dt_action,s.action,s.comment, \
  case when s.action =1 then 'Відключений ' when s.action =2 then 'Попереджений ' when s.action =5 then 'Попереджений (аванс)' \
   when s.action =3 then 'Підключений ' when s.action =4 then 'Оплатив' end as status,  cp.represent_name, \
   s.dt_warning, s.place_off, s.percent, s.sum_warning, s.dt_transmiss, s.mode_transmiss,s.sum_ae, s.sum_re, s.sum_2kr \
  from clm_client_tbl c \
  left join clm_statecl_h as scl on (c.id = scl.id_client) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  join \
  ( select s.id_client,s.action,s.dt_action,s.comment, \
    s.dt_warning, s.place_off, s.percent, s.sum_warning, s.dt_transmiss, s.mode_transmiss,s.sum_ae, s.sum_re, s.sum_2kr \
    from clm_switching_tbl as s \
    where s.dt_action=( select max(i.dt_action) from clm_switching_tbl as i \
    where i.id_client=s.id_client) \
   ) as s on (c.id=s.id_client) \
  where ( :insp is null or scl.id_position = :insp) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;
  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
//  Param->Name="lmmgg";
//  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::PrintMeterNoIndication( TDateTime dtb,TDateTime dte)
{
  ZQXLReps->Sql->Clear();

  AnsiString sqlstr = " select distinct c.id, c.code, c.short_name as name, eq.name_eqp, eq.num_eqp, m.id_type_eqp, eq.dt_install,   cp.represent_name, cp2.represent_name as point_inspector \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (ttr.code_eqp = m.code_eqp) \
    join eqm_meter_point_h as mp on (mp.id_meter = m.code_eqp and mp.dt_e is null) \
    join eqm_point_tbl as p on (mp.id_point = p.code_eqp ) \
    left join  eqm_eqp_use_tbl as use on (use.code_eqp = m.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_h as scl on (c.id = scl.id_client) \
    left join clm_position_tbl as cp on (scl.id_position=cp.id) \
    left join clm_position_tbl as cp2 on (p.id_position=cp2.id) \
    where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99,3) and c.book=-1 \
    and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date ) ) \
    and scl.id_section not in (205,206,207,208) \
    and ( :insp is null or scl.id_position = :insp) \
    and not exists \
    (select  h.id_client \
     from acm_headindication_tbl as h join acd_indication_tbl as i on (h.id_doc =i.id_doc) \
     where idk_document = 310 and h.reg_date <=:dte and h.reg_date >= :dtb \
     and h.id_client = c.id and i.num_eqp = eq.num_eqp and (i.value is not null and i.value <>0) \
     order by  c.code ) ;";

  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintMetersList(void)
{
/*
    join (select e.*,p.name as phasename,t.name as ind_el  \

             from eqi_meter_tbl e, eqk_phase_tbl p,eqk_meter_tbl t  \
              where e.phase=p.id and e.kind_meter=t.id\
          ) as im on (im.id = m.id_type_eqp) \
*/
/*
     left join \
      ( select m.id,type,t.name as kind,phase,p.name as phasen,pr.cl,term_control \
         from eqi_meter_tbl m                                                              \
         left join  eqi_meter_prec_tbl pr on pr.id_type_eqp=m.id                            \
          ,eqk_meter_tbl t,eqk_phase_tbl p                                                  \
         where m.kind_meter=t.id and m.phase=p.id order by m.id    \
      ) mcl on mcl.id=m.id_type_eqp                     \

*/

  AnsiString  sqlstr1="select c.id, c.short_name, c.code, \
     case when (c.id_state=3 or c.id_state=50 or c.id_state=99 ) then 1 else 0 end as id_state, \
     sss.name as name_state,  \
     coalesce(pp.disabled,0) as disabled,\
  m.code_eqp, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control,pim.name as phasename,tim.name as ind_el, im.zones, im.amperage_nom,\
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    sc.phone,cp.represent_name,pr.cl, adr.adr, sti.tt_type, sti.koef_i, stu.tu_type,stu.koef_u, sti.date_check as date_check_i, stu.date_check as date_check_u, \
    sti.num_eqp as num_sti, stu.num_eqp as num_stu, eqpps.name_eqp as  name_ps, \
    CASE WHEN coalesce(eq.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner, pp.code_eqp as id_point, pp.power,  pp.disabled, \
    CASE WHEN m.magnet = 1 THEN 'Установлен' ELSE '' END as magnet_str , cla.name as section, \
    CASE WHEN sti.is_owner is null THEN '' WHEN coalesce(sti.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_sti, \
    CASE WHEN stu.is_owner is null THEN '' WHEN coalesce(stu.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_stu, \
    kv.voltage_min as voltage, \
    CASE WHEN pp.id_un = 4 THEN pp.power/0.554 ELSE pp.power/13.84 END as calc1, \
    CASE WHEN sti.amperage_nom is not null and coalesce(pp.power,0) <>0 and sti.amperage_nom::::numeric/(CASE WHEN pp.id_un = 4 THEN pp.power/0.554 ELSE pp.power/13.84 END) > 1.6 THEN \
        sti.amperage_nom::::numeric/(CASE WHEN pp.id_un = 4 THEN pp.power/0.554 ELSE pp.power/13.84 END) ELSE null END as calc2, \
        p20.value as param20,p21.value as param21,p22.value as param22,p23.value as param23,p24.value as param24,p25.value as param25,p26.value as param26,p27.value as param27 \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqk_phase_tbl as pim on (im.phase=pim.id) \
    join eqk_meter_tbl as tim on (im.kind_meter=tim.id) \
    left join eqi_meter_prec_tbl pr on (pr.id_type_eqp=im.id )  \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join cli_state_tbl as sss on (sss.id=c.id_state) \
    left join clm_statecl_h as sc on (c.id = sc.id_client) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_point_tbl as pp on (pp.code_eqp = mp.id_point ) \
    left join bal_abons_tbl as ba on (ba.id_point = pp.code_eqp ) \
    left join eqm_equipment_tbl as eqpps on (ba.id_grp = eqpps.id) \
    left join eqm_equipment_tbl as eqpp on (mp.id_point = eqpp.id) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join eqk_voltage_tbl as kv on (kv.id = pp.id_un) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, ic.amperage_nom, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 20 order by code_eqp) as p20 on (pp.code_eqp = p20.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 21 order by code_eqp) as p21 on (pp.code_eqp = p21.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 22 order by code_eqp) as p22 on (pp.code_eqp = p22.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 23 order by code_eqp) as p23 on (pp.code_eqp = p23.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 24 order by code_eqp) as p24 on (pp.code_eqp = p24.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 25 order by code_eqp) as p25 on (pp.code_eqp = p25.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 26 order by code_eqp) as p26 on (pp.code_eqp = p26.code_eqp)\
   left join (select code_eqp, value from mnm_eqp_params_tbl where id_param = 27 order by code_eqp) as p27 on (pp.code_eqp = p27.code_eqp)\
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
    order by c.code, eq.num_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

//  Param=xlReport->Params->Add();
//  Param->Name="lperiod";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";

  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::MetersControlNow( TDateTime dtb,TDateTime dte)
{
  AnsiString  sqlstr1="select c.id, c.short_name, c.code,m.code_eqp, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control, \
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    sc.phone,cp.represent_name \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_h as sc on (c.id = sc.id_client) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :dtb::::date ) ) \
    and dt_control is not null and (dt_control + (text(im.term_control)||' year')::::interval) between :dtb and :dte \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and coalesce(pp.disabled,0) =0 \
    order by c.code, eq.num_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
   ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="lperiod";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";

  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------

void TfReports::MetersControlLate( TDateTime dt)
{

   AnsiString sqlstr=" select (:dt::::date + '32 days'::::interval)::::date as last_date, \
    CASE when (select holiday from calendar where c_date = (:dt::::date + '33 days'::::interval)) = true \
        THEN calend_dt_inc((:dt::::date + '33 days'::::interval)::::date,1) ELSE (:dt::::date + '33 days'::::interval)::::date END as off_date ;";

     ZQReps->Close();
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("dt")->AsDateTime=dt;

     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

    TDateTime last_date = ZQReps->FieldByName("last_date")->AsDateTime;
    TDateTime off_date = ZQReps->FieldByName("off_date")->AsDateTime;


    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();

  AnsiString sqlstr1 =" select ssss.*,   \
case when ssss.id_voltage in (1,2) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";



  sqlstr1=sqlstr1+"select c.id, c.short_name, c.name,c.code,   \
     case when (c.id_state=3 or c.id_state=50 or c.id_state=99 ) then 1 else 0 end as id_state, \
     sss.name as name_state,  \
     coalesce(pp.disabled,0) as disabled, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control, \
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    sc.phone,cp.represent_name , adr.adr , adr_c.adr as adr_abon, phones.pos_phones, town.name as city , \
    CASE WHEN im.phase =1 then 1 WHEN im.phase =2 then 3 END as phase , \
    rq.dt_work, rq.requirement_text, rq.requirement_date, \
    cla.name as groupname, coalesce(koef_u,1)* coalesce(koef_i,1) as k_tr, id_grp as link \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_equipment_tbl as eq2 on (mp.id_point = eq2.id) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    left join bal_abons_tbl as ba on (ba.id_point = mp.id_point) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = mp.id_point) \
    left join ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i from \
     eqm_compensator_i_tbl as c \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u from \
     eqm_compensator_i_tbl as c \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join cli_state_tbl as sss on (sss.id=c.id_state) \
    left join clm_statecl_h as sc on (c.id = sc.id_client) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join adv_address_tbl as adr on (adr.id = eq2.id_addres) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (c.id = phones.id_client) \
    left join adv_address_tbl as adr_c on (adr_c.id = c.id_addres) \
    left join adi_town_tbl as town on (town.id = adr_c.id_town) \
    left join (  select w.id , w.id_point, w.dt_work, w.requirement_text, w.requirement_date \
         from clm_works_tbl as w join \
         (select id_point, max(dt_work) as dt_work from clm_works_tbl \
          where id_type = 8 and requirement_ok_date is null \
          group by id_point ) as ww on (w.id_point = ww.id_point and w.dt_work = ww.dt_work ) \
    where id_type = 8 and requirement_ok_date is null and w.dt_work >= '2013-01-01'::::date) as rq on (rq.id_point = mp.id_point) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
    and dt_control is not null and (dt_control + (text(im.term_control)||' year')::::interval) <= :dt \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)  \
    and lp.id_point is null and coalesce(pp.disabled,0) =0 ";


   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  order by code,num_eqp " ;


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="llast_date";
  Param=xlReport->Params->Add();
  Param->Name="loff_date";

  Param=xlReport->Params->Add();
  Param->Name="lresname";
  Param=xlReport->Params->Add();
  Param->Name="lresshortname";
  Param=xlReport->Params->Add();
  Param->Name="lresaddr";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";

  xlReport->ParamByName["lresname"]->Value = ResName;
  xlReport->ParamByName["lresaddr"]->Value = ResAddr+" тел. "+ResPhone;
  xlReport->ParamByName["lresshortname"]->Value = ResName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  AnsiString BossName2 =BossName;
  int space_pos =AnsiPos(" ",BossName);
  if(space_pos!=0)
  {
    BossName2 = BossName.SubString(space_pos+1,10)+" "+ BossName.SubString(1,space_pos);
  }
  xlReport->ParamByName["bossname"]->Value = BossName2;

  //отдельные случаи для МЕМ и Нежина
  switch ( res_code ) {
  case 310 :
    xlReport->ParamByName["lresname"]->Value = "ЧЕРНІГІВСЬКІ   МІСЬКІ   ЕЛЕКТРИЧНІ   МЕРЕЖІ";
    xlReport->ParamByName["lresaddr"]->Value = "14038, м. Чернігів, Деснянський район,  проспект Перемоги, 126, тел 654-426, факс 654-496";
    xlReport->ParamByName["lresshortname"]->Value = " ЧнМЕМ.";
    xlReport->ParamByName["bospos"]->Value = "Директор ЧнМЕМ";
   break;
  case 210 :
    xlReport->ParamByName["lresname"]->Value = "НІЖИНСЬКИЙ РАЙОН ЕЛЕКТРИЧНИХ МЕРЕЖ";
    xlReport->ParamByName["lresshortname"]->Value = " Ніжинського РЕМ.";
//    xlReport->ParamByName["bospos"]->Value = "Директор Ніжинського РЕМ";
    xlReport->ParamByName["bossname"]->Value = BossName;
   break;
  };

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["llast_date"]->Value = FormatDateTime("dd.mm.yyyy",last_date);
  xlReport->ParamByName["loff_date"]->Value = FormatDateTime("dd.mm.yyyy",off_date);

  xlReport->ParamByName["ldt"]->Value = FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------

void TfReports::Prognoz(TDateTime mmgg)
{

   AnsiString sqlstr;

   sqlstr=" select seb_plan_rep((date_trunc('month', :mmgg::::date))::::date)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }


  // по категориям
  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (select coalesce(obr.id_section,999) as link, sum(ym13) as ym13, \
     sum(ym12) as ym12, sum(ym11) as ym11,  sum(ym10) as ym10, sum(ym03) as ym03, \
     sum(ym02) as ym02, sum(ym01) as ym01, sum(ym_plan) as ym_plan, \
     sum(s31) as s31, sum(s30) as s30, \
     sum(round(ym10*(CASE WHEN s31 =0 THEN 0 ELSE round(s30::::numeric/s31::::numeric*100,2) END )::::numeric/100,0)) as calc_demand \
     from seb_plan_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     join clm_statecl_h as sc on (c.id = sc.id_client) \
     where obr.mmgg = :mmgg and c.idk_work <>99  and  coalesce(obr.id_section,999) not in (206,207,209) \
     and ((sc.id_position = :insp) or ( :insp is null) ) \
     and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     ";

//     where obr.mmgg = :mmgg and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) ";

  if (cbNoKey->Checked)
     sqlstr2=sqlstr2+ " and sc.flag_key =0 ";

  sqlstr2=sqlstr2+ " group by obr.id_section )as sss \
     join cla_param_tbl as cla on (sss.link = cla.id and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;


  // по потребителям
    AnsiString  sqlstr1="  select coalesce(obr.id_section,999) as link ,c.code,c.short_name, p.represent_name,\
     ym13,ym12,ym11,ym10,ym01,ym02,ym03,s30,s31,ym_plan \
     from seb_plan_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     join clm_statecl_h as sc on (c.id = sc.id_client) \
     left join clm_position_tbl p on (sc.id_position=p.id ) \
     where obr.mmgg = :mmgg  and  coalesce(obr.id_section,999) not in (206,207,209) \
     and ((sc.id_position = :insp) or ( :insp is null) ) \
     and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
      and (( c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)) \
     or ((c.idk_work = 0 or coalesce(c.id_state,0) in (50,99)) and (coalesce(ym13+ym12+ym11+ym10+ym01+ym02+ym03+ym_plan,0) <>0 ))) ";


  if (cbNoKey->Checked)
     sqlstr1=sqlstr1+ " and sc.flag_key =0 ";

  sqlstr1=sqlstr1+ " order by c.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lkey";


  Param=xlReport->Params->Add();
  Param->Name="lm3y1";
  Param=xlReport->Params->Add();
  Param->Name="lm3y0";
  Param=xlReport->Params->Add();
  Param->Name="lm2y1";
  Param=xlReport->Params->Add();
  Param->Name="lm2y0";
  Param=xlReport->Params->Add();
  Param->Name="lm1y1";
  Param=xlReport->Params->Add();
  Param->Name="lm1y0";
  Param=xlReport->Params->Add();
  Param->Name="lm0y1";
  Param=xlReport->Params->Add();
  Param->Name="lsum1";
  Param=xlReport->Params->Add();
  Param->Name="lsum0";
  Param=xlReport->Params->Add();
  Param->Name="ldiv3";
  Param=xlReport->Params->Add();
  Param->Name="ldiv2";
  Param=xlReport->Params->Add();
  Param->Name="ldiv1";
  Param=xlReport->Params->Add();
  Param->Name="ldivy";
  Param=xlReport->Params->Add();
  Param->Name="ldiv23";
  Param=xlReport->Params->Add();
  Param->Name="ldiv12";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "на " +FormatDateTime("mmmm yyyy",mmgg);

  AnsiString skey = "";

  if (InspectorId!=0)
    skey=edInspector->Text;

  if (cbNoKey->Checked)
    skey=skey+ " ,без ключових ";

  xlReport->ParamByName["lkey"]->Value = skey;

  sqlstr=" select (date_trunc('month', :mmgg::::date))::::date - '1 year 3 month'::::interval as ym13, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year 2 month'::::interval as ym12, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year 1 month'::::interval as ym11, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year'::::interval as ym10, \
  (date_trunc('month', :mmgg::::date))::::date - '3 month'::::interval as ym03, \
  (date_trunc('month', :mmgg::::date))::::date - '2 month'::::interval as ym02, \
  (date_trunc('month', :mmgg::::date))::::date - '1 month'::::interval as ym01; ";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->Open();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->ParamByName["lm3y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym13")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm3y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym03")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm2y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym12")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm2y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm1y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym11")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm1y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym01")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm0y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym10")->AsDateTime)+ ", кВт.г.";

  xlReport->ParamByName["ldiv3"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym13")->AsDateTime);
  xlReport->ParamByName["ldiv2"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym12")->AsDateTime);
  xlReport->ParamByName["ldiv1"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym11")->AsDateTime);

  xlReport->ParamByName["lsum1"]->Value = "3 міс. "+FormatDateTime("yyyy",ZQReps->FieldByName("ym11")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lsum0"]->Value = "3 міс. "+FormatDateTime("yyyy",mmgg)+ ", кВт.г.";

  xlReport->ParamByName["ldivy"]->Value = "% 3 міс. "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy",ZQReps->FieldByName("ym11")->AsDateTime);

  xlReport->ParamByName["ldiv23"]->Value = "% "+FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym03")->AsDateTime);
  xlReport->ParamByName["ldiv12"]->Value = "% "+FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym01")->AsDateTime)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime);

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";

 ZQReps->Close();
 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbPSClClick(TObject *Sender)
{
 PSId = 0;
 PSVolt =0;
 edPSName->Text ="";
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbPSClick(TObject *Sender)
{
  TWTQuery *QueryAdr;
  QueryAdr = new  TWTQuery(this);
  TZDatasetOptions Options;
  Options=QueryAdr->Options;
  Options << doQuickOpen;
  QueryAdr->Options=Options;

  QueryAdr->Sql->Clear();

  QueryAdr->Sql->Add("select eq.id, eq.name_eqp,eqk.voltage_max from eqm_equipment_tbl as eq ");
  QueryAdr->Sql->Add("join eqm_compens_station_tbl as cs on (eq.id = cs.code_eqp) ");
  QueryAdr->Sql->Add("join eqk_voltage_tbl as eqk on (eqk.id = cs.id_voltage) ");
  QueryAdr->Sql->Add("where eq.type_eqp = 8 order by eq.name_eqp; ");
//  QueryAdr->Sql->Add("where eq.type_eqp = 8 and eqk.voltage_max in (10,6,3)  order by eq.name_eqp; ");

  WPSGrid = new TWTWinDBGrid(this, QueryAdr,false);
  WPSGrid->SetCaption("Подстанции");

  TWTQuery* Query = WPSGrid->DBGrid->Query;

  Query->Open();

  TStringList *WList=new TStringList();
  WList->Add("id");

  TStringList *NList=new TStringList();
  NList->Add("id");

  QueryAdr->SetSQLModify("eqm_equipment_tbl",WList,NList,false,false,false);
  TWTField *Field;

//  Field = WFiderGrid->AddColumn("kindname", "Тип", "Тип");
  Field = WPSGrid->AddColumn("name_eqp", "Наименование", "Наименование");
  Field = WPSGrid->AddColumn("voltage_max", "Рівень напруги", "Рівень напруги");

  WPSGrid->DBGrid->FieldSource = WPSGrid->DBGrid->Query->GetTField("id");

  WPSGrid->DBGrid->StringDest = "-1";
  WPSGrid->DBGrid->OnAccept=PSAccept;
  WPSGrid->DBGrid->Visible = true;
  WPSGrid->DBGrid->ReadOnly=true;
  WPSGrid->ShowAs("Выбор ПС");

}
//---------------------------------------------------------------------------
void __fastcall TfReports::PSAccept (TObject* Sender)
{
   PSId =WPSGrid->DBGrid->Query->FieldByName("id")->AsInteger;
   PSVolt =WPSGrid->DBGrid->Query->FieldByName("voltage_max")->AsFloat;   
   edPSName->Text =WPSGrid->DBGrid->Query->FieldByName("name_eqp")->AsString;
}
//---------------------------------------------------------------------------
void TfReports::PrintPSAbons(boolean Build)
{

  if (Build)
  {

   if(MessageDlg("Переформировать данные о подключении абонентов?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
  }


  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(" select * from ");
  ZQXLReps->Sql->Add(" (select 0 as sort, c.code,c.short_name, eq.name_eqp, ba.num_meter, coalesce(id_grp,-1) as link, p.power, p.power as power_roz,p.safe_category, stcl.phone,stcl.doc_dat ");
  ZQXLReps->Sql->Add(" from bal_abons_tbl as ba ");
  ZQXLReps->Sql->Add(" join clm_client_tbl as c on (c.id = ba.id_client) ");
  ZQXLReps->Sql->Add(" join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) ");
  ZQXLReps->Sql->Add(" join eqm_equipment_tbl as eq on (eq.id = ba.id_point) ");
  ZQXLReps->Sql->Add(" join eqm_point_tbl as p on (p.code_eqp = ba.id_point) ");
  ZQXLReps->Sql->Add(" left join rep_lighting_points_tmp as lp on (lp.id_point = ba.id_point) ");
//  ZQXLReps->Sql->Add(" where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and (id_grp = :grp or :grp =0 ) and ba.id_p_point is null  and p.reserv=0) as prom");
  ZQXLReps->Sql->Add(" where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and (id_grp = :grp or :grp =0 )  and p.reserv=0 and lp.id_point is null ) as prom");
  ZQXLReps->Sql->Add(" union all ");
  ZQXLReps->Sql->Add(" select -3,0, fiz1.short_name, '',fiz1.cnt::::varchar,fiz1.link,fiz1.power,  ((fiz1.power-0.58*fiz1.cnt)*coalesce(cf.val,0.005) + 0.58*fiz1.cnt) as power_roz,null,null,null from ");
  ZQXLReps->Sql->Add(" ( select '- Населення '::::varchar as short_name, count(distinct ba.id_client) as cnt,  coalesce(id_grp,-1) as link, sum( c.set_power) as power ");
  ZQXLReps->Sql->Add(" from bal_abons_tbl as ba  ");
  ZQXLReps->Sql->Add(" join clm_pclient_tbl as c on (c.id = ba.id_client)  ");
//  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and ba.id_p_point is null and coalesce(c.cod_tarif,0) not in (37,48) and coalesce(c.cod_zone,0)=0 ");
  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and coalesce(c.cod_tarif,0) not in (37,48) and coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 ");
  ZQXLReps->Sql->Add(" group by coalesce(id_grp,-1) ) as fiz1 ");
  ZQXLReps->Sql->Add(" left join bal_fizabon_coef_tbl as cf on (cf.type = 1 and cf.cnt = fiz1.cnt  ) ");

  ZQXLReps->Sql->Add(" union all ");
  ZQXLReps->Sql->Add(" select -2,0, fiz2.short_name, '',fiz2.cnt::::varchar,fiz2.link,fiz2.power,  ((fiz2.power-1.31*fiz2.cnt)*coalesce(cf.val,0.001) + 1.31*fiz2.cnt) as power_roz,null,null,null from  ");
  ZQXLReps->Sql->Add(" ( select '- Населення (електроплити)'::::varchar as short_name, count(distinct ba.id_client) as cnt,  coalesce(id_grp,-1) as link, sum( c.set_power) as power  ");
  ZQXLReps->Sql->Add(" from bal_abons_tbl as ba  ");
  ZQXLReps->Sql->Add(" join clm_pclient_tbl as c on (c.id = ba.id_client)  ");
//  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and ba.id_p_point is null and coalesce(c.cod_tarif,0) =37 and coalesce(c.cod_zone,0)=0 ");
  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and coalesce(c.cod_tarif,0) =37 and coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 ");
  ZQXLReps->Sql->Add(" group by coalesce(id_grp,-1) ) as fiz2 ");
  ZQXLReps->Sql->Add(" left join bal_fizabon_coef_tbl as cf on (cf.type = 2 and cf.cnt = fiz2.cnt  ) ");

  ZQXLReps->Sql->Add(" union all ");
  ZQXLReps->Sql->Add(" select -1,0, '- Населення (електроопалення)'::::varchar as short_name, '', count(distinct ba.id_client)::::varchar,  coalesce(id_grp,-1) , sum( c.set_power) , sum( c.set_power), null,null,null ");
  ZQXLReps->Sql->Add(" from bal_abons_tbl as ba  ");
  ZQXLReps->Sql->Add(" join clm_pclient_tbl as c on (c.id = ba.id_client)  ");
//  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and ba.id_p_point is null and coalesce(c.cod_tarif,0) =48 and coalesce(c.cod_zone,0)=0 ");
  ZQXLReps->Sql->Add(" where (id_grp = :grp or :grp =0 ) and coalesce(c.cod_tarif,0) =48 and coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 ");
  ZQXLReps->Sql->Add(" group by coalesce(id_grp,-1)  ");

  ZQXLReps->Sql->Add(" order by link,sort,code,name_eqp; ");

  if (PSVolt <=10)
    ZQXLReps->ParamByName("grp")->AsInteger=PSId;
  else
    ZQXLReps->ParamByName("grp")->AsInteger=0;

  // фидера

  AnsiString  sqlstr2="  select coalesce(ffs.id_st,ffs.id_fider) as link, ffs.f, \
  CASE WHEN ffs.f = 1 THEN eq.name_eqp WHEN ffs.f = 2 THEN ' - '||eq.name_eqp \
  WHEN ffs.f = 0 THEN 'Підстанції не підключені до фідерів'  ELSE 'Непідключені абоненти' END as name, coalesce(d.pwr,0) as pwr, coalesce(d.cnt,0) as cnt,  coalesce(d.power_roz,0) as power_roz \
  from (select 1 as f,code_eqp as id_fider , NULL as id_st from eqm_fider_tbl \
        union \
        select distinct 2, coalesce(fs.id_fider,0), ba.id_grp from bal_abons_tbl as ba \
         join eqm_equipment_tbl as e on (e.id = ba.id_grp) \
         left join bal_fider_st_tbl as fs on (ba.id_grp = fs.id_st) \
         where e.type_eqp = 8 \
        union \
        select -1,-1,NULL \
        union \
        select 0,0,NULL   ) as ffs \
  left join eqm_equipment_tbl as eq on (eq.id = coalesce(ffs.id_st,ffs.id_fider)) \
  left join eqm_fider_tbl as fider on (fider.code_eqp = ffs.id_fider ) \
  left join (  select sum(pwr) as pwr ,sum(cnt) as cnt , sum(power_roz) as power_roz , grp  \
 from (select sum(p.power) as pwr, count(distinct ba.id_client) as cnt,  coalesce(ba.id_grp,-1) as grp, sum(p.power) as power_roz \
                  from bal_abons_tbl as ba    \
                  join clm_client_tbl as c on (c.id = ba.id_client)  \
                  join clm_statecl_tbl as stcl on (stcl.id_client=c.id )  \
                  join eqm_point_tbl as p on (p.code_eqp = ba.id_point) \
                  left join rep_lighting_points_tmp as lp on (lp.id_point = ba.id_point) \
                 where c.book = -1 \
                 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
                 and p.reserv=0 and lp.id_point is null group by ba.id_grp \
               union all \
                select fiz1.* ,  ((fiz1.pwr-0.58*fiz1.cnt)*coalesce(cf.val,0.005) + 0.58*fiz1.cnt) as power_roz from \
                ( select  sum( c.set_power) as pwr , count(distinct ba.id_client) as cnt,  coalesce(id_grp,-1) as grp  \
                 from bal_abons_tbl as ba \
                 join clm_pclient_tbl as c on (c.id = ba.id_client) \
                  where c.book <> -1 and coalesce(c.cod_zone,0) in (0) and coalesce(c.cod_tarif,0) not in (37,48) and coalesce(c.id_state,0)<>50 \
                  group by ba.id_grp ) as fiz1 \
                 left join bal_fizabon_coef_tbl as cf on (cf.type = 1 and cf.cnt = fiz1.cnt ) \
               union all \
                select fiz2.* ,  ((fiz2.pwr-1.31*fiz2.cnt)*coalesce(cf.val,0.001) + 1.31*fiz2.cnt) as power_roz from \
                ( select  sum( c.set_power) as pwr , count(distinct ba.id_client) as cnt,  coalesce(id_grp,-1) as grp  \
                 from bal_abons_tbl as ba \
                 join clm_pclient_tbl as c on (c.id = ba.id_client) \
                  where c.book <> -1 and coalesce(c.cod_zone,0) in (0) and coalesce(c.cod_tarif,0) = 37 and coalesce(c.id_state,0)<>50 \
                  group by ba.id_grp ) as fiz2 \
                 left join bal_fizabon_coef_tbl as cf on (cf.type = 2 and cf.cnt = fiz2.cnt ) \
               union all \
                select sum(c.set_power) as pwr, count(distinct ba.id_client) as cnt,  coalesce(ba.id_grp,-1) as grp, sum(c.set_power) as power_roz \
                  from bal_abons_tbl as ba   \
                  join clm_pclient_tbl as c on (c.id = ba.id_client)  \
                  where c.book <> -1 and coalesce(c.cod_zone,0) in (0) and coalesce(c.cod_tarif,0) = 48 and coalesce(c.id_state,0)<>50 group by ba.id_grp \
               ) as b   \
       group by grp   \
      ) as d on (d.grp = coalesce(ffs.id_st,ffs.id_fider)) \
  where ((d.pwr is not null) or (ffs.f in (1,0 ))) \
  and ((ffs.id_fider = :fider) or ( :fider = 0 )) and ((ffs.id_st = :grp) or ( :grp = 0 ))  \
  and ((fider.id_station = :st35) or ( :st35 = 0 )) \
  order by id_fider, f, name ; ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;

  if (PSVolt <=10)
  {
    ZQXLRepsSum->ParamByName("grp")->AsInteger=PSId;
    ZQXLRepsSum->ParamByName("st35")->AsInteger=0;
  }
  else
  {
    ZQXLRepsSum->ParamByName("grp")->AsInteger=0;
    ZQXLRepsSum->ParamByName("st35")->AsInteger=PSId;
  }


  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();

  AnsiString  sqlstr3=" select eq.name_eqp, i.type,inst.code_eqp_inst as link \
        from eqm_compens_station_inst_tbl as inst \
        join eqm_equipment_tbl as eq on (eq.id = inst.code_eqp and eq.type_eqp = 2) \
        join eqm_equipment_tbl as eq2 on (eq2.id = inst.code_eqp_inst and eq2.type_eqp = 8) \
        join eqm_compensator_tbl as tr on (eq.id = tr.code_eqp) \
        join eqi_compensator_tbl as i on (i.id = tr.id_type_eqp) \
        union all      \
        select 'Т1' as name_eqp, i.type, cs.code_eqp as link \
        from eqm_compens_station_tbl as cs \
        join eqi_compensator_tbl as i on (i.id = cs.id_type1) \
        where not exists ( select code_eqp from eqm_compens_station_inst_tbl as inst \
                join eqm_equipment_tbl as eq on (eq.id = inst.code_eqp and eq.type_eqp = 2) \
                and inst.code_eqp_inst = cs.code_eqp) \
        union all \
        select 'Т2' as name_eqp, i.type, cs.code_eqp as link \
        from eqm_compens_station_tbl as cs \
        join eqi_compensator_tbl as i on (i.id = cs.id_type2) \
        where not exists ( select code_eqp from eqm_compens_station_inst_tbl as inst \
                join eqm_equipment_tbl as eq on (eq.id = inst.code_eqp and eq.type_eqp = 2) \
                and inst.code_eqp_inst = cs.code_eqp) \
        union all \
        select 'Т3' as name_eqp, i.type, cs.code_eqp as link \
        from eqm_compens_station_tbl as cs \
        join eqi_compensator_tbl as i on (i.id = cs.id_type3) \
        where not exists ( select code_eqp from eqm_compens_station_inst_tbl as inst \
                join eqm_equipment_tbl as eq on (eq.id = inst.code_eqp and eq.type_eqp = 2) \
                and inst.code_eqp_inst = cs.code_eqp) \
        union all \
        select 'Т4' as name_eqp, i.type, cs.code_eqp as link \
        from eqm_compens_station_tbl as cs \
        join eqi_compensator_tbl as i on (i.id = cs.id_type4) \
        where not exists ( select code_eqp from eqm_compens_station_inst_tbl as inst \
                join eqm_equipment_tbl as eq on (eq.id = inst.code_eqp and eq.type_eqp = 2) \
                and inst.code_eqp_inst = cs.code_eqp) \
        order by link, name_eqp ;";

  ZQXLReps2->Sql->Add(sqlstr3);


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  ZQXLReps2->MasterSource=DSRep;
  ZQXLReps2->LinkFields="link = link";

  try
  {
   ZQXLRepsSum->Open();
   ZQXLReps->Open();
   ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLReps2";
  Dsr->Range = "rangeComp";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = "Абоненти, підключені до ";

  if (PSId!=0)  caption =caption + "підстанції "+ edPSName->Text;
  else {
    if (FiderId!=0)  caption =caption + edFiderName->Text;
    else caption =caption + " електромережі";
  }  

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
  ZQXLRepsSum->Close();

}
//------------------------------------------------------------------------------
void TfReports::Prognoz2(TDateTime mmgg)
{

  AnsiString sqlstr;


   sqlstr=" select seb_plan_rep((date_trunc('month', :mmgg::::date))::::date)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  // по потребителям
  AnsiString  sqlstr1="  select coalesce(obr.id_section,999) as link ,cla.name as grp, c.code,c.short_name, \
     ym13,ym12,ym11,ym10,ym01,ym02,ym03,s30,s31,ym_plan \
     from seb_plan_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     join clm_statecl_h as sc on (c.id = sc.id_client) \
     join cla_param_tbl as cla on (coalesce(obr.id_section,999) = cla.id and cla.id_group = 200) \
     where obr.mmgg = :mmgg and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
     and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     ";

  if (cbNoKey->Checked)
     sqlstr1=sqlstr1+ " and sc.flag_key =0 ";

  sqlstr1=sqlstr1+ " order by cla.sort, c.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
/*  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";
*/
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
//  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lkey";


  Param=xlReport->Params->Add();
  Param->Name="lm3y1";
  Param=xlReport->Params->Add();
  Param->Name="lm3y0";
  Param=xlReport->Params->Add();
  Param->Name="lm2y1";
  Param=xlReport->Params->Add();
  Param->Name="lm2y0";
  Param=xlReport->Params->Add();
  Param->Name="lm1y1";
  Param=xlReport->Params->Add();
  Param->Name="lm1y0";
  Param=xlReport->Params->Add();
  Param->Name="lm0y1";
  Param=xlReport->Params->Add();
  Param->Name="lsum1";
  Param=xlReport->Params->Add();
  Param->Name="lsum0";
  Param=xlReport->Params->Add();
  Param->Name="ldiv3";
  Param=xlReport->Params->Add();
  Param->Name="ldiv2";
  Param=xlReport->Params->Add();
  Param->Name="ldiv1";
  Param=xlReport->Params->Add();
  Param->Name="ldivy";
  Param=xlReport->Params->Add();
  Param->Name="ldiv23";
  Param=xlReport->Params->Add();
  Param->Name="ldiv12";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "на " +FormatDateTime("mmmm yyyy",mmgg);

  if (cbNoKey->Checked)
    xlReport->ParamByName["lkey"]->Value = " без ключових";
  else
    xlReport->ParamByName["lkey"]->Value = " ";

  sqlstr=" select (date_trunc('month', :mmgg::::date))::::date - '1 year 3 month'::::interval as ym13, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year 2 month'::::interval as ym12, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year 1 month'::::interval as ym11, \
  (date_trunc('month', :mmgg::::date))::::date - '1 year'::::interval as ym10, \
  (date_trunc('month', :mmgg::::date))::::date - '3 month'::::interval as ym03, \
  (date_trunc('month', :mmgg::::date))::::date - '2 month'::::interval as ym02, \
  (date_trunc('month', :mmgg::::date))::::date - '1 month'::::interval as ym01; ";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->Open();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->ParamByName["lm3y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym13")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm3y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym03")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm2y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym12")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm2y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm1y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym11")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm1y0"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym01")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lm0y1"]->Value = FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym10")->AsDateTime)+ ", кВт.г.";

  xlReport->ParamByName["ldiv3"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym13")->AsDateTime);
  xlReport->ParamByName["ldiv2"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym12")->AsDateTime);
  xlReport->ParamByName["ldiv1"]->Value = "% "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym11")->AsDateTime);

  xlReport->ParamByName["lsum1"]->Value = "3 міс. "+FormatDateTime("yyyy",ZQReps->FieldByName("ym11")->AsDateTime)+ ", кВт.г.";
  xlReport->ParamByName["lsum0"]->Value = "3 міс. "+FormatDateTime("yyyy",mmgg)+ ", кВт.г.";

  xlReport->ParamByName["ldivy"]->Value = "% 3 міс. "+FormatDateTime("yyyy",mmgg)+"/"+ FormatDateTime("yyyy",ZQReps->FieldByName("ym11")->AsDateTime);

  xlReport->ParamByName["ldiv23"]->Value = "% "+FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym03")->AsDateTime);
  xlReport->ParamByName["ldiv12"]->Value = "% "+FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym01")->AsDateTime)+"/"+ FormatDateTime("yyyy mmmm",ZQReps->FieldByName("ym02")->AsDateTime);

  xlReport->Report();

 ZQReps->Close();
 ZQXLReps->Close();
// ZQXLRepsSum->Close();

// ZQXLReps->MasterSource=NULL;
// ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAkt4(TDateTime mmgg,int kind_energy,int client)
{
  if(client==0) return;

//   AnsiString sqlstr;

  AnsiString  sqlstr1=" select c.name, 'За даними '||c.short_name as short_abon, c.code, res.short_name, 'За даними '||res.short_name as short_res, 'Сума прописом за даними '||res.short_name||':' as short_res2, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname, \
  'від '||to_char(abonpar.doc_dat,'DD.MM.YYYY')||' р. № '||text(abonpar.doc_num) as docum_info, boss.name||' ВАТ ЕК ''Чернігівобленерго'' ' as bosposfull, 'Керівник '||c.short_name as abonboss, \
  CASE WHEN d.deb1 > 0 THEN d.deb1 WHEN k.kt1 < 0 THEN -k.kt1 END as deb1, \
  CASE WHEN d.deb2 > 0 THEN d.deb2 WHEN k.kt2 < 0 THEN -k.kt2 END as deb2, \
  CASE WHEN d.deb3 > 0 THEN d.deb3 WHEN k.kt3 < 0 THEN -k.kt3 END as deb3, \
  CASE WHEN d.deb4 > 0 THEN d.deb4 WHEN k.kt4 < 0 THEN -k.kt4 END as deb4, \
  CASE WHEN d.deb5 > 0 THEN d.deb5 WHEN k.kt5 < 0 THEN -k.kt5 END as deb5, \
  CASE WHEN d.deb6 > 0 THEN d.deb6 WHEN k.kt6 < 0 THEN -k.kt6 END as deb6, \
  CASE WHEN d.deb7 > 0 THEN d.deb7 WHEN k.kt7 < 0 THEN -k.kt7 END as deb7, \
  CASE WHEN k.kt1 > 0  THEN k.kt1 WHEN d.deb1 < 0 THEN -d.deb1 END as kt1, \
  CASE WHEN k.kt2 > 0  THEN k.kt2 WHEN d.deb2 < 0 THEN -d.deb2 END as kt2, \
  CASE WHEN k.kt3 > 0  THEN k.kt3 WHEN d.deb3 < 0 THEN -d.deb3 END as kt3, \
  CASE WHEN k.kt4 > 0  THEN k.kt4 WHEN d.deb4 < 0 THEN -d.deb4 END as kt4, \
  CASE WHEN k.kt5 > 0  THEN k.kt5 WHEN d.deb5 < 0 THEN -d.deb5 END as kt5, \
  CASE WHEN k.kt6 > 0  THEN k.kt6 WHEN d.deb6 < 0 THEN -d.deb6 END as kt6, \
  CASE WHEN k.kt7 > 0  THEN k.kt7 WHEN d.deb7 < 0 THEN -d.deb7 END as kt7 \
  from \
  (select \
   sum(case when  mmgg_bill + '3 month'::::interval > :mmgg::::date  THEN debet ELSE 0 END) as deb1, \
   sum(case when  (mmgg_bill + '6 month'::::interval > :mmgg::::date) and (mmgg_bill + '3 month'::::interval <= :mmgg::::date)  THEN debet ELSE 0 END) as deb2, \
   sum(case when  (mmgg_bill + '9 month'::::interval > :mmgg::::date) and (mmgg_bill + '6 month'::::interval <= :mmgg::::date)  THEN debet ELSE 0 END) as deb3, \
   sum(case when  (mmgg_bill + '12 month'::::interval > :mmgg::::date) and (mmgg_bill + '9 month'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb4, \
   sum(case when  (mmgg_bill + '2 year'::::interval > :mmgg::::date) and (mmgg_bill + '12 month'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb5, \
   sum(case when  (mmgg_bill + '3 year'::::interval > :mmgg::::date) and (mmgg_bill + '2 year'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb6, \
   sum(case when  (mmgg_bill + '3 year'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb7 \
   from( \
   select b.mmgg_bill, sum(rest)+ sum(rest_tax) as debet \
   from \
    (select bb.id_doc, coalesce(bb.value,0)-sum(coalesce(bbp.value,0)) as rest, \
    coalesce(bb.value_tax,0)-sum(coalesce(bbp.value_tax,0)) as rest_tax \
    from acm_bill_tbl bb left join  acm_billpay_tbl bbp on (bb.id_doc=bbp.id_bill and bbp.mmgg <= :mmgg) \
    where bb.id_client = :client and bb.id_pref = :pref and bb.mmgg <= :mmgg \
    group by  bb.id_doc,bb.value,bb.value_tax ) as bp  join acm_bill_tbl as b on (b.id_doc = bp.id_doc) \
   group by b.mmgg_bill \
   ) as deb \
   ) as d \
   join \
  (select \
   sum(case when  mmgg_pay + '3 month'::::interval > :mmgg::::date  THEN kredit ELSE 0 END) as kt1, \
   sum(case when  (mmgg_pay + '6 month'::::interval > :mmgg::::date) and (mmgg_pay + '3 month'::::interval <= :mmgg::::date)  THEN kredit ELSE 0 END) as kt2, \
   sum(case when  (mmgg_pay + '9 month'::::interval > :mmgg::::date) and (mmgg_pay + '6 month'::::interval <= :mmgg::::date)  THEN kredit ELSE 0 END) as kt3, \
   sum(case when  (mmgg_pay + '12 month'::::interval > :mmgg::::date) and (mmgg_pay + '9 month'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt4, \
   sum(case when  (mmgg_pay + '2 year'::::interval > :mmgg::::date) and (mmgg_pay + '12 month'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt5, \
   sum(case when  (mmgg_pay + '3 year'::::interval > :mmgg::::date) and (mmgg_pay + '2 year'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt6, \
   sum(case when  (mmgg_pay + '3 year'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt7 \
   from( \
   select p.mmgg_pay, sum(rest)+ sum(rest_tax) as kredit \
   from \
   ( \
    select pp.id_doc, coalesce(pp.value,0)-sum(coalesce(bbp.value,0)) as rest, \
    coalesce(pp.value_tax,0)-sum(coalesce(bbp.value_tax,0)) as rest_tax \
    from acm_pay_tbl pp left join acm_billpay_tbl bbp on (pp.id_doc=bbp.id_pay and bbp.mmgg <= :mmgg) \
    where pp.id_client = :client and pp.id_pref = :pref and pp.mmgg <= :mmgg  \
    group by  pp.id_doc,pp.value,pp.value_tax  \
   ) as pb \
   join acm_pay_tbl as p on (p.id_doc = pb.id_doc) \
   group by p.mmgg_pay \
   ) as kred \
   ) as k \
   on (1=1) \
   ,clm_client_tbl as c left join clm_statecl_h as abonpar on (abonpar.id_client = c.id) \
   ,clm_client_tbl as res \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
   where (res.id = syi_resid_fun() ) and c.id = :client \
   and abonpar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as abonpar2 where abonpar2.id_client = abonpar.id_client and abonpar2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
   ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);


  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

 if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="energy";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="workdt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->ParamByName["workdt"]->Value = dtRDate->Date;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  if (kind_energy==0)
    xlReport->ParamByName["energy"]->Value = "активну електроенергію";
  if (kind_energy==1)
    xlReport->ParamByName["energy"]->Value = "реактивну електроенергію";

  if (kind_energy==3)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";
  if (kind_energy==4)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";

  if (kind_energy==2)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту потужності ";
  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void __fastcall TfReports::xlReportBeforeWorkbookSave(TxlReport *Report,
      AnsiString &WorkbookName, AnsiString &WorkbookPath, bool Save)
{
  AnsiString OldName =WorkbookName;
  AnsiString NewName;

  if ((PTRepData(CurReport->Data))->ident == "4nkre")
  {
  // TWTQuery * T=new TWTQuery(this);
  // T->Sql->Add("select now()::::text as dttim");
  // T->Open();
  // AnsiString dt=T->FieldByName("dttim")->AsString;
  // NewName=OldName.SubString(OldName.AnsiPos("   "),OldName.AnsiPos("  xlrtmp ")-OldName.AnsiPos("   "));
   //NewName=NewName.Trim();
     TDateTime mmgg=dtBegin->Date;
   AnsiString dat=DateToStr(mmgg);
   //AnsiString tim=TimeToStr(Now());
   AnsiString tim=FormatDateTime("hh:nn:ss",Now());
     AnsiString dt=dat.SubString(4,2)+"_"+dat.SubString(7,4)+"____"+tim.SubString(1,2)+ "_"+tim.SubString(4,2)+"_"+tim.SubString(7,2);
      AnsiString PathF= "4nkre"+IntToStr(res_code)+"_"+dt;
   WorkbookName = PathF;
//   WorkbookPath = WorkbookPath+"tmp\\";
  }

  if ((PTRepData(CurReport->Data))->ident == "unif_fiz")
  {
   TWTQuery * T=new TWTQuery(this);
   T->Sql->Add("select value_ident from syi_sysvars_tbl where ident='tax_num_ending';");
   T->Open();
   AnsiString code=T->FieldByName("value_ident")->AsString;
   T->Close();

   AnsiString PathF;

   Word year1;
   Word month1;
   Word day1;

   DecodeDate(dtEnd->Date,year1,month1,day1);

   PathF= PathF+code.SubString(3,2) +FormatFloat("00",month1)+FormatFloat("0000",year1)+"ok";

   WorkbookName = PathF;

  }

  if ((PTRepData(CurReport->Data))->ident == "common_account")
  {
   AnsiString PathF;

   Word year1;
   Word month1;
   Word day1;

   DecodeDate(dtEnd->Date,year1,month1,day1);

   PathF= PathF+ FormatFloat("000",res_code)+"pay-" +FormatFloat("00",month1)+"-"+FormatFloat("0000",year1);

   WorkbookName = PathF;

  }

}
//---------------------------------------------------------------------------
void TfReports::AllPointTarif(TDateTime mmgg,TDateTime dt)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select c.id, c.short_name, c.code, p.code_eqp, p.id_tarif as link, eq.name_eqp,coalesce(b2.demand_val,0) as demand_val, coalesce(b2.sum_val,0) as sum_val \
    from eqm_tree_h as tr \
    join (select id, max(dt_b) as dt from eqm_tree_h  where dt_b <=   :dt and coalesce(dt_e,  :dt) >=   :dt group by id) as tr2 on (tr.id = tr2.id and tr2.dt = tr.dt_b) \
    join eqm_eqp_tree_h as ttr on (tr.id = ttr.id_tree) \
    join (select code_eqp, max(dt_b) as dt from eqm_eqp_tree_h  where dt_b <=   :dt and coalesce(dt_e,  :dt) >=   :dt group by code_eqp) as ttr2 on (ttr.code_eqp = ttr2.code_eqp and ttr2.dt = ttr.dt_b) \
    join eqm_equipment_h as eq on (ttr.code_eqp = eq.id and eq.type_eqp = 12) \
    join (select id, max(dt_b) as dt from eqm_equipment_h  where dt_b <=   :dt and coalesce(dt_e,  :dt) >=   :dt group by id) as eq2 on (eq.id = eq2.id and eq2.dt = eq.dt_b) \
    join eqm_point_h as p on (ttr.code_eqp = p.code_eqp) \
    join (select code_eqp, max(dt_b) as dt from eqm_point_h  where dt_b <=   :dt and coalesce(dt_e,  :dt) >=   :dt group by code_eqp) as p2 on (p.code_eqp = p2.code_eqp and p2.dt = p.dt_b) \
    left join \
    ( select u1.code_eqp,u1.id_client  from eqm_eqp_use_h as u1 \
       join (select code_eqp, max(dt_b) as dt from eqm_eqp_use_h  where dt_b <=   :dt and coalesce(dt_e,  :dt) >=   :dt group by code_eqp ) as u2 \
     on (u1.code_eqp = u2.code_eqp and u2.dt = u1.dt_b) \
    ) as use on (use.code_eqp = p.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_h as scl on (c.id = scl.id_client) \
    left join \
    (select bs.id_point, sum(bs.demand_val) as demand_val, sum(sum_val) as sum_val \
     from  acm_bill_tbl as b   \
     join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
     where b.id_pref =10 and b.mmgg = :mmgg group by bs.id_point) as b2 on (b2.id_point = p.code_eqp) \
    where scl.id_section not in (205,206,207,208) \
    and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and c.book=-1 and ( p.id_tarif = :tar or :tar is NULL) \
    order by id_tarif,code, name_eqp; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  if (TarifId!=0)
      ZQXLReps->ParamByName("tar")->AsInteger=TarifId;
  else
      ZQXLReps->ParamByName("tar")->Clear();

  // по категориям
  AnsiString  sqlstr2=" select id_tarif as link, coalesce(summa,0) as summa, coalesce(kvt,0) as kvt, cnt, tar.name as tarname, tgr.name as tgrname  from \
    (select  p.id_tarif, sum(b2.demand_val) as kvt, sum(b2.sum_val) as summa, count(*) as cnt \
    from eqm_tree_h as tr \
    join (select id, max(dt_b) as dt from eqm_tree_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by id) as tr2 on (tr.id = tr2.id and tr2.dt = tr.dt_b) \
    join eqm_eqp_tree_h as ttr on (tr.id = ttr.id_tree) \
    join (select code_eqp, max(dt_b) as dt from eqm_eqp_tree_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp) as ttr2 on (ttr.code_eqp = ttr2.code_eqp and ttr2.dt = ttr.dt_b) \
    join eqm_point_h as p on (ttr.code_eqp = p.code_eqp) \
    join (select code_eqp, max(dt_b) as dt from eqm_point_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp) as p2 on (p.code_eqp = p2.code_eqp and p2.dt = p.dt_b) \
    left join \
    ( select u1.code_eqp,u1.id_client  from eqm_eqp_use_h as u1 \
       join (select code_eqp, max(dt_b) as dt from eqm_eqp_use_h  where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp ) as u2 \
     on (u1.code_eqp = u2.code_eqp and u2.dt = u1.dt_b) \
    ) as use on (use.code_eqp = p.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_h as scl on (c.id = scl.id_client) \
    left join \
    (select bs.id_point, sum(bs.demand_val) as demand_val, sum(sum_val) as sum_val \
     from  acm_bill_tbl as b   \
     join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
     where b.id_pref =10 and b.mmgg = :mmgg group by bs.id_point) as b2 on (b2.id_point = p.code_eqp) \
    where scl.id_section not in (205,206,207,208) \
    and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and c.book=-1 and ( p.id_tarif = :tar or :tar is NULL) \
    group by p.id_tarif ) as ts \
    join aci_tarif_tbl as tar on (ts.id_tarif = tar.id) \
    join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif = tgr.id ) \
    order by tgr.ident,tar.id_classtarif, id_tarif;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;
  if (TarifId!=0)
      ZQXLRepsSum->ParamByName("tar")->AsInteger=TarifId;
  else
      ZQXLRepsSum->ParamByName("tar")->Clear();


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "За період "+FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["ldt"]->Value = "станом на "+FormatDateTime("dd.mm.yy",dt);
 /*
  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по тарифах.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по тарифах.";
*/
  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbTarifClick(TObject *Sender)
{
   TWTDBGrid* Grid;
   Grid=MainForm->AciTarifSel(NULL);
   if(Grid==NULL) return;
   else WTarGrid=Grid;

   WTarGrid->StringDest = "1";
   WTarGrid->OnAccept=TarAccept;
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbTarifClClick(TObject *Sender)
{
 TarifId = 0;
 edTarifName->Text ="";
}
//---------------------------------------------------------------------------
void __fastcall TfReports::TarAccept(TObject *Sender)
{
 TarifId= WTarGrid->Table->FieldByName("id")->AsInteger;
 edTarifName->Text=WTarGrid->Table->FieldByName("name")->AsString;
}
//---------------------------------------------------------------------------
void TfReports::PrognozPay(TDateTime mmgg)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" \
   select s.id_section as link,c.code ,c.short_name as name,s.dt_indicat  , \
   p.dem ,p.val , \
   s.pre_pay_day1 ,s.pre_pay_perc1 ,round((p.val*s.pre_pay_perc1/100),2) as pre_pay_sum1, \
   s.pre_pay_day2 ,s.pre_pay_perc2 ,round((p.val*s.pre_pay_perc2/100),2) as pre_pay_sum2, \
   s.pre_pay_day3 ,s.pre_pay_perc3 ,round((p.val*s.pre_pay_perc3/100),2) as pre_pay_sum3 \
   from clm_client_tbl c \
   join clm_statecl_h s on (c.id=s.id_client) \
   left join clm_position_tbl as cp on (s.id_position=cp.id) \
   left join (select id_client,sum(demand_val) as dem ,sum(value+value_tax) as val \
    from acm_bill_tbl where mmgg= :mmgg and id_pref=10 group by id_client) as p \
   on (p.id_client =c.id) \
   where ( :insp is null or s.id_position = :insp) \
   and s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
   and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
   order by c.code;  ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  // по категориям
  AnsiString  sqlstr2=" select ss.*, cla.name from \
  (select s.id_section as link,sum(p.dem) as dem ,sum(p.val) as val,\
   sum(round((p.val*s.pre_pay_perc1/100),2)) as pre_pay_sum1, \
   sum(round((p.val*s.pre_pay_perc2/100),2)) as pre_pay_sum2, \
   sum(round((p.val*s.pre_pay_perc3/100),2)) as pre_pay_sum3 \
   from clm_client_tbl c \
   left join clm_statecl_h s on (c.id=s.id_client) \
   left join (select id_client,sum(demand_val) as dem ,sum(value+value_tax) as val \
   from acm_bill_tbl \
   where mmgg= :mmgg and id_pref=10 group by id_client) as p on (p.id_client =c.id) \
   where ( :insp is null or s.id_position = :insp) \
   and s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
   and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
   group by s.id_section \
   ) as ss \
  join cla_param_tbl as cla on (ss.link = cla.id and cla.id_group = 200) \
  order by cla.sort; ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

   if (InspectorId!=0)
    ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "_нспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";


  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}



void TfReports::PrognozPayAdd(TDateTime mmgg)
{
  AnsiString sqlstr;
    sqlstr=" select seb_progn5((date_trunc('month', :mmgg::::date))::::date)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка  SQL :"+sqlstr);
    return;
   }

  AnsiString  sqlstr1=" \
   select s.id_section as link,c.code ,c.short_name as name, s.dt_indicat  , p.tar,  kr.sum_kredit, cp.represent_name,  \
   bill.demand,bill.value_all, \
    seb.dem as dem , \
    round(seb.dem*p.tar,2) as val , \
    pay.pay as pay_all, \
   s.pre_pay_day1 ,s.pre_pay_perc1 ,round(seb.dem*p.tar*s.pre_pay_perc1/100,2) as pre_pay_sum1, \
   pay10.pay as pay10, \
   s.pre_pay_day2 ,s.pre_pay_perc2 ,round(seb.dem*p.tar*s.pre_pay_perc2/100,2) as pre_pay_sum2, \
   pay20.pay as pay20, \
   s.pre_pay_day3 ,s.pre_pay_perc3 ,round(seb.dem*p.tar*s.pre_pay_perc3/100,2) as pre_pay_sum3, \
   pay30.pay as pay30 \
   from clm_client_tbl c \
   join clm_statecl_h s on (c.id=s.id_client) \
   left join clm_position_tbl as cp on (s.id_position=cp.id) \
    left join (select  id_client,  \
               case when demand_plan=0 then demand_calc else demand_plan end as dem  \
                from  seb_plan  where id_pref=10 and mmgg=:mmgg) seb \
       on (c.id=seb.id_client ) \
   left join (select id_client,sum(demand_val) as dem ,sum(value+value_tax) as val,\
   case when sum(demand_val)>0 then round((sum(value+value_tax)/ ( case when sum(demand_val)>0 then sum(demand_val) else -1 end ) ) ,5 ) else 0 end as tar  \
    from acm_bill_tbl where mmgg= (:mmgg ::::date- interval '1 month')::::date  \
     and id_pref=10 group by id_client) as p \
   on (p.id_client =c.id) \
 left join (select id_client,sum(demand_val) as demand ,sum(value+value_tax) as value_all \
    from acm_bill_tbl where mmgg= :mmgg  \
     and id_pref=10 group by id_client) as bill \
   on (bill.id_client =c.id) \
   left join (select  id_client,id_pref,mmgg,case when (b_val+b_valtax)<0 then -(b_val+b_valtax) else 0 end as sum_kredit  \
   from acm_saldo_tbl where id_pref=10 and mmgg=:mmgg) kr \
    on c.id=kr.id_client\
     left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where  id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay on pay.id_client=c.id \
   left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))<=11  and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay10  on pay10.id_client=c.id \
   left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))>11 and (reg_date-bom(reg_date))<=21 \
                   and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay20 on pay20.id_client=c.id \
    left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))>21 and (reg_date-bom(reg_date))<=32 \
                   and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay30 on pay30.id_client=c.id \
   where ( :insp is null or s.id_position = :insp) \
   and s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
   and coalesce(c.id_state,0) not in (50,99)\
   order by c.code;  ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

//   round((sum(value+value_tax)/sum(demand_val) ) ,5 ) as tar  \
  // Ї® Є вҐЈ®аЁп¬
  AnsiString  sqlstr2=" select ss.*, cla.name from \
  ( select s.id_section as link,     sum(kr.sum_kredit) as sum_kredit,    \
     sum(bill.demand) as demand,sum(bill.value_all) as value_all, \
     sum(seb.dem) as dem ,\
     sum(pay.pay) as pay_all, \
    sum(round(seb.dem*p.tar,2)) as val , \
   sum(round(seb.dem*p.tar*s.pre_pay_perc1/100,2))  as pre_pay_sum1, \
    sum(pay10.pay) as pay10, \
    sum(round(seb.dem*p.tar*s.pre_pay_perc2/100,2))  as pre_pay_sum2,\
    sum(pay20.pay) as pay20, \
    sum(round(seb.dem*p.tar*s.pre_pay_perc3/100,2))  as pre_pay_sum3,\
   sum(pay30.pay) as pay30 \
   from clm_client_tbl c \
   join clm_statecl_h s on (c.id=s.id_client) \
    left join (select  id_client,  \
               case when demand_plan=0 then demand_calc else demand_plan end as dem  \
                from  seb_plan  where id_pref=10 and mmgg=:mmgg) seb \
       on (c.id=seb.id_client ) \
   left join (select id_client,sum(demand_val) as dem ,sum(value+value_tax) as val,\
    case when sum(demand_val)>0 then round((sum(value+value_tax)/ ( case when sum(demand_val)>0 then sum(demand_val)else -1 end ) ) ,5 ) else 0 end as tar  \
    from acm_bill_tbl where mmgg= (:mmgg::::date- interval '1 month')::::date  \
     and id_pref=10 group by id_client) as p \
   on (p.id_client =c.id) \
 left join (select id_client,sum(demand_val) as demand ,sum(value+value_tax) as value_all \
    from acm_bill_tbl where mmgg= :mmgg  \
     and id_pref=10 group by id_client) as bill \
   on (bill.id_client =c.id) \
   left join (select  id_client,id_pref,mmgg,case when (b_val+b_valtax)<0 then -(b_val+b_valtax) else 0 end as sum_kredit  \
   from acm_saldo_tbl where id_pref=10 and mmgg=:mmgg) kr \
    on c.id=kr.id_client\
    left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where  id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay on pay.id_client=c.id \
   left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))<=11  and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay10  on pay10.id_client=c.id \
   left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))>11 and (reg_date-bom(reg_date))<=21 \
                   and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay20 on pay20.id_client=c.id \
    left join (select id_client,id_pref,sum(value_pay) as pay from acm_pay_tbl  \
                 where (reg_date-bom(reg_date))>21 and (reg_date-bom(reg_date))<=32 \
                   and id_pref=10 and mmgg=:mmgg \
                  and date_trunc('year',mmgg_pay)=date_trunc('year',:mmgg::::date) \
                group by id_client,id_pref \
           ) as pay30 on pay30.id_client=c.id \
    where ( :insp is null or s.id_position = :insp) \
    and s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
    group by s.id_section \
   ) as ss \
  join cla_param_tbl as cla on (ss.link = cla.id and cla.id_group = 200) \
  order by cla.sort; ";



  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  { ZQXLReps->Open();
    ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "I­бЇҐЄв®а "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}

void TfReports::PrognozPayAdd5(TDateTime mmgg)
{
  AnsiString sqlstr;
        sqlstr=" select progn_5((date_trunc('month', :mmgg::::date))::::date)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка  SQL :"+sqlstr);
    return;
   }
    AnsiString sqlstr1;
      sqlstr1=" select t.id_section as link, t.* from rep_prognoz5_tmp t \
                left join cla_param_tbl as cla on (t.id_section = cla.id and cla.id_group = 200),    \
                clm_statecl_h s  \
               where (t.id_client=s.id_client) and ( :insp is null or s.id_position = :insp) and \
      s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
      order by t.code";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

       AnsiString sqlstr2;
      sqlstr2="select t.id_section as link, cla.name,  \
      sum(sum_credit) as sum_credit,    \
     sum(demand) as demand,sum( value_all) as value_all, \
     sum(dem) as dem ,\
     sum(pay_all) as pay_all, \
    sum(t.val) as val , \
    sum(pre_pay_sum5) as pre_pay_sum5, \
   sum(pay5) as pay5, \
   sum( pre_pay_sum10) as pre_pay_sum10, \
   sum(pay10) as pay10, \
   sum(pre_pay_sum15) as pre_pay_sum15, \
   sum(pay15) as pay15, \
   sum(pre_pay_sum20) as pre_pay_sum20, \
   sum(pay20) as pay20, \
   sum(pre_pay_sum25) as pre_pay_sum25, \
   sum(pay25) as pay25, \
   sum(pre_pay_sum30) as pre_pay_sum30, \
   sum(pay30) as pay30 \
      from rep_prognoz5_tmp t \
      left join cla_param_tbl as cla on (t.id_section = cla.id and cla.id_group = 200)    \
      ,clm_statecl_h s\
            where (t.id_client=s.id_client) and ( :insp is null or s.id_position = :insp) and \
      s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
        group by t.id_section,cla.name,cla.sort order by cla.sort; ";

//   round((sum(value+value_tax)/sum(demand_val) ) ,5 ) as tar  \
  // Ї® Є вҐЈ®аЁп¬


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  { ZQXLReps->Open();
    ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bosspos";
   Param=xlReport->Params->Add();
  Param->Name="bossphone";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bosspos"]->Value = BossPos;
  xlReport->ParamByName["bossphone"]->Value = BossPhone;

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "I­бЇҐЄв®а "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}


//---------------------------------------------------------------------------
//-------------------------------------------------------------------------

void TfReports::PrognozPayDem5(TDateTime mmgg)
{
//  AnsiString sqlstr;
TWTQuery *Rep=new TWTQuery(this);
AnsiString  sqlstra=" select  progn_5(:pmmgg)";
Rep->Sql->Clear();
Rep->Sql->Add(sqlstra);
Rep->ParamByName("pmmgg")->AsDateTime=mmgg;
Rep->ExecSql();


  AnsiString  sqlstr1=" select  id_section as link,* from rep_prognoz5_tmp \
   where ( :insp is null or id_represent = :insp) \
   order by code;  ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  //ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

//   round((sum(value+value_tax)/sum(demand_val) ) ,5 ) as tar  \
  // по категориям
  AnsiString  sqlstr2="  select p.*,cla.name  from \
   ( select id_section as link, sum(sum_credit) as sum_credit,  \
      sum(demand) as demand, sum(value_all) as value_all, \
       sum(dem) as dem,sum(val) as val,\
       sum(pre_pay_dem5) as pre_pay_dem5,  \
       sum(pre_pay_sum5) as pre_pay_sum5,  \
       sum(pay5) as pay5,  \
       sum(pre_pay_dem10) as pre_pay_dem10,  \
       sum(pre_pay_sum10) as pre_pay_sum10,  \
       sum(pay10) as pay10,  \
       sum(pre_pay_dem15) as pre_pay_dem15,  \
       sum(pre_pay_sum15) as pre_pay_sum15,  \
       sum(pay15) as pay15,  \
       sum(pre_pay_dem20) as pre_pay_dem20,  \
       sum(pre_pay_sum20) as pre_pay_sum20,  \
       sum(pay20) as pay20,  \
       sum(pre_pay_dem25) as pre_pay_dem25,  \
       sum(pre_pay_sum25) as pre_pay_sum25,  \
       sum(pay25) as pay25,  \
       sum(pre_pay_dem30) as pre_pay_dem30,  \
       sum(pre_pay_sum30) as pre_pay_sum30,  \
       sum(pay30) as pay30  \
        from ( select * from  rep_prognoz5_tmp \
         where ( :insp is null or id_represent = :insp)) pp \
        group by id_section  \
   ) p \
    join cla_param_tbl as cla on (p.link = cla.id and cla.id_group = 200) \
  order by cla.sort; ";



  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
 // ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  { ZQXLReps->Open();
    ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bosspos";
   Param=xlReport->Params->Add();
  Param->Name="bossphone";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bosspos"]->Value = BossPos;
  xlReport->ParamByName["bossphone"]->Value = BossPhone;

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}


//-----------------------------------------------------------------------------
void TfReports::PrintMeterNoDemand( TDateTime dtb,TDateTime dte)
{
  ZQXLReps->Sql->Clear();

  AnsiString sqlstr = " select distinct c.id, c.code, c.short_name as name, eq.name_eqp, eq.num_eqp, m.id_type_eqp, eq.dt_install \
    from \
    (select h.id_client,i.num_eqp, sum(value_dem) as dem ,count(*) as cnt from acm_headindication_tbl as h join acd_indication_tbl as i on (h.id_doc =i.id_doc) \
      where idk_document = 310 and h.reg_date <=:dte and h.reg_date >= :dtb \
      and i.value is not null and i.value <>0  group by h.id_client,i.num_eqp \
      having sum(value_dem) =0 and count(*)>0 \
    ) as mnd, \
    eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (ttr.code_eqp = m.code_eqp) \
    left join  eqm_eqp_use_tbl as use on (use.code_eqp = m.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
    where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book=-1 \
    and scl.id_section not in (205,206,207,208) \
    and mnd.id_client = c.id and mnd.num_eqp = eq.num_eqp \
    order by  c.code  ;";

  ZQXLReps->Sql->Add(sqlstr);

  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;


  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintPointHistErr(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1=" select cl.code, cl.short_name, b.reg_date, b.reg_num, bs.id_point, bs.dt_end, \
 (select name_eqp from eqm_equipment_h where id = bs.id_point order by dat_b desc limit 1) as point_name from \
  acm_bill_tbl as b \
  join  acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  left join eqm_point_h as ph on (ph.code_eqp = bs.id_point and ph.dt_b <=bs.dt_end and bs.dt_end <= coalesce( ph.dt_e,bs.dt_end)  ) \
  left join eqm_equipment_h as eq on (eq.id = bs.id_point and eq.dt_b <=bs.dt_end and bs.dt_end <= coalesce( eq.dt_e, bs.dt_end)  ) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and (ph.code_eqp is null or eq.id is null) order by cl.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy == 0)  ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy == 1)  ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";
/*
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
*/

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::ObSaldoAkt(boolean Build)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select seb_saldakt( :mmgg,1)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям
  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (   select coalesce(obr.cod_section,999) as link ,\
         sum(kvt) as skvt , \
         sum(dt_val) as sdt_val , sum(dt_valtax) as sdt_valtax, sum(dt_val+ dt_valtax) as sdt_sum, \
         sum(kt_val) as skt_val, sum(kt_valtax) as skt_valtax, sum(kt_val+ kt_valtax) as skt_sum, \
         sum(b_dtval) as sb_dtval, sum(b_dtvaltax) as sb_dtvaltax, sum(b_dtval+ b_dtvaltax) as sb_dtsum, \
         sum(b_ktval) as sb_ktval, sum(b_ktvaltax) as sb_ktvaltax, sum(b_ktval+ b_ktvaltax) as sb_ktsum, \
         sum(e_dtval) as se_dtval, sum(e_dtvaltax) as se_dtvaltax, sum(e_dtval+ e_dtvaltax) as se_dtsum, \
         sum(e_ktval) as se_ktval, sum(e_ktvaltax) as se_ktvaltax, sum(e_ktval+ e_ktvaltax) as se_ktsum, \
         sum(e_dtval99) as se_dtval99, sum(e_dtvaltax99) as se_dtvaltax99, sum(e_dtval99+ e_dtvaltax99) as se_dtsum99, \
         sum(e_dtval00) as se_dtval00, sum(e_dtvaltax00) as se_dtvaltax00, sum(e_dtval00+ e_dtvaltax00) as se_dtsum00, \
         sum(e_dtval01) as se_dtval01, sum(e_dtvaltax01) as se_dtvaltax01, sum(e_dtval01+ e_dtvaltax01) as se_dtsum01, \
         sum(e_dtval02) as se_dtval02, sum(e_dtvaltax02) as se_dtvaltax02, sum(e_dtval02+ e_dtvaltax02) as se_dtsum02, \
         sum(e_dtval03) as se_dtval03, sum(e_dtvaltax03) as se_dtvaltax03, sum(e_dtval03+ e_dtvaltax03) as se_dtsum03, \
         sum(e_dtval04) as se_dtval04, sum(e_dtvaltax04) as se_dtvaltax04, sum(e_dtval04+ e_dtvaltax04) as se_dtsum04, \
         sum(e_dtval05) as se_dtval05, sum(e_dtvaltax05) as se_dtvaltax05, sum(e_dtval05+ e_dtvaltax05) as se_dtsum05, \
         sum(e_dtval06) as se_dtval06, sum(e_dtvaltax06) as se_dtvaltax06, sum(e_dtval06+ e_dtvaltax06) as se_dtsum06, \
         sum(e_dtval07) as se_dtval07, sum(e_dtvaltax07) as se_dtvaltax07, sum(e_dtval07+ e_dtvaltax07) as se_dtsum07, \
         sum(e_dtval08) as se_dtval08, sum(e_dtvaltax08) as se_dtvaltax08, sum(e_dtval08+ e_dtvaltax08) as se_dtsum08, \
         sum(e_dtval09) as se_dtval09, sum(e_dtvaltax09) as se_dtvaltax09, sum(e_dtval09+ e_dtvaltax09) as se_dtsum09, \
         sum(e_dtval10) as se_dtval10, sum(e_dtvaltax10) as se_dtvaltax10, sum(e_dtval10+ e_dtvaltax10) as se_dtsum10, \
         sum(e_dtval11) as se_dtval11, sum(e_dtvaltax11) as se_dtvaltax11, sum(e_dtval11+ e_dtvaltax11) as se_dtsum11, \
         sum(e_dtval12) as se_dtval12, sum(e_dtvaltax12) as se_dtvaltax12, sum(e_dtval12+ e_dtvaltax12) as se_dtsum12, \
         sum(e_dtval13) as se_dtval13, sum(e_dtvaltax13) as se_dtvaltax13, sum(e_dtval13+ e_dtvaltax13) as se_dtsum13, \
         sum(e_dtval14) as se_dtval14, sum(e_dtvaltax14) as se_dtvaltax14, sum(e_dtval14+ e_dtvaltax14) as se_dtsum14, \
         sum(b_dtval99) as sb_dtval99, sum(b_dtvaltax99) as sb_dtvaltax99, sum(b_dtval99+ b_dtvaltax99) as sb_dtsum99, \
         sum(b_dtval00) as sb_dtval00, sum(b_dtvaltax00) as sb_dtvaltax00, sum(b_dtval00+ b_dtvaltax00) as sb_dtsum00, \
         sum(b_dtval01) as sb_dtval01, sum(b_dtvaltax01) as sb_dtvaltax01, sum(b_dtval01+ b_dtvaltax01) as sb_dtsum01, \
         sum(b_dtval02) as sb_dtval02, sum(b_dtvaltax02) as sb_dtvaltax02, sum(b_dtval02+ b_dtvaltax02) as sb_dtsum02, \
         sum(b_dtval03) as sb_dtval03, sum(b_dtvaltax03) as sb_dtvaltax03, sum(b_dtval03+ b_dtvaltax03) as sb_dtsum03, \
         sum(b_dtval04) as sb_dtval04, sum(b_dtvaltax04) as sb_dtvaltax04, sum(b_dtval04+ b_dtvaltax04) as sb_dtsum04, \
         sum(b_dtval05) as sb_dtval05, sum(b_dtvaltax05) as sb_dtvaltax05, sum(b_dtval05+ b_dtvaltax05) as sb_dtsum05, \
         sum(b_dtval06) as sb_dtval06, sum(b_dtvaltax06) as sb_dtvaltax06, sum(b_dtval06+ b_dtvaltax06) as sb_dtsum06, \
         sum(b_dtval07) as sb_dtval07, sum(b_dtvaltax07) as sb_dtvaltax07, sum(b_dtval07+ b_dtvaltax07) as sb_dtsum07, \
         sum(b_dtval08) as sb_dtval08, sum(b_dtvaltax08) as sb_dtvaltax08, sum(b_dtval08+ b_dtvaltax08) as sb_dtsum08, \
         sum(b_dtval09) as sb_dtval09, sum(b_dtvaltax09) as sb_dtvaltax09, sum(b_dtval09+ b_dtvaltax09) as sb_dtsum09, \
         sum(b_dtval10) as sb_dtval10, sum(b_dtvaltax10) as sb_dtvaltax10, sum(b_dtval10+ b_dtvaltax10) as sb_dtsum10, \
         sum(b_dtval11) as sb_dtval11, sum(b_dtvaltax11) as sb_dtvaltax11, sum(b_dtval11+ b_dtvaltax11) as sb_dtsum11, \
         sum(b_dtval12) as sb_dtval12, sum(b_dtvaltax12) as sb_dtvaltax12, sum(b_dtval12+ b_dtvaltax12) as sb_dtsum12, \
         sum(b_dtval13) as sb_dtval13, sum(b_dtvaltax13) as sb_dtvaltax13, sum(b_dtval13+ b_dtvaltax13) as sb_dtsum13, \
         sum(b_dtval14) as sb_dtval14, sum(b_dtvaltax14) as sb_dtvaltax14, sum(b_dtval14+ b_dtvaltax14) as sb_dtsum14 \
      from seb_saldakt_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     where  obr.id_pref = 10 and obr.idk_work not in (0,99) group by obr.cod_section \
     )  as sss \
     join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
//  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);


    //ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr";


  //  ZQXLRepsSum->ParamByName("pref")->AsInteger=10;

  // по потребителям
  AnsiString  sqlstr1="  select coalesce(obr.cod_section,999) as link ,\
     obr.code,obr.short_name , \
      kvt, \
     dt_val, dt_valtax, (dt_val+ dt_valtax) as dt_sum, \
     kt_val, kt_valtax, (kt_val+ kt_valtax) as kt_sum, \
     b_dtval, b_dtvaltax, (b_dtval+ b_dtvaltax) as b_dtsum, \
     b_ktval, b_ktvaltax, (b_ktval+ b_ktvaltax) as b_ktsum, \
     e_dtval, e_dtvaltax, (e_dtval+ e_dtvaltax) as e_dtsum, \
     e_ktval, e_ktvaltax, (e_ktval+ e_ktvaltax) as e_ktsum, \
     e_dtval99, e_dtvaltax99, (e_dtval99+ e_dtvaltax99) as e_dtsum99, \
     e_dtval00, e_dtvaltax00, (e_dtval00+ e_dtvaltax00) as e_dtsum00, \
     e_dtval01, e_dtvaltax01, (e_dtval01+ e_dtvaltax01) as e_dtsum01, \
     e_dtval02, e_dtvaltax02, (e_dtval02+ e_dtvaltax02) as e_dtsum02, \
     e_dtval03, e_dtvaltax03, (e_dtval03+ e_dtvaltax03) as e_dtsum03, \
     e_dtval04, e_dtvaltax04, (e_dtval04+ e_dtvaltax04) as e_dtsum04, \
     e_dtval05, e_dtvaltax05, (e_dtval05+ e_dtvaltax05) as e_dtsum05, \
     e_dtval06, e_dtvaltax06, (e_dtval06+ e_dtvaltax06) as e_dtsum06, \
     e_dtval07, e_dtvaltax07, (e_dtval07+ e_dtvaltax07) as e_dtsum07, \
     e_dtval08, e_dtvaltax08, (e_dtval08+ e_dtvaltax08) as e_dtsum08, \
     e_dtval09, e_dtvaltax09, (e_dtval09+ e_dtvaltax09) as e_dtsum09, \
     e_dtval10, e_dtvaltax10, (e_dtval10+ e_dtvaltax10) as e_dtsum10, \
     e_dtval11, e_dtvaltax11, (e_dtval11+ e_dtvaltax11) as e_dtsum11, \
     e_dtval12, e_dtvaltax12, (e_dtval12+ e_dtvaltax12) as e_dtsum12, \
     e_dtval13, e_dtvaltax13, (e_dtval13+ e_dtvaltax13) as e_dtsum13, \
     e_dtval14, e_dtvaltax14, (e_dtval14+ e_dtvaltax14) as e_dtsum14, \
     b_dtval99, b_dtvaltax99, (b_dtval99+ b_dtvaltax99) as b_dtsum99, \
     b_dtval00, b_dtvaltax00, (b_dtval00+ b_dtvaltax00) as b_dtsum00, \
     b_dtval01, b_dtvaltax01, (b_dtval01+ b_dtvaltax01) as b_dtsum01, \
     b_dtval02, b_dtvaltax02, (b_dtval02+ b_dtvaltax02) as b_dtsum02, \
     b_dtval03, b_dtvaltax03, (b_dtval03+ b_dtvaltax03) as b_dtsum03, \
     b_dtval04, b_dtvaltax04, (b_dtval04+ b_dtvaltax04) as b_dtsum04, \
     b_dtval05, b_dtvaltax05, (b_dtval05+ b_dtvaltax05) as b_dtsum05, \
     b_dtval06, b_dtvaltax06, (b_dtval06+ b_dtvaltax06) as b_dtsum06, \
     b_dtval07, b_dtvaltax07, (b_dtval07+ b_dtvaltax07) as b_dtsum07, \
     b_dtval08, b_dtvaltax08, (b_dtval08+ b_dtvaltax08) as b_dtsum08, \
     b_dtval09, b_dtvaltax09, (b_dtval09+ b_dtvaltax09) as b_dtsum09, \
     b_dtval10, b_dtvaltax10, (b_dtval10+ b_dtvaltax10) as b_dtsum10, \
     b_dtval11, b_dtvaltax11, (b_dtval11+ b_dtvaltax11) as b_dtsum11, \
     b_dtval12, b_dtvaltax12, (b_dtval12+ b_dtvaltax12) as b_dtsum12, \
     b_dtval13, b_dtvaltax13, (b_dtval13+ b_dtvaltax13) as b_dtsum13, \
     b_dtval14, b_dtvaltax14, (b_dtval14+ b_dtvaltax14) as b_dtsum14 \
     from seb_saldakt_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client) \
     where  obr.id_pref = 10 and obr.idk_work not in (0,99) order by obr.code;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  //ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);


    //ZQXLReps->MacroByName("obrtable")->AsString="seb_obr";

   // ZQXLReps->ParamByName("pref")->AsInteger=10;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());



  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);


  {
    xlReport->ParamByName["caption"]->Value = "Оборотна відомість по актам за порушення режимів споживання";
  }


  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//------------------------------------------------------------------------------
void TfReports::PrintFizAbonFidersDem(TDateTime mmgg, boolean Build )
{
  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  AnsiString  sqlstr1="  select c.book,c.code,trim(c.name) as short_name, ba.num_meter, coalesce(id_grp,-1) as link, c.id_eqpborder, \
 CASE WHEN coalesce(c.id_state,0)=50 THEN 'Архив'::::varchar WHEN id_p_point is not null THEN 'Дубль'::::varchar ELSE ''::::varchar END as fdubl , value as dem , c.set_power \
 from bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join acm_privdem_tbl as pd on (pd.id_client = ba.id_client) \
 where pd.mmgg = :mmgg order by link,book, code; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  // фидера

  AnsiString  sqlstr2="  select coalesce(ffs.id_st,ffs.id_fider) as link, ffs.f, \
  CASE WHEN ffs.f = 1 THEN eq.name_eqp WHEN ffs.f = 2 THEN ' - '||eq.name_eqp \
  WHEN ffs.f = 0 THEN 'Підстанції не підключені до фідерів'  ELSE 'Непідключені абоненти' END as name, coalesce(d.dem,0) as dem, coalesce(d.cnt,0) as cnt \
  from (select 1 as f,code_eqp as id_fider , NULL as id_st from eqm_fider_tbl \
        union \
        select distinct 2, coalesce(fs.id_fider,0), ba.id_grp from bal_abons_tbl as ba \
         join eqm_equipment_tbl as e on (e.id = ba.id_grp) \
         left join bal_fider_st_tbl as fs on (ba.id_grp = fs.id_st) \
         where e.type_eqp = 8 \
        union \
        select -1,-1,NULL \
        union \
        select 0,0,NULL   ) as ffs \
  left join eqm_equipment_tbl as eq on (eq.id = coalesce(ffs.id_st,ffs.id_fider)) \
  left join ( \
    select sum(value) as dem, count(*) as cnt, coalesce(ba.id_grp,-1) as grp from bal_abons_tbl as ba join acm_privdem_tbl as pd on (pd.id_client = ba.id_client) \
    where pd.mmgg = :mmgg group by ba.id_grp ) as d on (d.grp = coalesce(ffs.id_st,ffs.id_fider)) \
  where ((d.dem is not null) or (ffs.f in (1,0 ))) \
  and ((ffs.id_fider = :fider) or ( :fider = 0 )) \
  order by ffs.id_fider, f, name ; ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();
  ZQXLRepsSum->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  AnsiString caption = "Споживання населення за мiсцем пiдключення до мереж РЕМ. ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//---------------------------------------------------------------------------
void TfReports::Print9NKRE_d1(TDateTime mmgg)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1="select cl.code, cl.short_name,ss.*, ident as link from \
  (select tgr.ident, b.id_client, eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum  \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  where b.id_pref=10 \
  and bs.mmgg =:mmgg \
  and (tgr.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23','tgr8_62' )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, eq.name_eqp,tgr.ident  \
  union \
 select distinct tgr2.ident, coalesce(use.id_client, tr.id_client),eq2.name_eqp,0,0 \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join aci_tarif_tbl as tar2 on (tar2.id=ph2.id_tarif) \
  join eqi_grouptarif_tbl as tgr2 on (tar2.id_grouptarif=tgr2.id) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  (tgr2.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23','tgr8_62' )) \
  and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ; ";


  AnsiString  sqlstr2="select tgr2.ident, tgr2.name, tgr2.ident as link, ss.*, \
  CASE WHEN tgr2.ident ='tgr7_13' THEN 'tgr8_41' WHEN tgr2.ident ='tgr8_101' THEN 'tgr8_42' WHEN ident ='tgr7_23' THEN 'tgr8_43' ELSE tgr2.ident END as sort \
  from \
  (select tgr.id as tgr_id, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum  \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  where b.id_pref=10 \
  and bs.mmgg =:mmgg \
  and (tgr.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23','tgr8_62' )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  and cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  group by tgr.id \
 ) as ss \
 join eqi_grouptarif_tbl as tgr2 on (ss.tgr_id=tgr2.id) \
  order by sort ; ";


 /*

   select cl.code, cl.short_name, eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref=10 and cl.book = -1 \
  and bs.mmgg =:mmgg \
  and (tgr.ident like 'tgr8%'  or (tgr.ident like 'tgr7%' and p.id = 1005)) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by cl.code, cl.short_name, eq.name_eqp \
  having sum(bs.demand_val)<>0 or round(sum(bs.sum_val),2) <>0  order by cl.code ;";

  */
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;


  // итоговые суммы
  AnsiString  sqlstr3=" select \
         coalesce(sum(CASE WHEN (ident in ('tgr8_10','tgr8_12','tgr8_22','tgr8_30','tgr8_32')) THEN demand_val ELSE 0 END ),0) as demand1, \
         coalesce(sum(CASE WHEN (ident in ('tgr8_10','tgr8_12','tgr8_22','tgr8_30','tgr8_32')) THEN sum_val ELSE 0 END ),0) as sumval1, \
         coalesce(sum(CASE WHEN ident like 'tgr7%' THEN demand_val ELSE 0 END ),0) as demand2, \
         coalesce(sum(CASE WHEN ident like 'tgr7%' THEN sum_val ELSE 0 END ),0) as sumval2, \
         coalesce(sum(CASE WHEN ident ='tgr8_62' THEN demand_val ELSE 0 END ),0) as demand3, \
         coalesce(sum(CASE WHEN ident ='tgr8_62' THEN sum_val ELSE 0 END ),0) as sumval3, \
         count(distinct id) as aboncount \
  from ( \
  select cl.id, ph.code_eqp, tgr.ident, coalesce(ph.id_extra,0) as extra, bs.demand_val, bs.sum_val \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref=10 and cl.book = -1  and bs.sum_val <>0 \
  and bs.mmgg =:mmgg \
  and (tgr.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23','tgr8_62' )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  order by code_eqp \
) as s2 ;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr3);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  ZQXLReps->First();
  int cl =0;
  int cl_count = 0;
  for(int i=1;i<=ZQXLReps->RecordCount;i++)
  {
   if (ZQXLReps->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps->FieldByName("code")->AsInteger;
    cl_count++;
   }
   ZQXLReps->Next();
  }

  ZQXLReps->Close();
  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLReps2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcount";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lcount"]->Value = IntToStr(cl_count);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLRepsSum->Close();
 ZQXLReps->Close();
 ZQXLReps2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------
void TfReports::Print9NKRE_d3(TDateTime mmgg)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select cl.code, cl.short_name,ss.* from \
  (select b.id_client, eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum , vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where b.id_pref=10 \
  and bs.mmgg =:mmgg \
  and ph.id_extra in (1001,1002,1012,1013) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, eq.name_eqp, vv.voltage_min \
  union \
 select distinct coalesce(use.id_client, tr.id_client),eq2.name_eqp,0,0,vv2.voltage_min \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join eqk_voltage_tbl as vv2 on (vv2.id=ph2.id_voltage) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  ph2.id_extra in (1001,1002,1012,1013) and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  // итоговые суммы
  AnsiString  sqlstr2=" select \
   coalesce(sum(CASE WHEN voltage<=160 and voltage>=110 THEN demand_val ELSE 0 END ),0) as demand110, \
   coalesce(sum(CASE WHEN voltage<=35 and voltage>=27  THEN demand_val ELSE 0 END ),0) as demand35, \
   coalesce(sum(CASE WHEN voltage<=160 and voltage>=110 THEN sum_val ELSE 0 END ),0) as sum110, \
   coalesce(sum(CASE WHEN voltage<=35 and voltage>=27  THEN sum_val ELSE 0 END ),0) as sum35, \
   coalesce(sum(CASE WHEN voltage<=10 and voltage>=3 THEN demand_val ELSE 0 END ),0) as demand10, \
   coalesce(sum(CASE WHEN voltage=0.4  THEN demand_val ELSE 0 END ),0) as demand04, \
   coalesce(sum(CASE WHEN voltage<=10 and voltage>=3 THEN sum_val ELSE 0 END ),0) as sum10, \
   coalesce(sum(CASE WHEN voltage=0.4  THEN sum_val ELSE 0 END ),0) as sum04, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=160 and voltage>=110 THEN demand_val ELSE 0 END ),0) as demand110p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=35 and voltage>=27  THEN demand_val ELSE 0 END ),0) as demand35p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=160 and voltage>=110 THEN sum_val ELSE 0 END ),0) as sum110p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=35 and voltage>=27  THEN sum_val ELSE 0 END ),0) as sum35p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=10 and voltage>=3 THEN demand_val ELSE 0 END ),0) as demand10p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage=0.4  THEN demand_val ELSE 0 END ),0) as demand04p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage<=10 and voltage>=3 THEN sum_val ELSE 0 END ),0) as sum10p, \
   coalesce(sum(CASE WHEN extra =1002 and voltage=0.4  THEN sum_val ELSE 0 END ),0) as sum04p, \
   count(distinct id) as aboncount \
  from ( \
  select cl.id, ph.code_eqp, tgr.ident, coalesce(ph.id_extra,0) as extra, bs.demand_val, bs.sum_val, vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref=10 and cl.book = -1  and bs.sum_val <>0 \
  and bs.mmgg =:mmgg \
  and p.id in (1001,1002,1012,1013) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  order by code_eqp \
) as s2 ;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  ZQXLReps->First();
  int cl =0;
  int cl_count = 0;
  for(int i=1;i<=ZQXLReps->RecordCount;i++)
  {
   if (ZQXLReps->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps->FieldByName("code")->AsInteger;
    cl_count++;
   }
   ZQXLReps->Next();
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLReps2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcount";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lcount"]->Value = IntToStr(cl_count);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();
}
//------------------------------------------------------------------------------
void TfReports::Print9NKRE_d2(TDateTime mmgg)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1="   select cl.code, cl.short_name,ss.* from \
  (select b.id_client, eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum , vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where b.id_pref=10 \
  and bs.mmgg =:mmgg \
  and ph.id_extra in (1003,1004) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, eq.name_eqp, vv.voltage_min \
  union \
 select distinct coalesce(use.id_client, tr.id_client),eq2.name_eqp,0,0,vv2.voltage_min \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join eqk_voltage_tbl as vv2 on (vv2.id=ph2.id_voltage) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  ph2.id_extra in (1003,1004) and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  // итоговые суммы
  AnsiString  sqlstr2=" select \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=160 and voltage>=110 THEN demand_val ELSE 0 END ),0) as demand110, \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=35 and voltage>=27  THEN demand_val ELSE 0 END ),0) as demand35, \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=160 and voltage>=110 THEN sum_val ELSE 0 END ),0) as sum110, \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=35 and voltage>=27  THEN sum_val ELSE 0 END ),0) as sum35, \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=10 and voltage>=3 THEN demand_val ELSE 0 END ),0) as demand10, \
   coalesce(sum(CASE WHEN extra =1003 and voltage=0.4  THEN demand_val ELSE 0 END ),0) as demand04, \
   coalesce(sum(CASE WHEN extra =1003 and voltage<=10 and voltage>=3 THEN sum_val ELSE 0 END ),0) as sum10, \
   coalesce(sum(CASE WHEN extra =1003 and voltage=0.4  THEN sum_val ELSE 0 END ),0) as sum04, \
   coalesce(sum(CASE WHEN extra =1004 THEN demand_val ELSE 0 END ),0) as demandp, \
   coalesce(sum(CASE WHEN extra =1004 THEN sum_val ELSE 0 END ),0) as sump, \
   count(distinct id) as aboncount \
  from ( \
  select cl.id, ph.code_eqp, tgr.ident, coalesce(ph.id_extra,0) as extra, bs.demand_val, bs.sum_val, vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref=10 and cl.book = -1  and bs.sum_val <>0 \
  and bs.mmgg =:mmgg \
  and p.id in (1003,1004) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  order by code_eqp \
) as s2 ;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  ZQXLReps->First();
  int cl =0;
  int cl_count = 0;
  for(int i=1;i<=ZQXLReps->RecordCount;i++)
  {
   if (ZQXLReps->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps->FieldByName("code")->AsInteger;
    cl_count++;
   }
   ZQXLReps->Next();
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLReps2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcount";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lcount"]->Value = IntToStr(cl_count);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();

}

//------------------------------------------------------------------------------
void TfReports::PrintLimitList(TDateTime mmgg)
{
 AnsiString  sqlstr1=" select cl.code,cl.name,s.month_limit ,s.value_dem,cl.represent_name \
 from ( select c.id,c.code,c.short_name as name, cp.represent_name  \
        from clm_client_tbl as c \
        join clm_statecl_tbl as scl on (c.id = scl.id_client) \
        left join clm_position_tbl as cp on (scl.id_position = cp.id) \
        where scl.id_section not in (205,206,207,208) \
        and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
        and c.book=-1 \
      )  as cl \
   left join ( \
   select hl.id_client,d1.month_limit, sum(d1.value_dem) as value_dem \
     from acd_demandlimit_tbl as d1 \
     join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and d2.month_limit= :mmgg \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
     where hl.idk_document = 600  and d1.month_limit= :mmgg \
     group by hl.id_client,d1.month_limit \
     order by hl.id_client \
   ) as s on s.id_client =cl.id \
 order by cl.code,s.month_limit ;";

 /*
  select d1.id_client,d1.value_dem,d1.month_limit from acd_demandlimit_tbl as d1  \
   join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
   where hl.idk_document = 600 and d1.mmgg=(select max(mmgg) from acd_demandlimit_tbl d2 \
        where d1.id_client=d2.id_client and d1.month_limit=d2.month_limit \
   and month_limit= :mmgg )

 */
 /*
      join ( \
      select h2.id_client, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
      from acm_headdemandlimit_tbl as h2 join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
      where h2.idk_document = 600 and d2.month_limit= :mmgg \
      group by h2.id_client order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg ) \

 */

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintEmptyIndication(TDateTime mmgg)
{
 AnsiString  sqlstr1=" select c.code, c.short_name,hi.reg_num, hi.reg_date from \
 (select i.id_doc,i.id_client, sum(coalesce(dind.value,0)) \
  from acm_headindication_tbl as i \
  left join dci_document_tbl as dk on (i.idk_document = dk.id) \
  left join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  where (dk.ident = 'rep_pwr') and date_trunc('month',i.mmgg)= :mmgg \
  group by i.id_doc,i.id_client \
  having sum(coalesce(dind.value,0))=0 \
 ) as s join clm_client_tbl as c on (c.id = s.id_client) \
 join acm_headindication_tbl as hi on (hi.id_doc = s.id_doc) \
 order by c.code ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintAreaDemand6(TDateTime mmgg)
{
//  AnsiString sqlstr;

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }


  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select ( :mmgg::::date - '5 month'::::interval)::::date as dt1,( :mmgg::::date )::::date as dt2 ;");

  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
   ZQReps->Open();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  TDateTime dt1 =   ZQReps->FieldByName("dt1")->AsDateTime;
  TDateTime dt2 =   ZQReps->FieldByName("dt2")->AsDateTime;

  ZQReps->Close();

  AnsiString  sqlstr1=" select sss.*, coalesce(gr.power,power_p) as power \
  from (select c.code, c.short_name, eq.id,eq.name_eqp, addr.adr, scl.doc_num, round(sum(bs.demand6),0) as demand6,  \
  sum(bs.demand_a1) as demand_a1, sum(bs.demand_r1) as demand_r1, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) and (coalesce(p.con_power_kva,0) = 1 )then p.connect_power ELSE 0 END ) as connect_power_kva, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) and (coalesce(p.con_power_kva,0) = 0 )then p.connect_power ELSE 0 END ) as connect_power_kvt, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) then p.power ELSE 0 END) as power_p, \
  sum(distinct grp.name_eqp||',') as connect_names, \
  min(coalesce(p.safe_category,3)) as safety \
  from \
  ( select * from ( \
  ( select b.id_client, bs.id_point, sum(bs.demand_val)/count(distinct bs.mmgg)::::numeric as demand6  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where ( ( (b.id_pref = 10) and (b.idk_doc<>280)  ) or (b.id_pref=101) ) \
    and b.mmgg <= :mmgg and b.mmgg >= :mmgg::::date-'5 month'::::interval \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bs6 \
  full join ( select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric as demand_a1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where ( ( (b.id_pref = 10) and (b.idk_doc<>280)  ) or (b.id_pref=101) ) \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bsa1 using (id_client,id_point) \
  full join ( select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric as demand_r1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=20 \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bsr1 using (id_client,id_point) \
  ) as bbs ) as bs     \
  join clm_client_tbl as c on (c.id = bs.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  join eqm_point_tbl as p on (bs.id_point = p.code_eqp) \
  left join bal_abons_tbl as ba on (ba.id_point = bs.id_point) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = bs.id_point) \
  left join eqm_equipment_tbl as grp on (grp.id = ba.id_grp) \
  left join eqm_compens_station_inst_tbl as csi on (bs.id_point = csi.code_eqp) \
  left join eqm_equipment_tbl as eq on (eq.id = csi.code_eqp_inst) \
  left join adv_address_tbl as addr on (addr.id = eq.id_addres) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  where scl.id_section not in (205,206,207,208) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and c.book = -1 and (eq.type_eqp = 11 or eq.id is null) \
  and ( :insp is null or scl.id_position = :insp) \
  group by c.code, c.short_name, eq.id, eq.name_eqp, addr.adr,scl.doc_num \
  ) as sss \
    left join eqm_ground_tbl as gr on (sss.id = gr.code_eqp) \
  order by code,name_eqp ;";

//   left join clm_statecl_h as scl on (c.id = scl.id_client) \
//  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  AnsiString  sqlstr2=" select c.code, c.short_name, scl.doc_num, round(sum(bs.demand6),0) as demand6,  \
  sum(bs.demand_a1) as demand_a1, sum(bs.demand_r1) as demand_r1, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) and (coalesce(p.con_power_kva,0) = 1 )then p.connect_power ELSE 0 END ) as connect_power_kva, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) and (coalesce(p.con_power_kva,0) = 0 )then p.connect_power ELSE 0 END ) as connect_power_kvt, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) then p.power ELSE 0 END) as power \
  from \
  ( select * from ( \
  ( select b.id_client, bs.id_point, sum(bs.demand_val)/count(distinct bs.mmgg)::::numeric as demand6  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=10 \
    and b.mmgg <= :mmgg and b.mmgg >= :mmgg::::date-'5 month'::::interval \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bs6 \
  full join ( select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric as demand_a1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=10 \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bsa1 using (id_client,id_point) \
  full join ( select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric as demand_r1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=20 \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bsr1 using (id_client,id_point) \
  ) as bbs ) as bs     \
  join clm_client_tbl as c on (c.id = bs.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  join eqm_point_tbl as p on (bs.id_point = p.code_eqp) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = bs.id_point) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  where scl.id_section not in (205,206,207,208) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and c.book = -1  \
  and ( :insp is null or scl.id_position = :insp) \
  group by c.code, c.short_name, scl.doc_num \
  order by c.code ;";

  ZQXLReps2->Close();  
  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps2->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value =" за період "+ FormatDateTime("mmmm yyyy",dt1)+" - "+
        FormatDateTime("mmmm yyyy",dt2);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dt2);


  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();

}
//------------------------------------------------------------------------------
void TfReports::PrintAreaDemand12(TDateTime mmgg)
{
//  AnsiString sqlstr;

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }


  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select ( :mmgg::::date - '1 year'::::interval)::::date as dt1,( :mmgg::::date - '1 month'::::interval)::::date as dt2 ;");

  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
   ZQReps->Open();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  TDateTime dt1 =   ZQReps->FieldByName("dt1")->AsDateTime;
  TDateTime dt2 =   ZQReps->FieldByName("dt2")->AsDateTime;

  ZQReps->Close();

  AnsiString  sqlstr1=" select sss.*, coalesce(gr.power,power_p) as power \
  from (select c.code, c.short_name, eq.id, eq.name_eqp, addr.adr, scl.doc_num, round(sum(bs.demand),0) as demand,  \
  sum(bsr1.demand_r1::::numeric) as demand_r1, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) then p.connect_power ELSE 0 END ) as connect_power, \
  sum(CASE WHEN (p.reserv=0) and coalesce(p.share,0)=0 and (lp.id_point is null) then p.power ELSE 0 END) as power_p, \
  sum(distinct grp.name_eqp||',') as connect_names \
  from \
  ( select b.id_client, bs.id_point, sum(bs.demand_val)/count(distinct bs.mmgg)::::numeric as demand  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where ( ( (b.id_pref = 10) and (b.idk_doc<>280)  ) or (b.id_pref=101) ) \
    and b.mmgg < :mmgg and b.mmgg >= :mmgg::::date-'1 year'::::interval \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bs \
  left join ( select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric as demand_r1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=20 \
    and b.mmgg = :dt2  \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bsr1 on (bsr1.id_client = bs.id_client and bsr1.id_point = bs.id_point ) \
  join clm_client_tbl as c on (c.id = bs.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  join eqm_point_tbl as p on (bs.id_point = p.code_eqp) \
  left join bal_abons_tbl as ba on (ba.id_point = bs.id_point) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = bs.id_point) \
  left join eqm_equipment_tbl as grp on (grp.id = ba.id_grp) \
  left join eqm_compens_station_inst_tbl as csi on (bs.id_point = csi.code_eqp) \
  left join eqm_equipment_tbl as eq on (eq.id = csi.code_eqp_inst) \
  left join adv_address_tbl as addr on (addr.id = eq.id_addres) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  where scl.id_section not in (205,206,207,208) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and c.book = -1 and (eq.type_eqp = 11 or eq.id is null) \
  and ( :insp is null or scl.id_position = :insp) \
  group by c.code, c.short_name, eq.id, eq.name_eqp, addr.adr,scl.doc_num \
  ) as sss \
    left join eqm_ground_tbl as gr on (sss.id = gr.code_eqp) \
  order by code,name_eqp ;";

//   left join clm_statecl_h as scl on (c.id = scl.id_client) \
//  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt2")->AsDateTime=dt2;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value =" за перiод "+ FormatDateTime("mmmm yyyy",dt1)+" - "+
        FormatDateTime("mmmm yyyy",dt2);

  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dt2);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//--------------------------------------------------------------------------


void __fastcall TfReports::sbInspectorClClick(TObject *Sender)
{
 InspectorId = 0;
 edInspector->Text ="";
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbInspectorClick(TObject *Sender)
{
  AnsiString EmpS="  ";
  TWTDBGrid* Grid;

  AnsiString filt="id_client="+ToStrSQL(ResId);
  Grid=MainForm->CliPositionSel(NULL,filt);
  if(Grid==NULL) return;
  else WPosGrid=Grid;

  WPosGrid->FieldSource= WPosGrid->Table->GetTField("id");

  if (!edInspector->Text.IsEmpty())
    WPosGrid->StringDest = edInspector->Text;
   else
     WPosGrid->StringDest = EmpS;
   WPosGrid->OnAccept=PosAccept;
}
//---------------------------------------------------------------------------
void __fastcall TfReports::PosAccept (TObject* Sender)
{
  InspectorId=WPosGrid->Table->FieldByName("id")->AsInteger;
  edInspector->Text=WPosGrid->Table->FieldByName("represent_name")->AsString;
};
//---------------------------------------------------------------------------
void __fastcall TfReports::ShowIndicDebtor(TDateTime mmgg, TDateTime rdate)
{
//
/*
 AnsiString  sqlstr1="  select id, name, code, phone, represent_name, date_indicat::::date,date_mi( :rdate::::date,date_indicat::::date) as disparity \
  from \
  ( \
   SELECT clm.id, clm.name, clm.code, cp.represent_name,scl.phone , \
      to_date(substr( sel_dt(clm.id,:mmgg::::date),12),'yyyy.mm.dd') as date_indicat \
  FROM clm_client_tbl as clm \
  left join clm_statecl_h as scl on (clm.id = scl.id_client) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  where clm.book = -1 and clm.idk_work not in (0,99) and  coalesce(clm.id_state,0) not in (50,99) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ( :insp is null or scl.id_position = :insp) \
  and coalesce(scl.id_section,0) not in (205,206,207,208) \
  ) as sel1 \
  WHERE \
  (date_indicat is not null) and (date_indicat < :rdate) and \
  id not in \
  (select distinct i.id_client from acm_headindication_tbl as i \
   left join dci_document_tbl as dk on (i.idk_document = dk.id) \
   left join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
   where (dk.ident = 'rep_pwr') and (to_char(i.mmgg,'YYYY-MM')=to_char( :mmgg::::timestamp,'YYYY-MM')) \
   and ((i.flag_priv <> True ) or (i.flag_priv is null)) \
   and dind.value is not null \
   ) and code <> 999 \
  ORDER BY   code ASC; ";
*/

 AnsiString  sqlstr1="  select id, name, code, phone, represent_name, executor, \
  date_indicat::::date,date_mi( :rdate::::date,date_indicat::::date) as disparity \
  from \
  ( \
   SELECT clm.id, clm.name, clm.code, cp.represent_name,cp2.represent_name as executor, scl.phone , \
      to_date(substr( sel_dt(clm.id,:mmgg::::date),12),'yyyy.mm.dd') as date_indicat \
  FROM clm_client_tbl as clm \
  left join clm_statecl_h as scl on (clm.id = scl.id_client) \
  left join clm_position_tbl as cp on (scl.id_position=cp.id) \
  left join clm_position_tbl as cp2 on (scl.id_kur=cp2.id) \
  where clm.book = -1 and clm.idk_work not in (0,99) and  coalesce(clm.id_state,0) not in (50,99,3) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and ( :insp is null or scl.id_position = :insp) \
  and ( :exec is null or scl.id_kur = :exec) \
  and coalesce(scl.id_section,0) not in (205,206,207,208) \
  and scl.dt_end_rent is null \
  ) as sel1 \
  WHERE \
  (date_indicat is not null) and (date_indicat < :rdate) and \
  id not in \
  (select distinct i.id_client \
   from acm_headindication_tbl as i \
   join acd_indication_tbl as di on (i.id_doc = di.id_doc and di.value is not null ) \
   join dci_document_tbl as dk on (i.idk_document = dk.id) \
   left join acd_indication_tbl as di2 on (i.id_doc = di2.id_doc and di2.value is null) \
   where (dk.ident = 'rep_pwr') and (i.mmgg =  :mmgg) \
   and di2.id_doc is null \
   )   ORDER BY   code ASC; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("rdate")->AsDateTime=rdate;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  if (ExecutorId!=0)
     ZQXLReps->ParamByName("exec")->AsInteger=ExecutorId;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;


//  lDate->Caption=DateToStr(rdate);
//  lmmgg->Caption= FormatDateTime("mmmm yyyy",mmgg);

//  rIndication->Preview();
//  xlReport->XLSTemplate = "XL\\IndicDebtor.xls";
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  //xlReport->AddDataSet(ZQIndication,"Range");
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias =  "ZQIndication";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lDate";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lDate"]->Value = DateToStr(rdate);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";

  AnsiString linsp = "" ;

  if (InspectorId!=0)
    linsp = "Iнспектор "+edInspector->Text;

  if (ExecutorId!=0)
    linsp = linsp+" технік по розрахункам "+edExecutor->Text;

  xlReport->ParamByName["linsp"]->Value = linsp;

  xlReport->Report();

}
//---------------------------------------------------------------------------
void TfReports::ShowBillDebtor(TDateTime rdate,int kind_energy)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select clm.id as link, clm.short_name, clm.code, bp.rest,bp.rest_tax,coalesce(b.date_transmis,b.reg_date) as reg_date,b.reg_num,b.id_doc, clp.day_pay_bill, \
  date_mi( :rdate::::date,calend_dt_inc(coalesce(b.date_transmis,b.reg_date)::::date,clp.day_pay_bill)) as debt_days, cp.represent_name \
  from acv_billpay as bp \
  join clm_client_tbl as clm on (clm.id=bp.id_client) \
  join clm_statecl_h as clp on (clm.id=clp.id_client) \
  join acm_bill_tbl as b on (b.id_doc=bp.id_doc) \
  left join clm_position_tbl as cp on (clp.id_position=cp.id) \
  where \
  b.id_pref= :pref \
  and bp.rest<>0 \
  and calend_dt_inc(coalesce(b.date_transmis,b.reg_date)::::date,clp.day_pay_bill)<= :rdate \
  and ( :insp is null or clp.id_position = :insp) \
  and clp.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = clp.id_client and scl2.mmgg_b <= date_trunc('month', :rdate::::date ) ) \
  order by clm.code, b.reg_date;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("rdate")->AsDateTime=rdate;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
    ZQXLReps->Open();
 //   ZQXLRepsSum->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

//  Dsr = xlReport->DataSources->Add();
//  Dsr->DataSet = ZQXLRepsSum;
//  Dsr->Alias =  "ZQXLRepsSum";
//  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
//  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldate";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldate"]->Value = FormatDateTime("dd.mm.yyyy",rdate);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";

  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";  
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформ.послуги";

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";


  xlReport->Report();

 ZQXLReps->Close();
// ZQXLRepsSum->Close();

}

//------------------------------------------------------------------------------
void TfReports::PrintBorderRes(void)
{

  AnsiString  sqlstr1=" select id_clienta,id_clientb,c.code,c.name,count(*) as cnt \
  from eqm_borders_tbl, \
   (select cm.id, cm.code,cm.name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and stcl.id_section not in (205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99,3) ) as c \
  where c.id=eqm_borders_tbl.id_clientb \
  group by id_clienta,id_clientb,c.code,c.name \
  having id_clienta=syi_resid_fun() \
  order by c.code;";


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::PrintBorderA(void)
{

  AnsiString  sqlstr1=" select b.id_clienta,c.code,c.name,count(*) as cnt \
  from eqm_borders_tbl as b \
  join \
   (select cm.id, cm.code,cm.name \
   from clm_client_tbl as cm \
   join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and stcl.id_section not in (205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99,3) ) as c \
  on (c.id=b.id_clienta) \
  join \
   (select cm.id, cm.code \
   from clm_client_tbl as cm \
   join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and stcl.id_section not in (205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99,3) ) as c2 \
  on (c2.id=b.id_clientb) \
  where c.id <> syi_resid_fun() \
  group by id_clienta,c.code,c.name \
  order by c.code;";


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}

////////////---------------------------------------------
void TfReports::PointsForCuriers(TDateTime rdate)
{
  AnsiString sqlstr1;
  TWTQuery *QHead;
  int id_head;
  QHead=new TWTQuery(this);



  if (InspectorId!=0)
   {    AnsiString  sqlstr1=" select * from  acm_inspecth_tbl where (id_position=:kur ) and reg_date=:dat";
   QHead->Sql->Clear();
   QHead->Sql->Add(sqlstr1);
   QHead->ParamByName("dat")->AsDateTime=rdate;
   QHead->ParamByName("kur")->AsInteger=InspectorId;
  }
  else
  { AnsiString  sqlstr1=" select * from  acn_inspecth_tbl where id_position is null and reg_date=:dat";
    QHead->Sql->Clear();
   QHead->Sql->Add(sqlstr1);
   QHead->ParamByName("dat")->AsDateTime=rdate;
   };

  try
  {
     QHead->Open();
     if (!(QHead->Eof))
      id_head=QHead->FieldByName("id_doc")->AsInteger;
     else
      ShowMessage("Нет данных о контрольных обходах с запрошенными параметрами! ");
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  ZQReps = new TWTQuery(this);
  ZQReps->MacroCheck=true;
  ZQReps->Options<< doQuickOpen;
  ZQReps->RequestLive=false;
  ZQReps->CachedUpdates=false;
//  ZQReps->Transaction->AutoCommit=true;

  AnsiString sqlstr="select getsysvar('id_person'::::varchar) as curuser;";

  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    cur_user=ZQReps->FieldByName("curuser")->AsInteger;
   }
  ZQReps->Close();

   sqlstr="select to_date(value_ident,'DD.MM.YYYY') as val from syi_sysvars_tbl where ident='mmgg';";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   try
   {
    ZQReps->Open();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
   cur_mmgg = ZQReps->FieldByName("val")->AsDateTime;
   ZQReps->Close();


  sqlstr="select res.id,res.kind_dep,res.short_name, \
  boss.name as bospos,boss.represent_name as bossname, buh.name as buhpos,buh.represent_name as buhname, \
  users.represent_name as usrname, ip.name as usrpos \
  from clm_client_tbl as res \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
   left join clm_position_tbl as users on (users.id = :user ) \
   left join cli_position_tbl as ip  on (ip.id = users.id_position) \
  where res.id = syi_resid_fun() ;";



  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("user")->AsInteger =cur_user ;
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    ZQReps->First();
    ResId=ZQReps->FieldByName("id")->AsInteger;
    ResName=ZQReps->FieldByName("short_name")->AsString;
    res_code=ZQReps->FieldByName("kind_dep")->AsInteger;

   // cur_user=ZQReps->FieldByName("curuser")->AsInteger;
    CurUserName=ZQReps->FieldByName("usrname")->AsString;
    CurUserPos=ZQReps->FieldByName("usrpos")->AsString;
    BossName=ZQReps->FieldByName("bossname")->AsString;
    BossPos=ZQReps->FieldByName("bospos")->AsString;
    BuhName=ZQReps->FieldByName("buhname")->AsString;
    BuhPos=ZQReps->FieldByName("buhpos")->AsString;
    }
  ZQReps->Close();


  sqlstr1="  \
    select  i.id,i.id_doc,i.id_client,cl.code,cl.short_name as short_name,\
       i.id_point,ep.name_eqp as name_eqp, i.id_meter,i.num_eqp, cl.dt_indicat,\
                i.id_address,ad.adr,                                              \
             i.type_eqp,i.carry,i.kind_energy as id_energy,ee.name as kind_energy,  m.dt_control,\
             i.zone as id_zone,ez.name as zone,i.value,i.value_dev,i.dt_insp,i.id_previndic,ii.value as before_indic,ii.dat_ind,ii.value_dem \
             from acm_inspectstr_tbl i left join  \
             (select id,adr from adv_address_tbl  order by id) ad  on  i.id_address=ad.id\
              left  join ( select  i.id,i.value,i.value_dem,i.dat_ind from  acd_indication_tbl i where mmgg>='2007-01-01' order by id) as ii\
                   on (ii.id=i.id_previndic )                                                                                                \
                       ,  (select c.id,c.code,c.short_name,s.dt_indicat from  clm_client_tbl c,clm_statecl_tbl s where c.id=s.id_client) cl,  \
              (select distinct id,name_eqp from (select h.* from eqm_equipment_h h ,                                                          \
  (select id,max(coalesce(dt_e,now())) as dt_e from eqm_equipment_h h group by id) as hh \
   where h.id=hh.id and coalesce(h.dt_e,now())=hh.dt_e ) h                                                                                        \
                         where (dt_e is null or dt_e=(select max(dt_e) from eqm_equipment_h hh where hh.id=h.id) ) and type_eqp=12 order by id  \
               ) ep,    eqm_meter_tbl m,eqk_energy_tbl ee,eqk_zone_tbl ez                                                                      \
                 where  i.id_doc=:head and i.id_point=ep.id and i.id_client=cl.id and  m.code_eqp=i.id_meter and i.kind_energy=ee.id and ez.id=i.zone           \
                order by i.id_doc,i.id_client,i.num_eqp   ";

       ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("head")->AsInteger=id_head;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
//  Dsr->MasterSourceName="ZQXLRepsSum";

    ZQReps->Close();
   sqlstr="select  id_doc,reg_num,reg_date,h.id_position, \
    (pn.name||'  '|| p.represent_name)::::varchar as kur, \
    h.comment,mmgg,flock\
    from acm_inspecth_tbl h,   clm_position_tbl p, cli_position_tbl pn\
       where p.id_position=pn.id  and  h.id_position=p.id and id_doc=:head;";

  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("head")->AsInteger =id_head ;
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
    if (ZQReps->RecordCount>0)
   {
  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldate";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lkur";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
   xlReport->ParamByName["ldate"]->Value = FormatDateTime("dd.mm.yy hh:nn",ZQReps->FieldByName("reg_date")->AsDateTime);

  xlReport->ParamByName["lres"]->Value = ResName;
  Param=xlReport->Params->Add();
  Param->Name="linsp";
  xlReport->ParamByName["lkur"]->Value = "Iнспектор "+ZQReps->FieldByName("kur")->AsString;
  };
  xlReport->Report();

 ZQXLReps->Close();
// ZQXLRepsSum->Close();




}

//------------------------------------------------------------------------------

void __fastcall TfReports::edAbonCodeKeyPress(TObject *Sender, char &Key)
{
 if ((Key==VK_RETURN)&&(edAbonCode->Text!=""))
 {

  AnsiString sqlstr= "select id, short_name, name from clm_client_tbl where code = :code and book =-1 limit 1;";
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("code")->AsString =edAbonCode->Text ;
  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    ZQReps->Close();
    return;
   }
   if (ZQReps->RecordCount>0)
   {
    AbonId=ZQReps->FieldByName("id")->AsInteger;
    edAbonName->Text=ZQReps->FieldByName("short_name")->AsString;
    AbonFullName=ZQReps->FieldByName("name")->AsString;
   }
  ZQReps->Close();

 }

}
//---------------------------------------------------------------------------
void TfReports::PrintWormMeters(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1="select c.code,c.short_name,z.name as name_z,t.name as tarif_n, m.type as meter_type, d.*, \
  case when     date_part('month',d.dat_b) in (1,2,12) \
         and   date_part('month',d.dat_e) in (1,2,12) \
      then round(round(d.kvt/(date_mi(d.dat_e,d.dat_b)+1)::::numeric,2)*(date_mi(d.dt_end,d.dt_begin)+1),0) \
      else d.kvt end as kvt_calc, \
  case when     date_part('month',d.dat_b) in (1,2,12) \
         and   date_part('month',d.dat_e) in (1,2,12) \
      then round(round(round(d.kvt/(date_mi(d.dat_e,d.dat_b)+1)::::numeric,2)*(date_mi(d.dt_end,d.dt_begin)+1),0)*d.tarif*d.koef,2) \
      else round(d.kvt*d.tarif*d.koef,2) end  as sum_calc \
  from \
  (select kvt.id_doc,kvt.id_client,tar.id_zone,tar.kind_energy, tar.id_tariff, kvt.id_type_eqp, \
  tar.id_point,kvt.num_eqp,kvt.dat_b,kvt.dat_e, tar.dt_begin,tar.dt_end,kvt.kvt,tar.koef,tar.tarif \
   from \
    (select d.id_doc,d.id_point,b.id_client,d.num_eqp,d.kind_energy,d.id_zone,d.id_type_eqp, \
      d.dat_b,d.dat_e, d.mmgg,d.calc_demand_w as kvt \
    from acd_met_kndzn_tbl d,  acm_bill_tbl b \
    where  calc_demand_w is not null \
     and d.id_doc=b.id_doc \
     and b.mmgg= :mmgg \
     and b.id_pref = :pref \
    order by d.id_doc,d.id_point \
   )  as kvt \
   right join \
   ( select bs.id_doc,id_point,bs.dt_begin,bs.dt_end,bs.kind_energy,bs.id_zone,id_zonekoef,z.koef, \
           id_tariff,id_sumtariff,t.value as tarif \
     from acm_bill_tbl b ,acd_billsum_tbl bs,acd_zone_tbl z,acd_tarif_tbl t, \
         (select distinct id_doc  from acd_met_kndzn_tbl \
           where  calc_demand_w is not null and mmgg= :mmgg \
         )  as need_s \
     where bs.id_zonekoef=z.id and bs.id_sumtariff=t.id \
         and need_s.id_doc=bs.id_doc and b.id_pref = :pref and bs.id_doc = b.id_doc order by bs.id_doc,bs.id_point \
    ) as tar \
   on (tar.id_doc=kvt.id_doc and tar.id_point=kvt.id_point) \
  ) as d \
  , clm_client_tbl c, eqk_zone_tbl z , aci_tarif_tbl t , eqi_meter_tbl m \
   where  c.id=d.id_client and d.id_zone=z.id and m.id = d.id_type_eqp \
   and d.id_tariff=t.id  and date_part('month',d.dt_begin) in (1,2,12) and date_part('month',d.dt_end) in (1,2,12) \
   order by c.code, num_eqp, name_z;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy == 0)  ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy == 1)  ZQXLReps->ParamByName("pref")->AsInteger=20;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
// акт по 2-зонным
void TfReports::PrintAkt_2zon(TDateTime mmgg,int client)
{

  AnsiString  sqlstr1="select abonname,  resname, bill.demand1,bill.demand2, bill.demand2_old, bill.demand2_new, \
  bill.sum1,bill.sum2,bill.sum2_old, bill.sum2_new, \
  b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, sa.pay, \
  sa.deb_e,  sa.e_val, sa.e_valtax, \
  bospos, bossname,  buhpos, buhname, adr , abn_boss \
  from \
  ( select abon.name as abonname, res.name as resname, boss.name as bospos,boss.represent_name as bossname, aa.adr, \
  buh.name as buhpos,buh.represent_name as buhname, ss.e_val+ss.e_valtax as deb_e,  ss.e_val, ss.e_valtax, ss.kt_val as pay, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join acm_saldo_tbl as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.mmgg = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) \
  ) as sa \
  left join ( select bm.id_client, \
  sum(CASE WHEN bs.id_zone=4 THEN bs.demand_val ELSE 0 END) as demand1, \
  sum(CASE WHEN bs.id_zone=5 THEN bs.demand_val ELSE 0 END) as demand2, \
  sum(CASE WHEN bs.id_zone=5 and  z.koef = 1.5  THEN bs.demand_val ELSE 0 END) as demand2_old, \
  sum(CASE WHEN bs.id_zone=5 and  z.koef = 1.85  THEN bs.demand_val ELSE 0 END) as demand2_new, \
  sum(CASE WHEN bs.id_zone=4 THEN bs.sum_val ELSE 0 END) as sum1, \
  sum(CASE WHEN bs.id_zone=5 THEN bs.sum_val ELSE 0 END) as sum2, \
  sum(CASE WHEN bs.id_zone=5 and  z.koef = 1.5  THEN bs.sum_val ELSE 0 END) as sum2_old, \
  sum(CASE WHEN bs.id_zone=5 and  z.koef = 1.85  THEN bs.sum_val ELSE 0 END) as sum2_new \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as bm using (id_doc) \
  join acd_zone_tbl as z on (z.id = bs.id_zonekoef) \
  where bs.id_zone in (4,5) and bs.kind_energy=1 \
  and bm.id_client = :client \
  and date_trunc('month',bs.mmgg)=date_trunc('month', :mmgg::::date) \
  group by bm.id_client ) as bill on (1=1) \
  left join (select max(reg_date) as reg_date ,max(reg_num) as reg_num, \
   sum(value) as value, sum(value_tax) as value_tax ,sum(demand_val) as demand_val from acm_bill_tbl \
   where id_client = :client and date_trunc('month',mmgg)=date_trunc('month', :mmgg::::date) and id_pref =10 )as b on (1=1);  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  if ((year1 = 2014)&&(month1==12))
     xlReport->XLSTemplate = "XL\\akt_2z_12_2014.xls";
  else
     xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;


  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

//  Param=xlReport->Params->Add();
//  Param->Name="lnow";
//  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

//  xlReport->ParamByName["workdt"]->Value = dt;

 xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
// акт по ел.транспорту
void TfReports::PrintAkt_Trans(TDateTime mmgg,int client)
{

  AnsiString  sqlstr1="select abonname, abonshname, resshname,  resname, bill.demand1,bill.demand2, \
  bill.sum1,bill.sum2,b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, sa.pay, \
  sa.deb_e,  sa.e_val, sa.e_valtax, \
  bospos, bossname,  buhpos, buhname, adr , abn_boss \
  from \
  ( select abon.name as abonname, abon.short_name as abonshname, res.name as resname, res.short_name as resshname, boss.name as bospos,boss.represent_name as bossname, aa.adr, \
  buh.name as buhpos,buh.represent_name as buhname, ss.e_val+ss.e_valtax as deb_e,  ss.e_val, ss.e_valtax, ss.kt_val as pay, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join acm_saldo_tbl as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.mmgg = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) \
  ) as sa \
  left join ( select bm.id_client, \
  sum(CASE WHEN tcl.ident='tcl1' THEN bs.demand_val ELSE 0 END) as demand1, \
  sum(CASE WHEN tcl.ident='tcl2' THEN bs.demand_val ELSE 0 END) as demand2, \
  sum(CASE WHEN tcl.ident='tcl1' THEN bs.sum_val ELSE 0 END) as sum1, \
  sum(CASE WHEN tcl.ident='tcl2' THEN bs.sum_val ELSE 0 END) as sum2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as bm using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tgr.ident = 'tgr4' \
  and bs.kind_energy=1 \
  and bm.id_client = :client \
  and date_trunc('month',bs.mmgg)=date_trunc('month', :mmgg::::date) \
  group by bm.id_client ) as bill on (1=1) \
  left join (select max(reg_date) as reg_date ,max(reg_num) as reg_num, \
   sum(value) as value, sum(value_tax) as value_tax ,sum(demand_val) as demand_val from acm_bill_tbl \
   where id_client = :client and date_trunc('month',mmgg)=date_trunc('month', :mmgg::::date) and id_pref =10 )as b on (1=1);  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

//  Param=xlReport->Params->Add();
//  Param->Name="lnow";
//  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

//  xlReport->ParamByName["workdt"]->Value = dt;

 xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
// акт по ел.транспорту
void TfReports::PrintAkt_Him(TDateTime mmgg,int client)
{

  AnsiString  sqlstr1="select abonname, abonshname, resshname,  resname, bill.demand1,bill.demand2, \
  bill.sum1,bill.sum2,b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, sa.pay, \
  sa.deb_e,  sa.e_val, sa.e_valtax, \
  bospos, bossname,  buhpos, buhname, adr, abn_boss \
  from \
  ( select abon.name as abonname, abon.short_name as abonshname, res.name as resname, res.short_name as resshname, boss.name as bospos,boss.represent_name as bossname, aa.adr, \
  buh.name as buhpos,buh.represent_name as buhname, ss.e_val+ss.e_valtax as deb_e,  ss.e_val, ss.e_valtax, ss.kt_val as pay, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join acm_saldo_tbl as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.mmgg = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) \
  ) as sa \
  left join ( select bm.id_client, \
  sum(CASE WHEN tcl.ident='tcl1' THEN bs.demand_val ELSE 0 END) as demand1, \
  sum(CASE WHEN tcl.ident='tcl2' THEN bs.demand_val ELSE 0 END) as demand2, \
  sum(CASE WHEN tcl.ident='tcl1' THEN bs.sum_val ELSE 0 END) as sum1, \
  sum(CASE WHEN tcl.ident='tcl2' THEN bs.sum_val ELSE 0 END) as sum2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as bm using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where tgr.ident = 'tgr12' \
  and bs.kind_energy=1 \
  and bm.id_client = :client \
  and date_trunc('month',bs.mmgg)=date_trunc('month', :mmgg::::date) \
  group by bm.id_client ) as bill on (1=1) \
  left join (select max(reg_date) as reg_date ,max(reg_num) as reg_num, \
   sum(value) as value, sum(value_tax) as value_tax ,sum(demand_val) as demand_val from acm_bill_tbl \
   where id_client = :client and date_trunc('month',mmgg)=date_trunc('month', :mmgg::::date) and id_pref =10 )as b on (1=1);  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
//  Param=xlReport->Params->Add();
//  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

//  Param=xlReport->Params->Add();
//  Param->Name="lnow";
//  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

//  xlReport->ParamByName["workdt"]->Value = dt;

 xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
// акт по ел.транспорту
void TfReports::PrintAkt_Osv(TDateTime mmgg,int client)
{
   AnsiString  sqlstr;
//   if (Build)
   {
    sqlstr=" select seb_one( date_trunc('month', :mmgg::::date)::::date, 0, :client )";

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
    ZQReps->ParamByName("client")->AsInteger=client;

    try
    {
     ZQReps->ExecSql();

      sqlstr= " update seb_obrs_tmp \
                    set b_dtval=0,    b_ktval=b_ktval-b_dtval \
                 where b_dtval<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
      sqlstr= " update seb_obrs_tmp \
                    set  b_dtval_tax=0, b_ktval_tax=b_ktval_tax-b_dtval_tax   \
               where b_dtval_tax<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_dtval=0,e_ktval=e_ktval-e_dtval \
               where e_dtval<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_dtval_tax=0,e_ktval_tax=e_ktval_tax-e_dtval_tax  \
               where e_dtval_tax<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
     /////////////////////////////////////////////////////
      sqlstr= " update seb_obrs_tmp \
                    set b_ktval=0,    b_dtval=b_dtval-b_ktval \
                 where b_ktval<0 and (select sum(b_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0  \
                                     and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date) \
                 ;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();
      sqlstr= " update seb_obrs_tmp \
                    set     b_ktval_tax=0, b_dtval_tax=b_dtval_tax-b_ktval_tax   \
               where b_ktval_tax<0 and (select sum(b_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date);";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_ktval=0,e_dtval=coalesce(e_dtval,0)-e_ktval \
               where e_ktval<0 and (select sum(e_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0\
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";
                         //
      ZQReps->Close();
      
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_ktval_tax=0,e_dtval_tax=e_dtval_tax-e_ktval_tax  \
               where e_ktval_tax<0 and (select sum(e_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
       ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();


    }
    catch(...)
    {
     ShowMessage("Ошибка SQL :"+sqlstr);
     return;
    }
   }

/*
  AnsiString  sqlstr1="select abonname, abonshname, resshname,  resname, bill.demand1,bill.demand2, \
  bill.sum1,bill.sum2,b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, sa.pay, sa.paytax, \
  sa.deb_e,  sa.kt_e,  \
  bospos, bossname,  buhpos, buhname, adr, abn_boss \
  from \
  ( select abon.name as abonname, abon.short_name as abonshname, res.name as resname, res.short_name as resshname, boss.name as bospos,boss.represent_name as bossname, aa.adr, \
  buh.name as buhpos,buh.represent_name as buhname, -ss.deb_kmv as deb_e, ss.kr_zkmv as kt_e, ss.opl_ze as pay, ss.opl_zpdv as paytax, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join seb_obr_all_tmp as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.period = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) \
  ) as sa \
  left join ( \
  select sss.id_client, sum(demand_n) as demand1, sum(sum_n) as sum1, sum(demand_d) as demand2, sum(sum_d) as sum2 from \
  (select b.id_client, mkz.num_eqp::::varchar, \
  sum(bs.demand_val) as demand_n, sum(bs.sum_val) as sum_n  \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
  left join (select id_point,id_doc, trim(regexp_replace(trim(max(num_eqp)),'(н|д)$',''))::::varchar as num_eqp \
            from acd_met_kndzn_tbl where id_zone = 0 and kind_energy=1 and mmgg = :mmgg group by id_point,id_doc ) as mkz \
            on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc ) \
  left join clm_client_tbl as clm on (clm.id=b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  where bs.id_tariff = 51 and bs.id_zone = 0 and b.id_pref = 10 \
  and b.id_client = :client \
  and b.mmgg = :mmgg and clm.book = -1 \
  group by b.id_client, mkz.num_eqp ) as sss \
  left join \
  (select b.id_client, mkz.num_eqp::::varchar, \
  sum(bs.demand_val) as demand_d, sum(bs.sum_val) as sum_d \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
  left join (select id_point,id_doc, trim(regexp_replace(trim(max(num_eqp)),'(н|д)$',''))::::varchar as num_eqp \
            from acd_met_kndzn_tbl where id_zone = 0 and kind_energy=1 and mmgg = :mmgg group by id_point,id_doc ) as mkz \
            on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc ) \
  left join clm_client_tbl as clm on (clm.id=b.id_client) \
  where bs.id_tariff <> 51 and bs.id_zone = 0 and b.id_pref = 10 \
  and b.id_client = :client \
  and b.mmgg = :mmgg and clm.book = -1 \
  group by b.id_client, mkz.num_eqp ) as sss2 on (sss.id_client = sss2.id_client and sss.num_eqp = sss2.num_eqp) \
  group by sss.id_client      \
  ) as bill on (1=1) \
  left join (select max(reg_date) as reg_date ,max(reg_num) as reg_num, \
   sum(value) as value, sum(value_tax) as value_tax ,sum(demand_val) as demand_val from acm_bill_tbl \
   where id_client = :client and date_trunc('month',mmgg)=date_trunc('month', :mmgg::::date) and id_pref =10 )as b on (1=1);  ";
*/

  AnsiString  sqlstr1="select abonname, abonshname, resshname,  resname, bill.demand1,bill.demand2, \
  bill.sum1,bill.sum2,b.reg_date,b.reg_num, b.value as sum, b.value_tax as sum_tax,b.demand_val as demand, sa.pay, sa.paytax, \
  sa.deb_e,  sa.kt_e,  \
  bospos, bossname,  buhpos, buhname, adr, abn_boss \
  from \
  ( select abon.name as abonname, abon.short_name as abonshname, res.name as resname, res.short_name as resshname, boss.name as bospos,boss.represent_name as bossname, aa.adr, \
  buh.name as buhpos,buh.represent_name as buhname, -ss.deb_kmv as deb_e, ss.kr_zkmv as kt_e, ss.opl_ze as pay, ss.opl_zpdv as paytax, abn_boss \
  from \
  clm_client_tbl as abon \
  left join adv_address_tbl as aa on (aa.id = abon.id_addres) \
  left join seb_obr_all_tmp as ss on (ss.id_client = abon.id) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  clm_client_tbl as res  \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='buh') )as buh  on (buh.id_client = res.id) \
  where abon.id = :client  \
  and ss.period = date_trunc('month', :mmgg::::date) and ss.id_pref = 10 \
  and (res.id = syi_resid_fun() ) \
  ) as sa \
  left join ( \
  select sss.id_client, sum(demand_n) as demand1, sum(sum_n) as sum1, sum(demand_d) as demand2, sum(sum_d) as sum2 from \
  (select b.id_client, trim(regexp_replace(trim(eq.num_eqp),'(н|д)$',''))::::varchar as num_eqp, \
  sum(bs.demand_val) as demand_n, sum(bs.sum_val) as sum_n  \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
  left join eqm_meter_point_h as mp on (mp.id_point = bs.id_point and mp.dt_b <= bs.dt_begin and coalesce(mp.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
  left join eqm_equipment_h as eq on (eq.id = mp.id_meter and eq.dt_b <= bs.dt_begin and coalesce(eq.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
  left join clm_client_tbl as clm on (clm.id=b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  where bs.id_tariff = 51 and bs.id_zone = 0 and b.id_pref = 10 \
  and b.id_client = :client \
  and b.mmgg = :mmgg and clm.book = -1 \
  group by b.id_client, num_eqp ) as sss \
  left join \
  (select b.id_client, trim(regexp_replace(trim(eq.num_eqp),'(н|д)$',''))::::varchar as num_eqp, \
  sum(bs.demand_val) as demand_d, sum(bs.sum_val) as sum_d \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
  left join eqm_meter_point_h as mp on (mp.id_point = bs.id_point and mp.dt_b <= bs.dt_begin and coalesce(mp.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
  left join eqm_equipment_h as eq on (eq.id = mp.id_meter and eq.dt_b <= bs.dt_begin and coalesce(eq.dt_e, bs.dt_begin ) >=bs.dt_begin ) \
  left join clm_client_tbl as clm on (clm.id=b.id_client) \
  where bs.id_tariff <> 51 and bs.id_zone = 0 and b.id_pref = 10 \
  and b.id_client = :client \
  and b.mmgg = :mmgg and clm.book = -1 \
  group by b.id_client, num_eqp ) as sss2 on (sss.id_client = sss2.id_client and sss.num_eqp = sss2.num_eqp) \
  group by sss.id_client      \
  ) as bill on (1=1) \
  left join (select max(reg_date) as reg_date ,max(reg_num) as reg_num, \
   sum(value) as value, sum(value_tax) as value_tax ,sum(demand_val) as demand_val from acm_bill_tbl \
   where id_client = :client and date_trunc('month',mmgg)=date_trunc('month', :mmgg::::date) and id_pref =10 )as b on (1=1);  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="ltime";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

//  Param=xlReport->Params->Add();
//  Param->Name="lnow";
//  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


//  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg)+" року";

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  switch ( month1 ) {

  case 1  :  xlReport->ParamByName["ltime"]->Value = " з 17:00 до 7:00 " ; break;
  case 2  :  xlReport->ParamByName["ltime"]->Value = " з 18:00 до 6:00 " ; break;
  case 3  :  xlReport->ParamByName["ltime"]->Value = " з 19:00 до 5:00 " ; break;
  case 4  :  xlReport->ParamByName["ltime"]->Value = " з 21:00 до 5:00 " ; break;
  case 5  :  xlReport->ParamByName["ltime"]->Value = " з 22:00 до 4:00 " ; break;
  case 6  :  xlReport->ParamByName["ltime"]->Value = " з 22:00 до 4:00 " ; break;
  case 7  :  xlReport->ParamByName["ltime"]->Value = " з 22:00 до 4:00 " ; break;
  case 8  :  xlReport->ParamByName["ltime"]->Value = " з 21:00 до 5:00 " ; break;
  case 9  :  xlReport->ParamByName["ltime"]->Value = " з 20:00 до 5:00 " ; break;
  case 10  :  xlReport->ParamByName["ltime"]->Value = " з 18:00 до 6:00 " ; break;
  case 11  :  xlReport->ParamByName["ltime"]->Value = " з 17:00 до 6:00 " ; break;
  case 12  :  xlReport->ParamByName["ltime"]->Value = " з 17:00 до 7:00 " ; break;
};

//  xlReport->ParamByName["workdt"]->Value = dt;

 xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------

void TfReports::PrintFreeTaxNums(TDateTime mmgg)
{

  AnsiString  sqlstr1=" select max_num,num from (select int_num from acm_tax_tbl as t1 where t1.mmgg = :mmgg \
   union \
  select int_num from acm_taxcorrection_tbl as t2 where t2.mmgg = :mmgg) as t right join syi_taxsequence_tbl as s \
  on (s.num = t.int_num  ), \
(select max(int_num) as max_num from ( \
  select int_num from acm_tax_tbl as t1 where t1.mmgg = :mmgg \
   union \
  select int_num from acm_taxcorrection_tbl as t2 where t2.mmgg = :mmgg) as tt ) as m \
 where  t.int_num is null and s.num <= max_num;  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "За  "+FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::PrintTaxCheck(TDateTime mmgg,int kind_energy,boolean Build)
{
  if (Build)
  {
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add("select seb_all( 0, :mmgg);");
   ZQReps->Sql->Add("select rep_mmggpay_fun( :pref, :mmgg );");


   if (kind_energy==0)
     ZQReps->ParamByName("pref")->AsInteger=10;
   if (kind_energy==1)
     ZQReps->ParamByName("pref")->AsInteger=20;
   if (kind_energy==3)
     ZQReps->ParamByName("pref")->AsInteger=520;


   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;


   try
   {
    ZQReps->ExecSql();
   }
   catch(EDatabaseError &e)
   {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
   }
  }
 /*
  AnsiString  sqlstr1=" select c.id,c.code,c.short_name,cp.flag_budjet, \
  case when coalesce(cp.flag_budjet,0) =1 or id_section in (206,207) then coalesce(pay2001,0)+coalesce(pay2000,0) else coalesce(nar_v,0) - coalesce(kr_zpmv,0)+ coalesce(kr_zkmv,0) +coalesce(pay2000,0) end as sum_val, \
  case when coalesce(cp.flag_budjet,0) =1 or id_section in (206,207) then coalesce(paytax2001,0)+coalesce(paytax2000,0) else coalesce(nar_pdv,0) - coalesce(kr_zpmpdv,0)+ coalesce(kr_zkmpdv,0) +coalesce(paytax2000,0) end as sum_tax, \
  tax.sum_val as doc_val, tax.sum_tax as doc_tax \
  from seb_obr_all_tmp as s left join \
  (select id_client, coalesce(sum(case when period_pay = 2001 then pay else 0 end),0) as pay2001, coalesce(sum(case when period_pay = 2001 then pay_tax else 0 end),0) as paytax2001, \
	coalesce(sum(case when period_pay = 2000 then pay else 0 end),0) as pay2000, coalesce(sum(case when period_pay = 2000 then pay_tax else 0 end),0) as paytax2000 \
	from rep_ndspay_tbl where mmgg = :mmgg::::date group by id_client) as p on (p.id_client = s.id_client ) \
  left join clm_client_tbl as c on (c.id = s.id_client ) \
  left join clm_statecl_tbl as cp on (cp.id_client=c.id) \
  left join \
( select id_client, sum(value+value_tax) as sum_val,sum(value_tax) as sum_tax from \
   (select t.id_client, t.value, t.value_tax \
    from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union all \
    select t.id_client, t.value, t.value_tax \
    from acm_taxcorrection_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
   ) as ssss group by id_client \
  ) as tax on (tax.id_client = s.id_client) \
  where period =  date_trunc('month',:mmgg::::date )and s.id_pref = :pref and c.idk_work not in (0,10,99) and cp.id_section not in (205,208,216,217) \
union \
select cla.id,0,cla.name,2, \
  coalesce(sum(nar_v),0) - coalesce(sum(kr_zpmv),0)+ coalesce(sum(kr_zkmv),0) +coalesce(sum(pay2000),0)  as sum_val, \
  coalesce(sum(nar_pdv),0) - coalesce(sum(kr_zpmpdv),0)+ coalesce(sum(kr_zkmpdv),0) +sum(coalesce(paytax2000,0))  as sum_tax, \
  sum(tax.sum_val) as doc_val, sum(tax.sum_tax) as doc_tax \
  from seb_obr_all_tmp as s left join \
  (  select p.id_client,coalesce(sum(p.value_pay),0) as pay2000 ,coalesce(sum(p.value_tax),0) as paytax2000 \
     from acm_pay_tbl as p \
     left join clm_client_tbl as cm on (cm.id = p.id_client) \
     left join clm_statecl_tbl as cp on (p.id_client=cp.id_client) \
     left join dci_document_tbl as dci on (p.idk_doc=dci.id) \
     where cm.book = -1 and p.mmgg=:mmgg::::date and ((dci.ident<>'writeoff') and (dci.ident<>'wr_off_act')) \
     and (date_part('year',p.mmgg_pay) = 2000 or cm.idk_work = 10 ) \
     and cp.id_section in (205,208) \
     and p.sign_pay = 1 \
     group by p.id_client \
) as p2 on (p2.id_client = s.id_client ) \
  left join clm_client_tbl as c on (c.id = s.id_client ) \
  left join clm_statecl_tbl as cp on (cp.id_client=c.id) \
  left join cla_param_tbl as cla on (cla.id = cp.id_section) \
  left join \
(  select id_client, sum(value+value_tax) as sum_val,sum(value_tax) as sum_tax from \
   (select t.id_client, t.value, t.value_tax \
    from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union all \
    select t.id_client, t.value, t.value_tax \
    from acm_taxcorrection_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
   ) as ssss group by id_client \
  ) as tax on (tax.id_client = s.id_client) \
  where period =  date_trunc('month',:mmgg::::date)and s.id_pref = :pref and c.idk_work not in (0,99) and cp.id_section in (205,208) \
 group by cla.id,cla.name order by code; ";
*/



  AnsiString  sqlstr1=" select c.id,c.code,c.short_name,cp.flag_budjet, \
  case when coalesce(cp.flag_budjet,0) =1 or id_section in (206,207) then coalesce(pay2001,0)+coalesce(pay2000,0) else coalesce(nar_e,0) - coalesce(kr_zpme,0)+ coalesce(kr_zkme,0) +coalesce(pay2000,0) end as sum_val, \
  case when coalesce(cp.flag_budjet,0) =1 or id_section in (206,207) then coalesce(paytax2001,0)+coalesce(paytax2000,0) else coalesce(nar_pdv,0) - coalesce(kr_zpmpdv,0)+ coalesce(kr_zkmpdv,0) +coalesce(paytax2000,0) end as sum_tax, \
  tax.sum_val as doc_val, tax.sum_tax as doc_tax \
  from seb_obr_all_tmp as s left join \
  (select id_client, coalesce(sum(case when period_pay = 2001 then pay-pay_tax else 0 end),0) as pay2001, \
                     coalesce(sum(case when period_pay = 2001 then pay_tax else 0 end),0) as paytax2001, \
            	     coalesce(sum(case when period_pay = 2000 then pay-pay_tax else 0 end),0) as pay2000, \
                     coalesce(sum(case when period_pay = 2000 then pay_tax else 0 end),0) as paytax2000 \
	from rep_ndspay_tbl where mmgg = :mmgg::::date group by id_client) as p on (p.id_client = s.id_client ) \
  left join clm_client_tbl as c on (c.id = s.id_client ) \
  left join clm_statecl_tbl as cp on (cp.id_client=c.id) \
  left join \
( select id_client, sum(value) as sum_val,sum(value_tax) as sum_tax from \
   (select t.id_client, t.value, t.value_tax \
    from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union all \
    select t.id_client, t.value, t.value_tax \
    from acm_taxcorrection_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
   ) as ssss group by id_client \
  ) as tax on (tax.id_client = s.id_client) \
  where period =  date_trunc('month',:mmgg::::date )and s.id_pref = :pref and c.idk_work not in (0,10,99) and cp.id_section not in (205,208,216,217) \
union  all \
select cla.id,0,cla.name,2, \
  coalesce(sum(nar_e),0) - coalesce(sum(kr_zpme),0)+ coalesce(sum(kr_zkme),0) +coalesce(sum(pay2000),0)  as sum_val, \
  coalesce(sum(nar_pdv),0) - coalesce(sum(kr_zpmpdv),0)+ coalesce(sum(kr_zkmpdv),0) +sum(coalesce(paytax2000,0))  as sum_tax, \
  sum(tax.sum_val) as doc_val, sum(tax.sum_tax) as doc_tax \
  from seb_obr_all_tmp as s left join \
  (  select p.id_client,coalesce(sum(p.value),0) as pay2000 ,coalesce(sum(p.value_tax),0) as paytax2000 \
     from acm_pay_tbl as p \
     left join clm_client_tbl as cm on (cm.id = p.id_client) \
     left join clm_statecl_tbl as cp on (p.id_client=cp.id_client) \
     left join dci_document_tbl as dci on (p.idk_doc=dci.id) \
     where cm.book = -1 and p.mmgg=:mmgg::::date and ((dci.ident<>'writeoff') and (dci.ident<>'wr_off_act')) \
     and (date_part('year',p.mmgg_pay) = 2000 or cm.idk_work = 10 ) \
     and cp.id_section in (205,208) \
     and p.sign_pay = 1 \
     group by p.id_client \
) as p2 on (p2.id_client = s.id_client ) \
  left join clm_client_tbl as c on (c.id = s.id_client ) \
  left join clm_statecl_tbl as cp on (cp.id_client=c.id) \
  left join cla_param_tbl as cla on (cla.id = cp.id_section) \
  left join \
(  select id_client, sum(value) as sum_val,sum(value_tax) as sum_tax from \
   (select t.id_client, t.value, t.value_tax \
    from acm_tax_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
    union all \
    select t.id_client, t.value, t.value_tax \
    from acm_taxcorrection_tbl as t  where \
    date_trunc('month',  :mmgg::::date) = date_trunc('month', t.reg_date) \
    and t.id_pref = :pref \
   ) as ssss group by id_client \
  ) as tax on (tax.id_client = s.id_client) \
  where period =  date_trunc('month',:mmgg::::date)and s.id_pref = :pref and c.idk_work not in (0,99) and cp.id_section in (205,208) \
 group by cla.id,cla.name order by code; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;



  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Перевірка податкових накладних (активна енергія)";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Перевірка податкових накладних (реактивна енергія)";
  if (kind_energy==3)
    xlReport->ParamByName["caption"]->Value = "Перевірка податкових накладних (Перевищення ліміту 2кр)";


  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::ShowTableFields(void)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select f.id, id_table as link ,id_type,f.name,f.note,def, t.name as type \
  from syi_field_tbl as f join syi_type_tbl as t on (t.id = id_type ) \
  where coalesce(act,0)=0 order by f.id;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  //

  AnsiString  sqlstr2=" select t.id as link,t.name,note,id_task,act, s.name as grp \
  from syi_table_tbl as t join syi_task_tbl as s on (s.id = id_task) where act =0 \
  order by id_task, name;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLReps->Open();
    ZQXLRepsSum->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsT";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsT";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

}

//---------------------------------------------------------------------------
void TfReports::PrintTT(TDateTime mmgg,boolean Build)
{

  if (Build)
  {
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add("select rep_tt_fun( :mmgg);");

   ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;


   try
   {
    ZQReps->ExecSql();
   }
   catch(EDatabaseError &e)
   {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
   }
  }

  AnsiString  sqlstr1="  select c.code, c.short_name, ss.*, i.type from \
  (select id_client,id_point,name,id_tt1 as id_tt,type_tt1 as type_tt,demand_val from rep_tt_tmp \
   union \
   select id_client,id_point,name,id_tt2,type_tt2,demand_val from rep_tt_tmp \
  ) as ss \
  join eqi_compensator_i_tbl as i on (i.id = type_tt) \
  join clm_client_tbl as c on (c.id = ss.id_client) \
  where ss.id_tt is not null order by type,c.code; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);


  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintAbon2Month( TDateTime mmgg1, TDateTime mmgg2)
{

  AnsiString sqlstr = "select tgr.short_name as tgr_name, tcl.name as class, c.code, c.short_name , \
  demand1, sum1, demand2,sum2 \
  from ( \
  (select b.id_client,tar.id_classtarif,tar.id_grouptarif, \
  sum(bs.demand_val) as demand1,  sum(bs.sum_val) as sum1 \
  from acd_billsum_tbl as bs join acm_bill_tbl as b using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  where  b.mmgg = date_trunc('month',:mmgg1::::date) and b.id_pref = 10 and coalesce(bs.demand_val,0)<>0 \
  group by b.id_client,tar.id_classtarif,tar.id_grouptarif )as s1 \
  full outer join \
  (select b.id_client,tar.id_classtarif,tar.id_grouptarif, \
  sum(bs.demand_val) as demand2,  sum(bs.sum_val) as sum2 \
  from acd_billsum_tbl as bs join acm_bill_tbl as b using (id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  where  b.mmgg = date_trunc('month',:mmgg2::::date) and b.id_pref = 10 and coalesce(bs.demand_val,0)<>0 \
  group by b.id_client,tar.id_classtarif,tar.id_grouptarif )as s2 \
  using (id_client,id_classtarif,id_grouptarif) \
  ) as ss \
  join clm_client_tbl as c on (c.id = ss.id_client) \
  join eqi_classtarif_tbl as tcl on (ss.id_classtarif=tcl.id) \
  join eqi_grouptarif_tbl as tgr on (ss.id_grouptarif=tgr.id) \
  order by tcl.name,tgr.ident,c.code, tgr.short_name, tcl.name; ";

  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;  

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg1";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg2";

  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg1"]->Value = FormatDateTime("mmmm yyyy",mmgg1);
  xlReport->ParamByName["lmmgg2"]->Value = FormatDateTime("mmmm yyyy",mmgg2);

//  AnsiString caption = "Абоненти, що мають нульове споживання.";
//  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonList(void)
{

  AnsiString sqlstr = " select c.id,c.code,c.name,short_name,doc_dat,doc_num,flag_budjet,id_section,addr_tax, addr_main,sc.phone, \
  licens_num,okpo_num,tax_num, period_indicat,dt_indicat,dt_start,day_pay_bill,sc.phone,month_indicat,sc.id_position,id_kur,id_depart , \
  flag_taxpay,id_section,flag_key,grp.name as gp_name, mn.name as min_name,cp1.represent_name as inspector,cp2.represent_name as executor, a.adr, pp.point_cnt, \
  pre_pay_day1, pre_pay_perc1, pre_pay_day2 , pre_pay_perc2 , \
  pre_pay_day3 , pre_pay_perc3 , flag_bank_day, flag_hlosts, CASE WHEN type_pay =1 THEN 1 ELSE 0 END as type_pay, \
  tr_doc_num, tr_doc_date, tr_year_price,  tr_doc_type, \
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as tr_doc_type_str, \
  CASE WHEN  sc.tr_doc_period =1 THEN 'Щомісячно' WHEN  sc.tr_doc_period =2 THEN 'Щорічно' END as tr_doc_period_str, \
  CASE WHEN coalesce(sc.flag_jur,0)=1 THEN 'юр.особа' ELSE 'фіз.особа' END as jur_str, sc.flag_ed, boss.boss_name, boss.boss_phone, \
  c.add_name \
  from clm_client_tbl as c \
  join clm_statecl_h as sc on (c.id = sc.id_client) \
  left join cla_param_tbl as grp on (grp.id = sc.id_section) \
  left join cla_param_tbl as mn on (mn.id = sc.id_depart) \
  left join clm_position_tbl as cp1 on (sc.id_position=cp1.id) \
  left join clm_position_tbl as cp2 on (sc.id_kur=cp2.id) \
  left join adv_address_tbl as a on (a.id = c.id_addres) \
  left join ( \
    select cl.id as id_client, count(p.code_eqp ) as point_cnt \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_point_tbl as p on (ttr.code_eqp = p.code_eqp) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = p.code_eqp) \
    left join clm_client_tbl as cl on (cl.id = coalesce (use.id_client, tr.id_client)) \
    group by cl.id \
  ) as pp on (pp.id_client = c.id) \
  left join ( select pos.id_client, pos.represent_name as boss_name, p.name as position, pos.phone as boss_phone\
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
            where (p_1.minid is not null ) or (pc.cnt = 1) \
            order by id_client     ) as boss on ( boss.id_client = c.id) \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code;";

  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();

  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintCompens5(TDateTime mmgg1, TDateTime mmgg2, boolean Build)
{
     int kpv=99999999;
     int comp =999999999;
  if (Ask("Вывести только недогруженные трансформаторы ?") )
     {kpv=5;
       comp=0;
      };
   if (Build)
  {

  if(MessageDlg("Обновить даные по недогруженным трансформаторам? (~ 5-10 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  calc_compens(:mmgg) ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
            ZQReps->ParamByName("mmgg")->AsDateTime=mmgg1;
    try
     {
      ZQReps->ExecSql();
      ZQReps->Close();
     ZQReps->Sql->Clear();
     AnsiString sqlstr="select  close() ;";
     ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(" select \
       distinct k.mmgg,b.code,b.name,e.name_eqp as name_point, rclient.short_name as rname, rclient.code as rcode, \
       e.volt_name,k.id_doc,k.id_point,k.id_meter,k.num_eqp,k.id_zone,ke.name as name_energy, \
       k.wtml,k.met_demand,k.k_ts,k.k_tr,k.ktr_demand,k.p_w,k.calc_demand_nocnt,\
          case when k.calc_demand_nocnt-k.ktr_demand>0 then k.calc_demand_nocnt-k.ktr_demand else 0 end  as minus,  \
          CASE WHEN pp.count_itr=0 THEN '' ELSE 'Так' END as count_itr, pp.itr_comment \
       from    ( select k.*,b.*, pb.id_rclient  from acd_met_kndzn_tbl as k  join (select distinct id_doc, id_point,id_client, id_rclient from acd_point_branch_tbl order by id_point )as pb \
                 on (pb.id_doc = k.id_doc and pb.id_point = k.id_point ) \
                 join acm_bill_tbl as b0 on (b0.id_doc = pb.id_doc and b0.id_client = pb.id_client)  \
     left join ( select a.code_eqp,(case when a.wtm<>0 then a.wtm else 168 end) as wtml, a.dt_b,a.dt_e \
                       from (select * from eqm_point_h where :pmmgg between dt_b and coalesce(dt_e,:pmmgg)) as a  \
                ) as b   on  b.code_eqp=k.id_point and b.dt_b<=k.dat_e and (b.dt_e>=k.dat_b or b.dt_e is null) \
     where calc_demand_nocnt>0 and b0.mmgg = :pmmgg) as k \
  left join ( select b.id_doc,b.id_client,c.code,c.short_name as name \
             from acm_bill_tbl b,clm_client_tbl c  where b.id_client=c.id \
            ) as b    on b.id_doc=k.id_doc   \
  left join   (select e.id,e.name_eqp, p.code_eqp,p.dt_b,p.dt_e,p.volt_name \
                  from (select * from eqm_equipment_h where :pmmgg between dt_b and coalesce(dt_e,:pmmgg)) as e     \
                  left join  (select p.code_eqp,p.dt_b,p.dt_e,v.voltage_min as volt_name \
                                  from eqm_point_h  p \
                                  left join eqk_voltage_tbl v   on  v.id=p.id_un   \
                             ) p  on p.code_eqp=e.id \
              )as e on  (e.id=k.id_point and :pmmgg between e.dt_b and coalesce(e.dt_e,:pmmgg)) \
 left join  clm_client_tbl as rclient on (rclient.id = k.id_rclient )  \
 left join eqm_point_tbl as pp on (pp.code_eqp = k.id_point ), \
 eqk_energy_tbl ke \
 where ke.id=k.kind_energy and  ke.id=1 and    k.mmgg=:pmmgg  and k.p_w<=:kpv \
order by k.mmgg,b.code,k.num_eqp " );


  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg1;

   ZQXLReps->ParamByName("kpv")->AsInteger=kpv;


 // ZQXLReps->MasterSource=DSRep;
  //ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();



  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();
  Param->Name="lmmgg";



  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);

  AnsiString caption = "Облік недоврахованої електроенергії при споживанні меньше 5% завантаженості облікового трансформатора ";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}

//-----------------------------------------------------------------------------------------------------
void TfReports::PrintNoMeter()
{

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add("    select p.*, a.adr \
from (select  cl.sect, cl.code,cl.short_name,tr.id_tree,p.* from (select id,name_eqp,type_eqp,id_addres from eqm_equipment_tbl  where type_eqp=12)  p \
     left join  \
       (select p.id_tree,p.code_eqp,tr1.code_eqp as tr from eqm_eqp_tree_tbl p \
         left join eqm_eqp_tree_tbl tr1 on (p.code_eqp=tr1.code_eqp_e) where tr1.code_eqp is null) as tr \
          on tr.code_eqp=p.id, \
          eqm_tree_tbl  ttt,  \
         ( select  cl.id,cl.code,cl.short_name, st.id_section,cla.name as sect  \
           from  clm_client_tbl cl,clm_statecl_h st,cla_param_tbl  cla \
            where cl.id=st.id_client and st.id_section=cla.id \
            and st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = st.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
         ) cl where ttt.id=tr.id_tree and ttt.id_client=cl.id \
         order by cl.sect,cl.code \
      ) p \
     left join adv_address_tbl a on p.id_addres=a.id " );

 ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

 ZQXLRepsSum->Sql->Clear();
 ZQXLRepsSum->Sql->Add("     select distinct p.sect \
from (select  cl.sect, cl.code,cl.short_name,tr.id_tree,p.* from (select id,name_eqp,type_eqp,id_addres from eqm_equipment_tbl  where type_eqp=12)  p \
     left join  \
       (select p.id_tree,p.code_eqp,tr1.code_eqp as tr from eqm_eqp_tree_tbl p \
         left join eqm_eqp_tree_tbl tr1 on (p.code_eqp=tr1.code_eqp_e) where tr1.code_eqp is null) as tr \
          on tr.code_eqp=p.id, \
          eqm_tree_tbl  ttt,  \
         ( select  cl.id,cl.code,cl.short_name, st.id_section,cla.name as sect  \
           from  clm_client_tbl cl,clm_statecl_tbl st,cla_param_tbl  cla \
            where cl.id=st.id_client and st.id_section=cla.id \
            and st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = st.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
         ) cl where ttt.id=tr.id_tree and ttt.id_client=cl.id \
         order by cl.sect,cl.code \
      ) p \
     left join adv_address_tbl a on p.id_addres=a.id " );

  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=cur_mmgg;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="sect = sect";

  try
  {
  ZQXLRepsSum->Open();
  ZQXLReps->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


 Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;


  AnsiString caption = "Перелік точек обліку абонентра не обладнаних приладами обліку ";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();
   ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//------------------------------------------------------------------------------
void TfReports::RepForEN(TDateTime mmgg1, TDateTime mmgg2, boolean Build)
{
 TDateTime Dat;
  // if (Build)
//  {

/*  if(MessageDlg("Обновить даные по недогруженным трансформаторам? (~ 5-10 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  calc_compens() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    try
     {
      ZQReps->ExecSql();
      ZQReps->Close();
     ZQReps->Sql->Clear();
     AnsiString sqlstr="select  close() ;";
     ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }
  */
  ZQXLReps->Sql->Clear();
     AnsiString  sqlstr1=   " select cl.*,dem.kv_1_4,dem.kv_2_3 from  \
(    select  c.id_section,c.name_sect,c.code,c.short_name, ad.adr,c.doc_num,c.doc_dat,c.phone,eq.name_eqp,ba.id_point, \
 ba.num_meter, coalesce(id_grp,-1) as link, eqb.name_eqp as fid,p.power                                                       \
   from bal_abons_tbl as ba                                                                                              \
   join (select s.id_section,s.name as name_sect,c.*, s.doc_num,s.doc_dat,s.phone from clm_client_tbl c                   \
     left join (    select s.*,p.name                                                                                           \
                 from clm_statecl_h s  left join cla_param_tbl p on s.id_section=p.id \
                 where   s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :pmmgg::::date ) ) \
 ) s  on s.id_client=c.id ) as c on (c.id = ba.id_client)\
     left join adv_address_tbl ad on c.id_addres=ad.id                                                                                           \
   join eqm_equipment_tbl as eq on (eq.id = ba.id_point)                                                                                          \
   join eqm_equipment_tbl as eqb on (eqb.id = ba.id_grp)                                                                                           \
  join eqm_point_tbl as p on (p.code_eqp = ba.id_point)                                                                                             \
  where c.book = -1                                                                                                                                  \
and ba.id_p_point is null  and p.reserv=0                                                                                                             \
order by c.id_section,c.code,id_grp                                                                                                                    \
) cl                                                                                                                                                    \
left join                                                                                                                                                \
(select coalesce(a.id_point,b.id_point) as id_point,a.kv_1_4,b.kv_2_3 from                                                                                \
 (select id_point,sum(fact_demand+fact_losts)/Count(*) as kv_1_4 from acd_pwr_demand_tbl \
  where (mmgg>=:pmmgg::::date and mmgg<=(:pmmgg::::date+interval '2 month')::::date )                 \
  or (mmgg>=(:pmmgg::::date+interval '9 month')::::date and mmgg<=(:pmmgg::::date+interval '11 month')::::date ) and kind_energy=1 group by id_point order by id_point) as a                                               \
 full join                                                                                                                                                   \
 (select id_point, sum(fact_demand+fact_losts)/Count(*) as kv_2_3 from acd_pwr_demand_tbl                                                                     \
   where (mmgg>=(:pmmgg::::date+interval '3 month')::::date and mmgg<=(:pmmgg::::date+ interval '8 month ')::::date)   and kind_energy=1 \
  group by id_point order by id_point )  as b  on a.id_point=b.id_point   \
                                                                           \
) dem  on (cl.id_point=dem.id_point)   order by      cl.id_section,cl.name_sect  ";
  ZQXLReps->Sql->Add(sqlstr1 );
    unsigned short year, month, day;
   mmgg1.DecodeDate(&year, &month, &day);
   mmgg1=EncodeDate(year, 1, 1);


  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg1;

    AnsiString  sqlstr2=" select distinct c.id_section,c.name_sect \
   from bal_abons_tbl as ba                                                                                              \
   join (select c.*, s.id_section,s.name as name_sect,s.doc_num,s.doc_dat,s.phone from clm_client_tbl c                   \
     left join (select s.*,p.name                                                                                           \
                 from clm_statecl_h s  left join cla_param_tbl p on s.id_section=p.id \
                 where   s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :pmmgg::::date ) ) \
                  ) s  on s.id_client=c.id ) as c on (c.id = ba.id_client)\
     left join adv_address_tbl ad on c.id_addres=ad.id                                                                                           \
   join eqm_equipment_tbl as eq on (eq.id = ba.id_point)                                                                                          \
   join eqm_equipment_tbl as eqb on (eqb.id = ba.id_grp)                                                                                           \
  join eqm_point_tbl as p on (p.code_eqp = ba.id_point)                                                                                             \
  where c.book = -1                                                                                                                                  \
and ba.id_p_point is null  and p.reserv=0                                                                                                             \
order by c.id_section,c.name_sect      ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);



  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="name_sect = name_sect";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


 Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);

  AnsiString caption = "Перелік споживачів по ";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
 void TfReports::PrintConnAbon(TDateTime mmgg1)
{

 ZQXLReps->Sql->Clear();
     AnsiString  sqlstr1= "select dc.*,c.code,c.name as cl_name, \
     tu.short_name as name_tu,pr.short_name as name_pr \
     from  (select a.*,eh.name_eqp from  \
                  (select dc.*,br.inf,br.code_eqp,br.dt_b,br.dt_e,br.id_doc  \
                   from clm_docconnect_tbl dc \
                   left join (select * from eqm_borders_h where                     \
                                 id_doc is not null  order by dt_b ) br on br.id_doc=dc.id  ) a, \
                   eqm_equipment_h eh \
                   where eh.id=a.code_eqp ) dc \
     left join clm_org_tbl as tu on (tu.id=dc.id_org_tu) \
     left join clm_org_tbl as pr on (pr.id=dc.id_org_proect), \
     clm_client_tbl c \
      where mmgg=:pmmgg and dc.id_client=c.id order by c.code  ";
     ZQXLReps->Sql->Add(sqlstr1);
     ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg1;


     //  ZQXLReps->MasterSource=DSRep;
 // ZQXLReps->LinkFields="name_sect = name_sect";

  try
  {

    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);

  AnsiString caption = "Документы подключения  за период";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
   /*

    TWTPanel* PSaldo=MainPanel->InsertPanel(200,true,200);
    TFont *F;
    F=new TFont();
    F ->Size=10;
    F->Style=F->Style << fsBold;
    F->Color=clBlue;
    PSaldo->Params->AddText("Документы на подключение по абоненту "+ NameCl,18,F,Classes::taCenter,true);
    DBGrSald=new TWTDBGrid(this, QuerSal);
    PSaldo->Params->AddGrid(DBGrSald, true)->ID="Saldo";
    TWTQuery* Table = DBGrSald->Query;


   Table->Open();

   TStringList *WListP=new TStringList();
   WListP->Add("id");
   TStringList *NListP=new TStringList();
  // WListP->Add("name_tu");
  // WListP->Add("name_proect");

   QuerSal->SetSQLModify("clm_docconnect_tbl",WListP,NListP,true,true,true);

   TWTField *Fieldh;

  Fieldh = DBGrSald->AddColumn("name", "Номер и описание техусловий", "");
  Fieldh = DBGrSald->AddColumn("dt_tu", "Дата техусловий", "Дата выдачи техусловий");
  Fieldh = DBGrSald->AddColumn("name_tu", "Орг.выдавшая техусловия", "");
  Fieldh->SetOnHelp(((TMainForm*)MainForm)->ClmOrgSpr);

  Fieldh = DBGrSald->AddColumn("name_tu", "Орг.выдавшая техусловия", "");
  Fieldh->SetOnHelp(((TMainForm*)MainForm)->ClmOrgSpr);


  Fieldh = DBGrSald->AddColumn("n_pay_tu", "№ оплаты ТУ", "");
  Fieldh = DBGrSald->AddColumn("dt_pay_tu", "Дата опл.ТУ", "");
  Fieldh = DBGrSald->AddColumn("set_power_tu", "Мощьность по ТУ", "");
  Fieldh->Precision=4;

 Fieldh = DBGrSald->AddColumn("n_connect", "№ дог.присоединения", "");
 Fieldh = DBGrSald->AddColumn("dt_connect", "Дата дог.присоединения", "");
  Fieldh = DBGrSald->AddColumn("dt_pay_connect", "Дата опл. присоединения","");

 Fieldh = DBGrSald->AddColumn("name_proect", "Орг.проектной документации", "");
 Fieldh->SetOnHelp(((TMainForm*)MainForm)->ClmOrgSpr);
 Fieldh = DBGrSald->AddColumn("n_pay_proect", "№ проекта", "");
 //Fieldh = DBGrSald->AddColumn("dt_pay_proect", "Дата опл.проекта", "");

 Fieldh = DBGrSald->AddColumn("n_act_net", "№ акту подключения", "");
 Fieldh = DBGrSald->AddColumn("dt_act_net", "Дата акта подключения", "");

 Fieldh = DBGrSald->AddColumn("n_common_use", "№ дог.совм.использования", "");
 Fieldh = DBGrSald->AddColumn("dt_common_use", "Дата дог.совм.использования", "");

// Fieldh = DBGrSald->AddColumn("dt_real_connect", "", "C НДС");


  Fieldh = DBGrSald->AddColumn("mmgg", "Месяц", "Месяц");
   Fieldh->SetReadOnly();

  Fieldh = DBGrSald->AddColumn("flock", "Закр.", "Флаг закрытия месяца");
  Fieldh->AddFixedVariable("0", "     ");
  Fieldh->AddFixedVariable("1", "Закр.");
  Fieldh->SetReadOnly();

//   DBGrHInd->BeforePost=CheckIndic;
//  DBGrHInd->AfterPost=IndicAddNew;
  DBGrSald->AfterInsert=AddCl;
    DBGrSald->Visible=true;
  SetCaption("Документы подключения по абоненту "+NameCl);
  ShowAs(WinName);
  MainPanel->ParamByID("Saldo")->Control->SetFocus();
*/
};

//----------------------
void TfReports::RepForENReact(TDateTime mmgg1, TDateTime mmgg2, boolean Build)
{
 TDateTime Dat;
  ZQXLReps->Sql->Clear();
     AnsiString  sqlstr1= " \
select cp.name_group,cp.code,cp.name_client,cp.code,ep.id_point,e.id_client as id_client,e.name_eqp,ep.num_eqp,ep.name_typeEqp,\
 pp.id_grouptarif,pp.id_tarif,pp.name,pp.class,pp.power                                                                                  \
                                                                                                                                 \
 from                                                                                                                            \
(                                                                                                                                \
  select * from                                                                                                                  \
    ((select e.*,et.id_client from                                                                                               \
       (select * from eqm_equipment_tbl where type_eqp in (12)) as e,                                                            \
         ( select e.*,et.id_client from eqm_eqp_tree_tbl e,                                                                      \
                (select t.* from eqm_tree_tbl t,clm_statecl_tbl s                                                                \
                  where s.id_client=t.id_client                                                                                   \
                )   et                                                                                                           \
           where et.id=e.id_tree                                                                                                 \
          ) et where e.id=et.code_eqp                                                                                            \
        )                                                                                                                        \
        union                                                                                                                    \
       (select e.*,et.id_client from                                                                                             \
          (select * from eqm_equipment_tbl where type_eqp in (12) ) as e,                                                        \
            (select e.* from eqm_eqp_use_tbl e     ,clm_statecl_tbl s                                                            \
              where s.id_client=e.id_client                                                                                      \
            )   et                                                                                                               \
            where e.id=et.code_eqp                                                                                               \
           )                                                                                                                     \
       ) as e                                                                                                                    \
     ) as e ,                                                                                                                    \
 (select pp.*,tg.value_r from                                                                                                    \
       (select p.*,t.id_grouptarif,t.name,clt.name as class from eqm_point_tbl p,aci_tarif_tbl t,eqi_classtarif_tbl  clt  \
           where p.id_tarif=t.id and t.id_classtarif=clt.id                            \
        ) pp left join eqk_tg_tbl tg on pp.id_tg=tg.id                                                                           \
  ) as pp,                                                                                                                       \
( select ep.*,e.num_eqp,mm.id_type_eqp,m.type as Name_typeEQP,m.carry from eqm_meter_point_h ep,eqm_equipment_tbl e,             \
   eqm_meter_tbl mm,eqi_meter_tbl m                                                                                              \
    where e.id=ep.id_meter  and :pmmgg between dt_b and coalesce(dt_e,now())  and ep.id_meter=mm.code_eqp            \
    and mm.id_type_eqp=m.id                                                                                                      \
 order by id_meter                                                                                                               \
) ep,      \
(select e.*  from eqd_meter_energy_tbl e where   \
   e.kind_energy=2 and date_inst<=:pmmgg order by e.code_eqp) as z,    \                                                                                                                     \
(select cc.id,cc.code,cc.short_name as name_client,s.id_section,p.name as name_group from clm_client_tbl cc,clm_statecl_h s ,        \
cla_param_tbl p                                                                                                                  \
   where cc.id=s.id_client and s.id_section=p.id                                                                                 \
    and  s.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = s.id_client and scl2.mmgg_b <= date_trunc('month', :pmmgg::::date ) ) \
 ) as cp                                                                                                                          \
where ep.id_point=e.id and e.id_client=cp.id and z.code_eqp=ep.id_meter  and pp.code_eqp=ep.id_point order by cp.id_section,cp.code ";                                                                                                                                    \

      ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg1;


  ZQXLReps->MasterSource=DSRep;
  //ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();



  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();
  Param->Name="lmmgg";



  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);

  AnsiString caption = "Звіт по встановленим реактивним лічильнікам ";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

 };
//--------------------------------------------------------------------------------
void TfReports::PrintDocRevis(TDateTime mmgg)
{
 TDateTime Dat;
  ZQXLReps->Sql->Clear();
   AnsiString  sqlstr1= " \
select c.*,p1.need_client,p2.yes_client,pn.new_client \
from ( select id_section,grp.sort, \
grp.name as grp_name,count(*) as all_client                                  \
  from clm_client_tbl as c join clm_statecl_tbl as sc on (c.id = sc.id_client)  \
  left join cla_param_tbl as grp on (grp.id = sc.id_section)                     \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)        \
  group by id_section ,grp.name,grp.sort order by grp.sort) c                      \
left join (select id_section,grp.sort,                                             \
grp.name as gp_name,count(*) as need_client                                        \
  from clm_client_tbl as c join clm_statecl_tbl as sc on (c.id = sc.id_client)     \
  left join cla_param_tbl as grp on (grp.id = sc.id_section)                        \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and sc.doc_dat<=getsysvarc('dt_start_dog') \
  group by id_section ,grp.name,grp.sort order by grp.sort) p1 on c.id_section=p1.id_section  \
left join (select id_section,grp.sort,                                                    \
grp.name as gp_name,count(*) as yes_client                                                 \
  from clm_client_tbl as c join clm_statecl_tbl as sc on (c.id = sc.id_client)             \
  left join cla_param_tbl as grp on (grp.id = sc.id_section)                                \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and sc.doc_dat>getsysvarc('dt_start_dog') \
  group by id_section ,grp.name,grp.sort order by grp.sort) p2 on c.id_section=p2.id_section   \
 left join (select id_section,grp.sort,                                                         \
grp.name as gp_name,count(*) as new_client                                                      \
  from clm_client_tbl as c join clm_statecl_tbl as sc on (c.id = sc.id_client)                   \
  left join cla_param_tbl as grp on (grp.id = sc.id_section)                                      \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and bom(sc.dt_create)=:pmmgg \
  group by id_section ,grp.name,grp.sort order by grp.sort) pn on c.id_section=pn.id_section    \
where c.sort<11 order by c.sort ";                                                                                                                                    \

  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;


  //ZQXLReps->MasterSource=DSRep;
  //ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLReps->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();



  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
   Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  /* Param->Name="lperiod";
  Param=xlReport->Params->Add();
    */



  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);
 /*   xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
   */
  AnsiString caption = "Звіт по переукладанню договорів  ";


  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

 };
//----------------------------------------------------------------------------------------
 void  TfReports::KurMeter(TDateTime mmgg)
{
//
AnsiString  sqlstr2=" select  kur.represent_name as kur_name, count(*)::::int as count_met  \
  from \
(                                                                                                    \
  select * from                                                                                          \
    ((select e.*,et.id_client,et.id_kur from                                                              \
       (select * from eqm_equipment_tbl where type_eqp in (12)) as e,                                      \
         ( select e.*,et.id_client,et.id_kur from eqm_eqp_tree_tbl e,                                       \
                (select t.*,s.id_kur from eqm_tree_tbl t,clm_statecl_tbl s                                  \
                  where s.id_client=t.id_client     and s.id_client<>syi_resid_fun()   \
                   and s.id_section not in (205,206,208)                                                       \
                )   et                                                                                      \
           where et.id=e.id_tree                                                                            \
          ) et where e.id=et.code_eqp                                                                       \
        )                                                                                                   \
        union                                                                                               \
       (select e.*,et.id_client,et.id_kur from                                                              \
          (select * from eqm_equipment_tbl where type_eqp in (12) ) as e,                                   \
            (select e.*,s.id_kur from eqm_eqp_use_tbl e     ,clm_statecl_tbl s                              \
              where s.id_client=e.id_client    and s.id_client<>syi_resid_fun()   \
              and s.id_section not in (205,206,208)                                                                \
            )   et                                                                                          \
            where e.id=et.code_eqp                                                                          \
           )                                                                                                \
       ) as e                                                                                               \
     ) as e                                                                                                 \
     left join (select * from clm_position_tbl order by id) kur on e.id_kur=kur.id                          \
     left join (select id,adr from adv_address_tbl order by id) adr on adr.id=e.id_addres                   \
 ,                                                                                                          \
 (select * from eqm_point_tbl ) as pp,                                                                      \
( select ep.*,e.num_eqp,mm.id_type_eqp,m.carry                                                              \
    from eqm_meter_point_h ep,eqm_equipment_tbl e,eqm_meter_tbl mm,eqi_meter_tbl m                          \
    where e.id=ep.id_meter and dt_e is null and ep.id_meter=mm.code_eqp and mm.id_type_eqp=m.id             \
) ep                                                                                                       \
where ep.id_point=e.id and pp.code_eqp=ep.id_point  and (e.id_kur=:insp or :insp is null)                                   \
 group by  kur_name ";                                                \


 AnsiString  sqlstr1=" select distinct c.code,c.short_name,e.dt_indicat,kur.represent_name as kur_name, \
  adr.adr,ep.id_point,ep.num_eqp,pp.day_control,ep.id_type_eqp,ep.carry,ep.id_meter as id_meter,e.* from \
(                                                                                                        \
  select * from                                                                                          \
    ((select e.*,et.id_client,et.id_kur,et.dt_indicat from                                                              \
       (select * from eqm_equipment_tbl where type_eqp in (12)) as e,                                      \
         ( select e.*,et.id_client,et.id_kur,et.dt_indicat from eqm_eqp_tree_tbl e,                                       \
                (select t.*,s.id_kur,s.dt_indicat from eqm_tree_tbl t,clm_statecl_tbl s                                  \
                  where s.id_client=t.id_client  and s.id_section not in (205,206,208)                     \
                  and s.id_client<>syi_resid_fun()                                                                        \
                )   et                                                                                      \
           where et.id=e.id_tree                                                                            \
          ) et where e.id=et.code_eqp                                                                       \
        )                                                                                                   \
        union                                                                                               \
       (select e.*,et.id_client,et.id_kur,et.dt_indicat from                                                              \
          (select * from eqm_equipment_tbl where type_eqp in (12) ) as e,                                   \
            (select e.*,s.id_kur,s.dt_indicat from eqm_eqp_use_tbl e     ,clm_statecl_tbl s                              \
              where s.id_client=e.id_client and s.id_section not in (205,206,208)                            \
                 and s.id_client<>syi_resid_fun()                                                                         \
            )   et                                                                                          \
            where e.id=et.code_eqp                                                                          \
           )                                                                                                \
       ) as e                                                                                               \
     ) as e                                                                                                 \
     left join (select * from clm_position_tbl order by id) kur on e.id_kur=kur.id                          \
     left join (select id,adr from adv_address_tbl order by id) adr on adr.id=e.id_addres                   \
 ,                                                                                                          \
 (select * from eqm_point_tbl ) as pp,                                                                      \
( select ep.*,e.num_eqp,mm.id_type_eqp,m.carry                                                              \
    from eqm_meter_point_h ep,eqm_equipment_tbl e,eqm_meter_tbl mm,eqi_meter_tbl m                          \
    where e.id=ep.id_meter and dt_e is null and ep.id_meter=mm.code_eqp and mm.id_type_eqp=m.id             \
) ep,                                                                                                       \
(select c.id,c.code,c.short_name from clm_client_tbl c order by c.id ) c                                    \
where ep.id_point=e.id and pp.code_eqp=ep.id_point and c.id=e.id_client   \
 and ((e.id_kur=:insp or :insp is null) )                                  \
 order by  kur_name,day_control,id_client,ep.num_eqp ";                                                \

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
   ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  //ZQXLRepsSum->ParamByName("res")->AsInteger=res;
  //ZQXLReps->ParamByName("res")->AsInteger=res;

  if (InspectorId!=0)
    { ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;
        ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;
    };
       ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="kur_name = kur_name";
  try
  {
    ZQXLReps->Open();
    ZQXLRepsSum->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

 xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lDate";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lDate"]->Value = FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Iнспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";


  xlReport->Report();
 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//------------------------------------------------------------------------------

void TfReports::PrintPoints10k_mem(TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select c.code, c.name,((case when scl.flag_ed=1 then 'Ед.налог' else '      ' end):::: varchar) as flag_ed, c.code||'.'||eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  sss2.dem as dem1,   CASE WHEN coalesce(kt.flag_type ,true) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                   \
select id_client,id_point, id_voltage, round(demand/cnt::::numeric,3) as dem  from                \
(                                                                                        \
 select b.id_client, bs.id_point, p.id_un as id_voltage, sum(bs.demand_val)::::numeric/1000 as demand,  count(distinct bs.mmgg) as cnt \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and coalesce(bs.id_tariff,900001) not in (900001,900002) \
  group by b.id_client, bs.id_point, p.id_un \
) as sss \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;


  AnsiString  sqlstr2="select c.code, c.name, eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  dem1, dem2, dem3, dem4, dem5, dem6, dem7, dem8, dem9, dem10, dem11, dem12, cnt, \
  CASE WHEN coalesce(kt.flag_type ,true) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                   \
select id_client,id_point, id_voltage, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  count(distinct mmgg) as cnt \
from                \
(                                                                                        \
 select b.id_client, bs.id_point,bs.mmgg, p.id_un as id_voltage, round(sum(bs.demand_val)::::numeric/1000,3) as demand \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and coalesce(bs.id_tariff,900001) not in (900001,900002) \
  group by b.id_client, bs.id_point, bs.mmgg, p.id_un \
) as sss \
group by id_client, id_point, id_voltage \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
  xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по лічильникам споживачів на ступені напруги від 6 кВ та більше (Тiльки для Чернiгiвських МЕМ)";

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintPointsAll(TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select c.code, c.name, c.code||'.'||eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  sss2.dem as dem1, power,wtm, connect_power, \
  CASE WHEN coalesce(kt.flag_type ,false) = true THEN 'мiська' ELSE 'сiльська' END as istown, \
  CASE WHEN coalesce(count_lost ,0) = 1 THEN '+' ELSE '' END as islost   \
   from \
(                                                                   \
select id_client,id_point, p.id_un as id_voltage, p.power,p.connect_power,p.wtm, p.count_lost, round(demand/cnt::::numeric,3) as dem  from                \
(                                                                                        \
 select b.id_client, bs.id_point, sum(bs.demand_val)::::numeric/1000 as demand,  count(distinct bs.mmgg) as cnt, max(bs.dt_end) as dt_end, max(b.reg_date) as reg_date \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
  c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and tgr.ident not like '%tgr9%' \
  group by b.id_client, bs.id_point  \
) as sss \
  join eqm_point_h as p on (sss.id_point = p.code_eqp)                                      \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(sss.dt_end,sss.reg_date,p2.dt_b) ) \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by  c.code, vv.voltage_min, eqm.name_eqp ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);

  xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів";

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";

 ZQXLReps->Close();
}
////////////---------------------------------------------

void TfReports::PrintAbonPointUn(TDateTime dt, boolean Build)
{    AnsiString sqlstr;
  if (Build)
  {
 /* AnsiString sqlstr="select calc_un_voltage_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
 // ZQReps->ParamByName("dt")->AsDateTime=dt;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
   */
 sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dt;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }



AnsiString  sqlstr11=" \select distinct gr as link,gr as row,case when gr=1 then 'Загальна кількість:' else \
                  case when gr=4 then 'Міські території:' else case when gr=7 then 'Сільські території:' \
                   end   end  end ::::text as name \
from (                                                                                                                                                                                                                         \
  select  1::::int as gr ,2 as row,'абон.'::::text as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client) as a04 \
 from   (select distinct id_client from rep_areas_points_tbl) a                                                                                                                                                                                                           \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1) a110 on a110.id_client=a.id_client                                                                                                                                                      \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2) a35 on a35.id_client=a.id_client                                                                                                                                                        \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21)) a10 on a10.id_client=a.id_client                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4) a4 on a4.id_client=a.id_client                                                                                                                                              \
union                                                                                                                                                                                                                                                                     \
select  1::::int as gr ,3 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point) as a04                                             \
 from   (select distinct id_point from rep_areas_points_tbl) a                                                                                                                                                                                                            \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1) a110 on a110.id_point=a.id_point                                                                                                                                                         \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2) a35 on a35.id_point=a.id_point                                                                                                                                                           \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21)) a10 on a10.id_point=a.id_point                                                                                                                                                 \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4) a4 on a4.id_point=a.id_point                                                                                                                                                 \
union                                                                                                                                                                                                                                                                     \
select  4::::int as gr ,5 as row,'абон.' as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client)  as a04       \
 from   (select distinct id_client from rep_areas_points_tbl where is_town) a                                                                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1 and is_town) a110 on a110.id_client=a.id_client                                                                                                                                           \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2 and is_town) a35 on a35.id_client=a.id_client                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21) and is_town) a10 on a10.id_client=a.id_client                                                                                                                                  \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town) a4 on a4.id_client=a.id_client                                                                                                                                   \
union                                                                                                                                                                                                                                                                      \
select  4::::int as gr,6 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point) as a04                                               \
 from   (select distinct id_point from rep_areas_points_tbl where  is_town) a                                                                                                                                                                                              \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1 and is_town) a110 on a110.id_point=a.id_point                                                                                                                                              \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2 and is_town) a35 on a35.id_point=a.id_point                                                                                                                                                \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21) and is_town) a10 on a10.id_point=a.id_point                                                                                                                                     \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town) a4 on a4.id_point=a.id_point                                                                                                                                      \
union                                                                                                                                                                                                                                                                      \
select  7::::int as gr ,8 as row,'абон.' as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client)  as a04        \
 from   (select distinct id_client from rep_areas_points_tbl where is_town=false) a                                                                                                                                                                                        \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1 and is_town=false) a110 on a110.id_client=a.id_client                                                                                                                                     \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2 and is_town=false) a35 on a35.id_client=a.id_client                                                                                                                                       \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21) and is_town=false) a10 on a10.id_client=a.id_client                                                                                                                            \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town=false) a4 on a4.id_client=a.id_client                                                                                                                             \
union                                                                                                                                                                                                                                                                      \
select  7::::int as gr,9 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point)  as a04                                              \
 from   (select distinct id_point from rep_areas_points_tbl where  is_town=false) a                                                                                                                                                                                        \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1 and is_town=false) a110 on a110.id_point=a.id_point                                                                                                                                        \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2 and is_town=false) a35 on a35.id_point=a.id_point                                                                                                                                          \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21) and is_town=false) a10 on a10.id_point=a.id_point                                                                                                                               \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town=false) a4 on a4.id_point=a.id_point                                                                                                                                \
 ) as a ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr11);

  AnsiString  sqlstr12=" \                                                                                                                                                                                                                                              \
select  1::::int as link ,2 as row,'абон.'::::text as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client) as a04 \
 from   (select distinct id_client from rep_areas_points_tbl) a                                                                                                                                                                                                           \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1) a110 on a110.id_client=a.id_client                                                                                                                                                      \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2) a35 on a35.id_client=a.id_client                                                                                                                                                        \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21)) a10 on a10.id_client=a.id_client                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4) a4 on a4.id_client=a.id_client                                                                                                                                              \
union                                                                                                                                                                                                                                                                     \
select  1::::int as link ,3 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point) as a04                                             \
 from   (select distinct id_point from rep_areas_points_tbl) a                                                                                                                                                                                                            \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1) a110 on a110.id_point=a.id_point                                                                                                                                                         \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2) a35 on a35.id_point=a.id_point                                                                                                                                                           \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21)) a10 on a10.id_point=a.id_point                                                                                                                                                 \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4) a4 on a4.id_point=a.id_point                                                                                                                                                 \
union                                                                                                                                                                                                                                                                     \
select  4::::int as link ,5 as row,'абон.' as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client)  as a04       \
 from   (select distinct id_client from rep_areas_points_tbl where is_town) a                                                                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1 and is_town) a110 on a110.id_client=a.id_client                                                                                                                                           \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2 and is_town) a35 on a35.id_client=a.id_client                                                                                                                                             \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21) and is_town) a10 on a10.id_client=a.id_client                                                                                                                                  \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town) a4 on a4.id_client=a.id_client                                                                                                                                   \
union                                                                                                                                                                                                                                                                      \
select  4::::int as link,6 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point) as a04                                               \
 from   (select distinct id_point from rep_areas_points_tbl where  is_town) a                                                                                                                                                                                              \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1 and is_town) a110 on a110.id_point=a.id_point                                                                                                                                              \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2 and is_town) a35 on a35.id_point=a.id_point                                                                                                                                                \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21) and is_town) a10 on a10.id_point=a.id_point                                                                                                                                     \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town) a4 on a4.id_point=a.id_point                                                                                                                                      \
union                                                                                                                                                                                                                                                                      \
select  7::::int as link ,8 as row,'абон.' as ed,'споживачів,приєднаних до мереж енергопостачальної організації'::::text as name,count(a.id_client) as all,count(a110.id_client) as a110,count(a35.id_client) as a35,count(a10.id_client) as a6_20,count(a4.id_client)  as a04        \
 from   (select distinct id_client from rep_areas_points_tbl where is_town=false) a                                                                                                                                                                                        \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=1 and is_town=false) a110 on a110.id_client=a.id_client                                                                                                                                     \
       left join (select distinct id_client from rep_areas_points_tbl where voltage=2 and is_town=false) a35 on a35.id_client=a.id_client                                                                                                                                       \
       left join (select distinct id_client from rep_areas_points_tbl where voltage in (3,31,21) and is_town=false) a10 on a10.id_client=a.id_client                                                                                                                            \
       left join (select distinct id_client from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town=false) a4 on a4.id_client=a.id_client                                                                                                                             \
union                                                                                                                                                                                                                                                                      \
select  7::::int as link,9 as row,'шт.' as ed,'загальна кількість точок обліку'::::text as name,count(a.id_point) as all,count(a110.id_point) as a110,count(a35.id_point) as a35,count(a10.id_point) as a6_20,count(a4.id_point)  as a04                                              \
 from   (select distinct id_point from rep_areas_points_tbl where  is_town=false) a                                                                                                                                                                                        \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=1 and is_town=false) a110 on a110.id_point=a.id_point                                                                                                                                        \
       left join (select distinct id_point from rep_areas_points_tbl where voltage=2 and is_town=false) a35 on a35.id_point=a.id_point                                                                                                                                          \
       left join (select distinct id_point from rep_areas_points_tbl where voltage in (3,31,21) and is_town=false) a10 on a10.id_point=a.id_point                                                                                                                               \
       left join (select distinct id_point from rep_areas_points_tbl where coalesce(voltage,4)=4 and is_town=false) a4 on a4.id_point=a.id_point                                                                                                                                \
 ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr12);
  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

    AnsiString  sqlstr13=" \
select   distinct a.id_client,c.code,c.short_name,a.id_point,h.name_eqp, a.voltage as un,coalesce(v.voltage_min,0) as voltage_min, pp.power \
 from   (select distinct * from rep_areas_points_tbl) a \
 join clm_client_tbl as c on (c.id=a.id_client)  \
 join eqm_equipment_h as h on (a.id_point=h.id ) \
 join eqm_point_h as pp on (a.id_point=pp.code_eqp ) \
 left join eqk_voltage_tbl v  on ( v.id=a.voltage )                    \
  where \
   h.dt_b = (select max(dt_b) from eqm_equipment_h as h2  where h2.id = h.id  ) and \
   pp.dt_b = (select max(dt_b) from eqm_point_h as pp2  where pp2.code_eqp = pp.code_eqp  ) \
  order by coalesce(v.voltage_min,0), a.voltage,c.code   \
 ";
   ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr13);

   try
  {

    ZQXLRepsSum->Open();
        ZQXLReps->Open();
         ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr11);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

    Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "RangeAdd";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
 //ZQXLReps2->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

 //ZQXLRepsSum2->Close();

}
//------------------------------------------------------------------------------

void TfReports::PrintAbonsExt(void)
{   AnsiString  sqlstr1=" \
  select c.id,c.code,c.name,short_name,doc_dat,doc_num,sc.phone,  okpo_num, trim(mn.name) as kwed, a.full_adr , \
  case when length(s2.fiders)>0 then substr(s2.fiders,1,length(s2.fiders)-1) else '' end  as fider, \
  case when length(s2.stations)>0 then substr(s2.stations,1,length(s2.stations)-1) else '' end  as station, \
  s2.sumpower \
  from clm_client_tbl as c join clm_statecl_h as sc on (c.id = sc.id_client) \
  left join cla_param_tbl as mn on (mn.id = sc.id_kwed and mn.id_group = 1000000) \
  left join adv_address_tbl as a on (a.id = c.id_addres) \
  left join \
( select s1.id, sum(s1.power) as sumpower, sum(distinct  eqf.name_eqp||',') as fiders, sum(distinct  eqs.name_eqp||',') as stations from \
(select distinct c.id ,ba.id_point,  ba.type_grp,  p.power , fs.id_st as station, \
CASE when ba.type_grp =15 then id_grp when ba.type_grp =8 then id_fider else null end as fider \
from clm_client_tbl as c \
left join bal_abons_tbl as ba  on (c.id = ba.id_client) \
left join eqm_point_tbl as p on (p.code_eqp = ba.id_point) \
left join bal_fider_st_tbl as fs on (fs.id_st = id_grp) \
where c.book = -1  and p.reserv=0 order by fider,station ) as s1 \
left join eqm_equipment_tbl as eqf on (eqf.id = s1.fider) \
left join eqm_equipment_tbl as eqs on (eqs.id = s1.station) \
group by s1.id \
) as s2 on (c.id =s2.id) \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and sc.id_section not in (205,206,207,208) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
//  xlReport->MacroAfter = "";

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::Check2KRBills (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select abon_limit_fun( :mmgg );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1="   select distinct ba.code,ba.short_name, \
  ba.demand_val,coalesce(l.value_dem,0) as limit, \
  CASE WHEN l.value_dem is null THEN 0 ELSE coalesce(ba.demand_val,0)-coalesce(l.value_dem,0) END as nedovist, \
  coalesce(bk.demand_val,0) as kr2_demand ,reg_date,l.mmgg \
  from \
  (select c.code,b.id_client,c.short_name,st.flag_budjet, demand_val  \
   from ( select b.id_client, sum(bs.demand_val) as demand_val \
          from acm_bill_tbl as b \
          join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
          join aci_tarif_tbl as tar on (tar.id=bs.id_tariff)   \
          join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
   where b.id_pref=10 and b.mmgg= :pmmgg and b.idk_doc in (200,204) and tgr.ident !~'tgr8' group by b.id_client) as b, \
   clm_client_tbl c,clm_statecl_tbl st \
   where c.id=b.id_client and c.id=st.id_client order by b.id_client,code \
  ) as ba \
  left join \
  ( select c.id as id_client,l.* \
    from seb_abon_limit_tmp as l join clm_client_tbl as c on (l.code=c.code and l.idk_document=600) \
    join (select code,  max(reg_date) as max_date from seb_abon_limit_tmp as l2 where month_limit= :pmmgg group by code order by code) as l3 \
    on (l3.code = l.code and l3.max_date = l.reg_date) \
    where  month_limit= :pmmgg order by c.id \
  ) as l on (l.id_client=ba.id_client) \
  left join \
  (select c.code,c.name,b.id_client,st.flag_budjet,demand_val \
   from ( select id_client, sum(demand_val) as demand_val from  acm_bill_tbl  where id_pref in (520,524) and mmgg= :pmmgg group by id_client) as b, \
   clm_client_tbl c,clm_statecl_tbl st \
   where c.id=b.id_client and c.id=st.id_client order by b.id_client,code \
  ) as bk  on (ba.id_client=bk.id_client) \
  where  coalesce(l.value_dem,0)< coalesce(ba.demand_val,0) ;";
  //and ba.flag_budjet <>1 ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::Check2KRBillsNoLimit (TDateTime mmgg, boolean Build)
{

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);
  AnsiString sqlstr;
  AnsiString  sqlstr1;

  if (Build)
  {
  if (year1<=2012)
    sqlstr="select abon_limit_fun( :mmgg );";
  else
    sqlstr="select area_limit_fun( :mmgg );";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
  if (year1<=2012)
  {
    sqlstr1="   select distinct ba.code,ba.short_name, \
    ba.demand_val,coalesce(l.value_dem,0) as limit \
    from \
    (select c.code,b.id_client,c.short_name,st.flag_budjet, demand_val  \
     from ( select id_client, sum(demand_val) as demand_val from  acm_bill_tbl  where id_pref=10 and mmgg = mmgg_bill and mmgg= :pmmgg group by id_client) as b, \
     clm_client_tbl c,clm_statecl_tbl st \
     where c.id=b.id_client and c.id=st.id_client order by b.id_client,code \
    ) as ba \
    left join \
    ( select c.id as id_client,l.* \
      from seb_abon_limit_tmp as l join clm_client_tbl as c on (l.code=c.code and l.idk_document=600) \
      join (select code,  max(reg_date) as max_date from seb_abon_limit_tmp as l2 where month_limit= :pmmgg group by code order by code) as l3 \
      on (l3.code = l.code and l3.max_date = l.reg_date) \
      where  month_limit= :pmmgg order by c.id \
    ) as l on (l.id_client=ba.id_client) \
    where  coalesce(l.value_dem,0)=0 and (ba.demand_val > 0);";
    //and ba.flag_budjet <>1 ";
  }
  else
  {
    sqlstr1="   select distinct ba.code,ba.short_name, \
    ba.demand_val,coalesce(l.value_dem,0) as limit \
    from \
    (select c.code,b.id_client,c.short_name,st.flag_budjet, demand_val  \
     from ( select id_client, sum(demand_val) as demand_val from  acm_bill_tbl  where id_pref=10 and mmgg = mmgg_bill and mmgg= :pmmgg group by id_client) as b, \
     clm_client_tbl c,clm_statecl_tbl st \
     where c.id=b.id_client and c.id=st.id_client order by b.id_client,code \
    ) as ba \
    left join \
    ( select l.id_client, sum(value_limit) as value_dem \
      from seb_area_limit_tmp as l  \
      where  mmgg= :pmmgg \
      group by l.id_client order by l.id_client \
    ) as l on (l.id_client=ba.id_client) \
    where  coalesce(l.value_dem,0)=0 and (ba.demand_val > 0);";
    //and ba.flag_budjet <>1 ";
  }


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}

//---------------------------------------------------------------------------
 void TfReports::PrintAkt5(TDateTime dtb,TDateTime dte,int kind_energy,int client, boolean Build)
 {

  int obr_exists=0;
  AnsiString message;
  AnsiString sqlstr;
  
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  if ((Build)&&(EncodeDate(year2,month2,1)>=cur_mmgg))
  {
   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year2,month2,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  sqlstr="  select   -deb_zpmv as deb, kr_zpmv,  -deb_kmv as deb_k,kr_zkmv \
   from %obrtable as obr  where obr.id_client = :client and period = :mmgg and obr.id_pref = :pref ;";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year2,month2,1);
  ZQReps->ParamByName("client")->AsInteger=client;
  if (kind_energy==0)    ZQReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQReps->ParamByName("pref")->AsInteger=902;

  if ((Build)&&(EncodeDate(year2,month2,1)>=cur_mmgg))
    ZQReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  double debet_e = ZQReps->FieldByName("deb_k")->AsFloat;
  double kredit_e = ZQReps->FieldByName("kr_zkmv")->AsFloat;

  double debet_b = 0;
  double kredit_b = 0;

  if(EncodeDate(year1,month1,1) == EncodeDate(year2,month2,1))
  {
    debet_b = ZQReps->FieldByName("deb")->AsFloat;
    kredit_b = ZQReps->FieldByName("kr_zpmv")->AsFloat;
  }
  else
  {
    sqlstr="  select   -deb_zpmv as deb, kr_zpmv,  -deb_kmv as deb_k,kr_zkmv \
     from seb_obr_all_tbl as obr  where obr.id_client = :client and period = :mmgg and obr.id_pref = :pref ;";

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
    ZQReps->ParamByName("client")->AsInteger=client;
    if (kind_energy==0)    ZQReps->ParamByName("pref")->AsInteger=10;
    if (kind_energy==1)    ZQReps->ParamByName("pref")->AsInteger=20;
    if (kind_energy==2)    ZQReps->ParamByName("pref")->AsInteger=510;
    if (kind_energy==3)    ZQReps->ParamByName("pref")->AsInteger=520;
    if (kind_energy==4)    ZQReps->ParamByName("pref")->AsInteger=524;
    if (kind_energy==5)    ZQReps->ParamByName("pref")->AsInteger=901;
    if (kind_energy==6)    ZQReps->ParamByName("pref")->AsInteger=902;

    try
     {
      ZQReps->Open();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

      debet_b = ZQReps->FieldByName("deb")->AsFloat;
      kredit_b = ZQReps->FieldByName("kr_zpmv")->AsFloat;

  }
  ZQReps->Close();
  ZQReps->Sql->Clear();

  sqlstr = " select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1)) and pos.id_client = :client \
    order by id_client ; ";

  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("client")->AsInteger=client;

  try
  {
    ZQReps->Open();
  }
  catch(...)
  {
   ShowMessage("Ошибка SQL :"+sqlstr);
   return;
  }

  AnsiString AbnBoss = ZQReps->FieldByName("abn_boss")->AsString;
  ZQReps->Close();


  AnsiString  sqlstr1="  select * from \
  (select p.reg_date, 0 as value_bill, p.value_pay , 'Оплата' as ident \
      from acm_pay_tbl as p \
       where (date_trunc('month', :dtb::::date ) <= date_trunc('month', p.reg_date)) and \
             (date_trunc('month', :dte::::date ) >= date_trunc('month', p.reg_date)) \
       and p.id_pref = :pref and p.sign_pay = 1 and p.id_client = :client \
  ) as pay \
  union all \
  (select b.reg_date, (b.value+b.value_tax) as value_bill, 0 as value_pay , \
      CASE WHEN b.idk_doc = 209 THEN 'Акт' ELSE 'Рахунок' END as ident \
      from acm_bill_tbl as b \
       where (date_trunc('month', :dtb::::date ) <= date_trunc('month', b.reg_date)) and \
             (date_trunc('month', :dte::::date ) >= date_trunc('month', b.reg_date)) \
       and b.id_pref = :pref and  b.id_client = :client and b.idk_doc <> 201 \
       ) order by reg_date ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  if (kind_energy == 0)  ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy == 1)  ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lsres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="debet_b";
  Param=xlReport->Params->Add();
  Param->Name="kredit_b";
  Param=xlReport->Params->Add();
  Param->Name="debet_e";
  Param=xlReport->Params->Add();
  Param->Name="kredit_e";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="lsabon";
  Param=xlReport->Params->Add();
  Param->Name="lbegin";
  Param=xlReport->Params->Add();
  Param->Name="lend";
  Param=xlReport->Params->Add();
  Param->Name="lend2";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bosspos";
  Param=xlReport->Params->Add();
  Param->Name="abnboss";



  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResFullName;
  xlReport->ParamByName["labon"]->Value = AbonFullName;
  xlReport->ParamByName["lsres"]->Value = ResName;
  xlReport->ParamByName["lsabon"]->Value = edAbonName->Text;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",EncodeDate(year1,month1,1))+" - "+
  FormatDateTime("dd.mm.yyyy",EncodeDate(year2,month2,1));

  xlReport->ParamByName["lbegin"]->Value = "Сальдо на "+ FormatDateTime("dd.mm.yyyy",EncodeDate(year1,month1,1));
  xlReport->ParamByName["lend"]->Value =   "Сальдо на "+ FormatDateTime("dd.mm.yyyy",IncMonth(EncodeDate(year2,month2,1),1));
  xlReport->ParamByName["lend2"]->Value =   FormatDateTime("dd.mm.yyyy",dte);  

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "Реактивна енергія.";
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = "Перевищення ліміту потужності.";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = "Перевищення ліміту споживання електроенергії.";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = "Перевищення ліміту споживання електроенергії.";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = "Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = "Інфляція.";

  xlReport->ParamByName["debet_b"]->Value = debet_b;
  xlReport->ParamByName["kredit_b"]->Value = kredit_b;
  xlReport->ParamByName["debet_e"]->Value = debet_e;
  xlReport->ParamByName["kredit_e"]->Value = kredit_e;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bosspos"]->Value = BossPos;
  xlReport->ParamByName["abnboss"]->Value = AbnBoss;

  xlReport->Report();

 ZQXLReps->Close();

 }
//==============================================================================
void TfReports::Monitor_A2_mem(TDateTime dtb,TDateTime dte)
{

//  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
/*
  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
 */
  sqlstr="  update rep_areas_points_tbl set  is_town = coalesce(kt.flag_type ,true) \
    from eqm_compens_station_inst_h as inst \
    join (select code_eqp, code_eqp_inst, max(dt_b) as dt from eqm_compens_station_inst_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp_inst,code_eqp order by code_eqp_inst,code_eqp) as inst2 \
       on (inst.code_eqp = inst2.code_eqp and inst.code_eqp_inst = inst2.code_eqp_inst and inst2.dt = inst.dt_b) \
    join eqm_equipment_h as area on (inst.code_eqp_inst = area.id and area.type_eqp = 11) \
    join (select id, max(dt_b) as dt from eqm_equipment_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by id) as area2 on (area.id = area2.id and area2.dt = area.dt_b) \
    left join adm_address_tbl as a on (a.id = area.id_addres) \
    left join adi_street_tbl as s on (s.id = a.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where inst.code_eqp= rep_areas_points_tbl.id_point; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select \
  sum(CASE WHEN coalesce(is_town ,true) = true THEN 1 ELSE 0 END) as count_m, \
  sum(CASE WHEN coalesce(is_town ,true) = false THEN 1 ELSE 0 END) as count_s \
  from \
  (\
   select distinct ap.id_client,id_area,is_town from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min =0.4 ) as ss ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN coalesce(kt.flag_type ,true) = true THEN demand_all ELSE 0 END) as demand_m, \
  sum(CASE WHEN coalesce(kt.flag_type ,true) = false  THEN demand_all ELSE 0 END) as demand_s \
  from \
   ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
   from \
   (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
    order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
   join clm_client_tbl as c on (c.id = b.id_client) \
   join clm_statecl_tbl as scl on (c.id = scl.id_client) \
   join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
   left join eqk_voltage_tbl as vv on (vv.id=p.id_voltage) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
   and c.book = -1 \
   and coalesce(bs.id_tariff,900001) not in (900001,900002) \
   and vv.voltage_min =0.4 \
   and scl.id_section not in (205,206,207,208) \
   group by bs.id_point, b.id_client \
   order by id_point \
  ) as sym1 \
  left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
  left join adm_address_tbl as a on (a.id = eqm.id_addres) \
  left join (select * from adi_street_tbl order by id_town) as s on (s.id = a.id_street) \
  left join (select * from adi_town_tbl order by idk_town) as t on (t.id = s.id_town) \
  left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sym1.id_point  ) \
  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======
   sqlstr1="   select c.code, c.short_name as name, eqm.name_eqp as point,eqa.name_eqp as area, \
  coalesce(kt.flag_type ,true) as is_town,sym1.demand_all, \
  CASE WHEN coalesce(kt.flag_type ,true) = true THEN 'мiська' ELSE 'сiльська' END as istown \
  from \
 ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where demand_val <> 0 and  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
   order by id_doc \
  ) as bs on (bs.id_doc = b.id_doc) \
   join clm_client_tbl as c on (c.id = b.id_client) \
   join clm_statecl_tbl as scl on (c.id = scl.id_client) \
   join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
   left join eqk_voltage_tbl as vv on (vv.id=p.id_voltage) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
   and c.book = -1 \
   and coalesce(bs.id_tariff,900001) not in (900001,900002) \
   and vv.voltage_min =0.4 \
   and scl.id_section not in (205,206,207,208) \
   group by bs.id_point, b.id_client \
  order by id_point \
 ) as sym1 \
join clm_client_tbl as c on (c.id = sym1.id_client) \
  left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
  left join adm_address_tbl as a on (a.id = eqm.id_addres) \
  left join (select * from adi_street_tbl order by id_town) as s on (s.id = a.id_street) \
  left join (select * from adi_town_tbl order by idk_town) as t on (t.id = s.id_town) \
  left join adk_town_tbl as kt on (kt.id = t.idk_town) \
  left join rep_areas_points_tbl as ap on (ap.id_point = sym1.id_point) \
  left join eqm_equipment_tbl as eqa on (eqa.id = ap.id_area) \
    where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sym1.id_point  ) \
order by istown, c.code;   ";


   sqlstr2="select c.code, c.short_name as name, \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
  from \
  ( \
   select distinct ap.id_client,id_area,is_town from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min =0.4 \
  ) as ss \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by istown, code, area ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ (Тiльки для Чернiгiвських МЕМ)";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();

}
////////////---------------------------------------------
void TfReports::Monitor_A3_mem(TDateTime dtb,TDateTime dte)
{
//  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  /*
  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr=" update rep_areas_points_tbl set voltage =  t.id_voltage \
  from eqm_eqp_tree_tbl as eqt join tree_volt_tmp as t on (eqt.id_tree = t.id_tree) \
    where eqt.code_eqp = rep_areas_points_tbl.id_point and t.id_voltage is not null \
    and coalesce(t.id_voltage ,0)<>coalesce(rep_areas_points_tbl.voltage ,0)  ;";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
 */
  sqlstr="  update rep_areas_points_tbl set is_town = coalesce(kt.flag_type ,true) \
    from eqm_compens_station_inst_h as inst \
    join (select code_eqp, code_eqp_inst, max(dt_b) as dt from eqm_compens_station_inst_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp_inst,code_eqp order by code_eqp_inst,code_eqp) as inst2 \
       on (inst.code_eqp = inst2.code_eqp and inst.code_eqp_inst = inst2.code_eqp_inst and inst2.dt = inst.dt_b) \
    join eqm_equipment_h as area on (inst.code_eqp_inst = area.id and area.type_eqp = 11) \
    join (select id, max(dt_b) as dt from eqm_equipment_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by id) as area2 on (area.id = area2.id and area2.dt = area.dt_b) \
    left join adm_address_tbl as a on (a.id = area.id_addres) \
    left join adi_street_tbl as s on (s.id = a.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where inst.code_eqp= rep_areas_points_tbl.id_point; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select \
  sum(CASE WHEN coalesce(is_town ,false) = true  and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN 1 ELSE 0 END) as count35, \
  sum(CASE WHEN volt >= 110 THEN 1 ELSE 0 END) as count110 \
  from \
  (\
   select distinct ap.id_client,id_area,is_town, vv.voltage_min as volt from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min >=6 ) as ss ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN coalesce(kt.flag_type ,true) = true  and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_m, \
  sum(CASE WHEN coalesce(kt.flag_type ,true) = false and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN demand_all ELSE 0 END) as demand35, \
  sum(CASE WHEN volt >= 110 THEN demand_all ELSE 0 END) as demand110 \
  from \
   ( select bs.id_point, b.id_client, vv.voltage_min as volt, sum(bs.demand_val)::::numeric/1000 as demand_all \
   from \
   (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
    order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
   join clm_client_tbl as c on (c.id = b.id_client) \
   join clm_statecl_tbl as scl on (c.id = scl.id_client) \
   join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
   left join eqk_voltage_tbl as vv on (vv.id=p.id_voltage) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
   and c.book = -1 \
   and coalesce(bs.id_tariff,900001) not in (900001,900002) \
   and vv.voltage_min >=6 \
   and scl.id_section not in (205,206,207,208) \
   group by bs.id_point, b.id_client , vv.voltage_min \
   order by id_point \
  ) as sym1 \
  left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
  left join adm_address_tbl as a on (a.id = eqm.id_addres) \
  left join (select * from adi_street_tbl order by id_town) as s on (s.id = a.id_street) \
  left join (select * from adi_town_tbl order by idk_town) as t on (t.id = s.id_town) \
  left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sym1.id_point  ) \
  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======
   sqlstr1="   select c.code, c.short_name as name, eqm.name_eqp as point,eqa.name_eqp as area, \
  coalesce(kt.flag_type ,true) as is_town,sym1.demand_all, volt ,\
  CASE WHEN coalesce(kt.flag_type ,true) = false and volt <= 20 and volt >= 6 THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
   ( select bs.id_point, b.id_client, vv.voltage_min as volt, sum(bs.demand_val)::::numeric/1000 as demand_all \
   from \
   (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where demand_val <> 0 and  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
    order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
   join clm_client_tbl as c on (c.id = b.id_client) \
   join clm_statecl_tbl as scl on (c.id = scl.id_client) \
   join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
   left join eqk_voltage_tbl as vv on (vv.id=p.id_voltage) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
   and c.book = -1 \
   and coalesce(bs.id_tariff,900001) not in (900001,900002) \
   and vv.voltage_min >=6 \
   and scl.id_section not in (205,206,207,208) \
   group by bs.id_point, b.id_client , vv.voltage_min \
   order by id_point \
  ) as sym1 \
join clm_client_tbl as c on (c.id = sym1.id_client) \
  left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
  left join adm_address_tbl as a on (a.id = eqm.id_addres) \
  left join (select * from adi_street_tbl order by id_town) as s on (s.id = a.id_street) \
  left join (select * from adi_town_tbl order by idk_town) as t on (t.id = s.id_town) \
  left join adk_town_tbl as kt on (kt.id = t.idk_town) \
  left join rep_areas_points_tbl as ap on (ap.id_point = sym1.id_point) \
  left join eqm_equipment_tbl as eqa on (eqa.id = ap.id_area) \
   where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sym1.id_point  ) \
   order by volt, istown, c.code;   ";


   sqlstr2="select c.code, c.short_name as name, volt,  \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = false and volt <= 20 and volt >= 6 THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
  ( \
   select distinct ap.id_client,id_area,is_town , vv.voltage_min as volt from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min >=6 \
  ) as ss \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by volt, istown, code, area ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();


}
////////////---------------------------------------------
void TfReports::Monitor_A2(TDateTime dtb,TDateTime dte)
{

//  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr=" update rep_areas_points_tbl set voltage =  t.id_voltage \
  from eqm_eqp_tree_tbl as eqt join tree_volt_tmp as t on (eqt.id_tree = t.id_tree) \
    where eqt.code_eqp = rep_areas_points_tbl.id_point and t.id_voltage is not null \
    and coalesce(t.id_voltage ,0)<>coalesce(rep_areas_points_tbl.voltage ,0)  ;";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select \
  sum(CASE WHEN coalesce(is_town ,false) = true THEN 1 ELSE 0 END) as count_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false THEN 1 ELSE 0 END) as count_s \
  from \
  (\
   select distinct ap.id_client,id_area,is_town from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min =0.4 ) as ss ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN is_town = true THEN demand_all ELSE 0 END) as demand_m, \
  sum(CASE WHEN is_town = false THEN demand_all ELSE 0 END) as demand_s \
  from \
  ( \
   select distinct ap.id_client,id_point,is_town from rep_areas_points_tbl as ap \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   where  vv.voltage_min =0.4 \
   order by id_point \
   ) as s1 \
   join \
   ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
   from \
   (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
    order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
   group by bs.id_point, b.id_client \
   order by id_point \
  ) as sym1 \
  on (s1.id_point = sym1.id_point)  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======
   sqlstr1="   select c.code, c.short_name as name, eq.name_eqp as point,eqa.name_eqp as area, \
  s1.is_town,sym1.demand_all, \
  CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
  from \
  ( \
  select distinct ap.id_client,id_point,is_town,id_area from rep_areas_points_tbl as ap \
  join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
  where  vv.voltage_min =0.4 \
  order by id_point \
  ) as s1 \
  join \
 ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
   order by id_doc \
  ) as bs on (bs.id_doc = b.id_doc) \
  group by bs.id_point, b.id_client \
  order by id_point \
 ) as sym1 \
 on (s1.id_point = sym1.id_point) \
join clm_client_tbl as c on (c.id = s1.id_client) \
left join eqm_equipment_tbl as eq on (eq.id = s1.id_point) \
left join eqm_equipment_tbl as eqa on (eqa.id = s1.id_area) \
order by istown, c.code;   ";


 sqlstr2="select c.code, c.short_name as name, \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
  from \
  ( \
   select distinct ap.id_client,id_area,is_town from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min =0.4 \
  ) as ss \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by istown, code, area ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();

}
////////////---------------------------------------------
void TfReports::Monitor_A3(TDateTime dtb,TDateTime dte)
{
//  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr=" update rep_areas_points_tbl set voltage =  t.id_voltage \
  from eqm_eqp_tree_tbl as eqt join tree_volt_tmp as t on (eqt.id_tree = t.id_tree) \
    where eqt.code_eqp = rep_areas_points_tbl.id_point and t.id_voltage is not null \
    and coalesce(t.id_voltage ,0)<>coalesce(rep_areas_points_tbl.voltage ,0)  ;";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select \
  sum(CASE WHEN coalesce(is_town ,false) = true  and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN 1 ELSE 0 END) as count35, \
  sum(CASE WHEN volt >= 110 THEN 1 ELSE 0 END) as count110 \
  from \
  (\
   select distinct ap.id_client,id_area,is_town, vv.voltage_min as volt from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min >=6 ) as ss ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN is_town = true  and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_m, \
  sum(CASE WHEN is_town = false and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN demand_all ELSE 0 END) as demand35, \
  sum(CASE WHEN volt >= 110 THEN demand_all ELSE 0 END) as demand110 \
  from \
  ( \
   select distinct ap.id_client,id_point,is_town, vv.voltage_min as volt from rep_areas_points_tbl as ap \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   where  vv.voltage_min >=6 \
   order by id_point \
   ) as s1 \
   join \
   ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
   from \
   (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
    order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
   group by bs.id_point, b.id_client \
   order by id_point \
  ) as sym1 \
  on (s1.id_point = sym1.id_point)  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======
   sqlstr1="   select c.code, c.short_name as name, eq.name_eqp as point,eqa.name_eqp as area, \
  s1.is_town,sym1.demand_all, volt ,\
  CASE WHEN is_town = false and volt <= 20 and volt >= 6 THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
  ( \
  select distinct ap.id_client,id_point,is_town,id_area, vv.voltage_min as volt from rep_areas_points_tbl as ap \
  join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
  where  vv.voltage_min >=6  \
  order by id_point \
  ) as s1 \
  join \
 ( select bs.id_point, b.id_client,  sum(bs.demand_val)::::numeric/1000 as demand_all \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
   (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1 \
   order by id_doc \
  ) as bs on (bs.id_doc = b.id_doc) \
  group by bs.id_point, b.id_client \
  order by id_point \
 ) as sym1 \
 on (s1.id_point = sym1.id_point) \
join clm_client_tbl as c on (c.id = s1.id_client) \
left join eqm_equipment_tbl as eq on (eq.id = s1.id_point) \
left join eqm_equipment_tbl as eqa on (eqa.id = s1.id_area) \
order by volt, istown, c.code;   ";


   sqlstr2="select c.code, c.short_name as name, volt,  \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = false and volt <= 20 and volt >= 6 THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
  ( \
   select distinct ap.id_client,id_area,is_town , vv.voltage_min as volt from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() )) \
   and vv.voltage_min >=6 \
  ) as ss \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by volt, istown, code, area ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();


}
////////////---------------------------------------------
void TfReports::PrintPoints10k(TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select c.code, c.name, ((case when scl.flag_ed=1 then 'Ед.налог' else '      ' end):::: varchar) as flag_ed,c.code||'.'||eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  sss2.dem as dem1,   CASE WHEN coalesce(kt.flag_type ,false) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                   \
select id_client,id_point, id_voltage, round(demand/cnt::::numeric,3) as dem  from                \
(                                                                                        \
 select b.id_client, bs.id_point, p.id_un as id_voltage, sum(bs.demand_val)::::numeric/1000 as demand,  count(distinct bs.mmgg) as cnt \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and tgr.ident not like '%tgr9%' \
  group by b.id_client, bs.id_point, p.id_un \
) as sss \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;


  AnsiString  sqlstr2="select c.code, c.name, eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  dem1, dem2, dem3, dem4, dem5, dem6, dem7, dem8, dem9, dem10, dem11, dem12, cnt, \
  CASE WHEN coalesce(kt.flag_type ,false) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                   \
select id_client,id_point, id_voltage, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  count(distinct mmgg) as cnt \
from                \
(                                                                                        \
 select b.id_client, bs.id_point,bs.mmgg, p.id_un as id_voltage, round(sum(bs.demand_val)::::numeric/1000,3) as demand \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and tgr.ident not like '%tgr9%' \
  group by b.id_client, bs.id_point, bs.mmgg, p.id_un \
) as sss \
group by id_client, id_point, id_voltage \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
  xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по лічильникам споживачів на ступені напруги від 6 кВ та більше";

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";

 ZQXLReps->Close();
}
////////////---------------------------------------------


void TfReports::PrintAbon10k(TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select c.code, c.name, ((case when scl.flag_ed=1 then 'Ед.налог' else '      ' end):::: varchar) as flag_ed,c.code||'.'||eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  sss2.dem as dem1,   CASE WHEN coalesce(kt.flag_type ,false) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                  \
select id_client,id_point, id_voltage, round(demand/cnt::::numeric,3) as dem  from                \
(                                                                                        \
 select b.id_client, bs.id_point, p.id_voltage as id_voltage, sum(bs.demand_val)::::numeric/1000 as demand,  count(distinct bs.mmgg) as cnt \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and tgr.ident not like '%tgr9%' \
  group by b.id_client, bs.id_point, p.id_voltage \
) as sss \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
//  ZQXLReps->ParamByName("dte")->AsDateTime=dte;


  AnsiString  sqlstr2="select c.code, c.name, eqm.name_eqp as point, \
  sss2.id_client,sss2.id_point, sss2.id_voltage, vv.voltage_min, \
  dem1, dem2, dem3, dem4, dem5, dem6, dem7, dem8, dem9, dem10, dem11, dem12, cnt, \
  CASE WHEN coalesce(kt.flag_type ,false) = true THEN 'мiська' ELSE 'сiльська' END as istown from \
(                                                                   \
select id_client,id_point, id_voltage, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  count(distinct mmgg) as cnt \
from                \
(                                                                                        \
 select b.id_client, bs.id_point,bs.mmgg, p.id_voltage as id_voltage, round(sum(bs.demand_val)::::numeric/1000,3) as demand \
  from \
  (select * from acm_bill_tbl where id_pref=10 order by id_client) as b join \
  (select * from acd_billsum_tbl where  date_part('year',mmgg ) = date_part('year',:dtb::::date )-1  order by id_doc \
   ) as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  join eqm_point_h as p on (bs.id_point = p.code_eqp)                                      \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where                                                                                    \
   p.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = p.code_eqp and p2.dt_b <= coalesce(bs.dt_end,b.reg_date,p2.dt_b) ) \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and tgr.ident not like '%tgr9%' \
  group by b.id_client, bs.id_point, bs.mmgg, p.id_voltage \
) as sss \
group by id_client, id_point, id_voltage \
order by id_point \
) as sss2 \
left join clm_client_tbl as c on (c.id = sss2.id_client) \
left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
left join eqm_equipment_h as eqm on (eqm.id=sss2.id_point) \
left join adm_address_tbl as a on (a.id = eqm.id_addres) \
left join adi_street_tbl as s on (s.id = a.id_street) \
left join adi_town_tbl as t on (t.id = s.id_town) \
left join adk_town_tbl as kt on (kt.id = t.idk_town) \
left join eqk_voltage_tbl as vv on (vv.id=sss2.id_voltage) \
    where scl.id_section not in (205,206,207,208) \
    and vv.voltage_min >=6 \
    and eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = sss2.id_point  ) \
order by c.code, eqm.name_eqp  ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
  xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по лічильникам споживачів на ступені напруги від 6 кВ та більше";

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";

 ZQXLReps->Close();
}
////////////---------------------------------------------


void TfReports::Monitor_MSVoltage(TDateTime dtb)
{

  AnsiString  sqlstr1=" select \
 sum(CASE WHEN res_include = 1 and voltage = 0.4 THEN 1 ELSE 0 END) as m04, \
 sum(CASE WHEN res_include = 1 and voltage >= 6 and voltage <= 20 THEN 1 ELSE 0 END) as m10, \
 sum(CASE WHEN res_include = 1 and voltage >=27 and voltage <= 35 THEN 1 ELSE 0 END) as m35, \
 sum(CASE WHEN res_include = 1 and voltage >=110 THEN 1 ELSE 0 END) as m110, \
 sum(CASE WHEN res_include = 1 and coalesce(cnt_sub,0)>0 and voltage = 0.4 THEN 1 ELSE 0 END) as ms04, \
 sum(CASE WHEN res_include = 1 and coalesce(cnt_sub,0)>0 and voltage >= 6 and voltage <= 20 THEN 1 ELSE 0 END) as ms10, \
 sum(CASE WHEN res_include = 1 and coalesce(cnt_sub,0)>0 and voltage >=27 and voltage <= 35 THEN 1 ELSE 0 END) as ms35, \
 sum(CASE WHEN res_include = 1 and coalesce(cnt_sub,0)>0 and voltage >=110 THEN 1 ELSE 0 END) as ms110, \
 sum(CASE WHEN res_include = 0 and voltage = 0.4 THEN 1 ELSE 0 END) as s04, \
 sum(CASE WHEN res_include = 0 and voltage >= 6 and voltage <= 20 THEN 1 ELSE 0 END) as s10, \
 sum(CASE WHEN res_include = 0 and voltage >=27 and voltage <= 35 THEN 1 ELSE 0 END) as s35, \
 sum(CASE WHEN res_include = 0 and voltage >=110 THEN 1 ELSE 0 END) as s110 \
 from \
(select id_client, max(res_include) as res_include , max(voltage) as voltage from \
( select distinct * from \
(select t.id_client,res_include(id_clienta),max(v.voltage_min) as voltage \
  from eqm_point_h as p \
  join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
  join eqm_eqp_tree_h as ttp on (p.code_eqp = ttp.code_eqp) \
  join eqm_tree_h as t on (ttp.id_tree = t.id) \
  join \
 (select cm.id, cm.code,cm.name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=t.id_client ) \
  left join eqm_borders_h as b on (t.id_client = b.id_clientb and t.code_eqp = b.code_eqp \
   and b.dt_b <= :dtb::::date and coalesce(b.dt_e,:dtb::::date) >= :dtb::::date) \
  where \
  t.dt_b <= :dtb::::date and coalesce(t.dt_e,:dtb::::date) >= :dtb::::date \
  and ttp.dt_b <= :dtb::::date and coalesce(ttp.dt_e,:dtb::::date) >= :dtb::::date \
  and p.dt_b <= :dtb::::date and coalesce(p.dt_e,:dtb::::date) >= :dtb::::date \
  group by t.id_client ) as ss \
union \
 select u.id_client, 1 ,max(v.voltage_min) as voltage \
 from \
 eqm_eqp_use_h as u \
 join eqm_point_h as p on (p.code_eqp = u.code_eqp) \
 join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
  join \
 (select cm.id, cm.code,cm.short_name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=u.id_client ) \
  where \
  u.dt_b <= :dtb::::date and coalesce(u.dt_e,:dtb::::date) >= :dtb::::date \
  and p.dt_b <= :dtb::::date and coalesce(p.dt_e,:dtb::::date) >= :dtb::::date \
 group by u.id_client \
 ) as sss group by id_client  ) as ssss \
 left join (select id_clienta, count(distinct id_clientb) as cnt_sub \
 from  eqm_borders_h as bb \
 join  (select cm.id, cm.code,cm.short_name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=bb.id_clientb ) \
 where \
 bb.dt_b <= :dtb::::date and coalesce(bb.dt_e,:dtb::::date) >= :dtb::::date \
 group by id_clienta \
 ) as sss2 on (sss2.id_clienta = ssss.id_client)";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);
  ZQXLRepsSum->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLRepsSum->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======

   sqlstr1="select ssss.*, \
 CASE WHEN coalesce(res_include ,0) = 1 THEN 'Основний' ELSE 'Субабонент' END as abon_type, \
 CASE WHEN coalesce(cnt_sub,0)>0 THEN 'Має субабон.' ELSE 'Не має субабон.' END as has_subabon \
 from \
 (select id_client, code, short_name, max(res_include) as res_include , max(voltage) as voltage from \
 ( select distinct * from \
(select t.id_client,c.code, c.short_name, res_include(id_clienta),max(v.voltage_min) as voltage \
  from eqm_point_h as p \
  join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
  join eqm_eqp_tree_h as ttp on (p.code_eqp = ttp.code_eqp) \
  join eqm_tree_h as t on (ttp.id_tree = t.id) \
  join \
 (select cm.id, cm.code,cm.short_name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=t.id_client ) \
   left join eqm_borders_h as b on (t.id_client = b.id_clientb and t.code_eqp = b.code_eqp \
   and b.dt_b <= :dtb::::date and coalesce(b.dt_e,:dtb::::date) >= :dtb::::date) \
  where \
  t.dt_b <= :dtb::::date and coalesce(t.dt_e,:dtb::::date) >= :dtb::::date \
  and ttp.dt_b <= :dtb::::date and coalesce(ttp.dt_e,:dtb::::date) >= :dtb::::date \
  and p.dt_b <= :dtb::::date and coalesce(p.dt_e,:dtb::::date) >= :dtb::::date \
  group by t.id_client, c.code, c.short_name ) as ss \
union \
 select u.id_client, c.code,c.short_name, 1 ,max(v.voltage_min) as voltage \
 from \
 eqm_eqp_use_h as u \
 join eqm_point_h as p on (p.code_eqp = u.code_eqp) \
 join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
  join \
 (select cm.id, cm.code,cm.short_name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=u.id_client ) \
  where \
  u.dt_b <= :dtb::::date and coalesce(u.dt_e,:dtb::::date) >= :dtb::::date \
  and p.dt_b <= :dtb::::date and coalesce(p.dt_e,:dtb::::date) >= :dtb::::date \
  group by u.id_client, c.code, c.short_name \
  order by code \
) as sss group by id_client, code, short_name ) as ssss \
 left join (select id_clienta, count(distinct id_clientb) as cnt_sub \
 from  eqm_borders_h as bb \
  join  (select cm.id, cm.code,cm.short_name from clm_client_tbl as cm join clm_statecl_tbl as stcl on (stcl.id_client=cm.id ) \
   where book=-1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and cm.idk_work not in (0,99) and coalesce(cm.id_state,0) not in (50,99) order by cm.id) as c \
 on (c.id=bb.id_clientb ) \
 where \
 bb.dt_b <= :dtb::::date and coalesce(bb.dt_e,:dtb::::date) >= :dtb::::date \
 group by id_clienta \
 ) as sss2 on (sss2.id_clienta = ssss.id_client)";


//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

}
////////////---------------------------------------------

void TfReports::AbonWithSubAbon (void)
{
        /*
  AnsiString  sqlstr1=" select distinct  c2.id as main_id, c2.code as main_code, c2.short_name as main_name, \
    c.id as sub_id, c.code as sub_code, c.short_name as sub_name \
from ( \
select  distinct b1.id_clientB as abon , b1.id_clientA as main, b2.id_clientA as main2 \
, b3.id_clientA as main3 \
, b4.id_clientA as main4 \
from eqm_borders_tbl as b1 \
join eqm_eqp_tree_tbl as tt1 on (b1.code_eqp  = tt1.code_eqp and tt1.code_eqp_e is not null) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b2 \
 on (b1.id_clientA = b2.id_clientB  and tt1.id_tree = b2.tree_B and b2.id_clientA <> syi_resid_fun()) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b3 \
 on (b2.id_clientA = b3.id_clientB  and b2.tree_A = b3.tree_B and b3.id_clientA <> syi_resid_fun()) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b4 \
 on (b3.id_clientA = b4.id_clientB  and b3.tree_A = b4.tree_B and b4.id_clientA <> syi_resid_fun()) \
where b1.id_clientA <> syi_resid_fun() \
) as ss \
join clm_client_tbl as c on (ss.abon = c.id) \
left join clm_client_tbl as c2 on (ss.main = c2.id or ss.main2 = c2.id or ss.main3 = c2.id or ss.main4 = c2.id ) \
where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
order by c2.code, c.code ;";
     */

  AnsiString  sqlstr1=" select distinct  c2.id as main_id, c2.code as main_code, c2.short_name as main_name,\
    ssss.master_point,ssss.zone_cnt, p.name_eqp,adr.adr, \
    c.id as sub_id, c.code as sub_code, c.short_name as sub_name , \
    scl.dt_indicat as dt_indicat_sub, scl2.dt_indicat as dt_indicat_main \
from ( \
select  distinct b1.id_clientB as abon , b1.id_clientA as main, b2.id_clientA as main2 \
, b3.id_clientA as main3 \
, b4.id_clientA as main4 \
from eqm_borders_tbl as b1 \
join eqm_eqp_tree_tbl as tt1 on (b1.code_eqp  = tt1.code_eqp and tt1.code_eqp_e is not null) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b2 \
 on (b1.id_clientA = b2.id_clientB  and tt1.id_tree = b2.tree_B and b2.id_clientA <> syi_resid_fun()) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b3 \
 on (b2.id_clientA = b3.id_clientB  and b2.tree_A = b3.tree_B and b3.id_clientA <> syi_resid_fun()) \
 left join( select b2.code_eqp,b2.id_clientA,b2.id_clientB, tt21.id_tree as tree_B, tt22.id_tree as tree_A  from eqm_borders_tbl as b2 \
           join eqm_eqp_tree_tbl as tt21 on (tt21.code_eqp = b2.code_eqp and tt21.code_eqp_e is null) \
           join eqm_eqp_tree_tbl as tt22 on (tt22.code_eqp = b2.code_eqp and tt22.code_eqp_e is not null) \
 order by code_eqp) as b4 \
 on (b3.id_clientA = b4.id_clientB  and b3.tree_A = b4.tree_B and b4.id_clientA <> syi_resid_fun()) \
where b1.id_clientA <> syi_resid_fun() \
) as ss \
join clm_client_tbl as c on (ss.abon = c.id) \
join clm_statecl_tbl as scl on (scl.id_client = c.id) \
left join clm_client_tbl as c2 on (ss.main = c2.id or ss.main2 = c2.id or ss.main3 = c2.id or ss.main4 = c2.id ) \
left join clm_statecl_tbl as scl2 on (scl2.id_client = c2.id) \
left join \
( \
select distinct id_master, master_point, id,code, short_name,zone_cnt \
from \
( \
select bm.id_client as id_master, bm.id_point as master_point, \
bs.id_point as s_point1, bs.id_client as s_client1, \
bs2.id_point as s_point2, bs2.id_client as s_client2, \
bs3.id_point as s_point3, bs3.id_client as s_client3 , \
c.id, c.code, c.short_name, zz.zone_cnt \
from bal_abons_tbl as bm \
join bal_abons_tbl as bs on (bm.id_point = bs.id_p_point) \
left join bal_abons_tbl as bs2 on (bs.id_point = bs2.id_p_point) \
left join bal_abons_tbl as bs3 on (bs2.id_point = bs3.id_p_point) \
left join clm_client_tbl as c on (c.id = bs.id_client or c.id =bs2.id_client or c.id =bs3.id_client) \
left join (select code_eqp, count(distinct zone) as zone_cnt from eqd_meter_zone_tbl where kind_energy = 1 group by code_eqp) as zz \
  on (zz.code_eqp = bm.id_meter) \
order by bm.id_client, bm.id_point \
) as sss \
where id_master<>id \
) as ssss on (ssss.id_master = c2.id and ssss.id = c.id) \
left join eqm_equipment_tbl as p on (p.id = master_point) \
left join adv_address_tbl as adr on (adr.id= p.id_addres) \
where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
order by c2.code, c.code ; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}

//--------------------------------------------------------
void TfReports::Monitor_A4(boolean Build,TDateTime dtb)
{

  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr=" update rep_areas_points_tbl set voltage =  t.id_voltage \
  from eqm_eqp_tree_tbl as eqt join tree_volt_tmp as t on (eqt.id_tree = t.id_tree) \
    where eqt.code_eqp = rep_areas_points_tbl.id_point and t.id_voltage is not null \
    and coalesce(t.id_voltage ,0)<>coalesce(rep_areas_points_tbl.voltage ,0)  ;";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString sqlstr=" select distinct id_client, cc.code, cc.short_name, code_f10, name_f10,code_ps10,coalesce(name_ps10,'-від фідера-') as name_ps10 ,id_area, volt, is_town , \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
from \
( \
select ssss.code, short_name, id_point, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( \
   select 0 as book,c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, id_grp as link, v.voltage_min as voltage \
     from bal_abons_tbl as ba \
    join clm_client_tbl as c on (c.id = ba.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
    join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
    join eqm_point_tbl as p on (p.code_eqp = ba.id_point) \
    join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
    where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
)as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= :mmgg ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg ) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) order by book, code \
) as fidersel \
 right join \
(  select distinct id_point,ap.id_client,id_area,is_town , vv.voltage_min as volt \
   from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
  where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() ))  \
) as areasel on (fidersel.id_point = areasel.id_point) \
 left join eqm_equipment_tbl as eqa on (eqa.id = areasel.id_area) \
 left join clm_client_tbl as cc on (cc.id = areasel.id_client) \
order by name_f10, name_ps10,area ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 xlReport->ParamByName["lcaption"]->Value = edFiderName->Text;

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------

void TfReports::Monitor_A4_mem(boolean Build, TDateTime dtb)
{

  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  /*
  sqlstr="select calc_tree_voltage_monitor_fun();";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr=" update rep_areas_points_tbl set voltage =  t.id_voltage \
  from eqm_eqp_tree_tbl as eqt join tree_volt_tmp as t on (eqt.id_tree = t.id_tree) \
    where eqt.code_eqp = rep_areas_points_tbl.id_point and t.id_voltage is not null \
    and coalesce(t.id_voltage ,0)<>coalesce(rep_areas_points_tbl.voltage ,0)  ;";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
 */
  sqlstr="  update rep_areas_points_tbl set is_town = coalesce(kt.flag_type ,true) \
    from eqm_compens_station_inst_h as inst \
    join (select code_eqp, code_eqp_inst, max(dt_b) as dt from eqm_compens_station_inst_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by code_eqp_inst,code_eqp order by code_eqp_inst,code_eqp) as inst2 \
       on (inst.code_eqp = inst2.code_eqp and inst.code_eqp_inst = inst2.code_eqp_inst and inst2.dt = inst.dt_b) \
    join eqm_equipment_h as area on (inst.code_eqp_inst = area.id and area.type_eqp = 11) \
    join (select id, max(dt_b) as dt from eqm_equipment_h where dt_b <= :dt and coalesce(dt_e,:dt) >= :dt group by id) as area2 on (area.id = area2.id and area2.dt = area.dt_b) \
    left join adm_address_tbl as a on (a.id = area.id_addres) \
    left join adi_street_tbl as s on (s.id = a.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where inst.code_eqp= rep_areas_points_tbl.id_point; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }


  AnsiString sqlstr=" select distinct id_client, cc.code, cc.short_name, code_f10, name_f10,code_ps10,coalesce(name_ps10,'-від фідера-') as name_ps10 ,id_area, volt, is_town , \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
from \
( \
select ssss.code, short_name, id_point, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( \
   select 0 as book,c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, id_grp as link, v.voltage_min as voltage \
     from bal_abons_tbl as ba \
    join clm_client_tbl as c on (c.id = ba.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
    join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
    join eqm_point_tbl as p on (p.code_eqp = ba.id_point) \
    join eqk_voltage_tbl as v on (p.id_voltage = v.id) \
    where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
)as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= '2009-03-01'::::date ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= '2009-03-01'::::date ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= '2009-03-01'::::date ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= '2009-03-01'::::date ) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) order by book, code \
) as fidersel \
 right join \
(  select distinct id_point,ap.id_client,id_area,is_town , vv.voltage_min as volt \
   from rep_areas_points_tbl as ap \
   join eqm_eqp_tree_tbl as tt on (tt.code_eqp = ap.id_point) \
   join eqm_tree_tbl as t on (tt.id_tree = t.id) \
   join eqk_voltage_tbl as vv on (vv.id=ap.voltage) \
   left join eqm_borders_tbl as b on (b.code_eqp = t.code_eqp) \
   where ((b.code_eqp is null )or (b.id_clienta = syi_resid_fun() ))  \
) as areasel on (fidersel.id_point = areasel.id_point) \
 left join eqm_equipment_tbl as eqa on (eqa.id = areasel.id_area) \
 left join clm_client_tbl as cc on (cc.id = areasel.id_client) \
order by name_f10, name_ps10,area ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr);
//  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 xlReport->ParamByName["lcaption"]->Value = edFiderName->Text;

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::WorkRequirementCheck (TDateTime dt)
{


  AnsiString sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

   sqlstr1=sqlstr1+" select w.*,c.code, c.short_name, p.name_eqp, adr.adr::::varchar ,wi.name as work, represent_name, ba.id_grp  \
    from clm_works_tbl as w \
    join clm_client_tbl as c on (c.id =w.id_client) \
    join eqm_equipment_tbl as p on (w.id_point = p.id ) \
    join bal_abons_tbl as ba on (ba.id_point = w.id_point) \
    join cli_works_tbl as wi on (w.id_type = wi.id ) \
    left join ( \
      select id_client, id_point, max(requirement_ok_date) as max_ok_dt \
      from clm_works_tbl \
      where requirement_date is not null \
      and requirement_ok_date is not null \
      group by id_client, id_point \
    ) as ok on (ok.id_client = w.id_client and ok.id_point = w.id_point) \
    left join clm_position_tbl as cp on (w.id_position = cp.id ) \
    left join adv_address_tbl as adr on (adr.id = p.id_addres ) \
    where w.requirement_date is not null and w.requirement_date <= :dt and w.requirement_ok_date is null \
    and w.dt_work >=coalesce(ok.max_ok_dt,w.dt_work) and w.dt_work >= '2013-01-01'::::date \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    order by c.code, p.name_eqp, w.requirement_date  ";

sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by name_ps35, name_f10, name_ps10, code, name_eqp, requirement_date " ;


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = "до "+ FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::WorkTechCheck (TDateTime dt)
{

  AnsiString sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

    sqlstr1=sqlstr1+" select w.dt_work,w.id_point, w.requirement_date, w.requirement_text, w.comment, \
    coalesce(w.next_work_date,w.dt_work+'3 year'::::interval) as next_work_date, \
  c.code, c.short_name, p.name_eqp, adr.adr::::varchar ,wi.name as work, represent_name, ba.id_grp \
    from clm_works_tbl as w \
    join (select id_client, id_point, id_type, max(dt_work) as dt_work from clm_works_tbl where dt_work <= :dt \
          group by id_client, id_point, id_type) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.id_type = w2.id_type and w.dt_work  = w2.dt_work ) \
    join clm_client_tbl as c on (c.id =w.id_client) \
    join eqm_equipment_tbl as p on (w.id_point = p.id ) \
    join bal_abons_tbl as ba on (ba.id_point = w.id_point) \
    join cli_works_tbl as wi on (w.id_type = wi.id ) \
    left join clm_position_tbl as cp on (w.id_position = cp.id ) \
    left join adv_address_tbl as adr on (adr.id = p.id_addres ) \
    where coalesce(w.next_work_date,w.dt_work+'3 year'::::interval) <= :dt and wi.ident = 'work1' \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    order by c.code, p.name_eqp, w.requirement_date ";

sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by name_ps35, name_f10, name_ps10, code " ;


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = "до "+ FormatDateTime("dd.mm.yyyy",dt);
  xlReport->ParamByName["lcaption"]->Value = "Перелік точок обліку в яких термін дії технічної перевірки закінчується";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::WorkControlCheck (TDateTime dt)
{

  AnsiString sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

   sqlstr1=sqlstr1+" select w.dt_work,w.id_point, w.requirement_date, w.requirement_text, w.comment, \
    coalesce(w.next_work_date,w.dt_work+'6 month'::::interval) as next_work_date, \
    c.code, c.short_name, p.name_eqp, adr.adr::::varchar ,wi.name as work, represent_name , ba.id_grp \
    from clm_works_tbl as w \
    join (select id_client, id_point, id_type, max(dt_work) as dt_work from clm_works_tbl where dt_work <= :dt \
          group by id_client, id_point, id_type) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.id_type = w2.id_type and w.dt_work  = w2.dt_work ) \
    join clm_client_tbl as c on (c.id =w.id_client) \
    join eqm_equipment_tbl as p on (w.id_point = p.id ) \
    join bal_abons_tbl as ba on (ba.id_point = w.id_point) \
    join cli_works_tbl as wi on (w.id_type = wi.id ) \
    left join clm_position_tbl as cp on (w.id_position = cp.id ) \
    left join adv_address_tbl as adr on (adr.id = p.id_addres ) \
    where coalesce(w.next_work_date,w.dt_work+'6 month'::::interval) <= :dt and wi.ident = 'work2' \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    order by c.code, p.name_eqp, w.requirement_date ";

sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by name_ps35, name_f10, name_ps10, code " ;
    

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = "до "+ FormatDateTime("dd.mm.yyyy",dt);
  xlReport->ParamByName["lcaption"]->Value = "Перелік точок обліку в яких термін дії попереднього контрольного огляду закінчується";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PlombListAll (TDateTime dt,int client, int inspector)
{
  AnsiString  sqlstr1="  select c.code, c.short_name, eq.name_eqp, trim(adr.adr) as adr, t.name as type,\
  p.object_name , p.plomb_num, p.dt_b, p.plomb_owner, p.dt, trim(p.comment) as comment, \
  trim(cp.represent_name) as represent_name, trim(cp2.represent_name) as person_name,\
  CASE WHEN coalesce(mm.magnet,0)=1 THEN 'Так' END as magnet \
  from clm_plomb_tbl as p \
  left join cli_plomb_type_tbl as t on (t.id = p.id_type) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  left join clm_position_tbl as cp2 on (cp2.id = p.id_person) \
  left join clm_client_tbl as c on (c.id = p.id_client ) \
  left join eqm_equipment_h as eq on (eq.id = p.id_point and  eq.dt_b <= :dt and coalesce(eq.dt_e, :dt ) >=:dt) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres ) \
  left join \
  (select id_point, max(magnet) as magnet from eqm_meter_point_h as h \
   join eqm_meter_h as m on (m.code_eqp = h.id_meter) \
   where h.dt_b <= :dt and coalesce(h.dt_e, :dt ) >=:dt \
   and m.dt_b <= :dt and coalesce(m.dt_e, :dt ) >=:dt \
   group by id_point \
  ) as mm on (mm.id_point = eq.id) \
  where p.dt_b <= :dt and coalesce(p.dt_e, :dt ) >=:dt \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and (p.id_client = :client or :client is null ) and (p.id_position = :pos or :pos is null) \
  order by c.code, eq.name_eqp, p.object_name,p.plomb_num ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dt);
  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PlombInstall (TDateTime dtb,TDateTime dte,int client, int inspector)
{
  AnsiString  sqlstr1="  select c.code, c.short_name, eq.name_eqp, adr.adr, t.name as type, p.* ,cp.represent_name, cp_off.represent_name as represent_name_off \
  from clm_plomb_tbl as p \
  join clm_client_tbl as c on (c.id = p.id_client ) \
  join eqm_equipment_h as eq on (eq.id = p.id_point ) \
  join (select id,max(dt_b) as datb from eqm_equipment_h group by id ) as eq2 on (eq2.id = eq.id and eq.dt_b = eq2.datb) \
  left join cli_plomb_type_tbl as t on (t.id = p.id_type) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  left join clm_position_tbl as cp_off on (cp_off.id = p.id_position_off) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres ) \
  where p.dt_b <= :dt_e and p.dt_b >=:dt_b \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and (p.id_client = :client or :client is null ) and (p.id_position = :pos or :pos is null) \
  order by c.code, eq.name_eqp, p.object_name,p.plomb_num ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_b")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dt_e")->AsDateTime=dte;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  xlReport->ParamByName["lcaption"]->Value = "Перелік пломб, що встановлені за період";

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PlombDelete (TDateTime dtb,TDateTime dte,int client, int inspector)
{
  AnsiString  sqlstr1="  select c.code, c.short_name, eq.name_eqp, adr.adr, t.name as type, p.* ,cp.represent_name, cp_off.represent_name as represent_name_off \
  from clm_plomb_tbl as p \
  join clm_client_tbl as c on (c.id = p.id_client ) \
  join eqm_equipment_h as eq on (eq.id = p.id_point ) \
  join (select id,max(dt_b) as datb from eqm_equipment_h group by id ) as eq2 on (eq2.id = eq.id and eq.dt_b = eq2.datb) \
  left join cli_plomb_type_tbl as t on (t.id = p.id_type) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  left join clm_position_tbl as cp_off on (cp_off.id = p.id_position_off) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres ) \
  where p.dt_e is not null and p.dt_e <= :dt_e and p.dt_e >=:dt_b \
  and (p.id_client = :client or :client is null ) and (p.id_position_off = :pos or :pos is null) \
  order by c.code, eq.name_eqp, p.object_name,p.plomb_num ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_b")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dt_e")->AsDateTime=dte;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  xlReport->ParamByName["lcaption"]->Value = "Перелік пломб, зняті за період";

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::WorkListAll (TDateTime dtb,TDateTime dte,int client, int inspector)
{
  AnsiString  sqlstr1=" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select mainss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from \
( \
   select w.*,c.code, c.short_name, p.name_eqp, adr.adr::::varchar ,wi.name as work, cp.represent_name, cu.represent_name as user_name, \
   (select num_eqp from clm_work_indications_tbl where id_work = w.id order by kind_energy ASC,id_zone ASC limit 1) as num_eqp, \
   (select value from clm_work_indications_tbl where id_work = w.id order by kind_energy ASC,id_zone ASC limit 1) as indic \
    from clm_works_tbl as w \
    join clm_client_tbl as c on (c.id =w.id_client) \
    join eqm_equipment_tbl as p on (w.id_point = p.id ) \
    join cli_works_tbl as wi on (w.id_type = wi.id ) \
    left join clm_position_tbl as cp on (w.id_position = cp.id ) \
    left join clm_position_tbl as cu on (w.id_person = cu.id ) \
    left join adv_address_tbl as adr on (adr.id = p.id_addres ) \
    where w.dt_work <= :dt_e and w.dt_work >=:dt_b \
    and (w.id_client = :client or :client is null ) and (w.id_position = :pos or :pos is null) \
) as mainss \
  left join bal_abons_tbl as ba on (ba.id_point = mainss.id_point) \
  left join eqm_equipment_tbl as ee on (ee.id = ba.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = ba.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by code, name_eqp, requirement_date;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_b")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dt_e")->AsDateTime=dte;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::WorkListDt(TDateTime dtb,TDateTime dte, int inspector)
{
  AnsiString  sqlstr1=" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select mainss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from \
( \
   select w.*,c.code, c.short_name, p.name_eqp, adr.adr::::varchar ,wi.name as work, cp.represent_name, cu.represent_name as user_name, \
   (select num_eqp from clm_work_indications_tbl where id_work = w.id order by kind_energy ASC,id_zone ASC limit 1) as num_eqp, \
   (select value from clm_work_indications_tbl where id_work = w.id order by kind_energy ASC,id_zone ASC limit 1) as indic \
    from clm_works_tbl as w \
    join clm_client_tbl as c on (c.id =w.id_client) \
    join eqm_equipment_tbl as p on (w.id_point = p.id ) \
    join cli_works_tbl as wi on (w.id_type = wi.id ) \
    left join clm_position_tbl as cp on (w.id_position = cp.id ) \
    left join clm_position_tbl as cu on (w.id_person = cu.id ) \
    left join adv_address_tbl as adr on (adr.id = p.id_addres ) \
    where w.dt <= :dt_e and w.dt >=:dt_b and (w.id_person = :pos or :pos is null) \
) as mainss \
  left join bal_abons_tbl as ba on (ba.id_point = mainss.id_point) \
  left join eqm_equipment_tbl as ee on (ee.id = ba.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = ba.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by code, name_eqp, requirement_date;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_b")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dt_e")->AsDateTime=dte;

  if (inspector != 0)
    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Роботи вніс  "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::WarningDebet (boolean Build, TDateTime dt,TDateTime mmgg,int client, int inspector,int list)
{
   int obr_exists=0;
    AnsiString message;
    AnsiString sqlstr;

   if (Build)
   {
     sqlstr="select count(*) as cnt from seb_obr_all_tbl where period = date_trunc('month', :mmgg::::date)- '1 month'::::interval;";
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
     obr_exists = ZQReps->FieldByName("cnt")->AsInteger;
     ZQReps->Close();

     if ((mmgg > cur_mmgg)||(obr_exists==0))
     {
      if (mmgg > cur_mmgg) message ="Предыдущий месяц не закрыт! Переформировать оборотку ?";
      else message ="Нет данных за предыдущий месяц! Переформировать оборотку ?";

      int r = MessageDlg(message, mtConfirmation, TMsgDlgButtons() << mbYes << mbNo<<mbCancel, 0);

      if ( r==mrCancel ) return;
      if ( r==mrYes )
      {
        sqlstr=" select seb_all( 3, (date_trunc('month', :mmgg::::date)- '1 month'::::interval)::::date );";

        ZQReps->Close();
        ZQReps->Sql->Clear();
        ZQReps->Sql->Add(sqlstr);
        ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

        try
        {
         ZQReps->ExecSql();
        }
        catch(...)
        {
         ShowMessage("Ошибка SQL :"+sqlstr);
         return;
        }

      }
     }
   }


  AnsiString  sqlstr1=" \
   select distinct cl.id, ss_a.sumbill,ss_a.bill_date,ss_a.transmis_date,ss_a.pay_all,ss_a.pay_date, stcl.phone, \
     calend_dt_inc(coalesce(ss_a.transmis_date,ss_a.bill_date)::::date,stcl.day_pay_bill) as check_date, :dt::::date as rep_date , \
     calend_dt_inc(coalesce(ss_a.transmis_date,ss_a.bill_date)::::date,stcl.day_pay_bill+3) as last_date_nominal, \
     calend_dt_inc(coalesce(ss_a.transmis_date,ss_a.bill_date)::::date,stcl.day_pay_bill+4) as off_date_nominal, \
     calend_dt_inc(:dt::::date,3) as last_date, \
     calend_dt_inc(:dt::::date,4) as off_date, \
     stcl.phone, coalesce(pos_phones,' ') as addphones, \
     CASE WHEN ss_a.dk >0 THEN ss_a.dk ELSE 0 END as debet_a, \
     CASE WHEN ss_r.dk >0 THEN ss_r.dk ELSE 0 END as debet_r, \
     CASE WHEN ss_2kr.dk >0 THEN ss_2kr.dk ELSE 0 END as debet_2kr, \
     cl.code, cl.short_name, cl.name as abonname, coalesce(cp.represent_name,' ') as represent_name,adr.adr, town.name as city ,  \
     coalesce(stcl.addr_local,' ') as addr_local , \
     CASE WHEN  coalesce(ssw.action,0) =1 THEN 'Отключен' WHEN coalesce(ssw.action,0) =2 THEN 'Предупрежден' WHEN coalesce(ssw.action,0) =5 THEN 'Предупрежден (аванс)' ELSE '' END as status ,\
     coalesce(ssw.action,0) as status_code , ssw.dt_action, ssw.dt_warning, ssw.dt_transmiss, ssw.comment,  \
     CASE WHEN  coalesce(ssw2.action,0) =5 THEN 'Предупрежден' ELSE '' END as status2 ,\
     ssw2.dt_action as dt_action2, ssw2.dt_warning as dt_warning2, ssw2.dt_transmiss as dt_transmiss2, ssw2.comment as comment2  \
     from \
      (select cl.* from clm_client_tbl as cl where ( :client is null or id = :client ) order by cl.id) as cl  \
      join clm_statecl_h as stcl on (cl.id = stcl.id_client) \
    left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb,  \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0) \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = 10  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = 10 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = 10 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client) as pay using (id_client) \
       order by id_client \
   )as ss_a  on (cl.id = ss_a.id_client) \
   left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0) \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref = 20  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref = 20 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref = 20 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_r  on (cl.id = ss_r.id_client) \
   left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb,  \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all, pay.reg_date as pay_date, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0) \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client , clm.order_pay,  \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, \
     e_kred+e_kred_tax as kr_zkmv_now, kr_zkmv - (e_kred+e_kred_tax) as kr_zkmv_old, \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = date_trunc('month', :mmgg::::date)- '1 month'::::interval and obr.id_pref in (520,524)  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = date_trunc('month', :mmgg::::date) and b.reg_date <= :dt \
      and b.id_pref in (520,524) and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and (date_trunc('month', :mmgg::::date) = date_trunc('month', p.reg_date))  \
       and p.id_pref in (520,524) and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_2kr  on (cl.id = ss_2kr.id_client) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action  , csw.dt_warning, csw.dt_transmiss, csw.comment \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where dt_action<=:dt and action <> 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action not in (3,4,5) and cswc.id_client is null \
        order by csw.id_client \
      ) as ssw on (cl.id = ssw.id_client) \
     left join \
      (  select csw.id_client,  csw.dt_action,  csw.action  , csw.dt_warning, csw.dt_transmiss, csw.comment \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where dt_action<=:dt and action = 5  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       where csw.action =5 and not exists (select id from clm_switching_tbl as cswc where (csw.id_client = cswc.id_client and csw.dt_action <= cswc.dt_action and cswc.action in (1,3,4)) ) \
        order by csw.id_client \
      ) as ssw2 on (cl.id = ssw2.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position = cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (cl.id = phones.id_client) \
     left join adv_address_tbl as adr on (adr.id = cl.id_addres) \
     left join adi_town_tbl as town on (town.id = adr.id_town) \
     where cl.idk_work not in (0,99)  and ( :insp is null or cp.id = :insp) \
     and ( :client is null or cl.id = :client ) \
     and   stcl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = stcl.id_client and stcl2.mmgg_b <= date_trunc('month', :mmgg::::date) ) \
     and (ss_a.dk > 0 or ss_r.dk >0 or ss_2kr.dk >0) \
     and  (calend_dt_inc(coalesce(ss_a.transmis_date,ss_a.bill_date)::::date,stcl.day_pay_bill) <= :dt) \
    order by cl.code  ;";

    //     and coalesce(ssw.action,0) not in (1,2) \

  ZQXLReps->Close();
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("insp")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("insp")->Clear();

  AnsiString  sqlstr2=" \
   select  boss.name as bospos,boss.represent_name as bossname,:dt::::date as rep_date,  respar.* \
     from \
     (select res.id, res.name, res.short_name as resname,respar.addr_local||',тел '||respar.phone as resaddr, \
            acc_a.account||','||banka.name||',МФО '||text(banka.id)||', код '||text(respar.okpo_num) as acc_a, \
            acc_r.account||','||bankr.name||',МФО '||text(bankr.id)||', код '||text(respar.okpo_num) as acc_r \
            from clm_client_tbl as res left join clm_statecl_tbl as respar on (respar.id_client = res.id) \
            left join cli_account_tbl as acc_a on (acc_a.id_client = res.id and acc_a.ident ='act_ee') \
            left join cmi_bank_tbl as banka on (banka.id = acc_a.mfo) \
            left join cli_account_tbl as acc_r on (acc_r.id_client = res.id and acc_r.ident ='react_ee') \
            left join cmi_bank_tbl as bankr on (bankr.id = acc_r.mfo) \
            where res.id = syi_resid_fun() \
     ) as respar \
     left join ( select * from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') where pos.id_client = syi_resid_fun() )as boss on (respar.id = boss.id_client) ;";


  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";

  xlReport->Params->Clear();

  if(list==1)
  {
   Param=xlReport->Params->Add();
   Param->Name="lres";
   Param=xlReport->Params->Add();
   Param->Name="lperiod";
   Param=xlReport->Params->Add();
   Param->Name="lnow";
   Param=xlReport->Params->Add();
   Param->Name="linsp";
   Param=xlReport->Params->Add();
   Param->Name="ldt";
   Param=xlReport->Params->Add();
   Param->Name="luser";
   Param=xlReport->Params->Add();
   Param->Name="luserphone";


   xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
   xlReport->ParamByName["lres"]->Value = ResName;
   xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
   FormatDateTime("dd.mm.yyyy",dtEnd->Date);
   xlReport->ParamByName["ldt"]->Value = "на "+FormatDateTime("dd.mm.yyyy",dt);

   xlReport->ParamByName["luser"]->Value = CurUserName;
   xlReport->ParamByName["luserphone"]->Value = CurUserPhone;


   if (InspectorId!=0)
     xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
   else
     xlReport->ParamByName["linsp"]->Value = " ";
  }

  if(list==0)
  {
   xlReport->MultisheetAlias = "ZQXLReps";
   xlReport->MultisheetField = "code";
  }

  xlReport->Report();
  xlReport->MultisheetAlias = "";
  xlReport->MultisheetField = "";

 ZQXLReps->Close();
 ZQXLReps2->Close(); 

}
//---------------------------------------------------------------------------
void TfReports::WarningAvans (boolean Build, TDateTime dt,TDateTime pmmgg,int client, int inspector,int list)
{
   int obr_exists=0;
    AnsiString message;
    AnsiString sqlstr;
    TDateTime mmgg = pmmgg;

   if (Build)
   {
     sqlstr="select count(*) as cnt from seb_obr_all_tbl where period = date_trunc('month', :mmgg::::date)- '1 month'::::interval;";
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
     obr_exists = ZQReps->FieldByName("cnt")->AsInteger;
     ZQReps->Close();

     if ((mmgg > cur_mmgg)||(obr_exists==0))
     {
      if (mmgg > cur_mmgg) message ="Предыдущий месяц не закрыт! Переформировать оборотку ?";
      else message ="Нет данных за предыдущий месяц! Переформировать оборотку ?";

      int r = MessageDlg(message, mtConfirmation, TMsgDlgButtons() << mbYes << mbNo<<mbCancel, 0);

      if ( r==mrCancel ) return;
      if ( r==mrYes )
      {
        sqlstr=" select seb_all( 3, (date_trunc('month', :mmgg::::date)- '1 month'::::interval)::::date );";

        ZQReps->Close();
        ZQReps->Sql->Clear();
        ZQReps->Sql->Add(sqlstr);
        ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

        try
        {
         ZQReps->ExecSql();
        }
        catch(...)
        {
         ShowMessage("Ошибка SQL :"+sqlstr);
         return;
        }

      }
     }
   }

//      date_trunc('month', :mmgg::::date)::::date+text(text(pre_pay_day-1)||' days')::::interval as pre_pay_date \
//      calend_dt_inc(coalesce(ss_a.transmis_date,ss_a.bill_date)::::date,stcl.day_pay_bill) as check_date

     sqlstr=" select date_trunc('month', :mmgg::::date) as mmgg, calend_dt_inc(:dt::::date,3) as last_date, calend_dt_inc(:dt::::date,4) as off_date  ;";

     ZQReps->Close();
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     ZQReps->ParamByName("dt")->AsDateTime=dt;

     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    mmgg = ZQReps->FieldByName("mmgg")->AsDateTime;
    TDateTime last_date = ZQReps->FieldByName("last_date")->AsDateTime;
    TDateTime off_date = ZQReps->FieldByName("off_date")->AsDateTime;

    ZQReps->Close();
    //-------------------
     sqlstr=" delete from rep_last_bill_tmp ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

     sqlstr=" insert into rep_last_bill_tmp \
              select id_client, max(mmgg) \
              from acm_bill_tbl \
              where mmgg <= :mmgg::::date - '1 month'::::interval  and mmgg >=:mmgg::::date - '3 month'::::interval \
              and demand_val > 0 and id_pref=10 and idk_doc = 200 \
              group by id_client order by id_client ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }


  AnsiString  sqlstr1=" select bigsel.*, round(value_dem*tarif_value*pre_pay_perc*1.2,2) as sum_avans, date_part('day',pre_pay_date ) as pre_pay_day, \
  GREATEST(round(value_dem*tarif_value*pre_pay_perc*1.2 -CASE WHEN ( pay_all + kb_now - db ) >0 THEN ( pay_all + kb_now - db ) ELSE 0 END + debet_a+debet_r+debet_2kr ,2),0) as debet \
   from ( \
   select distinct cl.id, ss_a.sumbill,ss_a.bill_date,ss_a.transmis_date,ss_a.pay_all,ss_a.pay_date, ss_a.kb_now, ss_a.db , stcl.phone, stcl.dt_indicat, stcl.pre_pay_day0, \
     :dt::::date as rep_date ,  :last_date::::date as last_date, :off_date::::date as off_date, \
     slimit.value_dem, \
     CASE WHEN avgtarsss.f_zone<>0 or avgtarsss.f_othertarif <> 0 or ((avgtarsss.f_main =0) and (avgtarsss.f_fiz <> 0 ) ) \
      THEN avgtarsss.avg_tar ELSE CASE WHEN tarsss.tarif_value is not null THEN tarsss.tarif_value \
      ELSE tar_2kl.tarif_value END END as tarif_value,  \
     stcl.phone, coalesce(pos_phones,'') as addphones, \
     CASE WHEN ss_a.dk >0 THEN ss_a.dk ELSE 0 END as debet_a, \
     CASE WHEN ss_r.dk >0 THEN ss_r.dk ELSE 0 END as debet_r, \
     CASE WHEN ss_2kr.dk >0 THEN ss_2kr.dk ELSE 0 END as debet_2kr, \
     cl.code, cl.short_name,cl.name as abonname, cp.represent_name,adr.adr, town.name as city ,  \
     stcl.addr_local, stcl.pre_pay_date1, stcl.pre_pay_date2, stcl.pre_pay_date3, \
     stcl.pre_pay_day1, stcl.pre_pay_day2, stcl.pre_pay_day3, stcl.doc_num, stcl.doc_dat, \
     stcl.pre_pay_perc3, stcl.pre_pay_perc2, stcl.pre_pay_perc1, \
     CASE WHEN (stcl.pre_pay_date3 is not null) and (stcl.pre_pay_date3 < :dt::::date) THEN stcl.pre_pay_date3 \
          WHEN (stcl.pre_pay_date2 is not null) and (stcl.pre_pay_date2 < :dt::::date) THEN stcl.pre_pay_date2 \
          WHEN (stcl.pre_pay_date1 is not null) and (stcl.pre_pay_date1 < :dt::::date) THEN stcl.pre_pay_date1 \
          ELSE null END as pre_pay_date , \
     CASE WHEN (stcl.pre_pay_date3 is not null) and (stcl.pre_pay_date3 < :dt::::date) THEN coalesce(stcl.pre_pay_perc3,0)+coalesce(stcl.pre_pay_perc2,0)+coalesce(stcl.pre_pay_perc1,0) \
          WHEN (stcl.pre_pay_date2 is not null) and (stcl.pre_pay_date2 < :dt::::date) THEN coalesce(stcl.pre_pay_perc2,0)+coalesce(stcl.pre_pay_perc1,0) \
          WHEN (stcl.pre_pay_date1 is not null) and (stcl.pre_pay_date1 < :dt::::date) THEN coalesce(stcl.pre_pay_perc1,0) \
          ELSE 0 END::::numeric/100 as pre_pay_perc ,  \
     CASE WHEN  coalesce(ssw.action,0) =1 THEN 'Отключен' WHEN coalesce(ssw.action,0) =2 THEN 'Предупрежден' WHEN coalesce(ssw.action,0) =5 THEN 'Предупрежден' ELSE '' END as status ,\
     coalesce(ssw.action,0) as status_code, ssw.dt_action, ssw.dt_warning, ssw.dt_transmiss , ssw.comment, \
     CASE WHEN  coalesce(ssw2.action,0) =2 THEN 'Предупрежден' ELSE '' END as status2 ,\
     ssw2.dt_action as dt_action2, ssw2.dt_warning as dt_warning2, ssw2.dt_transmiss as dt_transmiss2, ssw2.comment as comment2  \
     from \
      (select cl.* from clm_client_tbl as cl where ( :client is null or id = :client ) order by cl.id) as cl  \
      join \
      ( select st.id_client, st.dt_indicat, st.phone,st.day_pay_bill, st.addr_local, st.id_position, st.pre_pay_perc3, st.pre_pay_perc2, st.pre_pay_perc1, -st.pre_pay_day1 as pre_pay_day0, \
        st.pre_pay_day1, st.pre_pay_day2, st.pre_pay_day3, st.doc_num, st.doc_dat, \
        CASE WHEN (coalesce(st.pre_pay_day3,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day3,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date3, \
        CASE WHEN (coalesce(st.pre_pay_day2,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day2,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date2, \
        CASE WHEN (coalesce(st.pre_pay_day1,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day1,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date1 \
        from  clm_statecl_h as st \
        where st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = st.id_client and stcl2.mmgg_b <= :mmgg::::date ) \
        and ( :insp is null or st.id_position = :insp)  \
        order by st.id_client \
      ) as stcl on (cl.id = stcl.id_client) \
    left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, coalesce(s.kr_zkmv,0) as kb, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.kr_zkmv,0) ELSE coalesce(kr_zkmv_now,0) END as kb_now,  \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all,  pay.reg_date as pay_date, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0) \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km12v as deb12_k,  e_kred+e_kred_tax as kr_zkmv_now,  \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = :mmgg::::date- '1 month'::::interval and obr.id_pref = 10  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = :mmgg::::date and b.reg_date <= :dt \
      and b.id_pref = 10 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref = 10 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_a  on (cl.id = ss_a.id_client) \
   left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0)  \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km12v as deb12_k,   e_kred+e_kred_tax as kr_zkmv_now,  \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period =  :mmgg::::date- '1 month'::::interval and obr.id_pref = 20  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg =  :mmgg::::date and b.reg_date <= :dt \
      and b.id_pref = 20 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref = 20 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_r  on (cl.id = ss_r.id_client) \
   left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     CASE WHEN s.order_pay =0 THEN coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv,0)  \
          ELSE coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_zkmv_now,0) END as dk \
     from \
     (select obr.id_client, clm.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km12v as deb12_k,  e_kred+e_kred_tax as kr_zkmv_now,  \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period =  :mmgg::::date- '1 month'::::interval and obr.id_pref in (520,524)  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = :mmgg::::date and b.reg_date <= :dt \
      and b.id_pref in (520,524) and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref in (520,524) and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_2kr  on (cl.id = ss_2kr.id_client) \
   left join ( \
   select hl.id_client, sum(d1.value_dem) as value_dem \
     from acd_demandlimit_tbl as d1 \
     join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and d2.month_limit= :mmgg \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
     where hl.idk_document = 600  and d1.month_limit= :mmgg \
     group by hl.id_client \
     order by hl.id_client \
   ) as slimit on (slimit.id_client =cl.id ) \
   left join \
   ( select id_client, CASE when dem1>dem2 then  tcl1_id else tcl2_id end as tcl_id, t.id , tt.value as tarif_value \
     from \
     (select b.id_client, \
      sum(CASE when tcl1.ident='tcl1' then bs1.demand_val else 0 end ) as dem1, \
      sum(CASE when tcl1.ident='tcl2' then bs1.demand_val else 0 end ) as dem2, \
      max(CASE when tcl1.ident='tcl1' then tcl1.id else 0 end) as tcl1_id, \
      max(CASE when tcl1.ident='tcl2' then tcl1.id else 0 end) as tcl2_id \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t2 on (t2.id_client = b.id_client and t2.mmgg = b.mmgg ) \
      join aci_tarif_tbl as tar1 on (tar1.id=bs1.id_tariff) \
      join eqi_classtarif_tbl as tcl1 on (tar1.id_classtarif=tcl1.id) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
     ) as tss \
    join aci_tarif_tbl as t on (t.id_grouptarif = 12 and t.id_classtarif = CASE when dem1>dem2 then  tcl1_id else tcl2_id end ) \
    join acd_tarif_tbl as tt on (tt.id_tarif = t.id) \
    join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date group by id_tarif  )as ttd on (tt.id_tarif = ttd.id_tarif and tt.dt_begin = ttd.dtb) \
    order by id_client \
   ) as tarsss on (tarsss.id_client = cl.id) \
   left join \
   ( select b.id_client, CASE WHEN sum(bs1.demand_val) >0 THEN round(sum(bs1.sum_val)/sum(bs1.demand_val),5) ELSE 0 END as avg_tar, \
      sum(CASE WHEN coalesce(bs1.id_zone ,0)<>0 THEN 1 ELSE 0 END ) as f_zone, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) not in (12,14,15,16,21,22,29,30,44,45,28,35,37,48) THEN 1 ELSE 0 END ) as f_othertarif, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (12,14,15,16,21,22,29,30) THEN 1 ELSE 0 END ) as f_main, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (28,35,37,48) THEN 1 ELSE 0 END ) as f_fiz \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t1 on (t1.id_client = b.id_client and t1.mmgg = b.mmgg ) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
   ) as avgtarsss on (avgtarsss.id_client = cl.id) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action , csw.dt_warning, csw.dt_transmiss, csw.comment \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where dt_action<=:dt and action <> 2 group by id_client order by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action <> 3 and csw.action <> 4 and csw.action <> 2 and cswc.id_client is null \
       order by id_client \
      ) as ssw on (cl.id = ssw.id_client) \
     left join \
      (  select csw.id_client,  csw.dt_action,  csw.action  , csw.dt_warning, csw.dt_transmiss, csw.comment \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where dt_action<=:dt and action = 2  group by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       where csw.action =2 and not exists (select id from clm_switching_tbl as cswc where (csw.id_client = cswc.id_client and csw.dt_action <= cswc.dt_action and cswc.action in (1,3,4)) ) \
        order by csw.id_client \
      ) as ssw2 on (cl.id = ssw2.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position = cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client order by id_client) as phones on (cl.id = phones.id_client) \
     left join adv_address_tbl as adr on (adr.id = cl.id_addres) \
     left join adi_town_tbl as town on (town.id = adr.id_town), \
     (select t.id , tt.value as tarif_value \
      from aci_tarif_tbl as t  \
      join acd_tarif_tbl as tt on (tt.id_tarif = t.id) \
      join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date group by id_tarif  )as ttd on (tt.id_tarif = ttd.id_tarif and tt.dt_begin = ttd.dtb) \
      where t.id_grouptarif = 12 and t.id_classtarif = 14 \
     ) as tar_2kl \
     where cl.idk_work not in (0,99) \
    ) as bigsel ";

    if (!(cbAll->Checked))
       sqlstr1= sqlstr1+" where pre_pay_perc<> 0 and round( value_dem*tarif_value*pre_pay_perc*1.2 ,2) - CASE WHEN ( pay_all + kb_now - db ) >0 THEN ( pay_all + kb_now - db ) ELSE 0 END > 0 ";

    sqlstr1= sqlstr1+"order by code ;";

//      where b.id_pref=10  and b.mmgg=:mmgg::::date - '1 month'::::interval  and bs1.demand_val<>0 \

//      where b.id_pref=10  and b.mmgg= ( select max(mmgg) from acm_bill_tbl where id_client = b.id_client \
//            and mmgg <= :mmgg::::date - '1 month'::::interval and demand_val > 0 and id_pref=10 )  and bs1.demand_val<>0 \
//            and b.mmgg<= :mmgg::::date - '1 month'::::interval and b.mmgg >=:mmgg::::date - '3 month'::::interval \

//       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value+b.value_tax ELSE 0 END) as sumbill12 \
//      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12 \


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;
  ZQXLReps->ParamByName("last_date")->AsDateTime=last_date;
  ZQXLReps->ParamByName("off_date")->AsDateTime=off_date;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();

  if (inspector != 0)
    ZQXLReps->ParamByName("insp")->AsInteger=inspector;
  else
    ZQXLReps->ParamByName("insp")->Clear();

  AnsiString  sqlstr2=" \
   select  boss.name as bospos,boss.represent_name as bossname, :dt::::date as rep_date, respar.* \
     from \
     (select res.id, res.name, res.short_name as resname,respar.addr_local||',тел '||respar.phone::::varchar as resaddr, \
            acc_a.account||','||banka.name||',МФО '||text(banka.id)::::varchar||', код '||text(respar.okpo_num)::::varchar as acc_a, \
            acc_r.account||','||bankr.name||',МФО '||text(bankr.id)::::varchar||', код '||text(respar.okpo_num)::::varchar as acc_r \
            from clm_client_tbl as res left join clm_statecl_tbl as respar on (respar.id_client = res.id) \
            left join cli_account_tbl as acc_a on (acc_a.id_client = res.id and acc_a.ident ='act_ee') \
            left join cmi_bank_tbl as banka on (banka.id = acc_a.mfo) \
            left join cli_account_tbl as acc_r on (acc_r.id_client = res.id and acc_r.ident ='react_ee') \
            left join cmi_bank_tbl as bankr on (bankr.id = acc_r.mfo) \
            where res.id = syi_resid_fun() \
     ) as respar \
     left join ( select * from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') where pos.id_client = syi_resid_fun() )as boss on (respar.id = boss.id_client) ;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";


  xlReport->Params->Clear();

  if(list==1)
  {
   Param=xlReport->Params->Add();
   Param->Name="lres";
   Param=xlReport->Params->Add();
   Param->Name="lperiod";
   Param=xlReport->Params->Add();
   Param->Name="lnow";
   Param=xlReport->Params->Add();
   Param->Name="linsp";
   Param=xlReport->Params->Add();
   Param->Name="ldt";
   Param=xlReport->Params->Add();
   Param->Name="luser";
   Param=xlReport->Params->Add();
   Param->Name="luserphone";


   xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
   xlReport->ParamByName["lres"]->Value = ResName;
   xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
   FormatDateTime("dd.mm.yyyy",dtEnd->Date);
   xlReport->ParamByName["ldt"]->Value = "на "+FormatDateTime("dd.mm.yyyy",dt);

   xlReport->ParamByName["luser"]->Value = CurUserName;
   xlReport->ParamByName["luserphone"]->Value = CurUserPhone;

   if (InspectorId!=0)
     xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
   else
     xlReport->ParamByName["linsp"]->Value = " ";
  }

  if(list==0)
  {
   xlReport->MultisheetAlias = "ZQXLReps";
   xlReport->MultisheetField = "code";
  }
  xlReport->Report();
  xlReport->MultisheetAlias = "";
  xlReport->MultisheetField = "";

 ZQXLReps->Close();
 ZQXLReps2->Close(); 

}
//---------------------------------------------------------------------------
void TfReports::PrintNasPTarifAbons(TDateTime dtb,TDateTime dte)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1="  select c.code, c.name, ss.* from \
  ( \
    select b.id_client,b.mmgg as link, \
    sum(CASE WHEN tgr.ident ~'tgr8' THEN bs.demand_val ELSE 0 END ) as demand_8 , \
    sum(CASE WHEN tgr.ident ~'tgr7' THEN bs.demand_val ELSE 0 END ) as demand_7 , \
    sum(bs.demand_val) as demand \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    join clm_client_tbl as cl on (cl.id = b.id_client) \
    join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
    join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
    where b.id_pref=10 and cl.book = -1 \
    and bs.demand_val<>0 \
    and bs.mmgg>=date_trunc('month',:dtb::::date) and bs.mmgg<=date_trunc('month',:dte::::date) \
    group by b.id_client,b.mmgg \
  ) as ss \
  join clm_client_tbl as c on (c.id = ss.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  where demand_8<>0 or demand_7<>0 and scl.id_section not in (205,206,207,208) \
  order by link, code ; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;


  // по категориям
  AnsiString  sqlstr2=" select b.mmgg as link, \
  sum(CASE WHEN tgr.ident ~'tgr8' THEN bs.demand_val ELSE 0 END ) as demand_8 , \
  sum(CASE WHEN tgr.ident ~'tgr7' THEN bs.demand_val ELSE 0 END ) as demand_7 , \
  sum(bs.demand_val) as demand \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where b.id_pref=10 and cl.book = -1 \
  and bs.demand_val<>0 \
  and bs.mmgg>=date_trunc('month',:dtb::::date) and bs.mmgg<=date_trunc('month',:dte::::date) \
  group by b.mmgg  order by link ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLRepsSum->ParamByName("dte")->AsDateTime=dte;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
//  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  xlReport->MultisheetAlias = "ZQXLRepsSum";
  xlReport->MultisheetField = "link";
  xlReport->Report();
  xlReport->MultisheetAlias = "";
  xlReport->MultisheetField = "";


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintEqpChanges(TDateTime dtb,TDateTime dte,int id_client, boolean Build)
{

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select rep_hist_parse_fun( :dtb::::date, :dte::::date);";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("dtb")->AsDateTime=dtb;
   ZQReps->ParamByName("dte")->AsDateTime=dte;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }


  AnsiString  sqlstr1=" select rf.*, t.name, t.note, f.name as fname, f.note as fnote, eq.name_eqp, us.name as user_name,   \
  (text(rf.id_client)||text(rf.dt_change))::::varchar as link \
  from rep_hist_changed_fields_tbl as rf \
  left join syi_table_tbl as t on (t.id = rf.id_table) \
  left join syi_field_tbl as f on (f.id= rf.id_field) \
  left join eqm_equipment_h as eq on (eq.id = rf.code_eqp and eq.dt_b <= rf.dt_change and (eq.dt_e is null or eq.dt_e > rf.dt_change)) \
  left join syi_user as us on (us.id = rf.id_usr ) \
  where (rf.id_client = :client or :client is null ) \
  order by eq.name_eqp,id_table,id_field  ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  if (id_client!=0)
    ZQXLReps->ParamByName("client")->AsInteger=id_client;
  else
    ZQXLReps->ParamByName("client")->Clear();


  // по абонентам
  AnsiString  sqlstr2="  select distinct rf.dt_change, c.id, (text(c.id)||text(rf.dt_change))::::varchar as link,  c.code, c.short_name \
  from rep_hist_changed_fields_tbl as rf \
  left join clm_client_tbl as c on (rf.id_client = c.id) \
  where (rf.id_client = :client or :client is null ) \
  order by rf.dt_change,c.code ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);

  if (id_client!=0)
    ZQXLRepsSum->ParamByName("client")->AsInteger=id_client;
  else
    ZQXLRepsSum->ParamByName("client")->Clear();

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  // new eqp
  AnsiString  sqlstr3=" select eq.*, t.name as tree, dk.name as kind, c.code, c.short_name, adr.adr , us.name as user_name \
  from eqm_equipment_h as eq \
  join eqi_device_kinds_tbl as dk on (dk.id = eq.type_eqp) \
  join eqm_eqp_tree_h as tt on (tt.code_eqp = eq.id and tt.dt_b = eq.dt_b) \
  join eqm_tree_h as t on (t.id = tt.id_tree and t.dt_b <=tt.dt_b and (t.dt_e is null or t.dt_e > tt.dt_b ) ) \
  left join eqm_eqp_use_h as u1 on (u1.code_eqp = eq.id and eq.dt_b >=u1.dt_b and (u1.dt_e is null or u1.dt_e> eq.dt_b) ) \
  left join clm_client_tbl as c on (c.id = coalesce(u1.id_client,t.id_client)) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  left join eqm_equipment_h as eq2 on (eq2.id = eq.id and eq2.dt_b < eq.dt_b) \
  left join syi_user as us on (us.id = eq.id_user ) \
  where eq.dt_b >= :dtb and eq.dt_b <= :dte \
  and eq2.id is null and (c.id = :client or :client is null ) \
  and ( dk.id <> 9 or tt.code_eqp_e is null ) \
  order by dt_b, code, kind, name_eqp; ";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr3);

  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps2->ParamByName("dte")->AsDateTime=dte;

  if (id_client!=0)
    ZQXLReps2->ParamByName("client")->AsInteger=id_client;
  else
    ZQXLReps2->ParamByName("client")->Clear();

  // drop eqp
  AnsiString  sqlstr4=" select eq.*, t.name as tree, dk.name as kind, c.code, c.short_name, adr.adr , us.name as user_name \
  from eqm_equipment_h as eq \
  join eqi_device_kinds_tbl as dk on (dk.id = eq.type_eqp) \
  join eqm_eqp_tree_h as tt on (tt.code_eqp = eq.id and tt.dt_b <= eq.dt_b and (tt.dt_e is null or tt.dt_e > eq.dt_b ) ) \
  join eqm_tree_h as t on (t.id = tt.id_tree and t.dt_b <=tt.dt_b and (t.dt_e is null or t.dt_e > tt.dt_b ) ) \
  left join eqm_eqp_use_h as u1 on (u1.code_eqp = eq.id and eq.dt_b >=u1.dt_b and (u1.dt_e is null or u1.dt_e> eq.dt_b) ) \
  left join clm_client_tbl as c on (c.id = coalesce(u1.id_client,t.id_client)) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  left join eqm_equipment_h as eq2 on (eq2.id = eq.id and eq2.dt_b > eq.dt_b) \
  left join (select * from eqm_changelog_tbl where mode = 2 and processing = 1 )as ch on (ch.code_eqp = eq.id) \
  left join syi_user as us on (us.id = ch.id_usr ) \
  where eq.dt_e is not null and eq.dt_e >= :dtb and eq.dt_e <= :dte \
  and eq2.id is null and (c.id = :client or :client is null ) \
  and ( dk.id <> 9 or tt.code_eqp_e is null ) \
  order by dt_e, code, kind, name_eqp;";

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr4);

  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLRepsSum2->ParamByName("dte")->AsDateTime=dte;

  if (id_client!=0)
    ZQXLRepsSum2->ParamByName("client")->AsInteger=id_client;
  else
    ZQXLRepsSum2->ParamByName("client")->Clear();

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLRepsSum2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLRepsNew";
  Dsr->Range = "range_new";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsDel";
  Dsr->Range = "range_del";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintCompens5_2month_fider(TDateTime mmgg, boolean Build)
{
  int kpv=99999999;
  int comp =999999999;
  if (Ask("Вывести только недогруженные трансформаторы ?") )
  {kpv=5;
   comp=0;
  };

  if (Build)
  {

    if(MessageDlg("Обновить даные по недогруженным трансформаторам? (~ 5-10 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
    {
      AnsiString sqlstr="select  calc_compens(:mmgg) ;";
      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
              ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
      try
       {
        ZQReps->ExecSql();
        ZQReps->Close();
       ZQReps->Sql->Clear();
       AnsiString sqlstr="select  close() ;";
       ZQReps->Sql->Add(sqlstr);
        ZQReps->ExecSql();
       }
      catch(...)
       {
        ShowMessage("Ошибка SQL :"+sqlstr);
        return;
       }
    }
   }

  AnsiString sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select distinct c.code,c.short_name, c.name, adc.adr as abon_adr, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type as type_meter, im.carry, im.amperage_nom,m.dt_control,ph.name as phase, km.name as kind,  id_grp as link ,\
  k.k_ts, k.wtml, k.calc_demand_nocnt,k.ktr_demand,k.p_w, rclient.short_name as rname, rclient.code as rcode, \
  case when k.calc_demand_nocnt-k.ktr_demand>0 then k.calc_demand_nocnt-k.ktr_demand else 0 end  as minus,   \
  k_old.ktr_demand as ktr_demand_old,k_old.p_w as p_w_old, k_old.calc_demand_nocnt as calc_demand_nocnt_old , \
  case when k_old.calc_demand_nocnt-k_old.ktr_demand>0 then k_old.calc_demand_nocnt-k_old.ktr_demand else 0 end  as minus_old,   \
  text(vl.voltage_max)::::varchar as volt_name , sti.tt_type, sti.tt_accuracy, sti.tt_control, pr.cl as meter_accuracy \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqi_meter_prec_tbl as pr on (pr.id_type_eqp=im.id )  \
  left join adv_address_tbl as adc on (adc.id = c.id_addres) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join eqk_voltage_tbl as vl on (vl.id = p.id_un) \
  left join  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
    ic.conversion , ic.type as tt_type,ic.accuracy as tt_accuracy, c.date_check as tt_control from \
     eqm_compensator_i_tbl as c \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = m.code_eqp ) \
  left join \
     ( select distinct k.*,b.*, pb.id_rclient  from acd_met_kndzn_tbl as k \
       join (select distinct id_doc, id_point,id_client, id_rclient from acd_point_branch_tbl order by id_point )as pb  on (pb.id_doc = k.id_doc and pb.id_point = k.id_point ) \
       join acm_bill_tbl as b0 on (b0.id_doc = pb.id_doc and b0.id_client = pb.id_client)  \
       left join \
       ( select a.code_eqp,(case when a.wtm<>0 then a.wtm else 168 end) as wtml, a.dt_b,a.dt_e \
         from (select * from eqm_point_h where :mmgg between dt_b and coalesce(dt_e,:mmgg)) as a  \
       ) as b  on  b.code_eqp=k.id_point and b.dt_b<=k.dat_e and (b.dt_e>=k.dat_b or b.dt_e is null) \
       where calc_demand_nocnt>0 and b0.mmgg = :mmgg and kind_energy =1  \
       order by id_point \
     ) as k on (k.id_point = ba.id_point) \
  left join \
     ( select distinct k.*,b.*, pb.id_rclient  from acd_met_kndzn_tbl as k \
       join (select distinct id_doc, id_point,id_client, id_rclient from acd_point_branch_tbl order by id_point )as pb  on (pb.id_doc = k.id_doc and pb.id_point = k.id_point ) \
       join acm_bill_tbl as b0 on (b0.id_doc = pb.id_doc and b0.id_client = pb.id_client)  \
       left join \
       ( select a.code_eqp,(case when a.wtm<>0 then a.wtm else 168 end) as wtml, a.dt_b,a.dt_e \
         from (select * from eqm_point_h where :mmgg::::date-'1 month'::::interval between dt_b and coalesce(dt_e,:mmgg::::date-'1 month'::::interval)) as a  \
       ) as b  on  b.code_eqp=k.id_point and b.dt_b<=k.dat_e and (b.dt_e>=k.dat_b or b.dt_e is null) \
       where calc_demand_nocnt>0 and b0.mmgg = :mmgg::::date-'1 month'::::interval and  kind_energy =1 \
       order by id_point \
     ) as k_old on (k_old.id_point = ba.id_point and k.id_zone = k_old.id_zone) \
  left join  clm_client_tbl as rclient on (rclient.id = k.id_rclient ) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
        and (k.p_w<=:kpv) ";


   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
  order by code " ;

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("kpv")->AsInteger=kpv;

  AnsiString  sqlstr2="  select res.id, res.name, res.short_name as resname,respar.addr_local||',тел '||respar.phone::::varchar as resaddr \
            from clm_client_tbl as res left join clm_statecl_tbl as respar on (respar.id_client = res.id) \
            where res.id = syi_resid_fun() ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
   ZQXLReps->Open();
   ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  Param=xlReport->Params->Add();
  Param->Name="lres2";
  Param=xlReport->Params->Add();
  Param->Name="lresaddr";

  if (res_code==310)
  {
    xlReport->ParamByName["lres2"]->Value = "Чернігівські міські електромережі";
    xlReport->ParamByName["lresaddr"]->Value = "Пр.-т. Перемоги 126  тел: 654-459";

  }
  else
  {
    xlReport->ParamByName["lres2"]->Value = ZQXLReps2->FieldByName("resname")->AsString;
    xlReport->ParamByName["lresaddr"]->Value = ZQXLReps2->FieldByName("resaddr")->AsString;
  }

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}

//-----------------------------------------------------------------------------------------------------

void TfReports::InspectControlReport(TDateTime dtb,TDateTime dte, int inspector )
{
  AnsiString  sqlstr1="  select ssss.*, \
  CASE WHEN value>=before_indic THEN calc_ind_pr(value,before_indic,carry)*koef ELSE -calc_ind_pr(before_indic,value,carry)*koef END as control_dem, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2   END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2  END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2   END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , ee2.name_eqp as grpname2, \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2 \
  from ( \
    select  si.reg_date ,si.id_client,cl.code,cl.short_name as name_client, scl.doc_num, \
   si.id_point,ep.name_eqp as name_point, si.id_meter,si.num_eqp, \
   si.id_address,ad.adr, m.carry, m.type, ke.name as energy, kz.name as zone,  \
   si.value,si.koef,si.id_previndic,ii.value as before_indic,ii.dat_ind,ii.value_dem , ba.id_grp as link , si.work_type , pos.represent_name, \
   si.dt_insp, si.dt \
   from  ( \
   select h.reg_date ,i.id_client,i.id_point,i.id_meter,i.num_eqp,i.id_address, i.value,i.koef,i.id_previndic, i.kind_energy ,i.zone, i.type_eqp, \
   'Обход' as work_type, h.id_position , i.dt_insp, i.dt   from \
   ( select * from acm_inspectstr_tbl where value is not null and dt_insp >= :dtb and dt_insp <= :dte order by id_doc) as i \
   join (select * from acm_inspecth_tbl  where ( id_position = :insp or :insp is null )  order by id_doc ) as h \
    on (h.id_doc = i.id_doc) \
   union \
    select w.dt_work,w.id_client, i.id_point, i.id_meter, i.num_eqp, eq.id_addres, i.value, ind.coef_comp, ind.id as id_previndic, \
   i.kind_energy, i.id_zone,i.id_type, wi.name, w.id_position, w.dt_work, w.dt  \
     from ( select * from clm_work_indications_tbl where value is not null  order by id_work )as i \
     join ( select * from clm_works_tbl where ( id_position = :insp or :insp is null ) and dt_work >= :dtb and dt_work <= :dte  order by id ) as w on (w.id = i.id_work) \
     join cli_works_tbl as wi on (wi.id = w.id_type) \
     join eqi_meter_tbl as im on (im.id = i.id_type) \
     join eqm_equipment_tbl as eq on (eq.id = i.id_point ) \
     left join acd_indication_tbl as ind on  (i.id_meter=ind.id_meter \
        and i.num_eqp=ind.num_eqp \
        and i.id_zone=ind.id_zone and i.kind_energy=ind.kind_energy \
        and w.dt_work > ind.dat_ind ) \
     where  ind.id = (select id from acd_indication_tbl where id_meter=ind.id_meter \
        and num_eqp=ind.num_eqp   and id_zone=ind.id_zone and kind_energy=ind.kind_energy and dat_ind < w.dt_work \
        order by dat_ind desc limit 1) \
   ) as si    \
   join clm_client_tbl cl on (si.id_client=cl.id) \
   join clm_statecl_tbl as scl on (scl.id_client = cl.id) \
   join eqi_meter_tbl as m on (m.id = si.type_eqp) \
   join eqk_energy_tbl as ke on (ke.id = si.kind_energy ) \
   join eqk_zone_tbl as kz on (kz.id = si.zone ) \
   left join clm_position_tbl as pos on (pos.id = si. id_position ) \
   left join (select id,adr from adv_address_tbl  order by id) ad  on  si.id_address=ad.id \
   left join (select  i.id,i.value,i.value_dem,i.dat_ind from  acd_indication_tbl i order by id) as ii  on (ii.id=si.id_previndic ) \
   left join (select distinct id,name_eqp from \
      ( select h.* from eqm_equipment_h as h  where dt_b=(select max(dt_b) from eqm_equipment_h hh where hh.id=h.id) \
        and type_eqp=12 order by id ) as h2 \
      ) as ep    on (si.id_point=ep.id) \
   left join bal_abons_tbl as ba  on (si.id_point = ba.id_point) \
   order by si.id_point \
   ) as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  ) as ssss \
  where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END = :fider) or ( :fider = 0 )) \
  order by reg_date, code  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

  if (inspector!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=inspector;
  else
     ZQXLReps->ParamByName("insp")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="linsp";
  Param=xlReport->Params->Add();
  Param->Name="lfider";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "За період "+FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  if (InspectorId!=0)
    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
  else
    xlReport->ParamByName["linsp"]->Value = " ";

  if (FiderId!=0)
   xlReport->ParamByName["lfider"]->Value = edFiderName->Text;
  else
   xlReport->ParamByName["lfider"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::PrintUncheckedMeters(TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select ssss.*, \
  case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2   END as name_f10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2  END as code_ps10, \
case when id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2   END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , ee2.name_eqp as grpname2, \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2 \
  from ( \
  select distinct c.id, c.short_name, c.code, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control, \
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, eqh.dt_b as dt_ch, \
    sc.phone,cp.represent_name,adr.adr, obhod2.dt_insp as last_dt_insp,  obhod2.value as last_value, ww3.dt_work as last_dt_work ,wi1.value as last_work_value ,iw.name as last_work_name,  ba.id_grp , ke.name as energy \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join ( select id, num_eqp, min(dt_b) as dt_b from  eqm_equipment_h where type_eqp = 1 group by id, num_eqp order by id, num_eqp ) as eqh on (eqh.id = eq.id and eq.num_eqp = eqh.num_eqp ) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqd_meter_energy_tbl as me on (me.code_eqp = eq.id) \
    join eqk_energy_tbl as ke on (ke.id = me.kind_energy ) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_point_tbl as pp on (pp.code_eqp = mp.id_point ) \
    left join eqm_equipment_tbl as eqpp on (pp.code_eqp = eqpp.id) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join adv_address_tbl as adr  on (adr.id = eqpp.id_addres) \
    left join \
    ( select i.id_meter,i.num_eqp \
      from \
      ( select * from acm_inspectstr_tbl where value is not null and dt_insp >= :dtb and dt_insp <= :dte and kind_energy = 1 ) as i \
       union \
       select i.id_meter, i.num_eqp  \
       from ( select * from clm_work_indications_tbl where value is not null and kind_energy = 1 order by id_work )as i  \
       join ( select * from clm_works_tbl where dt_work >= :dtb and dt_work <= :dte  order by id ) as w on (w.id = i.id_work) \
       order by id_meter,num_eqp \
    ) as obhod on (obhod.id_meter = eq.id and obhod.num_eqp = eq.num_eqp ) \
    left join ( select is1.dt_insp, is1.value , is1.id_meter, is1.num_eqp from acm_inspectstr_tbl as  is1 \
     join (select id_meter, num_eqp, max(dt_insp) as dt_insp from acm_inspectstr_tbl where value is not null and dt_insp < :dtb group by id_meter, num_eqp  order by id_meter, num_eqp) as is2 \
     on (is1.id_meter = is2.id_meter and is1.num_eqp = is2.num_eqp and is1.dt_insp = is2.dt_insp) where is1.value is not null and zone in (0,3,5,8,10) and kind_energy = 1 order by is1.id_meter, is1.num_eqp \
    ) as obhod2 on (obhod2.id_meter = eq.id and obhod2.num_eqp = eq.num_eqp ) \
   left join \
   ( select max(w1.id) as id , w1.dt_work, w1.id_point \
     from clm_works_tbl as  w1 \
     join cli_works_tbl as iw on (iw.id = w1.id_type) \
     join (select w2.id_point, max(w2.dt_work) as dt_work from clm_works_tbl as  w2  where dt_work < :dtb group by w2.id_point order by id_point) as ww \
     on (ww.id_point = w1.id_point and ww.dt_work = w1.dt_work) group by w1.id_point, w1.dt_work \
   ) as ww2 on (ww2.id_point = pp.code_eqp ) \
  join clm_works_tbl as ww3 on (ww3.id = ww2.id) \
  join cli_works_tbl as iw on (iw.id = ww3.id_type) \
  left join clm_work_indications_tbl as wi1 on (wi1.id_work = ww2.id and wi1.num_eqp = eq.num_eqp and wi1.id_zone in (0,3,5,8,10) and wi1.kind_energy = 1) \
  left join bal_abons_tbl as ba  on (pp.code_eqp = ba.id_point) \
    where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and obhod.id_meter is null  and me.kind_energy = 1 \
    order by c.code, eq.num_eqp \
 ) as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  ) as ssss \
  where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END = :fider) or ( :fider = 0 )) \
  order by code, num_eqp  ";

//     where eqh.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
//   ( select dt_insp from acm_inspectstr_tbl where value is not null and dt_insp < :dtb  and id_meter = eq.id and num_eqp = eq.num_eqp order by dt_insp DESC, kind_energy ASC,zone ASC limit 1 ) as last_dt_insp, \
//   ( select value from acm_inspectstr_tbl where value is not null and dt_insp < :dtb  and id_meter = eq.id and num_eqp = eq.num_eqp order by dt_insp DESC, kind_energy ASC,zone ASC limit 1 ) as last_value \


//    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :dte::::date ) ) \

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
   ZQXLReps->ParamByName("dte")->AsDateTime=dte;
   ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="lperiod";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";

  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------

void TfReports::ObSaldoDemandYear(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям


  AnsiString  sqlstr2="  select coalesce(obr1.roz,obr2.roz,obr3.roz,obr4.roz,obr5.roz,obr6.roz,obr7.roz,obr8.roz,obr9.roz,obr10.roz,obr11.roz,obr12.roz) as link ,\
  cla.name, obr1.nar as nar1 ,obr2.nar as nar2 ,obr3.nar as nar3 ,obr4.nar as nar4 ,obr5.nar as nar5 ,obr6.nar as nar6 ,obr7.nar as nar7, \
  obr8.nar as nar8, obr9.nar as nar9 ,obr10.nar as nar10,obr11.nar as nar11,obr12.nar as nar12 \
     from \
    (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable1 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 1  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr1 \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable2 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 2  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr2 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable3 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 3  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr3 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable4 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 4  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr4 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable5 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 5  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr5 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable6 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 6  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr6 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable7 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 7  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr7 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable8 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 8  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr8 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable9 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 9  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr9 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable10 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 10  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr10 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable11 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 11  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr11 using (roz) \
     full outer join (select coalesce(roz,999) as roz, sum(nar) as nar from %obrtable12 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 12  and id_pref = :pref and idk_work not in (0,99) group by roz order by roz ) as obr12 using (roz) \
     join cla_param_tbl as cla on (coalesce(obr1.roz,obr2.roz,obr3.roz,obr4.roz,obr5.roz,obr6.roz,obr7.roz,obr8.roz,obr9.roz,obr10.roz,obr11.roz,obr12.roz)  = cla.kod and cla.id_group = 200) \
     order by cla.sort; ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
/*
  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tbl";
*/
  if (EncodeDate(year1,1,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable1")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable1")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,2,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable2")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable2")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,3,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable3")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable3")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,4,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable4")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable4")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,5,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable5")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable5")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,6,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable6")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable6")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,7,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable7")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable7")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,8,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable8")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable8")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,9,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable9")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable9")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,10,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable10")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable10")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,11,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable11")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable11")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,12,1)>=cur_mmgg)
    ZQXLRepsSum->MacroByName("obrtable12")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable12")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;


  // по потребителям


  AnsiString  sqlstr1=" select coalesce(obr1.roz,obr2.roz,obr3.roz,obr4.roz,obr5.roz,obr6.roz,obr7.roz,obr8.roz,obr9.roz,obr10.roz,obr11.roz,obr12.roz) as link, \
  coalesce(obr1.osob_r,obr2.osob_r,obr3.osob_r,obr4.osob_r,obr5.osob_r,obr6.osob_r,obr7.osob_r,obr8.osob_r,obr9.osob_r,obr10.osob_r,obr11.osob_r,obr12.osob_r) as osob_r, \
  coalesce(obr1.osob_rsk,obr2.osob_rsk,obr3.osob_rsk,obr4.osob_rsk,obr5.osob_rsk,obr6.osob_rsk,obr7.osob_rsk,obr8.osob_rsk,obr9.osob_rsk,obr10.osob_rsk,obr11.osob_rsk,obr12.osob_rsk) as abon_name, \
  c.represent_name, obr1.nar as nar1 ,obr2.nar as nar2 ,obr3.nar as nar3 ,obr4.nar as nar4 ,obr5.nar as nar5 ,obr6.nar as nar6 ,obr7.nar as nar7, \
  obr8.nar as nar8, obr9.nar as nar9 ,obr10.nar as nar10,obr11.nar as nar11,obr12.nar as nar12 , pp.point_cnt \
     from \
     (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable1 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 1  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr1 \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable2 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 2  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr2 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable3 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 3  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr3 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable4 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 4  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr4 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable5 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 5  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr5 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable6 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 6  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr6 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable7 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 7  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr7 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable8 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 8  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr8 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable9 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 9  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr9 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable10 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 10  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr10 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable11 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 11  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr11 using (id_client) \
     full outer join (select id_client, coalesce(roz,999) as roz, osob_r,osob_rsk, nar from %obrtable12 where date_part('year',period) = date_part('year',:mmgg::::date) and date_part('month',period) = 12  and id_pref = :pref and idk_work not in (0,99) and coalesce(nar,0)<>0 order by id_client ) as obr12 using (id_client) \
     join (select c.*,s.id_position,p.represent_name \
      from clm_client_tbl c join clm_statecl_tbl s on (s.id_client=c.id) \
      left join clm_position_tbl p on (s.id_position=p.id )  \
     ) as c on (c.id = coalesce(obr1.id_client,obr2.id_client,obr3.id_client,obr4.id_client,obr5.id_client,obr6.id_client,obr7.id_client,obr8.id_client,obr9.id_client,obr10.id_client,obr11.id_client,obr12.id_client)) \
     left join (select id_client, count(distinct id_point) as point_cnt from rep_areas_points_tbl group by id_client order by id_client) as pp on (c.id = pp.id_client) \
     order by obr1.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  if (EncodeDate(year1,1,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable1")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable1")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,2,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable2")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable2")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,3,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable3")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable3")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,4,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable4")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable4")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,5,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable5")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable5")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,6,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable6")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable6")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,7,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable7")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable7")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,8,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable8")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable8")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,9,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable9")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable9")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,10,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable10")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable10")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,11,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable11")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable11")->AsString="seb_obr_all_tbl";

  if (EncodeDate(year1,12,1)>=cur_mmgg)
    ZQXLReps->MacroByName("obrtable12")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable12")->AsString="seb_obr_all_tbl";

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("yyyy",dtBegin->Date)+" рік";
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);

  if (kind_energy==1)
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  else
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";

  if (kind_energy == 0)  xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за активну електроенергію";
  if (kind_energy == 1)  xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за реактивну електроенергію";
  if (kind_energy == 2)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Передача електроенергії.";
  if (kind_energy == 8)  xlReport->ParamByName["caption"]->Value = " Оборотна відомість. Інформаційні послуги.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------


void TfReports::HomeNetsDemand(TDateTime mmgg)
{

  AnsiString  sqlstr2=" select ab.num_gek as link, sum(ss1.losts) as losts, \
    sum(dem.demand) as demand ,sum (ss1.fizdemand) as fizdemand, ab.num_gek  from \
   (select eq.id, eq.name_eqp, sum(acl.losts) as losts ,sum(aca.demand) as fizdemand \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
    join bal_acc_tbl as acl on (acl.code_eqp = ins.code_eqp and acl.mmgg = :pmmgg ) \
    left join bal_eqp_tbl as eqb on (eqb.code_eqp = ins.code_eqp and eqb.mmgg = :pmmgg and eqb.type_eqp in (6,7)) \
    left join bal_acc_tbl as aca on (aca.code_eqp = -eqb.code_eqp and aca.mmgg = :pmmgg ) \
    where eq.type_eqp = 17 \
    group by eq.id, eq.name_eqp \
   ) as ss1 \
   left join \
   ( select eq.id, sum(demand_val) as demand \
     from eqm_equipment_tbl as eq \
     join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
     join acd_billsum_tbl as bs on (bs.id_point  = ins.code_eqp and mmgg = :pmmgg and kind_energy = 1) \
     where eq.type_eqp = 17 \
     group by eq.id \
   ) as dem on (dem.id = ss1.id) \
   left join adi_build_tbl as ab on (ab.id = ss1.id) \
   group by link,ab.num_gek  order by link ; ";

   ZQXLRepsSum->Sql->Clear();
   ZQXLRepsSum->Sql->Add(sqlstr2);
   ZQXLRepsSum->ParamByName("pmmgg")->AsDateTime=mmgg;



  AnsiString  sqlstr1=" select ab.num_gek as link, ss1.*, dem.demand , ab.num_gek  from \
   (select eq.id, eq.name_eqp, sum(acl.losts) as losts ,sum(aca.demand) as fizdemand \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
    join bal_acc_tbl as acl on (acl.code_eqp = ins.code_eqp and acl.mmgg = :pmmgg ) \
    left join bal_eqp_tbl as eqb on (eqb.code_eqp = ins.code_eqp and eqb.mmgg = :pmmgg and eqb.type_eqp in (6,7)) \
    left join bal_acc_tbl as aca on (aca.code_eqp = -eqb.code_eqp and aca.mmgg = :pmmgg ) \
    where eq.type_eqp = 17  \
    group by eq.id, eq.name_eqp \
   ) as ss1 \
   left join \
   ( select eq.id, sum(demand_val) as demand \
     from eqm_equipment_tbl as eq \
     join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
     join acd_billsum_tbl as bs on (bs.id_point  = ins.code_eqp and mmgg = :pmmgg and kind_energy = 1) \
     where eq.type_eqp = 17 \
     group by eq.id \
   ) as dem on (dem.id = ss1.id) \
   left join adi_build_tbl as ab on (ab.id = ss1.id) \
   order by link,name_eqp ; ";


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("pmmgg")->AsDateTime=mmgg;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  //----------------------

    AnsiString  sqlstr3=" select eq.id, eq.name_eqp as homenet, eq2.id as id_line, eq2.name_eqp as line, pd.value,c.book,c.code, c.name, ab.num_gek \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
    join bal_acc_tbl as acl on (acl.code_eqp = ins.code_eqp and acl.mmgg = :pmmgg ) \
    join eqm_equipment_tbl as eq2 on (eq2.id = ins.code_eqp ) \
    join bal_eqp_tbl as eqb on (eqb.code_eqp = ins.code_eqp and eqb.mmgg = :pmmgg and eqb.type_eqp in (6,7)) \
    join acm_privdem_tbl as pd on (pd.id_eqpborder = eq2.id and pd.mmgg = :pmmgg ) \
    join clm_pclient_tbl as c on (c.id = pd.id_client) \
    left join adi_build_tbl as ab on (ab.id = eq.id) \
    where eq.type_eqp = 17 \
    order by eq.name_eqp,eq2.name_eqp, c.book,c.code limit 64000; ";

   ZQXLReps2->Sql->Clear();
   ZQXLReps2->Sql->Add(sqlstr3);
   ZQXLReps2->ParamByName("pmmgg")->AsDateTime=mmgg;

   ZQXLReps2->MasterSource=NULL;
   ZQXLReps2->LinkFields="";

    AnsiString  sqlstr4=" select eq.id, eq.name_eqp as homenet, eq2.id as id_line, eq2.name_eqp as line, pd.value,c.book,c.code, c.name, ab.num_gek \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
    join bal_acc_tbl as acl on (acl.code_eqp = ins.code_eqp and acl.mmgg = :pmmgg ) \
    join eqm_equipment_tbl as eq2 on (eq2.id = ins.code_eqp ) \
    join bal_eqp_tbl as eqb on (eqb.code_eqp = ins.code_eqp and eqb.mmgg = :pmmgg and eqb.type_eqp in (6,7)) \
    join acm_privdem_tbl as pd on (pd.id_eqpborder = eq2.id and pd.mmgg = :pmmgg ) \
    join clm_pclient_tbl as c on (c.id = pd.id_client) \
    left join adi_build_tbl as ab on (ab.id = eq.id) \
    where eq.type_eqp = 17 \
    order by eq.name_eqp,eq2.name_eqp, c.book,c.code offset 64000; ";

   ZQXLRepsSum2->Sql->Clear();
   ZQXLRepsSum2->Sql->Add(sqlstr4);
   ZQXLRepsSum2->ParamByName("pmmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
    ZQXLRepsSum->Open();
    ZQXLReps2->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;

  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias =  "ZQXLReps2";
  Dsr->Range = "Range2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLReps3";
  Dsr->Range = "Range3";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum2->Close();

}
//---------------------------------------------------------------------------
void TfReports::PointsNoPlombNoWork(void)
{
  AnsiString  sqlstr1="select distinct eq.id, c.code, c.short_name as name, eq.name_eqp,   cp.represent_name , adr.adr , \
    case when w.id_point is null then '-' else '+' end as works, \
    case when pl.id_point is null then '-' else '+' end as plombs \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_point_tbl as p on (p.code_eqp = eq.id) \
    left join  eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
    left join clm_position_tbl as cp on (p.id_position=cp.id) \
    left join  adv_address_tbl as adr  on (adr.id = eq.id_addres) \
    left join  clm_works_tbl as w on (w.id_point = eq.id) \
    left join  clm_plomb_tbl as pl on (pl.id_point = eq.id) \
    where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book=-1 and scl.id_section not in (205,206,207,208) \
    and ( w.id_point is null or pl.id_point is null) \
   order by c.code, eq.name_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------

void TfReports::PrintPrognozFiders(TDateTime mmgg, boolean Build)
{
  AnsiString sqlstr;
  if (Build)
  {

  if(MessageDlg("Переформировать данные ?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    sqlstr="select bal_prognoz_calc_fun(:mmgg);";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  sqlstr="select * from bal_prognoz_basics_tbl where mmgg = :mmgg ;";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  int res_demand = ZQReps->FieldByName("res_demand")->AsInteger;
  int losts_1kl = ZQReps->FieldByName("losts_1kl")->AsInteger;
  int losts_2kl = ZQReps->FieldByName("losts_2kl")->AsInteger;

  ZQReps->Close();

  ZQXLRepsSum->Sql->Clear();
  AnsiString sqlstr1;
  // фидера
  sqlstr1 =" select pf.*,eq.name_eqp, cp.represent_name, pf.id_fider as link2  \
   from bal_prognoz_fiders_tbl as pf \
   join eqm_equipment_tbl as eq on (eq.id = pf.id_fider) \
   join eqm_fider_tbl as ff on (ff.code_eqp = pf.id_fider) \
   left join clm_position_tbl as cp on (cp.id = ff.id_position) \
   where pf.mmgg = :mmgg and (pf.id_fider = :fider or :fider is null ) and \
   ( :insp is null or ff.id_position = :insp) \
   order by cp.represent_name, eq.name_eqp;  ";

  ZQXLRepsSum->Sql->Add( sqlstr1 );

  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  // Группы потребителей
  AnsiString  sqlstr3=" select sum(demand_prognoz) as demand_prognoz, sum(sum_prognoz) as sum_prognoz, \
   cla.id, cla.name as grp_name, cla.sort, (text(p.id_fider)||'|'||text(cla.id))::::varchar as link, p.id_fider as link2  \
   from bal_prognoz_points_tbl as pp \
   join bal_points_all_tbl as p on (p.id_point = pp.id_point) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= pp.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where pp.mmgg = :mmgg and p.dat = :mmgg and (p.id_fider = :fider or :fider is null )  \
   group by cla.id, cla.name, cla.sort, p.id_fider \
   order by cla.sort; ";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);

  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLRepsSum2->ParamByName("fider")->AsInteger=FiderId;

  // расшифровка
  AnsiString  sqlstr2=" select pp.*,cc.code, \
   CASE WHEN p.fiz_count is not null THEN cc.short_name||'('||text(p.fiz_count)||')' ELSE cc.short_name END::::varchar as short_name, \
   cla.name as grp_name, eq2.name_eqp as point , p.id_fider as link2,  \
  (text(p.id_fider)||'|'||text(cla.id))::::varchar as link \
   from bal_prognoz_points_tbl as pp \
   join bal_points_all_tbl as p on (p.id_point = pp.id_point) \
   left join \
   ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
     (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
   ) as eq2  on (p.id_point=eq2.id) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= pp.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where pp.mmgg = :mmgg and p.dat = :mmgg and (p.id_fider = :fider or :fider is null )  and coalesce(demand_prognoz,0) <>0 \
   order by cla.sort, cc.code; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr2);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  
  ZQXLRepsSum2->MasterSource=DSRep;
  ZQXLRepsSum2->LinkFields="link2 = link2";

  ZQXLReps->MasterSource=DSRep2;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLRepsSum->Open();
  ZQXLRepsSum2->Open();
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias = "ZQXLRepsSum2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lres_demand";
  Param=xlReport->Params->Add();
  Param->Name="losts_1kl";
  Param=xlReport->Params->Add();
  Param->Name="losts_2kl";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "На "+FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->ParamByName["lres_demand"]->Value = IntToStr(res_demand);
  xlReport->ParamByName["losts_1kl"]->Value = IntToStr(losts_1kl);
  xlReport->ParamByName["losts_2kl"]->Value = IntToStr(losts_2kl);

/*  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";
  caption =caption+ edFiderName->Text;
  xlReport->ParamByName["caption"]->Value = caption;
*/
  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";



 ZQXLReps->Close();
 ZQXLRepsSum2->Close();
 ZQXLRepsSum->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
 ZQXLRepsSum2->MasterSource=NULL;
 ZQXLRepsSum2->LinkFields="";

}
//------------------------------------------------------------------------------

void TfReports::PrintPrognozFactFiders(TDateTime mmgg, boolean Build)
{

  AnsiString sqlstr;

/*
  if (Build)
  {

  if(MessageDlg("Переформировать данные ?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select bal_prognoz_calc_fun(:mmgg);";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }
*/

  sqlstr="select * from bal_prognoz_basics_tbl where mmgg = :mmgg ;";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  int res_demand = ZQReps->FieldByName("res_demand")->AsInteger;
  int losts_1kl = ZQReps->FieldByName("losts_1kl")->AsInteger;
  int losts_2kl = ZQReps->FieldByName("losts_2kl")->AsInteger;
  int res_demand_fact = ZQReps->FieldByName("res_demand_fact")->AsInteger;
  int losts_1kl_fact = ZQReps->FieldByName("losts_1kl_fact")->AsInteger;
  int losts_2kl_fact = ZQReps->FieldByName("losts_2kl_fact")->AsInteger;

  ZQXLRepsSum->Sql->Clear();
  AnsiString sqlstr1;
  // фидера
  sqlstr1 =" select pf.*, bd.ktr_demand as res_demand, pf.losts*pb.losts_2kl_fact/l.losts_all as losts_prognoz,  cp.represent_name, pf.id_fider as link2 , \
  ssum.sum_val \
   from \
   (select code_eqp as id_fider, name, id_point, sum(demand) as demand, sum(losts) as losts \
    from bal_grp_tree_conn_tbl where type_eqp = 15 and mmgg = :mmgg \
    group by  code_eqp, name, id_point order by code_eqp ) as pf \
   join (select sum(losts) as losts_all from bal_grp_tree_conn_tbl where type_eqp = 15 and mmgg = :mmgg ) as l on (1=1) \
   join eqm_fider_tbl as ff on (ff.code_eqp = pf.id_fider) \
   left join (select * from bal_prognoz_basics_tbl where mmgg = :mmgg ) as pb on (1=1) \
   left join bal_demand_tbl as bd  on (bd.id_point=pf.id_point and bd.mmgg = :mmgg) \
   left join clm_position_tbl as cp on (cp.id = ff.id_position) \
   left join \
   ( select p.id_fider, sum(case when gt.demand = 0 then 0 else round(bs.bill_sum * p.demand /gt.demand,2) end ) as sum_val \
     from \
     (select id_client, code_eqp as id_point , id_fider, sum(demand) as demand  \
      from bal_grp_tree_conn_tbl where type_eqp = 12 and mmgg = :mmgg \
      group by id_client, code_eqp, id_fider order by id_client, code_eqp) as p \
     join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
     left join \
     ( select id_point, sum(demand_val) as bill_demand, sum(sum_val) as bill_sum \
       from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
       group by id_point order by id_point \
     ) as bs on (bs.id_point = p.id_point ) \
     group by p.id_fider order by p.id_fider \
   ) as ssum on (ssum.id_fider = pf.id_fider) \
   where  (pf.id_fider = :fider or :fider is null ) and ( :insp is null or ff.id_position = :insp) \
   order by cp.represent_name, pf.name;  ";

  ZQXLRepsSum->Sql->Add( sqlstr1 );

  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  // Группы потребителей
  AnsiString  sqlstr3=" select sum(p.demand) as demand,   \
   sum(case when gt.demand = 0 then 0 else round(bs.bill_sum * p.demand /gt.demand,2) end ) as sum_val, \
   cla.id, cla.name as grp_name, cla.sort, (text(p.id_fider)||'|'||text(cla.id))::::varchar as link, p.id_fider as link2  \
   from \
   (select id_client, code_eqp as id_point , id_fider, sum(demand) as demand  \
    from bal_grp_tree_conn_tbl where type_eqp = 12 and mmgg = :mmgg \
    group by id_client, code_eqp, id_fider order by id_client, code_eqp) as p \
   join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
   left join \
   ( select id_point, sum(demand_val) as bill_demand, sum(sum_val) as bill_sum \
     from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
     group by id_point order by id_point \
   ) as bs on (bs.id_point = p.id_point ) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= p.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where (p.id_fider = :fider or :fider is null )  \
   group by cla.id, cla.name, cla.sort, p.id_fider \
   order by cla.sort; ";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);

  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLRepsSum2->ParamByName("fider")->AsInteger=FiderId;

  // расшифровка
  AnsiString  sqlstr2=" select p.*,cc.code, \
   CASE WHEN acc.fiz_count is not null THEN cc.short_name||'('||text(acc.fiz_count)||')' ELSE cc.short_name END::::varchar as short_name, \
   cla.name as grp_name, p.name as point , round(bs.bill_sum * p.demand /gt.demand,2) as sum_val , \
   p.id_fider as link2, (text(p.id_fider)||'|'||text(cla.id))::::varchar as link \
   from \
   (select id_client, code_eqp as id_point, name, id_fider, sum(demand) as demand \
    from bal_grp_tree_conn_tbl where type_eqp = 12 and mmgg = :mmgg \
    group by id_client, code_eqp, name, id_fider order by id_client, code_eqp) as p \
   join bal_acc_tbl as acc on (acc.code_eqp = p.id_point and acc.mmgg = :mmgg ) \
   join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
   left join \
   ( select id_point, sum(demand_val) as bill_demand, sum(sum_val) as bill_sum \
     from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
     group by id_point order by id_point \
   ) as bs on (bs.id_point = p.id_point ) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= p.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where (p.id_fider = :fider or :fider is null ) and coalesce(p.demand,0) <>0 \
   order by cla.sort, cc.code; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr2);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (FiderId!=0)
    ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  
  ZQXLRepsSum2->MasterSource=DSRep;
  ZQXLRepsSum2->LinkFields="link2 = link2";

  ZQXLReps->MasterSource=DSRep2;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLRepsSum->Open();
  ZQXLRepsSum2->Open();
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias = "ZQXLRepsSum2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "На "+FormatDateTime("mmmm yyyy",dtBegin->Date);

/*  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";
  caption =caption+ edFiderName->Text;
  xlReport->ParamByName["caption"]->Value = caption;
*/
  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";



 ZQXLReps->Close();
 ZQXLRepsSum2->Close();
 ZQXLRepsSum->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
 ZQXLRepsSum2->MasterSource=NULL;
 ZQXLRepsSum2->LinkFields="";

}
//------------------------------------------------------------------------------

void TfReports::PrintPrognozFiders_WithFact(TDateTime mmgg, boolean Build)
{
  AnsiString sqlstr;
  if (Build)
  {

  if(MessageDlg("Переформировать данные прогноза?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    sqlstr="select bal_prognoz_calc_fun(:mmgg);";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  sqlstr="select * from bal_prognoz_basics_tbl where mmgg = :mmgg ;";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  int res_demand = ZQReps->FieldByName("res_demand")->AsInteger;
  int losts_1kl = ZQReps->FieldByName("losts_1kl")->AsInteger;
  int losts_2kl = ZQReps->FieldByName("losts_2kl")->AsInteger;
  int res_demand_fact = ZQReps->FieldByName("res_demand_fact")->AsInteger;
  int losts_1kl_fact = ZQReps->FieldByName("losts_1kl_fact")->AsInteger;
  int losts_2kl_fact = ZQReps->FieldByName("losts_2kl_fact")->AsInteger;

  ZQReps->Close();
   //расчет среднего тарифа населения за текущий период
  sqlstr="  select sum(nar_v) as snar_v, sum(nar_pdv) as snar_n , sum(nar) as snar, \
  round(sum(nar_v)/sum(nar),4) as tarif \
  from seb_obr_all_tbl as obr join clm_client_tbl as c on (c.id = obr.id_client) \
  where obr.period = :mmgg and obr.id_pref = 10 and obr.idk_work not in (0,99) and obr.roz =9; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  float abon_tarif = ZQReps->FieldByName("tarif")->AsFloat;

  ZQReps->Close();

   //суммарные потери за текущий период
  sqlstr=" select sum(bg.losts) as losts_all from bal_grp_tree_conn_tbl as bg join eqm_fider_tbl as f2 on (f2.code_eqp = bg.code_eqp) \
  where bg.type_eqp = 15 and bg.mmgg = :mmgg and coalesce(f2.balans_only,0)= 0  ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  int losts_all = ZQReps->FieldByName("losts_all")->AsInteger;


  ZQReps->Close();
   // общее поступление по всем фидерам
  sqlstr="  select sum(ktr_demand) as demand \
   from bal_grp_tree_tbl as b \
   join bal_demand_tbl as bd  on (bd.id_point=b.id_point ) \
   join eqm_fider_tbl as f on (f.code_eqp = b.code_eqp) \
   where  bd.mmgg = :mmgg and b.mmgg = :mmgg  and type_eqp = 15 and coalesce(f.balans_only,0)= 0 ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  int fider_demand = ZQReps->FieldByName("demand")->AsInteger;

  ZQReps->Close();

  ZQXLRepsSum->Sql->Clear();
  AnsiString sqlstr1;
  // фидера
  sqlstr1 =" select sss.*, cp.represent_name, sss.id_fider as link2 \
 from \
 ( select  coalesce(ss_prognoz.id_fider, ss_fact.id_fider) as id_fider, \
    coalesce(ss_prognoz.name_eqp, ss_fact.name) as name_eqp, ss_prognoz.res_demand_prognoz,ss_prognoz.losts_prognoz, \
    ss_prognoz.abon_demand_prognoz, ss_prognoz.abon_sum_prognoz, \
    ss_fact.res_demand, ss_fact.fact_losts, ss_fact.demand, ss_fact.sum_val \
   from \
  ( select pf.*,eq.name_eqp   \
   from bal_prognoz_fiders_tbl as pf \
   join eqm_equipment_tbl as eq on (eq.id = pf.id_fider) \
   where pf.mmgg = :mmgg \
   ) as ss_prognoz \
   full outer join \
   ( \
   select pf.*, bd.ktr_demand as res_demand, pf.losts*(pb.losts_2kl_fact+pb.losts_1kl_fact-(pb.res_demand_fact- :fider_demand ))/:losts_all as fact_losts, ssum.sum_val \
   from \
   (select b.code_eqp as id_fider, b.name, b.id_point, sum(b.demand) as demand, sum(b.losts) as losts \
    from bal_grp_tree_conn_tbl as b \
    join eqm_fider_tbl as f on (f.code_eqp = b.code_eqp) \
    where b.type_eqp = 15 and b.mmgg = :mmgg and coalesce(f.balans_only,0)= 0 \
    group by  b.code_eqp, b.name, b.id_point order by b.code_eqp ) as pf \
   left join bal_demand_tbl as bd  on (bd.id_point=pf.id_point and bd.mmgg = :mmgg) \
   left join \
   ( select p.id_fider, sum(CASE WHEN p.id_client = -1 THEN p.demand* :abontarif ELSE case when gt.demand = 0 then 0 else round(bs.bill_sum * p.demand /gt.demand,2) end END) as sum_val \
     from \
     (select id_client, code_eqp as id_point , id_fider, sum(demand) as demand  \
      from bal_grp_tree_conn_tbl where type_eqp = 12 and mmgg = :mmgg \
      group by id_client, code_eqp, id_fider order by id_client, code_eqp) as p \
     join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
     left join \
     ( select id_point, sum(demand_val) as bill_demand, sum(sum_val)*1.2 as bill_sum \
       from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
       group by id_point order by id_point \
     ) as bs on (bs.id_point = p.id_point ) \
     group by p.id_fider order by p.id_fider \
   ) as ssum on (ssum.id_fider = pf.id_fider) \
   ,(select losts_2kl_fact,losts_1kl_fact,res_demand_fact from bal_prognoz_basics_tbl where mmgg = :mmgg ) as pb \
   ) as ss_fact on (ss_prognoz.id_fider = ss_fact.id_fider ) \
  ) as sss \
  join eqm_fider_tbl as ff on (ff.code_eqp = sss.id_fider) \
  left join clm_position_tbl as cp on (cp.id = ff.id_position) \
  where (sss.id_fider = :fider or :fider is null ) and  ( :insp is null or ff.id_position = :insp) \
   order by cp.represent_name, sss.name_eqp;  ";

  ZQXLRepsSum->Sql->Add( sqlstr1 );

  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum->ParamByName("abontarif")->AsFloat=abon_tarif;
  ZQXLRepsSum->ParamByName("fider_demand")->AsInteger=fider_demand;
  ZQXLRepsSum->ParamByName("losts_all")->AsInteger=losts_all;

  if (FiderId!=0)
    ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;

  if (InspectorId!=0)
     ZQXLRepsSum->ParamByName("insp")->AsInteger=InspectorId;

  // Группы потребителей
  AnsiString  sqlstr3=" select demand_prognoz, sum_prognoz, demand, sum_val, coalesce(ss_prognoz.grp_name,ss_fact.grp_name) as grp_name, \
  coalesce(ss_prognoz.sort,ss_fact.sort) as sort ,   coalesce(ss_prognoz.link,ss_fact.link) as link, \
  coalesce(ss_prognoz.link2,ss_fact.link2) as link2 \
   from \
  ( \
  select sum(demand_prognoz) as demand_prognoz, sum(sum_prognoz) as sum_prognoz, \
   cla.id, cla.name as grp_name, cla.sort, (text(p.id_fider)||'|'||text(cla.id))::::varchar as link, p.id_fider as link2  \
   from bal_prognoz_points_tbl as pp \
   join bal_points_all_tbl as p on (p.id_point = pp.id_point) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= pp.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where pp.mmgg = :mmgg and p.dat = :mmgg   and (p.id_fider = :fider or :fider is null )  \
   group by cla.id, cla.name, cla.sort, p.id_fider \
  ) as  ss_prognoz \
  full outer join \
  ( \
   select sum(p.demand) as demand, sum(CASE WHEN p.id_client = -1 THEN p.demand* :abontarif ELSE case when gt.demand = 0 then 0 else round(bs.bill_sum * p.demand /gt.demand,2) end END ) as sum_val, \
   cla.id, cla.name as grp_name, cla.sort, (text(p.id_fider)||'|'||text(cla.id))::::varchar as link, p.id_fider as link2  \
   from \
   (select b.id_client, b.code_eqp as id_point , b.id_fider, sum(b.demand) as demand  \
    from bal_grp_tree_conn_tbl as b \
    where b.type_eqp = 12 and b.mmgg = :mmgg \
    group by b.id_client, b.code_eqp, b.id_fider order by b.id_client, b.code_eqp) as p \
   join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
   left join \
   ( select id_point, sum(demand_val) as bill_demand, sum(sum_val)*1.2 as bill_sum \
     from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
     group by id_point order by id_point \
   ) as bs on (bs.id_point = p.id_point ) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= p.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where (p.id_fider = :fider or :fider is null )  \
   group by cla.id, cla.name, cla.sort, p.id_fider \
  ) as ss_fact on (ss_prognoz.link = ss_fact.link ) and (ss_prognoz.id = ss_fact.id ) \
  order by link2, sort; ";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);

  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum2->ParamByName("abontarif")->AsFloat=abon_tarif ;

  if (FiderId!=0)
    ZQXLRepsSum2->ParamByName("fider")->AsInteger=FiderId;

  // расшифровка
  AnsiString  sqlstr2="  select sss.*, CASE WHEN fiz_count is not null THEN cc.short_name||'('||text(fiz_count)||')' ELSE cc.short_name END::::varchar as short_name, \
  cla.name as grp_name, cc.code, (text(id_fider)||'|'||text(cla.id))::::varchar as link , id_fider as link2 \
  from \
 ( select coalesce(ss_prognoz.id_point,ss_fact.id_point) as id_point, coalesce(ss_prognoz.point,ss_fact.point) as point, \
   demand_prognoz, sum_prognoz, demand, sum_val,  coalesce(ss_prognoz.id_fider,ss_fact.id_fider) as id_fider, \
   coalesce(ss_prognoz.id_client,ss_fact.id_client) as id_client , coalesce(ss_prognoz.fiz_count,ss_fact.fiz_count) as fiz_count \
  from \
  ( \
  select pp.*,p.fiz_count, eq2.name_eqp as point , p.id_fider  \
   from bal_prognoz_points_tbl as pp \
   join bal_points_all_tbl as p on (p.id_point = pp.id_point) \
   left join \
   ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
     (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
   ) as eq2  on (p.id_point=eq2.id) \
   where pp.mmgg = :mmgg and p.dat = :mmgg and (p.id_fider = :fider or :fider is null )  and coalesce(demand_prognoz,0) <>0 \
   order by pp.id_point, p.id_fider \
   ) as ss_prognoz  \
   full outer join \
   (  select p.*, acc.fiz_count,p.name as point , CASE WHEN p.id_client = -1 THEN p.demand* :abontarif ELSE round(bs.bill_sum * p.demand /gt.demand,2) END as sum_val  \
   from \
   (select id_client, code_eqp as id_point, name, id_fider, sum(demand) as demand \
    from bal_grp_tree_conn_tbl where type_eqp = 12 and mmgg = :mmgg \
    group by id_client, code_eqp, name, id_fider order by id_client, code_eqp) as p \
   join bal_acc_tbl as acc on (acc.code_eqp = p.id_point and acc.mmgg = :mmgg ) \
   join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
   left join \
   ( select id_point, sum(demand_val) as bill_demand, sum(sum_val)*1.2 as bill_sum \
     from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
     group by id_point order by id_point \
   ) as bs on (bs.id_point = p.id_point ) \
   where (p.id_fider = :fider or :fider is null ) and coalesce(p.demand,0) <>0 \
   ) as ss_fact on (ss_prognoz.id_point = ss_fact.id_point ) and (ss_prognoz.id_fider = ss_fact.id_fider) \
  ) as sss \
 left join \
  (select c.id, c.code, c.short_name, sc.id_section \
   from clm_client_tbl as c \
   left join clm_statecl_h as sc on (c.id = sc.id_client) \
   where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
   union \
   select -1,0, 'Населення', 205 \
  ) as cc on (cc.id= sss.id_client) \
 left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
 order by cla.sort, cc.code; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr2);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("abontarif")->AsFloat=abon_tarif;

  if (FiderId!=0)
    ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

//  coalesce(ss_fact.fiz_count,ss_prognoz.fiz_count) as fiz_count,   coalesce(ss_fact.point_count,ss_prognoz.point_count) as point_count \
//  ss_prognoz.fiz_count, ss_prognoz.point_count \

  // Итоговый лист по группам потребителей
  AnsiString  sqlstr5="  select cp.represent_name, sss.grp_name,sss.sort,  sum(demand_prognoz) as demand_prognoz, sum(sum_prognoz) as sum_prognoz, \
  sum(demand) as demand, sum(sum_val) as sum_val, sum(fiz_count) as fiz_count, sum(point_count) as point_count \
  from ( \
  select demand_prognoz, sum_prognoz, demand, sum_val, coalesce(ss_prognoz.grp_name,ss_fact.grp_name) as grp_name, coalesce(ss_prognoz.sort,ss_fact.sort) as sort ,\
  coalesce(ss_prognoz.id_fider,ss_fact.id_fider) as id_fider, coalesce(ss_prognoz.id,ss_fact.id) as id_grp, \
 coalesce(ss_prognoz.fiz_count,ss_fact.fiz_count) as fiz_count,   coalesce(ss_prognoz.point_count,ss_fact.point_count) as point_count \
   from \
  ( \
  select sum(demand_prognoz) as demand_prognoz, sum(sum_prognoz) as sum_prognoz, sum(p.fiz_count) as fiz_count,count(distinct p.id_point) as point_count, \
   cla.id, cla.name as grp_name, cla.sort, p.id_fider  \
   from bal_prognoz_points_tbl as pp \
   join bal_points_all_tbl as p on (p.id_point = pp.id_point) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= pp.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where pp.mmgg = :mmgg and p.dat = :mmgg   and (p.id_fider = :fider or :fider is null )  and coalesce(demand_prognoz,0) <>0 \
   group by cla.id, cla.name, cla.sort, p.id_fider \
  ) as  ss_prognoz \
  full outer join \
  ( \
   select sum(acc.fiz_count) as fiz_count, count(distinct p.id_point) as point_count, sum(p.demand) as demand, sum(CASE WHEN p.id_client = -1 THEN p.demand* :abontarif ELSE case when gt.demand = 0 then 0 else round(bs.bill_sum * p.demand /gt.demand,2) end END ) as sum_val, \
   cla.id, cla.name as grp_name, cla.sort, p.id_fider   \
   from \
   (select b.id_client, b.code_eqp as id_point , b.id_fider, sum(b.demand) as demand  \
    from bal_grp_tree_conn_tbl as b \
    where b.type_eqp = 12 and b.mmgg = :mmgg \
    group by b.id_client, b.code_eqp, b.id_fider order by b.id_client, b.code_eqp) as p \
   join bal_acc_tbl as acc on (acc.code_eqp = p.id_point and acc.mmgg = :mmgg ) \
   join bal_grp_tree_tbl as gt on (gt.code_eqp = p.id_point and gt.mmgg = :mmgg ) \
   left join \
   ( select id_point, sum(demand_val) as bill_demand, sum(sum_val)*1.2 as bill_sum \
     from acd_billsum_tbl where kind_energy = 1 and mmgg = :mmgg \
     group by id_point order by id_point \
   ) as bs on (bs.id_point = p.id_point ) \
   left join \
    (select c.id, c.code, c.short_name, sc.id_section \
     from clm_client_tbl as c \
     left join clm_statecl_h as sc on (c.id = sc.id_client) \
     where sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
     union \
     select -1,0, 'Населення', 205 \
    ) as cc on (cc.id= p.id_client) \
   left join cla_param_tbl as cla on (cc.id_section = cla.id and cla.id_group = 200) \
   where (p.id_fider = :fider or :fider is null ) and coalesce(p.demand,0) <>0  \
   group by cla.id, cla.name, cla.sort, p.id_fider \
  ) as ss_fact on ((ss_prognoz.id_fider = ss_fact.id_fider ) and (ss_prognoz.id = ss_fact.id )) \
) as sss \
  join eqm_fider_tbl as ff on (ff.code_eqp = sss.id_fider) \
  left join clm_position_tbl as cp on (cp.id = ff.id_position) \
 group by represent_name, grp_name,sort \
 order by  represent_name, sort; ";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr5);

  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps2->ParamByName("abontarif")->AsFloat=abon_tarif ;

  if (FiderId!=0)
    ZQXLReps2->ParamByName("fider")->AsInteger=FiderId;


  ZQXLRepsSum2->MasterSource=DSRep;
  ZQXLRepsSum2->LinkFields="link2 = link2";

  ZQXLReps->MasterSource=DSRep2;
  ZQXLReps->LinkFields="link = link";

  try
  {
  ZQXLRepsSum->Open();
  ZQXLRepsSum2->Open();
  ZQXLReps->Open();
  ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->Alias =  "ZQXLRepsSumB";
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Range = "GroupRange2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias = "ZQXLRepsSum2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLRepsGrp";
  Dsr->Range = "Range3";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lres_demand";
  Param=xlReport->Params->Add();
  Param->Name="losts_1kl";
  Param=xlReport->Params->Add();
  Param->Name="losts_2kl";
  Param=xlReport->Params->Add();
  Param->Name="lres_demand_fact ";
  Param=xlReport->Params->Add();
  Param->Name="losts_1kl_fact";
  Param=xlReport->Params->Add();
  Param->Name="losts_2kl_fact";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "На "+FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->ParamByName["lres_demand"]->Value = IntToStr(res_demand);
  xlReport->ParamByName["losts_1kl"]->Value = IntToStr(losts_1kl);
  xlReport->ParamByName["losts_2kl"]->Value = IntToStr(losts_2kl);
  xlReport->ParamByName["lres_demand_fact"]->Value = IntToStr(res_demand_fact);
  xlReport->ParamByName["losts_1kl_fact"]->Value = IntToStr(losts_1kl_fact);
  xlReport->ParamByName["losts_2kl_fact"]->Value = IntToStr(losts_2kl_fact);

/*  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";
  caption =caption+ edFiderName->Text;
  xlReport->ParamByName["caption"]->Value = caption;
*/
  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";



 ZQXLReps->Close();
 ZQXLRepsSum2->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();


 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
 ZQXLRepsSum2->MasterSource=NULL;
 ZQXLRepsSum2->LinkFields="";

}
//------------------------------------------------------------------------------

void TfReports::PrintAbonFidersDemand(TDateTime dtb,TDateTime dte, int client,  boolean Build)
{
  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
  demand_1, demand_2, demand_3, demand_12, date_indic,  \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

  sqlstr1 = sqlstr1 +"  select c.id as id_client, c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power,p.wtm, \
  adv.adr, cp.represent_name, id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) ";

//    join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg::::date)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg::::date)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg::::date)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg::::date)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_1, sum(sum_val) as sum_1, max(CASE WHEN b.idk_doc =200 THEN b.dat_e ELSE null END ) as date_indic \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref in ( 10,11) and b.idk_doc<>280 and b.dat_e >= :dtb and b.dat_e <= :dte group by bs.id_point  order by bs.id_point \
  ) as b1 on (b1.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_2, sum(sum_val) as sum_2 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref in ( 10,11) and b.idk_doc<>280 and b.mmgg+'1 month'::::interval = date_trunc('month',:mmgg::::date) group by bs.id_point order by bs.id_point \
  ) as b2 on (b2.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_3, sum(sum_val) as sum_3 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref in ( 10,11)  and b.idk_doc<>280  and b.mmgg+'2 month'::::interval = date_trunc('month',:mmgg::::date) group by bs.id_point order by bs.id_point\
  ) as b3 on (b3.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_12, sum(sum_val) as sum_12 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref in ( 10,11)  and b.idk_doc<>280 and b.mmgg+'12 month'::::interval = date_trunc('month',:mmgg::::date) group by bs.id_point order by bs.id_point \
  ) as b12 on (b12.id_point = ssss.id_point) \
    where coalesce(b1.demand_1,0)<>0 and ((( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
     and (ssss.id_client = :client) or ( :client = 0 ))  order by name_ps35, name_f10, name_ps10 ;" ;



  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("client")->AsInteger=client;

  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;

  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = "За "+FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lmmgg"]->Value = "За "+FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  xlReport->Report();

 ZQXLReps->Close();


}
//------------------------------------------------------------------------------
void TfReports::PrintMeterChanges(TDateTime dtb,TDateTime dte, int id_client)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1="select sss1.*, eq.name_eqp, adr.adr, e.name as energy,z.name as zone, id_doc as link, m1.type , m2.type as type2 ,  c.code, c.short_name \
  from \
 ( select id_client, id_doc, id_meter, id_point, kind_energy, id_zone , ss1.num_eqp, ss1.id_typemet, ss1.value, ss1.prev_value  , ss1.coef_comp, \
     ss2.num_eqp as num_eqp2, ss2.id_typemet as id_typemet2, ss2.value as value2, ss2.coef_comp as coef_comp2 , coalesce(ss1.date_end,ss2.date_end) as date_end, \
     ss1.dt_control, ss2.dt_control as dt_control2 \
     from \
(  select distinct i.id_doc,i.id_client, i.date_end,dind.id_meter, mp.id_point, dind.id_previndic, dind.num_eqp, dind.id_typemet,dind.kind_energy, dind.id_zone, dind.value, prind.value as prev_value , dind.coef_comp, mm.dt_control \
  from acm_headindication_tbl as i \
  join dci_document_tbl as dk on (i.idk_document = dk.id) \
  join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  left join eqm_meter_h as mm on (mm.code_eqp = dind.id_meter and mm.dt_b<i.reg_date and coalesce(mm.dt_e,i.reg_date) >= i.reg_date) \
  left join eqm_equipment_h as eq on (eq.id = dind.id_meter and eq.num_eqp  = dind.num_eqp and eq.dt_e = i.date_end) \
  left join acd_indication_tbl as prind on (prind.id = dind.id_previndic) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and (dind.id_previndic is not null or eq.id is not null ) \
) as ss1 \
full outer join \
(  select distinct i.id_doc,i.id_client , i.date_end ,dind.id_meter, mp.id_point, dind.num_eqp, dind.id_typemet, dind.kind_energy, dind.id_zone, dind.value, dind.coef_comp, mm.dt_control  \
  from acm_headindication_tbl as i \
  join dci_document_tbl as dk on (i.idk_document = dk.id) \
  join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  join eqm_equipment_h as eq on (eq.id = dind.id_meter and eq.num_eqp  = dind.num_eqp and eq.dt_b = i.date_end) \
  left join eqm_meter_h as mm on (mm.code_eqp = dind.id_meter and mm.dt_b<=i.reg_date and (mm.dt_e > i.reg_date or mm.dt_e is null)) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and dind.id_previndic is null \
) as ss2 \
 using(id_client,id_doc, id_meter, id_point, kind_energy, id_zone) \
) as sss1 \
join eqm_equipment_h as eq on ( eq.id  = sss1.id_point ) \
join eqk_energy_tbl as e on (e.id = kind_energy) \
join eqk_zone_tbl as z on (z.id = id_zone) \
join clm_client_tbl as c on (c.id = sss1.id_client) \
left join adv_address_tbl as adr on ( adr.id  = eq.id_addres ) \
left join eqi_meter_tbl as m1 on (m1.id = id_typemet) \
left join eqi_meter_tbl as m2 on (m2.id = id_typemet2)\
where eq.dt_b = (select max(dt_b) from eqm_equipment_h where id = eq.id and dt_b < date_end  ) \
  and (c.id = :client or :client = 0) \
order by c.code, date_end, id_point, id_meter ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("client")->AsInteger=id_client;

  AnsiString  sqlstr3=" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select mainss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from \
( \
  select sss1.*, eq.name_eqp, adr.adr, e.name as energy,z.name as zone, m1.type , m2.type as type2 ,  c.code, c.short_name \
  from \
 ( select id_client, id_doc, id_meter, id_point, kind_energy, id_zone , ss1.num_eqp, ss1.id_typemet, ss1.value, ss1.prev_value  , ss1.coef_comp, \
     ss2.num_eqp as num_eqp2, ss2.id_typemet as id_typemet2, ss2.value as value2, ss2.coef_comp as coef_comp2 , coalesce(ss1.date_end,ss2.date_end) as date_end, \
     ss1.dt_control, ss2.dt_control as dt_control2 \
     from \
(  select distinct i.id_doc,i.id_client, i.date_end,dind.id_meter, mp.id_point, dind.id_previndic, dind.num_eqp, dind.id_typemet,dind.kind_energy, dind.id_zone, dind.value, prind.value as prev_value , dind.coef_comp, mm.dt_control \
  from acm_headindication_tbl as i \
  join dci_document_tbl as dk on (i.idk_document = dk.id) \
  join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  left join eqm_meter_h as mm on (mm.code_eqp = dind.id_meter and mm.dt_b<i.reg_date and coalesce(mm.dt_e,i.reg_date) >= i.reg_date) \
  left join acd_indication_tbl as prind on (prind.id = dind.id_previndic) \
  left join eqm_equipment_h as eq on (eq.id = dind.id_meter and eq.num_eqp  = dind.num_eqp and eq.dt_e = i.date_end) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and (dind.id_previndic is not null or eq.id is not null ) \
) as ss1 \
full outer join \
(  select distinct i.id_doc,i.id_client , i.date_end ,dind.id_meter, mp.id_point, dind.num_eqp, dind.id_typemet, dind.kind_energy, dind.id_zone, dind.value, dind.coef_comp, mm.dt_control  \
  from acm_headindication_tbl as i \
  join dci_document_tbl as dk on (i.idk_document = dk.id) \
  join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  join eqm_equipment_h as eq on (eq.id = dind.id_meter and eq.num_eqp  = dind.num_eqp and eq.dt_b = i.date_end) \
  left join eqm_meter_h as mm on (mm.code_eqp = dind.id_meter and mm.dt_b<=i.reg_date and (mm.dt_e > i.reg_date or mm.dt_e is null)) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and dind.id_previndic is null \
) as ss2 \
 using(id_client,id_doc, id_meter, id_point, kind_energy, id_zone) \
) as sss1 \
join eqm_equipment_h as eq on ( eq.id  = sss1.id_point ) \
join eqk_energy_tbl as e on (e.id = kind_energy) \
join eqk_zone_tbl as z on (z.id = id_zone) \
join clm_client_tbl as c on (c.id = sss1.id_client) \
left join adv_address_tbl as adr on ( adr.id  = eq.id_addres ) \
left join eqi_meter_tbl as m1 on (m1.id = id_typemet) \
left join eqi_meter_tbl as m2 on (m2.id = id_typemet2)\
where eq.dt_b = (select max(dt_b) from eqm_equipment_h where id = eq.id and dt_b < date_end  ) \
  and (c.id = :client or :client = 0) \
) as mainss \
  left join bal_abons_tbl as ba on (ba.id_point = mainss.id_point) \
  left join eqm_equipment_tbl as ee on (ee.id = ba.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = ba.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by code, date_end, id_point, id_meter ; ";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr3);
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps2->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps2->ParamByName("client")->AsInteger=id_client;


  // документы
  AnsiString  sqlstr2=" select distinct i.id_doc as link,i.id_client , c.code, c.short_name, i.reg_date, i.reg_num, i.date_end \
  from acm_headindication_tbl as i \
  join clm_client_tbl as c on (c.id = i.id_client) \
  left join dci_document_tbl as dk on (i.idk_document = dk.id) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte \
  and (i.id_client = :client or :client = 0) \
  order by code, date_end  ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLRepsSum->ParamByName("dte")->AsDateTime=dte;
  ZQXLRepsSum->ParamByName("client")->AsInteger=id_client;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps1";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
    FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::GraficWork_fiders(TDateTime mmgg, int work_type,boolean Build)
{

//  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;
  AnsiString sqlstr;
  if (Build)
  {

   if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }


   if(MessageDlg("Переформировать план работ? ", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    if (work_type ==1)
    {
      sqlstr="select rep_work_grafic_build(:mmgg, null,1) ;";
    }

    if (work_type ==2)
    {
      sqlstr="select rep_work_grafic_build(:mmgg, null,2); \
                        select rep_work_grafic_build((:mmgg::::date+'6 month'::::interval)::::date,null,2);  ";
    }

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, ";
  if (work_type ==1)
  {
//    sqlstr1 = sqlstr1 + "     ww.dt_work,ww.comment, (ww.dt_work + '3 year'::::interval)::::date as dt_next,   ";
    sqlstr1 = sqlstr1 + "     ww.dt_work,ww.comment,  plan1.date_work ::::date as dt_next, ";

  }
  if (work_type ==2)
  {
//    sqlstr1 = sqlstr1 + "     ww.dt_work,ww.comment, (ww.dt_work + '6 month'::::interval)::::date as dt_next, \
//       (ww.dt_work + '12 month'::::interval)::::date as dt_next2,      ";

    sqlstr1 = sqlstr1 + "     ww.dt_work,ww.comment, \
    plan1.date_work ::::date as dt_next, plan2.date_work ::::date as dt_next2,  ";

  }

  sqlstr1 = sqlstr1 + " \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select c.code,c.name,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type, im.carry, m.dt_control, m.warm ,ph.name as phase, km.name as kind, cp.represent_name,stt.tt_type, p.id_position, id_grp as link, \
  mr.num_meter_r, mr.type_r, mr.carry_r, mr.dt_control_r, mr.warm_r, \
  mrg.num_meter_g, mrg.type_g, mrg.carry_g, mrg.dt_control_g, mrg.warm_g, \
  stu.tu_type,stu.accuracy_u, stu.voltage_nom ,stt.amperage_nom ,stt.date_check_i,stu.date_check_u \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  left join \
  (select mp.id_point,eq.num_eqp as num_meter_r, im.type as type_r, im.carry as carry_r, m.dt_control as dt_control_r, m.warm as warm_r \
    from eqm_meter_point_h as mp \
    join eqm_meter_tbl as m on (m.code_eqp = mp.id_meter) \
    join eqm_equipment_tbl as eq on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqd_meter_energy_tbl as me on (me.code_eqp = mp.id_meter) \
    where me.kind_energy = 2 and mp.dt_e is null \
  ) as mr on (mr.id_point = ba.id_point) \
  left join \
  (select mp.id_point,eq.num_eqp as num_meter_g, im.type as type_g, im.carry as carry_g, m.dt_control as dt_control_g, m.warm as warm_g \
    from eqm_meter_point_h as mp \
    join eqm_meter_tbl as m on (m.code_eqp = mp.id_meter) \
    join eqm_equipment_tbl as eq on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqd_meter_energy_tbl as me on (me.code_eqp = mp.id_meter) \
    where me.kind_energy = 4 and mp.dt_e is null \
  ) as mrg on (mrg.id_point = ba.id_point) \
  left join \
   ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
   ic.type as tt_type,ic.accuracy as accuracy_i, ic.amperage_nom,c.date_check as date_check_i from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  left join \
   ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
    ic.type as tu_type,ic.accuracy as accuracy_u, ic.voltage_nom,c.date_check as date_check_u from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 2 order by id_meter \
) as stu on (stu.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) ";

  //left join clm_statecl_tbl as sc on (c.id = sc.id_client)

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  ( select w.id_point,w.dt_work,w.comment from clm_works_tbl as w \
    join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = :type group by id_client, id_point) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
    where w.id_type = :type \
  ) as ww on (ww.id_point = ssss.id_point) ";

  if (work_type ==1)
  {
    sqlstr1 = sqlstr1 +" \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >=:mmgg and date_work < ( :mmgg::::date + '3 year'::::interval )::::date \
    ) as plan1 on  (plan1.id_point = ssss.id_point) ";
  }

  if (work_type ==2)
  {
    sqlstr1 = sqlstr1 +" \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >=:mmgg and date_work < ( :mmgg::::date + '6 month'::::interval )::::date \
    ) as plan1 on  (plan1.id_point = ssss.id_point) \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >= ( :mmgg::::date + '6 month'::::interval )::::date and date_work < ( :mmgg::::date + '12 month'::::interval )::::date \
    ) as plan2 on  (plan2.id_point = ssss.id_point) ";
  }
  sqlstr1 = sqlstr1 +" \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
  and ( :insp is null or ssss.id_position = :insp) \
  order by code " ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("type")->AsInteger=work_type;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
//  Param=xlReport->Params->Add();
//  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yy",dtBegin->Date);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  /*
  AnsiString caption = "Підключення абонентів до мереж РЕМ. ";

  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
 // if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;
    */
  xlReport->Report();


 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::Print_Indic_History(TDateTime dtb,TDateTime dte, int id_client, boolean Build)
{


  if (Build)
  {

//  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  rep_meter_indic_hist_fun( :dtb, :dte ) ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("dtb")->AsDateTime=dtb;
    ZQReps->ParamByName("dte")->AsDateTime=dte;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLRepsSum->Close();
  ZQXLRepsSum->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select ind.id_client, c.code,c.short_name, ind.id_point, ind.id_meter, eq.name_eqp, ind.num_eqp as num_meter, ind.kind_energy, z1,z2,z3, \
  adv.adr, im.type, ph.name as phase, km.name as kind, id_grp , en.name as energy_name , zone1.name as zn1, zone2.name as zn2, zone3.name as zn3, \
  (text(ind.id_meter)||text(ind.num_eqp)||text(ind.kind_energy))::::varchar as link \
  from \
  ( select id_client, id_point , id_meter, num_eqp,kind_energy, max(zone1)as z1, max(zone2) as z2, max(zone3) as z3 \
      FROM rep_meter_indic_hist_tmp \
      where id_client = :client or :client = 0 \
      GROUP BY id_client, id_point , id_meter, num_eqp,kind_energy order by id_point \
  ) as ind \
  join bal_abons_tbl as ba on (ba.id_point = ind.id_point) \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ind.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ind.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ind.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join eqk_energy_tbl as en on (en.id = ind.kind_energy) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join eqk_zone_tbl as zone1 on (zone1.id = ind.z1 ) \
  left join eqk_zone_tbl as zone2 on (zone2.id = ind.z2 ) \
  left join eqk_zone_tbl as zone3 on (zone3.id = ind.z3 ) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) ";

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by code " ;

  ZQXLRepsSum->Sql->Add( sqlstr1 );
  ZQXLRepsSum->ParamByName("client")->AsInteger=id_client;
//  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  AnsiString sqlstr2 =" select sum(value1) as value1 ,sum(value2) as value2, sum(value3) as value3, \
   id_meter, num_eqp,kind_energy, work_type, work_name,id_doc,h.id_position, reg_date, cp.represent_name , \
    (text(id_meter)||text(num_eqp)||text(kind_energy))::::varchar as link \
    FROM rep_meter_indic_hist_tmp  as h \
    left join clm_position_tbl as cp on (cp.id = h.id_position) \
    WHERE h.id_client = :client or :client = 0 \
    GROUP BY id_meter, num_eqp,kind_energy,work_type, work_name,id_doc,h.id_position, reg_date , cp.represent_name \
    order by reg_date ;  " ;

  ZQXLReps->Close();
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add( sqlstr2 );
  ZQXLReps->ParamByName("client")->AsInteger=id_client;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
   ZQXLRepsSum->Open();
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias = "ZQXLRepsH";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsH";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  AnsiString caption = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date) ;


  if (id_client!=0) caption =caption +"  " + edAbonName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//-----------------------------------------------------------------------------
void TfReports::PrintAbonCountMonitor(TDateTime mmgg, boolean Build)
{

  if (Build)
  {

  if(MessageDlg("Переформировать данные ? ", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  rep_abon_count_volt_fun( :mmgg );";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select * from rep_count_volt_tbl where mmgg = :mmgg;" ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
//  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = " Станом на "+FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::Monitor_PS_2010(TDateTime dtb, boolean Build)
{

 if (Build)
 {
  AnsiString sqlstr="select rep_abon_count_volt_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
   sqlstr="select bal_points_find_fun( :dt );";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("dt")->AsDateTime=dtb;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
 }

  AnsiString sqlstr=" select code_f10 as link, code_ps10,name_ps10, sum_power, \
    CASE WHEN is_town_ps = true then 'Місто' ELSE 'Село' END as is_townstr, \
    sum(case when id_client<>-1 and coalesce(is_town,false) =true and volt = 0.4 then 1 else 0 end) as cnt_town04, \
    sum(case when id_client<>-1 and coalesce(is_town,false) =false and volt = 0.4 then 1 else 0 end) as cnt_vill04, \
    sum(case when id_client<>-1 and coalesce(is_town,false) =true and volt > 0.4 and volt < 20 then 1 else 0 end) as cnt_town10, \
    sum(case when id_client<>-1 and coalesce(is_town,false) =false and volt > 0.4 and volt < 20 then 1 else 0 end) as cnt_vill10, \
    sum(case when id_client<>-1 and volt = 0.4 and phase = 1 then 1 else 0 end) as cnt_02, \
    sum(case when id_client<>-1 and volt = 0.4 and phase = 2 then 1 else 0 end) as cnt_03, \
    sum(fiz_count) as fiz_count \
from \
( \
select ssss.*, \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage in (3,31,32,4) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32,4) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32,4) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32,4) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32,4) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32,4) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32,4) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32,4) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( \
   select distinct aa.id_area, aa.id_client, ba.id_grp , aa.is_town , vv.voltage_min as volt , aa.phase, 0 as fiz_count \
    from bal_points_all_tbl as ba \
    join rep_areas_points_tbl as ap on (ap.id_point = ba.id_point ) \
    join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
    join clm_client_tbl as c on (c.id = ba.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
    join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
    where  c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and ba.dat = :mmgg and ap.is_subabon = 0 \
    union \
    select 0, -1, ba2.id_grp , false , 0.4 , 1 , sum(ba2.fiz_count) \
    from bal_points_all_tbl as ba2 \
    where ba2.dat = :mmgg and ba2.id_client = -1 \
    group by ba2.id_grp \
)as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.id_grp and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
) as fidersel \
 left join \
   ( select a.code_eqp, coalesce(kt.flag_type,CASE WHEN res.kod = '310' THEN true ELSE false END ) as is_town_ps, sum(eqi.power_nom::::numeric) as sum_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    left join adm_address_tbl as ad on (ad.id = eq.id_addres) \
    left join adi_street_tbl as s on (s.id = ad.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    left join (select value_ident as kod, 1 as k from syi_sysvars_tbl where ident = 'kod_res') as res on (res.k = 1 ) \
    where eq.type_eqp=8 \
    group by a.code_eqp , coalesce(kt.flag_type,CASE WHEN res.kod = '310' THEN true ELSE false END ) \
    order by a.code_eqp \
   ) as ss_power on (ss_power.code_eqp = code_ps10 ) \
 where (( code_f10 = :fider) or ( :fider = 0 )) and code_ps10 is not null \
 group by code_f10,code_ps10,name_ps10,sum_power,is_town_ps  \
 order by code_f10, name_ps10 ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;


  AnsiString sqlstr2=" select id_fider as link, name_f10, ps_count, \
    sum(case when  id_client<>-1 and coalesce(is_town,false) =true and volt = 0.4 then 1 else 0 end) as cnt_town04, \
    sum(case when  id_client<>-1 and coalesce(is_town,false) =false and volt = 0.4 then 1 else 0 end) as cnt_vill04, \
    sum(case when  id_client<>-1 and coalesce(is_town,false) =true and volt > 0.4 and volt < 20 then 1 else 0 end) as cnt_town10, \
    sum(case when  id_client<>-1 and coalesce(is_town,false) =false and volt > 0.4 and volt < 20 then 1 else 0 end) as cnt_vill10, \
    sum(case when  id_client<>-1 and volt = 0.4 and phase = 1 then 1 else 0 end) as cnt_02, \
    sum(case when  id_client<>-1 and volt = 0.4 and phase = 2 then 1 else 0 end) as cnt_03, \
    sum(fiz_count) as fiz_count \
from \
( \
  select sss.*, ee.name_eqp as name_f10, ps_count  \
  from ( \
   select distinct aa.id_area, aa.id_client, ba.id_fider ,ba.id_grp, aa.is_town , vv.voltage_min as volt , aa.phase , 0 as fiz_count \
    from bal_points_all_tbl as ba \
    join rep_areas_points_tbl as ap on (ap.id_point = ba.id_point ) \
    join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
    join clm_client_tbl as c on (c.id = ba.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
    join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
    where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and ba.dat = :mmgg and ap.is_subabon =0 \
    union \
    select 0, -1, ba2.id_fider ,ba2.id_grp, false , 0.4 , 1 , sum(ba2.fiz_count) \
    from bal_points_all_tbl as ba2 \
    where ba2.dat = :mmgg and ba2.id_client = -1 \
    group by ba2.id_fider, ba2.id_grp \
  )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.id_fider ) \
  left join (select count(distinct id_grp) as ps_count, id_fider \
           from bal_points_all_tbl where dat = :mmgg and coalesce(id_grp,0)<> coalesce(id_fider,0) \
           and coalesce(id_grp,0) <>0 \
           group by id_fider order by id_fider) as ff on (ff.id_fider = sss.id_fider) \
 ) as ssss \
 where (( id_fider = :fider) or ( :fider = 0 )) \
 group by id_fider, name_f10, ps_count \
 order by name_f10 ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLRepsSum->ParamByName("fider")->AsInteger=FiderId;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 xlReport->ParamByName["lcaption"]->Value = edFiderName->Text;

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//------------------------------------------------------------------------------

void TfReports::Monitor_A4_2010(boolean Build,TDateTime dtb)
{

  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_volt_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
   sqlstr="select bal_points_find_fun( :dt );";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("dt")->AsDateTime=dtb;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  }

  AnsiString sqlstr=" select distinct id_client, code, short_name, code_f10, name_f10,code_ps10,coalesce(name_ps10,'-від фідера-') as name_ps10 ,id_area, volt, is_town , \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown, \
   CASE WHEN phase = 1 THEN 'Одна' WHEN phase = 2 THEN 'Три' ELSE '' END as phase_str \
from \
( \
select ssss.*,  \
case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when id_voltage in (3,31,32,4) and type_eqp = 8 then code_eqp \
     when id_voltage2 in (3,31,32,4) and type_eqp2 = 8 then code_eqp2 \
     when id_voltage3 in (3,31,32,4) and type_eqp3 = 8 then code_eqp3 \
     when id_voltage4 in (3,31,32,4) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when id_voltage in (3,31,32,4) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32,4) and type_eqp2 = 8 then grpname2 \
     when id_voltage3 in (3,31,32,4) and type_eqp3 = 8 then grpname3 \
     when id_voltage4 in (3,31,32,4) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( \
   select distinct aa.id_area, aa.id_client, c.code, c.short_name, ba.id_grp as link , aa.is_town , vv.voltage_min as volt , aa.phase, 0 as fiz_count   \
    from bal_points_all_tbl as ba \
    join rep_areas_points_tbl as ap on (ap.id_point = ba.id_point ) \
    join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
    join clm_client_tbl as c on (c.id = ba.id_client) \
    join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
    join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
    where  c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and ba.dat = :mmgg and ap.is_subabon = 0 \
  )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :mmgg) ) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  where (( case when id_voltage in (3,31,32) and type_eqp = 15 then code_eqp \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) order by code \
) as fidersel \
 left join eqm_equipment_tbl as eqa on (eqa.id = fidersel.id_area) \
order by name_f10, name_ps10,area ";

//---------------------------

/*
    union \
    select 0, -1, 0, 'Населення ', ba2.id_grp , false , 0.4 , 1 , sum(ba2.fiz_count)   \
    from bal_points_all_tbl as ba2 \
    where ba2.dat = :mmgg and ba2.id_client = -1 \
    group by ba2.id_grp \

*/

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 xlReport->ParamByName["lcaption"]->Value = edFiderName->Text;

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::Monitor_A2_2010(TDateTime dtb,TDateTime dte)
{

//  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_volt_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
     ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr="select rep_monitor_a2a3_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
     ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1=" select * from \
  ( \
  select 1 as k, \
  sum(CASE WHEN coalesce(is_town ,false) = true THEN 1 ELSE 0 END) as count_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false THEN 1 ELSE 0 END) as count_s \
  from \
  (\
   select distinct aa.id_client,aa.id_area,aa.is_town \
   from rep_areas_points_tbl as ap \
   join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
   join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
   where vv.voltage_min =0.4 and ap.is_subabon =0 ) as ss \
  ) as cnt1 \
  join \
  ( \
  select 1 as k, \
  sum(CASE WHEN coalesce(is_town ,false) = true THEN 1 ELSE 0 END) as count_t_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false THEN 1 ELSE 0 END) as count_t_s \
  from \
  ( \
   select distinct a.code_eqp as area , c.code_eqp, coalesce(kt.flag_type,((select getsysvar('kod_res')) = 310)) as is_town \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqm_equipment_tbl as eqc on (eqc.id = ins.code_eqp ) \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = a.code_eqp) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    left join adm_address_tbl as ad on (ad.id = eq.id_addres) \
    left join adi_street_tbl as s on (s.id = ad.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where eq.type_eqp=8 and eqi.voltage2_nom <=400 \
    and coalesce(eq.is_owner,0) = 0  and coalesce(eqc.is_owner,0) = 0 \
    and coalesce(cs.abon_ps,0) = 0 \
    order by a.code_eqp \
  ) as sss \
 ) as cnt2 on (cnt1.k = cnt2.k)   ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN coalesce(is_town ,false) = true THEN demand_all ELSE 0 END) as demand_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false THEN demand_all ELSE 0 END) as demand_s \
  from \
   (select pi.id_point, pi.id_client, pi.id_area, pi.is_town, vv.voltage_min as volt, pi.demand::::numeric/1000 as demand_all \
    from \
    rep_points_info_tmp as pi \
    left join eqk_voltage_tbl as vv on (vv.id=pi.voltage) \
    where vv.voltage_min =0.4 \
    order by id_point \
  ) as sym1  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
//  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======

   sqlstr1="   select c.code, c.short_name as name, eqm.name_eqp as point, \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
  coalesce(is_town ,true) as is_town,sym1.demand_all, volt ,\
  CASE WHEN coalesce(is_town ,true) = false THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
   (select pi.id_point, pi.id_client, pi.id_area, pi.is_town, vv.voltage_min as volt, pi.demand::::numeric/1000 as demand_all \
    from \
    rep_points_info_tmp as pi \
    left join eqk_voltage_tbl as vv on (vv.id=pi.voltage) \
    where vv.voltage_min =0.4 \
    order by id_point \
  ) as sym1 \
 join clm_client_tbl as c on (c.id = sym1.id_client) \
 left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
 left join eqm_equipment_h as eqa on (eqa.id =sym1.id_area) \
  where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = eqm.id  ) \
  and ( ( eqa.dt_b = (select max(dt_b) from eqm_equipment_h as eqa2 where eqa2.id = eqa.id  )) or (eqa.dt_b is null )) \
   order by volt, istown, c.code;   ";


   sqlstr2="select c.code, c.short_name as name, \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
   CASE WHEN is_town = true THEN 'мiська' ELSE 'сiльська' END as istown \
  from \
  ( \
   select distinct aa.id_client,aa.id_area,aa.is_town \
   from rep_areas_points_tbl as ap \
   join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
   join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
   where vv.voltage_min =0.4 and ap.is_subabon =0 \
   ) as ss  \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by istown, code, area ; ";


   AnsiString sqlstr3="   select distinct a.code_eqp as area , c.code_eqp, \
   CASE WHEN coalesce(kt.flag_type,((select getsysvar('kod_res')) = 310)) = true THEN 'мiська' ELSE 'сiльська' END as istown, \
    eq.name_eqp as tp_name,    eqc.name_eqp as comp_name,  adv.adr \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqm_equipment_tbl as eqc on (eqc.id = ins.code_eqp ) \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = a.code_eqp) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    left join adm_address_tbl as ad on (ad.id = eq.id_addres) \
    left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
    left join adi_street_tbl as s on (s.id = ad.id_street) \
    left join adi_town_tbl as t on (t.id = s.id_town) \
    left join adk_town_tbl as kt on (kt.id = t.idk_town) \
    where eq.type_eqp=8 and eqi.voltage2_nom <=400 \
    and coalesce(eq.is_owner,0) = 0  and coalesce(eqc.is_owner,0) = 0 \
    and coalesce(cs.abon_ps,0) = 0 \
    order by istown,eqc.name_eqp ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
//  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  ZQXLReps3->Sql->Clear();
  ZQXLReps3->Sql->Add(sqlstr3);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLReps3->Open();

    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();

  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps3;
  Dsr->Range = "Range3";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ (Тiльки для Чернiгiвських МЕМ)";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();
 ZQXLReps2->Close();
 ZQXLReps3->Close();

 ZQXLRepsSum->Close();
 ZQXLRepsSum2->Close();


}
////////////---------------------------------------------
void TfReports::Monitor_A3_2010(TDateTime dtb,TDateTime dte)
{

 // if (Build)
  {

  AnsiString sqlstr="select rep_abon_count_volt_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
     ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  sqlstr="select rep_monitor_a2a3_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  }

  AnsiString  sqlstr1="  select \
  sum(CASE WHEN coalesce(is_town ,false) = true  and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_m, \
  sum(CASE WHEN coalesce(is_town ,false) = false and volt <= 20 and volt >= 6 THEN 1 ELSE 0 END) as count6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN 1 ELSE 0 END) as count35, \
  sum(CASE WHEN volt >= 110 THEN 1 ELSE 0 END) as count110 \
  from \
  (\
   select distinct aa.id_client,aa.id_area,aa.is_town , vv.voltage_min as volt \
   from rep_areas_points_tbl as ap \
   join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
   join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
  where vv.voltage_min >=6 and ap.is_subabon =0 ) as ss ; ";


  AnsiString  sqlstr2="  select \
  sum(CASE WHEN coalesce(is_town ,true) = true  and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_m, \
  sum(CASE WHEN coalesce(is_town ,true) = false and volt <= 20 and volt >= 6 THEN demand_all ELSE 0 END) as demand6_s, \
  sum(CASE WHEN volt <= 35 and volt >= 27 THEN demand_all ELSE 0 END) as demand35, \
  sum(CASE WHEN volt >= 110 THEN demand_all ELSE 0 END) as demand110 \
  from \
   (select pi.id_point, pi.id_client, pi.id_area, pi.is_town, vv.voltage_min as volt, pi.demand::::numeric/1000 as demand_all \
    from \
    rep_points_info_tmp as pi \
    left join eqk_voltage_tbl as vv on (vv.id=pi.voltage) \
    where vv.voltage_min >=6 \
    order by id_point \
  ) as sym1  ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

//---------------------------

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
//  ZQXLRepsSum2->ParamByName("dtb")->AsDateTime=dtb;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  // ==== расшифровка ======
   sqlstr1="   select c.code, c.short_name as name, eqm.name_eqp as point, \
   CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
  coalesce(is_town ,true) as is_town,sym1.demand_all, volt ,\
  CASE WHEN coalesce(is_town ,true) = false THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
   (select pi.id_point, pi.id_client, pi.id_area, pi.is_town, vv.voltage_min as volt, pi.demand::::numeric/1000 as demand_all \
    from \
    rep_points_info_tmp as pi \
    left join eqk_voltage_tbl as vv on (vv.id=pi.voltage) \
    where vv.voltage_min >=6 \
    order by id_point \
  ) as sym1 \
 join clm_client_tbl as c on (c.id = sym1.id_client) \
 left join eqm_equipment_h as eqm on (eqm.id=sym1.id_point) \
 left join eqm_equipment_h as eqa on (eqa.id =sym1.id_area) \
  where eqm.dt_b = (select max(dt_b) from eqm_equipment_h as eqm2 where eqm2.id = eqm.id  ) \
  and ( ( eqa.dt_b = (select max(dt_b) from eqm_equipment_h as eqa2 where eqa2.id = eqa.id  )) or (eqa.dt_b is null )) \
   order by volt, istown, c.code;   ";


  sqlstr2="select c.code, c.short_name as name, volt,  \
  CASE WHEN eqa.name_eqp is null then '--не вказана--' ELSE eqa.name_eqp END as area, \
  CASE WHEN is_town = false THEN 'сiльська' ELSE 'мiська' END as istown \
  from \
  ( \
   select distinct aa.id_client,aa.id_area,aa.is_town , vv.voltage_min as volt \
   from rep_areas_points_tbl as ap \
   join rep_areas_tbl as aa on (aa.id_client = ap.id_client and aa.id_area = ap.id_area ) \
   join eqk_voltage_tbl as vv on (vv.id=aa.voltage) \
  where vv.voltage_min >=6 and ap.is_subabon =0 \
  ) as ss \
 join clm_client_tbl as c on (c.id = ss.id_client) \
 left join eqm_equipment_tbl as eqa on (eqa.id = ss.id_area) \
 order by volt, istown, code, area ; ";

//---------------------------

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
//  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
 // Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["lperiod"]->Value = "на "+ FormatDateTime("dd.mm.yyyy",dtBegin->Date);
 // xlReport->ParamByName["lcaption"]->Value = "Загальна інформація по точкам обліку споживачів, приєднаних до рівня напруги >=6 кВ";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();


}
//---------------------------------------------
void TfReports::PrintAbonFiders_grafic_mem(TDateTime mmgg, boolean Build)
{

//  if ((!cbUr->Checked)&&(!cbFiz->Checked)) return;

  if (Build)
  {

  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select sssss.*, \
    CASE when (dt1 is null or dt1 < date_trunc('month',:mmgg::::date)::::date) and dt2 < date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval THEN dt2 \
         when (dt1 < date_trunc('month',:mmgg::::date)::::date) and (dt2 >= date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval or dt2 is null ) THEN null  else dt1 END as date1, \
    CASE when (dt2 is null or dt2 < date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval) and dt3 < date_trunc('month',:mmgg::::date)::::date+ '2 month'::::interval THEN dt3 \
         when (dt2 < date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval) and (dt3 >= date_trunc('month',:mmgg::::date)::::date+ '2 month'::::interval or dt3 is null) THEN null  else dt2 END as date2, \
    CASE when (dt3 is null or dt3 < date_trunc('month',:mmgg::::date)::::date+ '2 month'::::interval) and dt4 < date_trunc('month',:mmgg::::date)::::date+ '3 month'::::interval THEN dt4 \
         when (dt3 < date_trunc('month',:mmgg::::date)::::date+ '2 month'::::interval) and (dt4 >= date_trunc('month',:mmgg::::date)::::date+ '3 month'::::interval or dt4 is null) THEN null else dt3 END as date3, \
    CASE when (dt4 is null or dt4 < date_trunc('month',:mmgg::::date)::::date+ '3 month'::::interval) and dt5 < date_trunc('month',:mmgg::::date)::::date+ '4 month'::::interval THEN dt5 \
         when (dt4 < date_trunc('month',:mmgg::::date)::::date+ '3 month'::::interval) and (dt5 >= date_trunc('month',:mmgg::::date)::::date+ '4 month'::::interval or dt5 is null) THEN null else dt4 END as date4, \
    CASE when (dt5 is null or dt5 < date_trunc('month',:mmgg::::date)::::date+ '4 month'::::interval) and dt6 < date_trunc('month',:mmgg::::date)::::date+ '5 month'::::interval THEN dt6 \
         when (dt5 < date_trunc('month',:mmgg::::date)::::date+ '4 month'::::interval) and (dt6 >= date_trunc('month',:mmgg::::date)::::date+ '5 month'::::interval or dt6 is null) THEN null  else dt5 END as date5, \
    CASE when (dt6 is null or dt6 < date_trunc('month',:mmgg::::date)::::date+ '5 month'::::interval) and dt7 < date_trunc('month',:mmgg::::date)::::date+ '6 month'::::interval THEN dt7 \
         when (dt6 < date_trunc('month',:mmgg::::date)::::date+ '5 month'::::interval) and (dt7 >= date_trunc('month',:mmgg::::date)::::date+ '6 month'::::interval or dt7 is null) THEN null  else dt6 END as date6, \
    CASE when (dt7 is null or dt7 < date_trunc('month',:mmgg::::date)::::date+ '6 month'::::interval) and dt8 < date_trunc('month',:mmgg::::date)::::date+ '7 month'::::interval THEN dt8 \
         when (dt7 < date_trunc('month',:mmgg::::date)::::date+ '6 month'::::interval) and (dt8 >= date_trunc('month',:mmgg::::date)::::date+ '7 month'::::interval or dt8 is null) THEN null  else dt7 END as date7, \
    CASE when (dt8 is null or dt8 < date_trunc('month',:mmgg::::date)::::date+ '7 month'::::interval) and dt9 < date_trunc('month',:mmgg::::date)::::date+ '8 month'::::interval THEN dt9 \
         when (dt8 < date_trunc('month',:mmgg::::date)::::date+ '7 month'::::interval) and (dt9 >= date_trunc('month',:mmgg::::date)::::date+ '8 month'::::interval or dt9 is null) THEN null  else dt8 END as date8, \
    CASE when (dt9 is null or dt9 < date_trunc('month',:mmgg::::date)::::date+ '8 month'::::interval) and dt10 < date_trunc('month',:mmgg::::date)::::date+ '9 month'::::interval THEN dt10 \
         when (dt9 < date_trunc('month',:mmgg::::date)::::date+ '8 month'::::interval) and (dt10 >= date_trunc('month',:mmgg::::date)::::date+ '9 month'::::interval or dt10 is null) THEN null else dt9 END as date9, \
    CASE when (dt10 is null or dt10 < date_trunc('month',:mmgg::::date)::::date+ '9 month'::::interval) and dt11 < date_trunc('month',:mmgg::::date)::::date+ '10 month'::::interval THEN dt11 \
         when (dt10 < date_trunc('month',:mmgg::::date)::::date+ '9 month'::::interval) and (dt11 >= date_trunc('month',:mmgg::::date)::::date+ '10 month'::::interval or dt11 is null) THEN null  else dt10 END as date10, \
    CASE when (dt11 is null or dt11 < date_trunc('month',:mmgg::::date)::::date+ '10 month'::::interval) and dt12 < date_trunc('month',:mmgg::::date)::::date+ '11 month'::::interval THEN dt12 \
         when (dt11 < date_trunc('month',:mmgg::::date)::::date+ '10 month'::::interval) and (dt12 >= date_trunc('month',:mmgg::::date)::::date+ '11 month'::::interval or dt12 is null) THEN null  else dt11 END as date11, \
    CASE when (dt12 is null or dt12 < date_trunc('month',:mmgg::::date)::::date+ '11 month'::::interval) and dt13 < date_trunc('month',:mmgg::::date)::::date+ '12 month'::::interval THEN dt13 \
         when (dt12 < date_trunc('month',:mmgg::::date)::::date+ '11 month'::::interval) and (dt13 >= date_trunc('month',:mmgg::::date)::::date+ '12 month'::::interval or dt13 is null) THEN null else dt12 END as date12 \
    from (  select ssss.*, cp2.represent_name as fider_inspector, \
     ww.worktype,ww.dt_work, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,4,7,10)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,5,8,11)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date) in (3,6,9,12)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                         END::::date ,2) as dt1, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt2, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '2 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'2 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'2 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'2 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'2 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'2 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'2 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'2 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'2 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'2 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'2 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt3, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '3 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'3 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'3 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'3 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'3 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'3 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'3 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'3 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'3 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'3 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'3 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt4, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '4 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'4 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'4 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'4 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'4 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'4 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'4 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'4 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'4 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'4 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'4 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt5, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '5 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'5 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'5 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'5 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'5 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'5 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'5 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'5 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'5 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'5 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'5 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt6, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '6 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'6 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'6 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'6 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'6 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'6 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'6 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'6 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'6 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'6 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'6 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt7, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '7 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'7 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'7 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'7 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'7 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'7 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'7 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'7 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'7 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'7 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'7 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt8, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '8 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'8 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'8 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'8 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'8 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'8 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'8 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'8 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'8 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'8 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'8 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt9, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '9 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'9 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'9 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'9 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'9 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'9 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'9 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'9 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'9 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'9 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'9 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                      END::::date ,2) as dt10, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '10 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'10 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'10 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'10 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'10 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'10 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'10 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'10 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'10 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'10 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'10 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt11, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '11 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'11 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'11 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'11 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'11 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'11 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'11 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'11 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'11 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'11 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'11 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt12, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '12 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date +'12 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'12 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date +'12 month'::::interval ) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+'12 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date +'12 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'12 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date +'12 month'::::interval ) in (2,5,8,11)     then date_trunc('month',:mmgg::::date)::::date+'12 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date +'12 month'::::interval ) in (3,6,9,12)     then date_trunc('month',:mmgg::::date)::::date+'12 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt13, \
 case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type, ph.name as phase, km.name as kind, cp.represent_name,cp3.represent_name as point_inspector, \
  stt.tt_type,stcl.dt_indicat,  substring(text(month_control)::::varchar,1,1)::::int as period_indicat, \
  CASE WHEN coalesce(substring(text(month_control)::::varchar,2,1),'') = '' THEN '1' ELSE substring(text(month_control)::::varchar,2,1) END::::int as month_indicat,\
  id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  left join clm_position_tbl as cp3 on (cp3.id = p.id_position) \
  left join \
  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
  ic.conversion , ic.type as tt_type,ic.accuracy from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99)  ";

  //left join clm_statecl_tbl as sc on (c.id = sc.id_client)

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  ( select wi.name as worktype, id_point,dt_work from \
    (select w.id_point,w.id_client, w.dt_work, min(w.id_type) as id_type \
     from clm_works_tbl as w \
     join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = 1 or id_type = 2 group by id_client, id_point) as w2 \
     on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
     group by w.id_point,w.id_client, w.dt_work \
    ) as wg \
    join cli_works_tbl as wi on (wi.id = wg.id_type) \
  ) as ww on (ww.id_point = ssss.id_point) \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
     and ( :insp is null or ff.id_position = :insp) \
     ) as sssss \
  order by code " ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lfider";
  Param=xlReport->Params->Add();
  Param->Name="linspector";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->ParamByName["lfider"]->Value = edFiderName->Text;
  xlReport->ParamByName["linspector"]->Value = edInspector->Text;

  AnsiString caption = "Графік зйому показників по юридичним споживачам.";

//  if (cbUr->Checked) caption =caption +" Юридичні особи; ";
 // if (cbFiz->Checked) caption =caption +" Населення; ";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();


 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::DemandLimit_AvansCalc (boolean Build, TDateTime dt,TDateTime pmmgg)
{
   int obr_exists=0;
    AnsiString message;
    AnsiString sqlstr;
    TDateTime mmgg = pmmgg;

   if (Build)
   {
     sqlstr="select count(*) as cnt from seb_obr_all_tbl where period = date_trunc('month', :mmgg::::date)- '1 month'::::interval;";
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
     obr_exists = ZQReps->FieldByName("cnt")->AsInteger;
     ZQReps->Close();

     if ((mmgg > cur_mmgg)||(obr_exists==0))
     {
      if (mmgg > cur_mmgg) message ="Предыдущий месяц не закрыт! Переформировать оборотку ?";
      else message ="Нет данных за предыдущий месяц! Переформировать оборотку ?";

      int r = MessageDlg(message, mtConfirmation, TMsgDlgButtons() << mbYes << mbNo<<mbCancel, 0);

      if ( r==mrCancel ) return;
      if ( r==mrYes )
      {
        sqlstr=" select seb_all( 3, (date_trunc('month', :mmgg::::date)- '1 month'::::interval)::::date );";

        ZQReps->Close();
        ZQReps->Sql->Clear();
        ZQReps->Sql->Add(sqlstr);
        ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

        try
        {
         ZQReps->ExecSql();
        }
        catch(...)
        {
         ShowMessage("Ошибка SQL :"+sqlstr);
         return;
        }

      }
     }
   }

    //-------------------
     sqlstr=" delete from rep_last_bill_tmp ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

     sqlstr=" insert into rep_last_bill_tmp \
              select id_client, max(mmgg) \
              from acm_bill_tbl \
              where mmgg <= :mmgg::::date and mmgg >=:mmgg::::date - '3 month'::::interval \
              and demand_val > 0 and id_pref=10 and idk_doc = 200 \
              group by id_client order by id_client ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }


  AnsiString  sqlstr1=" select bigsel.*, \
  CASE WHEN tarif_value <> 0 THEN value_dem+round((CASE WHEN kb_now+pay_all-db - round(value_dem*tarif_value*pre_pay_perc*1.2,2) >0 THEN kb_now+pay_all-db - round(value_dem*tarif_value*pre_pay_perc*1.2,2) ELSE 0 END )/(tarif_value*1.2),2) ELSE 0 END as max_limit, \
  CASE WHEN kb_now+pay_all-db >0 THEN kb_now+pay_all-db ELSE 0 END as kk_now, \
  coalesce(bill_b, :mmgg::::date+dt_indicat-'1 month'::::interval) as dt_start , \
  coalesce(bill_e, :mmgg::::date+(dt_indicat-1) ) as dt_end , \
  CASE WHEN tarif_calc_metod = 1 THEN 'поточний рах.' WHEN tarif_calc_metod = 2 THEN 'попередній рах.' WHEN tarif_calc_metod = 3 THEN 'розрахунок' END as tarif_calc_str, \
  round(value_dem*tarif_value*pre_pay_perc*1.2,2) as sum_avans \
   from ( \
   select distinct cl.id, ss_a.sumbill,ss_a.bill_date,ss_a.transmis_date,ss_a.pay_all,ss_a.pay_date, ss_a.kb_now, ss_a.db , stcl.phone, stcl.dt_indicat, \
     slimit.value_dem, \
     CASE WHEN avgtarsss.f_zone<>0 or avgtarsss.f_othertarif <> 0 or avgtarsss.f_currmmgg <>0 or ((avgtarsss.f_main =0) and (avgtarsss.f_fiz <> 0 ) )THEN avgtarsss.avg_tar \
          ELSE (tarsss.tarif_value*( (coalesce(bill_e, :mmgg::::date+(dt_indicat-1) )::::date - :mmgg::::date)+1)+ \
               tarsss.tarif_value_prev*(:mmgg::::date - coalesce(bill_b, :mmgg::::date+dt_indicat-'1 month'::::interval)::::date) \
               ) / ( (coalesce(bill_e, :mmgg::::date+(dt_indicat-1) )::::date-  coalesce(bill_b, :mmgg::::date+dt_indicat-'1 month'::::interval)::::date)+1  ) \
           END as tarif_value,  \
     CASE WHEN avgtarsss.f_currmmgg <>0 THEN 1 WHEN avgtarsss.f_zone<>0 or avgtarsss.f_othertarif <> 0 or ((avgtarsss.f_main =0) and (avgtarsss.f_fiz <> 0 )) THEN 2 ELSE 3 END as tarif_calc_metod , \
     CASE WHEN ss_a.dk >0 THEN ss_a.dk ELSE 0 END as debet_a, \
     cl.code, cl.short_name,cl.name as abonname, cp.represent_name, pr.name as grp_name, stcl.id_section , \
     bill_dates.bill_b, bill_dates.bill_e, \
     CASE WHEN (stcl.pre_pay_day3 is not null) and (stcl.pre_pay_day3 < :dt::::date) THEN stcl.pre_pay_day3 \
          WHEN (stcl.pre_pay_day2 is not null) and (stcl.pre_pay_day2 < :dt::::date) THEN stcl.pre_pay_day2 \
          WHEN (stcl.pre_pay_day1 is not null) and (stcl.pre_pay_day1 < :dt::::date) THEN stcl.pre_pay_day1 \
          ELSE null END as pre_pay_day , \
     CASE WHEN (stcl.pre_pay_day3 is not null) and (stcl.pre_pay_day3 < :dt::::date) THEN coalesce(stcl.pre_pay_perc3,0)+coalesce(stcl.pre_pay_perc2,0)+coalesce(stcl.pre_pay_perc1,0) \
          WHEN (stcl.pre_pay_day2 is not null) and (stcl.pre_pay_day2 < :dt::::date) THEN coalesce(stcl.pre_pay_perc2,0)+coalesce(stcl.pre_pay_perc1,0) \
          WHEN (stcl.pre_pay_day1 is not null) and (stcl.pre_pay_day1 < :dt::::date) THEN coalesce(stcl.pre_pay_perc1,0) \
          ELSE 0 END::::numeric/100 as pre_pay_perc   \
     from \
      (select cl.* from clm_client_tbl as cl where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) order by cl.id) as cl  \
      join \
      ( select st.id_client, st.dt_indicat, st.id_section,st.phone,st.day_pay_bill, st.addr_local, st.id_position, st.pre_pay_perc3, st.pre_pay_perc2, st.pre_pay_perc1, \
        CASE WHEN (coalesce(st.pre_pay_day3,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day3,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_day3, \
        CASE WHEN (coalesce(st.pre_pay_day2,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day2,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_day2, \
        CASE WHEN (coalesce(st.pre_pay_day1,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day1,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_day1 \
        from clm_statecl_h as st \
        where st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = st.id_client and stcl2.mmgg_b <= :mmgg::::date ) \
        and st.id_section not in (205,206,207,208) \
        order by st.id_client \
      ) as stcl on (cl.id = stcl.id_client) \
    left join \
    ( select coalesce(s.id_client, bill.id_client, pay.id_client) as id_client, \
     coalesce(s.deb_k,0) as db, CASE WHEN order_pay =0 THEN coalesce(s.kr_zkmv,0) ELSE coalesce(kr_zkmv_now,0) END as kb_now,  \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all,  pay.reg_date as pay_date, \
     coalesce(s.deb_k,0) - coalesce(pay.pay_all,0) + coalesce(bill.sumbill,0) - coalesce(s.kr_old_pos,0) - coalesce(s.kr_zkmv_now,0) as dk, \
     numeric_larger(coalesce(s.kr_zkmv_now,0) + coalesce(pay.pay10,0) - coalesce(bill.sumbill10,0) - coalesce(s.deb10_k,0),0 ) as kk_now \
     from \
     (select obr.id_client, c.order_pay, \
     -deb_kmv as deb_k,kr_zkmv as kr_zkmv, - deb_km10v as deb10_k,  e_kred+e_kred_tax as kr_zkmv_now,  \
     CASE WHEN kr_zkmv > (e_kred+e_kred_tax) THEN kr_zkmv - (e_kred+e_kred_tax) ELSE 0 END as kr_old_pos \
     from seb_obr_all_tbl as obr \
     join clm_client_tbl as c on (c.id = obr.id_client) \
     where obr.period = :mmgg::::date- '1 month'::::interval and obr.id_pref = 10  order by obr.id_client )as s \
     full outer join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date,  \
       sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value+b.value_tax ELSE 0 END) as sumbill10 \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = :mmgg::::date and b.reg_date <= :dt \
      and b.id_pref = 10 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     full outer join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all,  \
      sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10 \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where p.reg_date <= :dt and ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref = 10 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_a  on (cl.id = ss_a.id_client) \
   left join ( \
   select hl.id_client, sum(d1.value_dem) as value_dem \
     from acd_demandlimit_tbl as d1 \
     join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and d2.month_limit= :mmgg \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
     where hl.idk_document = 600  and d1.month_limit= :mmgg \
     group by hl.id_client \
     order by hl.id_client \
   ) as slimit on (slimit.id_client =cl.id ) \
   left join \
   ( select id_client, CASE when dem1>dem2 then  tcl1_id else tcl2_id end as tcl_id, t.id , tt.value as tarif_value, tt_prev.value as tarif_value_prev \
     from \
     (select b.id_client, \
      sum(CASE when tcl1.ident='tcl1' then bs1.demand_val else 0 end ) as dem1, \
      sum(CASE when tcl1.ident='tcl2' then bs1.demand_val else 0 end ) as dem2, \
      max(CASE when tcl1.ident='tcl1' then tcl1.id else 0 end) as tcl1_id, \
      max(CASE when tcl1.ident='tcl2' then tcl1.id else 0 end) as tcl2_id \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t2 on (t2.id_client = b.id_client and t2.mmgg = b.mmgg ) \
      join aci_tarif_tbl as tar1 on (tar1.id=bs1.id_tariff) \
      join eqi_classtarif_tbl as tcl1 on (tar1.id_classtarif=tcl1.id) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
     ) as tss \
    join aci_tarif_tbl as t on (t.id_grouptarif = 12 and t.id_classtarif = CASE when dem1>dem2 then  tcl1_id else tcl2_id end ) \
    join acd_tarif_tbl as tt on (tt.id_tarif = t.id) \
    join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date group by id_tarif  )as ttd on (tt.id_tarif = ttd.id_tarif and tt.dt_begin = ttd.dtb) \
    join acd_tarif_tbl as tt_prev on (tt_prev.id_tarif = t.id) \
    join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date- '1 month'::::interval group by id_tarif  )as ttd_prev on (tt_prev.id_tarif = ttd_prev.id_tarif and tt_prev.dt_begin = ttd_prev.dtb) \
    order by id_client \
   ) as tarsss on (tarsss.id_client = cl.id) \
   left join \
   ( select b.id_client, CASE WHEN sum(bs1.demand_val) >0 THEN round(sum(bs1.sum_val)/sum(bs1.demand_val),5) ELSE 0 END as avg_tar, \
      sum(CASE WHEN coalesce(bs1.id_zone ,0)<>0 THEN 1 ELSE 0 END ) as f_zone, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) not in (12,14,15,16,21,22,29,30,44,45,28,35,37,48) THEN 1 ELSE 0 END ) as f_othertarif, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (12,14,15,16,21,22,29,30) THEN 1 ELSE 0 END ) as f_main, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (28,35,37,48) THEN 1 ELSE 0 END ) as f_fiz,  \
      sum(CASE WHEN b.mmgg = :mmgg THEN 1 ELSE 0 END ) as f_currmmgg  \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t1 on (t1.id_client = b.id_client and t1.mmgg = b.mmgg ) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
   ) as avgtarsss on (avgtarsss.id_client = cl.id) \
   left join \
   ( select b.id_client, \
     CASE WHEN b.mmgg = :mmgg::::date THEN b.dat_e ELSE null END as bill_e, \
     CASE WHEN b.mmgg = :mmgg::::date THEN b.dat_b WHEN b.mmgg = :mmgg::::date - '1 month'::::interval THEN b.dat_e+'1 day'::::interval ELSE null END as bill_b \
     from \
     acm_bill_tbl as b \
     join rep_last_bill_tmp as t1 on (t1.id_client = b.id_client and t1.mmgg = b.mmgg ) \
     where b.id_pref=10 and b.idk_doc = 200 \
     order by b.id_client \
   ) as bill_dates on (bill_dates.id_client = cl.id) \
     left join clm_position_tbl as cp on (stcl.id_position = cp.id) \
     left join cla_param_tbl as pr on (stcl.id_section = pr.id) \
    ) as bigsel     \
    order by id_section, code ;";

//      where b.id_pref=10  and b.mmgg=:mmgg::::date - '1 month'::::interval  and bs1.demand_val<>0 \

//      where b.id_pref=10  and b.mmgg= ( select max(mmgg) from acm_bill_tbl where id_client = b.id_client \
//            and mmgg <= :mmgg::::date - '1 month'::::interval and demand_val > 0 and id_pref=10 )  and bs1.demand_val<>0 \
//            and b.mmgg<= :mmgg::::date - '1 month'::::interval and b.mmgg >=:mmgg::::date - '3 month'::::interval \


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();


   Param=xlReport->Params->Add();
   Param->Name="lres";
   Param=xlReport->Params->Add();
   Param->Name="lperiod";
   Param=xlReport->Params->Add();
   Param->Name="lnow";
//   Param=xlReport->Params->Add();
//   Param->Name="linsp";
   Param=xlReport->Params->Add();
   Param->Name="ldt";

   xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
   xlReport->ParamByName["lres"]->Value = ResName;
   xlReport->ParamByName["lperiod"]->Value = "За "+FormatDateTime("mmmm yyyy",dtBegin->Date);
   xlReport->ParamByName["ldt"]->Value = "на "+FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

  ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::BadIndicList(TDateTime mmgg)
{
  AnsiString  sqlstr1=" select sss.*, c.code, c.short_name, cp.represent_name, cp2.represent_name as represent_name2,cp3.represent_name as represent_name3, \
  cp4.represent_name as represent_name4, en.name as energy , zz.name as zone \
  from  ( \
  select s1.* , calc_ind_pr(value,val_prev,carry) as dem, calc_ind_pr(ind,val_prev,carry) as ind_dem \
  from ( \
  select h.id_client,p_insp.dt_insp, p_insp.value as kontrol_ind, ww.dt_work, ww.value as work_ind, ww.dt2, ww.id_person, p.dat_ind as dat_prev, p.value as val_prev, i.value, i.dat_ind ,i.carry, \
  CASE WHEN (coalesce(dt_insp, '1990-01-01'::::date) >=coalesce(dt_work, '1990-01-01'::::date) ) THEN p_insp.value ELSE ww.value END as ind, \
  ww.name as work,ww.id_position, ih.id_position as id_position2, p_insp.dt as dt1, p_insp.id_person as insp_id_person, \
  i.num_eqp, i.kind_energy, i.id_zone, i.coef_comp, i.dt_change, b.dt as dt_bill, b.date_transmis \
  from acd_indication_tbl as i \
     join acm_headindication_tbl as h on (h.id_doc = i.id_doc) \
     left join ( select  i.* from  acd_indication_tbl i order by id ) as p on (p.id=i.id_previndic  ) \
     left join acm_inspectstr_tbl as p_insp on (p_insp.id=i.id_inspect and p_insp.dt_insp >p.dat_ind and p_insp.value is not null) \
     left join acm_inspecth_tbl as ih on (ih.id_doc = p_insp.id_doc) \
     left join \
     ( select wi.id, w.dt_work, wi.value, wt.name, w.id_position,w.dt as dt2,w.id_person \
       from clm_work_indications_tbl as wi \
       join clm_works_tbl as w on (w.id = wi.id_work) \
       join cli_works_tbl as wt on (wt.id = w.id_type) \
     ) as ww on (ww.id = i.last_work_ind_id and ww.dt_work >p.dat_ind and ww.value is not null) \
     left join acm_bill_tbl as b on (b.id_ind = h.id_doc and b.id_pref =10 ) \
  where i.mmgg = :mmgg \
  and (p_insp.id is not null or ww.id is not null) \
  and h.idk_document = 310 \
  ) as s1 \
  where (ind > value)  \
  ) as sss \
  join clm_client_tbl as c on (c.id = sss.id_client) \
  left join clm_position_tbl as cp on (sss.id_position = cp.id) \
  left join clm_position_tbl as cp2 on (sss.id_position2 = cp2.id) \
  left join clm_position_tbl as cp3 on (sss.id_person = cp3.id) \
  left join clm_position_tbl as cp4 on (insp_id_person = cp4.id) \
  left join eqk_energy_tbl as en on (sss.kind_energy = en.id) \
  left join eqk_zone_tbl as zz on (sss.id_zone = zz.id) \
  where dem < ind_dem ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

//  if (inspector != 0)
//    ZQXLReps->ParamByName("pos")->AsInteger=inspector;
//  else
//    ZQXLReps->ParamByName("pos")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="linsp";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "За "+FormatDateTime("mmmm yyyy",dtBegin->Date);//+" - "+  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


//  if (InspectorId!=0)
//    xlReport->ParamByName["linsp"]->Value = "Інспектор "+edInspector->Text;
//  else
//    xlReport->ParamByName["linsp"]->Value = " ";

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------

void TfReports::Print3NKRE(boolean Build,TDateTime dtb,TDateTime dte)
{

  Word year1;
  Word month1;
  Word day1;
  DecodeDate(dtb,year1,month1,day1);

  if (Build)
  {
  AnsiString sqlstr="select rep_3nkre_fun( :dtb, :dte, 1);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQReps->ParamByName("dte")->AsDateTime=dte;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  if (month1!=1)
  {
   sqlstr="select rep_3nkre_fun( :dtb, :dte, 2);";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("dtb")->AsDateTime=EncodeDate(year1,1,1);
   ZQReps->ParamByName("dte")->AsDateTime=dte;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  }
/*
  AnsiString sqlstr=" select cla.id,case when r3.ident = 2 then 'Всього '||cla.name else cla.name end as name, r3.ident, \
  r3.class, round(r3.demand_val/1000) as demand , r3.sum_val, round(r3.saldo_b/1000,1) as saldo_b, round(r3.sum_pay/1000,1) as pay , \
  (select stcl.okpo_num from clm_statecl_tbl as stcl where stcl.id_section = cla.id limit 1) as okpo_num \
  from rep_3nkre_tbl as r3 \
  join cla_param_tbl as cla on ( r3.id_client = cla.id and cla.id_group = 200) \
  where mode = 1 \
  order by cla.name, r3.ident, r3.class; "  ;
*/

  AnsiString sqlstr=" select cla.id,case when r3.ident = 2 then 'Всього '||cla.name else cla.name end as name, r3.ident, \
  r3.class, r3.demand_val as demand , r3.sum_val, r3.sum_tax, r3.saldo_b, r3.sum_pay as pay , \
  (select stcl.okpo_num from clm_statecl_tbl as stcl where stcl.id_section = cla.id limit 1) as okpo_num \
  from rep_3nkre_tbl as r3 \
  join cla_param_tbl as cla on ( r3.id_client = cla.id and cla.id_group = 200) \
  where mode = 1 \
  order by cla.name, r3.ident, r3.class; "  ;

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr);
/*
  AnsiString sqlstr2=" select * from \
  (select sum(CASE WHEN class=1 THEN round(demand_val/1000) ELSE 0 END) as demand1, \
          sum(CASE WHEN class=2 THEN round(demand_val/1000) ELSE 0 END) as demand2, \
          sum(CASE WHEN class=1 THEN round(sum_val/1000,1)+ round(sum_val/5000,1) ELSE 0 END) as sum1, \
          sum(CASE WHEN class=2 THEN round(sum_val/1000,1)+ round(sum_val/5000,1) ELSE 0 END) as sum2, \
          sum(CASE WHEN class=1 THEN round(sum_val/5000,1) ELSE 0 END) as sumtax1, \
          sum(CASE WHEN class=2 THEN round(sum_val/5000,1) ELSE 0 END) as sumtax2, \
          sum(round(saldo_b/1000,1)) as saldo_b, \
          sum(round(sum_pay/1000,1)) as pay \
          from rep_3nkre_tbl as r3 where mode = 1  ) as s1, \
  (select sum(CASE WHEN class=1 THEN round(demand_val/1000) ELSE 0 END) as demand1_year, \
          sum(CASE WHEN class=2 THEN round(demand_val/1000) ELSE 0 END) as demand2_year, \
          sum(CASE WHEN class=1 THEN round(sum_val/1000,1)+ round(sum_val/5000,1) ELSE 0 END) as sum1_year, \
          sum(CASE WHEN class=2 THEN round(sum_val/1000,1)+ round(sum_val/5000,1) ELSE 0 END) as sum2_year, \
          sum(CASE WHEN class=1 THEN round(sum_val/5000,1) ELSE 0 END) as sumtax1_year, \
          sum(CASE WHEN class=2 THEN round(sum_val/5000,1) ELSE 0 END) as sumtax2_year, \
          sum(round(saldo_b/1000,1)) as saldo_b_year, \
          sum(round(sum_pay/1000,1)) as pay_year\
          from rep_3nkre_tbl as r3 where mode = :mode ) as sy ;";
*/

  AnsiString sqlstr2=" select * from \
  (select sum(CASE WHEN class=1 THEN demand_val ELSE 0 END) as demand1, \
          sum(CASE WHEN class=2 THEN demand_val ELSE 0 END) as demand2, \
          sum(CASE WHEN class=1 THEN sum_val+sum_tax ELSE 0 END) as sum1, \
          sum(CASE WHEN class=2 THEN sum_val+sum_tax ELSE 0 END) as sum2, \
          sum(CASE WHEN class=1 THEN sum_tax ELSE 0 END) as sumtax1, \
          sum(CASE WHEN class=2 THEN sum_tax ELSE 0 END) as sumtax2, \
          sum(saldo_b) as saldo_b, \
          sum(sum_pay) as pay \
          from rep_3nkre_tbl as r3 where mode = 1  ) as s1, \
  (select sum(CASE WHEN class=1 THEN demand_val ELSE 0 END) as demand1_year, \
          sum(CASE WHEN class=2 THEN demand_val ELSE 0 END) as demand2_year, \
          sum(CASE WHEN class=1 THEN sum_val+ sum_tax ELSE 0 END) as sum1_year, \
          sum(CASE WHEN class=2 THEN sum_val+ sum_tax ELSE 0 END) as sum2_year, \
          sum(CASE WHEN class=1 THEN sum_tax ELSE 0 END) as sumtax1_year, \
          sum(CASE WHEN class=2 THEN sum_tax ELSE 0 END) as sumtax2_year, \
          sum(saldo_b) as saldo_b_year, \
          sum(sum_pay) as pay_year\
          from rep_3nkre_tbl as r3 where mode = :mode ) as sy ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);

  if (month1!=1)
  {
   ZQXLReps2->ParamByName("mode")->AsInteger=2;
  }
  else
  {
   ZQXLReps2->ParamByName("mode")->AsInteger=1;
  }

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="lcaption";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

 // xlReport->ParamByName["lcaption"]->Value = edFiderName->Text;

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
 // xlReport->MacroAfter = "";

 ZQXLReps->Close();
 ZQXLReps2->Close();

}
//-----------------------------------------------------------------------------
void TfReports::ObSaldoTransit(boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(dtBegin->Date,year1,month1,day1);
  DecodeDate(dtEnd->Date,year2,month2,day2);

  AnsiString sqlstr;

  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям
  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (select coalesce(roz,999)as link, sum(nar) as snar, \
     sum(nar_v) as snar_v, sum(opl_zv) as sopl_zv, \
     sum(nar_pdv) as snar_n, sum(opl_zpdv) as sopl_n, \
     -sum(deb_zpmv) as sdeb, sum(kr_zpmv) as skr_zpmv, \
     -sum(deb_kmv) as sdeb_k, sum(kr_zkmv) as skr_zkmv, \
     -sum(deb_zpmpdv) as sdebn, sum(kr_zpmpdv) as skr_zpmn, \
     -sum(deb_kmpdv) as sdeb_kn, sum(kr_zkmpdv) as skr_zkmn, \
     sum(dem1) as sdem1, sum(dem2) as sdem2, sum(sum_val1) as sum_val1, sum(sum_val2) as sum_val2 \
     from \
    ( select obr.roz ,obr.osob_r, \
     nar, nar_v,opl_zv, nar_pdv , opl_zpdv , \
     deb_zpmv , kr_zpmv, deb_kmv ,kr_zkmv, \
     deb_zpmpdv ,kr_zpmpdv , deb_kmpdv ,kr_zkmpdv , \
     dem1, dem2, sum_val1, sum_val2 \
     from %obrtable as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    left join (select b.id_client, sum(bs.demand_val)::::numeric as dem1, sum(bs.sum_val)::::numeric as sum_val1 \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
    join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
    join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
    where b.id_pref= :pref and tcl.ident = 'tcl1' and b.mmgg = :mmgg\
    group by b.id_client ) as bs1 on (bs1.id_client = obr.id_client) \
    left join (select b.id_client, sum(bs.demand_val)::::numeric as dem2, sum(bs.sum_val)::::numeric as sum_val2 \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
    join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
    join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
    where b.id_pref= :pref and tcl.ident = 'tcl2' and b.mmgg = :mmgg \
    group by b.id_client ) as bs2 on (bs2.id_client = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
    ) as ss \
    group by ss.roz ) as sss \
    join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;

  // по потребителям
  AnsiString  sqlstr1="  select coalesce(obr.roz,999) as link ,obr.osob_r,obr.osob_rsk as abon_name, \
     nar, nar_v,opl_zv, nar_pdv as nar_n, opl_zpdv as opl_n, \
     -deb_zpmv as deb, kr_zpmv, -deb_kmv as deb_k,kr_zkmv, \
     -deb_zpmpdv as debn, kr_zpmpdv as kr_zpmn, \
     -deb_kmpdv as deb_kn,kr_zkmpdv as kr_zkmn, \
     dem1, dem2, sum_val1, sum_val2 \
     from %obrtable as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    left join (select b.id_client, sum(bs.demand_val)::::numeric as dem1, sum(bs.sum_val)::::numeric as sum_val1 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where b.id_pref= :pref and tcl.ident = 'tcl1' and b.mmgg = :mmgg \
  group by b.id_client ) as bs1 on (bs1.id_client = obr.id_client) \
  left join (select b.id_client, sum(bs.demand_val)::::numeric as dem2, sum(bs.sum_val)::::numeric as sum_val2 \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  where b.id_pref= :pref and tcl.ident = 'tcl2' and b.mmgg = :mmgg \
  group by b.id_client ) as bs2 on (bs2.id_client = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";


  // Итог
  AnsiString  sqlstr3=" select sum(nar) as snar, \
     sum(nar_v) as snar_v, sum(opl_zv) as sopl_zv, \
     sum(nar_pdv) as snar_n, sum(opl_zpdv) as sopl_n, \
     -sum(deb_zpmv) as sdeb, sum(kr_zpmv) as skr_zpmv, \
     -sum(deb_kmv) as sdeb_k, sum(kr_zkmv) as skr_zkmv, \
     -sum(deb_zpmpdv) as sdebn, sum(kr_zpmpdv) as skr_zpmn, \
     -sum(deb_kmpdv) as sdeb_kn, sum(kr_zkmpdv) as skr_zkmn, \
     sum(dem1) as sdem1, sum(dem2) as sdem2, sum(sum_val1) as sum_val1, sum(sum_val2) as sum_val2 \
     from \
    ( select obr.roz ,obr.osob_r, \
     nar, nar_v,opl_zv, nar_pdv , opl_zpdv , \
     deb_zpmv , kr_zpmv, deb_kmv ,kr_zkmv, \
     deb_zpmpdv ,kr_zpmpdv , deb_kmpdv ,kr_zkmpdv , \
     dem1, dem2, sum_val1, sum_val2 \
     from %obrtable as obr join clm_client_tbl as c on (c.id = obr.id_client) \
    left join (select b.id_client, sum(bs.demand_val)::::numeric as dem1, sum(bs.sum_val)::::numeric as sum_val1 \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
    join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
    join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
    where b.id_pref= :pref and tcl.ident = 'tcl1' and b.mmgg = :mmgg\
    group by b.id_client ) as bs1 on (bs1.id_client = obr.id_client) \
    left join (select b.id_client, sum(bs.demand_val)::::numeric as dem2, sum(bs.sum_val)::::numeric as sum_val2 \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
    join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
    join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
    where b.id_pref= :pref and tcl.ident = 'tcl2' and b.mmgg = :mmgg \
    group by b.id_client ) as bs2 on (bs2.id_client = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
    ) as ss; ";

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum2->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum2->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum2->ParamByName("pref")->AsInteger=120;


  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
    ZQXLRepsSum2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsSum2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());



  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);


  if (kind_energy==0)
  {
    xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за активну електроенергію";
    xlReport->ParamByName["demcaption"]->Value = "Спожито, кВтг";
  }
  if (kind_energy==1)
  {
    xlReport->ParamByName["caption"]->Value = "Оборотна відомість розрахунків за реактивну електроенергію";
    xlReport->ParamByName["demcaption"]->Value = "Обсяги перетікання, кВАрг";
  }


  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLRepsSum2->Close(); 

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonPower(TDateTime dt)
{

  AnsiString sqlstr = " select c.id,c.code,c.name,short_name,doc_dat,doc_num,flag_budjet,id_section,addr_tax, addr_main,sc.phone, \
  licens_num,okpo_num,tax_num, period_indicat,dt_indicat,dt_start,day_pay_bill,sc.phone,month_indicat,sc.id_position,id_kur,id_depart , \
  flag_taxpay,id_section,flag_key,grp.name as gp_name, a.adr , pwr, safe_cat \
  from clm_client_tbl as c \
  join clm_statecl_h as sc on (c.id = sc.id_client) \
  left join cla_param_tbl as grp on (grp.id = sc.id_section) \
  left join adv_address_tbl as a on (a.id = c.id_addres) \
  left join \
  ( \
   select id, sum(power) as pwr, trim(sum( distinct safe_category::::varchar||','),',') as safe_cat from \
   ( \
    select distinct c.id, p.code_eqp, p.power,p.safe_category \
    from eqm_tree_h as tr \
    join (select id, max(dt_b) as dt from eqm_tree_h  where dt_b <=  :dt and coalesce(dt_e, :dt) >=  :dt group by id order by id) as tr2 on (tr.id = tr2.id and tr2.dt = tr.dt_b) \
    join eqm_eqp_tree_h as ttr on (tr.id = ttr.id_tree) \
    join (select code_eqp, max(dt_b) as dt from eqm_eqp_tree_h  where dt_b <=  :dt and coalesce(dt_e, :dt) >=  :dt group by code_eqp order by code_eqp) as ttr2 on (ttr.code_eqp = ttr2.code_eqp and ttr2.dt = ttr.dt_b) \
    join eqm_point_h as p on (ttr.code_eqp = p.code_eqp) \
    join (select code_eqp, max(dt_b) as dt from eqm_point_h  where dt_b <=  :dt and coalesce(dt_e, :dt) >=  :dt group by code_eqp order by code_eqp) as p2 on (p.code_eqp = p2.code_eqp and p2.dt = p.dt_b) \
    left join \
    ( select u1.code_eqp,u1.id_client  from eqm_eqp_use_h as u1 \
       join (select code_eqp, max(dt_b) as dt from eqm_eqp_use_h  where dt_b <=  :dt and coalesce(dt_e, :dt) >=  :dt group by code_eqp order by code_eqp ) as u2 \
     on (u1.code_eqp = u2.code_eqp and u2.dt = u1.dt_b) \
    ) as use on (use.code_eqp = p.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
    where scl.id_section not in (205,206,207,208) \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and coalesce(p.share,0) = 0 \
    and c.book=-1 \
   ) as psss \
   group by id \
  ) as powersss on (powersss.id = c.id) \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and coalesce(sc.id_section,0) not in (0,205,206,207,208) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :dt::::date ) ) \
  order by c.code;";

  ZQXLReps->Sql->Add(sqlstr);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();

  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintMeterCheckChanges(TDateTime dtb,TDateTime dte, int id_client)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1="select sss1.*, eq.name_eqp, adr.adr, e.name as energy,z.name as zone, id_doc as link, m1.type , m2.type as type2 ,  c.code, c.short_name, \
       CASE WHEN dt_control is not null THEN dt_control + (text(m1.term_control)||' year')::::interval ELSE NULL END as newcontrol \
  from \
 ( select id_client, id_doc, id_meter, id_point, kind_energy, id_zone , ss1.num_eqp, ss1.id_typemet, ss1.value, ss1.prev_value  , ss1.coef_comp, ss1.dt_control, \
     ss2.num_eqp as num_eqp2, ss2.id_typemet as id_typemet2, ss2.value as value2, ss2.coef_comp as coef_comp2 , coalesce(ss1.date_end,ss2.date_end) as date_end \
     from \
(  select distinct i.id_doc,i.id_client, i.date_end,dind.id_meter, mp.id_point, dind.id_previndic, dind.num_eqp, dind.id_typemet,dind.kind_energy, dind.id_zone, dind.value, prind.value as prev_value , dind.coef_comp, mm.dt_control \
  from acm_headindication_tbl as i \
  left join dci_document_tbl as dk on (i.idk_document = dk.id) \
  left join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  left join acd_indication_tbl as prind on (prind.id = dind.id_previndic) \
  left join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  left join eqm_meter_h as mm on (mm.code_eqp = dind.id_meter and mm.dt_b<i.reg_date and mm.dt_e >= i.date_end) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and dind.id_previndic is not null \
) as ss1 \
full outer join \
(  select distinct i.id_doc,i.id_client , i.date_end ,dind.id_meter, mp.id_point, dind.num_eqp, dind.id_typemet, dind.kind_energy, dind.id_zone, dind.value, dind.coef_comp  \
  from acm_headindication_tbl as i \
  left join dci_document_tbl as dk on (i.idk_document = dk.id) \
  left join acd_indication_tbl as dind on (i.id_doc = dind.id_doc) \
  left join eqm_meter_point_h as mp on (mp.id_meter = dind.id_meter and mp.dt_b<=i.reg_date and coalesce(mp.dt_e,i.date_end) >= i.date_end) \
  where dk.ident = 'chn_cnt' and i.date_end >= :dtb and i.date_end <= :dte and dind.id_previndic is null \
) as ss2 \
 using(id_client,id_doc, id_meter, id_point, kind_energy, id_zone) \
) as sss1 \
join eqm_equipment_h as eq on ( eq.id  = sss1.id_point ) \
join eqk_energy_tbl as e on (e.id = kind_energy) \
join eqk_zone_tbl as z on (z.id = id_zone) \
join clm_client_tbl as c on (c.id = sss1.id_client) \
left join adv_address_tbl as adr on ( adr.id  = eq.id_addres ) \
left join eqi_meter_tbl as m1 on (m1.id = id_typemet) \
left join eqi_meter_tbl as m2 on (m2.id = id_typemet2)\
where eq.dt_b = (select max(dt_b) from eqm_equipment_h where id = eq.id and dt_b < date_end  ) \
  and (c.id = :client or :client = 0) \
  and sss1.num_eqp is not null and dt_control is not null \
  and dt_control + (text(m1.term_control)||' year')::::interval <=sss1.date_end \
order by c.code, date_end, id_point, id_meter ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("client")->AsInteger=id_client;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
    FormatDateTime("dd.mm.yyyy",dtEnd->Date);
  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

 xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::Fider_monitoring(TDateTime dtb,TDateTime dte, boolean Build)
{

  if (Build)
  {

  if(MessageDlg("Переформировать данные ?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select rep_fidermonitor_fun( :dtb::::date, :dte::::date ) ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("dtb")->AsDateTime=dtb;
    ZQReps->ParamByName("dte")->AsDateTime=dte;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }


  AnsiString sqlstr2 =" select h.*, cp.represent_name , f.name as fider , plan.* \
    FROM rep_fider_monitor_tmp  as h \
    join bal_grp_tree_tbl as f on (f.code_eqp = h.id_fider ) \
    left join clm_position_tbl as cp on (cp.id = h.id_position) \
    left join ( \
        select id_fider, \
        round(sum(CASE WHEN id_type = 1 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan1, \
        round(sum(CASE WHEN id_type = 2 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan2, \
        round(sum(CASE WHEN id_type = 3 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan3, \
        round(sum(CASE WHEN id_type = 4 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan4, \
        round(sum(CASE WHEN id_type = 5 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan5, \
        round(sum(CASE WHEN id_type = 6 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan6, \
        round(sum(CASE WHEN id_type = 7 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan7, \
        round(sum(CASE WHEN id_type = 8 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan8, \
        round(sum(CASE WHEN id_type = 9 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan9, \
        round(sum(CASE WHEN id_type = 10 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan10, \
        round(sum(CASE WHEN id_type = 11 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan11, \
        round(sum(CASE WHEN id_type = 12 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan12, \
        round(sum(CASE WHEN id_type = 13 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan13, \
        round(sum(CASE WHEN id_type = 14 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan14, \
        round(sum(CASE WHEN id_type = 15 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan15, \
        round(sum(CASE WHEN id_type = 16 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan16, \
        round(sum(CASE WHEN id_type = 17 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan17, \
        round(sum(CASE WHEN id_type = 18 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan18, \
        round(sum(CASE WHEN id_type = 19 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan19, \
        round(sum(CASE WHEN id_type = 20 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan20, \
        round(sum(CASE WHEN id_type = 21 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan21, \
        round(sum(CASE WHEN id_type = 22 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan22, \
        round(sum(CASE WHEN id_type = 23 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan23, \
        round(sum(CASE WHEN id_type = 24 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan24, \
        round(sum(CASE WHEN id_type = 25 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan25, \
        round(sum(CASE WHEN id_type = 26 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,0) as plan26, \
        round(sum(CASE WHEN id_type = 27 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,2)  as plan27, \
        round(sum(CASE WHEN id_type = 28 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ) ,2) as plan28, \
        round(sum(CASE WHEN id_type = 29 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan29, \
        round(sum(CASE WHEN id_type = 30 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan30, \
        round(sum(CASE WHEN id_type = 31 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan31, \
        round(sum(CASE WHEN id_type = 32 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan32, \
        round(sum(CASE WHEN id_type = 33 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan33, \
        round(sum(CASE WHEN id_type = 34 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan34, \
        round(sum(CASE WHEN id_type = 35 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),0)  as plan35, \
        round(sum(CASE WHEN id_type = 36 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),2)  as plan36, \
        round(sum(CASE WHEN id_type = 37 THEN cnt*cal_minutes_fun(date_larger(mmgg,:dtb::::date ), date_smaller((mmgg+'1 month - 1 days'::::interval)::::date, :dte::::date))::::numeric/ \
        	cal_minutes_fun(mmgg , mmgg+'1 month - 1 days'::::interval) ELSE 0 END ),2)  as plan37 \
        from mnm_plan_works_tbl \
        where mmgg >= date_trunc('month',:dtb::::date) and mmgg <= date_trunc('month',:dte::::date) \
        group by id_fider \
     ) as plan on (plan.id_fider = h.id_fider) \
    where f.mmgg =  (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :dte::::date and code_eqp <0)\
    and h.mmgg = :dtb::::date \
    order by cp.represent_name , f.name ; " ;



  ZQXLReps->Close();
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add( sqlstr2 );
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  AnsiString caption = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date) ;

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  Word year3;
  Word month3;
  Word day3;

  DecodeDate(dtb,year1,month1,day1);
  DecodeDate(dte,year2,month2,day2);
  DecodeDate(dte+1,year3,month3,day3);

  if((month1 == month2)&&(day1 ==1)&&(day3==1))
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtb);
  }
  else
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yyyy",dtb)+" - "+
     FormatDateTime("dd.mm.yyyy",dte);
  }


  xlReport->Report();

 ZQXLReps->Close();

}
//-----------------------------------------------------------------------------

void TfReports::Fider_monitoring_2periods(TDateTime dtb,TDateTime dte, TDateTime dtb2,TDateTime dte2, boolean Build)
{

  if (Build)
  {
   if(MessageDlg("Переформировать данные ?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    AnsiString sqlstr="select rep_fidermonitor_fun( :dtb::::date, :dte::::date ) ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("dtb")->AsDateTime=dtb;
    ZQReps->ParamByName("dte")->AsDateTime=dte;

    try
    {
      ZQReps->ExecSql();
    }
    catch(...)
    {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
    }

    ZQReps->Close();
    ZQReps->ParamByName("dtb")->AsDateTime=dtb2;
    ZQReps->ParamByName("dte")->AsDateTime=dte2;

    try
    {
      ZQReps->ExecSql();
    }
    catch(...)
    {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
    }

   }
  }


  AnsiString sqlstr2 =" select h.*, cp.represent_name , f.name as fider, \
        h2.pwr_limit_set	   as pwr_limit_set2,   \
        h2.work_tp                 as work_tp2      ,   \
        h2.work_tp_fiz             as work_tp_fiz2  ,   \
        h2.work_co                 as work_co2      ,   \
        h2.work_co_fiz             as work_co_fiz2  ,   \
        h2.work_meterch            as work_meterch2 ,   \
        h2.work_meterch_fiz        as work_meterch_fiz2,\
        h2.work_closing            as work_closing2 ,   \
        h2.work_meter_new          as work_meter_new2,  \
        h2.work_meter_new_res      as work_meter_new_res2,\
        h2.work_meter_new_fiz      as work_meter_new_fiz2,\
        h2.raid_count              as raid_count2,      \
        h2.pkee_count              as pkee_count2,      \
        h2.pkee_count_fiz          as pkee_count_fiz2 , \
        h2.pkee_demand             as pkee_demand2,     \
        h2.work_reserve_inspect    as work_reserve_inspect2,\
        h2.work_pwr_inspect        as work_pwr_inspect2,\
        h2.work_pwrre_inspect      as work_pwrre_inspect2,\
        h2.work_limit_plan         as work_limit_plan2,\
        h2.work_measurings         as work_measurings2,\
        h2.work_1kcheck            as work_1kcheck2,   \
        h2.work_indication         as work_indication2,\
        h2.work_indication_fiz     as work_indication_fiz2,\
        h2.work_bill_fiz           as work_bill_fiz2 , \
        h2.work_inspect_EAT        as work_inspect_EAT2,\
        h2.work_inspect_PKEE       as work_inspect_PKEE2,\
        h2.work_new_obj            as work_new_obj2,   \
        h2.work_repair_obj         as work_repair_obj2,\
        h2.work_new_obj_fiz        as work_new_obj_fiz2,\
        h2.work_repair_obj_fiz     as work_repair_obj_fiz2,\
        h2.work_warning            as work_warning2,   \
        h2.work_warning_fiz        as work_warning_fiz2,\
        h2.work_disconnect         as work_disconnect2, \
        h2.work_disconnect_fiz     as work_disconnect_fiz2,\
        h2.work_reconnect          as work_reconnect2,  \
        h2.work_reconnect_fiz      as work_reconnect_fiz2,\
        h2.bill_count              as bill_count2,      \
        h2.bill_count_fiz          as bill_count_fiz2,  \
        h2.work_doc_PKEE           as work_doc_PKEE2,   \
        h2.work_doc_PKEE_fiz       as work_doc_PKEE_fiz2,\
        h2.work_ps_teplo           as work_ps_teplo2,    \
        h2.work_ps_defect          as work_ps_defect2,   \
        h2.work_ps_defect_fail     as work_ps_defect_fail2,\
        h2.work_ps_defect_adv      as work_ps_defect_adv2, \
        h2.work_repair_teplo       as work_repair_teplo2,  \
        h2.work_clear_al10         as work_clear_al102,    \
        h2.work_clear_al04         as work_clear_al042,    \
        h2.work_ps_kap             as work_ps_kap2,        \
        h2.work_comp_change_s      as work_comp_change_s2, \
        h2.work_comp_change_g      as work_comp_change_g2, \
        h2.work_phase_meas         as work_phase_meas2,    \
        h2.work_clamp              as work_clamp2,         \
        h2.work_ti_check           as work_ti_check2,      \
        h2.work_cable_repl         as work_cable_repl2,    \
        h2.work_al10_repl          as work_al10_repl2,     \
        h2.work_al04_repl          as work_al04_repl2   \
    FROM rep_fider_monitor_tmp  as h \
    join rep_fider_monitor_tmp  as h2 on (h.id_fider = h2.id_fider) \
    join bal_grp_tree_tbl as f on (f.code_eqp = h.id_fider ) \
    left join clm_position_tbl as cp on (cp.id = h.id_position) \
    where f.mmgg = (select max(mmgg) from bal_grp_tree_tbl where mmgg <= :dte::::date and code_eqp <0) \
    and h.mmgg = :dtb::::date and h2.mmgg = :dtb2::::date \
    order by cp.represent_name , f.name ; " ;

  ZQXLReps->Close();
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add( sqlstr2 );
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dtb2")->AsDateTime=dtb2;

  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg2";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  AnsiString caption = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
//  FormatDateTime("dd.mm.yyyy",dtEnd->Date) ;

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  Word year3;
  Word month3;
  Word day3;

  DecodeDate(dtb,year1,month1,day1);
  DecodeDate(dte,year2,month2,day2);
  DecodeDate(dte+1,year3,month3,day3);

  if((month1 == month2)&&(day1 ==1)&&(day3==1))
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtb);
  }
  else
  {
    xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yyyy",dtb)+" - "+
     FormatDateTime("dd.mm.yyyy",dte);
  }


  DecodeDate(dtb2,year1,month1,day1);
  DecodeDate(dte2,year2,month2,day2);
  DecodeDate(dte2+1,year3,month3,day3);

  if((month1 == month2)&&(day1 ==1)&&(day3==1))
  {
    xlReport->ParamByName["lmmgg2"]->Value = FormatDateTime("mmmm yyyy",dtb2);
  }
  else
  {
    xlReport->ParamByName["lmmgg2"]->Value = FormatDateTime("dd.mm.yyyy",dtb2)+" - "+
     FormatDateTime("dd.mm.yyyy",dte2);
  }

  xlReport->Report();

 ZQXLReps->Close();

}
//-----------------------------------------------------------------------------


void TfReports::MeterIndicationList(TDateTime dt,int client, int fider, int inspector )
{
  AnsiString  sqlstr1="  select ssss.*, cp2.represent_name, \
case when id_voltage1 in (3,31,32) and type_eqp = 15 then code_eqp1 \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END as code_f10, \
case when id_voltage1 in (3,31,32) and type_eqp = 15 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2   END as name_f10, \
case when id_voltage1 in (3,31,32) and type_eqp = 8 then code_eqp1 \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2  END as code_ps10, \
case when id_voltage1 in (3,31,32) and type_eqp = 8 then grpname \
     when id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2   END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , ee2.name_eqp as grpname2, \
  gr1.type_eqp, gr1.code_eqp as code_eqp1, gr1.id_voltage as id_voltage1 , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2 \
  from ( \
  select c.code, c.id, c.short_name ,indic.* ,eqpp.name_eqp, adr.adr , im.type, ba.id_grp as link , mp.id_point  \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqk_phase_tbl as pim on (im.phase=pim.id) \
    join eqk_meter_tbl as tim on (im.kind_meter=tim.id) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_equipment_tbl as eqpp on (mp.id_point = eqpp.id) \
    left join adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
    left join ( \
	select ind.*, ke.name as energy, kz.name as zone , h.reg_date, h.reg_num, dk.name as doc_name \
                from acd_indication_tbl as ind join ( \
		select id_meter, num_eqp, id_zone,kind_energy, max(dat_ind) as dat from acd_indication_tbl \
		where dat_ind <= :dt and value is not null group by id_meter, num_eqp, id_zone,kind_energy \
		) as i \
	on  (i.id_meter=ind.id_meter \
		and i.num_eqp=ind.num_eqp \
		and i.id_zone=ind.id_zone and i.kind_energy=ind.kind_energy \
		and i.dat = ind.dat_ind ) \
	join eqk_energy_tbl as ke on (ke.id = ind.kind_energy ) \
	join eqk_zone_tbl as kz on (kz.id = ind.id_zone ) \
	join acm_headindication_tbl as h on (h.id_doc = ind.id_doc) \
	join dci_document_tbl as dk on (h.idk_document = dk.id) \
	) as indic \
        on  (m.code_eqp=indic.id_meter and eq.num_eqp = indic.num_eqp) \
    left join bal_abons_tbl as ba  on (mp.id_point = ba.id_point) \
    where ( c.id = :client or :client is null ) and coalesce(c.id_state,0) not in (50,99) \
    order by mp.id_point \
   ) as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when id_voltage1 in (3,31,32) and type_eqp = 15 then code_eqp1 \
     when id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2  END ) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  where (( ff.code_eqp = :fider) or ( :fider = 0 )) and ( :insp is null or ff.id_position = :insp) \
  order by  represent_name ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  ZQXLReps->ParamByName("fider")->AsInteger=fider;

  if (client!=0)
     ZQXLReps->ParamByName("client")->AsInteger=client;
  else
     ZQXLReps->ParamByName("client")->Clear();

  if (inspector!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=inspector;
  else
     ZQXLReps->ParamByName("insp")->Clear();

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lfider";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = "На "+FormatDateTime("dd.mm.yyyy",dt);

  AnsiString comment = "";

  if (InspectorId!=0)
    comment = "Інспектор "+edInspector->Text+";";

  if (FiderId!=0)
    comment = comment+ "Фідер "+edFiderName->Text+";";

  if (client!=0)
    comment = comment+ "Абонент "+edAbonName->Text+";";

  xlReport->ParamByName["lfider"]->Value = comment;

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbDec_2Click(TObject *Sender)
{
  WorkDate_2=IncMonth(WorkDate_2,-1);
  dtBegin_2->Date=WorkDate_2;
  dtEnd_2->Date=IncMonth(dtBegin_2->Date,1)-1;
  dtBegin_2->Time=0;
  dtEnd_2->Time=0;
  edMonth_2->Text=FormatDateTime("mmmm yyyy",WorkDate_2);
}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbInc_2Click(TObject *Sender)
{
  WorkDate_2=IncMonth(WorkDate_2,1);
  dtBegin_2->Date=WorkDate_2;
  dtEnd_2->Date=IncMonth(dtBegin_2->Date,1)-1;
  dtBegin_2->Time=0;
  dtEnd_2->Time=0;
  edMonth_2->Text=FormatDateTime("mmmm yyyy",WorkDate_2);
}
//---------------------------------------------------------------------------
void TfReports::PrintTaxList_Abon(TDateTime dtb,TDateTime dte, int client)
{

  if(client==0) return;
  
  AnsiString  sqlstr1="  select  cl.code,cl.short_name,s.type_tax, s.reg_num,s.reg_date, s.value, s.value_tax, p.name as pref, \
  CASE WHEN kind_calc =1 THEN 'рахунок'  WHEN kind_calc =2 THEN 'аванс' \
       WHEN kind_calc =3 THEN 'оплата'   WHEN kind_calc =4 THEN 'коригування' END as kind, \
  CASE WHEN flag_transmis =1 THEN 'Выдана' ELSE '' END as transmis \
  from ( \
   select t.id_client, 0::::int as type_tax,t.reg_num,t.int_num,t.reg_date, t.value, t.value_tax, kind_calc,flag_transmis, id_pref \
   from acm_tax_tbl as t  where \
    date_trunc('month',  :dtb::::date) <= date_trunc('month', t.reg_date) and date_trunc('month',  :dte::::date) >= date_trunc('month', t.reg_date) \
    and t.id_client = :client \
    union \
   select t.id_client,1::::int as type_tax, t.reg_num,0,t.reg_date, t.value, t.value_tax, 4 as kind_calc,flag_transmis, id_pref \
   from acm_taxcorrection_tbl as t  where \
    date_trunc('month',  :dtb::::date) <= date_trunc('month', t.reg_date) and date_trunc('month',  :dte::::date) >= date_trunc('month', t.reg_date) \
    and t.id_client = :client \
  ) as s  join clm_client_tbl as cl  on (cl.id = s.id_client)\
  join aci_pref_tbl as p on (p.id= s.id_pref)  \
  order by reg_date, int_num, reg_num ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  ZQXLReps->ParamByName("client")->AsInteger=client;


  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();

  AnsiString  sqlstr2="  select  c.code,c.name, sc.tax_num, '№ '||sc.doc_num ||' від '|| to_char(sc.doc_dat,'DD.MM.YYYY') as doc \
  from clm_client_tbl as c \
  join clm_statecl_h as sc on (c.id = sc.id_client) \
  where c.id = :client \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date ) ); ";

  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("client")->AsInteger=client;
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;

  try
  {
    ZQXLReps2->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["lnow"]->Value = Now();
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
          FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close(); 

}
//---------------------------------------------------------------------------
void TfReports::ShowRentDatesAll(void)
{
  AnsiString  sqlstr1=" SELECT clm.id as link, clm.short_name as name, clm.code, rh.name_object, rh.dt_rent_end,rh.comment \
  FROM clm_client_tbl as clm \
  join clm_statecl_h as scl on (clm.id = scl.id_client) \
  join clm_renthist_tbl as rh on (clm.id = rh.id_client) \
  where clm.book=-1 and clm.idk_work not in (0,99) and coalesce(clm.id_state,0) not in (50,99) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client ) \
  and scl.id_section not in (205,206,207,208) \
  and ( rh.dt_rent_end <= :dt or :show_all = 1 ) \
  order by rh.dt_rent_end, rh.name_object;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime= dtRDate ->Date;
  ZQXLReps->ParamByName("show_all")->AsInteger= (cbAll->Checked?1:0);

  AnsiString  sqlstr2=" SELECT distinct clm.id as link , clm.short_name as name, clm.code , scl.dt_end_rent , p.represent_name \
  FROM clm_client_tbl as clm \
  join clm_statecl_h as scl on (clm.id = scl.id_client) \
  join clm_renthist_tbl as rh on (clm.id = rh.id_client) \
  left join clm_position_tbl p on (scl.id_position=p.id ) \
  where clm.book=-1 and clm.idk_work not in (0,99) and coalesce(clm.id_state,0) not in (50,99) \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client  ) \
  and scl.id_section not in (205,206,207,208) \
  and ( rh.dt_rent_end <= :dt or :show_all = 1 ) \
  order by clm.code;";

// CASE WHEN scl.dt_end_rent = '1899-12-31' THEN null ELSE scl.dt_end_rent END as dt_end_rent \

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("dt")->AsDateTime= dtRDate ->Date;
  ZQXLRepsSum->ParamByName("show_all")->AsInteger= (cbAll->Checked?1:0);

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::MastersPowerDemand (TDateTime dtb,TDateTime dte, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_point_master_fun( :dt );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dte;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select sss.*, c.id,c.code,c.name,a.adr , powersss.pwr \
from ( \
select id_master_client, sum(kvt) as dem ,count(distinct mm.id_point) as cnt from \
(select distinct * from rep_point_master_tbl order by id_master_client,id_point) as mm \
join \
(select id_point, sum(demand_val) as kvt \
  from acd_billsum_tbl where mmgg >= :dtb  and  mmgg <= :dte and kind_energy=1 group by id_point order by id_point )as bs \
  on bs.id_point = mm.id_point \
  group by id_master_client \
) as sss \
  join  clm_client_tbl as c on (c.id = sss.id_master_client) \
  left join adv_address_tbl as a on (a.id = c.id_addres) \
  left join \
  ( \
   select id, sum(power) as pwr from \
   ( \
    select distinct c.id, p.code_eqp, coalesce(p.connect_power,p.power) as power \
    from eqm_tree_h as tr \
    join (select id, max(dt_b) as dt from eqm_tree_h  where dt_b <=  :dte and coalesce(dt_e, :dte) >=  :dte group by id order by id) as tr2 on (tr.id = tr2.id and tr2.dt = tr.dt_b) \
    join eqm_eqp_tree_h as ttr on (tr.id = ttr.id_tree) \
    join (select code_eqp, max(dt_b) as dt from eqm_eqp_tree_h  where dt_b <=  :dte and coalesce(dt_e, :dte) >=  :dte group by code_eqp order by code_eqp) as ttr2 on (ttr.code_eqp = ttr2.code_eqp and ttr2.dt = ttr.dt_b) \
    join eqm_point_h as p on (ttr.code_eqp = p.code_eqp) \
    join (select code_eqp, max(dt_b) as dt from eqm_point_h  where dt_b <=  :dte and coalesce(dt_e, :dte) >=  :dte group by code_eqp order by code_eqp) as p2 on (p.code_eqp = p2.code_eqp and p2.dt = p.dt_b) \
    left join \
    ( select u1.code_eqp,u1.id_client  from eqm_eqp_use_h as u1 \
       join (select code_eqp, max(dt_b) as dt from eqm_eqp_use_h  where dt_b <=  :dte and coalesce(dt_e, :dte) >=  :dte group by code_eqp order by code_eqp ) as u2 \
     on (u1.code_eqp = u2.code_eqp and u2.dt = u1.dt_b) \
    ) as use on (use.code_eqp = p.code_eqp) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and coalesce(p.share,0) = 0  and c.book=-1 \
   ) as psss \
   group by id \
  ) as powersss on (powersss.id = c.id) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) <> 50 \
  order by c.code ; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------
void TfReports::PrintTaxBookNew2011 (TDateTime dt_b)
{
/*
   AnsiString sqlstr=" update clm_statecl_tbl set tax_num='  '|| tax_num  WHERE length(tax_num)=10 ";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   };
*/

  AnsiString sqlstr=" select res.short_name as resname, \
  respar.tax_num as taxnum_res,respar.licens_num as SvidNum_res \
  from clm_client_tbl as res \
  left join clm_statecl_h as respar on (respar.id_client = res.id) \
  where res.id = syi_resid_fun() \
  and respar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as respar2 where respar2.id_client = respar.id_client and respar2.mmgg_b <= :mmgg::::date ) ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  ZQReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->Params->Clear();

  Param=xlReport->Params->Add();
  Param->Name="ResName_Addr";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum1";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum2";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum3";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum4";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum5";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum6";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum7";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum8";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum9";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum10";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum11";
  Param=xlReport->Params->Add();
  Param->Name="TaxNum12";
  Param=xlReport->Params->Add();
  Param->Name="lyear1";
  Param=xlReport->Params->Add();
  Param->Name="lyear2";
  Param=xlReport->Params->Add();
  Param->Name="lyear3";
  Param=xlReport->Params->Add();
  Param->Name="lyear4";
  Param=xlReport->Params->Add();
  Param->Name="lkvartal";
  Param=xlReport->Params->Add();
  Param->Name="lmonth1";
  Param=xlReport->Params->Add();
  Param->Name="lmonth2";

  Param=xlReport->Params->Add();
  Param->Name="SvidNumRes";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="buhname";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["buhname"]->Value = BuhName;

  AnsiString taxNum_res;
  Word year1;
  Word month1;
  Word day1;

  DecodeDate(dt_b,year1,month1,day1);

  AnsiString sdate = FormatDateTime("dd.mm.yyyy",dt_b);

  xlReport->ParamByName["lyear1"]->Value = AnsiString(sdate[7]);
  xlReport->ParamByName["lyear2"]->Value = AnsiString(sdate[8]);
  xlReport->ParamByName["lyear3"]->Value = AnsiString(sdate[9]);
  xlReport->ParamByName["lyear4"]->Value = AnsiString(sdate[10]);

  xlReport->ParamByName["lmonth1"]->Value = AnsiString(sdate[4]);
  xlReport->ParamByName["lmonth2"]->Value = AnsiString(sdate[5]);

  //xlReport->ParamByName["lkvartal"]->Value = floor((month1-1)/3)+1;
  xlReport->ParamByName["lkvartal"]->Value = " ";

  if (ZQReps->RecordCount>0)
   {
    ZQReps->First();

    xlReport->ParamByName["ResName_Addr"]->Value =  ZQReps->FieldByName("resname")->AsString;
//    xlReport->ParamByName["NumRes"]->Value = ZQReps->FieldByName("taxnum_res")->AsString;

    taxNum_res =  ZQReps->FieldByName("taxnum_res")->AsString.Trim();

    int len =taxNum_res.Length();
    for(int i = 0; i< (12-len); i++  ) {taxNum_res = taxNum_res+"-";}

    xlReport->ParamByName["TaxNum1"]->Value = AnsiString(taxNum_res[1]);
    xlReport->ParamByName["TaxNum2"]->Value = AnsiString(taxNum_res[2]);
    xlReport->ParamByName["TaxNum3"]->Value = AnsiString(taxNum_res[3]);
    xlReport->ParamByName["TaxNum4"]->Value = AnsiString(taxNum_res[4]);
    xlReport->ParamByName["TaxNum5"]->Value = AnsiString(taxNum_res[5]);
    xlReport->ParamByName["TaxNum6"]->Value = AnsiString(taxNum_res[6]);
    xlReport->ParamByName["TaxNum7"]->Value = AnsiString(taxNum_res[7]);
    xlReport->ParamByName["TaxNum8"]->Value = AnsiString(taxNum_res[8]);
    xlReport->ParamByName["TaxNum9"]->Value = AnsiString(taxNum_res[9]);
    xlReport->ParamByName["TaxNum10"]->Value = AnsiString(taxNum_res[10]);
    xlReport->ParamByName["TaxNum11"]->Value = AnsiString(taxNum_res[11]);
    xlReport->ParamByName["TaxNum12"]->Value = AnsiString(taxNum_res[12]);

    xlReport->ParamByName["SvidNumRes"]->Value = ZQReps->FieldByName("SvidNum_res")->AsString;

   }
  ZQReps->Close();

/*  if(dt_b< TDateTime(2010,1,1))
  {
   xlReport->ParamByName["caption"]->Value = " Реестр виданих податкових накладних за електроенергію за "+
      FormatDateTime("mmmm yyyy",dt_b);
  }
  else
  {
   xlReport->ParamByName["caption"]->Value = " Реестр отриманих та виданих податкових накладних за "+
      FormatDateTime("mmmm yyyy",dt_b);
  }
*/

  AnsiString  sqlstr1=" select * from ( \
  select t.int_num,0::::int as tax_type, t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN 'ПН' ELSE 'ПН02' END as tax_type_str, \
  CASE WHEN (scl.flag_taxpay = 0) and (t.mmgg < '2012-03-01'::::date) THEN cl.name ||' (постачання неплатнику податку)' \
       WHEN coalesce(trim(cl.add_name),'')<>'' THEN cl.add_name  ELSE cl.name END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE '0' END as tax_num, \
  CASE WHEN coalesce(t.pay_p,0)<>1999 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN coalesce(t.pay_p,0) =1999 THEN t.value ELSE 0 END as val_0 \
  from acm_tax_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and t.int_num <>0 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  union all \
  select t.int_num,1::::int as tax_type, t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN 'РК' ELSE 'РК02' END as tax_type_str, \
  CASE WHEN (scl.flag_taxpay = 0) and (t.mmgg < '2012-03-01'::::date) THEN cl.name ||' (постачання неплатнику податку)' \
       WHEN coalesce(trim(cl.add_name),'')<>'' THEN cl.add_name  ELSE cl.name END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE '0' END as tax_num, \
  CASE WHEN t.value_tax<>0 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN t.value_tax=0 THEN t.value ELSE 0 END as val_0 \
  from acm_taxcorrection_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  left join acm_tax_tbl tt on(tt.id_doc=t.id_tax)  \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and t.int_num <>0 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  ) as s order by substr(reg_num,1,position('/' in reg_num)-1 )::::int ";

//  ) as s order by reg_date,int_num,reg_num ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dt_b;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintTaxBookNew2011_Fast(TDateTime dt_b)
{

 AnsiString sqlstr=" select reg_num,reg_date, value, value_tax, \
  round(value/5,2) as calc_tax \
  from \
( select * from \
  (select t.reg_num,t.reg_date, t.value, t.value_tax \
   from acm_tax_tbl as t \
   where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
   and t.int_num <>0 \
  ) as t \
  union all \
  ( select t.reg_num,t.reg_date, t.value, t.value_tax \
    from acm_taxcorrection_tbl as t \
    where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
    and t.int_num <>0 \
  ) \
) as t2 \
  where ((round(value/5,2)-value_tax >0.050) or (round(value/5,2)- value_tax <-0.050))  ; ";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  ZQReps->ParamByName("dtb")->AsDateTime=dt_b;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  if (ZQReps->RecordCount>0)
   {
    ShowMessage("Обнаружены налоговые накладные, в которых фактическая сумма НДС \n отличается от расчетной больше чем на 5 копеек!");
   }
  ZQReps->Close();

  sqlstr=" select res.short_name as resname, \
  respar.tax_num as taxnum_res,respar.licens_num as SvidNum_res \
  from clm_client_tbl as res \
  left join clm_statecl_h as respar on (respar.id_client = res.id) \
  where res.id = syi_resid_fun() \
  and respar.mmgg_b = (select max(mmgg_b) from clm_statecl_h as respar2 where respar2.id_client = respar.id_client and respar2.mmgg_b <= :mmgg::::date ) ; ";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);

  ZQReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

  try
   {
    ZQReps->Open();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="ResName_Addr";
  Param=xlReport->Params->Add();
  Param->Name="NumRes";
  Param=xlReport->Params->Add();
  Param->Name="SvidNumRes";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmonth";
  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="buhname";



  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  if (ZQReps->RecordCount>0)
   {
    ZQReps->First();

    xlReport->ParamByName["ResName_Addr"]->Value =  ZQReps->FieldByName("resname")->AsString;
    xlReport->ParamByName["NumRes"]->Value = ZQReps->FieldByName("taxnum_res")->AsString;
    xlReport->ParamByName["SvidNumRes"]->Value = ZQReps->FieldByName("SvidNum_res")->AsString;
    xlReport->ParamByName["lmonth"]->Value = FormatDateTime("mmmm yyyy",dt_b);
   }
  ZQReps->Close();

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["buhname"]->Value = BuhName;

  AnsiString  sqlstr1=" select * from ( \
  select t.int_num,0::::int as tax_type, t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN 'ПН' ELSE 'ПН02' END as tax_type_str, \
  CASE WHEN (scl.flag_taxpay = 0) and (t.mmgg < '2012-03-01'::::date) THEN cl.name ||' (постачання неплатнику податку)' \
       WHEN coalesce(cl.add_name,'')<>'' THEN cl.add_name  ELSE cl.name END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE '0' END as tax_num, \
  CASE WHEN coalesce(t.pay_p,0)<>1999 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN coalesce(t.pay_p,0) =1999 THEN t.value ELSE 0 END as val_0 \
  from acm_tax_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and t.int_num <>0 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  union all \
  select t.int_num,1::::int as tax_type, t.reg_num,t.reg_date, t.value, t.value_tax, cl.code, \
  CASE WHEN scl.flag_taxpay = 1 THEN 'РК' ELSE 'РК02' END as tax_type_str, \
  CASE WHEN (scl.flag_taxpay = 0) and (t.mmgg < '2012-03-01'::::date) THEN cl.name ||' (постачання неплатнику податку)' \
       WHEN coalesce(cl.add_name,'')<>'' THEN cl.add_name  ELSE cl.name END as short_name, \
  CASE WHEN scl.flag_taxpay = 1 THEN scl.tax_num::::varchar ELSE '0' END as tax_num, \
  CASE WHEN t.value_tax<>0 THEN t.value ELSE 0 END as val_20, \
  CASE WHEN t.value_tax=0 THEN t.value ELSE 0 END as val_0 \
  from acm_taxcorrection_tbl as t join clm_client_tbl as cl  on (cl.id = t.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  left join acm_tax_tbl tt on(tt.id_doc=t.id_tax)  \
  where date_trunc('month',  :dtb::::date) = date_trunc('month', t.reg_date) \
  and t.int_num <>0 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dtb::::date) ) \
  ) as s order by int_num; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dt_b;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::Reactiv_2010(TDateTime mmgg1, TDateTime mmgg2)
{
  AnsiString  sqlstr1=" select c.code, c.name,ph.code_eqp,eqh.name_eqp, ph.wtm, ph.d, coalesce(ph.connect_power, ph.power) as pwr,tw.value as tarif, \
  CASE WHEN coalesce(ph.connect_power, ph.power) <= 150 THEN 1 \
       WHEN coalesce(ph.connect_power, ph.power) <= 750  and coalesce(ph.connect_power, ph.power) > 150 THEN 2 \
       WHEN coalesce(ph.connect_power, ph.power) > 750 THEN 3 END as link, date_part('month',r0.mmgg ) as mm, \
       r0.*, r1.*, r2.*, a1.* \
from \
 (select id_client,id_point, b.mmgg, sum(p1) as p1, sum(p2) as p2, max (dt_begin) as dt_b \
 from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc) \
where b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2  and kind_energy in (2,4) and p1+p2 <> 0 group by id_client,id_point,b.mmgg) as r0 \
 join clm_client_tbl as c on (c.id = r0.id_client) \
 join eqm_point_h as ph on (ph.code_eqp = r0.id_point) \
 join eqm_equipment_h as eqh on (eqh.id = r0.id_point) \
 join aci_tarif_tbl as tar on (tar.id=ph.id_tarif) \
 join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
 join acd_tarif_tbl as tw on (tw.id_tarif = tar.id) \
left join \
(select id_point, mmgg, sum(CASE WHEN kind_energy = 2 THEN fact_demand ELSE 0 END ) as demand_r, \
                               sum(CASE WHEN kind_energy = 4 THEN fact_demand ELSE 0 END ) as demand_g \
 from acd_pwr_demand_tbl where mmgg >= :mmgg1 and mmgg <= :mmgg2 and kind_energy in (2,4)  group by id_point, mmgg) as r1 \
on (r0.id_point = r1.id_point and r0.mmgg = r1.mmgg) \
left join \
(select id_point, mmgg, sum(dw) as losts_r \
 from acd_calc_losts_tbl where mmgg >= :mmgg1 and mmgg <= :mmgg2 and kind_energy =2 and type_eqm = 2 group by id_point,mmgg) as r2 \
on (r0.id_point = r2.id_point and r0.mmgg = r2.mmgg)  \
left join \
(select id_point, mmgg, sum(fact_demand) as demand_a \
 from acd_pwr_demand_tbl where mmgg >= :mmgg1 and mmgg <= :mmgg2 and kind_energy =1 group by id_point, mmgg) as a1 \
on (r0.id_point = a1.id_point and r0.mmgg = a1.mmgg) \
where \
    ph.dt_b = (select max(dt_b) from eqm_point_h as p2  where p2.code_eqp = r0.id_point and p2.dt_b <= r0.dt_b ) \
and eqh.dt_b = (select max(dt_b) from eqm_equipment_h as eq2  where eq2.id = r0.id_point and eq2.dt_b <= r0.dt_b ) \
and tw.dt_begin = (select max(dt_begin) from acd_tarif_tbl as tw2 where tw2.id_tarif = tw.id_tarif and tw2.dt_begin <= r0.dt_b) \
and tcl.ident= :tcl order by c.code, ph.code_eqp, mm;  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;
  ZQXLReps->ParamByName("tcl")->AsString = "tcl1";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr1);
  ZQXLReps2->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps2->ParamByName("mmgg2")->AsDateTime=mmgg2;
  ZQXLReps2->ParamByName("tcl")->AsString = "tcl2";

  AnsiString  sqlstr2=" select '1.1. Споживачі з приєднаною потужністю до 150 кВт' as grname , 1 as link \
                        union \
                        select '1.2. Споживачі з приєднаною потужністю від 150 до 750 кВт' ,2 \
                        union \
                        select '1.3. Споживачі з приєднаною потужністю вище 750 кВт',3 ";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);

  AnsiString  sqlstr3=" select '2.1. Споживачі з приєднаною потужністю до 150 кВт' as grname , 1 as link \
                        union \
                        select '2.2. Споживачі з приєднаною потужністю від 150 до 750 кВт' ,2 \
                        union \
                        select '2.3. Споживачі з приєднаною потужністю вище 750 кВт',3 ";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  ZQXLReps2->MasterSource=DSRep2;
  ZQXLReps2->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
    ZQXLRepsSum2->Open();
    ZQXLReps2->Open();

  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange1";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsSum2";
  Dsr->Range = "GroupRange2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range1";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1)+ " - "+FormatDateTime("mmmm yyyy",mmgg2);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();
 ZQXLReps2->Close();
 ZQXLRepsSum2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

 ZQXLReps2->MasterSource=NULL;
 ZQXLReps2->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::MastersDemandAktList (TDateTime dtb, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_point_master_fun( :dt );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
                 /*
  AnsiString  sqlstr1=" select ss.*, coalesce(bs2.self_dem,0) as  self_dem, c.code, c.short_name as name, sc.flag_taxpay, CASE WHEN sc.flag_taxpay =1 THEN 'Платник ПДВ' ELSE 'Не платник ПДВ' END as taxpay_str, \
  out_demand+coalesce(self_dem,0)+ CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as in_dem , \
  out_demand+CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as out_dem , \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END as sin_m, \
  CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as sout_m, \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END  as sall_m, \
  sc.tr_doc_num,sc.tr_doc_date,sc.tr_year_price,sc.tr_doc_type,\
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as type_str \
   from \
   ( \
  select id_master_client, sum(kvt) as out_demand ,coalesce(sum(sin),0) as sin, coalesce(sum(sout),0) as sout, count(distinct mm.id_point) as cnt from \
  (select distinct m.* from rep_point_master_tbl as m join eqm_tree_tbl as t on (t.id = m.id_master_tree) \
   join clm_client_tbl as cm on (t.id_client = cm.id) \
  where t.id_client <> syi_resid_fun() and coalesce(cm.flag_balance,0) <> 1 \
  order by m.id_master_client,m.id_point) as mm \
  join \
 (select id_doc,id_point, sum(demand_val) as kvt  \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_doc,id_point order by id_doc,id_point )as bs \
    on (bs.id_point = mm.id_point ) \
  left join \
 ( select b.id_doc,b.id_client,pd.id_point, sum(in_res_losts) as sin, sum(out_res_losts) as sout \
   from acm_bill_tbl as b join  acd_pwr_demand_tbl as pd  on  (b.id_doc =pd.id_doc  ) \
   where b.mmgg = :mmgg and pd.kind_energy = 1 \
   group by b.id_doc, b.id_client, pd.id_point \
 ) as ls on (ls.id_doc=bs.id_doc and ls.id_point = bs.id_point) \
  group by id_master_client \
  ) as ss \
 left join (select distinct r1.id_master_client from rep_point_master_tbl as r1 left join rep_point_master_tbl as r2 on (r1.id_master_client = r2.id_client and r1.id_master_tree = r2.id_point_tree ) \
   where r2.id_client is null) as mm on (mm.id_master_client = ss.id_master_client) \
 left join \
  (select b.id_client, sum(bs.demand_val) as self_dem \
  from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc ) \
  join (   select distinct  tt3.id_point \
        from (select bb.* from eqm_borders_h as bb \
              join clm_client_tbl as cm2 on (bb.id_clienta = cm2.id) \
          where id_clienta<>syi_resid_fun() and coalesce(cm2.flag_balance,0) <> 1 \
          order by code_eqp) as b \
        join eqm_eqp_tree_h as tt on (tt.code_eqp = b.code_eqp and tt.code_eqp_e is not null) \
        join \
        ( \
        select distinct p.code_eqp as id_point, tt2.id_tree from eqm_eqp_tree_h as tt2 \
        join eqm_point_h as p on (p.code_eqp = tt2.code_eqp) \
        where tt2.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt2.dt_e is null or tt2.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and p.dt_b <( :mmgg::::date + '1 month'::::interval) and (p.dt_e is null or p.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
         order by tt2.id_tree, p.code_eqp \
        ) as tt3 \
        on (tt3.id_tree = tt.id_tree) \
        where tt.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt.dt_e is null or tt.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and b.dt_b <( :mmgg::::date + '1 month'::::interval) and (b.dt_e is null or b.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        order by tt3.id_point \
        ) as pp on (pp.id_point = bs.id_point) \
  where b.mmgg = :mmgg and bs.kind_energy=1 group by b.id_client order by b.id_client )as bs2 \
  on (bs2.id_client = ss.id_master_client ) \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ;";
                        */

  AnsiString  sqlstr1=" select ss.*, coalesce(bs2.self_dem,0) as  self_dem, c.code, c.short_name as name, sc.flag_taxpay, CASE WHEN sc.flag_taxpay =1 THEN 'Платник ПДВ' ELSE 'Не платник ПДВ' END as taxpay_str, \
  out_demand+coalesce(self_dem,0)+ CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as in_dem , \
  out_demand+CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as out_dem , \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END as sin_m, \
  CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as sout_m, \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END  as sall_m, \
  sc.tr_doc_num,sc.tr_doc_date,sc.tr_year_price,sc.tr_doc_type,\
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as type_str \
   from \
   ( \
  select id_master_client, sum(kvt) as out_demand ,coalesce(sum(sin),0) as sin, coalesce(sum(sout),0) as sout, \
  coalesce(sum(sin_c),0) as sin_c, coalesce(sum(sout_c),0) as sout_c, \
  count(distinct mm.id_point) as cnt from \
  (select distinct m.* from rep_point_master_tbl as m join eqm_tree_tbl as t on (t.id = m.id_master_tree) \
   join clm_client_tbl as cm on (t.id_client = cm.id) \
  where t.id_client <> syi_resid_fun() and coalesce(cm.flag_balance,0) <> 1 \
  order by m.id_master_client,m.id_point) as mm \
  join \
 (select id_doc,id_point, sum(demand_val) as kvt  \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_doc,id_point order by id_doc,id_point )as bs \
    on (bs.id_point = mm.id_point ) \
  left join \
 ( select b.id_doc,b.id_client,pd.id_point, sum(in_res_losts) as sin, sum(out_res_losts) as sout \
   from acm_bill_tbl as b join  acd_pwr_demand_tbl as pd  on  (b.id_doc =pd.id_doc  ) \
   where b.mmgg = :mmgg and pd.kind_energy = 1 \
   group by b.id_doc, b.id_client, pd.id_point order by b.id_doc, pd.id_point\
 ) as ls on (ls.id_doc=bs.id_doc and ls.id_point = bs.id_point) \
  left join \
 (  select id_doc,id_client,id_point,id_client_eqp, \
   sum(CASE WHEN res_l = 1 THEN dw END) as sin_c, sum(CASE WHEN res_l = 2 THEN dw END) as sout_c \
   from \
   (select b.id_doc,b.id_client,cl.id_eqp,cl.id_point, coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  where b.mmgg = :mmgg and res_l in (1,2) \
  ) as ss \
  group by id_doc,id_client,id_point,id_client_eqp order by id_doc,id_point,id_client_eqp \
 ) as ls_c on (ls_c.id_doc=bs.id_doc and ls_c.id_point = bs.id_point and ls_c.id_client_eqp = mm.id_master_client) \
  group by id_master_client \
  ) as ss \
 left join (select distinct r1.id_master_client from rep_point_master_tbl as r1 left join rep_point_master_tbl as r2 on (r1.id_master_client = r2.id_client and r1.id_master_tree = r2.id_point_tree ) \
   where r2.id_client is null) as mm on (mm.id_master_client = ss.id_master_client) \
 left join \
  (select b.id_client, sum(bs.demand_val) as self_dem \
  from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc ) \
  join (   select distinct  tt3.id_point \
        from (select bb.* from eqm_borders_h as bb \
              join clm_client_tbl as cm2 on (bb.id_clienta = cm2.id) \
          where id_clienta<>syi_resid_fun() and coalesce(cm2.flag_balance,0) <> 1 \
          order by code_eqp) as b \
        join eqm_eqp_tree_h as tt on (tt.code_eqp = b.code_eqp and tt.code_eqp_e is not null) \
        join \
        ( \
        select distinct p.code_eqp as id_point, tt2.id_tree from eqm_eqp_tree_h as tt2 \
        join eqm_point_h as p on (p.code_eqp = tt2.code_eqp) \
        where tt2.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt2.dt_e is null or tt2.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and p.dt_b <( :mmgg::::date + '1 month'::::interval) and (p.dt_e is null or p.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
         order by tt2.id_tree, p.code_eqp \
        ) as tt3 \
        on (tt3.id_tree = tt.id_tree) \
        where tt.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt.dt_e is null or tt.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and b.dt_b <( :mmgg::::date + '1 month'::::interval) and (b.dt_e is null or b.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        order by tt3.id_point \
        ) as pp on (pp.id_point = bs.id_point) \
  where b.mmgg = :mmgg and bs.kind_energy=1 group by b.id_client order by b.id_client )as bs2 \
  on (bs2.id_client = ss.id_master_client ) \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ;";

  /*
    join eqm_tree_h as tr \
   on (tr.id = ttr.id_tree and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(tr.dt_b::::timestamp::::abstime,(coalesce(tr.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \

  */


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------
void TfReports::MastersDemandAkt (TDateTime dtb, int id_client,boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_point_master_fun( :dt );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }
/*
  AnsiString  sqlstr1=" select ss.*, bs2.self_dem, c.code, c.name, out_dem+self_dem as in_dem , \
  sc.tr_doc_num,sc.tr_doc_date,sc.tr_year_price,sc.tr_doc_type,\
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as type_str \
   from \
   ( \
  select id_master_client, sum(kvt) as out_dem ,count(distinct mm.id_point) as cnt from \
  (select distinct * from rep_point_master_tbl order by id_master_client,id_point) as mm \
  join \
  (select id_point, sum(demand_val) as kvt \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_point order by id_point )as bs \
    on (bs.id_point = mm.id_point )\
    group by id_master_client \
  ) as ss \
  join \
  (select b.id_client, sum(bs.demand_val) as self_dem \
  from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc ) where b.mmgg = :mmgg and bs.kind_energy=1 group by b.id_client order by b.id_client )as bs2 \
  on (bs2.id_client = ss.id_master_client ) \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) <> 50 \
  and c.id = :client \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ;";
*/
/*
  AnsiString  sqlstr1=" select ss.*, coalesce(bs2.self_dem,0) as self_dem , c.code, c.short_name as name, sc.flag_taxpay, \
  out_demand+coalesce(self_dem,0)+ CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as in_dem , \
  out_demand+CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as out_dem , \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END as sin_m, \
  CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END as sout_m, \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE 0 END + CASE WHEN mm.id_master_client is not null THEN sout ELSE 0 END  as sall_m, \
  sc.tr_doc_num,sc.tr_doc_date,sc.tr_year_price,sc.tr_doc_type,\
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as type_str \
   from \
   ( \
  select id_master_client, sum(kvt) as out_demand ,coalesce(sum(sin),0) as sin, coalesce(sum(sout),0) as sout, count(distinct mm.id_point) as cnt from \
  (select distinct m.* from rep_point_master_tbl as m join eqm_tree_tbl as t on (t.id = m.id_master_tree) where t.id_client <> syi_resid_fun() order by m.id_master_client,m.id_point) as mm \
  join \
 (select id_doc,id_point, sum(demand_val) as kvt  \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_doc,id_point order by id_doc,id_point )as bs \
    on (bs.id_point = mm.id_point ) \
  left join \
 ( select b.id_doc,b.id_client,pd.id_point, sum(in_res_losts) as sin, sum(out_res_losts) as sout \
   from acm_bill_tbl as b join  acd_pwr_demand_tbl as pd  on  (b.id_doc =pd.id_doc ) \
   where b.mmgg = :mmgg and pd.kind_energy = 1 \
   group by b.id_doc, b.id_client, pd.id_point \
 ) as ls on (ls.id_doc=bs.id_doc and ls.id_point = bs.id_point) \
  group by id_master_client \
  ) as ss \
 left join (select distinct r1.id_master_client from rep_point_master_tbl as r1 left join rep_point_master_tbl as r2 on (r1.id_master_client = r2.id_client and r1.id_master_tree = r2.id_point_tree) \
   where r2.id_client is null) as mm on (mm.id_master_client = ss.id_master_client) \
  left join \
  (select b.id_client, sum(bs.demand_val) as self_dem \
  from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc ) \
  join (   select distinct  tt3.id_point \
        from (select * from eqm_borders_h where id_clienta<>syi_resid_fun() order by code_eqp ) as b \
        join eqm_eqp_tree_h as tt on (tt.code_eqp = b.code_eqp and tt.code_eqp_e is not null) \
        join \
        ( \
        select distinct p.code_eqp as id_point, tt2.id_tree from eqm_eqp_tree_h as tt2 \
        join eqm_point_h as p on (p.code_eqp = tt2.code_eqp) \
        where tt2.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt2.dt_e is null or tt2.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and p.dt_b <( :mmgg::::date + '1 month'::::interval) and (p.dt_e is null or p.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
         order by tt2.id_tree, p.code_eqp \
        ) as tt3 \
        on (tt3.id_tree = tt.id_tree) \
        where tt.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt.dt_e is null or tt.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and b.dt_b <( :mmgg::::date + '1 month'::::interval) and (b.dt_e is null or b.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        order by tt3.id_point \
        ) as pp on (pp.id_point = bs.id_point) \
  where b.mmgg = :mmgg and bs.kind_energy=1 group by b.id_client order by b.id_client )as bs2 \
  on (bs2.id_client = ss.id_master_client ) \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and c.id = :client \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ;";
*/


  AnsiString  sqlstr1=" select ss.*, coalesce(bs2.self_dem,0) as self_dem , c.code, c.short_name as name, sc.flag_taxpay, \
  out_demand+coalesce(self_dem,0)+ CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as in_dem , \
  out_demand+CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as out_dem , \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END as sin_m, \
  CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as sout_m, \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END  as sall_m, \
  sc.tr_doc_num,sc.tr_doc_date,sc.tr_year_price,sc.tr_doc_type,\
  CASE WHEN  sc.tr_doc_type =1 THEN 'Довідка' WHEN  sc.tr_doc_type =2 THEN 'Кошторис' END as type_str \
   from \
   ( \
  select id_master_client, sum(kvt) as out_demand ,coalesce(sum(sin),0) as sin, coalesce(sum(sout),0) as sout, \
  coalesce(sum(sin_c),0) as sin_c, coalesce(sum(sout_c),0) as sout_c, \
  count(distinct mm.id_point) as cnt from \
  (select distinct m.* from rep_point_master_tbl as m join eqm_tree_tbl as t on (t.id = m.id_master_tree) where t.id_client <> syi_resid_fun() order by m.id_master_client,m.id_point) as mm \
  join \
 (select id_doc,id_point, sum(demand_val) as kvt  \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_doc,id_point order by id_doc,id_point )as bs \
    on (bs.id_point = mm.id_point ) \
  left join \
 ( select b.id_doc,b.id_client,pd.id_point, sum(in_res_losts) as sin, sum(out_res_losts) as sout \
   from acm_bill_tbl as b join  acd_pwr_demand_tbl as pd  on  (b.id_doc =pd.id_doc  ) \
   where b.mmgg = :mmgg and pd.kind_energy = 1 \
   group by b.id_doc, b.id_client, pd.id_point order by b.id_doc, pd.id_point\
 ) as ls on (ls.id_doc=bs.id_doc and ls.id_point = bs.id_point) \
  left join \
 (  select id_doc,id_client,id_point,id_client_eqp, \
   sum(CASE WHEN res_l = 1 THEN dw END) as sin_c, sum(CASE WHEN res_l = 2 THEN dw END) as sout_c \
   from \
   (select  b.id_doc,b.id_client,cl.id_eqp,cl.id_point, coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  where b.mmgg = :mmgg and res_l in (1,2) \
  ) as ss \
  group by id_doc,id_client,id_point,id_client_eqp order by id_doc,id_point,id_client_eqp \
 ) as ls_c on (ls_c.id_doc=bs.id_doc and ls_c.id_point = bs.id_point and ls_c.id_client_eqp = mm.id_master_client) \
  group by id_master_client \
  ) as ss \
 left join (select distinct r1.id_master_client from rep_point_master_tbl as r1 left join rep_point_master_tbl as r2 on (r1.id_master_client = r2.id_client and r1.id_master_tree = r2.id_point_tree) \
   ) as mm on (mm.id_master_client = ss.id_master_client) \
  left join \
  (select b.id_client, sum(bs.demand_val) as self_dem \
  from acd_billsum_tbl as bs join acm_bill_tbl as b on (b.id_doc = bs.id_doc ) \
  join (   select distinct  tt3.id_point \
        from (select * from eqm_borders_h where id_clienta<>syi_resid_fun() order by code_eqp ) as b \
        join eqm_eqp_tree_h as tt on (tt.code_eqp = b.code_eqp and tt.code_eqp_e is not null) \
        join \
        ( \
        select distinct p.code_eqp as id_point, tt2.id_tree from eqm_eqp_tree_h as tt2 \
        join eqm_point_h as p on (p.code_eqp = tt2.code_eqp) \
        where tt2.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt2.dt_e is null or tt2.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and p.dt_b <( :mmgg::::date + '1 month'::::interval) and (p.dt_e is null or p.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
         order by tt2.id_tree, p.code_eqp \
        ) as tt3 \
        on (tt3.id_tree = tt.id_tree) \
        where tt.dt_b <( :mmgg::::date + '1 month'::::interval) and (tt.dt_e is null or tt.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        and b.dt_b <( :mmgg::::date + '1 month'::::interval) and (b.dt_e is null or b.dt_e >=( :mmgg::::date - '1 month'::::interval) ) \
        order by tt3.id_point \
        ) as pp on (pp.id_point = bs.id_point) \
  where b.mmgg = :mmgg and bs.kind_energy=1 group by b.id_client order by b.id_client )as bs2 \
  on (bs2.id_client = ss.id_master_client ) \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and c.id = :client \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;
  ZQXLReps->ParamByName("client")->AsInteger=id_client;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
//  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lmonthname";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(dtb,year1,month1,day1);
  AnsiString monthstr;

  switch ( month1 ) {
    case 1 : monthstr="січні"; break;
    case 2 : monthstr="лютому"; break;
    case 3 : monthstr="березні"; break;
    case 4 : monthstr="квітні"; break;
    case 5 : monthstr="травні"; break;
    case 6 : monthstr="червні"; break;
    case 7 : monthstr="липні"; break;
    case 8 : monthstr="серпні"; break;
    case 9 : monthstr="вересні"; break;
    case 10 : monthstr="жовтні"; break;
    case 11 : monthstr="листопаді"; break;
    case 12 : monthstr="грудні"; break;
  }

  xlReport->ParamByName["lmonthname"]->Value = monthstr;
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1)+"р.";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
//  xlReport->ParamByName["lres"]->Value = ResName;


  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------
void TfReports::GraficWork_fiders_fact(TDateTime mmgg, int work_type,boolean Build)
{

  AnsiString sqlstr;
  if (Build)
  {

   if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }
  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select ssss.*, cp2.represent_name as fider_inspector, ww.dt_work, ww_m.dt_work as dt_work_fact, ww_m.dt as dt_fact, ";
  if (work_type ==1)
  {
    sqlstr1 = sqlstr1 + "   plan1.date_work ::::date as dt_next, ";
  }
  if (work_type ==2)
  {
    sqlstr1 = sqlstr1 + "   plan1.date_work ::::date as dt_next, plan2.date_work ::::date as dt_next2,  ";
  }

  sqlstr1 = sqlstr1 + " \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type, ph.name as phase, km.name as kind, cp.represent_name,stt.tt_type, p.id_position, id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  left join \
  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
  ic.conversion , ic.type as tt_type,ic.accuracy from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) ";

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  ( select w.id_point,w.dt_work,w.comment from clm_works_tbl as w \
    join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = :type group by id_client, id_point) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
    where w.id_type = :type \
  ) as ww on (ww.id_point = ssss.id_point) \
  left join \
  ( select w.id_point,w.dt_work,w.comment,w.dt from clm_works_tbl as w \
    join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = :type and date_trunc('month',dt_work) = :mmgg group by id_client, id_point) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
    where w.id_type = :type \
  ) as ww_m on (ww_m.id_point = ssss.id_point) ";

  if (work_type ==1)
  {
    sqlstr1 = sqlstr1 +" \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >=:mmgg and date_work < ( :mmgg::::date + '3 year'::::interval )::::date \
    ) as plan1 on  (plan1.id_point = ssss.id_point) ";
  }

  if (work_type ==2)
  {
    sqlstr1 = sqlstr1 +" \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >=:mmgg and date_work < ( :mmgg::::date + '6 month'::::interval )::::date \
    ) as plan1 on  (plan1.id_point = ssss.id_point) \
    left join \
    ( \
      select * from rep_work_grafic_tbl where id_work_type = :type \
      and date_work >= ( :mmgg::::date + '6 month'::::interval )::::date and date_work < ( :mmgg::::date + '12 month'::::interval )::::date \
    ) as plan2 on  (plan2.id_point = ssss.id_point) ";
  }
  sqlstr1 = sqlstr1 +" \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
  and ( :insp is null or ssss.id_position = :insp) \
  order by code " ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("type")->AsInteger=work_type;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;


  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
//  Param=xlReport->Params->Add();
//  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yy",dtBegin->Date);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::PrintAbonFiders_grafic_fact(TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 =" select sssss.*, \
    CASE when (dt1 is null or dt1 < date_trunc('month',:mmgg::::date)::::date) and dt2 < date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval THEN dt2 \
         when (dt1 < date_trunc('month',:mmgg::::date)::::date) and (dt2 >= date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval or dt2 is null ) THEN null  else dt1 END as date1 \
    from (  select ssss.*, cp2.represent_name as fider_inspector, \
     ww.worktype,ww.dt_work, obhod.dt_insp, obhod.dt ,\
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,4,7,10)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,5,8,11)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date) in (3,6,9,12)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt1, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
       when period_indicat = 2 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
       when period_indicat = 3 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval END::::date ,2) as dt2, \
 case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";

  sqlstr1 = sqlstr1 +"  select c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power, \
  adv.adr, im.type, ph.name as phase, km.name as kind, cp.represent_name,cp3.represent_name as point_inspector, \
  stt.tt_type,stcl.dt_indicat, substring(text(month_control)::::varchar,1,1)::::int as period_indicat, \
  CASE WHEN coalesce(substring(text(month_control)::::varchar,2,1),'') = '' THEN '1' ELSE substring(text(month_control)::::varchar,2,1) END::::int as month_indicat,\
   id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join eqk_phase_tbl as ph on (ph.id = im.phase) \
  left join eqk_meter_tbl as km on (km.id = im.kind_meter) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  left join clm_position_tbl as cp3 on (cp3.id = p.id_position) \
  left join \
  ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, \
  ic.conversion , ic.type as tt_type,ic.accuracy from \
   eqm_compensator_i_tbl as c \
   join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
   left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
   left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
   left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
   left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
   where ic.conversion = 1 order by id_meter \
) as stt on (stt.id_meter = m.code_eqp) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99)   ";

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  ( select wi.name as worktype, id_point,dt_work from \
    (select w.id_point,w.id_client, w.dt_work, min(w.id_type) as id_type \
     from clm_works_tbl as w \
     join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = 1 or id_type = 2 group by id_client, id_point) as w2 \
     on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
     group by w.id_point,w.id_client, w.dt_work \
    ) as wg \
    join cli_works_tbl as wi on (wi.id = wg.id_type) \
  ) as ww on (ww.id_point = ssss.id_point) \
    left join ( select is1.dt_insp, is1.value , is1.id_meter, is1.num_eqp, is1.id_point , is1.dt \
     from acm_inspectstr_tbl as  is1 \
     join (select id_point, max(dt_insp) as dt_insp from acm_inspectstr_tbl where value is not null and kind_energy = 1 and date_trunc('month',dt_insp) = :mmgg  group by id_point  order by id_point) as is2 \
     on (is1.id_point = is2.id_point and is1.dt_insp = is2.dt_insp) where is1.value is not null and zone in (0,3,5,8,10) and kind_energy = 1 order by is1.id_point \
    ) as obhod on (obhod.id_point = ssss.id_point ) \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
     and ( :insp is null or ff.id_position = :insp) \
     ) as sssss \
  order by code " ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lfider";
  Param=xlReport->Params->Add();
  Param->Name="linspector";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->ParamByName["lfider"]->Value = edFiderName->Text;
  xlReport->ParamByName["linspector"]->Value = edInspector->Text;

  AnsiString caption = "Виконання графіка зйому показників по юридичним споживачам.";

  caption =caption+ edFiderName->Text;

  xlReport->ParamByName["caption"]->Value = caption;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintTaxNDSErrList(TDateTime mmgg)
{
  AnsiString  sqlstr1="select err.*, t.reg_num, t.int_num,t.reg_date, t.kind_calc, \
      CASE WHEN t.kind_calc =1 THEN 'рахунок' WHEN t.kind_calc =2 THEN 'аванс' \
       WHEN t.kind_calc =3 THEN 'оплата' WHEN t.kind_calc =4 THEN 'Населення' END::::varchar as kind, \
     c.code, c.short_name , p.name as name_pref , tax_nn - tax_real as tax_dif \
    from acm_tax_ndserr_tbl as err \
    join acm_tax_tbl as t on (t.id_doc = err.id_doc) \
    join clm_client_tbl as c on (c.id = t.id_client) \
    join aci_pref_tbl as p on (p.id= err.id_pref) \
    where err.mmgg = :mmgg \
    order by t.int_num;  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::NDS2011_info(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1="select cm.code, cm.short_name,p.*,bp.value+bp.value_tax as bp_pay,bp.value_tax as bp_tax, \
 CASE WHEN scl.id_section not in (207,206) and scl.flag_budjet=1 THEN  'Бюджет' \
       WHEN scl.id_section =206 THEN 'Льготы' \
       WHEN scl.id_section =207 THEN 'Субсидии' \
       WHEN scl.id_section in (205,208)  THEN 'Население' \
       WHEN scl.id_section not in (205,206,207,208,216,217) and scl.flag_budjet=0 THEN 'Прочие' END::::varchar as category \
     from acm_billpay_tbl as bp \
     left join acm_bill_tbl as b on (b.id_doc=bp.id_bill) \
     left join acm_pay_tbl as p on (p.id_doc=bp.id_pay) \
     left join clm_client_tbl as cm on (cm.id = b.id_client) \
     left join clm_statecl_tbl as scl on (b.id_client=scl.id_client) \
     where cm.book = -1 \
     and b.mmgg= :mmgg \
     and b.id_pref = :pref \
     and date_part('year',p.mmgg_pay) > 2000 \
     and p.mmgg < '2011-04-01' \
     and bp.value <> 0 \
     and cm.idk_work not in (0,10,99)     \
     and scl.id_section not in (206,207,205,208) \
     order by cm.code,p.id_doc;  ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

   if (kind_energy==0)
     ZQXLReps->ParamByName("pref")->AsInteger=10;
   if (kind_energy==1)
     ZQXLReps->ParamByName("pref")->AsInteger=20;
   if (kind_energy==3)
    ZQXLReps->ParamByName("pref")->AsInteger=520;

  AnsiString  sqlstr2=" select cm.code, cm.short_name,b.*,b.value+b.value_tax as value_bill, bp.value+bp.value_tax as bp_pay,bp.value_tax as bp_tax,\
 CASE WHEN scl.id_section not in (207,206) and scl.flag_budjet=1 THEN  'Бюджет' \
       WHEN scl.id_section =206 THEN 'Льготы' \
       WHEN scl.id_section =207 THEN 'Субсидии' \
       WHEN scl.id_section in (205,208)  THEN 'Население' \
       WHEN scl.id_section not in (205,206,207,208,216,217) and scl.flag_budjet=0 THEN 'Прочие' END::::varchar as category \
     from acm_billpay_tbl as bp \
     left join acm_bill_tbl as b on (b.id_doc=bp.id_bill) \
     left join acm_pay_tbl as p on (p.id_doc=bp.id_pay) \
     left join clm_client_tbl as cm on (cm.id = b.id_client) \
     left join clm_statecl_tbl as scl on (b.id_client=scl.id_client) \
     where cm.book = -1 \
     and p.mmgg=:mmgg \
     and b.id_pref = :pref \
     and date_part('year',b.mmgg_bill) > 2000 \
     and b.mmgg < '2011-04-01' \
     and bp.value <> 0 \
     and cm.idk_work not in (0,10,99) \
     and scl.id_section not in (206,207,205,208) \
        order by cm.code,b.id_doc  ;";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

   if (kind_energy==0)
     ZQXLReps2->ParamByName("pref")->AsInteger=10;
   if (kind_energy==1)
     ZQXLReps2->ParamByName("pref")->AsInteger=20;
   if (kind_energy==3)
     ZQXLReps2->ParamByName("pref")->AsInteger=520;


  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";
  Dsr = xlReport->DataSources->Add();
  Dsr->Alias =  "ZQXLReps2";
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  if (kind_energy==0)
    xlReport->ParamByName["lenergy"]->Value = " активна електроенергія .";
  if (kind_energy==1)
    xlReport->ParamByName["lenergy"]->Value = " реактивна електроенергія.";
  if (kind_energy==3)
    xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання).";

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
}
//---------------------------------------------------------------------------
void TfReports::DublMetersList(void)
{

  AnsiString  sqlstr1="select c.id, c.short_name, c.code,m.code_eqp, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control,pim.name as phasename,tim.name as ind_el, im.zones, im.amperage_nom,\
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    sc.phone,cp.represent_name,pr.cl, adr.adr, \
    CASE WHEN tr.id_client = tr.id_department THEN 'РЕС' ELSE 'Абонент' END as owner, pp.code_eqp as id_point, pp.power, sen.energys, \
    CASE WHEN c.idk_work = 1 then 'юридич' WHEN c.idk_work = 0 then 'Прочие' WHEN c.idk_work = 99 then 'Хоз.нужды' END as priznak, \
    clis.name as state, ti.short_name as tar_name \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqk_phase_tbl as pim on (im.phase=pim.id) \
    join eqk_meter_tbl as tim on (im.kind_meter=tim.id) \
    join (select trim(num_eqp) as num, count(*) from eqm_equipment_tbl \
          where type_eqp = 1 and num_eqp is not null \
          group by trim(num_eqp) \
          having count(*) >1 \
          ) as dd on (dd.num = trim(eq.num_eqp)) \
    left join (  select me.code_eqp, sum(en.name||' '||z.name||'; ')::::varchar as energys from eqd_meter_energy_tbl as me \
          join eqk_energy_tbl as en on (en.id = me.kind_energy) \
          join eqd_meter_zone_tbl as mz on (mz.code_eqp = me.code_eqp and mz.kind_energy = me.kind_energy) \
          join eqk_zone_tbl as z on (z.id = mz.zone) \
          group by me.code_eqp order by me.code_eqp \
          ) as sen on (sen.code_eqp = eq.id) \
    left join eqi_meter_prec_tbl pr on (pr.id_type_eqp=im.id )  \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_point_tbl as pp on (pp.code_eqp = mp.id_point ) \
    left join eqm_equipment_tbl as eqpp on (mp.id_point = eqpp.id) \
    left join aci_tarif_tbl as ti on (ti.id = pp.id_tarif) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join  adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
    left join cli_state_tbl as clis on (clis.id = c.id_state) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    order by c.code, eq.num_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
//   ZQXLReps->ParamByName("mmgg")->AsDateTime=cur_mmgg;

//    and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
//    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::PrintMeterNoDemandManyMonth(TDateTime mmgg)
{
  AnsiString sqlstr;

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_noindicnt_fun(:mmgg);");

  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  AnsiString  sqlstr1=" select c.code, c.short_name,adr.adr,sss.* from \
   (select id_client,id_meter,id_point,num_meter,point_name,count(distinct mmgg) as mmgg_cnt from rep_noindic_mmgg_tbl \
    group by id_client,id_meter,id_point,num_meter,point_name \
   ) as sss \
   join clm_client_tbl as c on (c.id = sss.id_client) \
   join eqm_equipment_tbl as eqpp on (sss.id_point = eqpp.id) \
   left join adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
   where mmgg_cnt >2 \
   order by c.code,num_meter;";

  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = "З "+FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::RentHist (TDateTime mmgg, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select seb_renthist_fun( :mmgg );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select c.short_name as name, c.code, rh.dt_rent_end,rh.comment, rh.name_object||' '||coalesce(p.name_eqp,'') as obj,adv.adr \
  from seb_renthist_tbl as rh \
  join  clm_client_tbl as c on (c.id = rh.id_client) \
  join  clm_statecl_tbl  as sc on (c.id = sc.id_client) \
  left join adv_address_tbl as adv on (adv.id = rh.id_addres) \
  left join eqm_equipment_tbl as p on (p.id = rh.id_point) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and rh.mmgg = :mmgg and dt_rent_end < :mmgg::::date+('1 month'::::interval) and rh.flag = 0 \
  order by c.code ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------
void TfReports::GraficWork_symmary(TDateTime mmgg, boolean Build)
{

  AnsiString sqlstr;
  if (Build)
  {

   if(MessageDlg("Переформировать данные о подключении абонентов? (~ 10-30 мин.)", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
   {
    sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    }
   }
  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 ="  select code_f10,name_f10, fider_inspector,sum(plan1) as plan1, sum(plan2) as plan2, \
  sum(fact0) as fact0, sum(fact1) as fact1, sum(fact2) as fact2, \
  sum( CASE WHEN (CASE when (dt1 is null or dt1 < date_trunc('month',:mmgg::::date)::::date) and dt2 < date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval THEN dt2 \
       when (dt1 < date_trunc('month',:mmgg::::date)::::date) and (dt2 >= date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval or dt2 is null ) THEN null  else dt1 END) is null THEN 0 ELSE 1 END) as plan0 \
   from (  select ssss.*, cp2.represent_name as fider_inspector, ww_m1.fact as fact1,ww_m2.fact as fact2, obhod.fact as fact0, \
  ww_p1.plan as plan1, ww_p2.plan as plan2, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 2 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,4,6,8,10,12) then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 1 and date_part('month',:mmgg::::date) in (1,4,7,10)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 2 and date_part('month',:mmgg::::date) in (2,5,8,11)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     when period_indicat = 3 and month_indicat = 3 and date_part('month',:mmgg::::date) in (3,6,9,12)  then date_trunc('month',:mmgg::::date)::::date+(text(dt_indicat-1)|| ' days')::::interval \
                     END::::date ,2) as dt1, \
  calend_dt_dec(case when period_indicat = 1 then date_trunc('month',:mmgg::::date)::::date+ '1 month'::::interval+ (text(dt_indicat-1)|| ' days')::::interval \
       when period_indicat = 2 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,3,5,7,9,11) then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval \
       when period_indicat = 3 and date_part('month',:mmgg::::date +'1 month'::::interval ) in (1,4,7,10)     then date_trunc('month',:mmgg::::date)::::date+'1 month'::::interval+(text(dt_indicat-1)|| ' days')::::interval END::::date ,2) as dt2, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10 \
from \
( \
  select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from ( ";


  sqlstr1 = sqlstr1 +"  select c.code,c.short_name, ba.id_point, eq.name_eqp,  \
  stcl.dt_indicat, substring(text(month_control)::::varchar,1,1)::::int as period_indicat, \
  CASE WHEN coalesce(substring(text(month_control)::::varchar,2,1),'') = '' THEN '1' ELSE substring(text(month_control)::::varchar,2,1) END::::int as month_indicat,\
  cp.represent_name, p.id_position, id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  left join clm_position_tbl as cp on (cp.id = p.id_position) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
  and ba.id_meter is not null order by ba.id_point ";

   sqlstr1 = sqlstr1 +" )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl) ) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  left join \
  ( select w.id_point,count(*) as fact from clm_works_tbl as w \
    join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = 1 and date_trunc('month',dt_work) = :mmgg group by id_client, id_point) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
    where w.id_type = 1 group by w.id_point order by w.id_point \
  ) as ww_m1 on (ww_m1.id_point = ssss.id_point) \
  left join \
  ( select w.id_point,count(*) as fact from clm_works_tbl as w \
    join (select id_client, id_point, max(dt_work) as dt_work from clm_works_tbl where id_type = 2 and date_trunc('month',dt_work) = :mmgg group by id_client, id_point) as w2 \
    on (w.id_client = w2.id_client and w.id_point = w2.id_point and w.dt_work  = w2.dt_work ) \
    where w.id_type = 2 group by w.id_point order by w.id_point \
  ) as ww_m2 on (ww_m2.id_point = ssss.id_point)  \
  left join \
  (   select id_point, count(*) as plan from rep_work_grafic_tbl where id_work_type = 1 and date_trunc('month',date_work) = :mmgg  \
      group by id_point order by id_point \
  ) as ww_p1 on  (ww_p1.id_point = ssss.id_point) \
  left join \
  (   select id_point, count(*) as plan from rep_work_grafic_tbl where id_work_type = 2 and date_trunc('month',date_work) = :mmgg  \
      group by id_point order by id_point \
  ) as ww_p2 on  (ww_p2.id_point = ssss.id_point) \
  left join ( select is1.id_point, count(*) as fact  \
      from acm_inspectstr_tbl as  is1 \
      join (select id_point, max(dt_insp) as dt_insp from acm_inspectstr_tbl where value is not null and kind_energy = 1 and date_trunc('month',dt_insp) = :mmgg  group by id_point  order by id_point) as is2 \
      on (is1.id_point = is2.id_point and is1.dt_insp = is2.dt_insp) where is1.value is not null and zone in (0,3,5,8,10) and kind_energy = 1 group by is1.id_point order by is1.id_point \
  ) as obhod on (obhod.id_point = ssss.id_point ) \
    where (( case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END = :fider) or ( :fider = 0 )) \
  and ( :insp is null or ssss.id_position = :insp) \
  ) as sssss \
  group by code_f10,name_f10, fider_inspector order by fider_inspector, name_f10;" ;

  ZQXLReps->Sql->Add( sqlstr1 );
  ZQXLReps->ParamByName("fider")->AsInteger=FiderId;
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (InspectorId!=0)
     ZQXLReps->ParamByName("insp")->AsInteger=InspectorId;

  try
  {
   ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
//  Param=xlReport->Params->Add();
//  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yy",dtBegin->Date);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";


 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::PrintLimitYear(TDateTime mmgg)
{
 AnsiString  sqlstr1=" select cl.code,cl.name,s1.*,cl.represent_name \
 from ( select c.id,c.code,c.short_name as name, cp.represent_name  \
        from clm_client_tbl as c \
        join clm_statecl_tbl as scl on (c.id = scl.id_client) \
        left join clm_position_tbl as cp on (scl.id_position = cp.id) \
        where scl.id_section not in (205,206,207,208) \
        and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
        and c.book=-1 \
      )  as cl \
   left join ( \
        select  id_client, sum(CASE WHEN date_part('month',month_limit)= 1 THEN value_dem ELSE 0 END) as value1 , \
	sum(CASE WHEN date_part('month',month_limit)= 2 THEN value_dem ELSE 0 END) as value2 , \
	sum(CASE WHEN date_part('month',month_limit)= 3 THEN value_dem ELSE 0 END) as value3 , \
	sum(CASE WHEN date_part('month',month_limit)= 4 THEN value_dem ELSE 0 END) as value4 , \
	sum(CASE WHEN date_part('month',month_limit)= 5 THEN value_dem ELSE 0 END) as value5 , \
	sum(CASE WHEN date_part('month',month_limit)= 6 THEN value_dem ELSE 0 END) as value6 , \
	sum(CASE WHEN date_part('month',month_limit)= 7 THEN value_dem ELSE 0 END) as value7 , \
	sum(CASE WHEN date_part('month',month_limit)= 8 THEN value_dem ELSE 0 END) as value8 , \
	sum(CASE WHEN date_part('month',month_limit)= 9 THEN value_dem ELSE 0 END) as value9 , \
	sum(CASE WHEN date_part('month',month_limit)= 10 THEN value_dem ELSE 0 END) as value10 , \
	sum(CASE WHEN date_part('month',month_limit)= 11 THEN value_dem ELSE 0 END) as value11 , \
	sum(CASE WHEN date_part('month',month_limit)= 12 THEN value_dem ELSE 0 END) as value12 \
        from ( \
         select hl.id_client,d1.month_limit, sum(d1.value_dem) as value_dem \
           from acd_demandlimit_tbl as d1 \
           join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc)  \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2\
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and date_part('year',d2.month_limit)= date_part('year', :mmgg::::date ) \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
         where hl.idk_document = 600  and date_part('year',d1.month_limit)= date_part('year', :mmgg::::date ) \
        group by hl.id_client,d1.month_limit \
       order by hl.id_client \
       ) as ss group by id_client \
   ) as s1 on (s1.id_client =cl.id) \
 order by cl.code ;";

 /*
           join ( \
           select h2.id_client,d2.month_limit, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           where h2.idk_document = 600 and date_part('year',d2.month_limit)= date_part('year', :mmgg::::date ) \
           group by h2.id_client , d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg and hh.month_limit = d1.month_limit) \
*/


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("yyyy",dtBegin->Date)+" рік";

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::PrintAbonPointDemandYear(TDateTime mmgg,int kind_energy)
{

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 ="select ssss.*, demand_1,demand_2,demand_3,demand_4,demand_5,demand_6,demand_7,demand_8, demand_9,demand_10,demand_11,demand_12 \
  from (select distinct c.id as id_client, c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power,p.wtm, \
  adv.adr, cp.represent_name, gr.name_eqp as name_area, hn.name_eqp as name_hn, hn.num_gek \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  left join \
     (select eq.id, eq.name_eqp, ins.code_eqp \
      from eqm_equipment_tbl as eq \
      join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
      where eq.type_eqp = 11 \
    order by ins.code_eqp \
   ) as gr on (gr.code_eqp = eq.id) \
  left join \
     (select eq.id, eq.name_eqp, ins.code_eqp, a.num_gek \
      from eqm_equipment_tbl as eq \
      join eqm_compens_station_inst_tbl as ins on (ins.code_eqp_inst = eq.id) \
      join adi_build_tbl as a on (a.id = eq.id) \
      where eq.type_eqp = 17 \
    order by ins.code_eqp \
   ) as hn on (hn.code_eqp = eq.id) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
  order by ba.id_point \
  ) as ssss \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_1 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 1 group by bs.id_point  order by bs.id_point \
  ) as b1 on (b1.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_2 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 2 group by bs.id_point  order by bs.id_point \
  ) as b2 on (b2.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_3 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 3 group by bs.id_point  order by bs.id_point \
  ) as b3 on (b3.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_4 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 4 group by bs.id_point  order by bs.id_point \
  ) as b4 on (b4.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_5 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 5 group by bs.id_point  order by bs.id_point \
  ) as b5 on (b5.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_6 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 6 group by bs.id_point  order by bs.id_point \
  ) as b6 on (b6.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_7 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 7 group by bs.id_point  order by bs.id_point \
  ) as b7 on (b7.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_8 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 8 group by bs.id_point  order by bs.id_point \
  ) as b8 on (b8.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_9 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 9 group by bs.id_point  order by bs.id_point \
  ) as b9 on (b9.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_10 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 10 group by bs.id_point  order by bs.id_point \
  ) as b10 on (b10.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_11 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 11 group by bs.id_point  order by bs.id_point \
  ) as b11 on (b11.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_12 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 12 group by bs.id_point  order by bs.id_point \
  ) as b12 on (b12.id_point = ssss.id_point) \
  order by code,name_eqp;" ;

  ZQXLReps->Sql->Add( sqlstr1 );

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;
  if (kind_energy==9)    ZQXLReps->ParamByName("pref")->AsInteger=11;


  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lenergy";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = "За "+FormatDateTime("yyyy",dtBegin->Date)+" рік";

  if (kind_energy == 0)  xlReport->ParamByName["lenergy"]->Value = "активна електроенергія";
  if (kind_energy == 1)  xlReport->ParamByName["lenergy"]->Value = "реактивна електроенергія";
  if (kind_energy == 2)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["lenergy"]->Value = " Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["lenergy"]->Value = " Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["lenergy"]->Value = " Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["lenergy"]->Value = " Передача електроенергії.";
  if (kind_energy == 8)  xlReport->ParamByName["lenergy"]->Value = " Інформаційні послуги.";
  if (kind_energy == 9)  xlReport->ParamByName["lenergy"]->Value = " активна електроенергія для пофідерного.";


  xlReport->Report();

 ZQXLReps->Close();


}
//------------------------------------------------------------------------------
void TfReports::PrintAkt4List(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1=" select sss.*, c.short_name, c.code,okpo_num from \
(select * from \
(select \
   id_client, sum(case when  mmgg_bill + '3 month'::::interval > :mmgg::::date  THEN debet ELSE 0 END) as deb1, \
   sum(case when  (mmgg_bill + '6 month'::::interval > :mmgg::::date) and (mmgg_bill + '3 month'::::interval <= :mmgg::::date)  THEN debet ELSE 0 END) as deb2, \
   sum(case when  (mmgg_bill + '9 month'::::interval > :mmgg::::date) and (mmgg_bill + '6 month'::::interval <= :mmgg::::date)  THEN debet ELSE 0 END) as deb3, \
   sum(case when  (mmgg_bill + '12 month'::::interval > :mmgg::::date) and (mmgg_bill + '9 month'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb4, \
   sum(case when  (mmgg_bill + '2 year'::::interval > :mmgg::::date) and (mmgg_bill + '12 month'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb5, \
   sum(case when  (mmgg_bill + '3 year'::::interval > :mmgg::::date) and (mmgg_bill + '2 year'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb6, \
   sum(case when  (mmgg_bill + '3 year'::::interval <= :mmgg::::date) THEN debet ELSE 0 END) as deb7 \
   from( \
   select b.id_client,b.mmgg_bill, sum(rest)+ sum(rest_tax) as debet \
   from \
    (select bb.id_doc, bb.id_client, coalesce(bb.value,0)-sum(coalesce(bbp.value,0)) as rest, \
    coalesce(bb.value_tax,0)-sum(coalesce(bbp.value_tax,0)) as rest_tax \
    from acm_bill_tbl bb left join  acm_billpay_tbl bbp on (bb.id_doc=bbp.id_bill and bbp.mmgg <= :mmgg) \
    where  bb.id_pref = :pref and bb.mmgg <= :mmgg \
    group by bb.id_client, bb.id_doc,bb.value,bb.value_tax ) as bp  join acm_bill_tbl as b on (b.id_doc = bp.id_doc) \
   group by b.id_client,b.mmgg_bill \
   ) as deb group by id_client \
   ) as d \
   full join \
  (select \
   id_client, sum(case when  mmgg_pay + '3 month'::::interval > :mmgg::::date  THEN kredit ELSE 0 END) as kt1, \
   sum(case when  (mmgg_pay + '6 month'::::interval > :mmgg::::date) and (mmgg_pay + '3 month'::::interval <= :mmgg::::date)  THEN kredit ELSE 0 END) as kt2, \
   sum(case when  (mmgg_pay + '9 month'::::interval > :mmgg::::date) and (mmgg_pay + '6 month'::::interval <= :mmgg::::date)  THEN kredit ELSE 0 END) as kt3, \
   sum(case when  (mmgg_pay + '12 month'::::interval > :mmgg::::date) and (mmgg_pay + '9 month'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt4, \
   sum(case when  (mmgg_pay + '2 year'::::interval > :mmgg::::date) and (mmgg_pay + '12 month'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt5, \
   sum(case when  (mmgg_pay + '3 year'::::interval > :mmgg::::date) and (mmgg_pay + '2 year'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt6, \
   sum(case when  (mmgg_pay + '3 year'::::interval <= :mmgg::::date) THEN kredit ELSE 0 END) as kt7 \
   from( \
   select p.id_client, p.mmgg_pay, sum(rest)+ sum(rest_tax) as kredit \
   from \
   ( \
    select pp.id_doc, coalesce(pp.value,0)-sum(coalesce(bbp.value,0)) as rest, \
    coalesce(pp.value_tax,0)-sum(coalesce(bbp.value_tax,0)) as rest_tax \
    from acm_pay_tbl pp left join acm_billpay_tbl bbp on (pp.id_doc=bbp.id_pay and bbp.mmgg <= :mmgg) \
    where  pp.id_pref = :pref and pp.mmgg <= :mmgg \
    group by  pp.id_doc,pp.value,pp.value_tax \
   ) as pb \
   join acm_pay_tbl as p on (p.id_doc = pb.id_doc) \
   group by p.id_client,p.mmgg_pay \
   ) as kred  group by id_client \
   ) as k  using (id_client) \
) as sss \
join clm_client_tbl as c on (c.id = sss.id_client) \
join clm_statecl_tbl as abonpar on (abonpar.id_client = c.id) \
where c.book = -1 and  c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
order by c.code; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

 if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;


  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="energy";
  Param=xlReport->Params->Add();
  Param->Name="user";
  Param=xlReport->Params->Add();
  Param->Name="workdt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());


  xlReport->ParamByName["lres"]->Value = ResName;
//  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->ParamByName["workdt"]->Value = FormatDateTime("dd.mm.yyyy",dtRDate->Date);
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  if (kind_energy==0)
    xlReport->ParamByName["energy"]->Value = "активна електроенергія";
  if (kind_energy==1)
    xlReport->ParamByName["energy"]->Value = "реактивна електроенергія";

  if (kind_energy==3)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";
  if (kind_energy==4)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту споживання електроенергії";

  if (kind_energy==2)
    xlReport->ParamByName["energy"]->Value = "перевищення ліміту потужності ";
  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::BillSaldo(TDateTime date_b,TDateTime date_e,int kind_energy,int client, boolean Build)
{

 if(client==0) return;
  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(date_b,year1,month1,day1);
  DecodeDate(date_b,year2,month2,day2);

   AnsiString  sqlstr;
   if (Build)
   {
    sqlstr=" select seb_one( date_trunc('month', :mmgg::::date)::::date, 0, :client )";

      ZQXLReps->Close();
      ZQXLReps->Sql->Clear();
      ZQXLReps->Sql->Add(sqlstr);
      ZQXLReps->ParamByName("mmgg")->AsDateTime=date_b;
      ZQXLReps->ParamByName("client")->AsInteger=client;

    try
    {
      ZQXLReps->ExecSql();
    }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   };
   };
  AnsiString  sqlstr1=" select now() as dat_n,\
  (case when (coalesce(sal.saldo_val,0)-coalesce(sal_b.value_bill_before,0)+coalesce(sal_p.value_pay_before,0))>0 \
    then 'Переплата ' else 'Борг ' end ) as scribe_b, \
  (case when (coalesce(sal.saldo_val,0)-coalesce(sal_b.value_bill_before,0)+coalesce(sal_p.value_pay_before,0)+coalesce(p.value_pay,0)-coalesce(b.value,0))>0 \
   then 'Переплата ' else 'Борг ' end ) as scribe_e, \
  abon.name as abonname, substr_word(abon.name,0,53) as abonname1, substr(abon.name,length(substr_word(abon.name,0,53))+1,200) as abonname2, \
  users.represent_name as usrname, users.phone as usrphone,\
  abon.short_name as abonsname, abon.code as aboncode, res.name as resname,res.short_name as ressname, \
  abonpar.doc_num, abonpar.doc_dat, :date_b as dat_b,:date_e as dat_e, b.demand_val, b.value,\
  to_char(abonpar.doc_dat,'DD.MM.YYYY')||' р. № '||text(abonpar.doc_num) as docum_info, \
  boss.represent_name as bossname , abn_boss, \
  abs((coalesce(sal.saldo_val,0)-coalesce(sal_b.value_bill_before,0)+coalesce(sal_p.value_pay_before,0))) as value_b,\
    abs((coalesce(sal.saldo_val,0)-coalesce(sal_b.value_bill_before,0)+coalesce(sal_p.value_pay_before,0)-coalesce(b.value,0)+coalesce(p.value_pay,0))) as value_e,\
  b.demand_val as value_dem,b.value,p.value_pay \
  from  (SELECT * FROM clm_client_tbl WHERE ID=:client) as abon \
  left join (select deb_zpmv+kR_zpmv as saldo_val from %obrtable \
         where id_pref=:pref  and mmgg=bom(:date_b) and id_client=:client \
       ) as sal on true \
    left join (select sum(demand_val) as demand_val,sum(value+value_tax) as value from acm_bill_tbl \
         where id_pref=:pref  and reg_date>=:date_b and reg_date<=:date_e and id_client=:client \
       ) as b on true \
   left join  (select sum(value_pay) as value_pay from acm_pay_tbl \
         where id_pref=:pref  and reg_date>=:date_b and reg_date<=:date_e and id_client=:client \
       ) as P on true \
   left join (select sum(value+value_tax) as value_bill_before from acm_bill_tbl \
         where id_pref=:pref  and reg_date<:date_b and reg_date>=bom(:date_b) and id_client=:client \
       ) as sal_b on true \
  left join (select sum(value_pay) as value_pay_before from acm_pay_tbl \
         where id_pref=:pref  and reg_date<:date_b and reg_date>=bom(:date_b) and id_client=:client \
       ) as sal_p on true \
  left join clm_statecl_tbl as abonpar on (abonpar.id_client = abon.id) \
  left join cla_param_tbl as cla on ( abonpar.id_section = cla.id and cla.id_group = 200) \
  left join clm_position_tbl as users on (users.id =:user) \
  left join ( select pos.id_client, pos.represent_name as abn_boss, p.name as position  \
            from clm_position_tbl as pos \
            join cli_position_tbl as p on (p.id = pos.id_position) \
            left join (select pos2.id_client,min(pos2.id) as minid  from clm_position_tbl as pos2 \
                  join cli_position_tbl as p2 on (p2.id = pos2.id_position and p2.ident ='boss') \
                  group by pos2.id_client order by minid ) as p_1 on (p_1.minid = pos.id ) \
            left join (select pos3.id_client,count(*) as cnt  from clm_position_tbl as pos3 \
                  group by pos3.id_client) as pc on (pc.id_client = pos.id_client ) \
    where ((p_1.minid is not null ) or (pc.cnt = 1))  \
    order by id_client  ) as ab on ( ab.id_client = abon.id)  , \
  ( select * from clm_client_tbl where id = syi_resid_fun() ) as res \
   left join ( select * from clm_position_tbl as pos \
             join cli_position_tbl as p on (p.id = pos.id_position and p.ident ='boss') )as boss  on (boss.id_client = res.id) ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";

  ZQXLReps->ParamByName("client")->AsInteger=client;

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  ZQXLReps->ParamByName("date_b")->AsDateTime=date_b;
  ZQXLReps->ParamByName("date_e")->AsDateTime=date_e;
  ZQXLReps->ParamByName("user")->AsInteger =cur_user ;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";

  xlReport->Params->Clear();
    Param=xlReport->Params->Add();
  Param->Name="caption";
  if (kind_energy == 0)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв за активну  електроенергiю";
  if (kind_energy == 1)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв  за реактивну електроенергiю";
  if (kind_energy == 2)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв  за перевищення лiмiту (2кр потужнiсть).";
  if (kind_energy == 3)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв  за перевищення лiмiту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв  за перевищення лiмiту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв. Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв. iнфляцiя.";
  if (kind_energy == 7)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв. Передача електроенергiї.";
  if (kind_energy == 8)  xlReport->ParamByName["caption"]->Value = "  Довiдка про стан розрахункiв. iнформацiйнi послуги.";

  //xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  //xlReport->MacroAfter = "";

 ZQXLReps->Close();
}

//---------------------------------------------------------------------------
void TfReports::PrintFizAndUnif(TDateTime dtb,TDateTime dte)
{
/*
  AnsiString  sqlstr1=" select cl.id, cl.code, cl.add_name as name, sum_val, scl.tax_num, scl.okpo_num \
  from clm_client_tbl as cl \
  join (select id_client, sum(value) as sum_val  from acm_bill_tbl \
   where (mmgg >= date_trunc('month', :dtb::::date)) and (mmgg <= date_trunc('month', :dte::::date)) \
   and id_pref in (10,20,510,520) and value <> 0 group by id_client ) as b  on (cl.id = b.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client) \
  where  cl.book = -1  and cl.idk_work not in (0,99) \
  and coalesce(scl.flag_ed,0)=1 and coalesce(scl.flag_jur,0)=0 \
  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :dte::::date) ) \
  order by cl.code ; ";
*/
//   where (mmgg >= date_trunc('year', :dtb::::date)) and (mmgg <= date_trunc('month', :dtb::::date)) \

  AnsiString  sqlstr1= "select cl.id, cl.code, CASE WHEN coalesce(cl.add_name,'')='' THEN cl.name ELSE cl.add_name END as name, sum_val, scl.tax_num, scl.okpo_num \
  from clm_client_tbl as cl \
  join \
  (select id_client, sum(sum_val) as sum_val from \
  (select b.id_doc, b.id_client, b.value as sum_val  from acm_bill_tbl as b\
   join clm_statecl_h as scl  on (b.id_client = scl.id_client) \
   where (b.mmgg >= date_trunc('month', :dtb::::date)) and (b.mmgg <= date_trunc('month', :dte::::date)) \
   and b.id_pref in (10,20,510,520,524) and b.value <> 0 \
   and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= b.mmgg ) \
   and coalesce(scl.flag_ed,0)=1 and coalesce(scl.flag_jur,0)=0 \
   order by b.id_client ) as bb group by id_client) as bbb on (cl.id = bbb.id_client) \
  join clm_statecl_h as scl on (cl.id = scl.id_client and mmgg_e is null) \
  where  cl.book = -1  and cl.idk_work not in (0,99) \
  order by cl.code ; ";

  ZQXLReps->Close();
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dte")->AsDateTime=dte;

  AnsiString  sqlstr2=" select cl.id, cl.code, cl.name , sum_val, scl.tax_num, scl.okpo_num \
  from clm_client_tbl as cl \
  join \
  (select id_client, sum(sum_val) as sum_val from \
  (select b.id_doc, b.id_client, b.value as sum_val  from acm_bill_tbl as b\
   join clm_statecl_h as scl  on (b.id_client = scl.id_client) \
   where (b.mmgg >= date_trunc('month', :dtb::::date)) and (b.mmgg <= date_trunc('month', :dte::::date)) \
   and b.id_pref in (10,20,510,520,524) and b.value <> 0 \
   and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= b.mmgg ) \
   and coalesce(scl.flag_ed,0)=1 and coalesce(scl.flag_jur,0)=1 \
   order by b.id_client ) as bb group by id_client) as bbb on (cl.id = bbb.id_client) \
  join clm_statecl_h as scl  on (cl.id = scl.id_client and mmgg_e is null) \
  where  cl.book = -1  and cl.idk_work not in (0,99) \
  order by cl.code ; ";


  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("dtb")->AsDateTime=dtb;
  ZQXLReps2->ParamByName("dte")->AsDateTime=dte;

  try
  {
  ZQXLReps->Open();
  ZQXLReps2->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias =  "ZQXLReps";
  Dsr->Range = "Range1";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(dtb,year1,month1,day1);


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

   xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtb)+" - "+
     FormatDateTime("mmmm yyyy",dte);

  xlReport->MacroAfter = "FormatData";
  xlReport->Report();
  xlReport->MacroAfter = "";


 ZQXLReps->Close();
 ZQXLReps2->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintPoinPowerChanges(TDateTime dtb,TDateTime dte,boolean Build)
{

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select rep_hist_point_power_parse_fun( :dtb::::date, :dte::::date);";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("dtb")->AsDateTime=dtb;
   ZQReps->ParamByName("dte")->AsDateTime=dte;

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

 AnsiString  sqlstr1=" select * from ( select ss.*, c.code, c.short_name, eq.name_eqp, adr.adr, us.name as user_name ,ph.dt, \
 CASE WHEN coalesce(ph.reserv,0)=1 THEN 'Резерв' ELSE '' END::::varchar as status \
  from \
 (select coalesce(p1.record_oid , p2.record_oid) as record_oid, \
  coalesce(p1.dt_change , p2.dt_change) as dt_change, \
  coalesce(p1.id_client , p2.id_client) as id_client, \
  coalesce(p1.id_usr , p2.id_usr) as id_usr, \
  coalesce(p1.code_eqp , p2.code_eqp) as code_eqp, \
  p1.old_val as old_power, p1.new_val as new_power ,p2.old_val as old_connect, p2.new_val as new_connect \
  from \
  (select * from rep_hist_changed_fields_tbl as rf \
    left join syi_field_tbl as f on (f.id= rf.id_field) \
    where f.name ='power') as p1 \
    full outer join \
  (select * from rep_hist_changed_fields_tbl as rf \
    left join syi_field_tbl as f on (f.id= rf.id_field) \
    where f.name ='connect_power') as p2 on (p1.record_oid = p2.record_oid) \
  ) as ss \
  join clm_client_tbl as c on (ss.id_client = c.id) \
  join eqm_equipment_tbl as eq on (ss.code_eqp = eq.id) \
  join eqm_point_h as ph on (ph.code_eqp = ss.code_eqp and ss.dt_change = ph.dt_b) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  left join syi_user as us on (us.id = ss.id_usr ) \
  ) as eds ";

  if (cbAll->Checked)
  {
   sqlstr1+=" union all \
   (select eq.oid as record_oid, eq.dt_b, c.id,eq.id_user,eq.id, null, ph.power::::varchar, null, ph.connect_power::::varchar, \
   c.code, c.short_name, eq.name_eqp, adr.adr, us.name as user_name ,eq.dt, 'Новая'::::varchar as status \
   from eqm_equipment_h as eq \
   join eqm_point_h as ph on (ph.code_eqp = eq.id and eq.dt_b = ph.dt_b) \
   join eqm_eqp_tree_h as tt on (tt.code_eqp = eq.id and tt.dt_b = eq.dt_b) \
   join eqm_tree_h as t on (t.id = tt.id_tree and t.dt_b <=tt.dt_b and (t.dt_e is null or t.dt_e > tt.dt_b ) ) \
   left join eqm_eqp_use_h as u1 on (u1.code_eqp = eq.id and eq.dt_b >=u1.dt_b and (u1.dt_e is null or u1.dt_e> eq.dt_b) ) \
   left join clm_client_tbl as c on (c.id = coalesce(u1.id_client,t.id_client)) \
   left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
   left join eqm_equipment_h as eq2 on (eq2.id = eq.id and eq2.dt_b < eq.dt_b) \
   left join syi_user as us on (us.id = eq.id_user ) \
   where eq.dt_b >= :dtb and eq.dt_b <= :dte \
   and eq2.id is null and eq.type_eqp = 12 \
   ) ";

   sqlstr1+=" union all \
   (select eq.oid as record_oid, eq.dt_e, c.id,ch.id_usr,eq.id, ph.power::::varchar, null, ph.connect_power::::varchar, null, \
   c.code, c.short_name, eq.name_eqp, adr.adr, us.name as user_name ,ch.dt, 'Удалена'::::varchar as status \
   from eqm_equipment_h as eq \
   join eqm_point_h as ph on (ph.code_eqp = eq.id and eq.dt_e = ph.dt_e) \
   join eqm_eqp_tree_h as tt on (tt.code_eqp = eq.id and tt.dt_b <= eq.dt_b and (tt.dt_e is null or tt.dt_e > eq.dt_b ) ) \
   join eqm_tree_h as t on (t.id = tt.id_tree and t.dt_b <=tt.dt_b and (t.dt_e is null or t.dt_e > tt.dt_b ) ) \
   left join eqm_eqp_use_h as u1 on (u1.code_eqp = eq.id and eq.dt_b >=u1.dt_b and (u1.dt_e is null or u1.dt_e> eq.dt_b) ) \
   left join clm_client_tbl as c on (c.id = coalesce(u1.id_client,t.id_client)) \
   left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
   left join eqm_equipment_h as eq2 on (eq2.id = eq.id and eq2.dt_b > eq.dt_b) \
   left join (select * from eqm_changelog_tbl where mode = 2 and processing = 1 )as ch on (ch.code_eqp = eq.id) \
   left join syi_user as us on (us.id = ch.id_usr ) \
   where eq.dt_e is not null and eq.dt_e >= :dtb and eq.dt_e <= :dte \
   and eq2.id is null  and eq.type_eqp = 12 \
   ) ";
  }
  sqlstr1+=" order by code, name_eqp, dt_change; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  if (cbAll->Checked)
  {
   ZQXLReps->ParamByName("dtb")->AsDateTime=dtb;
   ZQXLReps->ParamByName("dte")->AsDateTime=dte;
  }

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------
void TfReports::RepPointCount(TDateTime dt, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_abon_count_fun( :dt);";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dt;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1="select  sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand > 5000000000 THEN 1 ELSE 0 END)::::numeric as sum5000, \
	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 5000000000  and demand > 4000000000 THEN 1 ELSE 0 END)::::numeric as sum4000, \
	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 4000000000  and demand > 3000000000 THEN 1 ELSE 0 END)::::numeric as sum3000, \
	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 3000000000  and demand > 2000000000 THEN 1 ELSE 0 END)::::numeric as sum2000, \
	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 2000000000  and demand > 1000000000 THEN 1 ELSE 0 END)::::numeric as sum1000, \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 1000000000  and demand > 500000000 THEN 1 ELSE 0 END)::::numeric as sum500 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 500000000   and demand > 100000000 THEN 1 ELSE 0 END)::::numeric as sum100 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 100000000   and demand > 50000000 THEN 1 ELSE 0 END)::::numeric as sum50 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 50000000    and demand > 10000000 THEN 1 ELSE 0 END)::::numeric as sum10 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 10000000    and demand > 5000000 THEN 1 ELSE 0 END)::::numeric as sum5 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 5000000     and demand > 1000000 THEN 1 ELSE 0 END)::::numeric as sum1 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand <= 1000000     and demand > 500000 THEN 1 ELSE 0 END)::::numeric as sum05 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 201 and demand < 500000 THEN 1 ELSE 0 END)::::numeric as sum0 , \
 	sum(CASE WHEN coalesce(scl.id_section,999) = 202 THEN 1 ELSE 0 END)::::numeric as sum_s , \
 	sum(CASE WHEN coalesce(scl.id_section,999) in (211,213,214,215,203,204) and is_town = true THEN 1 ELSE 0 END)::::numeric as sum_nt, \
	sum(CASE WHEN coalesce(scl.id_section,999) in (211,213,214,215,203,204) and is_town = false THEN 1 ELSE 0 END)::::numeric as sum_nv \
 from \
 ( select ap.id_client,ap.id_point,ap.is_town, coalesce(sum(bb.demand_val),0)::::numeric as demand \
    from rep_areas_points_tbl as ap \
    left join (select bs.id_point,bs.demand_val,b.mmgg from acd_billsum_tbl as bs  join acm_bill_tbl as b on  (bs.id_doc = b.id_doc) \
      where b.id_pref = 10 and b.mmgg <= :mmgg::::date and b.mmgg >:mmgg::::date - '1 year'::::interval \
    ) as bb on (bb.id_point = ap.id_point) \
    where ap.del_abon = 0 and ap.phase is not null \
    group by ap.id_client,ap.id_point,ap.is_town \
    order by demand \
 ) as ss \
 join clm_client_tbl as cl on (cl.id = ss.id_client) \
 join clm_statecl_tbl as scl  on (cl.id = scl.id_client) \
   where  cl.idk_work not in (0,99) ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dt;


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::PrintAbonPointProcent(TDateTime mmgg)
{

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 ="select ssss.*, demand_1,demand_2, CASE WHEN demand_2 <> 0 THEN (demand_1 - demand_2)::::numeric/demand_2 ELSE 0 END as delta \
  from (select distinct c.id as id_client, c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power,p.wtm, \
  adv.adr, cp.represent_name \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
  order by ba.id_point \
  ) as ssss \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_1 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref =10 and b.mmgg = :mmgg::::date group by bs.id_point  order by bs.id_point \
  ) as b1 on (b1.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_2 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref =10 and b.mmgg = :mmgg::::date - '1 month'::::interval  group by bs.id_point  order by bs.id_point \
  ) as b2 on (b2.id_point = ssss.id_point) \
  order by code,name_eqp;" ;

  ZQXLReps->Sql->Add( sqlstr1 );

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = "За "+FormatDateTime("mmmm yyyy",dtBegin->Date);


  xlReport->Report();

 ZQXLReps->Close();


}
//------------------------------------------------------------------------------
void TfReports::PS10_AbonLoad(TDateTime mmgg)
{
  AnsiString  sqlstr1=" select sss.*, pwr.ps_power, \
  CASE WHEN full_cnt =1 THEN 1 \
     WHEN full_cnt >1 and full_cnt<=10 THEN 2 \
     WHEN full_cnt >10 and full_cnt<=50 THEN 3 \
     WHEN full_cnt >50 and full_cnt<=100 THEN 4 \
     WHEN full_cnt >100 and full_cnt<=250 THEN 5 \
     WHEN full_cnt >250 and full_cnt<=500 THEN 6 \
     WHEN full_cnt >500 and full_cnt<=750 THEN 7 \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 8 \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 9 \
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 10 \
  END as link \
 from \
( \
 select trim_name as name , \
 coalesce(fiz_cnt,0)+ coalesce(fiz_cnt_pl,0)+ coalesce(fiz_cnt_op,0) as fiz_cnt, \
 coalesce(fiz_power,0)+coalesce(fiz_power_pl,0)+coalesce(fiz_power_op,0) as fiz_power ,\
 coalesce(((fiz_power-0.58*fiz_cnt)*coalesce((select val from bal_fizabon_coef_tbl as cf where cf.type = 1 and cf.cnt = fiz_cnt ),0.005) + 0.58*fiz_cnt),0) + \
  coalesce(((fiz_power_pl-1.31*fiz_cnt_pl)*coalesce((select val from bal_fizabon_coef_tbl as cf where cf.type = 2 and cf.cnt = fiz_cnt ),0.001) + 1.31*fiz_cnt_pl),0)+  \
   coalesce(fiz_power_op,0) as fiz_power_calc, \
 coalesce(prom_cnt,0) as prom_cnt, \
 coalesce(prom_cnt,0)+ coalesce(fiz_cnt,0)+ coalesce(fiz_cnt_pl,0)+ coalesce(fiz_cnt_op,0) as full_cnt,  power, connect_power from \
( \
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name , count(distinct p.id_client) as prom_cnt, sum(eqp.power) as power, sum(eqp.connect_power) as connect_power \
 from \
 bal_grp_tree_tbl as p \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = p.id_p_eqp ) \
 join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp) \
 join clm_client_tbl as c on (c.id = p.id_client ) \
 where p.type_eqp=12 and p.mmgg = :mmgg::::date \
 and   ps.type_eqp=8 and ps.mmgg = :mmgg::::date \
 and p.id_client > 0 \
 and eqp.reserv=0 \
 and eqp.id_voltage = 4 \
 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
 group by trim_name order by trim_name \
) as ssp \
full outer join \
( \
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name,  \
  count(distinct CASE WHEN  coalesce(c.cod_tarif,0) not in (37,48) THEN c.id ELSE null END) as fiz_cnt, \
  count(distinct CASE WHEN  coalesce(c.cod_tarif,0) =37 THEN c.id ELSE null END) as fiz_cnt_pl, \
  count(distinct CASE WHEN  coalesce(c.cod_tarif,0) =48 THEN c.id ELSE null END) as fiz_cnt_op, \
  sum( CASE WHEN  coalesce(c.cod_tarif,0) not in (37,48) THEN c.set_power ELSE 0 END ) as fiz_power, \
  sum( CASE WHEN  coalesce(c.cod_tarif,0) = 37 THEN c.set_power ELSE 0 END ) as fiz_power_pl, \
  sum( CASE WHEN  coalesce(c.cod_tarif,0) = 48 THEN c.set_power ELSE 0 END ) as fiz_power_op \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join acm_privdem_tbl as pd on (c.id = pd.id_client) \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = ba.id_grp ) \
 where coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 \
 and   ps.type_eqp=8 and ps.mmgg = :mmgg::::date \
 and   pd.mmgg = :mmgg::::date \
 group by trim_name order by trim_name \
) as ssf using (trim_name) \
) as sss \
left join \
( select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name, sum(eqi.power_nom::::numeric) as ps_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    where eq.type_eqp=8 \
    group by trim_name order by trim_name \
) as pwr on (pwr.trim_name = sss.name) \
order by link, full_cnt, name  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  AnsiString  sqlstr2="select link,grp_name,count(*) as cnt from \
( \
select sss.*, \
CASE WHEN full_cnt =1 THEN 1 \
     WHEN full_cnt >1 and full_cnt<=10 THEN 2 \
     WHEN full_cnt >10 and full_cnt<=50 THEN 3 \
     WHEN full_cnt >50 and full_cnt<=100 THEN 4 \
     WHEN full_cnt >100 and full_cnt<=250 THEN 5 \
     WHEN full_cnt >250 and full_cnt<=500 THEN 6  \
     WHEN full_cnt >500 and full_cnt<=750 THEN 7  \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 8  \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 9 \
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 10 \
END as link, \
CASE WHEN full_cnt =1 THEN '1 споживач' \
     WHEN full_cnt >1 and full_cnt<=10 THEN 'до 10 споживачiв' \
     WHEN full_cnt >10 and full_cnt<=50 THEN 'до 50 споживачiв' \
     WHEN full_cnt >50 and full_cnt<=100 THEN 'до 100 споживачiв' \
     WHEN full_cnt >100 and full_cnt<=250 THEN 'до 250 споживачiв' \
     WHEN full_cnt >250 and full_cnt<=500 THEN 'до 500 споживачiв'  \
     WHEN full_cnt >500 and full_cnt<=750 THEN 'до 750 споживачiв'   \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 'до 1000 споживачiв'  \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 'до 10000 споживачiв'\
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 'до 100000 споживачiв'\
END as grp_name \
 from \
( select trim_name as name , coalesce(prom_cnt,0) as prom_cnt, coalesce(fiz_cnt,0) as fiz_cnt, \
 coalesce(prom_cnt,0)+ coalesce(fiz_cnt,0) as full_cnt, fiz_power, power, connect_power from \
( select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name , count(distinct p.id_client) as prom_cnt, sum(eqp.power) as power, sum(eqp.connect_power) as connect_power \
from \
 bal_grp_tree_tbl as p \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = p.id_p_eqp ) \
 join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp) \
 join clm_client_tbl as c on (c.id = p.id_client ) \
 where p.type_eqp=12 and p.mmgg = :mmgg::::date \
 and   ps.type_eqp=8 and ps.mmgg = :mmgg::::date \
 and p.id_client > 0 \
 and eqp.id_voltage = 4 \
 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
 group by trim_name order by trim_name \
) as ssp \
full outer join \
( \
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name, \
 count(distinct c.id) as fiz_cnt,sum(c.set_power) as fiz_power \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join acm_privdem_tbl as pd on (c.id = pd.id_client) \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = ba.id_grp ) \
 where coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 \
 and   ps.type_eqp=8 and ps.mmgg = :mmgg::::date \
 and   pd.mmgg = :mmgg::::date \
 group by trim_name order by trim_name \
) as ssf using (trim_name) \
) as sss \
)as ssss \
group by link,grp_name \
order by link ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//------------------------------------------------------------------------------
void TfReports::PS35_AbonLoad(TDateTime mmgg)
{
  AnsiString  sqlstr1=" select bigs.code_ps35 as link ,bigs.name_ps35, count(distinct id_client) as prom_cnt, \
  sum(power) as power, sum(connect_power_kvt) as connect_power_kvt, sum(connect_power_kva) as connect_power_kva \
from( \
select ssss.*, \
coalesce(ff.id_station,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then code_eqp4 END) as code_ps35, \
coalesce(eqps.name_eqp,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then grpname4 END) as name_ps35 \
from \
( \
 select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
from \
( select ps.code_eqp as code_grp, p.id_client, ps.name, eqp.power, eqp.connect_power , vv.voltage_min,  \
 CASE WHEN coalesce(eqp.con_power_kva,0) = 1 THEN eqp.connect_power ELSE 0 END as connect_power_kva, \
 CASE WHEN coalesce(eqp.con_power_kva,0) = 0 THEN eqp.connect_power ELSE 0 END as connect_power_kvt \
 from \
 bal_grp_tree_tbl as p \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = p.id_p_eqp ) \
 join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp) \
 join clm_client_tbl as c on (c.id = p.id_client ) \
 join eqk_voltage_tbl as vv on (vv.id = eqp.id_voltage) \
 where p.type_eqp=12 and p.mmgg = :mmgg::::date \
 and ps.mmgg = :mmgg::::date \
 and p.id_client > 0 \
 and eqp.reserv=0 \
 and vv.voltage_min >= 1 \
 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
 )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.code_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.code_grp and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
    left join eqm_equipment_tbl as eqps on (eqps.id = ff.id_station) \
) as bigs \
 group by bigs.code_ps35,bigs.name_ps35 order by prom_cnt  ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  AnsiString  sqlstr2=" select bigs.code_ps35 as link,bigs.code||' '||bigs.client as abon, bigs.id_client, \
  sum(power) as power, sum(connect_power_kvt) as connect_power_kvt, sum(connect_power_kva) as connect_power_kva \
from( \
select ssss.*, \
coalesce(ff.id_station,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then code_eqp4 END) as code_ps35, \
coalesce(eqps.name_eqp,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then grpname4 END) as name_ps35 \
from \
( \
 select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
from \
( select ps.code_eqp as code_grp, c.code, c.short_name as client, p.id_client, ps.name, eqp.power, eqp.connect_power , vv.voltage_min,  \
 CASE WHEN coalesce(eqp.con_power_kva,0) = 1 THEN eqp.connect_power ELSE 0 END as connect_power_kva, \
 CASE WHEN coalesce(eqp.con_power_kva,0) = 0 THEN eqp.connect_power ELSE 0 END as connect_power_kvt \
 from \
 bal_grp_tree_tbl as p \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = p.id_p_eqp ) \
 join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp) \
 join clm_client_tbl as c on (c.id = p.id_client ) \
 join eqk_voltage_tbl as vv on (vv.id = eqp.id_voltage) \
 where p.type_eqp=12 and p.mmgg = :mmgg::::date \
 and ps.mmgg = :mmgg::::date \
 and p.id_client > 0 \
 and vv.voltage_min >= 1 \
 and eqp.reserv=0 \
 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
 )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.code_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.code_grp and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
    left join eqm_equipment_tbl as eqps on (eqps.id = ff.id_station) \
) as bigs \
 group by bigs.code_ps35 ,bigs.code, bigs.client, bigs.id_client order by bigs.code  ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr2);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";


  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}

//---------------------------------------------------------------------------
void TfReports::PrintAreaDemand_mem(TDateTime mmgg, int id_client)
{
//  AnsiString sqlstr;
/*
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }
*/

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select date_trunc('year', :mmgg::::date)::::date as dt1,(date_trunc('year', :mmgg::::date)+ '1 year'::::interval- '1 day'::::interval)::::date as dt2 ;");

  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
   ZQReps->Open();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }

  TDateTime dt1 =   ZQReps->FieldByName("dt1")->AsDateTime;
  TDateTime dt2 =   ZQReps->FieldByName("dt2")->AsDateTime;

  ZQReps->Close();

  //max(CASE WHEN p.reserv=0 THEN p.power ELSE 0 END) as power,
  //  left join rep_lighting_points_tmp as lp on (lp.id_point = bs.id_point)
  //  sum(CASE WHEN (lp.id_point is null) then bs.power ELSE 0 END) as power,

  AnsiString  sqlstr1="select eq.name_eqp, addr.adr, sum(bs.demand) as demand,  \
  sum(bs.demand1) as demand1, sum(bs.demand2) as demand2, sum(bs.demand3) as demand3, sum(bs.demand4) as demand4, \
  sum(bs.demand5) as demand5, sum(bs.demand6) as demand6, sum(bs.demand7) as demand7, sum(bs.demand8) as demand8,\
  sum(bs.demand9) as demand9, sum(bs.demand10) as demand10, sum(bs.demand11) as demand11, sum(bs.demand12) as demand12, \
  gr.power, gr.wtm, max(bs.voltage) as voltage \
   from \
  ( select b.id_client, bs.id_point, sum(bs.demand_val) as demand,   \
    max(v.voltage_min) as voltage,\
    sum(CASE WHEN date_part('month',b.mmgg) = 1 THEN bs.demand_val ELSE 0 END) as demand1, \
    sum(CASE WHEN date_part('month',b.mmgg) = 2 THEN bs.demand_val ELSE 0 END) as demand2, \
    sum(CASE WHEN date_part('month',b.mmgg) = 3 THEN bs.demand_val ELSE 0 END) as demand3, \
    sum(CASE WHEN date_part('month',b.mmgg) = 4 THEN bs.demand_val ELSE 0 END) as demand4, \
    sum(CASE WHEN date_part('month',b.mmgg) = 5 THEN bs.demand_val ELSE 0 END) as demand5, \
    sum(CASE WHEN date_part('month',b.mmgg) = 6 THEN bs.demand_val ELSE 0 END) as demand6, \
    sum(CASE WHEN date_part('month',b.mmgg) = 7 THEN bs.demand_val ELSE 0 END) as demand7, \
    sum(CASE WHEN date_part('month',b.mmgg) = 8 THEN bs.demand_val ELSE 0 END) as demand8, \
    sum(CASE WHEN date_part('month',b.mmgg) = 9 THEN bs.demand_val ELSE 0 END) as demand9, \
    sum(CASE WHEN date_part('month',b.mmgg) = 10 THEN bs.demand_val ELSE 0 END) as demand10, \
    sum(CASE WHEN date_part('month',b.mmgg) = 11 THEN bs.demand_val ELSE 0 END) as demand11, \
    sum(CASE WHEN date_part('month',b.mmgg) = 12 THEN bs.demand_val ELSE 0 END) as demand12  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    join eqm_point_tbl as p on (bs.id_point = p.code_eqp) \
    join eqk_voltage_tbl as v on (v.id = p.id_voltage) \
    where b.id_pref=10 \
    and ((date_part('year',b.mmgg) = date_part('year', :mmgg::::date)   and date_part('month',b.mmgg) <=date_part('month', :mmgg::::date)) or \
         (date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) > date_part('month', :mmgg::::date)))\
    and b.id_client = :client \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bs \
  join clm_client_tbl as c on (c.id = bs.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  left join \
    (select inst.code_eqp, inst.code_eqp_inst from eqm_compens_station_inst_h as inst \
     join (select code_eqp, code_eqp_inst, max(dt_b) as dt from eqm_compens_station_inst_h where dt_b < :mmgg12 \
     and (dt_e is null or dt_e >= :mmgg1 ) \
          group by code_eqp, code_eqp_inst order by  code_eqp, code_eqp_inst) as inst2 \
          on (inst.code_eqp = inst2.code_eqp and inst.code_eqp_inst = inst2.code_eqp_inst and inst2.dt = inst.dt_b) \
    ) as csi on (bs.id_point = csi.code_eqp) \
  left join eqm_equipment_tbl as eq on (eq.id = csi.code_eqp_inst) \
  left join eqm_ground_tbl as gr on (gr.code_eqp = csi.code_eqp_inst) \
  left join adv_address_tbl as addr on (addr.id = eq.id_addres) \
  where (eq.type_eqp = 11 or eq.id is null) \
  group by eq.id, eq.name_eqp, addr.adr,gr.wtm,gr.power \
  order by name_eqp ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=dt1;
  ZQXLReps->ParamByName("mmgg12")->AsDateTime=dt2;
  ZQXLReps->ParamByName("client")->AsInteger=id_client;



  AnsiString  sqlstr2=" select c.code, c.short_name, scl.dt_indicat, scl.dt_start ,scl.doc_num, scl.doc_dat, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date(date_trunc('year',:mmgg::::date)::::date ,scl.dt_start) \
  END as from1, \
  calend_get_date(date_trunc('year',:mmgg::::date)::::date ,scl.dt_indicat) as to1, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'1 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'1 month'::::interval)::::date ,scl.dt_start) \
  END as from2, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'1 month'::::interval)::::date ,scl.dt_indicat) as to2, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'2 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'2 month'::::interval)::::date ,scl.dt_start) \
  END as from3, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'2 month'::::interval)::::date ,scl.dt_indicat) as to3, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'3 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'3 month'::::interval)::::date ,scl.dt_start) \
  END as from4, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'3 month'::::interval)::::date ,scl.dt_indicat) as to4, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'4 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'4 month'::::interval)::::date ,scl.dt_start) \
  END as from5, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'4 month'::::interval)::::date ,scl.dt_indicat) as to5, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'5 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'5 month'::::interval)::::date ,scl.dt_start) \
  END as from6, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'5 month'::::interval)::::date ,scl.dt_indicat) as to6, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'6 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'6 month'::::interval)::::date ,scl.dt_start) \
  END as from7, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'6 month'::::interval)::::date ,scl.dt_indicat) as to7, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'7 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'7 month'::::interval)::::date ,scl.dt_start) \
  END as from8, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'7 month'::::interval)::::date ,scl.dt_indicat) as to8, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'8 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'8 month'::::interval)::::date ,scl.dt_start) \
  END as from9, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'8 month'::::interval)::::date ,scl.dt_indicat) as to9, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'9 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'9 month'::::interval)::::date ,scl.dt_start) \
  END as from10, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'9 month'::::interval)::::date ,scl.dt_indicat) as to10, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'10 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'10 month'::::interval)::::date ,scl.dt_start) \
  END as from11, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'10 month'::::interval)::::date ,scl.dt_indicat) as to11, \
  CASE WHEN scl.dt_start >=scl.dt_indicat THEN \
    calend_get_date((date_trunc('year',:mmgg::::date) +'11 month'::::interval - '1 month'::::interval)::::date,scl.dt_start) \
  ELSE \
    calend_get_date((date_trunc('year',:mmgg::::date)+'11 month'::::interval)::::date ,scl.dt_start) \
  END as from12, \
  calend_get_date((date_trunc('year',:mmgg::::date)+'11 month'::::interval)::::date ,scl.dt_indicat) as to12 \
  from clm_client_tbl as c  \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  where c.id = :client ;";


  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("client")->AsInteger=id_client;
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;
  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";

  Param=xlReport->Params->Add();
  Param->Name="lddmm1";
  Param=xlReport->Params->Add();
  Param->Name="lddmm2";
  Param=xlReport->Params->Add();
  Param->Name="lddmm3";
  Param=xlReport->Params->Add();
  Param->Name="lddmm4";
  Param=xlReport->Params->Add();
  Param->Name="lddmm5";
  Param=xlReport->Params->Add();
  Param->Name="lddmm6";
  Param=xlReport->Params->Add();
  Param->Name="lddmm7";
  Param=xlReport->Params->Add();
  Param->Name="lddmm8";
  Param=xlReport->Params->Add();
  Param->Name="lddmm9";
  Param=xlReport->Params->Add();
  Param->Name="lddmm10";
  Param=xlReport->Params->Add();
  Param->Name="lddmm11";
  Param=xlReport->Params->Add();
  Param->Name="lddmm12";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value =" за "+ FormatDateTime("yyyy",dt1);

  ShortMonthNames[0]="Січня";
  ShortMonthNames[1]="Лютого";
  ShortMonthNames[2]="Березня";
  ShortMonthNames[3]="Квітня";
  ShortMonthNames[4]="Травня";
  ShortMonthNames[5]="Червня";
  ShortMonthNames[6]="Липня";
  ShortMonthNames[7]="Серпня";
  ShortMonthNames[8]="Вересня";
  ShortMonthNames[9]="Жовтня";
  ShortMonthNames[10]="Листопада";
  ShortMonthNames[11]="Грудня";

  xlReport->ParamByName["lddmm1"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from1")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to1")->AsDateTime);

  xlReport->ParamByName["lddmm2"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from2")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to2")->AsDateTime);

  xlReport->ParamByName["lddmm3"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from3")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to3")->AsDateTime);

  xlReport->ParamByName["lddmm4"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from4")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to4")->AsDateTime);

  xlReport->ParamByName["lddmm5"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from5")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to5")->AsDateTime);

  xlReport->ParamByName["lddmm6"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from6")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to6")->AsDateTime);

  xlReport->ParamByName["lddmm7"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from7")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to7")->AsDateTime);

  xlReport->ParamByName["lddmm8"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from8")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to8")->AsDateTime);

  xlReport->ParamByName["lddmm9"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from9")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to9")->AsDateTime);

  xlReport->ParamByName["lddmm10"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from10")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to10")->AsDateTime);

  xlReport->ParamByName["lddmm11"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from11")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to11")->AsDateTime);

  xlReport->ParamByName["lddmm12"]->Value = "з "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("from12")->AsDateTime)+
                                          " \n до "+FormatDateTime("dd mmm",ZQXLReps2->FieldByName("to12")->AsDateTime);

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;


  xlReport->Report();

 ZQXLReps->Close();

}
////////////---------------------------------------------
void TfReports::PrintAreaDemand_meters(TDateTime mmgg)
{
//  AnsiString sqlstr;

  ZQReps->Close();

  AnsiString  sqlstr1=" select c.code, c.short_name, csi.name_eqp, addr.adr, im.type, em.dt_control,   \
  bs.id_meter,bs.num_eqp,bs.id_type_eqp,bs.k_tr, \
  CASE WHEN scl.id_section = 209 THEN 0 ELSE bs.demand_a1 END as demand_a1, bs.demand_r1, CASE WHEN (p.reserv=0) then p.power ELSE 0 END as power  \
  from \
  ( select * from  \
 ( select b.id_client, bs.id_point, mkz.id_meter, mkz.num_eqp, mkz.id_type_eqp, mkz.k_tr, \
    sum(bs.demand_val)::::numeric as demand_a1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    left join( select mz.id_doc, mz.id_point, mz.id_meter, mz.num_eqp, mz.id_type_eqp, max(mz.k_tr) as k_tr \
     from acd_met_kndzn_tbl as mz join \
     (select mz4.id_point,mz4.id_doc, mz4.id_meter, max(mz4.num_eqp) as num_eqp \
           from acd_met_kndzn_tbl as mz4 join \
             (select id_point,id_doc, max(id_meter) as id_meter \
                    from acd_met_kndzn_tbl where kind_energy=1 and mmgg = :mmgg::::date group by id_point,id_doc order by id_point,id_doc \
             ) as mz3 \
   	     on (mz4.id_point = mz3.id_point and mz4.id_doc = mz3.id_doc and mz4.id_meter = mz3.id_meter )\
	where mz4.kind_energy=1 and mz4.mmgg = :mmgg::::date group by mz4.id_point,mz4.id_doc,mz4.id_meter order by mz4.id_point,mz4.id_doc \
     ) as mz2 \
     on (mz.id_point = mz2.id_point and mz.id_doc = mz2.id_doc and mz.id_meter = mz2.id_meter and mz.num_eqp = mz2.num_eqp) \
     group by mz.id_doc, mz.id_point, mz.id_meter, mz.num_eqp, mz.id_type_eqp \
    ) as mkz on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc) \
    where b.id_pref=10 \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point ,mkz.id_meter, mkz.num_eqp, mkz.id_type_eqp, mkz.k_tr   order by b.id_client, bs.id_point  \
  ) as bsa1  \
  full join ( select b.id_client, bs.id_point, mkz.id_meter, mkz.num_eqp, mkz.id_type_eqp, mkz.k_tr, \
    sum(bs.demand_val)::::numeric as demand_r1  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    left join( select  mz.id_doc, mz.id_point, mz.id_meter, mz.num_eqp, mz.id_type_eqp, max(mz.k_tr) as k_tr \
     from acd_met_kndzn_tbl as mz join \
     (select mz4.id_point,mz4.id_doc, mz4.id_meter, max(mz4.num_eqp) as num_eqp \
           from acd_met_kndzn_tbl as mz4 join \
             (select id_point,id_doc, max(id_meter) as id_meter \
                    from acd_met_kndzn_tbl where kind_energy=2 and mmgg = :mmgg::::date group by id_point,id_doc order by id_point,id_doc \
             ) as mz3 \
   	     on (mz4.id_point = mz3.id_point and mz4.id_doc = mz3.id_doc and mz4.id_meter = mz3.id_meter )\
	where mz4.kind_energy=2 and mz4.mmgg = :mmgg::::date group by mz4.id_point,mz4.id_doc,mz4.id_meter order by mz4.id_point,mz4.id_doc \
     ) as mz2 \
     on (mz.id_point = mz2.id_point and mz.id_doc = mz2.id_doc and mz.id_meter = mz2.id_meter and mz.num_eqp = mz2.num_eqp) \
     group by mz.id_doc, mz.id_point, mz.id_meter, mz.num_eqp, mz.id_type_eqp \
    ) as mkz on (bs.id_point = mkz.id_point and b.id_doc = mkz.id_doc) \
    where b.id_pref=20  and bs.kind_energy = 2  \
    and b.mmgg = :mmgg  \
    group by b.id_client, bs.id_point ,mkz.id_meter, mkz.num_eqp, mkz.id_type_eqp, mkz.k_tr   order by b.id_client, bs.id_point   \
  ) as bsr1 using (id_client,id_point,id_meter,num_eqp,id_type_eqp,k_tr   ) \
  ) as bs     \
  join clm_client_tbl as c on (c.id = bs.id_client) \
  join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  left join eqm_point_tbl as p on (bs.id_point = p.code_eqp) \
  left join eqm_meter_tbl as em on (bs.id_meter = em.code_eqp) \
  left join eqi_meter_tbl as im on (im.id = bs.id_type_eqp) \
  left join (select csi.code_eqp, eq.name_eqp, eq.id_addres  from \
          eqm_compens_station_inst_tbl as csi \
          join eqm_equipment_tbl as eq on (eq.id = csi.code_eqp_inst) \
          where eq.type_eqp = 11 \
          order by csi.code_eqp \
  ) as csi on (bs.id_point = csi.code_eqp) \
  left join adv_address_tbl as addr on (addr.id = csi.id_addres) \
  where scl.id_section not in (205,206,207,208) \
  and c.idk_work not in (0,99) \
  and c.book = -1  \
  order by c.code,name_eqp,num_eqp ;";

//   left join clm_statecl_h as scl on (c.id = scl.id_client) \
//  and scl.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = scl.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
//  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value =FormatDateTime("mmmm yyyy",mmgg);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------

void TfReports::PrintCommonAccInfo(TDateTime mmgg)
{

  AnsiString  sqlstr1="select \
         coalesce(sum(CASE WHEN ident ='tgr8_10' and section =1017  THEN demand_val ELSE 0 END )/1000,0) as dem_10_17, \
         coalesce(count( distinct CASE WHEN ident ='tgr8_10' and section =1017  THEN id ELSE null END ),0) as cnt_10_17, \
         coalesce(sum(CASE WHEN ident ='tgr8_10' and section =1018  THEN demand_val ELSE 0 END )/1000,0) as dem_10_18, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_10' and section =1018  THEN id ELSE null END ),0) as cnt_10_18, \
         coalesce(sum(CASE WHEN ident ='tgr8_10' and section =1019  THEN demand_val ELSE 0 END )/1000,0) as dem_10_19, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_10' and section =1019  THEN id ELSE null END ),0) as cnt_10_19, \
         coalesce(sum(CASE WHEN ident ~'tgr8_10' and coalesce(section,0) =1020  THEN demand_val ELSE 0 END )/1000,0) as dem_10_20, \
         coalesce(count(distinct CASE WHEN ident ~'tgr8_10' and coalesce(section,0) =1020  THEN id ELSE null END ),0) as cnt_10_20, \
         coalesce(sum(CASE WHEN ident ~'tgr8_10' and coalesce(section,0) =1021  THEN demand_val ELSE 0 END )/1000,0) as dem_10_21, \
         coalesce(count(distinct CASE WHEN ident ~'tgr8_10' and coalesce(section,0) =1021  THEN id ELSE null END ),0) as cnt_10_21, \
         coalesce(sum(CASE WHEN ident ='tgr8_10' and coalesce(section,0) not in (1017,1018,1019,1020,1021)  THEN demand_val ELSE 0 END )/1000,0) as dem_10_other, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_10' and coalesce(section,0) not in (1017,1018,1019,1020,1021)  THEN id ELSE null END ),0) as cnt_10_other, \
         coalesce(sum(CASE WHEN ident ='tgr8_30' and section =1017  THEN demand_val ELSE 0 END )/1000,0) as dem_30_17, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_30' and section =1017  THEN id ELSE null END ),0) as cnt_30_17, \
         coalesce(sum(CASE WHEN ident ='tgr8_30' and section =1018  THEN demand_val ELSE 0 END )/1000,0) as dem_30_18, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_30' and section =1018  THEN id ELSE null END ),0) as cnt_30_18, \
         coalesce(sum(CASE WHEN ident ='tgr8_30' and section =1019  THEN demand_val ELSE 0 END )/1000,0) as dem_30_19, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_30' and section =1019  THEN id ELSE null END ),0) as cnt_30_19, \
         coalesce(sum(CASE WHEN ident ='tgr8_30' and coalesce(section,0) not in (1017,1018,1019,1020,1021)  THEN demand_val ELSE 0 END )/1000,0) as dem_30_other, \
         coalesce(count (distinct CASE WHEN ident ='tgr8_30' and coalesce(section,0) not in (1017,1018,1019,1020,1021)  THEN id ELSE null END ),0) as cnt_30_other, \
         coalesce(sum(CASE WHEN ident ='tgr8_12' THEN demand_val ELSE 0 END )/1000,0) as dem_12, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_12' THEN id ELSE null END ),0) as cnt_12, \
         coalesce(sum(CASE WHEN ident ='tgr8_22' THEN demand_val ELSE 0 END )/1000,0) as dem_22, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_22' THEN id ELSE null END ),0) as cnt_22, \
         coalesce(sum(CASE WHEN ident ='tgr8_32' THEN demand_val ELSE 0 END )/1000,0) as dem_32, \
         coalesce(count(distinct CASE WHEN ident ='tgr8_32' THEN id ELSE null END ),0) as cnt_32, \
         coalesce(sum(CASE WHEN ident in ('tgr8_62','tgr8_63') THEN demand_val ELSE 0 END )/1000,0) as dem_62, \
         coalesce(count(distinct CASE WHEN ident in ('tgr8_62','tgr8_63') THEN id ELSE null END ),0) as cnt_62, \
         coalesce(sum(CASE WHEN ident = 'tgr8_61' THEN demand_val ELSE 0 END )/1000,0) as dem_61, \
         coalesce(count(distinct CASE WHEN ident = 'tgr8_61' THEN id ELSE null END ),0) as cnt_61, \
         coalesce(sum(CASE WHEN ident = 'tgr7_13' THEN demand_val ELSE 0 END )/1000,0) as dem_13, \
         coalesce(count(distinct CASE WHEN ident = 'tgr7_13' THEN id ELSE null END ),0) as cnt_13, \
         coalesce(sum(CASE WHEN ident = 'tgr7_23' THEN demand_val ELSE 0 END )/1000,0) as dem_23, \
         coalesce(count(distinct CASE WHEN ident = 'tgr7_23' THEN id ELSE null END ),0) as cnt_23 \
  from \
  (select cl.id, tgr.id as id_tgr, tgr.ident, p.id AS section, \
   sum(bs.demand_val) as demand_val, round(sum(bs.sum_val),2) as sum_val, count(distinct cl.id) as cnt \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref in(10,101)  and b.idk_doc<>280 and cl.book = -1 \
  and bs.mmgg= :mmgg::::date \
  and coalesce(b.demand_val,0) <> 0 \
  and ((tgr.ident like 'tgr8%') or (tgr.ident in ('tgr7_13','tgr7_23') )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  group by tgr.id, tgr.ident, section, cl.id ) as s1 ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  AnsiString  sqlstr21="  select code, name , id_tgr, ident, tar , section, addname, (ident||'-'||section)::::varchar as link, \
     sum(demand_val)::::numeric/1000 as demand_val, round(sum(sum_val),2) as sum_val \
  from \
  (select cl.code, cl.short_name as name , tgr.id as id_tgr, tgr.ident, tgr.short_name as tar, \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.id,0) ELSE 0 END AS section, \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.name,'') ELSE '' END AS addname , \
  bs.demand_val,bs.sum_val\
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref in (10,101)  and b.idk_doc<>280 and cl.book = -1 \
  and bs.mmgg= :mmgg::::date \
  and coalesce(b.demand_val,0) <> 0 \
  and ((tgr.ident like 'tgr8%') or (tgr.ident in ('tgr7_13','tgr7_23') )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  ) as sss \
  group by code, name , id_tgr, ident, tar , section, addname, (ident||'-'||section)::::varchar \
order by ident, code  ;";


  AnsiString  sqlstr22="  select code, name , id_point, name_eqp, id_tgr, ident, tar , section, \
     adr, represent_name, addname, num_eqp, (ident||'-'||section)::::varchar as link, \
     sum(demand_val)::::numeric/1000 as demand_val, round(sum(sum_val),2) as sum_val \
  from \
  (select cl.code, cl.short_name as name , bs.id_point, eq.name_eqp, tgr.id as id_tgr, tgr.ident, tgr.short_name as tar, \
  adr.adr, cp.represent_name, eqm.num_eqp,  \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.id,0) ELSE 0 END AS section, \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.name,'') ELSE '' END AS addname , \
  bs.demand_val,bs.sum_val\
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  left join clm_position_tbl as cp on (ph.id_position=cp.id) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  left join eqm_meter_point_h as mp on (mp.id_point = bs.id_point and mp.dt_e is null) \
  left join eqm_equipment_tbl as eqm on (eqm.id = mp.id_meter) \
  where b.id_pref in (10,101)  and b.idk_doc<>280 and cl.book = -1 \
  and bs.mmgg= :mmgg::::date \
  and coalesce(b.demand_val,0) <> 0 \
  and ((tgr.ident like 'tgr8%') or (tgr.ident in ('tgr7_13','tgr7_23') )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  ) as sss \
  group by code, name , id_point, name_eqp, id_tgr, ident, tar , section, addname, adr, represent_name, num_eqp, \
   (ident||'-'||section)::::varchar order by ident, code  ;";


  AnsiString  sqlstr3="  select ident, tar , section, addname, (ident||'-'||section)::::varchar as link, \
     sum(demand_val)::::numeric/1000 as demand_val, round(sum(sum_val),2) as sum_val, count(distinct code) as cnt \
  from \
  (select cl.code, cl.short_name as name , tgr.id as id_tgr, tgr.ident, tgr.short_name as tar, \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.id,0) ELSE 0 END AS section, \
  CASE WHEN tgr.ident in ('tgr8_10','tgr8_30','tgr8_101') THEN coalesce(p.name,'') ELSE '' END AS addname , \
  bs.demand_val,bs.sum_val\
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref in (10,101)  and b.idk_doc<>280  and cl.book = -1 \
  and bs.mmgg= :mmgg::::date \
  and coalesce(b.demand_val,0) <> 0 \
  and ((tgr.ident like 'tgr8%') or (tgr.ident in ('tgr7_13','tgr7_23') )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  ) as sss \
  group by ident, tar , section, addname, (ident||'-'||section)::::varchar \
order by ident, section  ;";

  ZQXLReps2->Close();
  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr21);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLRepsSum2->Close();
  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;


  ZQXLReps3->Close();
  ZQXLReps3->Sql->Clear();
  ZQXLReps3->Sql->Add(sqlstr22);
  ZQXLReps3->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLRepsSum3->Close();
  ZQXLRepsSum3->Sql->Clear();
  ZQXLRepsSum3->Sql->Add(sqlstr3);
  ZQXLRepsSum3->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps2->MasterSource=DSRep2;
  ZQXLReps2->LinkFields="link = link";

  ZQXLReps3->MasterSource=DSRep3;
  ZQXLReps3->LinkFields="link = link";

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLReps3->Open();
    ZQXLRepsSum2->Open();
    ZQXLRepsSum3->Open();

  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsSum2";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum2";


  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum3;
  Dsr->Alias =  "ZQXLRepsSum3";
  Dsr->Range = "GroupRange2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps3;
  Dsr->Alias = "ZQXLReps3";
  Dsr->Range = "Range2";
  Dsr->MasterSourceName="ZQXLRepsSum3";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();
 ZQXLReps3->Close();
 ZQXLRepsSum3->Close();
 ZQXLRepsSum2->Close();

 ZQXLReps2->MasterSource=NULL;
 ZQXLReps2->LinkFields="";

 ZQXLReps3->MasterSource=NULL;
 ZQXLReps3->LinkFields="";

}
//------------------------------------------------------------------------------
void TfReports::PrintLimitGroundYear(TDateTime mmgg)
{
 AnsiString  sqlstr1=" select cl.code,cl.name,cl.period_indicat, s1.*,cl.represent_name, area.name_eqp as area_name, area.power, area.wtm, area.adr as area_adr, area.is_used \
 from ( select c.id,c.code,c.short_name as name, cp.represent_name , scl.period_indicat \
        from clm_client_tbl as c \
        join clm_statecl_tbl as scl on (c.id = scl.id_client) \
        left join clm_position_tbl as cp on (scl.id_position = cp.id) \
        where scl.id_section not in (205,206,207,208) \
        and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
        and c.book=-1 \
      )  as cl \
      left join ( \
       select a.id_client, a.code_eqp, eq.name_eqp , g.power, g.wtm, addr.adr,  \
       CASE WHEN (select count(*) from eqm_compens_station_inst_tbl as csi where csi.code_eqp_inst = a.code_eqp) >0 THEN 1 ELSE 0 END as is_used \
       from eqm_area_tbl as a join eqm_ground_tbl as g on (g.code_eqp = a.code_eqp) \
       join eqm_equipment_tbl as eq on (eq.id = a.code_eqp) \
       left join adv_address_tbl as addr on (addr.id = eq.id_addres) \
      ) as area on (area.id_client = cl.id) \
   left join ( \
        select  id_client,id_area,     \
        sum(CASE WHEN date_part('month',month_limit)= 1 THEN value_dem ELSE 0 END) as value1 , \
	sum(CASE WHEN date_part('month',month_limit)= 2 THEN value_dem ELSE 0 END) as value2 , \
	sum(CASE WHEN date_part('month',month_limit)= 3 THEN value_dem ELSE 0 END) as value3 , \
	sum(CASE WHEN date_part('month',month_limit)= 4 THEN value_dem ELSE 0 END) as value4 , \
	sum(CASE WHEN date_part('month',month_limit)= 5 THEN value_dem ELSE 0 END) as value5 , \
	sum(CASE WHEN date_part('month',month_limit)= 6 THEN value_dem ELSE 0 END) as value6 , \
	sum(CASE WHEN date_part('month',month_limit)= 7 THEN value_dem ELSE 0 END) as value7 , \
	sum(CASE WHEN date_part('month',month_limit)= 8 THEN value_dem ELSE 0 END) as value8 , \
	sum(CASE WHEN date_part('month',month_limit)= 9 THEN value_dem ELSE 0 END) as value9 , \
	sum(CASE WHEN date_part('month',month_limit)= 10 THEN value_dem ELSE 0 END) as value10 , \
	sum(CASE WHEN date_part('month',month_limit)= 11 THEN value_dem ELSE 0 END) as value11 , \
	sum(CASE WHEN date_part('month',month_limit)= 12 THEN value_dem ELSE 0 END) as value12 \
        from ( \
         select distinct hl.id_client,d1.value_dem,d1.month_limit,d1.id_area \
           from acd_demandlimit_tbl as d1 \
           join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc)  \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and date_part('year',d2.month_limit)= date_part('year', :mmgg::::date ) \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
        where hl.idk_document = 600  and date_part('year',d1.month_limit)= date_part('year', :mmgg::::date ) \
       order by hl.id_client,id_area \
       ) as ss group by id_client, id_area \
   ) as s1 on (s1.id_client =cl.id and s1.id_area = area.code_eqp) \
 order by cl.code,area_name ;";

 //       where exists (select code_eqp from eqm_compens_station_inst_tbl as csi where csi.code_eqp_inst = a.code_eqp)
  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("yyyy",dtBegin->Date)+" рік";

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::Print8NKRE(TDateTime mmgg)
{
   // 1 страница
  AnsiString  sqlstr1="select cl.code, cl.short_name,ss.*, ident as link from \
  (select tgr.ident, b.id_client, eq.name_eqp, eq.id as id_point, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum  \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  where b.id_pref in (10,101)  and b.idk_doc<>280 \
  and bs.mmgg =:mmgg \
  and (tgr.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, eq.name_eqp, eq.id, tgr.ident  \
  union all \
 select distinct tgr2.ident, coalesce(use.id_client, tr.id_client),eq2.name_eqp,eq2.id as id_point,0,0 \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join aci_tarif_tbl as tar2 on (tar2.id=ph2.id_tarif) \
  join eqi_grouptarif_tbl as tgr2 on (tar2.id_grouptarif=tgr2.id) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  (tgr2.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) \
  and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ; ";

   // 1 стр. группы
  AnsiString  sqlstr2="select tgr2.ident, tgr2.name, tgr2.ident as link, ss.*, \
  CASE WHEN tgr2.ident ='tgr7_13' THEN 'tgr8_41' WHEN tgr2.ident ='tgr8_101' THEN 'tgr8_42' WHEN ident ='tgr7_23' THEN 'tgr8_43' ELSE tgr2.ident END as sort \
  from \
  (select s.id as tgr_id, sum(s.demand_val) as demand, round(sum(s.sum_val),2) as sum , count(distinct s.id_client) as cnt \
   from (select tgr.id, b.id_client, bs.demand_val, bs.sum_val  \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  where b.id_pref in (10,101)  and b.idk_doc<>280  \
  and bs.mmgg =:mmgg \
  and (tgr.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  union all \
 select distinct tgr2.id, coalesce(use.id_client, tr.id_client) as id_client ,0,0 \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join aci_tarif_tbl as tar2 on (tar2.id=ph2.id_tarif) \
  join eqi_grouptarif_tbl as tgr2 on (tar2.id_grouptarif=tgr2.id) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  (tgr2.ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) \
  and bs2.id_point is null ) as s \
  join clm_client_tbl as cl on (cl.id = s.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  group by s.id \
 ) as ss \
 join eqi_grouptarif_tbl as tgr2 on (ss.tgr_id=tgr2.id) \
  order by sort ; ";

  // религия
  AnsiString  sqlstr3="   select cl.code, cl.short_name,ss.* from \
  (select b.id_client, bs.id_point, eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum , vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where b.id_pref in (10,101)  and b.idk_doc<>280  \
  and bs.mmgg =:mmgg \
  and ph.id_extra in (1003,1004) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, bs.id_point, eq.name_eqp, vv.voltage_min \
  union \
 select distinct coalesce(use.id_client, tr.id_client),ph2.code_eqp as id_point, eq2.name_eqp,0,0,vv2.voltage_min \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join eqk_voltage_tbl as vv2 on (vv2.id=ph2.id_voltage) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  ph2.id_extra in (1003,1004) and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ;";

  //тюрьмы
  AnsiString  sqlstr4=" select cl.code, cl.short_name,ss.* from \
  (select b.id_client, bs.id_point,eq.name_eqp, sum(bs.demand_val) as demand, round(sum(bs.sum_val),2) as sum , vv.voltage_min as voltage \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eq on (eq.id = bs.id_point) \
  join eqk_voltage_tbl as vv on (vv.id=ph.id_voltage) \
  where b.id_pref in (10,101)  and b.idk_doc<>280  \
  and bs.mmgg =:mmgg \
  and ph.id_extra in (1001,1002,1012,1013) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = bs.id_point and eq2.dt_b <= coalesce(b.dat_e,eq2.dt_b) ) \
  group by b.id_client, bs.id_point, eq.name_eqp, vv.voltage_min \
  union \
 select distinct coalesce(use.id_client, tr.id_client),ph2.code_eqp as id_point, eq2.name_eqp,0,0,vv2.voltage_min \
  from eqm_tree_tbl as tr \
  join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
  join eqm_point_tbl as ph2 on (ttr.code_eqp = ph2.code_eqp) \
  join eqm_equipment_tbl as eq2 on (eq2.id = ttr.code_eqp) \
  join eqk_voltage_tbl as vv2 on (vv2.id=ph2.id_voltage) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp = ph2.code_eqp) \
  left join acd_billsum_tbl as bs2 on (ph2.code_eqp = bs2.id_point and bs2.mmgg = :mmgg ) \
  where  ph2.id_extra in (1001,1002,1012,1013) and bs2.id_point is null ) as ss \
  join clm_client_tbl as cl on (cl.id = ss.id_client) \
  where cl.idk_work not in (0,99) and coalesce(cl.id_state,0) not in (50,99) \
  order by cl.code ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr3);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps3->Sql->Clear();
  ZQXLReps3->Sql->Add(sqlstr4);
  ZQXLReps3->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  // итоговые суммы
  AnsiString  sqlstr5=" select \
         coalesce(sum(CASE WHEN (ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) THEN demand_val ELSE 0 END ),0) as demand1, \
         coalesce(sum(CASE WHEN (ident in ('tgr8_10','tgr8_101','tgr8_12','tgr8_22','tgr8_30','tgr8_32','tgr7_13','tgr7_23' )) THEN sum_val ELSE 0 END ),0) as sumval1, \
         coalesce(sum(CASE WHEN extra =1003 and tcl_ident='tcl1' THEN demand_val ELSE 0 END ),0) as demand211, \
         coalesce(sum(CASE WHEN extra =1003 and tcl_ident='tcl2' THEN demand_val ELSE 0 END ),0) as demand212, \
         coalesce(sum(CASE WHEN extra =1003 and tcl_ident='tcl1' THEN sum_val ELSE 0 END ),0) as sum211, \
         coalesce(sum(CASE WHEN extra =1003 and tcl_ident='tcl2' THEN sum_val ELSE 0 END ),0) as sum212, \
         coalesce(sum(CASE WHEN extra =1004 and tcl_ident='tcl1' THEN demand_val ELSE 0 END ),0) as demand221, \
         coalesce(sum(CASE WHEN extra =1004 and tcl_ident='tcl2' THEN demand_val ELSE 0 END ),0) as demand222, \
         coalesce(sum(CASE WHEN extra =1004 and tcl_ident='tcl1' THEN sum_val ELSE 0 END ),0) as sum221, \
         coalesce(sum(CASE WHEN extra =1004 and tcl_ident='tcl2' THEN sum_val ELSE 0 END ),0) as sum222, \
         coalesce(sum(CASE WHEN extra in (1001,1012,1013) and tcl_ident='tcl1' THEN demand_val ELSE 0 END ),0) as demand311, \
         coalesce(sum(CASE WHEN extra in (1001,1012,1013) and tcl_ident='tcl2' THEN demand_val ELSE 0 END ),0) as demand312, \
         coalesce(sum(CASE WHEN extra in (1001,1012,1013) and tcl_ident='tcl1' THEN sum_val ELSE 0 END ),0) as sum311, \
         coalesce(sum(CASE WHEN extra in (1001,1012,1013) and tcl_ident='tcl2' THEN sum_val ELSE 0 END ),0) as sum312, \
         coalesce(sum(CASE WHEN extra =1002 and tcl_ident='tcl1' THEN demand_val ELSE 0 END ),0) as demand321, \
         coalesce(sum(CASE WHEN extra =1002 and tcl_ident='tcl2' THEN demand_val ELSE 0 END ),0) as demand322, \
         coalesce(sum(CASE WHEN extra =1002 and tcl_ident='tcl1' THEN sum_val ELSE 0 END ),0) as sum321, \
         coalesce(sum(CASE WHEN extra =1002 and tcl_ident='tcl2' THEN sum_val ELSE 0 END ),0) as sum322 \
  from ( \
  select cl.id, ph.code_eqp, tgr.ident, tcl.ident as tcl_ident, coalesce(ph.id_extra,0) as extra, bs.demand_val, bs.sum_val \
  from acd_billsum_tbl as bs \
  join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  join eqi_classtarif_tbl as tcl on (tar.id_classtarif=tcl.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  left join cla_param_tbl as p on (p.id=ph.id_extra) \
  where b.id_pref in (10,101)  and b.idk_doc<>280  and cl.book = -1  and bs.sum_val <>0 \
  and bs.mmgg =:mmgg \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(b.dat_e,p2.dt_b) ) \
  order by code_eqp \
) as s2 ;";


  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr5);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;


  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLReps3->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  ZQXLReps->First();
  int cl =0;
  int cl_count1 = 0;
  for(int i=1;i<=ZQXLReps->RecordCount;i++)
  {
   if (ZQXLReps->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps->FieldByName("code")->AsInteger;
    cl_count1++;
   }
   ZQXLReps->Next();
  }

  ZQXLReps2->First();
  cl =0;
  int cl_count2 = 0;
  for(int i=1;i<=ZQXLReps2->RecordCount;i++)
  {
   if (ZQXLReps2->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps2->FieldByName("code")->AsInteger;
    cl_count2++;
   }
   ZQXLReps2->Next();
  }

  ZQXLReps3->First();
  cl =0;
  int cl_count3 = 0;
  for(int i=1;i<=ZQXLReps3->RecordCount;i++)
  {
   if (ZQXLReps3->FieldByName("code")->AsInteger !=cl )
   {
    cl = ZQXLReps3->FieldByName("code")->AsInteger;
    cl_count3++;
   }
   ZQXLReps3->Next();
  }

  ZQXLReps->Close();
  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLReps3->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range2";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps3;
  Dsr->Alias = "ZQXLReps3";
  Dsr->Range = "Range3";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias =  "ZQXLRepsSum2";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lcount1";
  Param=xlReport->Params->Add();
  Param->Name="lcount2";
  Param=xlReport->Params->Add();
  Param->Name="lcount3";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lcount1"]->Value = IntToStr(cl_count1);
  xlReport->ParamByName["lcount2"]->Value = IntToStr(cl_count2);
  xlReport->ParamByName["lcount3"]->Value = IntToStr(cl_count3);
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  xlReport->Report();

 ZQXLRepsSum->Close();
 ZQXLReps->Close();
 ZQXLReps2->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------
void TfReports::PrintAbonTarYear(TDateTime mmgg, int abon)
{
 AnsiString  sqlstr1=" select id_client,tgr_id,tgr_name, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN sum_val  END) as sum1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN sum_val  END) as sum2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN sum_val  END) as sum3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN sum_val  END) as sum4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN sum_val  END) as sum5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN sum_val  END) as sum6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN sum_val  END) as sum7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN sum_val  END) as sum8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN sum_val  END) as sum9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN sum_val END) as sum10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN sum_val END) as sum11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN sum_val END) as sum12, \
  count(distinct mmgg) as cnt \
from \
( select b.id_client, tar.id as tgr_id , tar.short_name as tgr_name, bs.mmgg, sum(bs.demand_val) as demand, sum(bs.sum_val) as sum_val \
  from \
  (select * from acm_bill_tbl where id_pref=10 and mmgg <= :mmgg::::date and mmgg >:mmgg::::date-'1 year'::::interval order by id_client) as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where \
   c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and id_client = :abon \
  group by b.id_client, tar.id ,tgr_name, bs.mmgg  \
) as sss \
 group by id_client, tgr_id,tgr_name \
 order by id_client, tgr_id ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("abon")->AsInteger=abon;

 AnsiString  sqlstr2=" select \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN sum_val  END) as sum1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN sum_val  END) as sum2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN sum_val  END) as sum3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN sum_val  END) as sum4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN sum_val  END) as sum5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN sum_val  END) as sum6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN sum_val  END) as sum7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN sum_val  END) as sum8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN sum_val  END) as sum9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN sum_val END) as sum10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN sum_val END) as sum11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN sum_val END) as sum12, \
  max(CASE WHEN date_part('month',mmgg)=1 THEN date_part('year',mmgg)  END) as year1, \
  max(CASE WHEN date_part('month',mmgg)=2 THEN date_part('year',mmgg)  END) as year2, \
  max(CASE WHEN date_part('month',mmgg)=3 THEN date_part('year',mmgg)  END) as year3, \
  max(CASE WHEN date_part('month',mmgg)=4 THEN date_part('year',mmgg)  END) as year4, \
  max(CASE WHEN date_part('month',mmgg)=5 THEN date_part('year',mmgg)  END) as year5, \
  max(CASE WHEN date_part('month',mmgg)=6 THEN date_part('year',mmgg)  END) as year6, \
  max(CASE WHEN date_part('month',mmgg)=7 THEN date_part('year',mmgg)  END) as year7, \
  max(CASE WHEN date_part('month',mmgg)=8 THEN date_part('year',mmgg)  END) as year8, \
  max(CASE WHEN date_part('month',mmgg)=9 THEN date_part('year',mmgg)  END) as year9, \
  max(CASE WHEN date_part('month',mmgg)=10 THEN date_part('year',mmgg) END) as year10, \
  max(CASE WHEN date_part('month',mmgg)=11 THEN date_part('year',mmgg) END) as year11, \
  max(CASE WHEN date_part('month',mmgg)=12 THEN date_part('year',mmgg) END) as year12 \
from \
( select b.id_client, tgr.id as tgr_id , tgr.short_name as tgr_name, bs.mmgg, sum(bs.demand_val) as demand, sum(bs.sum_val) as sum_val \
  from \
  (select * from acm_bill_tbl where id_pref=10 and mmgg <= :mmgg::::date and mmgg >:mmgg::::date-'1 year'::::interval order by id_client) as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where \
   c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and id_client = :abon \
  group by b.id_client, tgr.id ,tgr_name, bs.mmgg  \
) as sss  ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum->ParamByName("abon")->AsInteger=abon;

 AnsiString  sqlstr3=" select \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN demand  END) as dem1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN demand  END) as dem2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN demand  END) as dem3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN demand  END) as dem4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN demand  END) as dem5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN demand  END) as dem6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN demand  END) as dem7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN demand  END) as dem8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN demand  END) as dem9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN demand END) as dem10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN demand END) as dem11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN demand END) as dem12, \
  sum(CASE WHEN date_part('month',mmgg)=1 THEN sum_val  END) as sum1, \
  sum(CASE WHEN date_part('month',mmgg)=2 THEN sum_val  END) as sum2, \
  sum(CASE WHEN date_part('month',mmgg)=3 THEN sum_val  END) as sum3, \
  sum(CASE WHEN date_part('month',mmgg)=4 THEN sum_val  END) as sum4, \
  sum(CASE WHEN date_part('month',mmgg)=5 THEN sum_val  END) as sum5, \
  sum(CASE WHEN date_part('month',mmgg)=6 THEN sum_val  END) as sum6, \
  sum(CASE WHEN date_part('month',mmgg)=7 THEN sum_val  END) as sum7, \
  sum(CASE WHEN date_part('month',mmgg)=8 THEN sum_val  END) as sum8, \
  sum(CASE WHEN date_part('month',mmgg)=9 THEN sum_val  END) as sum9, \
  sum(CASE WHEN date_part('month',mmgg)=10 THEN sum_val END) as sum10, \
  sum(CASE WHEN date_part('month',mmgg)=11 THEN sum_val END) as sum11, \
  sum(CASE WHEN date_part('month',mmgg)=12 THEN sum_val END) as sum12 \
from \
( select b.id_client, tgr.id as tgr_id , tgr.short_name as tgr_name, bs.mmgg, sum(bs.demand_val) as demand, sum(bs.sum_val) as sum_val \
  from \
  (select * from acm_bill_tbl where id_pref=20 and mmgg <= :mmgg::::date and mmgg >:mmgg::::date-'1 year'::::interval order by id_client) as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as c on (c.id = b.id_client) \
  left join aci_tarif_tbl as tar on (tar.id=bs.id_tariff) \
  left join eqi_grouptarif_tbl as tgr on (tar.id_grouptarif=tgr.id) \
  where \
   c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and c.book = -1 \
  and id_client = :abon \
  group by b.id_client, tgr.id ,tgr_name, bs.mmgg  \
) as sss  ;";

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr3);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLRepsSum2->ParamByName("abon")->AsInteger=abon;


  AnsiString  sqlstr4="  select  c.code,c.name, sc.tax_num, '№ '||sc.doc_num ||' від '|| to_char(sc.doc_dat,'DD.MM.YYYY') as doc \
  from clm_client_tbl as c \
  join clm_statecl_h as sc on (c.id = sc.id_client) \
  where c.id = :abon \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ); ";

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr4);
  ZQXLReps2->ParamByName("abon")->AsInteger=abon;
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=mmgg;


  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();

  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("yyyy",dtBegin->Date)+" рік";

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::PrintSwitchList(boolean Build)
{

  if (Build)
  {
   AnsiString sqlstr="select rep_switch_area_start_fun();";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }


  AnsiString  sqlstr1="select eq.id, eq.name_eqp,eq.num_eqp,eq.dt_change as dt_install, \
   tr.id_client, cl1.short_name as name, c.short_name as name_use, eqa.name_eqp as area_name, adr2.adr::::varchar as area_adr,  \
   cl1.code , c.code as code_use, adr.adr::::varchar,  s.amperage_nom, eqi.type as switch_type, \
   eqk.name as switch_gr \
  from eqm_equipment_tbl AS eq \
  join eqm_switch_tbl as s on (s.code_eqp = eq.id) \
  join eqi_switch_tbl as eqi on (eqi.id = s.id_type_eqp) \
  join eqm_eqp_tree_tbl as eqt on (eqt.code_eqp =eq.id ) \
  join eqm_tree_tbl as tr on (eqt.id_tree = tr.id) \
  join clm_client_tbl as cl1 on (cl1.id=tr.id_client) \
  left join rep_switch_area_tmp as sa on (sa.id_switch = eq.id) \
  left join eqm_equipment_tbl AS eqa on (eqa.id = sa.id_area) \
  left join eqk_switchs_gr_tbl as eqk on (eqk.id = eqi.id_gr) \
  left join eqm_eqp_use_tbl as use on (use.code_eqp=eq.id) \
  left join clm_client_tbl as c on (coalesce(use.id_client,tr.id_client)=c.id) \
  left join adv_address_tbl as adr on (adr.id= CASE WHEN coalesce(eq.id_addres,0)=0 THEN c.id_addres ELSE eq.id_addres END) \
  left join adv_address_tbl as adr2 on (adr2.id= eqa.id_addres ) \
  where (eq.type_eqp = 3) \
  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  order by c.code,eq.name_eqp; ";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::CheckAreaParams(void)
{
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();


  AnsiString  sqlstr1=" select a.id_client, c.code, c.name, eq.name_eqp as area_name, adr.adr as area_adr, \
  gr.wtm , ss.wtm as wtm_point,  gr.power, ss.power as power_point \
  from (select ins.code_eqp_inst, min(p.wtm) as wtm, sum(p.power) as power \
    from eqm_point_tbl as p \
    join eqm_compens_station_inst_tbl as ins on (p.code_eqp = ins.code_eqp) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = p.code_eqp) \
    where coalesce(p.reserv,0)=0 and coalesce(p.share,0)=0 and lp.id_point is null \
  group by ins.code_eqp_inst) as ss \
  join eqm_ground_tbl as gr on (ss.code_eqp_inst = gr.code_eqp) \
  join eqm_area_tbl as a on (a.code_eqp = gr.code_eqp) \
  join clm_client_tbl as  c on (c.id = a.id_client) \
  join eqm_equipment_tbl as eq on (eq.id = a.code_eqp) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  where ((coalesce(ss.wtm,0) <> coalesce(gr.wtm,0)) or (coalesce(ss.power,0) <> coalesce(gr.power,0))) \
  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  order by c.code,eq.name_eqp; ";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}

//------------------------------------------------------------------------------
void TfReports::PS35_AbonSummary(TDateTime mmgg)
{
                /*
  AnsiString  sqlstr1=" select bigs.code_ps35 ,bigs.name_ps35,  bigs.code_vvod , bigs.name_vvod, \
  sum(fiz_count) as fiz_count, sum(fiz_power) as fiz_power, sum(prom_power) as prom_power, \
  sum(prom_power_1kl) as prom_power_1kl, \
  count(distinct CASE WHEN bigs.id_client> 0 THEN bigs.id_client ELSE null END ) as prom_count, \
  count(distinct CASE WHEN bigs.id_client> 0 and point_voltage in (1,2,11,12,21) THEN bigs.id_client ELSE null END ) as prom_count_1kl \
from( \
select ssss.*, \
coalesce(ff.id_station,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then code_eqp4 END) as code_ps35, \
coalesce(eqps.name_eqp,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then grpname4 END) as name_ps35, \
case when ssss.type_eqp = 3 then ssss.code_eqp \
     when ssss.type_eqp2 = 3 then ssss.code_eqp2 \
     when ssss.type_eqp3 = 3 then ssss.code_eqp3 \
     when ssss.type_eqp4 = 3 then ssss.code_eqp4 END as code_vvod, \
case when ssss.type_eqp = 3 then ssss.grpname \
     when ssss.type_eqp2 = 3 then ssss.grpname2 \
     when ssss.type_eqp3 = 3 then ssss.grpname3 \
     when ssss.type_eqp4 = 3 then ssss.grpname4 END as name_vvod \
from \
( \
 select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
from \
( select ps.code_eqp as code_grp, p.id_client, ps.name, eqp.id_voltage as point_voltage, \
 CASE when p.id_client =-1 THEN acc.fiz_count else 0 END as fiz_count , \
 CASE when p.id_client =-1 THEN acc.fiz_power else 0 END as fiz_power , \
 CASE when p.id_client >0  THEN eqp.power else 0 END as prom_power , \
 CASE when p.id_client >0  THEN 1 else 0 END as prom_count, \
 CASE when p.id_client >0 and eqp.id_voltage in (1,2,11,12,21) THEN eqp.power else 0 END as prom_power_1kl  \
 from \
 bal_grp_tree_tbl as p \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = p.id_p_eqp ) \
 join bal_acc_tbl as acc on (p.code_eqp = acc.code_eqp) \
 left join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp) \
 left join clm_client_tbl as c on (c.id = p.id_client ) \
 left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
  where p.type_eqp=12 \
 and p.mmgg = :mmgg::::date \
 and ps.mmgg = :mmgg::::date \
 and acc.mmgg = :mmgg::::date \
 and ((eqp.reserv=0  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and scl.id_section not in (205,206,207,208) ) or (p.id_client =-1)) \
 )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.code_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.code_grp and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
    left join eqm_equipment_tbl as eqps on (eqps.id = ff.id_station) \
) as bigs \
 group by bigs.code_ps35,bigs.name_ps35, bigs.code_vvod , bigs.name_vvod order by bigs.name_ps35,bigs.name_vvod   ;";
*/

  if(MessageDlg("Переформировать данные о подключении абонентов? ", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    //  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
  }

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

  try
  {
   ZQReps->ExecSql();
  }
  catch(EDatabaseError &e)
  {
   ShowMessage("Ошибка : "+e.Message.SubString(8,200));
   return;
  }


  AnsiString  sqlstr1=" select bigs.code_ps35 ,bigs.name_ps35,  bigs.code_vvod , bigs.name_vvod, \
  count(distinct fiz_id ) as fiz_count, sum(fiz_power) as fiz_power, \
  count(distinct fiz_id_h ) as fiz_count_h, sum(fiz_power_h) as fiz_power_h, \
  sum(prom_power) as prom_power,   sum(prom_power_1kl) as prom_power_1kl, \
  count(distinct prom_id ) as prom_count, \
  count(distinct CASE WHEN point_voltage in (1,2,11,12,21) THEN prom_id END ) as prom_count_1kl \
from( \
select ssss.*, \
coalesce(ff.id_station,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then code_eqp4 END) as code_ps35, \
coalesce(eqps.name_eqp,case when ssss.id_voltage in (1,2,21) and ssss.type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2,21) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2,21) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2,21) and type_eqp4 = 8 then grpname4 END) as name_ps35, \
case when ssss.type_eqp = 3 then ssss.code_eqp \
     when ssss.type_eqp2 = 3 then ssss.code_eqp2 \
     when ssss.type_eqp3 = 3 then ssss.code_eqp3 \
     when ssss.type_eqp4 = 3 then ssss.code_eqp4 END as code_vvod, \
case when ssss.type_eqp = 3 then ssss.grpname \
     when ssss.type_eqp2 = 3 then ssss.grpname2 \
     when ssss.type_eqp3 = 3 then ssss.grpname3 \
     when ssss.type_eqp4 = 3 then ssss.grpname4 END as name_vvod \
from \
( \
 select sss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
from \
( select ps.code_eqp as code_grp, ba.id_client, ps.name, eqp.id_voltage as point_voltage, \
 CASE when coalesce(ba.flag_priv,0)=1 THEN ba.id_client  END as fiz_id , \
 CASE when coalesce(ba.flag_priv,0)=1 and coalesce(cf.cod_tarif,0) =48 THEN ba.id_client  END as fiz_id_h , \
 CASE when coalesce(ba.flag_priv,0)=1 THEN cf.set_power else 0 END as fiz_power , \
 CASE when coalesce(ba.flag_priv,0)=1 and coalesce(cf.cod_tarif,0) =48 THEN cf.set_power else 0 END as fiz_power_h , \
 CASE when coalesce(ba.flag_priv,0)=0 THEN ba.id_client END as prom_id , \
 CASE when coalesce(ba.flag_priv,0)=0 THEN eqp.power else 0 END as prom_power , \
 CASE when coalesce(ba.flag_priv,0)=0 and eqp.id_voltage in (1,2,11,12,21) THEN eqp.power else 0 END as prom_power_1kl \
 from \
 bal_abons_tbl as ba \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = ba.id_grp ) \
 left join clm_pclient_tbl as cf on (cf.id = ba.id_client) \
 left join eqm_point_tbl as eqp on (eqp.code_eqp = ba.id_point) \
 left join clm_client_tbl as c on (c.id = ba.id_client ) \
 left join clm_statecl_tbl as scl on (c.id = scl.id_client) \
 left join rep_lighting_points_tmp as lp on (lp.id_point = ba.id_point) \
  where  ps.mmgg = :mmgg::::date \
  and ((eqp.reserv=0  and coalesce(eqp.share,0) = 0 and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and scl.id_section not in (205,206,207,208) and (lp.id_point is null) ) or ( coalesce(ba.flag_priv,0)=1 \
    and (coalesce(cf.cod_zone,0)=0  )and coalesce(cf.id_state,0)<>50 )) \
 )as sss \
  left join eqm_equipment_tbl as ee on (ee.id = sss.code_grp) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = sss.code_grp and gr1.mmgg= :mmgg::::date) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= :mmgg::::date) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and ssss.type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
    left join eqm_equipment_tbl as eqps on (eqps.id = ff.id_station) \
) as bigs \
 group by bigs.code_ps35,bigs.name_ps35, bigs.code_vvod , bigs.name_vvod order by bigs.name_ps35,bigs.name_vvod   ;";


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::Check2KRBillsArea (TDateTime mmgg, boolean Build)
{

  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);
  AnsiString sqlstr;
  AnsiString  sqlstr1;


  if (Build)
  {
  AnsiString sqlstr="select area_limit_fun( :mmgg );";

  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  if ((year1==2013)&&(month1<5)) // период когда считали по каждой площадке отдельно
  {
   sqlstr1="select  c.code, c.short_name, s.name_area, s.adr_area, s.bill_kvt as demand_val, \
   s.date_limit as reg_date, l.mmgg ,s.value_limit, s.d_kvt \
   from seb_area_limit_tmp as s \
   join clm_client_tbl as c on (c.id = s.id_client) \
   left join acd_demandlimit_tbl as l on (l.id = s.id_limit) \
   where s.mmgg = :mmgg and coalesce(s.bill_kvt,0)> coalesce(s.value_limit,0) \
   and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99); ";
  }
  else
  {
   sqlstr1="select  c.code, c.short_name, '' as name_area, '' as adr_area, s.bill_kvt as demand_val, \
   s.date_limit as reg_date, null as mmgg ,s.value_limit, b.d_kvt \
   from (select id_client, sum(bill_kvt) as bill_kvt, sum(value_limit) as value_limit, max(date_limit) as date_limit \
     from seb_area_limit_tmp as s \
     left join eqm_ground_tbl as g on (g.code_eqp = s.id_area) \
     where mmgg = :mmgg and (s.id_area is null or g.code_eqp is not null) group by id_client ) as s \
   left join ( select id_client, sum(demand_val) as d_kvt from  acm_bill_tbl \
     where id_pref in (520,524) and mmgg= :mmgg group by id_client) as b on (b.id_client = s.id_client) \
   join clm_client_tbl as c on (c.id = s.id_client) \
   where  coalesce(s.bill_kvt,0)> coalesce(s.value_limit,0) \
   and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99); ";

  }


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::CheckLimitPowerArea (TDateTime mmgg)
{

  AnsiString  sqlstr1="select d.value_dem, d.month_limit, h.reg_date, h.dt, g.power, g.wtm, round(g.power*g.wtm*coalesce(scl.period_indicat,1),0) as lim  , \
        c.code, c.short_name, eq.name_eqp as name_area , scl.period_indicat \
        from acd_demandlimit_tbl as d \
        join acm_headdemandlimit_tbl as h on (h.id_doc =d.id_doc) \
        join (     select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
                   from acm_headdemandlimit_tbl as h2 join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
                   where h2.idk_document = 600 and date_part('year',d2.month_limit)= date_part('year', :mmgg::::date ) \
                   group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
                  ) as hh on (hh.id_client = h.id_client and hh.maxdate = h.reg_date and hh.maxmmgg = h.mmgg \
                     and hh.month_limit = d.month_limit and hh.id_area = d.id_area) \
        join eqm_ground_tbl as g on (g.code_eqp = d.id_area) \
        join clm_client_tbl as c on (c.id = h.id_client) \
        join clm_statecl_tbl as scl on (scl.id_client = c.id) \
        join eqm_equipment_tbl as eq on (eq.id = d.id_area) \
        where date_part('year',d.month_limit ) =date_part('year', :mmgg::::date ) \
        and d.month_limit >= :mmgg::::date \
        and d.value_dem > round(g.power*g.wtm*coalesce(scl.period_indicat,1),0) \
        and scl.id_section  not in (210,211,212,213,214,215,203) \
        and d.id_area is not null \
        and h.idk_document = 600 \
        order by c.code,eq.name_eqp,d.month_limit; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::HomenetLines (void)
{

  AnsiString  sqlstr1=" select eq.name_eqp as homenet, eq2.id as id_line, eq2.name_eqp as line, \
    l.length, l.id_voltage,cb.type, cb.ro, v.voltage_min, ab.num_gek \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_inst_tbl as ins on (eq.id = ins.code_eqp_inst) \
    join eqm_equipment_tbl as eq2 on (eq2.id = ins.code_eqp ) \
    join eqm_line_c_tbl as l on (l.code_eqp = eq2.id) \
    join eqi_cable_tbl as cb on (cb.id = l.id_type_eqp ) \
    join eqk_voltage_tbl as v on (v.id = l.id_voltage) \
   left join adi_build_tbl as ab on (ab.id = eq.id) \
    where eq.type_eqp=17 \
   order by ab.num_gek,homenet, line; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonCompensList(void)
{

  if(MessageDlg("Переформировать данные о подключении абонентов?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
    
   }

  AnsiString  sqlstr1="  select eq.id,eq.name_eqp as name_tp,eqi.type, eq.loss_power,eqi.power_nom , adr.adr::::varchar as tp_adr, \
  area.name_eqp as name_area, area.id_adr as id_adr_area, area.adr::::varchar as adr_area, \
  tp.name_eqp as name_ps, tp.id_adr as id_ps_adr, tp.adr::::varchar as ps_adr, c.code, c.short_name, \
  coalesce(adr.adr,area.adr,tp.adr)::::varchar as adr , ttt.id_grp, ff.name_eqp as name_grp \
from eqm_compensator_tbl as cm \
join eqm_equipment_tbl as eq on (eq.id = cm.code_eqp) \
join eqm_eqp_tree_tbl as tt on ( eq.id = tt.code_eqp) \
join eqm_tree_tbl as t on (t.id = tt.id_tree) \
join clm_client_tbl as c on (c.id = t.id_client) \
join eqi_compensator_tbl as eqi on (eqi.id = cm.id_type_eqp) \
left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
left join ( \
 select ins.code_eqp, ins.code_eqp_inst, eq.name_eqp, adr.id as id_adr, adr.adr \
 from eqm_compens_station_inst_tbl as ins \
 join eqm_equipment_tbl as eq on (eq.id = ins.code_eqp_inst ) \
 left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
 where eq.type_eqp=11 \
) as area on (area.code_eqp = eq.id) \
left join ( \
 select ins.code_eqp, ins.code_eqp_inst, eq.name_eqp, adr.id as id_adr, adr.adr \
 from eqm_compens_station_inst_tbl as ins \
 join eqm_equipment_tbl as eq on (eq.id = ins.code_eqp_inst ) \
 left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
 where eq.type_eqp=8 \
) as tp on (tp.code_eqp = eq.id) \
left join \
( select distinct tt.id_tree, coalesce(fs.id_fider,ba.id_grp) as id_grp \
 from bal_abons_tbl as ba \
 join eqm_eqp_tree_tbl as tt on ( ba.id_point = tt.code_eqp) \
 left join bal_grp_tree_tbl as fs on (fs.code_eqp = ba.id_grp and fs.type_eqp = 8 and fs.mmgg = (select max(mmgg) from bal_grp_tree_tbl) ) \
) as ttt on (ttt.id_tree = t.id) \
left join eqm_equipment_tbl as ff on (ff.id = ttt.id_grp) \
where c.id <> syi_resid_fun() \
and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (3,50,99) \
order by c.code, name_tp; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::AbonAreaSummary()
{
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();



  AnsiString  sqlstr1="  select c.id as link, c.code,c.name,doc_dat,doc_num, \
  sc.phone, licens_num,okpo_num,tax_num,  a.adr , ps.connect_power, ps.safe_cat, ps.power \
  from clm_client_tbl as c \
  join clm_statecl_tbl as sc on (c.id = sc.id_client) \
  left join adv_address_tbl as a on (a.id = c.id_addres) \
  left join \
  ( \
    select a.id_client, sum(p.connect_power) as connect_power, sum(p.power) as power,\
    trim(sum( distinct p.safe_category::::varchar||','),',') as safe_cat \
    from eqm_point_tbl as p \
    join eqm_compens_station_inst_tbl as ins on (p.code_eqp = ins.code_eqp) \
    join eqm_area_tbl as a on (a.code_eqp = ins.code_eqp_inst) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = p.code_eqp) \
    where coalesce(p.reserv,0)=0 and coalesce(p.share,0)=0 and lp.id_point is null \
    group by a.id_client  \
  ) as ps on (ps.id_client = c.id) \
  where c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) and coalesce(sc.id_section,0) not in (0,205,206,207,208) \
  order by c.code;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr1);

  AnsiString  sqlstr2=" select a.id_client as link, eq.name_eqp as area_name, adr.adr as area_adr, \
  ss.power, ss.connect_power, ss.safe_cat \
  from (select ins.code_eqp_inst, sum(p.connect_power) as connect_power, sum(p.power) as power, \
    trim(sum( distinct p.safe_category::::varchar||','),',') as safe_cat \
    from eqm_point_tbl as p \
    join eqm_compens_station_inst_tbl as ins on (p.code_eqp = ins.code_eqp) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = p.code_eqp) \
    where coalesce(p.reserv,0)=0 and coalesce(p.share,0)=0 and lp.id_point is null \
  group by ins.code_eqp_inst) as ss \
  join eqm_ground_tbl as gr on (ss.code_eqp_inst = gr.code_eqp) \
  join eqm_area_tbl as a on (a.code_eqp = gr.code_eqp) \
  join clm_client_tbl as  c on (c.id = a.id_client) \
  join eqm_equipment_tbl as eq on (eq.id = a.code_eqp) \
  left join adv_address_tbl as adr on (adr.id = eq.id_addres) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  order by a.id_client,eq.name_eqp;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr2);

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";
}
//---------------------------------------------------------------------------
void TfReports::PS10_Rezerv(TDateTime mmgg)
{
  if(MessageDlg("Переформировать данные о подключении абонентов?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
  }



    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();


  AnsiString  sqlstr1=" select sss.*, pwr.ps_power, pwr.tr_cnt, pwr.max_power, pwr.p_regday, \
  CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END as pwr1, \
  Round(CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END /  \
  CASE \
     WHEN full_cnt<=10 THEN 0.9 \
     WHEN full_cnt >10 and full_cnt<=50 THEN 0.67 \
     WHEN full_cnt >50 and full_cnt<=100 THEN 0.53 \
     WHEN full_cnt >100 and full_cnt<=250 THEN 0.43 \
     WHEN full_cnt >250 and full_cnt<=500 THEN 0.36  \
     WHEN full_cnt >500 and full_cnt<=750 THEN 0.29   \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 0.24   \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 0.2   \
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 0.16 \
     WHEN full_cnt >100000 and full_cnt<=1000000 THEN 0.12\
     WHEN full_cnt >1000000 THEN 0.09  END  - full_power) as pwr2 \
 from \
( \
 select trim_name as name , \
 coalesce(fiz_cnt,0)+ coalesce(prom_cnt,0) as full_cnt, \
 coalesce(fiz_power,0) as fiz_power , coalesce(fiz_cnt,0) as fiz_cnt, \
 coalesce(prom_cnt,0) as prom_cnt,  coalesce(power,0) as prom_power, \
 coalesce(fiz_power,0)+ coalesce(power,0) as full_power, \
 coalesce(power_c1,0) as power_c1,  coalesce(power_c2,0) as power_c2, \
 coalesce(cnt_c1,0) as cnt_c1,  coalesce(cnt_c2,0) as cnt_c2 \
 from ( \
 select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name , \
 count(distinct p.id_client) as prom_cnt, sum(p.power) as power, sum(p.connect_power) as connect_power, \
 sum(CASE WHEN coalesce(p.safe_category,3) =1 THEN p.power ELSE 0 END) as power_c1, \
 sum(CASE WHEN coalesce(p.safe_category,3) =2 THEN p.power ELSE 0 END) as power_c2, \
 sum(CASE WHEN coalesce(p.safe_category,3) =3 THEN p.power ELSE 0 END) as power_c3, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =1 THEN p.id_client END) as cnt_c1, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =2 THEN p.id_client END) as cnt_c2, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =3 THEN p.id_client END) as cnt_c3 \
 from \
 eqm_equipment_tbl as ps \
 join eqm_compens_station_tbl as cs on (cs.code_eqp = ps.id) \
 join eqm_area_tbl as a on (a.code_eqp = cs.code_eqp) \
 join clm_client_tbl as c on (c.id = a.id_client ) \
 left join \
 (select ba.id_point as code_eqp,ba.id_grp,ba.id_client,eqp.power,eqp.connect_power, eqp.safe_category \
  from bal_abons_tbl as ba \
  join eqm_point_tbl as eqp on (eqp.code_eqp = ba.id_point  ) \
  join clm_client_tbl as c on (c.id = ba.id_client ) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = ba.id_point) \
  where coalesce(eqp.reserv,0)=0 and coalesce(eqp.share,0)=0 and lp.id_point is null \
  and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
  ) as p  on (ps.id = p.id_grp ) \
 where  ps.type_eqp=8 and cs.id_voltage in (3,31,32)  \
 and exists (select csi.code_eqp from eqm_compens_station_inst_tbl as csi where csi.code_eqp_inst = ps.id) \
 and ((c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)) or (a.id_client = a.id_department)) \
 group by trim_name order by trim_name \
) as ssp \
full outer join \
( \
 select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name,  \
  count(distinct c.id ) as fiz_cnt, sum( c.set_power ) as fiz_power \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join eqm_equipment_tbl as ps on (ps.id = ba.id_grp ) \
 join eqm_compens_station_tbl as cs on (cs.code_eqp = ps.id) \
 where coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 \
 and   ps.type_eqp=8 and cs.id_voltage in (3,31,32)  \
 group by trim_name order by trim_name \
) as ssf using (trim_name) \
) as sss \
left join \
( select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т1|Т2|Т-1|Т-2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name, \
    sum(cs.power) as ps_power,  sum (cs.comp_cnt)::::int as tr_cnt, \
    max(GREATEST(c1.power_nom,c2.power_nom,c3.power_nom,c4.power_nom)) as  max_power, \
    max(cs.p_regday) as p_regday \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = eq.id) \
    left join eqi_compensator_tbl as c1 on (c1.id = cs.id_type1) \
    left join eqi_compensator_tbl as c2 on (c2.id = cs.id_type2) \
    left join eqi_compensator_tbl as c3 on (c3.id = cs.id_type3) \
    left join eqi_compensator_tbl as c4 on (c4.id = cs.id_type4) \
    where eq.type_eqp=8 and cs.id_voltage in (3,31,32) \
    and exists (select csi.code_eqp from eqm_compens_station_inst_tbl as csi where csi.code_eqp_inst = eq.id) \
    group by trim_name order by trim_name \
) as pwr on (pwr.trim_name = sss.name) \
order by name  ;";


/*
( select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name, \
    sum(eqi.power_nom::::numeric) as ps_power, \
    count (distinct c.code_eqp) as tr_cnt, max(eqi.power_nom::::numeric) as max_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    where eq.type_eqp=8 \
    group by trim_name order by trim_name \
) as pwr on (pwr.trim_name = sss.name) \
*/

/*
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name,  \
  count(distinct c.id ) as fiz_cnt, sum( c.set_power ) as fiz_power \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join acm_privdem_tbl as pd on (c.id = pd.id_client) \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = ba.id_grp ) \
 where coalesce(c.cod_zone,0)=0 and coalesce(c.id_state,0)<>50 \
 and   ps.type_eqp=8 and ps.id_voltage = 3 and ps.mmgg = :mmgg::::date \
 and   pd.mmgg = :mmgg::::date \
 group by trim_name order by trim_name \

*/

/*

  AnsiString  sqlstr1=" select sss.*, pwr.ps_power, pwr.tr_cnt, pwr.max_power, pwr.p_regday, \
  CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END as pwr1, \
  Round(CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END /  \
  CASE \
     WHEN full_cnt >1 and full_cnt<=10 THEN 0.9 \
     WHEN full_cnt >10 and full_cnt<=50 THEN 0.67 \
     WHEN full_cnt >50 and full_cnt<=100 THEN 0.53 \
     WHEN full_cnt >100 and full_cnt<=250 THEN 0.43 \
     WHEN full_cnt >250 and full_cnt<=500 THEN 0.36 \
     WHEN full_cnt >500 and full_cnt<=750 THEN 0.29 \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 0.24 \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 0.2 \
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 0.16 \
     WHEN full_cnt >100000 and full_cnt<=1000000 THEN 0.12 \
     WHEN full_cnt >1000000 THEN 0.09  END  - full_power) as pwr2 \
 from \
( \
 select trim_name as name , \
 coalesce(fiz_cnt,0)+ coalesce(prom_cnt,0) as full_cnt, \
 coalesce(fiz_power,0) as fiz_power , coalesce(fiz_cnt,0) as fiz_cnt, \
 coalesce(prom_cnt,0) as prom_cnt,  coalesce(power,0) as prom_power, \
 coalesce(fiz_power,0)+ coalesce(power,0) as full_power, \
 coalesce(power_c1,0) as power_c1,  coalesce(power_c2,0) as power_c2, \
 coalesce(cnt_c1,0) as cnt_c1,  coalesce(cnt_c2,0) as cnt_c2 \
 from ( \
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name , \
 count(distinct p.id_client) as prom_cnt, sum(p.power) as power, sum(p.connect_power) as connect_power, \
 sum(CASE WHEN coalesce(p.safe_category,3) =1 THEN p.power ELSE 0 END) as power_c1, \
 sum(CASE WHEN coalesce(p.safe_category,3) =2 THEN p.power ELSE 0 END) as power_c2, \
 sum(CASE WHEN coalesce(p.safe_category,3) =3 THEN p.power ELSE 0 END) as power_c3, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =1 THEN p.id_client END) as cnt_c1, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =2 THEN p.id_client END) as cnt_c2, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =3 THEN p.id_client END) as cnt_c3 \
 from \
 bal_grp_tree_tbl as ps \
 left join \
 (select p.code_eqp,p.id_p_eqp,p.id_client,eqp.power,eqp.connect_power, eqp.safe_category \
  from bal_grp_tree_tbl as p \
  join eqm_point_tbl as eqp on (eqp.code_eqp = p.code_eqp  ) \
  join clm_client_tbl as c on (c.id = p.id_client ) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = p.code_eqp) \
  where p.type_eqp=12 and p.mmgg = :mmgg::::date and p.id_client > 0 \
  and coalesce(eqp.reserv,0)=0 and coalesce(eqp.share,0)=0 and lp.id_point is null \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  ) as p  on (ps.code_eqp = p.id_p_eqp ) \
 where  ps.type_eqp=8 and ps.id_voltage = 3 and ps.mmgg = :mmgg::::date \
 group by trim_name order by trim_name \
) as ssp \
full outer join \
( \
 select trim(regexp_replace(trim(ps.name),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name,  \
  count(distinct c.id ) as fiz_cnt, sum( c.set_power ) as fiz_power \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join bal_grp_tree_tbl as ps on (ps.code_eqp = ba.id_grp ) \
 where coalesce(c.cod_zone,0)=0 and coalesce(c.id_state,0)<>50 \
 and   ps.type_eqp=8 and ps.id_voltage = 3 and ps.mmgg = :mmgg::::date \
 group by trim_name order by trim_name \
) as ssf using (trim_name) \
) as sss \
left join \
( select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т1|Т2|Т-1|Т-2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name, \
    sum(cs.power) as ps_power,  sum (cs.comp_cnt)::::int as tr_cnt, \
    max(GREATEST(c1.power_nom,c2.power_nom,c3.power_nom,c4.power_nom)) as  max_power, \
    max(cs.p_regday) as p_regday \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = eq.id) \
    left join eqi_compensator_tbl as c1 on (c1.id = cs.id_type1) \
    left join eqi_compensator_tbl as c2 on (c2.id = cs.id_type2) \
    left join eqi_compensator_tbl as c3 on (c3.id = cs.id_type3) \
    left join eqi_compensator_tbl as c4 on (c4.id = cs.id_type4) \
    where eq.type_eqp=8 and cs.id_voltage = 3 \
    group by trim_name order by trim_name \
) as pwr on (pwr.trim_name = sss.name) \
order by name  ;";

*/

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
//  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::PS35_Rezerv(void)
{

  AnsiString sqlstr;
  if(MessageDlg("Переформировать данные о подключении абонентов?", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);

    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
  }


   sqlstr="select * from rep_abons_connect_find();";
   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);

   try
    {
     ZQReps->ExecSql();
    }
   catch(...)
    {
     ShowMessage("Ошибка SQL :"+sqlstr);
     return;
    }


    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();


  AnsiString  sqlstr1=" select sss.*, pwr.ps_power, pwr.tr_cnt, pwr.max_power, pwr.p_regday, \
  CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END as pwr1, \
  Round(CASE WHEN pwr.tr_cnt = 1 THEN round(pwr.ps_power*0.92) \
  ELSE round((pwr.ps_power-pwr.max_power)*0.92*1.4) END /  \
  CASE \
     WHEN full_cnt<=10 THEN 1 \
     WHEN full_cnt >10 and full_cnt<=50 THEN 0.81 \
     WHEN full_cnt >50 and full_cnt<=100 THEN 0.69 \
     WHEN full_cnt >100 and full_cnt<=250 THEN 0.61 \
     WHEN full_cnt >250 and full_cnt<=500 THEN 0.55  \
     WHEN full_cnt >500 and full_cnt<=750 THEN 0.5   \
     WHEN full_cnt >750 and full_cnt<=1000 THEN 0.46   \
     WHEN full_cnt >1000 and full_cnt<=10000 THEN 0.42   \
     WHEN full_cnt >10000 and full_cnt<=100000 THEN 0.38 \
     WHEN full_cnt >100000 and full_cnt<=1000000 THEN 0.36\
     WHEN full_cnt >1000000 THEN 0.33  END  - full_power) as pwr2 \
 from \
( \
 select trim_name as name , \
 coalesce(fiz_cnt,0)+ coalesce(prom_cnt,0) as full_cnt, \
 coalesce(fiz_power,0) as fiz_power , coalesce(fiz_cnt,0) as fiz_cnt, \
 coalesce(prom_cnt,0) as prom_cnt,  coalesce(power,0) as prom_power, \
 coalesce(fiz_power,0)+ coalesce(power,0) as full_power, \
 coalesce(power_c1,0) as power_c1,  coalesce(power_c2,0) as power_c2, \
 coalesce(cnt_c1,0) as cnt_c1,  coalesce(cnt_c2,0) as cnt_c2 \
 from ( \
 select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name , \
 count(distinct p.id_client) as prom_cnt, sum(p.power) as power, sum(p.connect_power) as connect_power, \
 sum(CASE WHEN coalesce(p.safe_category,3) =1 THEN p.power ELSE 0 END) as power_c1, \
 sum(CASE WHEN coalesce(p.safe_category,3) =2 THEN p.power ELSE 0 END) as power_c2, \
 sum(CASE WHEN coalesce(p.safe_category,3) =3 THEN p.power ELSE 0 END) as power_c3, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =1 THEN p.id_client END) as cnt_c1, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =2 THEN p.id_client END) as cnt_c2, \
 count(distinct CASE WHEN coalesce(p.safe_category,3) =3 THEN p.id_client END) as cnt_c3 \
 from \
 eqm_equipment_tbl as ps \
 join \
 (select ba.id_point as code_eqp,ba.id_client,ba.id_ps35,eqp.power,eqp.connect_power, eqp.safe_category \
  from  rep_abons_connect_tmp as ba \
  join eqm_point_tbl as eqp on (eqp.code_eqp = ba.id_point  ) \
  join clm_client_tbl as c on (c.id = ba.id_client ) \
  left join rep_lighting_points_tmp as lp on (lp.id_point = ba.id_point) \
  where coalesce(eqp.reserv,0)=0 and coalesce(eqp.share,0)=0 and lp.id_point is null \
  and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  ) as p  on (ps.id = p.id_ps35 ) \
 group by trim_name order by trim_name \
) as ssp \
full outer join \
( \
 select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2|Т1|Т2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name,  \
  count(distinct c.id ) as fiz_cnt, sum( c.set_power ) as fiz_power \
 from \
 rep_abons_connect_tmp as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join eqm_equipment_tbl as ps on (ps.id = ba.id_ps35 ) \
 where coalesce(c.cod_zone,0) in (0) and coalesce(c.id_state,0)<>50 \
 group by trim_name order by trim_name \
) as ssf using (trim_name) \
) as sss \
left join \
( select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т1|Т2|Т-1|Т-2|\\\\(1\\\\)|\\\\(2\\\\))',''))::::varchar as trim_name, \
    sum(cs.power) as ps_power,  sum (cs.comp_cnt)::::int as tr_cnt, \
    max(GREATEST(c1.power_nom,c2.power_nom,c3.power_nom,c4.power_nom)) as  max_power, \
    max(cs.p_regday) as p_regday \
    from eqm_equipment_tbl as eq \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = eq.id) \
    left join eqi_compensator_tbl as c1 on (c1.id = cs.id_type1) \
    left join eqi_compensator_tbl as c2 on (c2.id = cs.id_type2) \
    left join eqi_compensator_tbl as c3 on (c3.id = cs.id_type3) \
    left join eqi_compensator_tbl as c4 on (c4.id = cs.id_type4) \
    where eq.type_eqp=8 and cs.id_voltage in (1,2,11,12,21) \
    group by trim_name order by trim_name \
) as pwr on (pwr.trim_name = sss.name) \
order by name  ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
//  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->Report();

 ZQXLReps->Close();

}
//------------------------------------------------------------------------------
void TfReports::Saldo_AllEnergy(TDateTime mmgg, boolean Build)
{
 // таблица с секциями по дебету и кредиту по АЕ, РЕ и 2кр
  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);
  AnsiString sqlstr;

  if (Build)
  {

   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select obr.cod_r, obr.osob_r as code,obr.osob_rsk as abon_name, c.code_okpo, st.doc_num, \
     nar, nar_v,opl_zv, -deb_zpmv as deb_b, kr_zpmv as kt_b, \
     -deb_kmv as deb_e,kr_zkmv as kt_e \
     from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client)  \
     join clm_statecl_tbl as st on (st.id_client = c.id) \
     where obr.period = :mmgg and obr.id_pref = :pref \
     and obr.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
     and coalesce(deb_zpmv,0)<>0 \
     order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLReps->ParamByName("pref")->AsInteger=10;

  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr1);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLReps2->ParamByName("pref")->AsInteger=20;

  ZQXLReps3->Sql->Clear();
  ZQXLReps3->Sql->Add(sqlstr1);
  ZQXLReps3->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLReps3->ParamByName("pref")->AsInteger=520;

  AnsiString  sqlstr2=" select obr.cod_r, obr.osob_r as code,obr.osob_rsk as abon_name, c.code_okpo, st.doc_num, \
     nar, nar_v,opl_zv, -deb_zpmv as deb_b, kr_zpmv as kt_b, \
     -deb_kmv as deb_e,kr_zkmv as kt_e \
     from seb_obr_all_tmp as obr join clm_client_tbl as c on (c.id = obr.id_client)  \
     join clm_statecl_tbl as st on (st.id_client = c.id) \
     where obr.period = :mmgg and ( obr.id_pref = :pref  or  obr.id_pref = :pref2 )  \
     and obr.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
     and coalesce(kr_zpmv,0)<>0 \
     order by obr.osob_r;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  ZQXLRepsSum->ParamByName("pref2")->AsInteger=10;

  ZQXLRepsSum2->Sql->Clear();
  ZQXLRepsSum2->Sql->Add(sqlstr2);
  ZQXLRepsSum2->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLRepsSum2->ParamByName("pref")->AsInteger=20;
  ZQXLRepsSum2->ParamByName("pref2")->AsInteger=20;

  ZQXLRepsSum3->Sql->Clear();
  ZQXLRepsSum3->Sql->Add(sqlstr2);
  ZQXLRepsSum3->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);
  ZQXLRepsSum3->ParamByName("pref")->AsInteger=520;
  ZQXLRepsSum3->ParamByName("pref2")->AsInteger=524;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
    ZQXLReps3->Open();

    ZQXLRepsSum->Open();
    ZQXLRepsSum2->Open();
    ZQXLRepsSum3->Open();

  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range_ae";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Alias = "ZQXLReps2";
  Dsr->Range = "Range_re";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps3;
  Dsr->Alias = "ZQXLReps3";
  Dsr->Range = "Range_2k";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias = "ZQXLRepsSum";
  Dsr->Range = "Range_aek";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum2;
  Dsr->Alias = "ZQXLRepsSum2";
  Dsr->Range = "Range_rek";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum3;
  Dsr->Alias = "ZQXLRepsSum3";
  Dsr->Range = "Range_2kk";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

//  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = "по "+ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date);

  xlReport->Report();

  ZQXLReps->Close();
  ZQXLReps2->Close();
  ZQXLReps3->Close();

  ZQXLRepsSum->Close();
  ZQXLRepsSum2->Close();
  ZQXLRepsSum3->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintMetersAvgDemand( TDateTime dtb,TDateTime dte)
{

  AnsiString  sqlstr1="select c.id, c.short_name, c.code,m.code_eqp, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control,pim.name as phasename,tim.name as ind_el, im.zones, im.amperage_nom,\
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    sc.phone,cp.represent_name,pr.cl, adr.adr, sti.tt_type, sti.koef_i, stu.tu_type,stu.koef_u, sti.date_check as date_check_i, stu.date_check as date_check_u, \
    sti.num_eqp as num_sti, stu.num_eqp as num_stu, eqpps.name_eqp as  name_ps, \
    CASE WHEN coalesce(eq.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner, pp.code_eqp as id_point, pp.power,  pp.disabled, \
    CASE WHEN m.magnet = 1 THEN 'Установлен' ELSE '' END as magnet_str , cla.name as section, \
    CASE WHEN sti.is_owner is null THEN '' WHEN coalesce(sti.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_sti, \
    CASE WHEN stu.is_owner is null THEN '' WHEN coalesce(stu.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_stu, \
    kv.voltage_min as voltage, bs6.demand6 \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqk_phase_tbl as pim on (im.phase=pim.id) \
    join eqk_meter_tbl as tim on (im.kind_meter=tim.id) \
    left join eqi_meter_prec_tbl pr on (pr.id_type_eqp=im.id )  \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_h as sc on (c.id = sc.id_client) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_point_tbl as pp on (pp.code_eqp = mp.id_point ) \
    left join bal_abons_tbl as ba on (ba.id_point = pp.code_eqp ) \
    left join eqm_equipment_tbl as eqpps on (ba.id_grp = eqpps.id) \
    left join eqm_equipment_tbl as eqpp on (mp.id_point = eqpp.id) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join eqk_voltage_tbl as kv on (kv.id = pp.id_un) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, ic.amperage_nom, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
   left join \
  ( select b.id_client, bs.id_point, sum(bs.demand_val)/count(distinct bs.mmgg)::::numeric as demand6  \
    from acd_billsum_tbl as bs \
    join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
    where b.id_pref=10 \
    and b.mmgg >= :mmgg1::::date and b.mmgg <= :mmgg2::::date \
    group by b.id_client, bs.id_point order by b.id_client, bs.id_point \
  ) as bs6 on (bs6.id_point = pp.code_eqp)\
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as sc2 where sc2.id_client = sc.id_client and sc2.mmgg_b <= date_trunc('month', :mmgg1::::date ) ) \
    order by c.code, eq.num_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("mmgg1")->AsDateTime=dtb;
   ZQXLReps->ParamByName("mmgg2")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="lperiod";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";

  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------
void TfReports::AvansAnializ (TDateTime pmmgg,boolean Build)
{
   int obr_exists=0;
    AnsiString message;
    AnsiString sqlstr;
    TDateTime mmgg = pmmgg;

   if (Build)
   {
     sqlstr="select count(*) as cnt from seb_obr_all_tbl where period = date_trunc('month', :mmgg::::date)- '1 month'::::interval;";
     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->Open();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
     obr_exists = ZQReps->FieldByName("cnt")->AsInteger;
     ZQReps->Close();

     if ((mmgg > cur_mmgg)||(obr_exists==0))
     {
      if (mmgg > cur_mmgg) message ="Предыдущий месяц не закрыт! Переформировать оборотку ?";
      else message ="Нет данных за предыдущий месяц! Переформировать оборотку ?";

      int r = MessageDlg(message, mtConfirmation, TMsgDlgButtons() << mbYes << mbNo<<mbCancel, 0);

      if ( r==mrCancel ) return;
      if ( r==mrYes )
      {
        sqlstr=" select seb_all( 3, (date_trunc('month', :mmgg::::date))::::date );";

        ZQReps->Close();
        ZQReps->Sql->Clear();
        ZQReps->Sql->Add(sqlstr);
        ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

        try
        {
         ZQReps->ExecSql();
        }
        catch(...)
        {
         ShowMessage("Ошибка SQL :"+sqlstr);
         return;
        }

      }
     }
   }

    ZQReps->Close();
    //-------------------
     sqlstr=" delete from rep_last_bill_tmp ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

     sqlstr=" insert into rep_last_bill_tmp \
              select id_client, max(mmgg) \
              from acm_bill_tbl \
              where mmgg <= :mmgg::::date - '1 month'::::interval  and mmgg >=:mmgg::::date - '3 month'::::interval \
              and demand_val > 0 and id_pref=10 and idk_doc = 200 \
              group by id_client order by id_client ;";

     ZQReps->Sql->Clear();
     ZQReps->Sql->Add(sqlstr);
     ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;
     try
     {
      ZQReps->ExecSql();
     }
     catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

  AnsiString  sqlstr1=" select id_section as link, bigsel.*, round(value_dem*tarif_value*pre_pay_perc*1.2,2) as sum_avans, date_part('day',pre_pay_date ) as pre_pay_day \
   from ( \
   select distinct cl.id, ss_a.* , stcl.phone, stcl.dt_indicat, stcl.pre_pay_day0, stcl.id_section, \
     slimit.value_dem, \
     CASE WHEN avgtarsss.f_zone<>0 or avgtarsss.f_othertarif <> 0 or ((avgtarsss.f_main =0) and (avgtarsss.f_fiz <> 0 ) )THEN avgtarsss.avg_tar ELSE tarsss.tarif_value END as tarif_value,  \
     stcl.phone, coalesce(pos_phones,'') as addphones, \
     cl.code, cl.short_name,cl.name as abonname, cp.represent_name,adr.adr,  \
     stcl.addr_local, stcl.pre_pay_date1, stcl.pre_pay_date2, stcl.pre_pay_date3, \
     stcl.pre_pay_day1, stcl.pre_pay_day2, stcl.pre_pay_day3, stcl.doc_num, stcl.doc_dat, \
     stcl.pre_pay_perc3, stcl.pre_pay_perc2, stcl.pre_pay_perc1, \
          stcl.pre_pay_date1 as pre_pay_date , \
          coalesce(stcl.pre_pay_perc1,0)::::numeric/100 as pre_pay_perc ,  \
     CASE WHEN  coalesce(ssw.action,0) =1 THEN 'Отключен' WHEN coalesce(ssw.action,0) =2 THEN 'Предупрежден' WHEN coalesce(ssw.action,0) =5 THEN 'Предупрежден (аванс)' ELSE '' END as status ,\
     coalesce(ssw.action,0) as status_code, ssw.dt_action, ssw.dt_warning \
     from \
      (select cl.* from clm_client_tbl as cl order by cl.id) as cl  \
      join \
      ( select st.id_client, st.dt_indicat, st.phone,st.day_pay_bill, st.addr_local, st.id_position, st.pre_pay_perc3, st.pre_pay_perc2, st.pre_pay_perc1, -st.pre_pay_day1 as pre_pay_day0, \
        st.pre_pay_day1, st.pre_pay_day2, st.pre_pay_day3, st.doc_num, st.doc_dat, st.id_section,\
        CASE WHEN (coalesce(st.pre_pay_day3,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day3,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date3, \
        CASE WHEN (coalesce(st.pre_pay_day2,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day2,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date2, \
        CASE WHEN (coalesce(st.pre_pay_day1,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day1,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date1 \
        from  clm_statecl_h as st \
        where st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = st.id_client and stcl2.mmgg_b <= :mmgg::::date ) \
        order by st.id_client \
      ) as stcl on (cl.id = stcl.id_client) \
    left join \
    ( select s.id_client , \
     coalesce(s.deb_b,0) as db, coalesce(s.kr_zpmv,0) as kb, \
     coalesce(s.kr_zkmv,0)  as ke,    s.deb_k as de, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all,  pay.reg_date as pay_date \
      from \
     (select obr.id_client, clm.order_pay, \
     -deb_zpmv as deb_b, kr_zpmv, -deb_kmv as deb_k, kr_zkmv    \
     from seb_obr_all_tbl as obr \
     join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = :mmgg::::date and obr.id_pref = 10  order by obr.id_client )as s \
     left join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = :mmgg::::date  \
      and b.id_pref = 10 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     left join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where  ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref = 10 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_a  on (cl.id = ss_a.id_client) \
   left join ( \
   select hl.id_client, sum(d1.value_dem) as value_dem \
     from acd_demandlimit_tbl as d1 \
     join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and d2.month_limit= :mmgg \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
     where hl.idk_document = 600  and d1.month_limit= :mmgg \
     group by hl.id_client \
     order by hl.id_client \
   ) as slimit on (slimit.id_client =cl.id ) \
   left join \
   ( select id_client, CASE when dem1>dem2 then  tcl1_id else tcl2_id end as tcl_id, t.id , tt.value as tarif_value \
     from \
     (select b.id_client, \
      sum(CASE when tcl1.ident='tcl1' then bs1.demand_val else 0 end ) as dem1, \
      sum(CASE when tcl1.ident='tcl2' then bs1.demand_val else 0 end ) as dem2, \
      max(CASE when tcl1.ident='tcl1' then tcl1.id else 0 end) as tcl1_id, \
      max(CASE when tcl1.ident='tcl2' then tcl1.id else 0 end) as tcl2_id \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t2 on (t2.id_client = b.id_client and t2.mmgg = b.mmgg ) \
      join aci_tarif_tbl as tar1 on (tar1.id=bs1.id_tariff) \
      join eqi_classtarif_tbl as tcl1 on (tar1.id_classtarif=tcl1.id) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
     ) as tss \
    join aci_tarif_tbl as t on (t.id_grouptarif = 12 and t.id_classtarif = CASE when dem1>dem2 then  tcl1_id else tcl2_id end ) \
    join acd_tarif_tbl as tt on (tt.id_tarif = t.id) \
    join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date group by id_tarif  )as ttd on (tt.id_tarif = ttd.id_tarif and tt.dt_begin = ttd.dtb) \
    order by id_client \
   ) as tarsss on (tarsss.id_client = cl.id) \
   left join \
   ( select b.id_client, CASE WHEN sum(bs1.demand_val) >0 THEN round(sum(bs1.sum_val)/sum(bs1.demand_val),5) ELSE 0 END as avg_tar, \
      sum(CASE WHEN coalesce(bs1.id_zone ,0)<>0 THEN 1 ELSE 0 END ) as f_zone, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) not in (12,14,15,16,21,22,29,30,44,45,28,35,37,48) THEN 1 ELSE 0 END ) as f_othertarif, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (12,14,15,16,21,22,29,30) THEN 1 ELSE 0 END ) as f_main, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (28,35,37,48) THEN 1 ELSE 0 END ) as f_fiz \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t1 on (t1.id_client = b.id_client and t1.mmgg = b.mmgg ) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
   ) as avgtarsss on (avgtarsss.id_client = cl.id) \
     left join \
      ( select csw.id_client,  csw.dt_action,  csw.action , csw.dt_warning \
       from clm_switching_tbl as csw \
       join (select id_client, max(dt_action) as maxdt from clm_switching_tbl where action <> 2 group by id_client order by id_client) as csdt \
       on (csw.id_client = csdt.id_client and csw.dt_action = csdt.maxdt) \
       left join clm_switching_tbl as cswc on (csw.id_client = cswc.id_client and csw.dt_action = cswc.dt_action and cswc.action in (3,4)) \
       where csw.action <> 3 and csw.action <> 4 and csw.action <> 2 and cswc.id_client is null \
       order by id_client \
      ) as ssw on (cl.id = ssw.id_client) \
     left join clm_position_tbl as cp on (stcl.id_position = cp.id) \
     left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client order by id_client) as phones on (cl.id = phones.id_client) \
     left join adv_address_tbl as adr on (adr.id = cl.id_addres) \
     left join adi_town_tbl as town on (town.id = adr.id_town) \
     where cl.idk_work not in (0,99) \
    ) as bigsel \
    where pre_pay_perc1<> 0 and pre_pay_day1 <0 order by code ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;


  AnsiString  sqlstr2=" select grp_kod, grp_name, grp_sort, id_section as link, \
  sum(db) as db, sum(kb) as kb, sum(pay_all) as pay_all, sum(de) as de, sum(ke) as ke, \
  sum(round(value_dem*tarif_value*pre_pay_perc*1.2,2) ) as sum_avans, \
  sum(GREATEST(round(value_dem*tarif_value*pre_pay_perc*1.2 -CASE WHEN ( pay_all + kb - db ) >0 THEN ( pay_all + kb - db ) ELSE 0 END ,2),0)) as davans \
   from ( \
   select distinct cl.id, ss_a.* , cla.kod as grp_kod, cla.name as grp_name,cla.sort as grp_sort, \
     slimit.value_dem, \
     CASE WHEN avgtarsss.f_zone<>0 or avgtarsss.f_othertarif <> 0 or ((avgtarsss.f_main =0) and (avgtarsss.f_fiz <> 0 ) )THEN avgtarsss.avg_tar ELSE tarsss.tarif_value END as tarif_value,  \
     stcl.addr_local, stcl.pre_pay_date1, stcl.pre_pay_date2, stcl.pre_pay_date3, \
     stcl.pre_pay_day1, stcl.pre_pay_day2, stcl.pre_pay_day3, stcl.doc_num, stcl.doc_dat, stcl.id_section, \
     stcl.pre_pay_perc3, stcl.pre_pay_perc2, stcl.pre_pay_perc1, \
          stcl.pre_pay_date1 as pre_pay_date , \
          coalesce(stcl.pre_pay_perc1,0)::::numeric/100 as pre_pay_perc   \
     from \
      (select cl.* from clm_client_tbl as cl order by cl.id) as cl  \
      join \
      ( select st.id_client, st.dt_indicat, st.phone,st.day_pay_bill, st.addr_local, st.id_position, st.pre_pay_perc3, st.pre_pay_perc2, st.pre_pay_perc1, -st.pre_pay_day1 as pre_pay_day0, \
        st.pre_pay_day1, st.pre_pay_day2, st.pre_pay_day3, st.doc_num, st.doc_dat, st.id_section, \
        CASE WHEN (coalesce(st.pre_pay_day3,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day3,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date3, \
        CASE WHEN (coalesce(st.pre_pay_day2,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day2,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date2, \
        CASE WHEN (coalesce(st.pre_pay_day1,0)<>0 ) THEN calend_bank_day( :mmgg::::date, st.pre_pay_day1,st.flag_bank_day,st.dt_start) ELSE null END as pre_pay_date1 \
        from  clm_statecl_h as st \
        where st.mmgg_b = (select max(mmgg_b) from clm_statecl_h as stcl2 where stcl2.id_client = st.id_client and stcl2.mmgg_b <= :mmgg::::date ) \
        order by st.id_client \
      ) as stcl on (cl.id = stcl.id_client) \
    left join cla_param_tbl as cla on (stcl.id_section = cla.id) \
    left join \
    ( select s.id_client , \
     coalesce(s.deb_b,0) as db, coalesce(s.kr_zpmv,0) as kb, \
     coalesce(s.kr_zkmv,0)  as ke,    s.deb_k as de, \
     coalesce(bill.sumbill,0) AS sumbill, bill.reg_date as bill_date, bill.transmis_date,\
     coalesce(pay.pay_all,0) AS pay_all,  pay.reg_date as pay_date \
      from \
     (select obr.id_client, clm.order_pay, \
     -deb_zpmv as deb_b, kr_zpmv, -deb_kmv as deb_k, kr_zkmv    \
     from seb_obr_all_tbl as obr \
     join clm_client_tbl as clm on (clm.id = obr.id_client) \
     where obr.period = :mmgg::::date and obr.id_pref = 10  order by obr.id_client )as s \
     left join \
     ( select b.id_client, sum(b.value+b.value_tax) as sumbill, \
       max(b.date_transmis) as transmis_date, max(b.reg_date) as reg_date  \
     from acm_bill_tbl as b \
      left join clm_client_tbl as c on (c.id= b.id_client) \
      where b.mmgg = :mmgg::::date  \
      and b.id_pref = 10 and c.book = -1 and c.idk_work not in (0,99) and b.idk_doc <> 201 group by b.id_client order by b.id_client ) as bill using (id_client) \
     left join \
     (select p.id_client, max(p.reg_date) as reg_date,  sum(p.value_pay) as pay_all  \
      from acm_pay_tbl as p left join clm_client_tbl as c on (c.id= p.id_client) \
       where  ( :mmgg::::date = date_trunc('month', p.reg_date))  \
       and p.id_pref = 10 and c.book = -1 and p.sign_pay = 1 group by p.id_client order by p.id_client ) as pay using (id_client) \
       order by id_client \
   )as ss_a  on (cl.id = ss_a.id_client) \
   left join ( \
   select hl.id_client, sum(d1.value_dem) as value_dem \
     from acd_demandlimit_tbl as d1 \
     join acm_headdemandlimit_tbl as hl on (hl.id_doc = d1.id_doc) \
           join ( \
           select h2.id_client,d2.month_limit, d2.id_area, max(h2.reg_date) as maxdate , max(h2.mmgg) as maxmmgg \
           from acm_headdemandlimit_tbl as h2 \
           join acd_demandlimit_tbl as d2  on  (h2.id_doc = d2.id_doc) \
           left join eqm_ground_tbl as g on (g.code_eqp = d2.id_area)\
           where h2.idk_document = 600 and d2.month_limit= :mmgg \
           and (d2.id_area is null or g.code_eqp is not null) \
           group by h2.id_client , d2.id_area, d2.month_limit order by h2.id_client \
          ) as hh on (hh.id_client = hl.id_client and hh.maxdate = hl.reg_date and hh.maxmmgg = hl.mmgg  \
             and hh.month_limit = d1.month_limit and hh.id_area = d1.id_area) \
     where hl.idk_document = 600  and d1.month_limit= :mmgg \
     group by hl.id_client \
     order by hl.id_client \
   ) as slimit on (slimit.id_client =cl.id ) \
   left join \
   ( select id_client, CASE when dem1>dem2 then  tcl1_id else tcl2_id end as tcl_id, t.id , tt.value as tarif_value \
     from \
     (select b.id_client, \
      sum(CASE when tcl1.ident='tcl1' then bs1.demand_val else 0 end ) as dem1, \
      sum(CASE when tcl1.ident='tcl2' then bs1.demand_val else 0 end ) as dem2, \
      max(CASE when tcl1.ident='tcl1' then tcl1.id else 0 end) as tcl1_id, \
      max(CASE when tcl1.ident='tcl2' then tcl1.id else 0 end) as tcl2_id \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t2 on (t2.id_client = b.id_client and t2.mmgg = b.mmgg ) \
      join aci_tarif_tbl as tar1 on (tar1.id=bs1.id_tariff) \
      join eqi_classtarif_tbl as tcl1 on (tar1.id_classtarif=tcl1.id) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
     ) as tss \
    join aci_tarif_tbl as t on (t.id_grouptarif = 12 and t.id_classtarif = CASE when dem1>dem2 then  tcl1_id else tcl2_id end ) \
    join acd_tarif_tbl as tt on (tt.id_tarif = t.id) \
    join (select id_tarif, max(dt_begin) as dtb from acd_tarif_tbl where dt_begin <= :mmgg::::date group by id_tarif  )as ttd on (tt.id_tarif = ttd.id_tarif and tt.dt_begin = ttd.dtb) \
    order by id_client \
   ) as tarsss on (tarsss.id_client = cl.id) \
   left join \
   ( select b.id_client, CASE WHEN sum(bs1.demand_val) >0 THEN round(sum(bs1.sum_val)/sum(bs1.demand_val),5) ELSE 0 END as avg_tar, \
      sum(CASE WHEN coalesce(bs1.id_zone ,0)<>0 THEN 1 ELSE 0 END ) as f_zone, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) not in (12,14,15,16,21,22,29,30,44,45,28,35,37,48) THEN 1 ELSE 0 END ) as f_othertarif, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (12,14,15,16,21,22,29,30) THEN 1 ELSE 0 END ) as f_main, \
      sum(CASE WHEN coalesce(bs1.id_tariff ,0) in (28,35,37,48) THEN 1 ELSE 0 END ) as f_fiz \
      from acm_bill_tbl as b \
      join acd_billsum_tbl as bs1 on (bs1.id_doc = b.id_doc) \
      join rep_last_bill_tmp as t1 on (t1.id_client = b.id_client and t1.mmgg = b.mmgg ) \
      where b.id_pref=10 and bs1.demand_val<>0 and b.idk_doc = 200 \
      group by b.id_client order by b.id_client \
   ) as avgtarsss on (avgtarsss.id_client = cl.id) \
     where cl.idk_work not in (0,99) and pre_pay_perc1<> 0 and pre_pay_day1 <0 \
    ) as bigsel \
    group by grp_kod, grp_name, grp_sort , id_section \
 order by grp_sort ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);

  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLReps->Open();
    ZQXLRepsSum->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();

   Param=xlReport->Params->Add();
   Param->Name="lres";
   Param=xlReport->Params->Add();
   Param->Name="lperiod";
   Param=xlReport->Params->Add();
   Param->Name="lnow";

   xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
   xlReport->ParamByName["lres"]->Value = ResName;
   xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
        FormatDateTime("dd.mm.yyyy",dtEnd->Date);

 xlReport->Report();
 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::WorkListNone (TDateTime dtb,TDateTime dte,int client)
{
  AnsiString  sqlstr1=" select ssss.*, cp2.represent_name as fider_inspector, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then code_eqp4 END as code_ps35, \
case when ssss.id_voltage in (1,2) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (1,2) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (1,2) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (1,2) and type_eqp4 = 8 then grpname4 END as name_ps35, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END as code_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then grpname4 END as name_f10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then code_eqp4 END as code_ps10, \
case when ssss.id_voltage in (3,31,32) and type_eqp = 8 then grpname \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 8 then grpname2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 8 then grpname3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 8 then grpname4 END as name_ps10 \
from \
( \
  select mainss.*, ee.name_eqp as grpname , \
  gr1.type_eqp, gr1.code_eqp, gr1.id_voltage , \
  gr2.type_eqp as type_eqp2, gr2.code_eqp as code_eqp2, gr2.id_voltage as id_voltage2, \
  gr3.type_eqp as type_eqp3, gr3.code_eqp as code_eqp3, gr3.id_voltage as id_voltage3, \
  gr4.type_eqp as type_eqp4, gr4.code_eqp as code_eqp4, gr4.id_voltage as id_voltage4, \
  ee2.name_eqp as grpname2,ee3.name_eqp as grpname3,ee4.name_eqp as grpname4 \
  from \
( \
  select distinct c.code,c.short_name, adc.adr as abon_adr, ba.id_point, eq.name_eqp, ba.num_meter,  \
  adv.adr, im.type as type_meter, ba.id_grp as link \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_meter_tbl as m on (m.code_eqp=ba.id_meter ) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
  left join adv_address_tbl as adc on (adc.id = c.id_addres) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) and coalesce(p.reserv,0)=0 \
  and (c.id = :client or :client is null ) \
  and not exists ( \
    select w.id \
    from clm_works_tbl as w \
    where w.dt_work <= :dt_e and w.dt_work >=:dt_b and w.id_client = c.id ) \
) as mainss \
  left join eqm_equipment_tbl as ee on (ee.id = mainss.link) \
  left join bal_grp_tree_tbl as gr1 on (gr1.code_eqp = mainss.link and gr1.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join bal_grp_tree_tbl as gr2 on (gr1.id_p_eqp = gr2.code_eqp and gr2.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee2 on (ee2.id = gr2.code_eqp) \
  left join bal_grp_tree_tbl as gr3 on (gr2.id_p_eqp = gr3.code_eqp and gr3.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee3 on (ee3.id = gr3.code_eqp) \
  left join bal_grp_tree_tbl as gr4 on (gr3.id_p_eqp = gr4.code_eqp and gr4.mmgg= (select max(mmgg) from bal_grp_tree_tbl)) \
  left join eqm_equipment_tbl as ee4 on (ee4.id = gr4.code_eqp) \
  ) as ssss \
  left join eqm_fider_tbl as ff on (ff.code_eqp = case when ssss.id_voltage in (3,31,32) and type_eqp = 15 then ssss.code_eqp \
     when ssss.id_voltage2 in (3,31,32) and type_eqp2 = 15 then code_eqp2 \
     when ssss.id_voltage3 in (3,31,32) and type_eqp3 = 15 then code_eqp3 \
     when ssss.id_voltage4 in (3,31,32) and type_eqp4 = 15 then code_eqp4 END) \
  left join clm_position_tbl as cp2 on (cp2.id = ff.id_position) \
  order by code, name_eqp ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt_b")->AsDateTime=dtb;
  ZQXLReps->ParamByName("dt_e")->AsDateTime=dte;

  if (client != 0)
    ZQXLReps->ParamByName("client")->AsInteger=client;
  else
    ZQXLReps->ParamByName("client")->Clear();


  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="labon";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->ParamByName["labon"]->Value = edAbonName->Text;

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------
void TfReports::PrintTTControlList(TDateTime dt, int show_all)
{

  AnsiString  sqlstr1="select c.id, c.short_name, c.code,m.code_eqp, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control,pim.name as phasename,tim.name as ind_el, im.zones, im.amperage_nom,\
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol,  \
    sc.phone,cp.represent_name,pr.cl, adr.adr, sti.tt_type, sti.koef_i, stu.tu_type,stu.koef_u, sti.date_check as date_check_i, stu.date_check as date_check_u, \
    sti.num_eqp as num_sti, stu.num_eqp as num_stu, eqpps.name_eqp as  name_ps, \
    CASE WHEN coalesce(eq.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner, pp.code_eqp as id_point, pp.power,  pp.disabled, \
    CASE WHEN m.magnet = 1 THEN 'Установлен' ELSE '' END as magnet_str , cla.name as section, \
    CASE WHEN sti.is_owner is null THEN '' WHEN coalesce(sti.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_sti, \
    CASE WHEN stu.is_owner is null THEN '' WHEN coalesce(stu.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_stu, \
    kv.voltage_min as voltage, \
    (sti.date_check+'4 year'::::interval)::::date as next_check_i, sti.dt_install as dt_install_i, \
    (stu.date_check+'4 year'::::interval)::::date as next_check_u, stu.dt_install as dt_install_u \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqk_phase_tbl as pim on (im.phase=pim.id) \
    join eqk_meter_tbl as tim on (im.kind_meter=tim.id) \
    left join eqi_meter_prec_tbl pr on (pr.id_type_eqp=im.id )  \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join eqm_meter_point_h as mp on (mp.id_meter = eq.id and mp.dt_e is null) \
    left join eqm_point_tbl as pp on (pp.code_eqp = mp.id_point ) \
    left join bal_abons_tbl as ba on (ba.id_point = pp.code_eqp ) \
    left join eqm_equipment_tbl as eqpps on (ba.id_grp = eqpps.id) \
    left join eqm_equipment_tbl as eqpp on (mp.id_point = eqpp.id) \
    left join clm_position_tbl as cp on (coalesce(pp.id_position,sc.id_position)=cp.id) \
    left join adv_address_tbl as adr  on (adr.id = coalesce(eqpp.id_addres,c.id_addres)) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join eqk_voltage_tbl as kv on (kv.id = pp.id_un) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, ic.amperage_nom, eq.dt_install, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, eq.dt_install, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
    where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
    and ((sti.tt_type is not null ) or (stu.tu_type is not null)) \
    and ( \
     (sti.date_check is not null and (sti.date_check+'4 year'::::interval)::::date <=:dt) \
    or \
     (stu.date_check is not null and (stu.date_check+'4 year'::::interval)::::date <= :dt) \
    or ( :show_all = 1)) \
    order by c.code, eq.num_eqp;";

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr1);
   ZQXLReps->ParamByName("dt")->AsDateTime=dt;
   ZQXLReps->ParamByName("show_all")->AsInteger=show_all;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="ldate";
//  Param=xlReport->Params->Add();
//  Param->Name="lenergy";

  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="demcaption";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["ldate"]->Value = "На "+FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::Meters2_5List( TDateTime dt)
{

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();

  AnsiString sqlstr1 =" select distinct c.id, c.short_name, c.name,c.code,  \
    sc.phone,cp.represent_name , adr_c.adr as adr_abon, phones.pos_phones, town.name as city , \
    cla.name as groupname, v.voltage_min,(c.code||'_'||text(voltage_min))::::varchar as  link ,\
    CASE WHEN v.voltage_min = 0.4 THEN (:dt::::date + '1 month'::::interval)::::date \
         ELSE (:dt::::date + '3 month'::::interval)::::date END as last_date \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_equipment_tbl as eq2 on (mp.id_point = eq2.id) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqk_voltage_tbl as v on (v.id = pp.id_un) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqi_meter_prec_tbl as imp on (imp.id_type_eqp = im.id ) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = mp.id_point) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join clm_position_tbl as cp on (sc.id_position=cp.id) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (c.id = phones.id_client) \
    left join adv_address_tbl as adr_c on (adr_c.id = c.id_addres) \
    left join adi_town_tbl as town on (town.id = adr_c.id_town) \
    where trim(imp.cl) ='2.5'  \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)  \
    and lp.id_point is null and coalesce(pp.disabled,0) =0   \
    order by code,voltage_min; ";


   ZQXLRepsSum->Sql->Clear();
   ZQXLRepsSum->Sql->Add(sqlstr1);
   ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;

  AnsiString sqlstr2 ="select c.id, c.short_name, c.code, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control, \
    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, hm.dt_b as dt_ch, \
    adr.adr,  CASE WHEN im.phase =1 then 1 WHEN im.phase =2 then 3 END as phase , \
    v.voltage_min,(c.code||'_'||text(voltage_min))::::varchar as link  \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_equipment_tbl as eq2 on (mp.id_point = eq2.id) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqk_voltage_tbl as v on (v.id = pp.id_un) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqi_meter_prec_tbl as imp on (imp.id_type_eqp = im.id ) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = mp.id_point) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join adv_address_tbl as adr on (adr.id = eq2.id_addres) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and trim(imp.cl) ='2.5'  \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)  \
    and lp.id_point is null and coalesce(pp.disabled,0) =0  \
    order by c.code, voltage_min, num_eqp ";


   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr2);
//   ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="llast_date";
//  Param=xlReport->Params->Add();
//  Param->Name="loff_date";

  Param=xlReport->Params->Add();
  Param->Name="lresname";
  Param=xlReport->Params->Add();
  Param->Name="lresshortname";
  Param=xlReport->Params->Add();
  Param->Name="lresaddr";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";

  xlReport->ParamByName["lresname"]->Value = ResName;
  xlReport->ParamByName["lresaddr"]->Value = ResAddr+" тел. "+ResPhone;
  xlReport->ParamByName["lresshortname"]->Value = ResName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  AnsiString BossName2 =BossName;
  int space_pos =AnsiPos(" ",BossName);
  if(space_pos!=0)
  {
    BossName2 = BossName.SubString(space_pos+1,10)+" "+ BossName.SubString(1,space_pos);
  }
  xlReport->ParamByName["bossname"]->Value = BossName2;

  //отдельные случаи для МЕМ и Нежина
  switch ( res_code ) {
  case 310 :
    xlReport->ParamByName["lresname"]->Value = "ЧЕРНІГІВСЬКІ   МІСЬКІ   ЕЛЕКТРИЧНІ   МЕРЕЖІ";
    xlReport->ParamByName["lresaddr"]->Value = "14038, м. Чернігів, Деснянський район,  проспект Перемоги, 126, тел 654-426, факс 654-496";
    xlReport->ParamByName["lresshortname"]->Value = " Чернігівські МЕМ ";
    xlReport->ParamByName["bospos"]->Value = "Директор ЧнМЕМ";
   break;
  case 210 :
    xlReport->ParamByName["lresname"]->Value = "НІЖИНСЬКИЙ РАЙОН ЕЛЕКТРИЧНИХ МЕРЕЖ";
    xlReport->ParamByName["lresshortname"]->Value = " ВП Ніжинський РЕМ ";
//    xlReport->ParamByName["bospos"]->Value = "Директор Ніжинського РЕМ";
    xlReport->ParamByName["bossname"]->Value = BossName;
   break;
  case 240 :
    xlReport->ParamByName["lresname"]->Value = "ПРИЛУЦЬКИЙ РАЙОН ЕЛЕКТРИЧНИХ МЕРЕЖ";
    xlReport->ParamByName["lresshortname"]->Value = " ВП Прилуцький РЕМ ";
//    xlReport->ParamByName["bospos"]->Value = "Директор Ніжинського РЕМ";
//    xlReport->ParamByName["bossname"]->Value = BossName;
   break;

  };

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  xlReport->ParamByName["llast_date"]->Value = FormatDateTime("dd.mm.yyyy",last_date);
//  xlReport->ParamByName["loff_date"]->Value = FormatDateTime("dd.mm.yyyy",off_date);

  xlReport->ParamByName["ldt"]->Value = FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Open();
}
//---------------------------------------------------------------------------
void TfReports::MetersAndTTControlWarning( TDateTime dt)
{

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add("select rep_lighting_dubl_fun();");

    try
    {
     ZQReps->ExecSql();
    }
    catch(EDatabaseError &e)
    {
     ShowMessage("Ошибка : "+e.Message.SubString(8,200));
     return;
    }
    ZQReps->Close();

  AnsiString sqlstr1 =" select distinct c.id, c.short_name, c.name,c.code,  \
    sc.phone,cp.represent_name , adr_c.adr as adr_abon, phones.pos_phones, town.name as city , \
    cla.name as groupname, v.voltage_min,(c.code||'_'||text(voltage_min))::::varchar as  link ,\
    CASE WHEN v.voltage_min = 0.4 THEN (:dt::::date + '1 month'::::interval)::::date \
         ELSE (:dt::::date + '3 month'::::interval)::::date END as last_date \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_equipment_tbl as eq2 on (mp.id_point = eq2.id) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqk_voltage_tbl as v on (v.id = pp.id_un) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqi_meter_prec_tbl as imp on (imp.id_type_eqp = im.id ) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = mp.id_point) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join clm_position_tbl as cp on (sc.id_position=cp.id) \
    left join cla_param_tbl as cla on (sc.id_section = cla.id) \
    left join (select id_client, sum(','||phone) as pos_phones from clm_position_tbl where coalesce(phone,'')<>'' group by id_client ) as phones on (c.id = phones.id_client) \
    left join adv_address_tbl as adr_c on (adr_c.id = c.id_addres) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join adi_town_tbl as town on (town.id = adr_c.id_town) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, ic.amperage_nom, eq.dt_install, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, eq.dt_install, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and ( \
     coalesce(dt_control,hm.dt_b) is not null and (coalesce(dt_control,hm.dt_b) + (text(im.term_control)||' year')::::interval) <= :dt \
     or \
     ((sti.tt_type is not null ) or (stu.tu_type is not null)) \
     and \
     ( \
       (sti.date_check is not null and sti.num_eqp is not null and (sti.date_check+'4 year'::::interval)::::date <=:dt) \
         or \
       (stu.date_check is not null and stu.num_eqp is not null and (stu.date_check+'4 year'::::interval)::::date <= :dt) \
     ) \
    ) \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)  \
    and lp.id_point is null and coalesce(pp.disabled,0) =0   \
    order by code,voltage_min; ";


   ZQXLRepsSum->Sql->Clear();
   ZQXLRepsSum->Sql->Add(sqlstr1);
   ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;

  AnsiString sqlstr2 ="select c.id, c.short_name, c.code, m.id_type_eqp, eq.name_eqp, eq.num_eqp, im.type,im.term_control,im.carry,m.dt_control, \
    coalesce(dt_control,hm.dt_b) + (text(im.term_control)||' year')::::interval  as newcontrol, hm.dt_b as dt_ch, \
    adr.adr,  CASE WHEN im.phase =1 then 1 WHEN im.phase =2 then 3 END as phase , \
    sti.tt_type, sti.koef_i, stu.tu_type,stu.koef_u, sti.date_check as date_check_i, stu.date_check as date_check_u, \
    sti.num_eqp as num_sti, stu.num_eqp as num_stu, \
    CASE WHEN sti.is_owner is null THEN '' WHEN coalesce(sti.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_sti, \
    CASE WHEN stu.is_owner is null THEN '' WHEN coalesce(stu.is_owner,0) = 0 THEN 'РЕС' ELSE 'Абонент' END as owner_stu, \
    (sti.date_check+'4 year'::::interval)::::date as next_check_i, sti.dt_install as dt_install_i, \
    (stu.date_check+'4 year'::::interval)::::date as next_check_u, stu.dt_install as dt_install_u, \
    v.voltage_min,(c.code||'_'||text(voltage_min))::::varchar as link  \
    from eqm_tree_tbl as tr \
    join eqm_eqp_tree_tbl as ttr on (tr.id = ttr.id_tree) \
    join eqm_equipment_tbl as eq on (ttr.code_eqp = eq.id) \
    join eqm_meter_tbl as m on (m.code_eqp = eq.id) \
    join eqm_meter_point_h as mp on (mp.id_meter = eq.id and dt_e is null) \
    join eqm_equipment_tbl as eq2 on (mp.id_point = eq2.id) \
    join eqm_point_tbl as pp on (mp.id_point = pp.code_eqp) \
    join eqk_voltage_tbl as v on (v.id = pp.id_un) \
    join eqi_meter_tbl as im on (im.id = m.id_type_eqp) \
    join eqi_meter_prec_tbl as imp on (imp.id_type_eqp = im.id ) \
    left join rep_lighting_points_tmp as lp on (lp.id_point = mp.id_point) \
    left join eqm_eqp_use_tbl as use on (use.code_eqp = eq.id) \
    left join clm_client_tbl as c on (c.id = coalesce (use.id_client, tr.id_client)) \
    left join clm_statecl_tbl as sc on (c.id = sc.id_client) \
    left join eqm_equipment_h as hm on (hm.id = eq.id) \
    left join adv_address_tbl as adr on (adr.id = eq2.id_addres) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, ic.amperage_nom, eq.dt_install, \
    ic.conversion , ic.type as tt_type,ic.accuracy, CASE WHEN coalesce(ic.amperage2_nom,0)=0 THEN 0 ELSE ic.amperage_nom/ic.amperage2_nom END as koef_i, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 1 order by id_meter \
   ) as sti on (sti.id_meter = eq.id) \
    left join \
    ( select  CASE WHEN eq2.type_eqp = 1 THEN eq2.id WHEN eq3.type_eqp = 1 THEN eq3.id END as id_meter, c.date_check, eq.dt_install, \
    ic.conversion , ic.type as tu_type,ic.accuracy, CASE WHEN coalesce(ic.voltage2_nom,0)=0 THEN 0 ELSE ic.voltage_nom/ic.voltage2_nom END as koef_u, eq.num_eqp, eq.is_owner \
    from \
     eqm_compensator_i_tbl as c \
     join eqm_equipment_tbl as eq on (eq.id =c.code_eqp ) \
     join eqi_compensator_i_tbl as ic on (ic.id = c.id_type_eqp) \
     left join eqm_eqp_tree_tbl as tt on (tt.code_eqp_e=c.code_eqp )   \
     left join eqm_eqp_tree_tbl as tt2 on (tt2.code_eqp_e=tt.code_eqp ) \
     left join eqm_equipment_tbl as eq2 on (eq2.id =tt.code_eqp ) \
     left join eqm_equipment_tbl as eq3 on (eq3.id =tt2.code_eqp ) \
     where ic.conversion = 2 order by id_meter \
   ) as stu on (stu.id_meter = eq.id) \
    where hm.dt_b = (select dt_b from eqm_equipment_h where id = eq.id and num_eqp = eq.num_eqp order by dt_b ASC limit 1 ) \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99)  \
    and ( \
     coalesce(dt_control,hm.dt_b) is not null and (coalesce(dt_control,hm.dt_b) + (text(im.term_control)||' year')::::interval) <= :dt \
     or \
     ((sti.tt_type is not null ) or (stu.tu_type is not null)) \
     and \
     ( \
       (sti.date_check is not null and sti.num_eqp is not null and (sti.date_check+'4 year'::::interval)::::date <=:dt) \
         or \
       (stu.date_check is not null and stu.num_eqp is not null and (stu.date_check+'4 year'::::interval)::::date <= :dt) \
     ) \
    ) \
    and lp.id_point is null and coalesce(pp.disabled,0) =0  \
    order by c.code, voltage_min, num_eqp ";

    //    CASE WHEN dt_control is not null THEN dt_control + (text(im.term_control)||' year')::::interval ELSE NULL END as newcontrol, \

   ZQXLReps->Sql->Clear();
   ZQXLReps->Sql->Add(sqlstr2);
   ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";

  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
//  Param=xlReport->Params->Add();
//  Param->Name="llast_date";
//  Param=xlReport->Params->Add();
//  Param->Name="loff_date";

  Param=xlReport->Params->Add();
  Param->Name="lresname";
  Param=xlReport->Params->Add();
  Param->Name="lresshortname";
  Param=xlReport->Params->Add();
  Param->Name="lresaddr";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";

  xlReport->ParamByName["lresname"]->Value = ResName;
  xlReport->ParamByName["lresaddr"]->Value = ResAddr+" тел. "+ResPhone;
  xlReport->ParamByName["lresshortname"]->Value = ResName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  AnsiString BossName2 =BossName;
  int space_pos =AnsiPos(" ",BossName);
  if(space_pos!=0)
  {
    BossName2 = BossName.SubString(space_pos+1,10)+" "+ BossName.SubString(1,space_pos);
  }
  xlReport->ParamByName["bossname"]->Value = BossName2;

  //отдельные случаи для МЕМ и Нежина
  switch ( res_code ) {
  case 310 :
    xlReport->ParamByName["lresname"]->Value = "ЧЕРНІГІВСЬКІ   МІСЬКІ   ЕЛЕКТРИЧНІ   МЕРЕЖІ";
    xlReport->ParamByName["lresaddr"]->Value = "14038, м. Чернігів, Деснянський район,  проспект Перемоги, 126, тел 654-426, факс 654-496";
    xlReport->ParamByName["lresshortname"]->Value = " Чернігівські МЕМ ";
    xlReport->ParamByName["bospos"]->Value = "Директор ЧнМЕМ";
   break;
  case 210 :
    xlReport->ParamByName["lresname"]->Value = "НІЖИНСЬКИЙ РАЙОН ЕЛЕКТРИЧНИХ МЕРЕЖ";
    xlReport->ParamByName["lresshortname"]->Value = " ВП Ніжинський РЕМ ";
//    xlReport->ParamByName["bospos"]->Value = "Директор Ніжинського РЕМ";
    xlReport->ParamByName["bossname"]->Value = BossName;
   break;
  case 240 :
    xlReport->ParamByName["lresname"]->Value = "ПРИЛУЦЬКИЙ РАЙОН ЕЛЕКТРИЧНИХ МЕРЕЖ";
    xlReport->ParamByName["lresshortname"]->Value = " ВП Прилуцький РЕМ ";
//    xlReport->ParamByName["bospos"]->Value = "Директор Ніжинського РЕМ";
//    xlReport->ParamByName["bossname"]->Value = BossName;
   break;

  };

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

//  xlReport->ParamByName["llast_date"]->Value = FormatDateTime("dd.mm.yyyy",last_date);
//  xlReport->ParamByName["loff_date"]->Value = FormatDateTime("dd.mm.yyyy",off_date);

  xlReport->ParamByName["ldt"]->Value = FormatDateTime("dd.mm.yyyy",dt);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Open();
}
//---------------------------------------------------------------------------
void TfReports::PS10_AbonDemand (TDateTime dtb,TDateTime dte)
{

  if(MessageDlg("Переформировать данные о подключении абонентов? ", mtConfirmation, TMsgDlgButtons() << mbYes << mbNo, 0) == mrYes)
  {
    AnsiString sqlstr="select  bal_abon_find_fun() ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }
  }

  AnsiString  sqlstr1="select *, case when abon_ps =0 then 'РЕМ' else 'Абонентська' end as abon_ps_txt from \
(select trim(regexp_replace(trim(eq.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name, cs.abon_ps, \
     adr.adr, sum(eqi.power_nom::::numeric) as ps_power \
    from eqm_area_tbl as a \
    join eqm_compens_station_inst_tbl as ins on (a.code_eqp = ins.code_eqp_inst) \
    join eqm_compens_station_tbl as cs on (cs.code_eqp = a.code_eqp) \
    join eqm_compensator_tbl as c on (c.code_eqp = ins.code_eqp) \
    join eqm_equipment_tbl as eq on (eq.id = a.code_eqp ) \
    join eqi_compensator_tbl as eqi on (eqi.id = c.id_type_eqp) \
    left join adv_address_tbl as adr on (eq.id_addres = adr.id) \
    where eq.type_eqp=8 and cs.id_voltage in (3,31,32) \
    group by trim_name, abon_ps, adr order by trim_name \
) as tp \
left join \
( select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name, \
  sum( pd.value ) as fiz_demand, count(distinct c.id) as cnt_fizabon \
 from \
 bal_abons_tbl as ba \
 join clm_pclient_tbl as c on (c.id = ba.id_client) \
 join acm_privdem_tbl as pd on (c.id = pd.id_client) \
 join eqm_equipment_tbl as ps on (ps.id = ba.id_grp ) \
 join eqm_compens_station_tbl as cs on (cs.code_eqp = ps.id) \
 where  ps.type_eqp=8 and pd.value <>0 \
 and   pd.mmgg >= :mmgg1::::date and pd.mmgg <= :mmgg2::::date \
 group by trim_name order by trim_name \
) as sfiz using (trim_name) \
left join \
( select trim(regexp_replace(trim(ps.name_eqp),'(\\\\.1|\\\\.2|Т-1|Т-2)',''))::::varchar as trim_name, \
  sum( bs.demand_val ) as abon_demand, count(distinct c.id) as cnt_abon, count(distinct eq.id) as cnt_point \
 from \
 bal_abons_tbl as ba \
 join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
 join clm_client_tbl as c on (c.id = ba.id_client) \
 join acd_billsum_tbl as bs on (bs.id_point = ba.id_point) \
 join acm_bill_tbl as b on (bs.id_doc = b.id_doc) \
 join eqm_equipment_tbl as ps on (ps.id = ba.id_grp ) \
 join eqm_compens_station_tbl as cs on (cs.code_eqp = ps.id) \
 where  ps.type_eqp=8 \
 and   bs.mmgg >= :mmgg1::::date and bs.mmgg <= :mmgg2::::date \
 and ( ( (b.id_pref = 10) and (b.idk_doc<>280)  ) or (b.id_pref=101) ) and c.book = -1 and c.idk_work not in (0,99) \
 group by trim_name order by trim_name \
) as sabn using (trim_name) \
order by trim_name;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=dtb;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=dte;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;
  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date)+" - "+
          FormatDateTime("mmmm yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//---------------------------------------------------------------------------

void TfReports::PrintAbonPointDemandYear_Magnet(TDateTime mmgg)
{

  ZQXLReps->Sql->Clear();
  AnsiString sqlstr1;

  sqlstr1 ="select ssss.*, demand_1,demand_2,demand_3,demand_4,demand_5,demand_6,demand_7,demand_8, demand_9,demand_10,demand_11,demand_12, \
  demand__1,demand__2,demand__3,demand__4,demand__5,demand__6,demand__7,demand__8, demand__9,demand__10,demand__11,demand__12 \
  from (select distinct c.id as id_client, c.code,c.short_name, ba.id_point, eq.name_eqp, ba.num_meter, p.power,p.wtm, \
  adv.adr, cp.represent_name, pt.name as plomb_tname, pp.plomb_dt \
  from bal_abons_tbl as ba \
  join clm_client_tbl as c on (c.id = ba.id_client) \
  join clm_statecl_tbl as stcl on (stcl.id_client=c.id ) \
  join eqm_equipment_tbl as eq on (eq.id = ba.id_point) \
  join eqm_point_tbl as p on (p.code_eqp=ba.id_point ) \
  join ( \
   select p.id_point, max(id_type) as id_type, max(p.dt_b) as plomb_dt \
   from clm_plomb_tbl as p \
   where id_type in (10,11,16) \
   and p.dt_e is null and p.dt_b is not null \
   and date_part('year',p.dt_b)=date_part('year', :mmgg::::date) \
   group by p.id_point  ) as pp on (pp.id_point = ba.id_point) \
  join cli_plomb_type_tbl as pt on (pt.id = pp.id_type) \
  left join adv_address_tbl as adv on (adv.id = eq.id_addres) \
  left join clm_position_tbl as cp on (cp.id = stcl.id_position) \
  where c.book = -1 and coalesce(stcl.id_section,0) not in (0,205,206,207,208) and c.idk_work not in (0) and coalesce(c.id_state,0) not in (50,99) \
  order by ba.id_point \
  ) as ssss \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_1 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 1 group by bs.id_point  order by bs.id_point \
  ) as b1 on (b1.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_2 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 2 group by bs.id_point  order by bs.id_point \
  ) as b2 on (b2.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_3 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 3 group by bs.id_point  order by bs.id_point \
  ) as b3 on (b3.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_4 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 4 group by bs.id_point  order by bs.id_point \
  ) as b4 on (b4.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_5 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 5 group by bs.id_point  order by bs.id_point \
  ) as b5 on (b5.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_6 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 6 group by bs.id_point  order by bs.id_point \
  ) as b6 on (b6.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_7 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 7 group by bs.id_point  order by bs.id_point \
  ) as b7 on (b7.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_8 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 8 group by bs.id_point  order by bs.id_point \
  ) as b8 on (b8.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_9 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 9 group by bs.id_point  order by bs.id_point \
  ) as b9 on (b9.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_10 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 10 group by bs.id_point  order by bs.id_point \
  ) as b10 on (b10.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_11 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 11 group by bs.id_point  order by bs.id_point \
  ) as b11 on (b11.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand_12 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date) and date_part('month',b.mmgg) = 12 group by bs.id_point  order by bs.id_point \
  ) as b12 on (b12.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__1 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 1 group by bs.id_point  order by bs.id_point \
  ) as bb1 on (bb1.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__2 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 2 group by bs.id_point  order by bs.id_point \
  ) as bb2 on (bb2.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__3 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 3 group by bs.id_point  order by bs.id_point \
  ) as bb3 on (bb3.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__4 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 4 group by bs.id_point  order by bs.id_point \
  ) as bb4 on (bb4.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__5 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 5 group by bs.id_point  order by bs.id_point \
  ) as bb5 on (bb5.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__6 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 6 group by bs.id_point  order by bs.id_point \
  ) as bb6 on (bb6.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__7 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 7 group by bs.id_point  order by bs.id_point \
  ) as bb7 on (bb7.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__8 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 8 group by bs.id_point  order by bs.id_point \
  ) as bb8 on (bb8.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__9 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 9 group by bs.id_point  order by bs.id_point \
  ) as bb9 on (bb9.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__10 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 10 group by bs.id_point  order by bs.id_point \
  ) as bb10 on (bb10.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__11 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 11 group by bs.id_point  order by bs.id_point \
  ) as bb11 on (bb11.id_point = ssss.id_point) \
  left join \
  (select bs.id_point, sum(bs.demand_val) as demand__12 \
   from  acm_bill_tbl as b   \
   join acd_billsum_tbl as bs on (b.id_doc = bs.id_doc) \
   where b.id_pref = :pref and date_part('year',b.mmgg) = date_part('year', :mmgg::::date)-1 and date_part('month',b.mmgg) = 12 group by bs.id_point  order by bs.id_point \
  ) as bb12 on (bb12.id_point = ssss.id_point) \
  order by code,name_eqp;" ;

  ZQXLReps->Sql->Add( sqlstr1 );

  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("pref")->AsInteger=10;

  try
  {
  ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка  : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  xlReport->ParamByName["lmmgg"]->Value = "За "+FormatDateTime("yyyy",dtBegin->Date)+" рік";

  xlReport->Report();

 ZQXLReps->Close();


}
//------------------------------------------------------------------------------
void TfReports::Reactiv_2014(TDateTime mmgg1, TDateTime mmgg2)
{
  AnsiString  sqlstr1=" select * from ( \
  select  cl.id, cl.short_name as name, cl.code, bs.id_point, eqh.name_eqp,v.voltage_min::::varchar as voltage, addr.adr,\
  round(sum (CASE WHEN bs.kind_energy=2 and bd.ident = 1 THEN bs.demand_val ELSE 0 END)::::numeric/1000,3) as demand_re_r, \
  round(sum (CASE WHEN bs.kind_energy=4 and bd.ident = 1 THEN bs.demand_val ELSE 0 END)::::numeric/1000,3) as demand_ge_r, \
  round(sum (CASE WHEN bs.kind_energy=2 and bd.ident = 4 THEN bs.demand_val ELSE 0 END)::::numeric/1000,3) as demand_re_a, \
  round(sum (CASE WHEN bs.kind_energy=4 and bd.ident = 4 THEN bs.demand_val ELSE 0 END)::::numeric/1000,3) as demand_ge_a \
  from acm_bill_tbl as b \
  join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
  join clm_client_tbl as cl on (cl.id = b.id_client) \
  join \
  (select distinct id_doc, id_point, ident from acd_pwr_demand_tbl where kind_energy in (2,4) \
   and mmgg >= :mmgg1 and mmgg <= :mmgg2 \
   order by id_doc, id_point ) as bd on (bd.id_doc = b.id_doc and bd.id_point = bs.id_point) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  join eqm_equipment_h as eqh on (eqh.id = bs.id_point) \
  left join adv_address_tbl as addr on (addr.id = eqh.id_addres) \
  left join eqk_voltage_tbl as v on (v.id = ph.id_voltage) \
  where b.id_pref=20 and cl.book = -1 \
  and b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 \
  and ( bs.demand_val <> 0 or bs.sum_val<>0) \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2  where p2.code_eqp = bs.id_point and p2.dt_b <= bs.dt_begin ) \
  and eqh.dt_b = (select max(dt_b) from eqm_equipment_h as eq2  where eq2.id = bs.id_point and eq2.dt_b <= bs.dt_begin ) \
 group by cl.id,cl.code, cl.short_name, bs.id_point,eqh.name_eqp, voltage, addr.adr  ) as re \
  left join \
  (select bs.id_point, b.id_client, \
   round(sum(bs.demand_val)::::numeric/1000,3) as demand_ae \
   from acm_bill_tbl as b \
   join acd_billsum_tbl as bs on (bs.id_doc = b.id_doc) \
   where b.id_pref=10 and b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 \
   group by bs.id_point, b.id_client order by bs.id_point, b.id_client \
  ) as ae on (ae.id_client = re.id and ae.id_point = re.id_point) \
   order by code,voltage, name_eqp ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1)+ " - "+FormatDateTime("mmmm yyyy",mmgg2);

  xlReport->Report();

 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::Print2kr2014(TDateTime mmgg)
{
  AnsiString  sqlstr1=" select c.code, c.short_name,  sum(p.value) as sum_pay \
   from acm_pay_tbl as p \
   join clm_client_tbl as c on (c.id= p.id_client) \
  where p.mmgg = :mmgg::::date  and p.id_pref = 524 and c.book = -1 and sign_pay = 1 \
  group by c.code, c.short_name \
  order by c.code ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";

  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
////////////---------------------------------------------
void TfReports::PrintLimitAreaChange(TDateTime dtb,TDateTime dte)
{

    AnsiString sqlstr="select  rep_limit_area_change_fun( :dtb, :dte ) ;";
    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("dtb")->AsDateTime=dtb;
    ZQReps->ParamByName("dte")->AsDateTime=dte;
    try
     {
      ZQReps->ExecSql();
     }
    catch(...)
     {
      ShowMessage("Ошибка SQL :"+sqlstr);
      return;
     }

 AnsiString  sqlstr1=" select r.*, c.code, c.short_name \
   from rep_limit_area_change_tbl as r \
    join clm_client_tbl as c on (c.id= r.id_client) \
  order by r.reg_date, c.code, r.name_area, r.month_limit ;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
     FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
}
//------------------------------------------------------------------------------

void __fastcall TfReports::cbLNLAllClick(TObject *Sender)
{
    if(cbLNLAll->Checked)
      cbLNLNasNP->Checked = false;
}
//---------------------------------------------------------------------------

void __fastcall TfReports::cbLNLNasNPClick(TObject *Sender)
{
    if(cbLNLNasNP->Checked)
      cbLNLAll->Checked = false;
}
//---------------------------------------------------------------------------
void TfReports::PrintAbonOwnNeeds(TDateTime mmgg1,TDateTime mmgg2,int kind_energy)
{
//  AnsiString sqlstr;

  AnsiString  sqlstr1=" select cl.id as link, cl.code, cl.short_name , bs.id_point,  \
  bs.demand, eq2.name_eqp, bs.num_eqp, adr.adr   \
  from \
  ( select b.id_client,bs.id_point,bs.id_tariff, kz.num_eqp, sum(bs.demand_val) as demand \
   from acm_bill_tbl as b \
   join acd_billsum_tbl as bs on ( b.id_doc = bs.id_doc) \
   left join  ( select distinct id_point,id_doc, max(num_eqp) as num_eqp \
    from acd_met_kndzn_tbl where mmgg >= :mmgg1 and mmgg <= :mmgg2 and kind_energy = :energy group by id_point,id_doc order by id_point,id_doc ) as kz  \
   on (kz.id_point = bs.id_point and kz.id_doc = b.id_doc ) \
   where b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 and b.id_pref = :pref \
   and ((bs.demand_val <> 0) or (bs.sum_val <> 0 )) \
   group by b.id_client,bs.id_point,bs.id_tariff, kz.num_eqp \
  ) as bs \
  join clm_client_tbl as cl on (cl.id = bs.id_client) \
  left join \
  ( select eq3.id,eq3.name_eqp,eq3.id_addres from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) order by eq3.id \
  ) as eq2  on (bs.id_point=eq2.id) \
  left join adv_address_tbl as adr on (adr.id = eq2.id_addres) \
  where cl.book = -1 and bs.id_tariff = 900002 \
   order by cl.code, eq2.name_eqp, bs.num_eqp ; ";

   //   order by cl.code, eq2.name_eqp, bs.num_eqp ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLReps->ParamByName("mmgg2")->AsDateTime=mmgg2;

//  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
    ZQXLReps->ParamByName("energy")->AsInteger=1;
   }
//  if (kind_energy==1)
//   {
//    ZQXLReps->ParamByName("pref")->AsInteger=20;
//    ZQXLReps->ParamByName("energy")->AsInteger=2;
//   }

  // по абонентам
  AnsiString  sqlstr2=" select cl.id as link, cl.code, cl.short_name, sum(bs.demand_val) as demand \
  from clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  where b.mmgg >= :mmgg1 and b.mmgg <= :mmgg2 and b.id_pref = :pref and cl.book = -1 \
  and bs.id_tariff = 900002 \
  group by cl.id , cl.code, cl.short_name order by cl.code ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg1")->AsDateTime=mmgg1;
  ZQXLRepsSum->ParamByName("mmgg2")->AsDateTime=mmgg2;

//  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
//  if (kind_energy==1)
//    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;

  Word year1;
  Word month1;
  Word day1;

  Word year2;
  Word month2;
  Word day2;

  DecodeDate(mmgg1,year1,month1,day1);
  DecodeDate(mmgg2,year2,month2,day2);

  if ((year1==year2)&&(month1==month2))
  {
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1);
  }
  else
  {
     xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg1)+" - "+FormatDateTime("mmmm yyyy",mmgg2);
  }

    xlReport->ParamByName["caption"]->Value = "Довідка про використання електроенергії на господарчі потреби.";
//  if (kind_energy==1)
//    xlReport->ParamByName["caption"]->Value = "Довідка про використання реактивної електроенергії на господарчі потреби.";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::AbonDebetPay(TDateTime mmgg,boolean Build,int kind_energy)
{
  Word year1;
  Word month1;
  Word day1;

  DecodeDate(mmgg,year1,month1,day1);

  AnsiString sqlstr;

  if (Build)
  {
   sqlstr=" select seb_all( 0, :mmgg)";

   ZQReps->Close();
   ZQReps->Sql->Clear();
   ZQReps->Sql->Add(sqlstr);
   ZQReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

   try
   {
    ZQReps->ExecSql();
   }
   catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  // по категориям

  AnsiString  sqlstr2=" select sss.*,cla.name from \
     (select  coalesce(obr.roz,999) as link , \
     sum(opl_zv) as opl_zv, sum(-deb_zpme) as deb, sum(-deb_zpmpdv) as deb_tax, sum(pay.pay_sum) as pay_sum, \
     sum(pay.pay_tax) as pay_tax, count(distinct obr.id_client) as cnt  \
     from %obrtable as obr \
     join clm_client_tbl as c on (c.id = obr.id_client) \
     left join \
     (  select bp.id_client,sum(bp.value) as pay_sum, sum(bp.value_tax) as pay_tax \
         from acm_billpay_tbl as bp \
        join acm_bill_tbl as b on (b.id_doc = bp.id_bill) \
        join acm_pay_tbl as p on (p.id_doc = bp.id_pay) \
        where b.id_pref = :pref and b.mmgg < :mmgg \
        and p.mmgg =:mmgg \
        group by bp.id_client \
     ) as pay on (pay.id_client = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
     and ( deb_zpme <> 0 or deb_zpmpdv <> 0 ) \
     group by obr.roz )as sss \
     join cla_param_tbl as cla on (sss.link = cla.kod and cla.id_group = 200) order by cla.sort ";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLRepsSum->MacroByName("obrtable")->AsString="seb_obr_all_tbl";


  if (kind_energy==0)    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLRepsSum->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLRepsSum->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLRepsSum->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLRepsSum->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLRepsSum->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLRepsSum->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLRepsSum->ParamByName("pref")->AsInteger=120;

  // по потребителям

  AnsiString  sqlstr1="  select coalesce(obr.roz,999) as link ,obr.osob_r,obr.osob_rsk as abon_name ,\
     opl_zv, -deb_zpme as deb, - deb_zpmpdv as deb_tax, pay.pay_sum, pay.pay_tax \
     from %obrtable as obr \
     join clm_client_tbl as c on (c.id = obr.id_client) \
     left join \
     (  select bp.id_client,sum(bp.value) as pay_sum, sum(bp.value_tax) as pay_tax \
         from acm_billpay_tbl as bp \
        join acm_bill_tbl as b on (b.id_doc = bp.id_bill) \
        join acm_pay_tbl as p on (p.id_doc = bp.id_pay) \
        where b.id_pref = :pref and b.mmgg < :mmgg \
        and p.mmgg =:mmgg \
        group by bp.id_client \
     ) as pay on (pay.id_client = obr.id_client) \
     where obr.period = :mmgg and obr.id_pref = :pref and obr.idk_work not in (0,99) \
     and ( deb_zpme <> 0 or deb_zpmpdv <> 0 ) \
     order by obr.osob_r;";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=EncodeDate(year1,month1,1);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;


  if ((Build)||(EncodeDate(year1,month1,1)>=cur_mmgg))
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tmp";
  else
    ZQXLReps->MacroByName("obrtable")->AsString="seb_obr_all_tbl";

  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
    ZQXLRepsSum->Open();
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";


  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lyear";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";
  Param=xlReport->Params->Add();
  Param->Name="demcaption";

  Param=xlReport->Params->Add();
  Param->Name="bossname";
  Param=xlReport->Params->Add();
  Param->Name="bospos";
  Param=xlReport->Params->Add();
  Param->Name="buhname";
  Param=xlReport->Params->Add();
  Param->Name="user";

  xlReport->ParamByName["bossname"]->Value = BossName;
  xlReport->ParamByName["bospos"]->Value = BossPos;
  xlReport->ParamByName["buhname"]->Value = BuhName;
  xlReport->ParamByName["user"]->Value = "Виконавець:  "+CurUserPos+" "+CurUserName;

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());

  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",dtBegin->Date);
  xlReport->ParamByName["lyear"]->Value = IntToStr(year1);

  if (kind_energy == 0)  xlReport->ParamByName["caption"]->Value = "Погашення дебіторської заборгованості (активна електроенергія)";
  if (kind_energy == 1)  xlReport->ParamByName["caption"]->Value = "Погашення дебіторської заборгованості (реактивна електроенергія)";
  if (kind_energy == 3)  xlReport->ParamByName["caption"]->Value = "Погашення дебіторської заборгованості (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["caption"]->Value = "Погашення дебіторської заборгованості (2кр споживання без ПДВ).";

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";

}
//---------------------------------------------------------------------------
void TfReports::PrintAbonExtra(TDateTime mmgg,int kind_energy)
{

  AnsiString  sqlstr1=" select cl.id, cl.code, cl.short_name , bs.id_point, \
  bs.demand, bs.sum_val, eq2.name_eqp, coalesce(ph.id_extra,0) as link \
  from clm_client_tbl as cl join acm_bill_tbl as b on (cl.id = b.id_client) \
  join (select id_point, id_doc, sum(demand_val) as demand,sum(sum_val) as sum_val, max(dt_end) as dt_end \
    from acd_billsum_tbl group by id_point, id_doc )as bs using ( id_doc) \
  join  ( select eq3.id,eq3.name_eqp from eqm_equipment_h as eq3 join \
    (select id,max(dt_b) as maxdt from eqm_equipment_h where type_eqp = 12  group by id ) as sdt3 on (sdt3.id = eq3.id and sdt3.maxdt = eq3.dt_b) \
  ) as eq2  on (bs.id_point=eq2.id) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
  and (bs.demand <>0 or bs.sum_val <>0 ) and ph.id_extra is not null order by ph.id_extra, cl.code ; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=mmgg;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }

  // по категориям
  AnsiString  sqlstr2=" select coalesce(ts.id_extra,0) as link, demand, sum_val , ap.name  \
  from  (select ph.id_extra, sum(bs.demand_val) as demand,sum(bs.sum_val) as sum_val \
  from  clm_client_tbl as cl \
  join acm_bill_tbl as b on (cl.id = b.id_client) \
  join acd_billsum_tbl as bs using ( id_doc) \
  join eqm_point_h as ph on (ph.code_eqp = bs.id_point) \
  where b.mmgg = :mmgg and b.id_pref = :pref and cl.book = -1 \
  and ph.dt_b = (select max(dt_b) from eqm_point_h as p2 \
   where p2.code_eqp = bs.id_point and p2.dt_b <= coalesce(bs.dt_end,p2.dt_b) ) \
   and (bs.demand_val <>0 or bs.sum_val <>0 ) and ph.id_extra is not null \
  group by ph.id_extra )as ts  \
  join cla_param_tbl as ap on (ap.id = ts.id_extra) \
  order by ap.id ;";


  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("mmgg")->AsDateTime=mmgg;
  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
   ZQXLReps->Open();
   ZQXLRepsSum->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання активної електроенергії по додатковим параметрам обліків.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про споживання реактивної електроенергії по додатковим параметрам обліків.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------
void TfReports::ObSaldoAbonForAll(TDateTime mmgg,int kind_energy, boolean Build)
{

   AnsiString  sqlstr;
   if (Build)
   {
    sqlstr=" select seb_all(0, date_trunc('month', :mmgg::::date)::::date )";

    ZQReps->Close();
    ZQReps->Sql->Clear();
    ZQReps->Sql->Add(sqlstr);
    ZQReps->ParamByName("mmgg")->AsDateTime=mmgg;

    try
    {
     ZQReps->ExecSql();

      sqlstr= " update seb_obrs_tmp \
                    set b_dtval=0,    b_ktval=b_ktval-b_dtval \
                 where b_dtval<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr= " update seb_obrs_tmp \
                    set  b_dtval_tax=0, b_ktval_tax=b_ktval_tax-b_dtval_tax   \
               where b_dtval_tax<0;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_dtval=0,e_ktval=e_ktval-e_dtval \
               where e_dtval<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_dtval_tax=0,e_ktval_tax=e_ktval_tax-e_dtval_tax  \
               where e_dtval_tax<0";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
      ZQReps->ExecSql();

      sqlstr= " update seb_obrs_tmp \
                    set b_ktval=0,    b_dtval=b_dtval-b_ktval \
                 where b_ktval<0 and (select sum(b_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0  \
                                     and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date) \
                 ;";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();
      sqlstr= " update seb_obrs_tmp \
                    set     b_ktval_tax=0, b_dtval_tax=b_dtval_tax-b_ktval_tax   \
               where b_ktval_tax<0 and (select sum(b_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date);";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set e_ktval=0,e_dtval=coalesce(e_dtval,0)-e_ktval \
               where e_ktval<0 and (select sum(e_ktval)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0\
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";
                         //
      ZQReps->Close();
      
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
         ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();

      sqlstr="update seb_obrs_tmp set   e_ktval_tax=0,e_dtval_tax=e_dtval_tax-e_ktval_tax  \
               where e_ktval_tax<0 and (select sum(e_ktval_tax)  as skt_val from seb_obrs_tmp a\
                        where a.id_client=seb_obrs_tmp.id_client  \
                        and a.id_pref=seb_obrs_tmp.id_pref \
                        and a.hmmgg=seb_obrs_tmp.hmmgg)<>0 \
                         and date_trunc('year',seb_obrs_tmp.hmmgg)=date_trunc('year',:pmmgg::::date)";

      ZQReps->Close();
      ZQReps->Sql->Clear();
      ZQReps->Sql->Add(sqlstr);
       ZQReps->ParamByName("pmmgg")->AsDateTime=mmgg;
      ZQReps->ExecSql();


    }
    catch(...)
    {
     ShowMessage("Ошибка SQL :"+sqlstr);
     return;
    }
   }


  AnsiString  sqlstr1="select abon.short_name , abon.code, \
  CASE WHEN abonpar.dt_end_rent is not null THEN 1 END as closed, \
  abonpar.doc_num, abonpar.doc_dat as doc, \
  sss1.*, sss2.*,sss3.* \
  from  clm_client_tbl as abon \
  join clm_statecl_tbl as abonpar on (abonpar.id_client = abon.id) \
  left join \
  ( select obr.id_client , \
  sum(kt1999.b_kt+kt1999.b_kttax) as kr_zpmv99, \
  sum(kt2000.b_kt+kt2000.b_kttax) as kr_zpmv00, \
  sum(kt2001.b_kt+kt2001.b_kttax) as kr_zpmv01, \
  sum(kt2002.b_kt+kt2002.b_kttax) as kr_zpmv02, \
  sum(kt2003.b_kt+kt2003.b_kttax) as kr_zpmv03, \
  sum(kt2004.b_kt+kt2004.b_kttax) as kr_zpmv04, \
  sum(kt2005.b_kt+kt2005.b_kttax) as kr_zpmv05, \
  sum(kt2006.b_kt+kt2006.b_kttax) as kr_zpmv06, \
  sum(kt2007.b_kt+kt2007.b_kttax) as kr_zpmv07, \
  sum(kt2008.b_kt+kt2008.b_kttax) as kr_zpmv08, \
  sum(kt2009.b_kt+kt2009.b_kttax) as kr_zpmv09, \
  sum(kt2010.b_kt+kt2010.b_kttax) as kr_zpmv10, \
  sum(kt2011.b_kt+kt2011.b_kttax) as kr_zpmv11, \
  sum(kt2012.b_kt+kt2012.b_kttax) as kr_zpmv12, \
  sum(kt2013.b_kt+kt2013.b_kttax) as kr_zpmv13, \
  sum(kt2014.b_kt+kt2014.b_kttax) as kr_zpmv14, \
  -sum(deb_pm99v) as deb99 ,- sum(deb_pm00v) as deb00,\
  -sum(deb_pm01v) as deb01,- sum(deb_pm02v) as deb02, \
  -sum(deb_pm03v) as deb03,- sum(deb_pm04v) as deb04, \
  -sum(deb_pm05v) as deb05, -sum(deb_pm06v) as deb06, \
  -sum(deb_pm07v) as deb07,-sum(deb_pm08v) as deb08,\
  -sum(deb_pm09v) as deb09, -sum(deb_pm10v) as deb10,\
  -sum(deb_pm11v) as deb11, -sum(deb_pm12v) as deb12, \
  -sum(deb_pm13v) as deb13, -sum(deb_pm14v) as deb14, \
  sum(kt1999.e_kt+kt1999.e_kttax) as kr_zkmv99, \
  sum(kt2000.e_kt+kt2000.e_kttax) as kr_zkmv00, \
  sum(kt2001.e_kt+kt2001.e_kttax) as kr_zkmv01, \
  sum(kt2002.e_kt+kt2002.e_kttax) as kr_zkmv02, \
  sum(kt2003.e_kt+kt2003.e_kttax) as kr_zkmv03, \
  sum(kt2004.e_kt+kt2004.e_kttax) as kr_zkmv04, \
  sum(kt2005.e_kt+kt2005.e_kttax) as kr_zkmv05, \
  sum(kt2006.e_kt+kt2006.e_kttax) as kr_zkmv06, \
  sum(kt2007.e_kt+kt2007.e_kttax) as kr_zkmv07, \
  sum(kt2008.e_kt+kt2008.e_kttax) as kr_zkmv08, \
  sum(kt2009.e_kt+kt2009.e_kttax) as kr_zkmv09, \
  sum(kt2010.e_kt+kt2010.e_kttax) as kr_zkmv10, \
  sum(kt2011.e_kt+kt2011.e_kttax) as kr_zkmv11, \
  sum(kt2012.e_kt+kt2012.e_kttax) as kr_zkmv12, \
  sum(kt2013.e_kt+kt2013.e_kttax) as kr_zkmv13, \
  sum(kt2014.e_kt+kt2014.e_kttax) as kr_zkmv14, \
  -sum(deb_km99v) as deb99_k,- sum(deb_km00v) as deb00_k, \
  -sum(deb_km01v) as deb01_k,- sum(deb_km02v) as deb02_k, \
  -sum(deb_km03v) as deb03_k,- sum(deb_km04v) as deb04_k, \
  -sum(deb_km05v) as deb05_k, -sum(deb_km06v) as deb06_k, \
  -sum(deb_km07v) as deb07_k, -sum(deb_km08v) as deb08_k,\
  -sum(deb_km09v) as deb09_k, -sum(deb_km10v) as deb10_k , \
  -sum(deb_km11v) as deb11_k , -sum(deb_km12v) as deb12_k ,\
  -sum(deb_km13v) as deb13_k , -sum(deb_km14v) as deb14_k ,\
  sum(kt1999.b_kttax) as kr_zpmn99, \
  sum(kt2000.b_kttax) as kr_zpmn00, \
  sum(kt2001.b_kttax) as kr_zpmn01, \
  sum(kt2002.b_kttax) as kr_zpmn02, \
  sum(kt2003.b_kttax) as kr_zpmn03, \
  sum(kt2004.b_kttax) as kr_zpmn04, \
  sum(kt2005.b_kttax) as kr_zpmn05, \
  sum(kt2006.b_kttax) as kr_zpmn06, \
  sum(kt2007.b_kttax) as kr_zpmn07, \
  sum(kt2008.b_kttax) as kr_zpmn08, \
  sum(kt2009.b_kttax) as kr_zpmn09, \
  sum(kt2010.b_kttax) as kr_zpmn10, \
  sum(kt2011.b_kttax) as kr_zpmn11, \
  sum(kt2012.b_kttax) as kr_zpmn12, \
  sum(kt2013.b_kttax) as kr_zpmn13, \
  sum(kt2014.b_kttax) as kr_zpmn14, \
  -sum(deb_pm00pdv) as deb00n,\
  -sum(deb_pm01pdv) as deb01n,- sum(deb_pm02pdv) as deb02n, \
  -sum(deb_pm03pdv) as deb03n,- sum(deb_pm04pdv) as deb04n, \
  -sum(deb_pm05pdv) as deb05n, -sum(deb_pm06pdv) as deb06n, \
  -sum(deb_pm07pdv) as deb07n,-sum(deb_pm08pdv) as deb08n,\
  -sum(deb_pm09pdv) as deb09n,-sum(deb_pm10pdv) as deb10n, \
  -sum(deb_pm11pdv) as deb11n, -sum(deb_pm12pdv) as deb12n, \
  -sum(deb_pm13pdv) as deb13n, -sum(deb_pm14pdv) as deb14n, \
  sum(kt1999.e_kttax) as kr_zkmn99, \
  sum(kt2000.e_kttax) as kr_zkmn00, \
  sum(kt2001.e_kttax) as kr_zkmn01, \
  sum(kt2002.e_kttax) as kr_zkmn02, \
  sum(kt2003.e_kttax) as kr_zkmn03, \
  sum(kt2004.e_kttax) as kr_zkmn04, \
  sum(kt2005.e_kttax) as kr_zkmn05, \
  sum(kt2006.e_kttax) as kr_zkmn06, \
  sum(kt2007.e_kttax) as kr_zkmn07, \
  sum(kt2008.e_kttax) as kr_zkmn08, \
  sum(kt2009.e_kttax) as kr_zkmn09, \
  sum(kt2010.e_kttax) as kr_zkmn10, \
  sum(kt2011.e_kttax) as kr_zkmn11, \
  sum(kt2012.e_kttax) as kr_zkmn12, \
  sum(kt2013.e_kttax) as kr_zkmn13, \
  sum(kt2014.e_kttax) as kr_zkmn14, \
  -sum(deb_km00pdv) as deb00_kn, \
  -sum(deb_km01pdv) as deb01_kn,- sum(deb_km02pdv) as deb02_kn, \
  -sum(deb_km03pdv) as deb03_kn,- sum(deb_km04pdv) as deb04_kn, \
  -sum(deb_km05pdv) as deb05_kn, -sum(deb_km06pdv) as deb06_kn, \
  -sum(deb_km07pdv) as deb07_kn,-sum(deb_km08pdv) as deb08_kn, \
  -sum(deb_km09pdv) as deb09_kn,  -sum(deb_km10pdv) as deb10_kn, \
  -sum(deb_km11pdv) as deb11_kn , -sum(deb_km12pdv) as deb12_kn, \
  -sum(deb_km13pdv) as deb13_kn , -sum(deb_km14pdv) as deb14_kn \
  from  seb_obr_all_tmp as obr \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=1999 group by id_client ) as kt1999 on ( kt1999.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2000 group by id_client ) as kt2000 on ( kt2000.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2001 group by id_client ) as kt2001 on ( kt2001.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2002 group by id_client ) as kt2002 on ( kt2002.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2003 group by id_client ) as kt2003 on ( kt2003.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2004 group by id_client ) as kt2004 on ( kt2004.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2005 group by id_client ) as kt2005 on ( kt2005.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2006 group by id_client ) as kt2006 on ( kt2006.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2007 group by id_client ) as kt2007 on ( kt2007.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2008 group by id_client ) as kt2008 on ( kt2008.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2009 group by id_client ) as kt2009 on ( kt2009.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2010 group by id_client ) as kt2010 on ( kt2010.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2011 group by id_client ) as kt2011 on ( kt2011.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2012 group by id_client ) as kt2012 on ( kt2012.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2013 group by id_client ) as kt2013 on ( kt2013.id_client = obr.id_client) \
     left join (select id_client, sum(b_ktval) as b_kt, sum(b_ktval_tax) as b_kttax, sum(e_ktval) as e_kt, sum(e_ktval_tax) as e_kttax  from seb_obrs_tmp \
     where  id_pref = :pref  and date_part('year',hmmgg)=2014 group by id_client ) as kt2014 on ( kt2014.id_client = obr.id_client) \
  where obr.id_pref = :pref \
  and obr.period = date_trunc('month',  :dt::::date) \
  group by obr.id_client ) as sss1 on (sss1.id_client = abon.id) \
 left join \
 (select p.id_client, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 1999 THEN p.value_pay ELSE 0 END) as pay99, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_pay ELSE 0 END) as pay00, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_pay ELSE 0 END) as pay01, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_pay ELSE 0 END) as pay02, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_pay ELSE 0 END) as pay03, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_pay ELSE 0 END) as pay04, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_pay ELSE 0 END) as pay05, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_pay ELSE 0 END) as pay06, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_pay ELSE 0 END) as pay07, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_pay ELSE 0 END) as pay08, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_pay ELSE 0 END) as pay09, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_pay ELSE 0 END) as pay10, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_pay ELSE 0 END) as pay11, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_pay ELSE 0 END) as pay12, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_pay ELSE 0 END) as pay13, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_pay ELSE 0 END) as pay14, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2000 THEN p.value_tax ELSE 0 END) as paytax00, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2001 THEN p.value_tax ELSE 0 END) as paytax01, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2002 THEN p.value_tax ELSE 0 END) as paytax02, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2003 THEN p.value_tax ELSE 0 END) as paytax03, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2004 THEN p.value_tax ELSE 0 END) as paytax04, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2005 THEN p.value_tax ELSE 0 END) as paytax05, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2006 THEN p.value_tax ELSE 0 END) as paytax06, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2007 THEN p.value_tax ELSE 0 END) as paytax07, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2008 THEN p.value_tax ELSE 0 END) as paytax08, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2009 THEN p.value_tax ELSE 0 END) as paytax09, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2010 THEN p.value_tax ELSE 0 END) as paytax10, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2011 THEN p.value_tax ELSE 0 END) as paytax11, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2012 THEN p.value_tax ELSE 0 END) as paytax12, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2013 THEN p.value_tax ELSE 0 END) as paytax13, \
  sum(CASE WHEN date_part('year',p.mmgg_pay) = 2014 THEN p.value_tax ELSE 0 END) as paytax14  \
  from acm_pay_tbl as p  \
  where  p.mmgg = date_trunc('month',  :dt::::date)  \
  and p.id_pref = :pref and p.sign_pay = 1 group by p.id_client \
  )as sss2 on (sss2.id_client = abon.id) \
 left join \
 (select b.id_client, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.value ELSE 0 END) as bill99, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value ELSE 0 END) as bill00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value ELSE 0 END) as bill01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value ELSE 0 END) as bill02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value ELSE 0 END) as bill03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value ELSE 0 END) as bill04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value ELSE 0 END) as bill05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value ELSE 0 END) as bill06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value ELSE 0 END) as bill07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value ELSE 0 END) as bill08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value ELSE 0 END) as bill09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value ELSE 0 END) as bill10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value ELSE 0 END) as bill11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value ELSE 0 END) as bill12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value ELSE 0 END) as bill13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value ELSE 0 END) as bill14, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.value_tax ELSE 0 END) as billtax00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.value_tax ELSE 0 END) as billtax01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.value_tax ELSE 0 END) as billtax02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.value_tax ELSE 0 END) as billtax03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.value_tax ELSE 0 END) as billtax04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.value_tax ELSE 0 END) as billtax05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.value_tax ELSE 0 END) as billtax06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.value_tax ELSE 0 END) as billtax07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.value_tax ELSE 0 END) as billtax08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.value_tax ELSE 0 END) as billtax09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.value_tax ELSE 0 END) as billtax10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.value_tax ELSE 0 END) as billtax11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.value_tax ELSE 0 END) as billtax12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.value_tax ELSE 0 END) as billtax13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.value_tax ELSE 0 END) as billtax14, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 1999 THEN b.demand_val ELSE 0 END) as dem99, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2000 THEN b.demand_val ELSE 0 END) as dem00, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2001 THEN b.demand_val ELSE 0 END) as dem01, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2002 THEN b.demand_val ELSE 0 END) as dem02, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2003 THEN b.demand_val ELSE 0 END) as dem03, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2004 THEN b.demand_val ELSE 0 END) as dem04, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2005 THEN b.demand_val ELSE 0 END) as dem05, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2006 THEN b.demand_val ELSE 0 END) as dem06, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2007 THEN b.demand_val ELSE 0 END) as dem07, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2008 THEN b.demand_val ELSE 0 END) as dem08, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2009 THEN b.demand_val ELSE 0 END) as dem09, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2010 THEN b.demand_val ELSE 0 END) as dem10, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2011 THEN b.demand_val ELSE 0 END) as dem11, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2012 THEN b.demand_val ELSE 0 END) as dem12, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2013 THEN b.demand_val ELSE 0 END) as dem13, \
  sum(CASE WHEN date_part('year',b.mmgg_bill) = 2014 THEN b.demand_val ELSE 0 END) as dem14  \
  from acm_bill_tbl as b  \
  where b.mmgg = date_trunc('month',  :dt::::date)  \
  and b.id_pref = :pref and b.idk_doc<>201 group by b.id_client \
  )as sss3 on (sss3.id_client = abon.id) \
   where coalesce(kr_zpmv05,0)<> 0 or coalesce(kr_zpmv06,0) <> 0 or \
         coalesce(kr_zpmv07,0)<> 0 or coalesce(kr_zpmv08,0) <> 0 or \
         coalesce(kr_zpmv09,0)<> 0 or coalesce(kr_zpmv10,0) <> 0 or \
         coalesce(kr_zpmv11,0)<> 0 or coalesce(kr_zpmv12,0) <> 0 or \
         coalesce(kr_zpmv13,0)<> 0 or ( :show_all = 1) \
   order by abon.code ; ";

  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);

  ZQXLReps->ParamByName("dt")->AsDateTime=mmgg;
  ZQXLReps->ParamByName("show_all")->AsInteger=(cbAll->Checked?1:0);

  if (kind_energy==0)    ZQXLReps->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)    ZQXLReps->ParamByName("pref")->AsInteger=20;
  if (kind_energy==2)    ZQXLReps->ParamByName("pref")->AsInteger=510;
  if (kind_energy==3)    ZQXLReps->ParamByName("pref")->AsInteger=520;
  if (kind_energy==4)    ZQXLReps->ParamByName("pref")->AsInteger=524;
  if (kind_energy==5)    ZQXLReps->ParamByName("pref")->AsInteger=901;
  if (kind_energy==6)    ZQXLReps->ParamByName("pref")->AsInteger=902;
  if (kind_energy==7)    ZQXLReps->ParamByName("pref")->AsInteger=110;
  if (kind_energy==8)    ZQXLReps->ParamByName("pref")->AsInteger=120;

  try
  {
    ZQXLReps->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lmmgg";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lmmgg"]->Value = FormatDateTime("mmmm yyyy",mmgg);

  if (kind_energy == 0)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Активна енергія.";
  if (kind_energy == 1)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Реактивна енергія.";
  if (kind_energy == 2)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках.  Перевищення ліміту (2кр потужність).";
  if (kind_energy == 3)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках.  Перевищення ліміту (2кр споживання з ПДВ).";
  if (kind_energy == 4)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Перевищення ліміту (2кр споживання без ПДВ).";
  if (kind_energy == 5)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Пеня.";
  if (kind_energy == 6)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Інфляція.";
  if (kind_energy == 7)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Передача.";
  if (kind_energy == 8)  xlReport->ParamByName["caption"]->Value = "Розподіл Дт/Кт по роках. Інформ.послуги";

  xlReport->Report();


 ZQXLReps->Close();

}
//---------------------------------------------------------------------------

void TfReports::PrintOldKt(TDateTime dt,int kind_energy)
{

  AnsiString  sqlstr1=" select  pb.id_client as link, c.code, c.short_name, pb.mmgg, \
  pb.mmgg_pay, sum(rest) as rest, sum(rest_tax) as rest_tax \
  from acv_paybill as pb \
  join acm_pay_tbl as p on (p.id_doc = pb.id_doc) \
  join clm_client_tbl as c on (c.id = pb.id_client) \
  join clm_statecl_tbl as scl on (scl.id_client = c.id) \
  where (rest<>0 or rest_tax<>0) \
  and pb.mmgg_pay < :dt::::date  and pb.id_client <> syi_resid_fun() \
  and p.id_pref = :pref \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  group by pb.id_client,  c.code, c.short_name, pb.mmgg, pb.mmgg_pay \
  order by code, pb.mmgg_pay; ";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("dt")->AsDateTime=dt;

  if (kind_energy==0)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=10;
   }
  if (kind_energy==1)
   {
    ZQXLReps->ParamByName("pref")->AsInteger=20;
   }

  AnsiString  sqlstr2="select  pb.id_client as link, c.code, c.short_name, sum(rest) as rest, sum(rest_tax) as rest_tax \
  from acv_paybill as pb \
  join acm_pay_tbl as p on (p.id_doc = pb.id_doc) \
  join clm_client_tbl as c on (c.id = pb.id_client) \
  join clm_statecl_tbl as scl on (scl.id_client = c.id) \
  where (rest<>0 or rest_tax<>0) \
  and pb.mmgg_pay < :dt::::date and pb.id_client <> syi_resid_fun() \
  and p.id_pref = :pref \
    and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  group by pb.id_client,  c.code, c.short_name ";

  if (!(cbAll->Checked))
          sqlstr2+=" having sum(rest)<>0 or sum(rest_tax) <>0 ";

  sqlstr2+=" order by code  ;";

  ZQXLRepsSum->Sql->Clear();
  ZQXLRepsSum->Sql->Add(sqlstr2);
  ZQXLRepsSum->ParamByName("dt")->AsDateTime=dt;
  if (kind_energy==0)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=10;
  if (kind_energy==1)
    ZQXLRepsSum->ParamByName("pref")->AsInteger=20;


  ZQXLReps->MasterSource=DSRep;
  ZQXLReps->LinkFields="link = link";

  try
  {
   ZQXLReps->Open();
   ZQXLRepsSum->Open();
  }
  catch(EDatabaseError &e)
  {
    ShowMessage("Ошибка : "+e.Message.SubString(8,200));
    return;
  }


  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;
  xlReport->DataSources->Clear();

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLRepsSum;
  Dsr->Alias =  "ZQXLRepsSum";
  Dsr->Range = "GroupRange";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Alias = "ZQXLReps";
  Dsr->Range = "Range";
  Dsr->MasterSourceName="ZQXLRepsSum";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="ldt";
  Param=xlReport->Params->Add();
  Param->Name="caption";
  Param=xlReport->Params->Add();
  Param->Name="lnow";

  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["ldt"]->Value = FormatDateTime("dd mmmm yyyy",dt);

  if (kind_energy==0)
    xlReport->ParamByName["caption"]->Value = "Звіт про невикористані платежі за активну електроенергію.";
  if (kind_energy==1)
    xlReport->ParamByName["caption"]->Value = "Звіт про невикористані платежі за реактивну електроенергію.";

  xlReport->Report();


 ZQXLReps->Close();
 ZQXLRepsSum->Close();

 ZQXLReps->MasterSource=NULL;
 ZQXLReps->LinkFields="";


}
//---------------------------------------------------------------------------

void TfReports::MastersDemandAktListDetail (TDateTime dtb, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_point_master_fun( :dt );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select ss.*, c.code as master_code, c.short_name as master_name, c2.code , c2.short_name as name, eq.name_eqp, \
  CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END as sin_m,\
  CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as sout_m, \
  out_demand +CASE WHEN mm.id_master_client is not null THEN sin ELSE sin_c END + CASE WHEN mm.id_master_client is not null THEN sout ELSE sout_c END as out_all \
   from \
   ( \
  select id_master_client,mm.id_client,bs.id_point,  sum(kvt) as out_demand ,coalesce(sum(sin),0) as sin, coalesce(sum(sout),0) as sout, \
  coalesce(sum(sin_c),0) as sin_c, coalesce(sum(sout_c),0) as sout_c \
   from \
  (select distinct m.* from rep_point_master_tbl as m join eqm_tree_tbl as t on (t.id = m.id_master_tree) \
   join clm_client_tbl as cm on (t.id_client = cm.id) \
  where t.id_client <> syi_resid_fun() and coalesce(cm.flag_balance,0) <> 1 \
  order by m.id_master_client,m.id_point) as mm \
  join \
 (select id_doc,id_point, sum(demand_val) as kvt \
    from acd_billsum_tbl where mmgg = :mmgg and kind_energy=1 group by id_doc,id_point order by id_doc,id_point )as bs \
    on (bs.id_point = mm.id_point ) \
  left join \
 ( select b.id_doc,b.id_client,pd.id_point, sum(in_res_losts) as sin, sum(out_res_losts) as sout \
   from acm_bill_tbl as b join  acd_pwr_demand_tbl as pd  on  (b.id_doc =pd.id_doc  ) \
   where b.mmgg = :mmgg and pd.kind_energy = 1 \
   group by b.id_doc, b.id_client, pd.id_point order by b.id_doc, pd.id_point \
 ) as ls on (ls.id_doc=bs.id_doc and ls.id_point = bs.id_point) \
  left join \
 (  select id_doc,id_client,id_point,id_client_eqp, \
   sum(CASE WHEN res_l = 1 THEN dw END) as sin_c, sum(CASE WHEN res_l = 2 THEN dw END) as sout_c \
   from \
   (select b.id_doc,b.id_client,cl.id_eqp,cl.id_point, coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  where b.mmgg = :mmgg and res_l in (1,2) \
  ) as ss \
  group by id_doc,id_client,id_point,id_client_eqp order by id_doc,id_point,id_client_eqp \
 ) as ls_c on (ls_c.id_doc=bs.id_doc and ls_c.id_point = bs.id_point and ls_c.id_client_eqp = mm.id_master_client) \
  group by id_master_client,bs.id_point, mm.id_client order by id_master_client,mm.id_client,bs.id_point \
  ) as ss \
  join  clm_client_tbl as c on (c.id = ss.id_master_client) \
  join  clm_client_tbl as c2 on (c2.id = ss.id_client) \
  join  eqm_equipment_h as eq on (eq.id = ss.id_point) \
  join  clm_statecl_h  as sc on (c.id = sc.id_client) \
 left join (select distinct r1.id_master_client from rep_point_master_tbl as r1 left join rep_point_master_tbl as r2 on (r1.id_master_client = r2.id_client and r1.id_master_tree = r2.id_point_tree ) \
   where r2.id_client is null) as mm on (mm.id_master_client = ss.id_master_client) \
  where c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
  and sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = eq.id and eq2.dt_b <= date_trunc('month', :mmgg::::date ) ) \
  order by c.code, c2.code ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);


  xlReport->Report();

 ZQXLReps->Close();
}
//----------------------------------------------------------------------------

void TfReports::MastersDemandLostsDetail (TDateTime dtb, boolean Build)
{
  if (Build)
  {
  AnsiString sqlstr="select rep_point_master_fun( :dt );";
  ZQReps->Close();
  ZQReps->Sql->Clear();
  ZQReps->Sql->Add(sqlstr);
  ZQReps->ParamByName("dt")->AsDateTime=dtb;

  try
   {
    ZQReps->ExecSql();
   }
  catch(...)
   {
    ShowMessage("Ошибка SQL :"+sqlstr);
    return;
   }
  }

  AnsiString  sqlstr1=" select sss.*, c.code, c.short_name, sc.doc_num, sc.tr_doc_num, eq.name_eqp, dk.name as type_name \
 from \
( select id_client_eqp,  mmgg, id_eqp,type_eqm,id_type_eqp,sn_len,un, \
   sum( dw ) as sin_sout \
   from \
   (select b.mmgg, b.id_doc,b.id_client,cl.id_eqp,cl.id_point,cl.type_eqm, cl.id_type_eqp, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.ukz_un ELSE eqi.voltage_nom END::::numeric/1000 as un, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.sn_len/1000 ELSE cl.sn_len END::::numeric as sn_len, \
   coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join (select distinct id_doc, id_point from acd_billsum_tbl where mmgg = :mmgg::::date order by id_doc, id_point) as bs on (bs.id_doc = b.id_doc and bs.id_point = cl.id_point) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  join \
  (select distinct m.id_client, m.id_master_client \
    from rep_point_master_tbl as m \
   order by m.id_master_client,m.id_client \
  ) as mm on (mm.id_client = b.id_client and mm.id_master_client = coalesce (use.id_client, tr.id_client)) \
  left join eqi_compensator_tbl as eqi on (eqi.id = cl.id_type_eqp) \
  where b.mmgg = :mmgg::::date and res_l in (1,2) and b.id_pref in (10,11) \
  ) as ss \
  group by id_client_eqp, mmgg, id_eqp,type_eqm, sn_len, un , id_type_eqp order by id_client_eqp \
 ) as sss \
 join clm_client_tbl as c on (c.id = sss.id_client_eqp) \
 join  clm_statecl_h  as sc on (c.id = sc.id_client) \
 join  eqm_equipment_h  as eq on (eq.id = sss.id_eqp) \
 join eqi_device_kinds_tbl as dk on (dk.id = type_eqm) \
where  sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = eq.id and eq2.dt_b <= (:mmgg::::date +'1 month'::::interval )) \
  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
order by un, c.code, type_eqm ;";


  ZQXLReps->Sql->Clear();
  ZQXLReps->Sql->Add(sqlstr1);
  ZQXLReps->ParamByName("mmgg")->AsDateTime=dtb;


  AnsiString  sqlstr2=" select sss.*, c.code, c.short_name, sc.doc_num, sc.tr_doc_num, eq.name_eqp, dk.name as type_name \
 from \
( select id_client_eqp,  mmgg, id_eqp,type_eqm,un, sn_len, sum( dw ) as sin_sout \
   from \
   (select b.mmgg, b.id_doc,b.id_client,cl.id_eqp,cl.id_point,cl.type_eqm, cl.id_type_eqp, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.ukz_un ELSE eqi.voltage_nom END::::numeric/1000 as un, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.sn_len/1000 ELSE cl.sn_len END::::numeric as sn_len, \
   coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join (select distinct id_doc, id_point from acd_billsum_tbl where mmgg = :mmgg::::date order by id_doc, id_point) as bs on (bs.id_doc = b.id_doc and bs.id_point = cl.id_point) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  join \
  (select distinct m.id_client, m.id_master_client \
    from rep_point_master_tbl as m \
   order by m.id_master_client,m.id_client \
  ) as mm on (mm.id_client = b.id_client and mm.id_master_client = coalesce (use.id_client, tr.id_client)) \
  left join eqi_compensator_tbl as eqi on (eqi.id = cl.id_type_eqp) \
  where b.mmgg = :mmgg::::date and res_l in (1,2) and b.id_pref in (10,11) and type_eqm = 2 \
  ) as ss \
  group by id_client_eqp, mmgg, id_eqp,type_eqm, sn_len, un order by id_client_eqp \
 ) as sss \
 join clm_client_tbl as c on (c.id = sss.id_client_eqp) \
 join  clm_statecl_h  as sc on (c.id = sc.id_client) \
 join  eqm_equipment_h  as eq on (eq.id = sss.id_eqp) \
 join eqi_device_kinds_tbl as dk on (dk.id = type_eqm) \
where  sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and eq.dt_b = (select max(dt_b) from eqm_equipment_h as eq2 where eq2.id = eq.id and eq2.dt_b <= (:mmgg::::date +'1 month'::::interval )) \
  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
union all \
select sss.*, c.code, c.short_name, sc.doc_num, sc.tr_doc_num, CASE WHEN type_eqm = 6 THEN 'КЛ' ELSE 'ПЛ' END||'-'||trim(to_char(un,'990.9')) as name_eqp,  dk.name as type_name \
 from \
 (select id_client_eqp,  mmgg, 0, type_eqm,un, sum(sn_len) as len , sum( sin_sout ) as sin_sout \
  from \
  (select id_client_eqp,  mmgg, id_eqp, type_eqm,sn_len ,un, sum( dw ) as sin_sout \
   from \
   (select b.mmgg, b.id_doc,b.id_client,cl.id_point,cl.type_eqm, cl.id_eqp, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.ukz_un ELSE eqi.voltage_nom END::::numeric/1000 as un, \
   CASE WHEN cl.type_eqm in (6,7) THEN cl.sn_len/1000 ELSE cl.sn_len END::::numeric as sn_len, \
   coalesce (use.id_client, tr.id_client) as id_client_eqp ,res_l,dw \
   from acd_calc_losts_tbl as cl \
   join acm_bill_tbl as b on  (b.id_doc =cl.id_doc ) \
   join (select distinct id_doc, id_point from acd_billsum_tbl where mmgg = :mmgg::::date order by id_doc, id_point) as bs on (bs.id_doc = b.id_doc and bs.id_point = cl.id_point) \
   join eqm_eqp_tree_h as ttr on (ttr.code_eqp = cl.id_eqp and \
     tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(ttr.dt_b::::timestamp::::abstime,(coalesce(ttr.dt_e,(:mmgg::::date + '20 year'::::interval) ::::date))::::timestamp::::abstime)) \
  ) \
  join eqm_tree_tbl as tr \
   on (tr.id = ttr.id_tree ) \
  left join eqm_eqp_use_h as use \
   on (use.code_eqp = cl.id_eqp and \
   tintervalov(tinterval(cl.dat_b::::timestamp::::abstime,cl.dat_e::::timestamp::::abstime),tinterval(use.dt_b::::timestamp::::abstime,(coalesce(use.dt_e,(:mmgg::::date + '20 year'::::interval)::::date))::::timestamp::::abstime)) \
  ) \
  join \
  (select distinct m.id_client, m.id_master_client \
    from rep_point_master_tbl as m \
   order by m.id_master_client,m.id_client \
  ) as mm on (mm.id_client = b.id_client and mm.id_master_client = coalesce (use.id_client, tr.id_client)) \
  left join eqi_compensator_tbl as eqi on (eqi.id = cl.id_type_eqp) \
  where b.mmgg = :mmgg::::date and res_l in (1,2) and b.id_pref in (10,11) and type_eqm in (6,7) \
  ) as ss \
  group by id_client_eqp, mmgg, type_eqm, un , sn_len , id_eqp \
 ) as sst \
   group by id_client_eqp, mmgg, type_eqm, un  order by id_client_eqp \
 ) as sss \
 join clm_client_tbl as c on (c.id = sss.id_client_eqp) \
 join  clm_statecl_h  as sc on (c.id = sc.id_client) \
 join eqi_device_kinds_tbl as dk on (dk.id = type_eqm) \
where  sc.mmgg_b = (select max(mmgg_b) from clm_statecl_h as scl2 where scl2.id_client = sc.id_client and scl2.mmgg_b <= date_trunc('month', :mmgg::::date ) ) \
  and c.book=-1 and c.idk_work not in (0,99) and coalesce(c.id_state,0) not in (50,99) \
order by un, code, type_eqm;";


  ZQXLReps2->Sql->Clear();
  ZQXLReps2->Sql->Add(sqlstr2);
  ZQXLReps2->ParamByName("mmgg")->AsDateTime=dtb;

  try
  {
    ZQXLReps->Open();
    ZQXLReps2->Open();
  }
  catch(...)
  {
    ShowMessage("Ошибка SQL :"+sqlstr1);
    return;
  }

  xlReport->XLSTemplate = "XL\\"+(PTRepData(CurReport->Data))->file_name;;
  TxlDataSource *Dsr;
  TxlReportParam *Param;

  xlReport->DataSources->Clear();
  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps;
  Dsr->Range = "Range";

  Dsr = xlReport->DataSources->Add();
  Dsr->DataSet = ZQXLReps2;
  Dsr->Range = "Range2";

  xlReport->Params->Clear();
  Param=xlReport->Params->Add();
  Param->Name="lres";
  Param=xlReport->Params->Add();
  Param->Name="lperiod";
  Param=xlReport->Params->Add();
  Param->Name="lnow";


  xlReport->ParamByName["lnow"]->Value = FormatDateTime("dd.mm.yy hh:nn",Now());
  xlReport->ParamByName["lres"]->Value = ResName;
  xlReport->ParamByName["lperiod"]->Value = FormatDateTime("dd.mm.yyyy",dtBegin->Date)+" - "+
  FormatDateTime("dd.mm.yyyy",dtEnd->Date);

  xlReport->Report();

 ZQXLReps->Close();
 ZQXLReps2->Close();
}
//----------------------------------------------------------------------------

void __fastcall TfReports::sbExecutorClClick(TObject *Sender)
{
 ExecutorId = 0;
 edExecutor->Text ="";

}
//---------------------------------------------------------------------------

void __fastcall TfReports::sbExecutorClick(TObject *Sender)
{
  AnsiString EmpS="  ";
  TWTDBGrid* Grid;

  AnsiString filt="id_client="+ToStrSQL(ResId);
  Grid=MainForm->CliPositionSel(NULL,filt);
  if(Grid==NULL) return;
  else WPosGrid=Grid;

  WPosGrid->FieldSource= WPosGrid->Table->GetTField("id");

  if (!edExecutor->Text.IsEmpty())
    WPosGrid->StringDest = edExecutor->Text;
   else
     WPosGrid->StringDest = EmpS;
   WPosGrid->OnAccept=PosAcceptExecutor;

}
//---------------------------------------------------------------------------
void __fastcall TfReports::PosAcceptExecutor (TObject* Sender)
{
  ExecutorId=WPosGrid->Table->FieldByName("id")->AsInteger;
  edExecutor->Text=WPosGrid->Table->FieldByName("represent_name")->AsString;
};
//---------------------------------------------------------------------------
